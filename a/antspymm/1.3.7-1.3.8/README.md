# Comparing `tmp/antspymm-1.3.7.tar.gz` & `tmp/antspymm-1.3.8.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "antspymm-1.3.7.tar", last modified: Wed May 22 18:39:06 2024, max compression
+gzip compressed data, was "antspymm-1.3.8.tar", last modified: Wed May 29 14:00:46 2024, max compression
```

## Comparing `antspymm-1.3.7.tar` & `antspymm-1.3.8.tar`

### file list

```diff
@@ -1,63 +1,63 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-22 18:39:06.244264 antspymm-1.3.7/
--rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-05-22 18:39:01.000000 antspymm-1.3.7/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)       33 2024-05-22 18:39:01.000000 antspymm-1.3.7/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    14860 2024-05-22 18:39:06.244264 antspymm-1.3.7/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)    14244 2024-05-22 18:39:01.000000 antspymm-1.3.7/README.md
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-22 18:39:06.220263 antspymm-1.3.7/antspymm/
--rw-r--r--   0 runner    (1001) docker     (127)     4462 2024-05-22 18:39:01.000000 antspymm-1.3.7/antspymm/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)   479836 2024-05-22 18:39:01.000000 antspymm-1.3.7/antspymm/mm.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-22 18:39:06.244264 antspymm-1.3.7/antspymm.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    14860 2024-05-22 18:39:06.000000 antspymm-1.3.7/antspymm.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     1421 2024-05-22 18:39:06.000000 antspymm-1.3.7/antspymm.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-22 18:39:06.000000 antspymm-1.3.7/antspymm.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)      134 2024-05-22 18:39:06.000000 antspymm-1.3.7/antspymm.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        9 2024-05-22 18:39:06.000000 antspymm-1.3.7/antspymm.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-22 18:39:06.240264 antspymm-1.3.7/docs/
--rw-r--r--   0 runner    (1001) docker     (127)     1508 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/adni_rsfmri_2_nrg_conversion.py
--rw-r--r--   0 runner    (1001) docker     (127)   594290 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/antspymm_data_dictionary.csv
--rw-r--r--   0 runner    (1001) docker     (127)      567 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/bids_cohort_example.py
--rw-r--r--   0 runner    (1001) docker     (127)     3342 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/blind_qc.Rmd
--rw-r--r--   0 runner    (1001) docker     (127)  1055592 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/blind_qc.html
--rw-r--r--   0 runner    (1001) docker     (127)     1445 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/convert_adni_dti_to_nrg.R
--rw-r--r--   0 runner    (1001) docker     (127)   450556 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/deepnbm.jpg
--rw-r--r--   0 runner    (1001) docker     (127)   525580 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/example_antspymm_output.csv
--rw-r--r--   0 runner    (1001) docker     (127)     1296 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/example_run_from_directory.py
--rw-r--r--   0 runner    (1001) docker     (127)    28375 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/make_dict_table.Rmd
--rw-r--r--   0 runner    (1001) docker     (127)  9773579 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/make_dict_table.html
--rw-r--r--   0 runner    (1001) docker     (127)      632 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/nrg_cohort_example.py
--rw-r--r--   0 runner    (1001) docker     (127)     5369 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/ptbp_nrg.py
--rw-r--r--   0 runner    (1001) docker     (127)     5971 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/roi_visualization.py
--rw-r--r--   0 runner    (1001) docker     (127)     1732 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/roi_visualization_ppmi.py
--rw-r--r--   0 runner    (1001) docker     (127)     1965 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/step1_blind_qc.py
--rw-r--r--   0 runner    (1001) docker     (127)     3781 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/step2_outlierness.py
--rw-r--r--   0 runner    (1001) docker     (127)     7481 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/step3_mm_nrg_csv.py
--rw-r--r--   0 runner    (1001) docker     (127)      961 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/step4_aggregate.py
--rw-r--r--   0 runner    (1001) docker     (127)     3643 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/ukbb_to_nrg_processing.py
--rw-r--r--   0 runner    (1001) docker     (127)     4546 2024-05-22 18:39:01.000000 antspymm-1.3.7/docs/ukbb_to_nrg_processing2.py
--rw-r--r--   0 runner    (1001) docker     (127)      696 2024-05-22 18:39:01.000000 antspymm-1.3.7/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-22 18:39:06.244264 antspymm-1.3.7/setup.cfg
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-22 18:39:06.244264 antspymm-1.3.7/tests/
--rw-r--r--   0 runner    (1001) docker     (127)     1855 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/blind_qc.py
--rw-r--r--   0 runner    (1001) docker     (127)     5589 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/mm.py
--rw-r--r--   0 runner    (1001) docker     (127)     2087 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/mm_nrg.py
--rw-r--r--   0 runner    (1001) docker     (127)     1563 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/outlierness.py
--rw-r--r--   0 runner    (1001) docker     (127)      830 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/parallel_study_aggregation_example.py
--rw-r--r--   0 runner    (1001) docker     (127)      109 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/test_00_setup.py
--rw-r--r--   0 runner    (1001) docker     (127)      440 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/test_bids_2_nrg.py
--rw-r--r--   0 runner    (1001) docker     (127)     2732 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/test_deformation_gradient_reo.py
--rw-r--r--   0 runner    (1001) docker     (127)      379 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/test_dti_recon.py
--rw-r--r--   0 runner    (1001) docker     (127)     1500 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/test_dti_reg.py
--rw-r--r--   0 runner    (1001) docker     (127)     3924 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/test_dwi_rebasing.py
--rw-r--r--   0 runner    (1001) docker     (127)     1275 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/test_dwi_run.py
--rw-r--r--   0 runner    (1001) docker     (127)     1751 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/test_dwi_run_ptbp_scrub.py
--rw-r--r--   0 runner    (1001) docker     (127)      445 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/test_flair_run.py
--rw-r--r--   0 runner    (1001) docker     (127)     3364 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/test_joint_dti_recon.py
--rw-r--r--   0 runner    (1001) docker     (127)     1497 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/test_mm_csv.py
--rw-r--r--   0 runner    (1001) docker     (127)     2900 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/test_nrg_validation.py
--rw-r--r--   0 runner    (1001) docker     (127)     2272 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/test_perfusion_ptbp.py
--rw-r--r--   0 runner    (1001) docker     (127)     1707 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/test_perfusion_run.py
--rw-r--r--   0 runner    (1001) docker     (127)     2101 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/test_rsfmri_run.py
--rw-r--r--   0 runner    (1001) docker     (127)     1903 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/test_rsfmri_run_minimal.py
--rw-r--r--   0 runner    (1001) docker     (127)      762 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/test_ukbb_rsfmri.py
--rw-r--r--   0 runner    (1001) docker     (127)      597 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/testsr.py
--rw-r--r--   0 runner    (1001) docker     (127)     1439 2024-05-22 18:39:01.000000 antspymm-1.3.7/tests/visualize_tractogram.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 14:00:46.506516 antspymm-1.3.8/
+-rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-05-29 14:00:38.000000 antspymm-1.3.8/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)       33 2024-05-29 14:00:38.000000 antspymm-1.3.8/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    14860 2024-05-29 14:00:46.506516 antspymm-1.3.8/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)    14244 2024-05-29 14:00:38.000000 antspymm-1.3.8/README.md
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 14:00:46.482516 antspymm-1.3.8/antspymm/
+-rw-r--r--   0 runner    (1001) docker     (127)     4462 2024-05-29 14:00:38.000000 antspymm-1.3.8/antspymm/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)   480752 2024-05-29 14:00:38.000000 antspymm-1.3.8/antspymm/mm.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 14:00:46.506516 antspymm-1.3.8/antspymm.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    14860 2024-05-29 14:00:46.000000 antspymm-1.3.8/antspymm.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     1346 2024-05-29 14:00:46.000000 antspymm-1.3.8/antspymm.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-29 14:00:46.000000 antspymm-1.3.8/antspymm.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      134 2024-05-29 14:00:46.000000 antspymm-1.3.8/antspymm.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        9 2024-05-29 14:00:46.000000 antspymm-1.3.8/antspymm.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 14:00:46.502516 antspymm-1.3.8/docs/
+-rw-r--r--   0 runner    (1001) docker     (127)     1508 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/adni_rsfmri_2_nrg_conversion.py
+-rw-r--r--   0 runner    (1001) docker     (127)   594290 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/antspymm_data_dictionary.csv
+-rw-r--r--   0 runner    (1001) docker     (127)      567 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/bids_cohort_example.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3342 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/blind_qc.Rmd
+-rw-r--r--   0 runner    (1001) docker     (127)  1055592 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/blind_qc.html
+-rw-r--r--   0 runner    (1001) docker     (127)     1445 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/convert_adni_dti_to_nrg.R
+-rw-r--r--   0 runner    (1001) docker     (127)   450556 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/deepnbm.jpg
+-rw-r--r--   0 runner    (1001) docker     (127)   525580 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/example_antspymm_output.csv
+-rw-r--r--   0 runner    (1001) docker     (127)     1296 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/example_run_from_directory.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28375 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/make_dict_table.Rmd
+-rw-r--r--   0 runner    (1001) docker     (127)  9773579 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/make_dict_table.html
+-rw-r--r--   0 runner    (1001) docker     (127)      632 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/nrg_cohort_example.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5369 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/ptbp_nrg.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5971 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/roi_visualization.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1732 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/roi_visualization_ppmi.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1965 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/step1_blind_qc.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3781 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/step2_outlierness.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7481 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/step3_mm_nrg_csv.py
+-rw-r--r--   0 runner    (1001) docker     (127)      961 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/step4_aggregate.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3643 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/ukbb_to_nrg_processing.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4546 2024-05-29 14:00:38.000000 antspymm-1.3.8/docs/ukbb_to_nrg_processing2.py
+-rw-r--r--   0 runner    (1001) docker     (127)      696 2024-05-29 14:00:38.000000 antspymm-1.3.8/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-29 14:00:46.506516 antspymm-1.3.8/setup.cfg
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 14:00:46.506516 antspymm-1.3.8/tests/
+-rw-r--r--   0 runner    (1001) docker     (127)      440 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/bids_2_nrg.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1855 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/blind_qc.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2732 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/deformation_gradient_reo.py
+-rw-r--r--   0 runner    (1001) docker     (127)      379 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/dti_recon.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1500 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/dti_reg.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3924 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/dwi_rebasing.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1275 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/dwi_run.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1751 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/dwi_run_ptbp_scrub.py
+-rw-r--r--   0 runner    (1001) docker     (127)      445 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/flair_run.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3364 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/joint_dti_recon.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5589 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/mm.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1497 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/mm_csv.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2087 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/mm_nrg.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2900 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/nrg_validation.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1563 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/outlierness.py
+-rw-r--r--   0 runner    (1001) docker     (127)      830 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/parallel_study_aggregation_example.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2272 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/perfusion_ptbp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1707 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/perfusion_run.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2101 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/rsfmri_run.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1903 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/rsfmri_run_minimal.py
+-rw-r--r--   0 runner    (1001) docker     (127)      602 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/test_reference_run.py
+-rw-r--r--   0 runner    (1001) docker     (127)      597 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/testsr.py
+-rw-r--r--   0 runner    (1001) docker     (127)      762 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/ukbb_rsfmri.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1439 2024-05-29 14:00:38.000000 antspymm-1.3.8/tests/visualize_tractogram.py
```

### Comparing `antspymm-1.3.7/LICENSE` & `antspymm-1.3.8/LICENSE`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/PKG-INFO` & `antspymm-1.3.8/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: antspymm
-Version: 1.3.7
+Version: 1.3.8
 Summary: multi-channel/time-series medical image processing with antspyx
 Author-email: "Avants, Gosselin, Tustison, Reardon" <stnava@gmail.com>
 License: Apache 2.0
 Requires-Python: >=3.8
 Description-Content-Type: text/markdown
 License-File: LICENSE
 Requires-Dist: h5py>=2.10.0
```

### Comparing `antspymm-1.3.7/README.md` & `antspymm-1.3.8/README.md`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/antspymm/__init__.py` & `antspymm-1.3.8/antspymm/__init__.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/antspymm/mm.py` & `antspymm-1.3.8/antspymm/mm.py`

 * *Files 0% similar despite different names*

```diff
@@ -11623,18368 +11623,18425 @@
 0002d660: 7370 7974 3177 2e6d 6572 6765 5f68 6965  spyt1w.merge_hie
 0002d670: 7261 7263 6869 6361 6c5f 6373 7673 5f74  rarchical_csvs_t
 0002d680: 6f5f 7769 6465 5f66 6f72 6d61 7428 0a20  o_wide_format(. 
 0002d690: 2020 2020 2020 2020 2020 2020 207b 274e               {'N
 0002d6a0: 4d27 203a 206e 6d64 667d 2c0a 2020 2020  M' : nmdf},.    
 0002d6b0: 2020 2020 2020 2020 2020 636f 6c5f 6e61            col_na
 0002d6c0: 6d65 7320 3d20 5b27 4d65 616e 275d 2029  mes = ['Mean'] )
-0002d6d0: 0a20 2069 6620 7665 7262 6f73 653a 0a20  .  if verbose:. 
-0002d6e0: 2020 2020 2070 7269 6e74 2820 226e 6d20       print( "nm 
-0002d6f0: 646f 6e65 2220 290a 0a20 2072 725f 6d61  done" )..  rr_ma
-0002d700: 736b 203d 2061 6e74 732e 6d61 736b 5f69  sk = ants.mask_i
-0002d710: 6d61 6765 2820 6c61 6265 6c73 326e 6d2c  mage( labels2nm,
-0002d720: 206c 6162 656c 7332 6e6d 2c20 5b33 332c   labels2nm, [33,
-0002d730: 3334 5d20 2c20 6269 6e61 7269 7a65 3d54  34] , binarize=T
-0002d740: 7275 6520 290a 2020 736e 5f6d 6173 6b20  rue ).  sn_mask 
-0002d750: 3d20 616e 7473 2e6d 6173 6b5f 696d 6167  = ants.mask_imag
-0002d760: 6528 206c 6162 656c 7332 6e6d 2c20 6c61  e( labels2nm, la
-0002d770: 6265 6c73 326e 6d2c 205b 372c 392c 3233  bels2nm, [7,9,23
-0002d780: 2c32 355d 202c 2062 696e 6172 697a 653d  ,25] , binarize=
-0002d790: 5472 7565 2029 0a20 206e 6d61 7667 736e  True ).  nmavgsn
-0002d7a0: 7220 3d20 6d61 736b 5f73 6e72 2820 6e6d  r = mask_snr( nm
-0002d7b0: 5f61 7667 5f63 726f 7070 6564 2c20 7272  _avg_cropped, rr
-0002d7c0: 5f6d 6173 6b2c 2073 6e5f 6d61 736b 2c20  _mask, sn_mask, 
-0002d7d0: 6269 6173 5f63 6f72 7265 6374 203d 2046  bias_correct = F
-0002d7e0: 616c 7365 2029 0a0a 2020 736e 6176 6720  alse )..  snavg 
-0002d7f0: 3d20 6e6d 5f61 7667 5f63 726f 7070 6564  = nm_avg_cropped
-0002d800: 5b20 736e 5f6d 6173 6b20 3d3d 2031 5d2e  [ sn_mask == 1].
-0002d810: 6d65 616e 2829 0a20 2072 7261 7667 203d  mean().  rravg =
-0002d820: 206e 6d5f 6176 675f 6372 6f70 7065 645b   nm_avg_cropped[
-0002d830: 2072 725f 6d61 736b 203d 3d20 315d 2e6d   rr_mask == 1].m
-0002d840: 6561 6e28 290a 2020 736e 7374 6420 3d20  ean().  snstd = 
-0002d850: 6e6d 5f61 7667 5f63 726f 7070 6564 5b20  nm_avg_cropped[ 
-0002d860: 736e 5f6d 6173 6b20 3d3d 2031 5d2e 7374  sn_mask == 1].st
-0002d870: 6428 290a 2020 7272 7374 6420 3d20 6e6d  d().  rrstd = nm
-0002d880: 5f61 7667 5f63 726f 7070 6564 5b20 7272  _avg_cropped[ rr
-0002d890: 5f6d 6173 6b20 3d3d 2031 5d2e 7374 6428  _mask == 1].std(
-0002d8a0: 290a 2020 736e 766f 6c20 3d20 6e70 2e70  ).  snvol = np.p
-0002d8b0: 726f 6428 2061 6e74 732e 6765 745f 7370  rod( ants.get_sp
-0002d8c0: 6163 696e 6728 736e 5f6d 6173 6b29 2029  acing(sn_mask) )
-0002d8d0: 202a 2073 6e5f 6d61 736b 2e73 756d 2829   * sn_mask.sum()
-0002d8e0: 0a0a 2020 2320 6765 7420 7468 6520 6d65  ..  # get the me
-0002d8f0: 616e 2076 6f78 656c 2070 6f73 6974 696f  an voxel positio
-0002d900: 6e20 6f66 2074 6865 2053 4e0a 2020 6966  n of the SN.  if
-0002d910: 2073 6e76 6f6c 203e 2030 3a0a 2020 2020   snvol > 0:.    
-0002d920: 2020 736e 5f7a 203d 2061 6e74 732e 7472    sn_z = ants.tr
-0002d930: 616e 7366 6f72 6d5f 7068 7973 6963 616c  ansform_physical
-0002d940: 5f70 6f69 6e74 5f74 6f5f 696e 6465 7828  _point_to_index(
-0002d950: 2073 6e5f 6d61 736b 2c20 616e 7473 2e67   sn_mask, ants.g
-0002d960: 6574 5f63 656e 7465 725f 6f66 5f6d 6173  et_center_of_mas
-0002d970: 7328 736e 5f6d 6173 6b20 2929 5b32 5d0a  s(sn_mask ))[2].
-0002d980: 2020 2020 2020 736e 5f7a 203d 2073 6e5f        sn_z = sn_
-0002d990: 7a2f 736e 5f6d 6173 6b2e 7368 6170 655b  z/sn_mask.shape[
-0002d9a0: 325d 2023 2061 726f 756e 6420 302e 3520  2] # around 0.5 
-0002d9b0: 776f 756c 6420 6265 206e 6963 650a 2020  would be nice.  
-0002d9c0: 656c 7365 3a0a 2020 2020 2020 736e 5f7a  else:.      sn_z
-0002d9d0: 203d 206d 6174 682e 6e61 6e0a 0a20 206e   = math.nan..  n
-0002d9e0: 6d5f 6576 7220 3d20 616e 7473 7079 7431  m_evr = antspyt1
-0002d9f0: 772e 7061 7463 685f 6569 6765 6e76 616c  w.patch_eigenval
-0002da00: 7565 5f72 6174 696f 2820 6e6d 5f61 7667  ue_ratio( nm_avg
-0002da10: 2c20 3531 322c 205b 362c 362c 365d 2c20  , 512, [6,6,6], 
-0002da20: 6576 6465 7074 6820 3d20 302e 392c 206d  evdepth = 0.9, m
-0002da30: 6173 6b3d 6372 6f70 7065 7232 6e6d 2029  ask=cropper2nm )
-0002da40: 0a0a 2020 7265 7475 726e 7b0a 2020 2020  ..  return{.    
-0002da50: 2020 274e 4d5f 6176 6727 203a 206e 6d5f    'NM_avg' : nm_
-0002da60: 6176 672c 0a20 2020 2020 2027 4e4d 5f61  avg,.      'NM_a
-0002da70: 7667 5f63 726f 7070 6564 2720 3a20 6e6d  vg_cropped' : nm
-0002da80: 5f61 7667 5f63 726f 7070 6564 2c0a 2020  _avg_cropped,.  
-0002da90: 2020 2020 274e 4d5f 6c61 6265 6c73 273a      'NM_labels':
-0002daa0: 206c 6162 656c 7332 6e6d 2c0a 2020 2020   labels2nm,.    
-0002dab0: 2020 274e 4d5f 6372 6f70 7065 6427 3a20    'NM_cropped': 
-0002dac0: 6372 6f70 5f6e 6d5f 6c69 7374 2c0a 2020  crop_nm_list,.  
-0002dad0: 2020 2020 274e 4d5f 6d69 6462 7261 696e      'NM_midbrain
-0002dae0: 524f 4927 3a20 6372 6f70 7065 7232 6e6d  ROI': cropper2nm
-0002daf0: 2c0a 2020 2020 2020 274e 4d5f 6461 7461  ,.      'NM_data
-0002db00: 6672 616d 6527 3a20 6e6d 6466 2c0a 2020  frame': nmdf,.  
-0002db10: 2020 2020 274e 4d5f 6461 7461 6672 616d      'NM_datafram
-0002db20: 655f 7769 6465 273a 206e 6d64 665f 7769  e_wide': nmdf_wi
-0002db30: 6465 2c0a 2020 2020 2020 2774 315f 746f  de,.      't1_to
-0002db40: 5f4e 4d27 3a20 736c 6162 7265 675b 2777  _NM': slabreg['w
-0002db50: 6172 7065 646d 6f76 6f75 7427 5d2c 0a20  arpedmovout'],. 
-0002db60: 2020 2020 2027 7431 5f74 6f5f 4e4d 5f74       't1_to_NM_t
-0002db70: 7261 6e73 666f 726d 2720 3a20 736c 6162  ransform' : slab
-0002db80: 7265 675b 2766 7764 7472 616e 7366 6f72  reg['fwdtransfor
-0002db90: 6d73 275d 2c0a 2020 2020 2020 274e 4d5f  ms'],.      'NM_
-0002dba0: 6176 675f 7369 676e 616c 746f 6e6f 6973  avg_signaltonois
-0002dbb0: 6527 203a 206e 6d61 7667 736e 722c 0a20  e' : nmavgsnr,. 
-0002dbc0: 2020 2020 2027 4e4d 5f61 7667 5f73 7562       'NM_avg_sub
-0002dbd0: 7374 616e 7469 616e 6967 7261 2720 3a20  stantianigra' : 
-0002dbe0: 736e 6176 672c 0a20 2020 2020 2027 4e4d  snavg,.      'NM
-0002dbf0: 5f73 7464 5f73 7562 7374 616e 7469 616e  _std_substantian
-0002dc00: 6967 7261 2720 3a20 736e 7374 642c 0a20  igra' : snstd,. 
-0002dc10: 2020 2020 2027 4e4d 5f76 6f6c 756d 655f       'NM_volume_
-0002dc20: 7375 6273 7461 6e74 6961 6e69 6772 6127  substantianigra'
-0002dc30: 203a 2073 6e76 6f6c 2c0a 2020 2020 2020   : snvol,.      
-0002dc40: 274e 4d5f 6176 675f 7265 6672 6567 696f  'NM_avg_refregio
-0002dc50: 6e27 203a 2072 7261 7667 2c0a 2020 2020  n' : rravg,.    
-0002dc60: 2020 274e 4d5f 7374 645f 7265 6672 6567    'NM_std_refreg
-0002dc70: 696f 6e27 203a 2072 7273 7464 2c0a 2020  ion' : rrstd,.  
-0002dc80: 2020 2020 274e 4d5f 6d69 6e27 203a 206e      'NM_min' : n
-0002dc90: 6d5f 6176 675f 6372 6f70 7065 642e 6d69  m_avg_cropped.mi
-0002dca0: 6e28 292c 0a20 2020 2020 2027 4e4d 5f6d  n(),.      'NM_m
-0002dcb0: 6178 2720 3a20 6e6d 5f61 7667 5f63 726f  ax' : nm_avg_cro
-0002dcc0: 7070 6564 2e6d 6178 2829 2c0a 2020 2020  pped.max(),.    
-0002dcd0: 2020 274e 4d5f 6d65 616e 2720 3a20 6e6d    'NM_mean' : nm
-0002dce0: 5f61 7667 5f63 726f 7070 6564 2e6e 756d  _avg_cropped.num
-0002dcf0: 7079 2829 2e6d 6561 6e28 292c 0a20 2020  py().mean(),.   
-0002dd00: 2020 2027 4e4d 5f73 6427 203a 206e 702e     'NM_sd' : np.
-0002dd10: 7374 6428 206e 6d5f 6176 675f 6372 6f70  std( nm_avg_crop
-0002dd20: 7065 642e 6e75 6d70 7928 2920 292c 0a20  ped.numpy() ),. 
-0002dd30: 2020 2020 2027 4e4d 5f71 3070 7430 3527       'NM_q0pt05'
-0002dd40: 203a 206e 702e 7175 616e 7469 6c65 2820   : np.quantile( 
-0002dd50: 6e6d 5f61 7667 5f63 726f 7070 6564 2e6e  nm_avg_cropped.n
-0002dd60: 756d 7079 2829 2c20 302e 3035 2029 2c0a  umpy(), 0.05 ),.
-0002dd70: 2020 2020 2020 274e 4d5f 7130 7074 3130        'NM_q0pt10
-0002dd80: 2720 3a20 6e70 2e71 7561 6e74 696c 6528  ' : np.quantile(
-0002dd90: 206e 6d5f 6176 675f 6372 6f70 7065 642e   nm_avg_cropped.
-0002dda0: 6e75 6d70 7928 292c 2030 2e31 3020 292c  numpy(), 0.10 ),
-0002ddb0: 0a20 2020 2020 2027 4e4d 5f71 3070 7439  .      'NM_q0pt9
-0002ddc0: 3027 203a 206e 702e 7175 616e 7469 6c65  0' : np.quantile
-0002ddd0: 2820 6e6d 5f61 7667 5f63 726f 7070 6564  ( nm_avg_cropped
-0002dde0: 2e6e 756d 7079 2829 2c20 302e 3930 2029  .numpy(), 0.90 )
-0002ddf0: 2c0a 2020 2020 2020 274e 4d5f 7130 7074  ,.      'NM_q0pt
-0002de00: 3935 2720 3a20 6e70 2e71 7561 6e74 696c  95' : np.quantil
-0002de10: 6528 206e 6d5f 6176 675f 6372 6f70 7065  e( nm_avg_croppe
-0002de20: 642e 6e75 6d70 7928 292c 2030 2e39 3520  d.numpy(), 0.95 
-0002de30: 292c 0a20 2020 2020 2027 4e4d 5f73 7562  ),.      'NM_sub
-0002de40: 7374 616e 7469 616e 6967 7261 5f7a 5f63  stantianigra_z_c
-0002de50: 6f6f 7264 696e 6174 6527 203a 2073 6e5f  oordinate' : sn_
-0002de60: 7a2c 0a20 2020 2020 2027 4e4d 5f65 7672  z,.      'NM_evr
-0002de70: 2720 3a20 6e6d 5f65 7672 2c0a 2020 2020  ' : nm_evr,.    
-0002de80: 2020 274e 4d5f 636f 756e 7427 3a20 6c65    'NM_count': le
-0002de90: 6e28 206c 6973 745f 6e6d 5f69 6d61 6765  n( list_nm_image
-0002dea0: 7320 290a 2020 2020 2020 207d 0a0a 0a0a  s ).       }....
-0002deb0: 6465 6620 6573 7469 6d61 7465 5f6f 7074  def estimate_opt
-0002dec0: 696d 616c 5f70 6361 5f63 6f6d 706f 6e65  imal_pca_compone
-0002ded0: 6e74 7328 6461 7461 2c20 7661 7269 616e  nts(data, varian
-0002dee0: 6365 5f74 6872 6573 686f 6c64 3d30 2e38  ce_threshold=0.8
-0002def0: 302c 2070 6c6f 743d 4661 6c73 6529 3a0a  0, plot=False):.
-0002df00: 2020 2020 2222 220a 2020 2020 4573 7469      """.    Esti
-0002df10: 6d61 7465 2074 6865 206f 7074 696d 616c  mate the optimal
-0002df20: 206e 756d 6265 7220 6f66 2050 4341 2063   number of PCA c
-0002df30: 6f6d 706f 6e65 6e74 7320 746f 2072 6570  omponents to rep
-0002df40: 7265 7365 6e74 2074 6865 2067 6976 656e  resent the given
-0002df50: 2064 6174 612e 0a0a 2020 2020 3a70 6172   data...    :par
-0002df60: 616d 2064 6174 613a 2054 6865 2064 6174  am data: The dat
-0002df70: 6120 6d61 7472 6978 2028 7361 6d70 6c65  a matrix (sample
-0002df80: 7320 7820 6665 6174 7572 6573 292e 0a20  s x features).. 
-0002df90: 2020 203a 7061 7261 6d20 7661 7269 616e     :param varian
-0002dfa0: 6365 5f74 6872 6573 686f 6c64 3a20 5468  ce_threshold: Th
-0002dfb0: 7265 7368 6f6c 6420 666f 7220 6375 6d75  reshold for cumu
-0002dfc0: 6c61 7469 7665 2065 7870 6c61 696e 6564  lative explained
-0002dfd0: 2076 6172 6961 6e63 6520 2864 6566 6175   variance (defau
-0002dfe0: 6c74 2030 2e39 3529 2e0a 2020 2020 3a70  lt 0.95)..    :p
-0002dff0: 6172 616d 2070 6c6f 743a 2049 6620 5472  aram plot: If Tr
-0002e000: 7565 2c20 706c 6f74 2074 6865 2063 756d  ue, plot the cum
-0002e010: 756c 6174 6976 6520 6578 706c 6169 6e65  ulative explaine
-0002e020: 6420 7661 7269 616e 6365 2067 7261 7068  d variance graph
-0002e030: 2028 6465 6661 756c 7420 4661 6c73 6529   (default False)
-0002e040: 2e0a 2020 2020 3a72 6574 7572 6e3a 2054  ..    :return: T
-0002e050: 6865 206f 7074 696d 616c 206e 756d 6265  he optimal numbe
-0002e060: 7220 6f66 2070 7269 6e63 6970 616c 2063  r of principal c
-0002e070: 6f6d 706f 6e65 6e74 732e 0a20 2020 2022  omponents..    "
-0002e080: 2222 0a20 2020 2069 6d70 6f72 7420 6e75  "".    import nu
-0002e090: 6d70 7920 6173 206e 700a 2020 2020 6672  mpy as np.    fr
-0002e0a0: 6f6d 2073 6b6c 6561 726e 2e64 6563 6f6d  om sklearn.decom
-0002e0b0: 706f 7369 7469 6f6e 2069 6d70 6f72 7420  position import 
-0002e0c0: 5043 410a 2020 2020 696d 706f 7274 206d  PCA.    import m
-0002e0d0: 6174 706c 6f74 6c69 622e 7079 706c 6f74  atplotlib.pyplot
-0002e0e0: 2061 7320 706c 740a 0a20 2020 2023 2050   as plt..    # P
-0002e0f0: 6572 666f 726d 2050 4341 0a20 2020 2070  erform PCA.    p
-0002e100: 6361 203d 2050 4341 2829 0a20 2020 2070  ca = PCA().    p
-0002e110: 6361 2e66 6974 2864 6174 6129 0a0a 2020  ca.fit(data)..  
-0002e120: 2020 2320 4361 6c63 756c 6174 6520 6375    # Calculate cu
-0002e130: 6d75 6c61 7469 7665 2065 7870 6c61 696e  mulative explain
-0002e140: 6564 2076 6172 6961 6e63 650a 2020 2020  ed variance.    
-0002e150: 6375 6d75 6c61 7469 7665 5f76 6172 6961  cumulative_varia
-0002e160: 6e63 6520 3d20 6e70 2e63 756d 7375 6d28  nce = np.cumsum(
-0002e170: 7063 612e 6578 706c 6169 6e65 645f 7661  pca.explained_va
-0002e180: 7269 616e 6365 5f72 6174 696f 5f29 0a0a  riance_ratio_)..
-0002e190: 2020 2020 2320 4465 7465 726d 696e 6520      # Determine 
-0002e1a0: 7468 6520 6e75 6d62 6572 206f 6620 636f  the number of co
-0002e1b0: 6d70 6f6e 656e 7473 2066 6f72 2064 6573  mponents for des
-0002e1c0: 6972 6564 2065 7870 6c61 696e 6564 2076  ired explained v
-0002e1d0: 6172 6961 6e63 650a 2020 2020 6e5f 636f  ariance.    n_co
-0002e1e0: 6d70 6f6e 656e 7473 203d 206e 702e 7768  mponents = np.wh
-0002e1f0: 6572 6528 6375 6d75 6c61 7469 7665 5f76  ere(cumulative_v
-0002e200: 6172 6961 6e63 6520 3e3d 2076 6172 6961  ariance >= varia
-0002e210: 6e63 655f 7468 7265 7368 6f6c 6429 5b30  nce_threshold)[0
-0002e220: 5d5b 305d 202b 2031 0a0a 2020 2020 2320  ][0] + 1..    # 
-0002e230: 4f70 7469 6f6e 616c 6c79 2070 6c6f 7420  Optionally plot 
-0002e240: 7468 6520 6578 706c 6169 6e65 6420 7661  the explained va
-0002e250: 7269 616e 6365 0a20 2020 2069 6620 706c  riance.    if pl
-0002e260: 6f74 3a0a 2020 2020 2020 2020 706c 742e  ot:.        plt.
-0002e270: 6669 6775 7265 2866 6967 7369 7a65 3d28  figure(figsize=(
-0002e280: 382c 2034 2929 0a20 2020 2020 2020 2070  8, 4)).        p
-0002e290: 6c74 2e70 6c6f 7428 6375 6d75 6c61 7469  lt.plot(cumulati
-0002e2a0: 7665 5f76 6172 6961 6e63 652c 206c 696e  ve_variance, lin
-0002e2b0: 6577 6964 7468 3d32 290a 2020 2020 2020  ewidth=2).      
-0002e2c0: 2020 706c 742e 6178 686c 696e 6528 793d    plt.axhline(y=
-0002e2d0: 7661 7269 616e 6365 5f74 6872 6573 686f  variance_thresho
-0002e2e0: 6c64 2c20 636f 6c6f 723d 2772 272c 206c  ld, color='r', l
-0002e2f0: 696e 6573 7479 6c65 3d27 2d2d 2729 0a20  inestyle='--'). 
-0002e300: 2020 2020 2020 2070 6c74 2e61 7876 6c69         plt.axvli
-0002e310: 6e65 2878 3d6e 5f63 6f6d 706f 6e65 6e74  ne(x=n_component
-0002e320: 7320 2d20 312c 2063 6f6c 6f72 3d27 7227  s - 1, color='r'
-0002e330: 2c20 6c69 6e65 7374 796c 653d 272d 2d27  , linestyle='--'
-0002e340: 290a 2020 2020 2020 2020 706c 742e 786c  ).        plt.xl
-0002e350: 6162 656c 2827 4e75 6d62 6572 206f 6620  abel('Number of 
-0002e360: 436f 6d70 6f6e 656e 7473 2729 0a20 2020  Components').   
-0002e370: 2020 2020 2070 6c74 2e79 6c61 6265 6c28       plt.ylabel(
-0002e380: 2743 756d 756c 6174 6976 6520 4578 706c  'Cumulative Expl
-0002e390: 6169 6e65 6420 5661 7269 616e 6365 2729  ained Variance')
-0002e3a0: 0a20 2020 2020 2020 2070 6c74 2e74 6974  .        plt.tit
-0002e3b0: 6c65 2827 4578 706c 6169 6e65 6420 5661  le('Explained Va
-0002e3c0: 7269 616e 6365 2062 7920 4e75 6d62 6572  riance by Number
-0002e3d0: 206f 6620 5072 696e 6369 7061 6c20 436f   of Principal Co
-0002e3e0: 6d70 6f6e 656e 7473 2729 0a20 2020 2020  mponents').     
-0002e3f0: 2020 2070 6c74 2e73 686f 7728 290a 0a20     plt.show().. 
-0002e400: 2020 2072 6574 7572 6e20 6e5f 636f 6d70     return n_comp
-0002e410: 6f6e 656e 7473 0a0a 696d 706f 7274 206e  onents..import n
-0002e420: 756d 7079 2061 7320 6e70 0a0a 6465 6620  umpy as np..def 
-0002e430: 636f 6d70 7574 655f 5065 7241 465f 766f  compute_PerAF_vo
-0002e440: 7865 6c28 7469 6d65 5f73 6572 6965 7329  xel(time_series)
-0002e450: 3a0a 2020 2020 2222 220a 2020 2020 436f  :.    """.    Co
-0002e460: 6d70 7574 6520 7468 6520 5065 7263 656e  mpute the Percen
-0002e470: 7461 6765 2041 6d70 6c69 7475 6465 2046  tage Amplitude F
-0002e480: 6c75 6374 7561 7469 6f6e 2028 5065 7241  luctuation (PerA
-0002e490: 4629 2066 6f72 2061 2067 6976 656e 2074  F) for a given t
-0002e4a0: 696d 6520 7365 7269 6573 2e0a 0a20 2020  ime series...   
-0002e4b0: 2031 302e 3133 3731 2f6a 6f75 726e 616c   10.1371/journal
-0002e4c0: 2e70 6f6e 652e 3032 3237 3032 310a 0a20  .pone.0227021.. 
-0002e4d0: 2020 2050 6572 4146 203d 2031 3030 2f6e     PerAF = 100/n
-0002e4e0: 202a 2073 756d 287c 2878 5f69 202d 206d   * sum(|(x_i - m
-0002e4f0: 292f 6d7c 2920 0a20 2020 2077 6865 7265  )/m|) .    where
-0002e500: 206d 203d 2031 2f6e 202a 2073 756d 2878   m = 1/n * sum(x
-0002e510: 5f69 292c 2078 5f69 2069 7320 7468 6520  _i), x_i is the 
-0002e520: 7369 676e 616c 2069 6e74 656e 7369 7479  signal intensity
-0002e530: 2061 7420 6561 6368 2074 696d 6520 706f   at each time po
-0002e540: 696e 742c 200a 2020 2020 616e 6420 6e20  int, .    and n 
-0002e550: 6973 2074 6865 2074 6f74 616c 206e 756d  is the total num
-0002e560: 6265 7220 6f66 2074 696d 6520 706f 696e  ber of time poin
-0002e570: 7473 2e0a 0a20 2020 203a 7061 7261 6d20  ts...    :param 
-0002e580: 7469 6d65 5f73 6572 6965 733a 204e 756d  time_series: Num
-0002e590: 7079 2061 7272 6179 206f 6620 7469 6d65  py array of time
-0002e5a0: 2073 6572 6965 7320 6461 7461 0a20 2020   series data.   
-0002e5b0: 203a 7265 7475 726e 3a20 436f 6d70 7574   :return: Comput
-0002e5c0: 6564 2050 6572 4146 2076 616c 7565 0a20  ed PerAF value. 
-0002e5d0: 2020 2022 2222 0a20 2020 206e 203d 206c     """.    n = l
-0002e5e0: 656e 2874 696d 655f 7365 7269 6573 290a  en(time_series).
-0002e5f0: 2020 2020 6d20 3d20 6e70 2e6d 6561 6e28      m = np.mean(
-0002e600: 7469 6d65 5f73 6572 6965 7329 0a20 2020  time_series).   
-0002e610: 2070 6572 4146 203d 2031 3030 202f 206e   perAF = 100 / n
-0002e620: 202a 206e 702e 7375 6d28 6e70 2e61 6273   * np.sum(np.abs
-0002e630: 2828 7469 6d65 5f73 6572 6965 7320 2d20  ((time_series - 
-0002e640: 6d29 202f 206d 2929 0a20 2020 2072 6574  m) / m)).    ret
-0002e650: 7572 6e20 7065 7241 460a 0a64 6566 2063  urn perAF..def c
-0002e660: 616c 6375 6c61 7465 5f74 7269 6d6d 6564  alculate_trimmed
-0002e670: 5f6d 6561 6e28 6461 7461 2c20 7072 6f70  _mean(data, prop
-0002e680: 6f72 7469 6f6e 5f74 6f5f 7472 696d 293a  ortion_to_trim):
-0002e690: 0a20 2020 2022 2222 0a20 2020 2043 616c  .    """.    Cal
-0002e6a0: 6375 6c61 7465 2074 6865 2074 7269 6d6d  culate the trimm
-0002e6b0: 6564 206d 6561 6e20 666f 7220 6120 6769  ed mean for a gi
-0002e6c0: 7665 6e20 6461 7461 2061 7272 6179 2e0a  ven data array..
-0002e6d0: 0a20 2020 203a 7061 7261 6d20 6461 7461  .    :param data
-0002e6e0: 3a20 4120 6e75 6d70 7920 6172 7261 7920  : A numpy array 
-0002e6f0: 6f66 2064 6174 612e 0a20 2020 203a 7061  of data..    :pa
-0002e700: 7261 6d20 7072 6f70 6f72 7469 6f6e 5f74  ram proportion_t
-0002e710: 6f5f 7472 696d 3a20 5072 6f70 6f72 7469  o_trim: Proporti
-0002e720: 6f6e 2028 3020 746f 2030 2e35 2920 6f66  on (0 to 0.5) of
-0002e730: 2064 6174 6120 746f 2074 7269 6d20 6672   data to trim fr
-0002e740: 6f6d 2065 6163 6820 656e 642e 0a20 2020  om each end..   
-0002e750: 203a 7265 7475 726e 3a20 5468 6520 7472   :return: The tr
-0002e760: 696d 6d65 6420 6d65 616e 206f 6620 7468  immed mean of th
-0002e770: 6520 6461 7461 2e0a 2020 2020 2222 220a  e data..    """.
-0002e780: 2020 2020 6672 6f6d 2073 6369 7079 2069      from scipy i
-0002e790: 6d70 6f72 7420 7374 6174 730a 2020 2020  mport stats.    
-0002e7a0: 7265 7475 726e 2073 7461 7473 2e74 7269  return stats.tri
-0002e7b0: 6d5f 6d65 616e 2864 6174 612c 2070 726f  m_mean(data, pro
-0002e7c0: 706f 7274 696f 6e5f 746f 5f74 7269 6d29  portion_to_trim)
-0002e7d0: 0a0a 6465 6620 5065 7241 4628 2078 2c20  ..def PerAF( x, 
-0002e7e0: 6d61 736b 2c20 676c 6f62 616c 6d65 616e  mask, globalmean
-0002e7f0: 3d54 7275 6520 293a 0a20 2020 2022 2222  =True ):.    """
-0002e800: 0a20 2020 2043 6f6d 7075 7465 2074 6865  .    Compute the
-0002e810: 2050 6572 6365 6e74 6167 6520 416d 706c   Percentage Ampl
-0002e820: 6974 7564 6520 466c 7563 7475 6174 696f  itude Fluctuatio
-0002e830: 6e20 2850 6572 4146 2920 666f 7220 6120  n (PerAF) for a 
-0002e840: 6769 7665 6e20 7469 6d65 2073 6572 6965  given time serie
-0002e850: 732e 0a0a 2020 2020 3130 2e31 3337 312f  s...    10.1371/
-0002e860: 6a6f 7572 6e61 6c2e 706f 6e65 2e30 3232  journal.pone.022
-0002e870: 3730 3231 0a0a 2020 2020 5065 7241 4620  7021..    PerAF 
-0002e880: 3d20 3130 302f 6e20 2a20 7375 6d28 7c28  = 100/n * sum(|(
-0002e890: 785f 6920 2d20 6d29 2f6d 7c29 200a 2020  x_i - m)/m|) .  
-0002e8a0: 2020 7768 6572 6520 6d20 3d20 312f 6e20    where m = 1/n 
-0002e8b0: 2a20 7375 6d28 785f 6929 2c20 785f 6920  * sum(x_i), x_i 
-0002e8c0: 6973 2074 6865 2073 6967 6e61 6c20 696e  is the signal in
-0002e8d0: 7465 6e73 6974 7920 6174 2065 6163 6820  tensity at each 
-0002e8e0: 7469 6d65 2070 6f69 6e74 2c20 0a20 2020  time point, .   
-0002e8f0: 2061 6e64 206e 2069 7320 7468 6520 746f   and n is the to
-0002e900: 7461 6c20 6e75 6d62 6572 206f 6620 7469  tal number of ti
-0002e910: 6d65 2070 6f69 6e74 732e 0a0a 2020 2020  me points...    
-0002e920: 3a70 6172 616d 2078 3a20 7469 6d65 2073  :param x: time s
-0002e930: 6572 6965 7320 616e 7473 496d 6167 650a  eries antsImage.
-0002e940: 2020 2020 3a70 6172 616d 206d 6173 6b3a      :param mask:
-0002e950: 2062 7261 696e 206d 6173 6b0a 2020 2020   brain mask.    
-0002e960: 3a70 6172 616d 2067 6c6f 6261 6c6d 6561  :param globalmea
-0002e970: 6e3a 2062 6f6f 6c65 616e 2069 6620 5472  n: boolean if Tr
-0002e980: 7565 2064 6976 6964 6520 6279 2074 6865  ue divide by the
-0002e990: 2067 6c6f 6261 6c6d 6561 6e20 696e 2074   globalmean in t
-0002e9a0: 6865 2062 7261 696e 206d 6173 6b0a 2020  he brain mask.  
-0002e9b0: 2020 3a72 6574 7572 6e3a 2043 6f6d 7075    :return: Compu
-0002e9c0: 7465 6420 5065 7241 4620 696d 6167 650a  ted PerAF image.
-0002e9d0: 2020 2020 2222 220a 2020 2020 7469 6d65      """.    time
-0002e9e0: 5f73 6572 6965 7320 3d20 616e 7473 2e74  _series = ants.t
-0002e9f0: 696d 6573 6572 6965 735f 746f 5f6d 6174  imeseries_to_mat
-0002ea00: 7269 7828 2078 2c20 6d61 736b 2029 0a20  rix( x, mask ). 
-0002ea10: 2020 206e 203d 2074 696d 655f 7365 7269     n = time_seri
-0002ea20: 6573 2e73 6861 7065 5b31 5d0a 2020 2020  es.shape[1].    
-0002ea30: 7665 6320 3d20 6e70 2e7a 6572 6f73 2820  vec = np.zeros( 
-0002ea40: 6e20 290a 2020 2020 666f 7220 6920 696e  n ).    for i in
-0002ea50: 2072 616e 6765 286e 293a 0a20 2020 2020   range(n):.     
-0002ea60: 2020 2076 6563 5b69 5d20 3d20 636f 6d70     vec[i] = comp
-0002ea70: 7574 655f 5065 7241 465f 766f 7865 6c28  ute_PerAF_voxel(
-0002ea80: 2074 696d 655f 7365 7269 6573 5b3a 2c69   time_series[:,i
-0002ea90: 5d20 290a 2020 2020 6f75 7469 6d67 203d  ] ).    outimg =
-0002eaa0: 2061 6e74 732e 6d61 6b65 5f69 6d61 6765   ants.make_image
-0002eab0: 2820 6d61 736b 2c20 7665 6320 290a 2020  ( mask, vec ).  
-0002eac0: 2020 6966 2067 6c6f 6261 6c6d 6561 6e3a    if globalmean:
-0002ead0: 0a20 2020 2020 2020 206f 7574 696d 6720  .        outimg 
-0002eae0: 3d20 6f75 7469 6d67 202f 2063 616c 6375  = outimg / calcu
-0002eaf0: 6c61 7465 5f74 7269 6d6d 6564 5f6d 6561  late_trimmed_mea
-0002eb00: 6e28 2076 6563 2c20 302e 3031 2029 0a20  n( vec, 0.01 ). 
-0002eb10: 2020 2072 6574 7572 6e20 6f75 7469 6d67     return outimg
-0002eb20: 0a0a 0a64 6566 2072 6573 7469 6e67 5f73  ...def resting_s
-0002eb30: 7461 7465 5f66 6d72 695f 6e65 7477 6f72  tate_fmri_networ
-0002eb40: 6b73 2820 666d 7269 2c20 666d 7269 5f74  ks( fmri, fmri_t
-0002eb50: 656d 706c 6174 652c 2074 312c 2074 3173  emplate, t1, t1s
-0002eb60: 6567 6d65 6e74 6174 696f 6e2c 0a20 2020  egmentation,.   
-0002eb70: 2066 3d5b 302e 3033 2c20 302e 3038 5d2c   f=[0.03, 0.08],
-0002eb80: 0a20 2020 2046 445f 7468 7265 7368 6f6c  .    FD_threshol
-0002eb90: 643d 352e 302c 0a20 2020 2073 7061 203d  d=5.0,.    spa =
-0002eba0: 204e 6f6e 652c 0a20 2020 2073 7074 203d   None,.    spt =
-0002ebb0: 204e 6f6e 652c 0a20 2020 206e 6320 3d20   None,.    nc = 
-0002ebc0: 352c 0a20 2020 206f 7574 6c69 6572 5f74  5,.    outlier_t
-0002ebd0: 6872 6573 686f 6c64 3d30 2e32 3530 2c0a  hreshold=0.250,.
-0002ebe0: 2020 2020 6963 615f 636f 6d70 6f6e 656e      ica_componen
-0002ebf0: 7473 203d 2030 2c0a 2020 2020 696d 7075  ts = 0,.    impu
-0002ec00: 7465 203d 2054 7275 652c 0a20 2020 2063  te = True,.    c
-0002ec10: 656e 736f 7220 3d20 5472 7565 2c0a 2020  ensor = True,.  
-0002ec20: 2020 6465 7370 696b 6520 3d20 322e 352c    despike = 2.5,
-0002ec30: 0a20 2020 206d 6f74 696f 6e5f 6173 5f6e  .    motion_as_n
-0002ec40: 7569 7361 6e63 6520 3d20 5472 7565 2c0a  uisance = True,.
-0002ec50: 2020 2020 706f 7765 7273 203d 2046 616c      powers = Fal
-0002ec60: 7365 2c0a 2020 2020 7570 7361 6d70 6c65  se,.    upsample
-0002ec70: 203d 2033 2e30 2c0a 2020 2020 636c 6561   = 3.0,.    clea
-0002ec80: 6e5f 746d 7020 3d20 4e6f 6e65 2c0a 2020  n_tmp = None,.  
-0002ec90: 2020 7061 7261 6d73 6574 3d27 756e 7365    paramset='unse
-0002eca0: 7427 2c0a 2020 2020 7665 7262 6f73 653d  t',.    verbose=
-0002ecb0: 4661 6c73 6520 293a 0a20 2022 2222 0a20  False ):.  """. 
-0002ecc0: 2043 6f6d 7075 7465 2072 6573 7469 6e67   Compute resting
-0002ecd0: 2073 7461 7465 206e 6574 776f 726b 2063   state network c
-0002ece0: 6f72 7265 6c61 7469 6f6e 206d 6170 7320  orrelation maps 
-0002ecf0: 6261 7365 6420 6f6e 2074 6865 204a 2050  based on the J P
-0002ed00: 6f77 6572 206c 6162 656c 732e 0a20 2054  ower labels..  T
-0002ed10: 6869 7320 7769 6c6c 206f 7574 7075 7420  his will output 
-0002ed20: 6120 6d61 7020 666f 7220 6561 6368 206f  a map for each o
-0002ed30: 6620 7468 6520 6d61 6a6f 7220 6e65 7477  f the major netw
-0002ed40: 6f72 6b20 7379 7374 656d 732e 2020 5468  ork systems.  Th
-0002ed50: 6973 2066 756e 6374 696f 6e20 0a20 2077  is function .  w
-0002ed60: 696c 6c20 6279 206f 7074 696f 6e61 6c6c  ill by optionall
-0002ed70: 7920 7570 7361 6d70 6c65 2064 6174 6120  y upsample data 
-0002ed80: 746f 2032 6d6d 2064 7572 696e 6720 7468  to 2mm during th
-0002ed90: 6520 7265 6769 7374 7261 7469 6f6e 2070  e registration p
-0002eda0: 726f 6365 7373 2069 6620 6461 7461 200a  rocess if data .
-0002edb0: 2020 6973 2062 656c 6f77 2074 6861 7420    is below that 
-0002edc0: 7265 736f 6c75 7469 6f6e 2e0a 0a20 2072  resolution...  r
-0002edd0: 6567 6973 7472 6174 696f 6e20 2d20 6465  egistration - de
-0002ede0: 7370 696b 6520 2d20 616e 6174 6f6d 7920  spike - anatomy 
-0002edf0: 2d20 736d 6f6f 7468 202d 206e 7569 7361  - smooth - nuisa
-0002ee00: 6e63 6520 2d20 6261 6e64 7061 7373 202d  nce - bandpass -
-0002ee10: 2072 6567 7265 7373 2e6e 7569 7361 6e63   regress.nuisanc
-0002ee20: 6520 2d20 6365 6e73 6f72 202d 2066 616c  e - censor - fal
-0002ee30: 6666 202d 2063 6f72 7265 6c61 7469 6f6e  ff - correlation
-0002ee40: 730a 0a20 2041 7267 756d 656e 7473 0a20  s..  Arguments. 
-0002ee50: 202d 2d2d 2d2d 2d2d 2d2d 0a20 2066 6d72   ---------.  fmr
-0002ee60: 6920 3a20 424f 4c44 2066 6d72 6920 616e  i : BOLD fmri an
-0002ee70: 7473 496d 6167 650a 0a20 2066 6d72 695f  tsImage..  fmri_
-0002ee80: 7465 6d70 6c61 7465 203a 2072 6566 6572  template : refer
-0002ee90: 656e 6365 2073 7061 6365 2066 6f72 2042  ence space for B
-0002eea0: 4f4c 440a 0a20 2074 3120 3a20 414e 5473  OLD..  t1 : ANTs
-0002eeb0: 496d 6167 650a 2020 2020 696e 7075 7420  Image.    input 
-0002eec0: 332d 4420 5431 2062 7261 696e 2069 6d61  3-D T1 brain ima
-0002eed0: 6765 2028 6272 6169 6e20 6578 7472 6163  ge (brain extrac
-0002eee0: 7465 6429 0a0a 2020 7431 7365 676d 656e  ted)..  t1segmen
-0002eef0: 7461 7469 6f6e 203a 2041 4e54 7349 6d61  tation : ANTsIma
-0002ef00: 6765 0a20 2020 2074 3120 7365 676d 656e  ge.    t1 segmen
-0002ef10: 7461 7469 6f6e 202d 2061 2073 6978 2074  tation - a six t
-0002ef20: 6973 7375 6520 7365 676d 656e 7461 7469  issue segmentati
-0002ef30: 6f6e 2069 6d61 6765 2069 6e20 5431 2073  on image in T1 s
-0002ef40: 7061 6365 0a0a 2020 6620 3a20 6261 6e64  pace..  f : band
-0002ef50: 2070 6173 7320 6c69 6d69 7473 2066 6f72   pass limits for
-0002ef60: 2066 7265 7175 656e 6379 2066 696c 7465   frequency filte
-0002ef70: 7269 6e67 3b20 7765 2075 7365 2068 6967  ring; we use hig
-0002ef80: 682d 7061 7373 2068 6572 6520 6173 2070  h-pass here as p
-0002ef90: 6572 2053 6869 7265 7220 3230 3135 0a0a  er Shirer 2015..
-0002efa0: 2020 7370 6120 3a20 6761 7573 7369 616e    spa : gaussian
-0002efb0: 2073 6d6f 6f74 6869 6e67 2066 6f72 2073   smoothing for s
-0002efc0: 7061 7469 616c 2063 6f6d 706f 6e65 6e74  patial component
-0002efd0: 2028 7068 7973 6963 616c 2063 6f6f 7264   (physical coord
-0002efe0: 696e 6174 6573 290a 0a20 2073 7074 203a  inates)..  spt :
-0002eff0: 2067 6175 7373 6961 6e20 736d 6f6f 7468   gaussian smooth
-0002f000: 696e 6720 666f 7220 7465 6d70 6f72 616c  ing for temporal
-0002f010: 2063 6f6d 706f 6e65 6e74 0a0a 2020 6e63   component..  nc
-0002f020: 2020 3a20 6e75 6d62 6572 206f 6620 636f    : number of co
-0002f030: 6d70 6f6e 656e 7473 2066 6f72 2063 6f6d  mponents for com
-0002f040: 7063 6f72 2066 696c 7465 7269 6e67 3b20  pcor filtering; 
-0002f050: 6966 206c 6573 7320 7468 616e 2031 2077  if less than 1 w
-0002f060: 6520 6573 7469 6d61 7465 206f 6e20 7468  e estimate on th
-0002f070: 6520 666c 7920 6261 7365 6420 6f6e 2065  e fly based on e
-0002f080: 7870 6c61 696e 6564 2076 6172 6961 6e63  xplained varianc
-0002f090: 653b 2031 3020 7772 7420 5368 6972 6572  e; 10 wrt Shirer
-0002f0a0: 2032 3031 3520 3520 6672 6f6d 2063 7366   2015 5 from csf
-0002f0b0: 2061 6e64 2035 2066 726f 6d20 776d 0a0a   and 5 from wm..
-0002f0c0: 2020 6963 615f 636f 6d70 6f6e 656e 7473    ica_components
-0002f0d0: 203a 2069 6e74 6567 6572 2069 6620 6772   : integer if gr
-0002f0e0: 6561 7465 7220 7468 616e 2030 2074 6865  eater than 0 the
-0002f0f0: 6e20 696e 636c 7564 6520 6963 6120 636f  n include ica co
-0002f100: 6d70 6f6e 656e 7473 0a0a 2020 696d 7075  mponents..  impu
-0002f110: 7465 203a 2062 6f6f 6c65 616e 2069 6620  te : boolean if 
-0002f120: 5472 7565 2c20 7468 656e 2075 7365 2069  True, then use i
-0002f130: 6d70 7574 6174 696f 6e20 696e 2066 2f41  mputation in f/A
-0002f140: 4c46 462c 2050 6572 4146 2063 616c 6375  LFF, PerAF calcu
-0002f150: 6c61 7469 6f6e 0a0a 2020 6365 6e73 6f72  lation..  censor
-0002f160: 203a 2062 6f6f 6c65 616e 2069 6620 5472   : boolean if Tr
-0002f170: 7565 2c20 7468 656e 2075 7365 2063 656e  ue, then use cen
-0002f180: 736f 7269 6e67 2028 6365 6e73 6f72 696e  soring (censorin
-0002f190: 6729 0a0a 2020 6465 7370 696b 6520 3a20  g)..  despike : 
-0002f1a0: 6966 2074 6869 7320 6973 2067 7265 6174  if this is great
-0002f1b0: 6572 2074 6861 6e20 7a65 726f 2077 696c  er than zero wil
-0002f1c0: 6c20 7275 6e20 766f 7865 6c2d 7769 7365  l run voxel-wise
-0002f1d0: 2064 6573 7069 6b69 6e67 2069 6e20 7468   despiking in th
-0002f1e0: 6520 3364 4465 7370 696b 6520 2861 666e  e 3dDespike (afn
-0002f1f0: 6929 2073 656e 7365 3b20 6166 7465 7220  i) sense; after 
-0002f200: 6d6f 7469 6f6e 2d63 6f72 7265 6374 696f  motion-correctio
-0002f210: 6e0a 0a20 206d 6f74 696f 6e5f 6173 5f6e  n..  motion_as_n
-0002f220: 7569 7361 6e63 653a 2062 6f6f 6c65 616e  uisance: boolean
-0002f230: 2077 696c 6c20 6164 6420 6d6f 7469 6f6e   will add motion
-0002f240: 2061 6e64 2066 6972 7374 2064 6572 6976   and first deriv
-0002f250: 6174 6976 6520 6f66 206d 6f74 696f 6e20  ative of motion 
-0002f260: 6173 206e 7569 7361 6e63 650a 0a20 2070  as nuisance..  p
-0002f270: 6f77 6572 7320 3a20 626f 6f6c 6561 6e20  owers : boolean 
-0002f280: 6966 2054 7275 6520 7573 6520 506f 7765  if True use Powe
-0002f290: 7273 206e 6f64 6573 206f 7468 6572 7769  rs nodes otherwi
-0002f2a0: 7365 2032 3032 3320 5965 6f20 3530 3020  se 2023 Yeo 500 
-0002f2b0: 686f 6d6f 746f 7069 6320 6e6f 6465 7320  homotopic nodes 
-0002f2c0: 2831 302e 3130 3136 2f6a 2e6e 6575 726f  (10.1016/j.neuro
-0002f2d0: 696d 6167 652e 3230 3233 2e31 3230 3031  image.2023.12001
-0002f2e0: 3029 0a0a 2020 7570 7361 6d70 6c65 203a  0)..  upsample :
-0002f2f0: 2066 6c6f 6174 206f 7074 696f 6e61 6c6c   float optionall
-0002f300: 7920 6973 6f74 726f 7069 6361 6c6c 7920  y isotropically 
-0002f310: 7570 7361 6d70 6c65 2064 6174 6120 746f  upsample data to
-0002f320: 2075 7073 616d 706c 6520 2874 6865 2070   upsample (the p
-0002f330: 6172 616d 6574 6572 2076 616c 7565 2920  arameter value) 
-0002f340: 696e 206d 6d20 6475 7269 6e67 2074 6865  in mm during the
-0002f350: 2072 6567 6973 7472 6174 696f 6e20 7072   registration pr
-0002f360: 6f63 6573 7320 6966 2064 6174 6120 6973  ocess if data is
-0002f370: 2062 656c 6f77 2074 6861 7420 7265 736f   below that reso
-0002f380: 6c75 7469 6f6e 3b20 6966 2074 6865 2069  lution; if the i
-0002f390: 6e70 7574 2073 7061 6369 6e67 2069 7320  nput spacing is 
-0002f3a0: 6c65 7373 2074 6861 6e20 7468 6174 2070  less than that p
-0002f3b0: 726f 7669 6465 6420 6279 2074 6865 2075  rovided by the u
-0002f3c0: 7365 722c 2074 6865 2064 6174 6120 7769  ser, the data wi
-0002f3d0: 6c6c 2073 696d 706c 7920 6265 2072 6573  ll simply be res
-0002f3e0: 616d 706c 6564 2074 6f20 6973 6f74 726f  ampled to isotro
-0002f3f0: 7069 6320 7265 736f 6c75 7469 6f6e 0a0a  pic resolution..
-0002f400: 2020 636c 6561 6e5f 746d 7020 3a20 7769    clean_tmp : wi
-0002f410: 6c6c 2061 7574 6f6d 6174 6963 616c 6c79  ll automatically
-0002f420: 2074 7279 2074 6f20 636c 6561 6e20 7468   try to clean th
-0002f430: 6520 746d 7020 6469 7265 6374 6f72 7920  e tmp directory 
-0002f440: 2d20 6e6f 7420 7265 636f 6d6d 656e 6465  - not recommende
-0002f450: 6420 6275 7420 6361 6e20 6265 2075 7365  d but can be use
-0002f460: 6420 696e 2064 6973 7472 6962 7574 6564  d in distributed
-0002f470: 2063 6f6d 7075 7469 6e67 2073 7973 7465   computing syste
-0002f480: 6d73 2074 6f20 6865 6c70 2070 7265 7665  ms to help preve
-0002f490: 6e74 2066 6169 6c75 7265 7320 6475 6520  nt failures due 
-0002f4a0: 746f 2061 6363 756d 756c 6174 696f 6e20  to accumulation 
-0002f4b0: 6f66 2074 6d70 2066 696c 6573 2077 6865  of tmp files whe
-0002f4c0: 6e20 646f 696e 6720 6c61 7267 652d 7363  n doing large-sc
-0002f4d0: 616c 6520 7072 6f63 6573 7369 6e67 2e20  ale processing. 
-0002f4e0: 2069 6620 7468 6973 2069 7320 7365 742c   if this is set,
-0002f4f0: 2074 6865 2066 6c6f 6174 2076 616c 7565   the float value
-0002f500: 2063 6c65 616e 5f74 6d70 2077 696c 6c20   clean_tmp will 
-0002f510: 6265 2069 6e74 6572 7072 6574 6564 2061  be interpreted a
-0002f520: 7320 7468 6520 6167 6520 696e 2068 6f75  s the age in hou
-0002f530: 7273 206f 6620 6669 6c65 7320 746f 2062  rs of files to b
-0002f540: 6520 636c 6561 6e65 642e 0a0a 2020 7665  e cleaned...  ve
-0002f550: 7262 6f73 6520 3a20 626f 6f6c 6561 6e0a  rbose : boolean.
-0002f560: 0a20 2052 6574 7572 6e73 0a20 202d 2d2d  .  Returns.  ---
-0002f570: 2d2d 2d2d 2d2d 0a20 2061 2064 6963 7469  ------.  a dicti
-0002f580: 6f6e 6172 7920 636f 6e74 6169 6e69 6e67  onary containing
-0002f590: 2074 6865 2064 6572 6976 6564 206e 6574   the derived net
-0002f5a0: 776f 726b 206d 6170 730a 0a20 2052 6566  work maps..  Ref
-0002f5b0: 6572 656e 6365 730a 2020 2d2d 2d2d 2d2d  erences.  ------
-0002f5c0: 2d2d 2d0a 0a20 2031 302e 3131 3632 2f6e  ---..  10.1162/n
-0002f5d0: 6574 6e5f 615f 3030 3037 3120 224d 6574  etn_a_00071 "Met
-0002f5e0: 686f 6473 2074 6861 7420 696e 636c 7564  hods that includ
-0002f5f0: 6564 2067 6c6f 6261 6c20 7369 676e 616c  ed global signal
-0002f600: 2072 6567 7265 7373 696f 6e20 7765 7265   regression were
-0002f610: 2074 6865 206d 6f73 7420 636f 6e73 6973   the most consis
-0002f620: 7465 6e74 6c79 2065 6666 6563 7469 7665  tently effective
-0002f630: 2064 652d 6e6f 6973 696e 6720 7374 7261   de-noising stra
-0002f640: 7465 6769 6573 2e22 0a0a 2020 3130 2e31  tegies."..  10.1
-0002f650: 3031 362f 6a2e 6e65 7572 6f69 6d61 6765  016/j.neuroimage
-0002f660: 2e32 3031 392e 3131 3631 3537 2022 6672  .2019.116157 "fr
-0002f670: 6f6e 7461 6c20 616e 6420 6465 6661 756c  ontal and defaul
-0002f680: 7420 6d6f 6465 6c20 6e65 7477 6f72 6b73  t model networks
-0002f690: 2061 7265 206d 6f73 7420 7265 6c69 6162   are most reliab
-0002f6a0: 6c65 2077 6865 7265 6173 2073 7562 636f  le whereas subco
-0002f6b0: 7274 6963 616c 206e 6574 6577 6f72 6b73  rtical neteworks
-0002f6c0: 2061 7265 206c 6561 7374 2072 656c 6961   are least relia
-0002f6d0: 626c 6522 2020 2274 6865 206d 6f73 7420  ble"  "the most 
-0002f6e0: 636f 6d70 7265 6865 6e73 6976 6520 7374  comprehensive st
-0002f6f0: 7564 6965 7320 6f66 2070 6970 656c 696e  udies of pipelin
-0002f700: 6520 6566 6665 6374 7320 6f6e 2065 6467  e effects on edg
-0002f710: 652d 6c65 7665 6c20 7265 6c69 6162 696c  e-level reliabil
-0002f720: 6974 7920 6861 7665 2062 6565 6e20 646f  ity have been do
-0002f730: 6e65 2062 7920 7368 6972 6572 2028 3230  ne by shirer (20
-0002f740: 3135 2920 616e 6420 5061 726b 6573 2028  15) and Parkes (
-0002f750: 3230 3138 2922 2022 736c 6963 6520 7469  2018)" "slice ti
-0002f760: 6d69 6e67 2063 6f72 7265 6374 696f 6e20  ming correction 
-0002f770: 6861 7320 6d69 6e69 6d61 6c20 696d 7061  has minimal impa
-0002f780: 6374 2220 2275 7365 206f 6620 6c6f 772d  ct" "use of low-
-0002f790: 7061 7373 206f 7220 6e61 7272 6f77 2066  pass or narrow f
-0002f7a0: 696c 7465 7220 2864 6973 6361 7264 696e  ilter (discardin
-0002f7b0: 6720 2068 6967 6820 6672 6571 7565 6e63  g  high frequenc
-0002f7c0: 7920 696e 666f 726d 6174 696f 6e29 2072  y information) r
-0002f7d0: 6564 7563 6564 2062 6f74 6820 7265 6c69  educed both reli
-0002f7e0: 6162 696c 6974 7920 616e 6420 7369 676e  ability and sign
-0002f7f0: 616c 2d6e 6f69 7365 2073 6570 6172 6174  al-noise separat
-0002f800: 696f 6e22 0a0a 2020 3130 2e31 3031 362f  ion"..  10.1016/
-0002f810: 6a2e 6e65 7572 6f69 6d61 6765 2e32 3031  j.neuroimage.201
-0002f820: 372e 3132 2e30 3733 3a20 4f75 7220 7265  7.12.073: Our re
-0002f830: 7375 6c74 7320 696e 6469 6361 7465 2074  sults indicate t
-0002f840: 6861 7420 2831 2920 7369 6d70 6c65 206c  hat (1) simple l
-0002f850: 696e 6561 7220 7265 6772 6573 7369 6f6e  inear regression
-0002f860: 206f 6620 7265 6769 6f6e 616c 2066 4d52   of regional fMR
-0002f870: 4920 7469 6d65 2073 6572 6965 7320 6167  I time series ag
-0002f880: 6169 6e73 7420 6865 6164 206d 6f74 696f  ainst head motio
-0002f890: 6e20 7061 7261 6d65 7465 7273 2061 6e64  n parameters and
-0002f8a0: 2057 4d2f 4353 4620 7369 676e 616c 7320   WM/CSF signals 
-0002f8b0: 2877 6974 6820 6f72 2077 6974 686f 7574  (with or without
-0002f8c0: 2065 7870 616e 7369 6f6e 2074 6572 6d73   expansion terms
-0002f8d0: 2920 6973 206e 6f74 2073 7566 6669 6369  ) is not suffici
-0002f8e0: 656e 7420 746f 2072 656d 6f76 6520 6865  ent to remove he
-0002f8f0: 6164 206d 6f74 696f 6e20 6172 7465 6661  ad motion artefa
-0002f900: 6374 733b 2028 3229 2061 436f 6d70 436f  cts; (2) aCompCo
-0002f910: 7220 7069 7065 6c69 6e65 7320 6d61 7920  r pipelines may 
-0002f920: 6f6e 6c79 2062 6520 7669 6162 6c65 2069  only be viable i
-0002f930: 6e20 6c6f 772d 6d6f 7469 6f6e 2064 6174  n low-motion dat
-0002f940: 613b 2028 3329 2076 6f6c 756d 6520 6365  a; (3) volume ce
-0002f950: 6e73 6f72 696e 6720 7065 7266 6f72 6d73  nsoring performs
-0002f960: 2077 656c 6c20 6174 206d 696e 696d 6973   well at minimis
-0002f970: 696e 6720 6d6f 7469 6f6e 2d72 656c 6174  ing motion-relat
-0002f980: 6564 2061 7274 6566 6163 7420 6275 7420  ed artefact but 
-0002f990: 6120 6d61 6a6f 7220 6265 6e65 6669 7420  a major benefit 
-0002f9a0: 6f66 2074 6869 7320 6170 7072 6f61 6368  of this approach
-0002f9b0: 2064 6572 6976 6573 2066 726f 6d20 7468   derives from th
-0002f9c0: 6520 6578 636c 7573 696f 6e20 6f66 2068  e exclusion of h
-0002f9d0: 6967 682d 6d6f 7469 6f6e 2069 6e64 6976  igh-motion indiv
-0002f9e0: 6964 7561 6c73 3b20 2834 2920 7768 696c  iduals; (4) whil
-0002f9f0: 6520 6e6f 7420 6173 2065 6666 6563 7469  e not as effecti
-0002fa00: 7665 2061 7320 766f 6c75 6d65 2063 656e  ve as volume cen
-0002fa10: 736f 7269 6e67 2c20 4943 412d 4152 4f4d  soring, ICA-AROM
-0002fa20: 4120 7065 7266 6f72 6d65 6420 7765 6c6c  A performed well
-0002fa30: 2061 6372 6f73 7320 6f75 7220 6265 6e63   across our benc
-0002fa40: 686d 6172 6b73 2066 6f72 2072 656c 6174  hmarks for relat
-0002fa50: 6976 656c 7920 6c6f 7720 636f 7374 2069  ively low cost i
-0002fa60: 6e20 7465 726d 7320 6f66 2064 6174 6120  n terms of data 
-0002fa70: 6c6f 7373 3b20 2835 2920 7468 6520 6164  loss; (5) the ad
-0002fa80: 6469 7469 6f6e 206f 6620 676c 6f62 616c  dition of global
-0002fa90: 2073 6967 6e61 6c20 7265 6772 6573 7369   signal regressi
-0002faa0: 6f6e 2069 6d70 726f 7665 6420 7468 6520  on improved the 
-0002fab0: 7065 7266 6f72 6d61 6e63 6520 6f66 206e  performance of n
-0002fac0: 6561 726c 7920 616c 6c20 7069 7065 6c69  early all pipeli
-0002fad0: 6e65 7320 6f6e 206d 6f73 7420 6265 6e63  nes on most benc
-0002fae0: 686d 6172 6b73 2c20 6275 7420 6578 6163  hmarks, but exac
-0002faf0: 6572 6261 7465 6420 7468 6520 6469 7374  erbated the dist
-0002fb00: 616e 6365 2d64 6570 656e 6465 6e63 6520  ance-dependence 
-0002fb10: 6f66 2063 6f72 7265 6c61 7469 6f6e 7320  of correlations 
-0002fb20: 6265 7477 6565 6e20 6d6f 7469 6f6e 2061  between motion a
-0002fb30: 6e64 2066 756e 6374 696f 6e61 6c20 636f  nd functional co
-0002fb40: 6e6e 6563 2d20 7469 7669 7479 3b20 616e  nnec- tivity; an
-0002fb50: 6420 2836 2920 6772 6f75 7020 636f 6d70  d (6) group comp
-0002fb60: 6172 6973 6f6e 7320 696e 2066 756e 6374  arisons in funct
-0002fb70: 696f 6e61 6c20 636f 6e6e 6563 7469 7669  ional connectivi
-0002fb80: 7479 2062 6574 7765 656e 2068 6561 6c74  ty between healt
-0002fb90: 6879 2063 6f6e 7472 6f6c 7320 616e 6420  hy controls and 
-0002fba0: 7363 6869 7a6f 7068 7265 6e69 6120 7061  schizophrenia pa
-0002fbb0: 7469 656e 7473 2061 7265 2068 6967 686c  tients are highl
-0002fbc0: 7920 6465 7065 6e64 656e 7420 6f6e 2070  y dependent on p
-0002fbd0: 7265 7072 6f63 6573 7369 6e67 2073 7472  reprocessing str
-0002fbe0: 6174 6567 792e 2057 6520 6f66 6665 7220  ategy. We offer 
-0002fbf0: 736f 6d65 2072 6563 6f6d 6d65 6e64 6174  some recommendat
-0002fc00: 696f 6e73 2066 6f72 2062 6573 7420 7072  ions for best pr
-0002fc10: 6163 7469 6365 2061 6e64 206f 7574 6c69  actice and outli
-0002fc20: 6e65 2073 696d 706c 6520 616e 616c 7973  ne simple analys
-0002fc30: 6573 2074 6f20 6661 6369 6c69 7461 7465  es to facilitate
-0002fc40: 2074 7261 6e73 7061 7265 6e74 2072 6570   transparent rep
-0002fc50: 6f72 7469 6e67 206f 6620 7468 6520 6465  orting of the de
-0002fc60: 6772 6565 2074 6f20 7768 6963 6820 6120  gree to which a 
-0002fc70: 6769 7665 6e20 7365 7420 6f66 2066 696e  given set of fin
-0002fc80: 6469 6e67 7320 6d61 7920 6265 2061 6666  dings may be aff
-0002fc90: 6563 7465 6420 6279 206d 6f74 696f 6e2d  ected by motion-
-0002fca0: 7265 6c61 7465 6420 6172 7465 6661 6374  related artefact
-0002fcb0: 2e0a 0a20 2031 302e 3130 3136 2f6a 2e64  ...  10.1016/j.d
-0002fcc0: 636e 2e32 3032 322e 3130 3130 3837 203a  cn.2022.101087 :
-0002fcd0: 2057 6520 666f 756e 6420 7468 6174 3a20   We found that: 
-0002fce0: 3129 2074 6865 206d 6f73 7420 6566 6669  1) the most effi
-0002fcf0: 6361 6369 6f75 7320 7069 7065 6c69 6e65  cacious pipeline
-0002fd00: 2066 6f72 2062 6f74 6820 6e6f 6973 6520   for both noise 
-0002fd10: 7265 6d6f 7661 6c20 616e 6420 696e 666f  removal and info
-0002fd20: 726d 6174 696f 6e20 7265 636f 7665 7279  rmation recovery
-0002fd30: 2069 6e63 6c75 6465 6420 6365 6e73 6f72   included censor
-0002fd40: 696e 672c 2047 5352 2c20 6261 6e64 7061  ing, GSR, bandpa
-0002fd50: 7373 2066 696c 7465 7269 6e67 2c20 616e  ss filtering, an
-0002fd60: 6420 6865 6164 206d 6f74 696f 6e20 7061  d head motion pa
-0002fd70: 7261 6d65 7465 7220 2848 4d50 2920 7265  rameter (HMP) re
-0002fd80: 6772 6573 7369 6f6e 2c20 3229 2049 4341  gression, 2) ICA
-0002fd90: 2d41 524f 4d41 2070 6572 666f 726d 6564  -AROMA performed
-0002fda0: 2073 696d 696c 6172 6c79 2074 6f20 484d   similarly to HM
-0002fdb0: 5020 7265 6772 6573 7369 6f6e 2061 6e64  P regression and
-0002fdc0: 2064 6964 206e 6f74 206f 6276 6961 7465   did not obviate
-0002fdd0: 2074 6865 206e 6565 6420 666f 7220 6365   the need for ce
-0002fde0: 6e73 6f72 696e 672c 2033 2920 4753 5220  nsoring, 3) GSR 
-0002fdf0: 6861 6420 6120 6d69 6e69 6d61 6c20 696d  had a minimal im
-0002fe00: 7061 6374 206f 6e20 636f 6e6e 6563 746f  pact on connecto
-0002fe10: 6d65 2066 696e 6765 7270 7269 6e74 696e  me fingerprintin
-0002fe20: 6720 6275 7420 696d 7072 6f76 6564 2049  g but improved I
-0002fe30: 5343 2c20 616e 6420 3429 2074 6865 2073  SC, and 4) the s
-0002fe40: 7472 6963 7465 7374 2063 656e 736f 7269  trictest censori
-0002fe50: 6e67 2061 7070 726f 6163 6865 7320 7265  ng approaches re
-0002fe60: 6475 6365 6420 6d6f 7469 6f6e 2063 6f72  duced motion cor
-0002fe70: 7265 6c61 7465 6420 6564 6765 7320 6275  related edges bu
-0002fe80: 7420 6e65 6761 7469 7665 6c79 2069 6d70  t negatively imp
-0002fe90: 6163 7465 6420 6964 656e 7469 6669 6162  acted identifiab
-0002fea0: 696c 6974 792e 0a0a 2020 2222 220a 0a20  ility...  """.. 
-0002feb0: 2069 6d70 6f72 7420 7761 726e 696e 6773   import warnings
-0002fec0: 0a0a 2020 6966 2063 6c65 616e 5f74 6d70  ..  if clean_tmp
-0002fed0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0002fee0: 2020 636c 6561 6e5f 746d 705f 6469 7265    clean_tmp_dire
-0002fef0: 6374 6f72 7928 2061 6765 5f68 6f75 7273  ctory( age_hours
-0002ff00: 203d 2063 6c65 616e 5f74 6d70 2029 0a0a   = clean_tmp )..
-0002ff10: 2020 6966 206e 6320 3e20 313a 0a20 2020    if nc > 1:.   
-0002ff20: 206e 6320 3d20 696e 7428 6e63 290a 2020   nc = int(nc).  
-0002ff30: 656c 7365 3a0a 2020 2020 6e63 3d66 6c6f  else:.    nc=flo
-0002ff40: 6174 286e 6329 0a0a 2020 7479 7065 5f6f  at(nc)..  type_o
-0002ff50: 665f 7472 616e 7366 6f72 6d3d 2752 6967  f_transform='Rig
-0002ff60: 6964 2720 2320 2c20 2320 7368 6f75 6c64  id' # , # should
-0002ff70: 2070 726f 6261 626c 7920 6e6f 7420 6368   probably not ch
-0002ff80: 616e 6765 2074 6869 730a 2020 7265 6d6f  ange this.  remo
-0002ff90: 7665 5f69 743d 5472 7565 0a20 206f 7574  ve_it=True.  out
-0002ffa0: 7075 745f 6469 7265 6374 6f72 7920 3d20  put_directory = 
-0002ffb0: 7465 6d70 6669 6c65 2e6d 6b64 7465 6d70  tempfile.mkdtemp
-0002ffc0: 2829 0a20 206f 7574 7075 745f 6469 7265  ().  output_dire
-0002ffd0: 6374 6f72 795f 7720 3d20 6f75 7470 7574  ctory_w = output
-0002ffe0: 5f64 6972 6563 746f 7279 202b 2022 2f74  _directory + "/t
-0002fff0: 735f 7431 5f72 6567 2f22 0a20 206f 732e  s_t1_reg/".  os.
-00030000: 6d61 6b65 6469 7273 286f 7574 7075 745f  makedirs(output_
-00030010: 6469 7265 6374 6f72 795f 772c 6578 6973  directory_w,exis
-00030020: 745f 6f6b 3d54 7275 6529 0a20 206f 666e  t_ok=True).  ofn
-00030030: 7431 7478 203d 2074 656d 7066 696c 652e  t1tx = tempfile.
-00030040: 4e61 6d65 6454 656d 706f 7261 7279 4669  NamedTemporaryFi
-00030050: 6c65 2864 656c 6574 653d 4661 6c73 652c  le(delete=False,
-00030060: 7375 6666 6978 3d27 7431 5f64 6566 6f72  suffix='t1_defor
-00030070: 6d61 7469 6f6e 272c 6469 723d 6f75 7470  mation',dir=outp
-00030080: 7574 5f64 6972 6563 746f 7279 5f77 292e  ut_directory_w).
-00030090: 6e61 6d65 0a0a 2020 696d 706f 7274 206e  name..  import n
-000300a0: 756d 7079 2061 7320 6e70 0a23 2041 7373  umpy as np.# Ass
-000300b0: 756d 696e 6720 636f 7265 2061 6e64 2075  uming core and u
-000300c0: 7469 6c73 2061 7265 206d 6f64 756c 6573  tils are modules
-000300d0: 206f 7220 7061 636b 6167 6573 2077 6974   or packages wit
-000300e0: 6820 6e65 6365 7373 6172 7920 6675 6e63  h necessary func
-000300f0: 7469 6f6e 730a 0a20 2069 6620 7570 7361  tions..  if upsa
-00030100: 6d70 6c65 203e 2030 2e30 3a0a 2020 2020  mple > 0.0:.    
-00030110: 2020 7370 6320 3d20 616e 7473 2e67 6574    spc = ants.get
-00030120: 5f73 7061 6369 6e67 2820 666d 7269 2029  _spacing( fmri )
-00030130: 0a20 2020 2020 206d 696e 7370 6320 3d20  .      minspc = 
-00030140: 7570 7361 6d70 6c65 0a20 2020 2020 2069  upsample.      i
-00030150: 6620 6d69 6e28 7370 635b 303a 335d 2920  f min(spc[0:3]) 
-00030160: 3c20 6d69 6e73 7063 3a0a 2020 2020 2020  < minspc:.      
-00030170: 2020 2020 6d69 6e73 7063 203d 206d 696e      minspc = min
-00030180: 2873 7063 5b30 3a33 5d29 0a20 2020 2020  (spc[0:3]).     
-00030190: 206e 6577 7370 6320 3d20 5b6d 696e 7370   newspc = [minsp
-000301a0: 632c 6d69 6e73 7063 2c6d 696e 7370 635d  c,minspc,minspc]
-000301b0: 0a20 2020 2020 2066 6d72 695f 7465 6d70  .      fmri_temp
-000301c0: 6c61 7465 203d 2061 6e74 732e 7265 7361  late = ants.resa
-000301d0: 6d70 6c65 5f69 6d61 6765 2820 666d 7269  mple_image( fmri
-000301e0: 5f74 656d 706c 6174 652c 206e 6577 7370  _template, newsp
-000301f0: 632c 2069 6e74 6572 705f 7479 7065 3d30  c, interp_type=0
-00030200: 2029 0a0a 2020 6465 6620 7465 6d70 6f72   )..  def tempor
-00030210: 616c 5f64 6572 6976 6174 6976 655f 7361  al_derivative_sa
-00030220: 6d65 5f73 6861 7065 2861 7272 6179 293a  me_shape(array):
-00030230: 0a20 2020 2022 2222 0a20 2020 2043 6f6d  .    """.    Com
-00030240: 7075 7465 2074 6865 2074 656d 706f 7261  pute the tempora
-00030250: 6c20 6465 7269 7661 7469 7665 206f 6620  l derivative of 
-00030260: 6120 3244 206e 756d 7079 2061 7272 6179  a 2D numpy array
-00030270: 2061 6c6f 6e67 2074 6865 2030 7468 2061   along the 0th a
-00030280: 7869 7320 2874 696d 6529 0a20 2020 2061  xis (time).    a
-00030290: 6e64 2065 6e73 7572 6520 7468 6520 6f75  nd ensure the ou
-000302a0: 7470 7574 2068 6173 2074 6865 2073 616d  tput has the sam
-000302b0: 6520 7368 6170 6520 6173 2074 6865 2069  e shape as the i
-000302c0: 6e70 7574 2e0a 0a20 2020 203a 7061 7261  nput...    :para
-000302d0: 6d20 6172 7261 793a 2032 4420 6e75 6d70  m array: 2D nump
-000302e0: 7920 6172 7261 7920 7769 7468 2074 696d  y array with tim
-000302f0: 6520 6173 2074 6865 2030 7468 2061 7869  e as the 0th axi
-00030300: 732e 0a20 2020 203a 7265 7475 726e 3a20  s..    :return: 
-00030310: 3244 206e 756d 7079 2061 7272 6179 206f  2D numpy array o
-00030320: 6620 7468 6520 7465 6d70 6f72 616c 2064  f the temporal d
-00030330: 6572 6976 6174 6976 6520 7769 7468 2074  erivative with t
-00030340: 6865 2073 616d 6520 7368 6170 6520 6173  he same shape as
-00030350: 2069 6e70 7574 2e0a 2020 2020 2222 220a   input..    """.
-00030360: 2020 2020 6465 7269 7661 7469 7665 203d      derivative =
-00030370: 206e 702e 6469 6666 2861 7272 6179 2c20   np.diff(array, 
-00030380: 6178 6973 3d30 290a 2020 2020 0a20 2020  axis=0).    .   
-00030390: 2023 2041 7070 656e 6420 6120 726f 7720   # Append a row 
-000303a0: 746f 206d 6169 6e74 6169 6e20 7468 6520  to maintain the 
-000303b0: 7361 6d65 2073 6861 7065 0a20 2020 2023  same shape.    #
-000303c0: 2059 6f75 2063 616e 2063 686f 6f73 6520   You can choose 
-000303d0: 746f 2061 7070 656e 6420 6120 726f 7720  to append a row 
-000303e0: 6f66 207a 6572 6f73 206f 7220 7468 6520  of zeros or the 
-000303f0: 6c61 7374 2072 6f77 206f 6620 7468 6520  last row of the 
-00030400: 6465 7269 7661 7469 7665 0a20 2020 2023  derivative.    #
-00030410: 2048 6572 652c 2061 2072 6f77 206f 6620   Here, a row of 
-00030420: 7a65 726f 7320 6973 2061 7070 656e 6465  zeros is appende
-00030430: 640a 2020 2020 7a65 726f 735f 726f 7720  d.    zeros_row 
-00030440: 3d20 6e70 2e7a 6572 6f73 2828 312c 2061  = np.zeros((1, a
-00030450: 7272 6179 2e73 6861 7065 5b31 5d29 290a  rray.shape[1])).
-00030460: 2020 2020 7265 7475 726e 206e 702e 7673      return np.vs
-00030470: 7461 636b 2828 7a65 726f 735f 726f 772c  tack((zeros_row,
-00030480: 2064 6572 6976 6174 6976 6520 2929 0a0a   derivative ))..
-00030490: 2020 6465 6620 636f 6d70 7574 655f 7453    def compute_tS
-000304a0: 5444 284d 2c20 7175 616e 7469 6c65 2c20  TD(M, quantile, 
-000304b0: 783d 302c 2061 7869 733d 3029 3a0a 2020  x=0, axis=0):.  
-000304c0: 2020 7374 644d 203d 206e 702e 7374 6428    stdM = np.std(
-000304d0: 4d2c 2061 7869 733d 6178 6973 290a 2020  M, axis=axis).  
-000304e0: 2020 2320 7365 7420 6261 6420 7661 6c75    # set bad valu
-000304f0: 6573 2074 6f20 780a 2020 2020 7374 644d  es to x.    stdM
-00030500: 5b73 7464 4d20 3d3d 2030 5d20 3d20 780a  [stdM == 0] = x.
-00030510: 2020 2020 7374 644d 5b6e 702e 6973 6e61      stdM[np.isna
-00030520: 6e28 7374 644d 295d 203d 2078 0a20 2020  n(stdM)] = x.   
-00030530: 2074 7420 3d20 726f 756e 6428 7175 616e   tt = round(quan
-00030540: 7469 6c65 202a 2031 3030 290a 2020 2020  tile * 100).    
-00030550: 7468 7265 7368 6f6c 645f 7374 6420 3d20  threshold_std = 
-00030560: 6e70 2e70 6572 6365 6e74 696c 6528 7374  np.percentile(st
-00030570: 644d 2c20 7474 290a 2020 2020 7265 7475  dM, tt).    retu
-00030580: 726e 207b 2774 5354 4427 3a20 7374 644d  rn {'tSTD': stdM
-00030590: 2c20 2774 6872 6573 686f 6c64 5f73 7464  , 'threshold_std
-000305a0: 273a 2074 6872 6573 686f 6c64 5f73 7464  ': threshold_std
-000305b0: 7d0a 0a20 2064 6566 2067 6574 5f63 6f6d  }..  def get_com
-000305c0: 7063 6f72 5f6d 6174 7269 7828 626f 6c64  pcor_matrix(bold
-000305d0: 496d 6167 652c 206d 6173 6b2c 2071 7561  Image, mask, qua
-000305e0: 6e74 696c 6529 3a0a 2020 2020 2222 220a  ntile):.    """.
-000305f0: 2020 2020 436f 6d70 7574 6520 7468 6520      Compute the 
-00030600: 636f 6d70 636f 7220 6d61 7472 6978 2e0a  compcor matrix..
-00030610: 0a20 2020 203a 7061 7261 6d20 626f 6c64  .    :param bold
-00030620: 496d 6167 653a 2054 6865 2062 6f6c 6420  Image: The bold 
-00030630: 696d 6167 652e 0a20 2020 203a 7061 7261  image..    :para
-00030640: 6d20 6d61 736b 3a20 5468 6520 6d61 736b  m mask: The mask
-00030650: 2074 6f20 6170 706c 792c 2069 6620 4e6f   to apply, if No
-00030660: 6e65 2c20 6974 2077 696c 6c20 6265 2063  ne, it will be c
-00030670: 6f6d 7075 7465 642e 0a20 2020 203a 7061  omputed..    :pa
-00030680: 7261 6d20 7175 616e 7469 6c65 3a20 5175  ram quantile: Qu
-00030690: 616e 7469 6c65 2066 6f72 2063 6f6d 7075  antile for compu
-000306a0: 7469 6e67 2074 6872 6573 686f 6c64 2069  ting threshold i
-000306b0: 6e20 7453 5444 2e0a 2020 2020 3a72 6574  n tSTD..    :ret
-000306c0: 7572 6e3a 2054 6865 2063 6f6d 706f 7220  urn: The compor 
-000306d0: 6d61 7472 6978 2e0a 2020 2020 2222 220a  matrix..    """.
-000306e0: 2020 2020 6966 206d 6173 6b20 6973 204e      if mask is N
-000306f0: 6f6e 653a 0a20 2020 2020 2020 2074 656d  one:.        tem
-00030700: 7020 3d20 616e 7473 2e73 6c69 6365 5f69  p = ants.slice_i
-00030710: 6d61 6765 2862 6f6c 6449 6d61 6765 2c20  mage(boldImage, 
-00030720: 6178 6973 3d62 6f6c 6449 6d61 6765 2e64  axis=boldImage.d
-00030730: 696d 656e 7369 6f6e 202d 2031 2c20 6964  imension - 1, id
-00030740: 783d 3029 0a20 2020 2020 2020 206d 6173  x=0).        mas
-00030750: 6b20 3d20 616e 7473 2e67 6574 5f6d 6173  k = ants.get_mas
-00030760: 6b28 7465 6d70 290a 0a20 2020 2069 6d61  k(temp)..    ima
-00030770: 6765 6d61 7472 6978 203d 2061 6e74 732e  gematrix = ants.
-00030780: 7469 6d65 7365 7269 6573 5f74 6f5f 6d61  timeseries_to_ma
-00030790: 7472 6978 2862 6f6c 6449 6d61 6765 2c20  trix(boldImage, 
-000307a0: 6d61 736b 290a 2020 2020 7465 6d70 203d  mask).    temp =
-000307b0: 2063 6f6d 7075 7465 5f74 5354 4428 696d   compute_tSTD(im
-000307c0: 6167 656d 6174 7269 782c 2071 7561 6e74  agematrix, quant
-000307d0: 696c 652c 2030 290a 2020 2020 7473 6e72  ile, 0).    tsnr
-000307e0: 6d61 736b 203d 2061 6e74 732e 6d61 6b65  mask = ants.make
-000307f0: 5f69 6d61 6765 286d 6173 6b2c 2074 656d  _image(mask, tem
-00030800: 705b 2774 5354 4427 5d29 0a20 2020 2074  p['tSTD']).    t
-00030810: 736e 726d 6173 6b20 3d20 616e 7473 2e74  snrmask = ants.t
-00030820: 6872 6573 686f 6c64 5f69 6d61 6765 2874  hreshold_image(t
-00030830: 736e 726d 6173 6b2c 2074 656d 705b 2774  snrmask, temp['t
-00030840: 6872 6573 686f 6c64 5f73 7464 275d 2c20  hreshold_std'], 
-00030850: 7465 6d70 5b27 7453 5444 275d 2e6d 6178  temp['tSTD'].max
-00030860: 2829 290a 2020 2020 4d20 3d20 616e 7473  ()).    M = ants
-00030870: 2e74 696d 6573 6572 6965 735f 746f 5f6d  .timeseries_to_m
-00030880: 6174 7269 7828 626f 6c64 496d 6167 652c  atrix(boldImage,
-00030890: 2074 736e 726d 6173 6b29 0a20 2020 2072   tsnrmask).    r
-000308a0: 6574 7572 6e20 4d0a 0a0a 2020 6672 6f6d  eturn M...  from
-000308b0: 2073 6b6c 6561 726e 2e64 6563 6f6d 706f   sklearn.decompo
-000308c0: 7369 7469 6f6e 2069 6d70 6f72 7420 4661  sition import Fa
-000308d0: 7374 4943 410a 2020 6465 6620 6669 6e64  stICA.  def find
-000308e0: 5f69 6e64 6963 6573 286c 7374 2c20 7661  _indices(lst, va
-000308f0: 6c75 6529 3a0a 2020 2020 7265 7475 726e  lue):.    return
-00030900: 205b 696e 6465 7820 666f 7220 696e 6465   [index for inde
-00030910: 782c 2065 6c65 6d65 6e74 2069 6e20 656e  x, element in en
-00030920: 756d 6572 6174 6528 6c73 7429 2069 6620  umerate(lst) if 
-00030930: 656c 656d 656e 7420 3e20 7661 6c75 655d  element > value]
-00030940: 0a0a 2020 6465 6620 6d65 616e 5f6f 665f  ..  def mean_of_
-00030950: 6c69 7374 286c 7374 293a 0a20 2020 2069  list(lst):.    i
-00030960: 6620 6e6f 7420 6c73 743a 2020 2320 4368  f not lst:  # Ch
-00030970: 6563 6b20 6966 2074 6865 206c 6973 7420  eck if the list 
-00030980: 6973 206e 6f74 2065 6d70 7479 0a20 2020  is not empty.   
-00030990: 2020 2020 2072 6574 7572 6e20 3020 2023       return 0  #
-000309a0: 2052 6574 7572 6e20 3020 6f72 2061 7070   Return 0 or app
-000309b0: 726f 7072 6961 7465 2076 616c 7565 2066  ropriate value f
-000309c0: 6f72 2061 6e20 656d 7074 7920 6c69 7374  or an empty list
-000309d0: 0a20 2020 2072 6574 7572 6e20 7375 6d28  .    return sum(
-000309e0: 6c73 7429 202f 206c 656e 286c 7374 290a  lst) / len(lst).
-000309f0: 2020 666d 7269 7370 6320 3d20 6c69 7374    fmrispc = list
-00030a00: 2820 616e 7473 2e67 6574 5f73 7061 6369  ( ants.get_spaci
-00030a10: 6e67 2820 666d 7269 2029 2029 0a20 2069  ng( fmri ) ).  i
-00030a20: 6620 7370 6120 6973 204e 6f6e 653a 0a20  f spa is None:. 
-00030a30: 2020 2073 7061 203d 206d 6561 6e5f 6f66     spa = mean_of
-00030a40: 5f6c 6973 7428 2066 6d72 6973 7063 5b30  _list( fmrispc[0
-00030a50: 3a33 5d20 2920 2a20 312e 300a 2020 6966  :3] ) * 1.0.  if
-00030a60: 2073 7074 2069 7320 4e6f 6e65 3a0a 2020   spt is None:.  
-00030a70: 2020 7370 7420 3d20 666d 7269 7370 635b    spt = fmrispc[
-00030a80: 335d 202a 2030 2e35 0a20 2020 2020 200a  3] * 0.5.      .
-00030a90: 2020 696d 706f 7274 206e 756d 7079 2061    import numpy a
-00030aa0: 7320 6e70 0a20 2069 6d70 6f72 7420 7061  s np.  import pa
-00030ab0: 6e64 6173 2061 7320 7064 0a20 2069 6d70  ndas as pd.  imp
-00030ac0: 6f72 7420 7265 0a20 2069 6d70 6f72 7420  ort re.  import 
-00030ad0: 6d61 7468 0a20 2023 2070 6f69 6e74 2064  math.  # point d
-00030ae0: 6174 6120 7265 736f 7572 6365 730a 2020  ata resources.  
-00030af0: 4120 3d20 6e70 2e7a 6572 6f73 2828 312c  A = np.zeros((1,
-00030b00: 3129 290a 2020 6466 6e6e 616d 653d 2744  1)).  dfnname='D
-00030b10: 6566 6175 6c74 4d6f 6465 270a 2020 6966  efaultMode'.  if
-00030b20: 2070 6f77 6572 733a 0a20 2020 2020 2070   powers:.      p
-00030b30: 6f77 6572 735f 6172 6561 6c5f 6d6e 695f  owers_areal_mni_
-00030b40: 6974 6b20 3d20 7064 2e72 6561 645f 6373  itk = pd.read_cs
-00030b50: 7628 2067 6574 5f64 6174 6128 2770 6f77  v( get_data('pow
-00030b60: 6572 735f 6d6e 695f 6974 6b27 2c20 7461  ers_mni_itk', ta
-00030b70: 7267 6574 5f65 7874 656e 7369 6f6e 3d22  rget_extension="
-00030b80: 2e63 7376 2229 2920 2320 706f 7765 7220  .csv")) # power 
-00030b90: 636f 6f72 6469 6e61 7465 730a 2020 2020  coordinates.    
-00030ba0: 2020 636f 6f72 6473 3d27 706f 7765 7273    coords='powers
-00030bb0: 270a 2020 656c 7365 3a0a 2020 2020 2020  '.  else:.      
-00030bc0: 706f 7765 7273 5f61 7265 616c 5f6d 6e69  powers_areal_mni
-00030bd0: 5f69 746b 203d 2070 642e 7265 6164 5f63  _itk = pd.read_c
-00030be0: 7376 2820 6765 745f 6461 7461 2827 7070  sv( get_data('pp
-00030bf0: 6d69 5f74 656d 706c 6174 655f 3530 3050  mi_template_500P
-00030c00: 6172 6365 6c73 5f59 656f 3230 3131 5f31  arcels_Yeo2011_1
-00030c10: 374e 6574 776f 726b 735f 3230 3233 5f68  7Networks_2023_h
-00030c20: 6f6d 6f74 6f70 6963 272c 2074 6172 6765  omotopic', targe
-00030c30: 745f 6578 7465 6e73 696f 6e3d 222e 6373  t_extension=".cs
-00030c40: 7622 2929 2023 2079 656f 2032 3032 3320  v")) # yeo 2023 
-00030c50: 636f 6f72 6469 6e61 7465 730a 2020 2020  coordinates.    
-00030c60: 2020 636f 6f72 6473 3d27 7965 6f5f 3137    coords='yeo_17
-00030c70: 5f35 3030 5f32 3032 3327 0a20 2066 6d72  _500_2023'.  fmr
-00030c80: 6920 3d20 616e 7473 2e69 4d61 7468 2820  i = ants.iMath( 
-00030c90: 666d 7269 2c20 274e 6f72 6d61 6c69 7a65  fmri, 'Normalize
-00030ca0: 2720 290a 2020 626d 6173 6b20 3d20 616e  ' ).  bmask = an
-00030cb0: 7473 7079 6e65 742e 6272 6169 6e5f 6578  tspynet.brain_ex
-00030cc0: 7472 6163 7469 6f6e 2820 666d 7269 5f74  traction( fmri_t
-00030cd0: 656d 706c 6174 652c 2027 626f 6c64 2720  emplate, 'bold' 
-00030ce0: 292e 7468 7265 7368 6f6c 645f 696d 6167  ).threshold_imag
-00030cf0: 6528 302e 352c 3129 2e69 4d61 7468 2822  e(0.5,1).iMath("
-00030d00: 4669 6c6c 486f 6c65 7322 290a 2020 6966  FillHoles").  if
-00030d10: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-00030d20: 7072 696e 7428 2242 6567 696e 2072 7366  print("Begin rsf
-00030d30: 6d72 6920 6d6f 7469 6f6e 2063 6f72 7265  mri motion corre
-00030d40: 6374 696f 6e22 290a 2020 6465 6275 673d  ction").  debug=
-00030d50: 4661 6c73 650a 2020 6966 2064 6562 7567  False.  if debug
-00030d60: 3a0a 2020 2020 2020 616e 7473 2e69 6d61  :.      ants.ima
-00030d70: 6765 5f77 7269 7465 2820 666d 7269 5f74  ge_write( fmri_t
-00030d80: 656d 706c 6174 652c 2027 2f74 6d70 2f66  emplate, '/tmp/f
-00030d90: 6d72 695f 7465 6d70 6c61 7465 2e6e 6969  mri_template.nii
-00030da0: 2e67 7a27 2029 0a20 2020 2020 2061 6e74  .gz' ).      ant
-00030db0: 732e 696d 6167 655f 7772 6974 6528 2066  s.image_write( f
-00030dc0: 6d72 692c 2027 2f74 6d70 2f66 6d72 692e  mri, '/tmp/fmri.
-00030dd0: 6e69 692e 677a 2720 290a 2020 2020 2020  nii.gz' ).      
-00030de0: 7072 696e 7428 2264 6562 7567 2077 726f  print("debug wro
-00030df0: 7465 2066 6d72 6920 616e 6420 666d 7269  te fmri and fmri
-00030e00: 5f74 656d 706c 6174 6522 290a 2020 2320  _template").  # 
-00030e10: 6d6f 742d 636f 0a20 2063 6f72 726d 6f20  mot-co.  corrmo 
-00030e20: 3d20 7469 6d65 7365 7269 6573 5f72 6567  = timeseries_reg
-00030e30: 280a 2020 2020 666d 7269 2c20 666d 7269  (.    fmri, fmri
-00030e40: 5f74 656d 706c 6174 652c 0a20 2020 2074  _template,.    t
-00030e50: 7970 655f 6f66 5f74 7261 6e73 666f 726d  ype_of_transform
-00030e60: 3d74 7970 655f 6f66 5f74 7261 6e73 666f  =type_of_transfo
-00030e70: 726d 2c0a 2020 2020 746f 7461 6c5f 7369  rm,.    total_si
-00030e80: 676d 613d 302e 352c 0a20 2020 2066 644f  gma=0.5,.    fdO
-00030e90: 6666 7365 743d 322e 302c 0a20 2020 2074  ffset=2.0,.    t
-00030ea0: 7269 6d20 3d20 382c 0a20 2020 206f 7574  rim = 8,.    out
-00030eb0: 7075 745f 6469 7265 6374 6f72 793d 4e6f  put_directory=No
-00030ec0: 6e65 2c0a 2020 2020 7665 7262 6f73 653d  ne,.    verbose=
-00030ed0: 7665 7262 6f73 652c 0a20 2020 2073 796e  verbose,.    syn
-00030ee0: 5f6d 6574 7269 633d 2763 6327 2c0a 2020  _metric='cc',.  
-00030ef0: 2020 7379 6e5f 7361 6d70 6c69 6e67 3d32    syn_sampling=2
-00030f00: 2c0a 2020 2020 7265 675f 6974 6572 6174  ,.    reg_iterat
-00030f10: 696f 6e73 3d5b 3430 2c32 302c 355d 2c0a  ions=[40,20,5],.
-00030f20: 2020 2020 7265 7475 726e 5f6e 756d 7079      return_numpy
-00030f30: 5f6d 6f74 696f 6e5f 7061 7261 6d65 7465  _motion_paramete
-00030f40: 7273 3d54 7275 6520 290a 2020 0a20 2069  rs=True ).  .  i
-00030f50: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-00030f60: 2070 7269 6e74 2822 456e 6420 7273 666d   print("End rsfm
-00030f70: 7269 206d 6f74 696f 6e20 636f 7272 6563  ri motion correc
-00030f80: 7469 6f6e 2229 0a20 2020 2020 2070 7269  tion").      pri
-00030f90: 6e74 2822 3d3d 3d20 6e65 7874 2061 6e61  nt("=== next ana
-00030fa0: 746f 6d69 6361 6c6c 7920 6261 7365 6420  tomically based 
-00030fb0: 6d61 7070 696e 6720 3d3d 3d22 290a 0a20  mapping ===").. 
-00030fc0: 2064 6573 7069 6b69 6e67 5f63 6f75 6e74   despiking_count
-00030fd0: 203d 206e 702e 7a65 726f 7328 2063 6f72   = np.zeros( cor
-00030fe0: 726d 6f5b 276d 6f74 696f 6e5f 636f 7272  rmo['motion_corr
-00030ff0: 6563 7465 6427 5d2e 7368 6170 655b 335d  ected'].shape[3]
-00031000: 2029 0a20 2069 6620 6465 7370 696b 6520   ).  if despike 
-00031010: 3e20 302e 303a 0a20 2020 2020 2063 6f72  > 0.0:.      cor
-00031020: 726d 6f5b 276d 6f74 696f 6e5f 636f 7272  rmo['motion_corr
-00031030: 6563 7465 6427 5d2c 2064 6573 7069 6b69  ected'], despiki
-00031040: 6e67 5f63 6f75 6e74 203d 2064 6573 7069  ng_count = despi
-00031050: 6b65 5f74 696d 655f 7365 7269 6573 5f61  ke_time_series_a
-00031060: 666e 6928 2063 6f72 726d 6f5b 276d 6f74  fni( corrmo['mot
-00031070: 696f 6e5f 636f 7272 6563 7465 6427 5d2c  ion_corrected'],
-00031080: 2063 313d 6465 7370 696b 6520 290a 0a20   c1=despike ).. 
-00031090: 2064 6573 7069 6b69 6e67 5f63 6f75 6e74   despiking_count
-000310a0: 5f73 756d 6d61 7279 203d 2064 6573 7069  _summary = despi
-000310b0: 6b69 6e67 5f63 6f75 6e74 2e73 756d 2829  king_count.sum()
-000310c0: 202f 206e 702e 7072 6f64 2820 636f 7272   / np.prod( corr
-000310d0: 6d6f 5b27 6d6f 7469 6f6e 5f63 6f72 7265  mo['motion_corre
-000310e0: 6374 6564 275d 2e73 6861 7065 2029 0a20  cted'].shape ). 
-000310f0: 2068 6967 685f 6d6f 7469 6f6e 5f63 6f75   high_motion_cou
-00031100: 6e74 3d28 636f 7272 6d6f 5b27 4644 275d  nt=(corrmo['FD']
-00031110: 203e 2046 445f 7468 7265 7368 6f6c 6420   > FD_threshold 
-00031120: 292e 7375 6d28 290a 2020 6869 6768 5f6d  ).sum().  high_m
-00031130: 6f74 696f 6e5f 7063 743d 6869 6768 5f6d  otion_pct=high_m
-00031140: 6f74 696f 6e5f 636f 756e 7420 2f20 666d  otion_count / fm
-00031150: 7269 2e73 6861 7065 5b33 5d0a 0a20 2023  ri.shape[3]..  #
-00031160: 2066 696c 7465 7220 6d61 736b 2062 6173   filter mask bas
-00031170: 6564 206f 6e20 5453 4e52 0a20 206d 7974  ed on TSNR.  myt
-00031180: 736e 7220 3d20 7473 6e72 2820 636f 7272  snr = tsnr( corr
-00031190: 6d6f 5b27 6d6f 7469 6f6e 5f63 6f72 7265  mo['motion_corre
-000311a0: 6374 6564 275d 2c20 626d 6173 6b20 290a  cted'], bmask ).
-000311b0: 2020 6d79 7473 6e72 5468 7265 7368 203d    mytsnrThresh =
-000311c0: 206e 702e 7175 616e 7469 6c65 2820 6d79   np.quantile( my
-000311d0: 7473 6e72 2e6e 756d 7079 2829 2c20 302e  tsnr.numpy(), 0.
-000311e0: 3939 3520 290a 2020 7473 6e72 6d61 736b  995 ).  tsnrmask
-000311f0: 203d 2061 6e74 732e 7468 7265 7368 6f6c   = ants.threshol
-00031200: 645f 696d 6167 6528 206d 7974 736e 722c  d_image( mytsnr,
-00031210: 2030 2c20 6d79 7473 6e72 5468 7265 7368   0, mytsnrThresh
-00031220: 2029 2e6d 6f72 7068 6f6c 6f67 7928 2263   ).morphology("c
-00031230: 6c6f 7365 222c 3229 0a20 2062 6d61 736b  lose",2).  bmask
-00031240: 203d 2062 6d61 736b 202a 2074 736e 726d   = bmask * tsnrm
-00031250: 6173 6b0a 0a20 2023 2061 6e61 746f 6d69  ask..  # anatomi
-00031260: 6361 6c20 6d61 7070 696e 670a 2020 756e  cal mapping.  un
-00031270: 6420 3d20 666d 7269 5f74 656d 706c 6174  d = fmri_templat
-00031280: 6520 2a20 626d 6173 6b0a 2020 7431 7265  e * bmask.  t1re
-00031290: 6720 3d20 616e 7473 2e72 6567 6973 7472  g = ants.registr
-000312a0: 6174 696f 6e28 2075 6e64 2c20 7431 2c0a  ation( und, t1,.
-000312b0: 2020 2020 2253 794e 426f 6c64 222c 206f      "SyNBold", o
-000312c0: 7574 7072 6566 6978 3d6f 666e 7431 7478  utprefix=ofnt1tx
-000312d0: 2029 0a20 2069 6620 7665 7262 6f73 653a   ).  if verbose:
-000312e0: 0a20 2020 2070 7269 6e74 2822 7431 2032  .    print("t1 2
-000312f0: 2062 6f6c 6420 646f 6e65 2229 0a20 2067   bold done").  g
-00031300: 6d73 6567 203d 2061 6e74 732e 7468 7265  mseg = ants.thre
-00031310: 7368 6f6c 645f 696d 6167 6528 2074 3173  shold_image( t1s
-00031320: 6567 6d65 6e74 6174 696f 6e2c 2032 2c20  egmentation, 2, 
-00031330: 3220 290a 2020 676d 7365 6720 3d20 676d  2 ).  gmseg = gm
-00031340: 7365 6720 2b20 616e 7473 2e74 6872 6573  seg + ants.thres
-00031350: 686f 6c64 5f69 6d61 6765 2820 7431 7365  hold_image( t1se
-00031360: 676d 656e 7461 7469 6f6e 2c20 342c 2034  gmentation, 4, 4
-00031370: 2029 0a20 2067 6d73 6567 203d 2061 6e74   ).  gmseg = ant
-00031380: 732e 7468 7265 7368 6f6c 645f 696d 6167  s.threshold_imag
-00031390: 6528 2067 6d73 6567 2c20 312c 2034 2029  e( gmseg, 1, 4 )
-000313a0: 0a20 2067 6d73 6567 203d 2061 6e74 732e  .  gmseg = ants.
-000313b0: 694d 6174 6828 2067 6d73 6567 2c20 274d  iMath( gmseg, 'M
-000313c0: 4427 2c20 3120 2920 2320 4649 584d 4552  D', 1 ) # FIXMER
-000313d0: 5346 0a20 2067 6d73 6567 203d 2061 6e74  SF.  gmseg = ant
-000313e0: 732e 6170 706c 795f 7472 616e 7366 6f72  s.apply_transfor
-000313f0: 6d73 2820 756e 642c 2067 6d73 6567 2c0a  ms( und, gmseg,.
-00031400: 2020 2020 7431 7265 675b 2766 7764 7472      t1reg['fwdtr
-00031410: 616e 7366 6f72 6d73 275d 2c20 696e 7465  ansforms'], inte
-00031420: 7270 6f6c 6174 6f72 203d 2027 6e65 6172  rpolator = 'near
-00031430: 6573 744e 6569 6768 626f 7227 2029 202a  estNeighbor' ) *
-00031440: 2062 6d61 736b 0a20 2063 7366 416e 6457   bmask.  csfAndW
-00031450: 4d20 3d20 2820 616e 7473 2e74 6872 6573  M = ( ants.thres
-00031460: 686f 6c64 5f69 6d61 6765 2820 7431 7365  hold_image( t1se
-00031470: 676d 656e 7461 7469 6f6e 2c20 312c 2031  gmentation, 1, 1
-00031480: 2029 202b 0a20 2020 2020 2020 2020 2020   ) +.           
-00031490: 2020 2020 616e 7473 2e74 6872 6573 686f      ants.thresho
-000314a0: 6c64 5f69 6d61 6765 2820 7431 7365 676d  ld_image( t1segm
-000314b0: 656e 7461 7469 6f6e 2c20 332c 2033 2029  entation, 3, 3 )
-000314c0: 2029 2e6d 6f72 7068 6f6c 6f67 7928 2265   ).morphology("e
-000314d0: 726f 6465 222c 3129 0a20 2063 7366 416e  rode",1).  csfAn
-000314e0: 6457 4d20 3d20 616e 7473 2e61 7070 6c79  dWM = ants.apply
-000314f0: 5f74 7261 6e73 666f 726d 7328 2075 6e64  _transforms( und
-00031500: 2c20 6373 6641 6e64 574d 2c0a 2020 2020  , csfAndWM,.    
-00031510: 7431 7265 675b 2766 7764 7472 616e 7366  t1reg['fwdtransf
-00031520: 6f72 6d73 275d 2c20 696e 7465 7270 6f6c  orms'], interpol
-00031530: 6174 6f72 203d 2027 6e65 6172 6573 744e  ator = 'nearestN
-00031540: 6569 6768 626f 7227 2029 2020 2a20 626d  eighbor' )  * bm
-00031550: 6173 6b0a 2020 6373 6620 3d20 616e 7473  ask.  csf = ants
-00031560: 2e74 6872 6573 686f 6c64 5f69 6d61 6765  .threshold_image
-00031570: 2820 7431 7365 676d 656e 7461 7469 6f6e  ( t1segmentation
-00031580: 2c20 312c 2031 2029 0a20 2063 7366 203d  , 1, 1 ).  csf =
-00031590: 2061 6e74 732e 6170 706c 795f 7472 616e   ants.apply_tran
-000315a0: 7366 6f72 6d73 2820 756e 642c 2063 7366  sforms( und, csf
-000315b0: 2c20 7431 7265 675b 2766 7764 7472 616e  , t1reg['fwdtran
-000315c0: 7366 6f72 6d73 275d 2c20 696e 7465 7270  sforms'], interp
-000315d0: 6f6c 6174 6f72 203d 2027 6e65 6172 6573  olator = 'neares
-000315e0: 744e 6569 6768 626f 7227 2029 2020 2a20  tNeighbor' )  * 
-000315f0: 626d 6173 6b0a 2020 776d 203d 2061 6e74  bmask.  wm = ant
-00031600: 732e 7468 7265 7368 6f6c 645f 696d 6167  s.threshold_imag
-00031610: 6528 2074 3173 6567 6d65 6e74 6174 696f  e( t1segmentatio
-00031620: 6e2c 2033 2c20 3320 292e 6d6f 7270 686f  n, 3, 3 ).morpho
-00031630: 6c6f 6779 2822 6572 6f64 6522 2c31 290a  logy("erode",1).
-00031640: 2020 776d 203d 2061 6e74 732e 6170 706c    wm = ants.appl
-00031650: 795f 7472 616e 7366 6f72 6d73 2820 756e  y_transforms( un
-00031660: 642c 2077 6d2c 2074 3172 6567 5b27 6677  d, wm, t1reg['fw
-00031670: 6474 7261 6e73 666f 726d 7327 5d2c 2069  dtransforms'], i
-00031680: 6e74 6572 706f 6c61 746f 7220 3d20 276e  nterpolator = 'n
-00031690: 6561 7265 7374 4e65 6967 6862 6f72 2720  earestNeighbor' 
-000316a0: 2920 202a 2062 6d61 736b 0a20 2069 6620  )  * bmask.  if 
-000316b0: 706f 7765 7273 3a0a 2020 2020 6368 3220  powers:.    ch2 
-000316c0: 3d20 6d6d 5f72 6561 6428 2061 6e74 732e  = mm_read( ants.
-000316d0: 6765 745f 616e 7473 5f64 6174 6128 2022  get_ants_data( "
-000316e0: 6368 3222 2029 2029 0a20 2065 6c73 653a  ch2" ) ).  else:
-000316f0: 0a20 2020 2063 6832 203d 206d 6d5f 7265  .    ch2 = mm_re
-00031700: 6164 2820 6765 745f 6461 7461 2820 2250  ad( get_data( "P
-00031710: 504d 495f 7465 6d70 6c61 7465 305f 6272  PMI_template0_br
-00031720: 6169 6e22 2c20 7461 7267 6574 5f65 7874  ain", target_ext
-00031730: 656e 7369 6f6e 3d27 2e6e 6969 2e67 7a27  ension='.nii.gz'
-00031740: 2029 2029 0a20 2074 7265 6720 3d20 616e   ) ).  treg = an
-00031750: 7473 2e72 6567 6973 7472 6174 696f 6e28  ts.registration(
-00031760: 200a 2020 2020 2320 7468 6973 2069 7320   .    # this is 
-00031770: 746f 206d 616b 6520 7468 6520 696d 7061  to make the impa
-00031780: 6374 206f 6620 7265 736f 6c75 7469 6f6e  ct of resolution
-00031790: 2063 6f6e 7369 7374 656e 740a 2020 2020   consistent.    
-000317a0: 616e 7473 2e72 6573 616d 706c 655f 696d  ants.resample_im
-000317b0: 6167 6528 7431 2c20 5b31 2e30 2c31 2e30  age(t1, [1.0,1.0
-000317c0: 2c31 2e30 5d2c 2069 6e74 6572 705f 7479  ,1.0], interp_ty
-000317d0: 7065 3d30 292c 200a 2020 2020 6368 322c  pe=0), .    ch2,
-000317e0: 2022 616e 7473 5265 6769 7374 7261 7469   "antsRegistrati
-000317f0: 6f6e 5379 4e51 7569 636b 5265 7072 6f5b  onSyNQuickRepro[
-00031800: 735d 2220 290a 2020 6966 2070 6f77 6572  s]" ).  if power
-00031810: 733a 0a20 2020 2063 6f6e 6361 7478 3220  s:.    concatx2 
-00031820: 3d20 7472 6567 5b27 696e 7674 7261 6e73  = treg['invtrans
-00031830: 666f 726d 7327 5d20 2b20 7431 7265 675b  forms'] + t1reg[
-00031840: 2769 6e76 7472 616e 7366 6f72 6d73 275d  'invtransforms']
-00031850: 0a20 2020 2070 7473 3262 6f6c 6420 3d20  .    pts2bold = 
-00031860: 616e 7473 2e61 7070 6c79 5f74 7261 6e73  ants.apply_trans
-00031870: 666f 726d 735f 746f 5f70 6f69 6e74 7328  forms_to_points(
-00031880: 2033 2c20 706f 7765 7273 5f61 7265 616c   3, powers_areal
-00031890: 5f6d 6e69 5f69 746b 2c20 636f 6e63 6174  _mni_itk, concat
-000318a0: 7832 2c0a 2020 2020 2020 2020 7768 6963  x2,.        whic
-000318b0: 6874 6f69 6e76 6572 7420 3d20 2820 5472  htoinvert = ( Tr
-000318c0: 7565 2c20 4661 6c73 652c 2054 7275 652c  ue, False, True,
-000318d0: 2046 616c 7365 2029 2029 0a20 2020 206c   False ) ).    l
-000318e0: 6f63 6174 696f 6e73 203d 2070 7473 3262  ocations = pts2b
-000318f0: 6f6c 642e 696c 6f63 5b3a 2c3a 335d 2e76  old.iloc[:,:3].v
-00031900: 616c 7565 730a 2020 2020 7074 496d 6720  alues.    ptImg 
-00031910: 3d20 616e 7473 2e6d 616b 655f 706f 696e  = ants.make_poin
-00031920: 7473 5f69 6d61 6765 2820 6c6f 6361 7469  ts_image( locati
-00031930: 6f6e 732c 2062 6d61 736b 2c20 7261 6469  ons, bmask, radi
-00031940: 7573 203d 2032 2029 0a20 2065 6c73 653a  us = 2 ).  else:
-00031950: 0a20 2020 2063 6f6e 6361 7478 3220 3d20  .    concatx2 = 
-00031960: 7431 7265 675b 2766 7764 7472 616e 7366  t1reg['fwdtransf
-00031970: 6f72 6d73 275d 202b 2074 7265 675b 2766  orms'] + treg['f
-00031980: 7764 7472 616e 7366 6f72 6d73 275d 2020  wdtransforms']  
-00031990: 2020 0a20 2020 2072 7366 7365 6766 6e20    .    rsfsegfn 
-000319a0: 3d20 6765 745f 6461 7461 2827 7070 6d69  = get_data('ppmi
-000319b0: 5f74 656d 706c 6174 655f 3530 3050 6172  _template_500Par
-000319c0: 6365 6c73 5f59 656f 3230 3131 5f31 374e  cels_Yeo2011_17N
-000319d0: 6574 776f 726b 735f 3230 3233 5f68 6f6d  etworks_2023_hom
-000319e0: 6f74 6f70 6963 272c 2074 6172 6765 745f  otopic', target_
-000319f0: 6578 7465 6e73 696f 6e3d 222e 6e69 692e  extension=".nii.
-00031a00: 677a 2229 0a20 2020 2072 7366 7365 6769  gz").    rsfsegi
-00031a10: 6d67 203d 2061 6e74 732e 696d 6167 655f  mg = ants.image_
-00031a20: 7265 6164 2820 7273 6673 6567 666e 2029  read( rsfsegfn )
-00031a30: 0a20 2020 2070 7449 6d67 203d 2061 6e74  .    ptImg = ant
-00031a40: 732e 6170 706c 795f 7472 616e 7366 6f72  s.apply_transfor
-00031a50: 6d73 2820 756e 642c 2072 7366 7365 6769  ms( und, rsfsegi
-00031a60: 6d67 2c20 636f 6e63 6174 7832 2c20 696e  mg, concatx2, in
-00031a70: 7465 7270 6f6c 6174 6f72 3d27 6e65 6172  terpolator='near
-00031a80: 6573 744e 6569 6768 626f 7227 2029 202a  estNeighbor' ) *
-00031a90: 2062 6d61 736b 0a20 2020 2070 7473 3262   bmask.    pts2b
-00031aa0: 6f6c 6420 3d20 706f 7765 7273 5f61 7265  old = powers_are
-00031ab0: 616c 5f6d 6e69 5f69 746b 0a20 2020 2023  al_mni_itk.    #
-00031ac0: 2061 6e74 732e 706c 6f74 2820 756e 642c   ants.plot( und,
-00031ad0: 2070 7449 6d67 2c20 6372 6f70 3d54 7275   ptImg, crop=Tru
-00031ae0: 652c 2061 7869 733d 3220 290a 0a20 2023  e, axis=2 )..  #
-00031af0: 206f 7074 696f 6e61 6c20 736d 6f6f 7468   optional smooth
-00031b00: 696e 670a 2020 7472 203d 2061 6e74 732e  ing.  tr = ants.
-00031b10: 6765 745f 7370 6163 696e 6728 2063 6f72  get_spacing( cor
-00031b20: 726d 6f5b 276d 6f74 696f 6e5f 636f 7272  rmo['motion_corr
-00031b30: 6563 7465 6427 5d20 295b 335d 0a20 2073  ected'] )[3].  s
-00031b40: 6d74 6820 3d20 2820 7370 612c 2073 7061  mth = ( spa, spa
-00031b50: 2c20 7370 612c 2073 7074 2029 2023 2074  , spa, spt ) # t
-00031b60: 6869 7320 6973 2066 6f72 2073 6967 6d61  his is for sigma
-00031b70: 496e 5068 7973 6963 616c 436f 6f72 6469  InPhysicalCoordi
-00031b80: 6e61 7465 7320 3d20 5452 5545 0a20 2073  nates = TRUE.  s
-00031b90: 696d 6720 3d20 616e 7473 2e73 6d6f 6f74  img = ants.smoot
-00031ba0: 685f 696d 6167 6528 2063 6f72 726d 6f5b  h_image( corrmo[
-00031bb0: 276d 6f74 696f 6e5f 636f 7272 6563 7465  'motion_correcte
-00031bc0: 6427 5d2c 2073 6d74 682c 2073 6967 6d61  d'], smth, sigma
-00031bd0: 5f69 6e5f 7068 7973 6963 616c 5f63 6f6f  _in_physical_coo
-00031be0: 7264 696e 6174 6573 203d 2054 7275 6520  rdinates = True 
-00031bf0: 290a 0a20 2023 2063 6f6c 6c65 6374 2063  )..  # collect c
-00031c00: 656e 736f 7269 6e67 2069 6e64 6963 6573  ensoring indices
-00031c10: 0a20 2068 6c69 6e64 7320 3d20 6669 6e64  .  hlinds = find
-00031c20: 5f69 6e64 6963 6573 2820 636f 7272 6d6f  _indices( corrmo
-00031c30: 5b27 4644 275d 2c20 4644 5f74 6872 6573  ['FD'], FD_thres
-00031c40: 686f 6c64 2029 0a20 2069 6620 7665 7262  hold ).  if verb
-00031c50: 6f73 653a 0a20 2020 2070 7269 6e74 2822  ose:.    print("
-00031c60: 6869 6768 206d 6f74 696f 6e20 696e 6469  high motion indi
-00031c70: 6365 7322 290a 2020 2020 7072 696e 7428  ces").    print(
-00031c80: 2068 6c69 6e64 7320 290a 2020 6966 206f   hlinds ).  if o
-00031c90: 7574 6c69 6572 5f74 6872 6573 686f 6c64  utlier_threshold
-00031ca0: 203c 2031 2e30 2061 6e64 206f 7574 6c69   < 1.0 and outli
-00031cb0: 6572 5f74 6872 6573 686f 6c64 203e 2030  er_threshold > 0
-00031cc0: 2e30 3a0a 2020 2020 666d 7269 6d6f 7463  .0:.    fmrimotc
-00031cd0: 6f72 722c 2068 6c69 6e64 7332 203d 206c  orr, hlinds2 = l
-00031ce0: 6f6f 705f 7469 6d65 7365 7269 6573 5f63  oop_timeseries_c
-00031cf0: 656e 736f 7269 6e67 2820 636f 7272 6d6f  ensoring( corrmo
-00031d00: 5b27 6d6f 7469 6f6e 5f63 6f72 7265 6374  ['motion_correct
-00031d10: 6564 275d 2c20 0a20 2020 2020 2074 6872  ed'], .      thr
-00031d20: 6573 686f 6c64 3d6f 7574 6c69 6572 5f74  eshold=outlier_t
-00031d30: 6872 6573 686f 6c64 2c20 7665 7262 6f73  hreshold, verbos
-00031d40: 653d 7665 7262 6f73 6520 290a 2020 2020  e=verbose ).    
-00031d50: 686c 696e 6473 2e65 7874 656e 6428 2068  hlinds.extend( h
-00031d60: 6c69 6e64 7332 2029 0a20 2020 2064 656c  linds2 ).    del
-00031d70: 2066 6d72 696d 6f74 636f 7272 0a20 2068   fmrimotcorr.  h
-00031d80: 6c69 6e64 7320 3d20 6c69 7374 2873 6574  linds = list(set
-00031d90: 2868 6c69 6e64 7329 2920 2320 6d61 6b65  (hlinds)) # make
-00031da0: 2075 6e69 7175 650a 0a20 2023 206e 7569   unique..  # nui
-00031db0: 7361 6e63 650a 2020 676c 6f62 616c 6d61  sance.  globalma
-00031dc0: 7420 3d20 616e 7473 2e74 696d 6573 6572  t = ants.timeser
-00031dd0: 6965 735f 746f 5f6d 6174 7269 7828 2063  ies_to_matrix( c
-00031de0: 6f72 726d 6f5b 276d 6f74 696f 6e5f 636f  orrmo['motion_co
-00031df0: 7272 6563 7465 6427 5d2c 2062 6d61 736b  rrected'], bmask
-00031e00: 2029 0a20 2067 6c6f 6261 6c73 6967 6e61   ).  globalsigna
-00031e10: 6c20 3d20 6e70 2e6e 616e 6d65 616e 2820  l = np.nanmean( 
-00031e20: 676c 6f62 616c 6d61 742c 2061 7869 7320  globalmat, axis 
-00031e30: 3d20 3120 290a 2020 6465 6c20 676c 6f62  = 1 ).  del glob
-00031e40: 616c 6d61 740a 2020 636f 6d70 636f 7271  almat.  compcorq
-00031e50: 7561 6e74 696c 653d 302e 3530 0a20 206e  uantile=0.50.  n
-00031e60: 635f 776d 3d6e 635f 6373 663d 6e63 0a20  c_wm=nc_csf=nc. 
-00031e70: 2069 6620 6e63 203c 2031 3a0a 2020 2020   if nc < 1:.    
-00031e80: 676c 6f62 616c 6d61 7420 3d20 6765 745f  globalmat = get_
-00031e90: 636f 6d70 636f 725f 6d61 7472 6978 2820  compcor_matrix( 
-00031ea0: 636f 7272 6d6f 5b27 6d6f 7469 6f6e 5f63  corrmo['motion_c
-00031eb0: 6f72 7265 6374 6564 275d 2c20 776d 2c20  orrected'], wm, 
-00031ec0: 636f 6d70 636f 7271 7561 6e74 696c 6520  compcorquantile 
-00031ed0: 290a 2020 2020 6e63 5f77 6d20 3d20 696e  ).    nc_wm = in
-00031ee0: 7428 6573 7469 6d61 7465 5f6f 7074 696d  t(estimate_optim
-00031ef0: 616c 5f70 6361 5f63 6f6d 706f 6e65 6e74  al_pca_component
-00031f00: 7328 2064 6174 613d 676c 6f62 616c 6d61  s( data=globalma
-00031f10: 742c 2076 6172 6961 6e63 655f 7468 7265  t, variance_thre
-00031f20: 7368 6f6c 643d 6e63 2929 0a20 2020 2067  shold=nc)).    g
-00031f30: 6c6f 6261 6c6d 6174 203d 2067 6574 5f63  lobalmat = get_c
-00031f40: 6f6d 7063 6f72 5f6d 6174 7269 7828 2063  ompcor_matrix( c
-00031f50: 6f72 726d 6f5b 276d 6f74 696f 6e5f 636f  orrmo['motion_co
-00031f60: 7272 6563 7465 6427 5d2c 2063 7366 2c20  rrected'], csf, 
-00031f70: 636f 6d70 636f 7271 7561 6e74 696c 6520  compcorquantile 
-00031f80: 290a 2020 2020 6e63 5f63 7366 203d 2069  ).    nc_csf = i
-00031f90: 6e74 2865 7374 696d 6174 655f 6f70 7469  nt(estimate_opti
-00031fa0: 6d61 6c5f 7063 615f 636f 6d70 6f6e 656e  mal_pca_componen
-00031fb0: 7473 2820 6461 7461 3d67 6c6f 6261 6c6d  ts( data=globalm
-00031fc0: 6174 2c20 7661 7269 616e 6365 5f74 6872  at, variance_thr
-00031fd0: 6573 686f 6c64 3d6e 6329 290a 2020 2020  eshold=nc)).    
-00031fe0: 6465 6c20 676c 6f62 616c 6d61 740a 2020  del globalmat.  
-00031ff0: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-00032000: 7072 696e 7428 2269 6e63 6c75 6465 2063  print("include c
-00032010: 6f6d 7063 6f72 2063 6f6d 706f 6e65 6e74  ompcor component
-00032020: 7320 6173 206e 7569 7361 6e63 653a 2063  s as nuisance: c
-00032030: 7366 2022 202b 2073 7472 286e 635f 6373  sf " + str(nc_cs
-00032040: 6629 202b 2022 2077 6d20 2220 2b20 7374  f) + " wm " + st
-00032050: 7228 6e63 5f77 6d29 290a 2020 6d79 636f  r(nc_wm)).  myco
-00032060: 6d70 636f 725f 6373 6620 3d20 616e 7473  mpcor_csf = ants
-00032070: 2e63 6f6d 7063 6f72 2820 636f 7272 6d6f  .compcor( corrmo
-00032080: 5b27 6d6f 7469 6f6e 5f63 6f72 7265 6374  ['motion_correct
-00032090: 6564 275d 2c0a 2020 2020 6e63 6f6d 7063  ed'],.    ncompc
-000320a0: 6f72 3d6e 635f 6373 662c 2071 7561 6e74  or=nc_csf, quant
-000320b0: 696c 653d 636f 6d70 636f 7271 7561 6e74  ile=compcorquant
-000320c0: 696c 652c 206d 6173 6b20 3d20 6373 662c  ile, mask = csf,
-000320d0: 0a20 2020 2066 696c 7465 725f 7479 7065  .    filter_type
-000320e0: 3d27 706f 6c79 6e6f 6d69 616c 272c 2064  ='polynomial', d
-000320f0: 6567 7265 653d 3220 290a 2020 6d79 636f  egree=2 ).  myco
-00032100: 6d70 636f 725f 776d 203d 2061 6e74 732e  mpcor_wm = ants.
-00032110: 636f 6d70 636f 7228 2063 6f72 726d 6f5b  compcor( corrmo[
-00032120: 276d 6f74 696f 6e5f 636f 7272 6563 7465  'motion_correcte
-00032130: 6427 5d2c 0a20 2020 206e 636f 6d70 636f  d'],.    ncompco
-00032140: 723d 6e63 5f77 6d2c 2071 7561 6e74 696c  r=nc_wm, quantil
-00032150: 653d 636f 6d70 636f 7271 7561 6e74 696c  e=compcorquantil
-00032160: 652c 206d 6173 6b20 3d20 776d 2c0a 2020  e, mask = wm,.  
-00032170: 2020 6669 6c74 6572 5f74 7970 653d 2770    filter_type='p
-00032180: 6f6c 796e 6f6d 6961 6c27 2c20 6465 6772  olynomial', degr
-00032190: 6565 3d32 2029 0a20 206e 7569 7361 6e63  ee=2 ).  nuisanc
-000321a0: 6520 3d20 6e70 2e63 5f5b 206d 7963 6f6d  e = np.c_[ mycom
-000321b0: 7063 6f72 5f63 7366 5b20 2763 6f6d 706f  pcor_csf[ 'compo
-000321c0: 6e65 6e74 7327 205d 2c20 6d79 636f 6d70  nents' ], mycomp
-000321d0: 636f 725f 776d 5b20 2763 6f6d 706f 6e65  cor_wm[ 'compone
-000321e0: 6e74 7327 205d 205d 0a0a 2020 6966 206d  nts' ] ]..  if m
-000321f0: 6f74 696f 6e5f 6173 5f6e 7569 7361 6e63  otion_as_nuisanc
-00032200: 653a 0a20 2020 2020 2069 6620 7665 7262  e:.      if verb
-00032210: 6f73 653a 0a20 2020 2020 2020 2020 2070  ose:.          p
-00032220: 7269 6e74 2822 696e 636c 7564 6520 6d6f  rint("include mo
-00032230: 7469 6f6e 2061 7320 6e75 6973 616e 6365  tion as nuisance
-00032240: 2229 0a20 2020 2020 2020 2020 2070 7269  ").          pri
-00032250: 6e74 2820 636f 7272 6d6f 5b27 6d6f 7469  nt( corrmo['moti
-00032260: 6f6e 5f70 6172 616d 6574 6572 7327 5d2e  on_parameters'].
-00032270: 7368 6170 6520 290a 2020 2020 2020 6465  shape ).      de
-00032280: 7269 7620 3d20 7465 6d70 6f72 616c 5f64  riv = temporal_d
-00032290: 6572 6976 6174 6976 655f 7361 6d65 5f73  erivative_same_s
-000322a0: 6861 7065 2820 636f 7272 6d6f 5b27 6d6f  hape( corrmo['mo
-000322b0: 7469 6f6e 5f70 6172 616d 6574 6572 7327  tion_parameters'
-000322c0: 5d20 2029 0a20 2020 2020 206e 7569 7361  ]  ).      nuisa
-000322d0: 6e63 6520 3d20 6e70 2e63 5f5b 206e 7569  nce = np.c_[ nui
-000322e0: 7361 6e63 652c 2063 6f72 726d 6f5b 276d  sance, corrmo['m
-000322f0: 6f74 696f 6e5f 7061 7261 6d65 7465 7273  otion_parameters
-00032300: 275d 2c20 6465 7269 7620 5d0a 0a20 2069  '], deriv ]..  i
-00032310: 6620 6963 615f 636f 6d70 6f6e 656e 7473  f ica_components
-00032320: 203e 2030 3a0a 2020 2020 6966 2076 6572   > 0:.    if ver
-00032330: 626f 7365 3a0a 2020 2020 2020 2020 7072  bose:.        pr
-00032340: 696e 7428 2269 6e63 6c75 6465 2069 6361  int("include ica
-00032350: 2063 6f6d 706f 6e65 6e74 7320 6173 206e   components as n
-00032360: 7569 7361 6e63 653a 2022 202b 2073 7472  uisance: " + str
-00032370: 2869 6361 5f63 6f6d 706f 6e65 6e74 7329  (ica_components)
-00032380: 290a 2020 2020 6963 6120 3d20 4661 7374  ).    ica = Fast
-00032390: 4943 4128 6e5f 636f 6d70 6f6e 656e 7473  ICA(n_components
-000323a0: 3d69 6361 5f63 6f6d 706f 6e65 6e74 732c  =ica_components,
-000323b0: 206d 6178 5f69 7465 723d 3130 3030 302c   max_iter=10000,
-000323c0: 2074 6f6c 3d30 2e30 3031 2c20 7261 6e64   tol=0.001, rand
-000323d0: 6f6d 5f73 7461 7465 3d34 3220 290a 2020  om_state=42 ).  
-000323e0: 2020 676c 6f62 616c 6d61 7420 3d20 616e    globalmat = an
-000323f0: 7473 2e74 696d 6573 6572 6965 735f 746f  ts.timeseries_to
-00032400: 5f6d 6174 7269 7828 2063 6f72 726d 6f5b  _matrix( corrmo[
-00032410: 276d 6f74 696f 6e5f 636f 7272 6563 7465  'motion_correcte
-00032420: 6427 5d2c 2063 7366 416e 6457 4d20 290a  d'], csfAndWM ).
-00032430: 2020 2020 6e75 6973 616e 6365 5f69 6361      nuisance_ica
-00032440: 203d 2069 6361 2e66 6974 5f74 7261 6e73   = ica.fit_trans
-00032450: 666f 726d 2867 6c6f 6261 6c6d 6174 2920  form(globalmat) 
-00032460: 2023 2052 6563 6f6e 7374 7275 6374 2073   # Reconstruct s
-00032470: 6967 6e61 6c73 0a20 2020 206e 7569 7361  ignals.    nuisa
-00032480: 6e63 6520 3d20 6e70 2e63 5f5b 206e 7569  nce = np.c_[ nui
-00032490: 7361 6e63 652c 206e 7569 7361 6e63 655f  sance, nuisance_
-000324a0: 6963 6120 5d0a 2020 2020 6465 6c20 676c  ica ].    del gl
-000324b0: 6f62 616c 6d61 740a 0a20 2023 2063 6f6e  obalmat..  # con
-000324c0: 6361 7420 616c 6c20 6e75 6973 616e 6365  cat all nuisance
-000324d0: 2064 6174 610a 2020 2320 6e75 6973 616e   data.  # nuisan
-000324e0: 6365 203d 206e 702e 635f 5b20 6e75 6973  ce = np.c_[ nuis
-000324f0: 616e 6365 2c20 6d79 636f 6d70 636f 725b  ance, mycompcor[
-00032500: 2762 6173 6973 275d 205d 0a20 2023 206e  'basis'] ].  # n
-00032510: 7569 7361 6e63 6520 3d20 6e70 2e63 5f5b  uisance = np.c_[
-00032520: 206e 7569 7361 6e63 652c 2063 6f72 726d   nuisance, corrm
-00032530: 6f5b 2746 4427 5d20 5d0a 2020 6e75 6973  o['FD'] ].  nuis
-00032540: 616e 6365 203d 206e 702e 635f 5b20 6e75  ance = np.c_[ nu
-00032550: 6973 616e 6365 2c20 676c 6f62 616c 7369  isance, globalsi
-00032560: 676e 616c 205d 0a0a 2020 6966 2069 6d70  gnal ]..  if imp
-00032570: 7574 653a 0a20 2020 2073 696d 6769 6d70  ute:.    simgimp
-00032580: 203d 2069 6d70 7574 655f 7469 6d65 7365   = impute_timese
-00032590: 7269 6573 2820 7369 6d67 2c20 686c 696e  ries( simg, hlin
-000325a0: 6473 2c20 6d65 7468 6f64 3d27 6c69 6e65  ds, method='line
-000325b0: 6172 2729 0a20 2065 6c73 653a 0a20 2020  ar').  else:.   
-000325c0: 2073 696d 6769 6d70 203d 2073 696d 670a   simgimp = simg.
-000325d0: 0a20 2023 2066 616c 6666 2f61 6c66 6620  .  # falff/alff 
-000325e0: 7374 7566 6620 2064 6566 2061 6c66 665f  stuff  def alff_
-000325f0: 696d 6167 6528 2078 2c20 6d61 736b 2c20  image( x, mask, 
-00032600: 666c 6f3d 302e 3031 2c20 6668 693d 302e  flo=0.01, fhi=0.
-00032610: 312c 206e 7569 7361 6e63 653d 4e6f 6e65  1, nuisance=None
-00032620: 2029 3a0a 2020 6d79 6661 6c66 663d 616c   ):.  myfalff=al
-00032630: 6666 5f69 6d61 6765 2820 7369 6d67 696d  ff_image( simgim
-00032640: 702c 2062 6d61 736b 2c20 666c 6f3d 665b  p, bmask, flo=f[
-00032650: 305d 2c20 6668 693d 665b 315d 2c20 6e75  0], fhi=f[1], nu
-00032660: 6973 616e 6365 3d6e 7569 7361 6e63 6520  isance=nuisance 
-00032670: 2029 0a0a 2020 2320 6261 6e64 7061 7373   )..  # bandpass
-00032680: 2061 6e79 2064 6174 6120 636f 6c6c 6563   any data collec
-00032690: 7465 6420 6265 666f 7265 2068 6572 6520  ted before here 
-000326a0: 2d2d 2069 6620 6261 6e64 7061 7373 2072  -- if bandpass r
-000326b0: 6571 7565 7374 6564 0a20 2069 6620 665b  equested.  if f[
-000326c0: 305d 203e 2030 2061 6e64 2066 5b31 5d20  0] > 0 and f[1] 
-000326d0: 3c20 312e 303a 0a20 2020 2069 6620 7665  < 1.0:.    if ve
-000326e0: 7262 6f73 653a 0a20 2020 2020 2020 2070  rbose:.        p
-000326f0: 7269 6e74 2820 2262 616e 6470 6173 733a  rint( "bandpass:
-00032700: 2022 202b 2073 7472 2866 5b30 5d29 202b   " + str(f[0]) +
-00032710: 2022 203c 3d3e 2022 202b 2073 7472 2820   " <=> " + str( 
-00032720: 665b 315d 2029 2029 0a20 2020 206e 7569  f[1] ) ).    nui
-00032730: 7361 6e63 6520 3d20 616e 7473 2e62 616e  sance = ants.ban
-00032740: 6470 6173 735f 6669 6c74 6572 5f6d 6174  dpass_filter_mat
-00032750: 7269 7828 206e 7569 7361 6e63 652c 2074  rix( nuisance, t
-00032760: 7220 3d20 7472 2c20 6c6f 7766 3d66 5b30  r = tr, lowf=f[0
-00032770: 5d2c 2068 6967 6866 3d66 5b31 5d20 2920  ], highf=f[1] ) 
-00032780: 2320 736f 6d65 2077 6f75 6c64 2061 7267  # some would arg
-00032790: 7565 2061 6761 696e 7374 2074 6869 730a  ue against this.
-000327a0: 2020 2020 676c 6f62 616c 6d61 7420 3d20      globalmat = 
-000327b0: 616e 7473 2e74 696d 6573 6572 6965 735f  ants.timeseries_
-000327c0: 746f 5f6d 6174 7269 7828 2073 696d 672c  to_matrix( simg,
-000327d0: 2062 6d61 736b 2029 0a20 2020 2067 6c6f   bmask ).    glo
-000327e0: 6261 6c6d 6174 203d 2061 6e74 732e 6261  balmat = ants.ba
-000327f0: 6e64 7061 7373 5f66 696c 7465 725f 6d61  ndpass_filter_ma
-00032800: 7472 6978 2820 676c 6f62 616c 6d61 742c  trix( globalmat,
-00032810: 2074 7220 3d20 7472 2c20 6c6f 7766 3d66   tr = tr, lowf=f
-00032820: 5b30 5d2c 2068 6967 6866 3d66 5b31 5d20  [0], highf=f[1] 
-00032830: 2920 2320 736f 6d65 2077 6f75 6c64 2061  ) # some would a
-00032840: 7267 7565 2061 6761 696e 7374 2074 6869  rgue against thi
-00032850: 730a 2020 2020 7369 6d67 203d 2061 6e74  s.    simg = ant
-00032860: 732e 6d61 7472 6978 5f74 6f5f 7469 6d65  s.matrix_to_time
-00032870: 7365 7269 6573 2820 7369 6d67 2c20 676c  series( simg, gl
-00032880: 6f62 616c 6d61 742c 2062 6d61 736b 2029  obalmat, bmask )
-00032890: 0a0a 2020 6966 2076 6572 626f 7365 3a0a  ..  if verbose:.
-000328a0: 2020 2020 7072 696e 7428 226e 6f77 2072      print("now r
-000328b0: 6567 7265 7373 206e 7569 7361 6e63 6522  egress nuisance"
-000328c0: 290a 0a0a 2020 6966 206c 656e 2820 686c  )...  if len( hl
-000328d0: 696e 6473 2029 203e 2030 203a 0a20 2020  inds ) > 0 :.   
-000328e0: 2069 6620 6365 6e73 6f72 3a0a 2020 2020   if censor:.    
-000328f0: 2020 2020 6e75 6973 616e 6365 203d 2072      nuisance = r
-00032900: 656d 6f76 655f 656c 656d 656e 7473 5f66  emove_elements_f
-00032910: 726f 6d5f 6e75 6d70 795f 6172 7261 7928  rom_numpy_array(
-00032920: 206e 7569 7361 6e63 652c 2068 6c69 6e64   nuisance, hlind
-00032930: 7320 2029 0a20 2020 2020 2020 2073 696d  s  ).        sim
-00032940: 6720 3d20 7265 6d6f 7665 5f76 6f6c 756d  g = remove_volum
-00032950: 6573 5f66 726f 6d5f 7469 6d65 7365 7269  es_from_timeseri
-00032960: 6573 2820 7369 6d67 2c20 686c 696e 6473  es( simg, hlinds
-00032970: 2029 0a0a 2020 676d 6d61 7420 3d20 616e   )..  gmmat = an
-00032980: 7473 2e74 696d 6573 6572 6965 735f 746f  ts.timeseries_to
-00032990: 5f6d 6174 7269 7828 2073 696d 672c 2062  _matrix( simg, b
-000329a0: 6d61 736b 2029 0a20 2067 6d6d 6174 203d  mask ).  gmmat =
-000329b0: 2061 6e74 732e 7265 6772 6573 735f 636f   ants.regress_co
-000329c0: 6d70 6f6e 656e 7473 2820 676d 6d61 742c  mponents( gmmat,
-000329d0: 206e 7569 7361 6e63 6520 290a 2020 7369   nuisance ).  si
-000329e0: 6d67 203d 2061 6e74 732e 6d61 7472 6978  mg = ants.matrix
-000329f0: 5f74 6f5f 7469 6d65 7365 7269 6573 2873  _to_timeseries(s
-00032a00: 696d 672c 2067 6d6d 6174 2c20 626d 6173  img, gmmat, bmas
-00032a10: 6b29 0a0a 0a20 2023 2073 7472 7563 7475  k)...  # structu
-00032a20: 7265 2074 6865 206f 7574 7075 7420 6461  re the output da
-00032a30: 7461 0a20 206f 7574 6469 6374 203d 207b  ta.  outdict = {
-00032a40: 7d0a 2020 6f75 7464 6963 745b 2770 6172  }.  outdict['par
-00032a50: 616d 7365 7427 5d20 3d20 7061 7261 6d73  amset'] = params
-00032a60: 6574 0a20 206f 7574 6469 6374 5b27 7570  et.  outdict['up
-00032a70: 7361 6d70 6c69 6e67 275d 203d 2075 7073  sampling'] = ups
-00032a80: 616d 706c 650a 2020 6f75 7464 6963 745b  ample.  outdict[
-00032a90: 2763 6f6f 7264 7327 5d20 3d20 636f 6f72  'coords'] = coor
-00032aa0: 6473 0a20 206f 7574 6469 6374 5b27 6466  ds.  outdict['df
-00032ab0: 6e6e 616d 6527 5d3d 6466 6e6e 616d 650a  nname']=dfnname.
-00032ac0: 2020 6f75 7464 6963 745b 276d 6561 6e42    outdict['meanB
-00032ad0: 6f6c 6427 5d20 3d20 756e 640a 0a20 2023  old'] = und..  #
-00032ae0: 2061 6464 2063 6f72 7265 6c61 7469 6f6e   add correlation
-00032af0: 206d 6174 7269 7820 7468 6174 2063 6170   matrix that cap
-00032b00: 7475 7265 7320 6561 6368 206e 6f64 6520  tures each node 
-00032b10: 7061 6972 0a20 2023 2073 6f6d 6520 6f66  pair.  # some of
-00032b20: 2074 6865 2073 7068 6572 6573 206f 7665   the spheres ove
-00032b30: 726c 6170 2073 6f20 6578 7472 6163 7420  rlap so extract 
-00032b40: 7365 7061 7261 7465 6c79 2066 726f 6d20  separately from 
-00032b50: 6561 6368 2052 4f49 0a20 2069 6620 706f  each ROI.  if po
-00032b60: 7765 7273 3a0a 2020 2020 6e50 6f69 6e74  wers:.    nPoint
-00032b70: 7320 3d20 696e 7428 7074 7332 626f 6c64  s = int(pts2bold
-00032b80: 5b27 524f 4927 5d2e 6d61 7828 2929 0a20  ['ROI'].max()). 
-00032b90: 2020 2070 6f69 6e74 7261 6e67 6520 3d20     pointrange = 
-00032ba0: 6c69 7374 2872 616e 6765 2869 6e74 286e  list(range(int(n
-00032bb0: 506f 696e 7473 2929 290a 2020 656c 7365  Points))).  else
-00032bc0: 3a0a 2020 2020 6e50 6f69 6e74 7320 3d20  :.    nPoints = 
-00032bd0: 696e 7428 7074 496d 672e 6d61 7828 2929  int(ptImg.max())
-00032be0: 0a20 2020 2070 6f69 6e74 7261 6e67 6520  .    pointrange 
-00032bf0: 3d20 6c69 7374 2872 616e 6765 2869 6e74  = list(range(int
-00032c00: 286e 506f 696e 7473 2929 290a 2020 6e56  (nPoints))).  nV
-00032c10: 6f6c 756d 6573 203d 2073 696d 672e 7368  olumes = simg.sh
-00032c20: 6170 655b 335d 0a20 206d 6561 6e52 4f49  ape[3].  meanROI
-00032c30: 203d 206e 702e 7a65 726f 7328 5b6e 566f   = np.zeros([nVo
-00032c40: 6c75 6d65 732c 206e 506f 696e 7473 5d29  lumes, nPoints])
-00032c50: 0a20 2072 6f69 4e61 6d65 7320 3d20 5b5d  .  roiNames = []
-00032c60: 0a20 2069 6620 6465 6275 673a 0a20 2020  .  if debug:.   
-00032c70: 2020 2070 7449 6d67 416c 6c20 3d20 756e     ptImgAll = un
-00032c80: 6420 2a20 302e 0a20 2066 6f72 2069 2069  d * 0..  for i i
-00032c90: 6e20 706f 696e 7472 616e 6765 3a0a 2020  n pointrange:.  
-00032ca0: 2020 2320 7370 6563 6966 7920 6e61 6d65    # specify name
-00032cb0: 2066 6f72 206d 6174 7269 7820 656e 7472   for matrix entr
-00032cc0: 6965 7320 7468 6174 2773 206c 696e 6b73  ies that's links
-00032cd0: 2062 6163 6b20 746f 2052 4f49 206e 756d   back to ROI num
-00032ce0: 6265 7220 616e 6420 6e65 7477 6f72 6b3b  ber and network;
-00032cf0: 2065 2e67 2e2c 2052 4f49 315f 556e 6365   e.g., ROI1_Unce
-00032d00: 7274 6169 6e0a 2020 2020 6e65 744c 6162  rtain.    netLab
-00032d10: 656c 203d 2072 652e 7375 6228 2022 2022  el = re.sub( " "
-00032d20: 2c20 2222 2c20 7074 7332 626f 6c64 2e6c  , "", pts2bold.l
-00032d30: 6f63 5b69 2c27 5379 7374 656d 4e61 6d65  oc[i,'SystemName
-00032d40: 275d 290a 2020 2020 6e65 744c 6162 656c  ']).    netLabel
-00032d50: 203d 2072 652e 7375 6228 2022 2d22 2c20   = re.sub( "-", 
-00032d60: 2222 2c20 6e65 744c 6162 656c 2029 0a20  "", netLabel ). 
-00032d70: 2020 206e 6574 4c61 6265 6c20 3d20 7265     netLabel = re
-00032d80: 2e73 7562 2820 222f 222c 2022 222c 206e  .sub( "/", "", n
-00032d90: 6574 4c61 6265 6c20 290a 2020 2020 726f  etLabel ).    ro
-00032da0: 694c 6162 656c 203d 2022 524f 4922 202b  iLabel = "ROI" +
-00032db0: 2073 7472 2870 7473 3262 6f6c 642e 6c6f   str(pts2bold.lo
-00032dc0: 635b 692c 2752 4f49 275d 2920 2b20 275f  c[i,'ROI']) + '_
-00032dd0: 2720 2b20 6e65 744c 6162 656c 0a20 2020  ' + netLabel.   
-00032de0: 2072 6f69 4e61 6d65 732e 6170 7065 6e64   roiNames.append
-00032df0: 2820 726f 694c 6162 656c 2029 0a20 2020  ( roiLabel ).   
-00032e00: 2069 6620 706f 7765 7273 3a0a 2020 2020   if powers:.    
-00032e10: 2020 2020 7074 496d 6167 6520 3d20 616e      ptImage = an
-00032e20: 7473 2e6d 616b 655f 706f 696e 7473 5f69  ts.make_points_i
-00032e30: 6d61 6765 2870 7473 3262 6f6c 642e 696c  mage(pts2bold.il
-00032e40: 6f63 5b5b 695d 2c3a 335d 2e76 616c 7565  oc[[i],:3].value
-00032e50: 732c 2062 6d61 736b 2c20 7261 6469 7573  s, bmask, radius
-00032e60: 3d31 292e 7468 7265 7368 6f6c 645f 696d  =1).threshold_im
-00032e70: 6167 6528 2031 2c20 3165 3920 290a 2020  age( 1, 1e9 ).  
-00032e80: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00032e90: 2370 7269 6e74 2822 446f 696e 6720 2220  #print("Doing " 
-00032ea0: 2b20 7074 7332 626f 6c64 2e6c 6f63 5b69  + pts2bold.loc[i
-00032eb0: 2c27 5379 7374 656d 4e61 6d65 275d 202b  ,'SystemName'] +
-00032ec0: 2022 2061 7420 2220 2b20 7374 7228 6929   " at " + str(i)
-00032ed0: 2029 0a20 2020 2020 2020 2023 7074 496d   ).        #ptIm
-00032ee0: 6167 6520 3d20 616e 7473 2e6d 6173 6b5f  age = ants.mask_
-00032ef0: 696d 6167 6528 2070 7449 6d67 2c20 7074  image( ptImg, pt
-00032f00: 496d 672c 206c 6576 656c 3d70 7473 3262  Img, level=pts2b
-00032f10: 6f6c 645b 2752 4f49 275d 5b70 7473 3262  old['ROI'][pts2b
-00032f20: 6f6c 645b 2753 7973 7465 6d4e 616d 6527  old['SystemName'
-00032f30: 5d3d 3d70 7473 3262 6f6c 642e 6c6f 635b  ]==pts2bold.loc[
-00032f40: 692c 2753 7973 7465 6d4e 616d 6527 5d5d  i,'SystemName']]
-00032f50: 2c62 696e 6172 697a 653d 5472 7565 290a  ,binarize=True).
-00032f60: 2020 2020 2020 2020 7074 496d 6167 653d          ptImage=
-00032f70: 616e 7473 2e74 6872 6573 686f 6c64 5f69  ants.threshold_i
-00032f80: 6d61 6765 2820 7074 496d 672c 2070 7473  mage( ptImg, pts
-00032f90: 3262 6f6c 642e 6c6f 635b 692c 2752 4f49  2bold.loc[i,'ROI
-00032fa0: 275d 2c20 7074 7332 626f 6c64 2e6c 6f63  '], pts2bold.loc
-00032fb0: 5b69 2c27 524f 4927 5d20 290a 2020 2020  [i,'ROI'] ).    
-00032fc0: 6966 2064 6562 7567 3a0a 2020 2020 2020  if debug:.      
-00032fd0: 7074 496d 6741 6c6c 203d 2070 7449 6d67  ptImgAll = ptImg
-00032fe0: 416c 6c20 2b20 7074 496d 6167 650a 2020  All + ptImage.  
-00032ff0: 2020 6966 2070 7449 6d61 6765 2e73 756d    if ptImage.sum
-00033000: 2829 203e 2030 203a 0a20 2020 2020 2020  () > 0 :.       
-00033010: 206d 6561 6e52 4f49 5b3a 2c69 5d20 3d20   meanROI[:,i] = 
-00033020: 616e 7473 2e74 696d 6573 6572 6965 735f  ants.timeseries_
-00033030: 746f 5f6d 6174 7269 7828 2073 696d 672c  to_matrix( simg,
-00033040: 2070 7449 6d61 6765 292e 6d65 616e 2861   ptImage).mean(a
-00033050: 7869 733d 3129 0a0a 2020 6966 2064 6562  xis=1)..  if deb
-00033060: 7567 3a0a 2020 2020 2020 616e 7473 2e69  ug:.      ants.i
-00033070: 6d61 6765 5f77 7269 7465 2820 7369 6d67  mage_write( simg
-00033080: 2c20 272f 746d 702f 7369 6d67 2e6e 6969  , '/tmp/simg.nii
-00033090: 2e67 7a27 2029 0a20 2020 2020 2061 6e74  .gz' ).      ant
-000330a0: 732e 696d 6167 655f 7772 6974 6528 2070  s.image_write( p
-000330b0: 7449 6d67 416c 6c2c 2027 2f74 6d70 2f70  tImgAll, '/tmp/p
-000330c0: 7449 6d67 416c 6c2e 6e69 692e 677a 2720  tImgAll.nii.gz' 
-000330d0: 290a 2020 2020 2020 616e 7473 2e69 6d61  ).      ants.ima
-000330e0: 6765 5f77 7269 7465 2820 756e 642c 2027  ge_write( und, '
-000330f0: 2f74 6d70 2f75 6e64 2e6e 6969 2e67 7a27  /tmp/und.nii.gz'
-00033100: 2029 0a20 2020 2020 2061 6e74 732e 696d   ).      ants.im
-00033110: 6167 655f 7772 6974 6528 2075 6e64 2c20  age_write( und, 
-00033120: 272f 746d 702f 756e 642e 6e69 692e 677a  '/tmp/und.nii.gz
-00033130: 2720 290a 0a20 2023 2067 6574 2066 756c  ' )..  # get ful
-00033140: 6c20 636f 7272 656c 6174 696f 6e20 6d61  l correlation ma
-00033150: 7472 6978 0a20 2063 6f72 4d61 7420 3d20  trix.  corMat = 
-00033160: 6e70 2e63 6f72 7263 6f65 6628 6d65 616e  np.corrcoef(mean
-00033170: 524f 492c 2072 6f77 7661 723d 4661 6c73  ROI, rowvar=Fals
-00033180: 6529 0a20 206f 7574 7075 744d 6174 203d  e).  outputMat =
-00033190: 2070 642e 4461 7461 4672 616d 6528 636f   pd.DataFrame(co
-000331a0: 724d 6174 290a 2020 6f75 7470 7574 4d61  rMat).  outputMa
-000331b0: 742e 636f 6c75 6d6e 7320 3d20 726f 694e  t.columns = roiN
-000331c0: 616d 6573 0a20 206f 7574 7075 744d 6174  ames.  outputMat
-000331d0: 5b27 524f 4973 275d 203d 2072 6f69 4e61  ['ROIs'] = roiNa
-000331e0: 6d65 730a 2020 2320 6164 6420 746f 2064  mes.  # add to d
-000331f0: 6963 7469 6f6e 6172 790a 2020 6f75 7464  ictionary.  outd
-00033200: 6963 745b 2766 756c 6c43 6f72 724d 6174  ict['fullCorrMat
-00033210: 275d 203d 206f 7574 7075 744d 6174 0a0a  '] = outputMat..
-00033220: 2020 6e65 7477 6f72 6b73 203d 2070 6f77    networks = pow
-00033230: 6572 735f 6172 6561 6c5f 6d6e 695f 6974  ers_areal_mni_it
-00033240: 6b5b 2753 7973 7465 6d4e 616d 6527 5d2e  k['SystemName'].
-00033250: 756e 6971 7565 2829 0a20 2023 2074 6869  unique().  # thi
-00033260: 7320 6973 206a 7573 7420 666f 7220 6875  s is just for hu
-00033270: 6d61 6e20 7265 6164 6162 696c 6974 7920  man readability 
-00033280: 2d20 7265 6d69 6e64 7320 7573 206f 6620  - reminds us of 
-00033290: 7768 6963 6820 7765 2063 686f 6f73 6520  which we choose 
-000332a0: 6279 2064 6566 6175 6c74 0a20 2069 6620  by default.  if 
-000332b0: 706f 7765 7273 3a0a 2020 2020 6e65 746e  powers:.    netn
-000332c0: 616d 6573 203d 205b 2743 696e 6775 6c6f  ames = ['Cingulo
-000332d0: 2d6f 7065 7263 756c 6172 2054 6173 6b20  -opercular Task 
-000332e0: 436f 6e74 726f 6c27 2c20 2744 6566 6175  Control', 'Defau
-000332f0: 6c74 204d 6f64 6527 2c0a 2020 2020 2020  lt Mode',.      
-00033300: 2020 2020 2020 2020 2020 2020 2020 274d                'M
-00033310: 656d 6f72 7920 5265 7472 6965 7661 6c27  emory Retrieval'
-00033320: 2c20 2756 656e 7472 616c 2041 7474 656e  , 'Ventral Atten
-00033330: 7469 6f6e 272c 2027 5669 7375 616c 272c  tion', 'Visual',
-00033340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00033350: 2020 2020 2027 4672 6f6e 746f 2d70 6172       'Fronto-par
-00033360: 6965 7461 6c20 5461 736b 2043 6f6e 7472  ietal Task Contr
-00033370: 6f6c 272c 2027 5361 6c69 656e 6365 272c  ol', 'Salience',
-00033380: 2027 5375 6263 6f72 7469 6361 6c27 2c0a   'Subcortical',.
-00033390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000333a0: 2020 2020 2744 6f72 7361 6c20 4174 7465      'Dorsal Atte
-000333b0: 6e74 696f 6e27 5d0a 2020 2020 6e75 6d6f  ntion'].    numo
-000333c0: 666e 6574 7320 3d20 5b33 2c35 2c36 2c37  fnets = [3,5,6,7
-000333d0: 2c38 2c39 2c31 302c 3131 2c31 335d 0a20  ,8,9,10,11,13]. 
-000333e0: 2065 6c73 653a 0a20 2020 206e 6574 6e61   else:.    netna
-000333f0: 6d65 7320 3d20 6e65 7477 6f72 6b73 0a20  mes = networks. 
-00033400: 2020 206e 756d 6f66 6e65 7473 203d 206c     numofnets = l
-00033410: 6973 7428 7261 6e67 6528 6c65 6e28 6e65  ist(range(len(ne
-00033420: 746e 616d 6573 2929 290a 200a 2020 6374  tnames))). .  ct
-00033430: 203d 2030 0a20 2066 6f72 206d 796e 6574   = 0.  for mynet
-00033440: 2069 6e20 6e75 6d6f 666e 6574 733a 0a20   in numofnets:. 
-00033450: 2020 206e 6574 6e61 6d65 203d 2072 652e     netname = re.
-00033460: 7375 6228 2022 2022 2c20 2222 2c20 6e65  sub( " ", "", ne
-00033470: 7477 6f72 6b73 5b6d 796e 6574 5d20 290a  tworks[mynet] ).
-00033480: 2020 2020 6e65 746e 616d 6520 3d20 7265      netname = re
-00033490: 2e73 7562 2820 222d 222c 2022 222c 206e  .sub( "-", "", n
-000334a0: 6574 6e61 6d65 2029 0a20 2020 2077 7720  etname ).    ww 
-000334b0: 3d20 6e70 2e77 6865 7265 2820 706f 7765  = np.where( powe
-000334c0: 7273 5f61 7265 616c 5f6d 6e69 5f69 746b  rs_areal_mni_itk
-000334d0: 5b27 5379 7374 656d 4e61 6d65 275d 203d  ['SystemName'] =
-000334e0: 3d20 6e65 7477 6f72 6b73 5b6d 796e 6574  = networks[mynet
-000334f0: 5d20 295b 305d 0a20 2020 2069 6620 706f  ] )[0].    if po
-00033500: 7765 7273 3a0a 2020 2020 2020 2020 6466  wers:.        df
-00033510: 6e49 6d67 203d 2061 6e74 732e 6d61 6b65  nImg = ants.make
-00033520: 5f70 6f69 6e74 735f 696d 6167 6528 7074  _points_image(pt
-00033530: 7332 626f 6c64 2e69 6c6f 635b 7777 2c3a  s2bold.iloc[ww,:
-00033540: 335d 2e76 616c 7565 732c 2062 6d61 736b  3].values, bmask
-00033550: 2c20 7261 6469 7573 3d31 292e 7468 7265  , radius=1).thre
-00033560: 7368 6f6c 645f 696d 6167 6528 2031 2c20  shold_image( 1, 
-00033570: 3165 3920 290a 2020 2020 656c 7365 3a0a  1e9 ).    else:.
-00033580: 2020 2020 2020 2020 6466 6e49 6d67 203d          dfnImg =
-00033590: 2061 6e74 732e 6d61 736b 5f69 6d61 6765   ants.mask_image
-000335a0: 2820 7074 496d 672c 2070 7449 6d67 2c20  ( ptImg, ptImg, 
-000335b0: 6c65 7665 6c3d 7074 7332 626f 6c64 5b27  level=pts2bold['
-000335c0: 524f 4927 5d5b 7074 7332 626f 6c64 5b27  ROI'][pts2bold['
-000335d0: 5379 7374 656d 4e61 6d65 275d 3d3d 6e65  SystemName']==ne
-000335e0: 7477 6f72 6b73 5b6d 796e 6574 5d5d 2c62  tworks[mynet]],b
-000335f0: 696e 6172 697a 653d 5472 7565 290a 2020  inarize=True).  
-00033600: 2020 6966 2064 666e 496d 672e 6d61 7828    if dfnImg.max(
-00033610: 2920 3e3d 2031 3a0a 2020 2020 2020 2020  ) >= 1:.        
-00033620: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-00033630: 2020 2020 2020 2020 7072 696e 7428 2244          print("D
-00033640: 4f3a 2022 202b 2063 6f6f 7264 7320 2b20  O: " + coords + 
-00033650: 2220 2220 2b20 6e65 746e 616d 6520 290a  " " + netname ).
-00033660: 2020 2020 2020 2020 6466 6e6d 6174 203d          dfnmat =
-00033670: 2061 6e74 732e 7469 6d65 7365 7269 6573   ants.timeseries
-00033680: 5f74 6f5f 6d61 7472 6978 2820 7369 6d67  _to_matrix( simg
-00033690: 2c20 616e 7473 2e74 6872 6573 686f 6c64  , ants.threshold
-000336a0: 5f69 6d61 6765 2820 6466 6e49 6d67 2c20  _image( dfnImg, 
-000336b0: 312c 2064 666e 496d 672e 6d61 7828 2920  1, dfnImg.max() 
-000336c0: 2920 290a 2020 2020 2020 2020 6466 6e73  ) ).        dfns
-000336d0: 6967 6e61 6c20 3d20 6e70 2e6e 616e 6d65  ignal = np.nanme
-000336e0: 616e 2820 6466 6e6d 6174 2c20 6178 6973  an( dfnmat, axis
-000336f0: 203d 2031 2029 0a20 2020 2020 2020 206e   = 1 ).        n
-00033700: 616e 5f63 6f75 6e74 5f64 666e 203d 206e  an_count_dfn = n
-00033710: 702e 636f 756e 745f 6e6f 6e7a 6572 6f28  p.count_nonzero(
-00033720: 206e 702e 6973 6e61 6e28 2064 666e 7369   np.isnan( dfnsi
-00033730: 676e 616c 2920 290a 2020 2020 2020 2020  gnal) ).        
-00033740: 6966 206e 616e 5f63 6f75 6e74 5f64 666e  if nan_count_dfn
-00033750: 203e 2030 203a 0a20 2020 2020 2020 2020   > 0 :.         
-00033760: 2020 2077 6172 6e69 6e67 732e 7761 726e     warnings.warn
-00033770: 2820 2220 6d79 6e65 7420 2220 2b20 6e65  ( " mynet " + ne
-00033780: 746e 616d 6573 5b20 6d79 6e65 7420 5d20  tnames[ mynet ] 
-00033790: 2b20 2220 7673 2022 202b 2020 2220 6d65  + " vs " +  " me
-000337a0: 616e 2d73 6967 6e61 6c20 6861 7320 6e61  an-signal has na
-000337b0: 6e73 2022 202b 2073 7472 2820 6e61 6e5f  ns " + str( nan_
-000337c0: 636f 756e 745f 6466 6e20 2920 2920 0a20  count_dfn ) ) . 
-000337d0: 2020 2020 2020 2067 6d6d 6174 4446 4e43         gmmatDFNC
-000337e0: 6f72 7220 3d20 6e70 2e7a 6572 6f73 2820  orr = np.zeros( 
-000337f0: 676d 6d61 742e 7368 6170 655b 315d 2029  gmmat.shape[1] )
-00033800: 0a20 2020 2020 2020 2069 6620 6e61 6e5f  .        if nan_
-00033810: 636f 756e 745f 6466 6e20 3d3d 2030 3a0a  count_dfn == 0:.
-00033820: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00033830: 6b20 696e 2072 616e 6765 2820 676d 6d61  k in range( gmma
-00033840: 742e 7368 6170 655b 315d 2029 3a0a 2020  t.shape[1] ):.  
-00033850: 2020 2020 2020 2020 2020 2020 2020 6e61                na
-00033860: 6e5f 636f 756e 745f 676d 203d 206e 702e  n_count_gm = np.
-00033870: 636f 756e 745f 6e6f 6e7a 6572 6f28 206e  count_nonzero( n
-00033880: 702e 6973 6e61 6e28 2067 6d6d 6174 5b3a  p.isnan( gmmat[:
-00033890: 2c6b 5d29 2029 0a20 2020 2020 2020 2020  ,k]) ).         
-000338a0: 2020 2020 2020 2069 6620 6465 6275 6720         if debug 
-000338b0: 616e 6420 4661 6c73 653a 0a20 2020 2020  and False:.     
-000338c0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000338d0: 7269 6e74 2820 7374 7228 206b 2029 202b  rint( str( k ) +
-000338e0: 2020 2220 6e61 6e73 2067 6d20 2220 2b20    " nans gm " + 
-000338f0: 7374 7228 6e61 6e5f 636f 756e 745f 676d  str(nan_count_gm
-00033900: 2920 2029 0a20 2020 2020 2020 2020 2020  )  ).           
-00033910: 2020 2020 2069 6620 6e61 6e5f 636f 756e       if nan_coun
-00033920: 745f 676d 203d 3d20 303a 0a20 2020 2020  t_gm == 0:.     
-00033930: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00033940: 6d6d 6174 4446 4e43 6f72 725b 206b 205d  mmatDFNCorr[ k ]
-00033950: 203d 2070 6561 7273 6f6e 7228 2064 666e   = pearsonr( dfn
-00033960: 7369 676e 616c 2c20 676d 6d61 745b 3a2c  signal, gmmat[:,
-00033970: 6b5d 2029 5b30 5d0a 2020 2020 2020 2020  k] )[0].        
-00033980: 636f 7272 496d 6720 3d20 616e 7473 2e6d  corrImg = ants.m
-00033990: 616b 655f 696d 6167 6528 2062 6d61 736b  ake_image( bmask
-000339a0: 2c20 676d 6d61 7444 464e 436f 7272 2020  , gmmatDFNCorr  
-000339b0: 290a 2020 2020 2020 2020 6f75 7464 6963  ).        outdic
-000339c0: 745b 206e 6574 6e61 6d65 205d 203d 2063  t[ netname ] = c
-000339d0: 6f72 7249 6d67 202a 2067 6d73 6567 0a20  orrImg * gmseg. 
-000339e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000339f0: 206f 7574 6469 6374 5b20 6e65 746e 616d   outdict[ netnam
-00033a00: 6520 5d20 3d20 4e6f 6e65 0a20 2020 2063  e ] = None.    c
-00033a10: 7420 3d20 6374 202b 2031 0a0a 2020 4120  t = ct + 1..  A 
-00033a20: 3d20 6e70 2e7a 6572 6f73 2820 2820 6c65  = np.zeros( ( le
-00033a30: 6e28 206e 756d 6f66 6e65 7473 2029 202c  n( numofnets ) ,
-00033a40: 206c 656e 2820 6e75 6d6f 666e 6574 7320   len( numofnets 
-00033a50: 2920 2920 290a 2020 415f 7769 6465 203d  ) ) ).  A_wide =
-00033a60: 206e 702e 7a65 726f 7328 2028 2031 2c20   np.zeros( ( 1, 
-00033a70: 6c65 6e28 206e 756d 6f66 6e65 7473 2029  len( numofnets )
-00033a80: 202a 206c 656e 2820 6e75 6d6f 666e 6574   * len( numofnet
-00033a90: 7320 2920 2920 290a 2020 6e65 776e 616d  s ) ) ).  newnam
-00033aa0: 6573 3d5b 5d0a 2020 6e65 776e 616d 6573  es=[].  newnames
-00033ab0: 5f77 6964 653d 5b5d 0a20 2063 7420 3d20  _wide=[].  ct = 
-00033ac0: 300a 2020 666f 7220 6920 696e 2072 616e  0.  for i in ran
-00033ad0: 6765 2820 6c65 6e28 206e 756d 6f66 6e65  ge( len( numofne
-00033ae0: 7473 2029 2029 3a0a 2020 2020 2020 6e65  ts ) ):.      ne
-00033af0: 746e 616d 6569 203d 2072 652e 7375 6228  tnamei = re.sub(
-00033b00: 2022 2022 2c20 2222 2c20 6e65 7477 6f72   " ", "", networ
-00033b10: 6b73 5b6e 756d 6f66 6e65 7473 5b69 5d5d  ks[numofnets[i]]
-00033b20: 2029 0a20 2020 2020 206e 6574 6e61 6d65   ).      netname
-00033b30: 6920 3d20 7265 2e73 7562 2820 222d 222c  i = re.sub( "-",
-00033b40: 2022 222c 206e 6574 6e61 6d65 6920 290a   "", netnamei ).
-00033b50: 2020 2020 2020 6e65 776e 616d 6573 2e61        newnames.a
-00033b60: 7070 656e 6428 206e 6574 6e61 6d65 6920  ppend( netnamei 
-00033b70: 2029 0a20 2020 2020 2077 7720 3d20 6e70   ).      ww = np
-00033b80: 2e77 6865 7265 2820 706f 7765 7273 5f61  .where( powers_a
-00033b90: 7265 616c 5f6d 6e69 5f69 746b 5b27 5379  real_mni_itk['Sy
-00033ba0: 7374 656d 4e61 6d65 275d 203d 3d20 6e65  stemName'] == ne
-00033bb0: 7477 6f72 6b73 5b6e 756d 6f66 6e65 7473  tworks[numofnets
-00033bc0: 5b69 5d5d 2029 5b30 5d0a 2020 2020 2020  [i]] )[0].      
-00033bd0: 6966 2070 6f77 6572 733a 0a20 2020 2020  if powers:.     
-00033be0: 2020 2020 2064 666e 496d 6720 3d20 616e       dfnImg = an
-00033bf0: 7473 2e6d 616b 655f 706f 696e 7473 5f69  ts.make_points_i
-00033c00: 6d61 6765 2870 7473 3262 6f6c 642e 696c  mage(pts2bold.il
-00033c10: 6f63 5b77 772c 3a33 5d2e 7661 6c75 6573  oc[ww,:3].values
-00033c20: 2c20 626d 6173 6b2c 2072 6164 6975 733d  , bmask, radius=
-00033c30: 3129 2e74 6872 6573 686f 6c64 5f69 6d61  1).threshold_ima
-00033c40: 6765 2820 312c 2031 6539 2029 0a20 2020  ge( 1, 1e9 ).   
-00033c50: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00033c60: 2020 2064 666e 496d 6720 3d20 616e 7473     dfnImg = ants
-00033c70: 2e6d 6173 6b5f 696d 6167 6528 2070 7449  .mask_image( ptI
-00033c80: 6d67 2c20 7074 496d 672c 206c 6576 656c  mg, ptImg, level
-00033c90: 3d70 7473 3262 6f6c 645b 2752 4f49 275d  =pts2bold['ROI']
-00033ca0: 5b70 7473 3262 6f6c 645b 2753 7973 7465  [pts2bold['Syste
-00033cb0: 6d4e 616d 6527 5d3d 3d6e 6574 776f 726b  mName']==network
-00033cc0: 735b 6e75 6d6f 666e 6574 735b 695d 5d5d  s[numofnets[i]]]
-00033cd0: 2c62 696e 6172 697a 653d 5472 7565 290a  ,binarize=True).
-00033ce0: 2020 2020 2020 666f 7220 6a20 696e 2072        for j in r
-00033cf0: 616e 6765 2820 6c65 6e28 206e 756d 6f66  ange( len( numof
-00033d00: 6e65 7473 2029 2029 3a0a 2020 2020 2020  nets ) ):.      
-00033d10: 2020 2020 6e65 746e 616d 656a 203d 2072      netnamej = r
-00033d20: 652e 7375 6228 2022 2022 2c20 2222 2c20  e.sub( " ", "", 
-00033d30: 6e65 7477 6f72 6b73 5b6e 756d 6f66 6e65  networks[numofne
-00033d40: 7473 5b6a 5d5d 2029 0a20 2020 2020 2020  ts[j]] ).       
-00033d50: 2020 206e 6574 6e61 6d65 6a20 3d20 7265     netnamej = re
-00033d60: 2e73 7562 2820 222d 222c 2022 222c 206e  .sub( "-", "", n
-00033d70: 6574 6e61 6d65 6a20 290a 2020 2020 2020  etnamej ).      
-00033d80: 2020 2020 6e65 776e 616d 6573 5f77 6964      newnames_wid
-00033d90: 652e 6170 7065 6e64 2820 6e65 746e 616d  e.append( netnam
-00033da0: 6569 202b 2022 5f32 5f22 202b 206e 6574  ei + "_2_" + net
-00033db0: 6e61 6d65 6a20 290a 2020 2020 2020 2020  namej ).        
-00033dc0: 2020 415b 692c 6a5d 203d 2030 0a20 2020    A[i,j] = 0.   
-00033dd0: 2020 2020 2020 2069 6620 6466 6e49 6d67         if dfnImg
-00033de0: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
-00033df0: 206e 6574 6e61 6d65 6a20 6973 206e 6f74   netnamej is not
-00033e00: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00033e10: 2020 2073 7562 6269 7420 3d20 6466 6e49     subbit = dfnI
-00033e20: 6d67 203d 3d20 310a 2020 2020 2020 2020  mg == 1.        
-00033e30: 2020 2020 6966 2073 7562 6269 7420 6973      if subbit is
-00033e40: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00033e50: 2020 2020 2020 2020 2020 2069 6620 7375             if su
-00033e60: 6262 6974 2e73 756d 2829 203e 2030 2061  bbit.sum() > 0 a
-00033e70: 6e64 206e 6574 6e61 6d65 6a20 696e 206f  nd netnamej in o
-00033e80: 7574 6469 6374 3a0a 2020 2020 2020 2020  utdict:.        
-00033e90: 2020 2020 2020 2020 2020 2020 415b 692c              A[i,
-00033ea0: 6a5d 203d 206f 7574 6469 6374 5b20 6e65  j] = outdict[ ne
-00033eb0: 746e 616d 656a 205d 5b20 7375 6262 6974  tnamej ][ subbit
-00033ec0: 205d 2e6d 6561 6e28 290a 2020 2020 2020   ].mean().      
-00033ed0: 2020 2020 415f 7769 6465 5b30 2c63 745d      A_wide[0,ct]
-00033ee0: 203d 2041 5b69 2c6a 5d0a 2020 2020 2020   = A[i,j].      
-00033ef0: 2020 2020 6374 3d63 742b 310a 0a20 2041      ct=ct+1..  A
-00033f00: 203d 2070 642e 4461 7461 4672 616d 6528   = pd.DataFrame(
-00033f10: 2041 2029 0a20 2041 2e63 6f6c 756d 6e73   A ).  A.columns
-00033f20: 203d 206e 6577 6e61 6d65 730a 2020 415b   = newnames.  A[
-00033f30: 276e 6574 776f 726b 7327 5d3d 6e65 776e  'networks']=newn
-00033f40: 616d 6573 0a20 2041 5f77 6964 6520 3d20  ames.  A_wide = 
-00033f50: 7064 2e44 6174 6146 7261 6d65 2820 415f  pd.DataFrame( A_
-00033f60: 7769 6465 2029 0a20 2041 5f77 6964 652e  wide ).  A_wide.
-00033f70: 636f 6c75 6d6e 7320 3d20 6e65 776e 616d  columns = newnam
-00033f80: 6573 5f77 6964 650a 2020 6f75 7464 6963  es_wide.  outdic
-00033f90: 745b 2763 6f72 7227 5d20 3d20 410a 2020  t['corr'] = A.  
-00033fa0: 6f75 7464 6963 745b 2763 6f72 725f 7769  outdict['corr_wi
-00033fb0: 6465 275d 203d 2041 5f77 6964 650a 2020  de'] = A_wide.  
-00033fc0: 6f75 7464 6963 745b 2766 6d72 695f 7465  outdict['fmri_te
-00033fd0: 6d70 6c61 7465 275d 203d 2066 6d72 695f  mplate'] = fmri_
-00033fe0: 7465 6d70 6c61 7465 0a20 206f 7574 6469  template.  outdi
-00033ff0: 6374 5b27 6272 6169 6e6d 6173 6b27 5d20  ct['brainmask'] 
-00034000: 3d20 626d 6173 6b0a 2020 6f75 7464 6963  = bmask.  outdic
-00034010: 745b 2767 6d6d 6173 6b27 5d20 3d20 676d  t['gmmask'] = gm
-00034020: 7365 670a 2020 6f75 7464 6963 745b 2761  seg.  outdict['a
-00034030: 6c66 6627 5d20 3d20 6d79 6661 6c66 665b  lff'] = myfalff[
-00034040: 2761 6c66 6627 5d0a 2020 6f75 7464 6963  'alff'].  outdic
-00034050: 745b 2766 616c 6666 275d 203d 206d 7966  t['falff'] = myf
-00034060: 616c 6666 5b27 6661 6c66 6627 5d0a 2020  alff['falff'].  
-00034070: 2320 6164 6420 676c 6f62 616c 206d 6561  # add global mea
-00034080: 6e20 616e 6420 7374 616e 6461 7264 2064  n and standard d
-00034090: 6576 6961 7469 6f6e 2066 6f72 2070 6f73  eviation for pos
-000340a0: 742d 686f 6320 7a2d 7363 6f72 696e 670a  t-hoc z-scoring.
-000340b0: 2020 6f75 7464 6963 745b 2761 6c66 665f    outdict['alff_
-000340c0: 6d65 616e 275d 203d 2028 6d79 6661 6c66  mean'] = (myfalf
-000340d0: 665b 2761 6c66 6627 5d5b 6d79 6661 6c66  f['alff'][myfalf
-000340e0: 665b 2761 6c66 6627 5d21 3d30 5d29 2e6d  f['alff']!=0]).m
-000340f0: 6561 6e28 290a 2020 6f75 7464 6963 745b  ean().  outdict[
-00034100: 2761 6c66 665f 7364 275d 203d 2028 6d79  'alff_sd'] = (my
-00034110: 6661 6c66 665b 2761 6c66 6627 5d5b 6d79  falff['alff'][my
-00034120: 6661 6c66 665b 2761 6c66 6627 5d21 3d30  falff['alff']!=0
-00034130: 5d29 2e73 7464 2829 0a20 206f 7574 6469  ]).std().  outdi
-00034140: 6374 5b27 6661 6c66 665f 6d65 616e 275d  ct['falff_mean']
-00034150: 203d 2028 6d79 6661 6c66 665b 2766 616c   = (myfalff['fal
-00034160: 6666 275d 5b6d 7966 616c 6666 5b27 6661  ff'][myfalff['fa
-00034170: 6c66 6627 5d21 3d30 5d29 2e6d 6561 6e28  lff']!=0]).mean(
-00034180: 290a 2020 6f75 7464 6963 745b 2766 616c  ).  outdict['fal
-00034190: 6666 5f73 6427 5d20 3d20 286d 7966 616c  ff_sd'] = (myfal
-000341a0: 6666 5b27 6661 6c66 6627 5d5b 6d79 6661  ff['falff'][myfa
-000341b0: 6c66 665b 2766 616c 6666 275d 213d 305d  lff['falff']!=0]
-000341c0: 292e 7374 6428 290a 0a20 2070 6572 6166  ).std()..  peraf
-000341d0: 696d 6720 3d20 5065 7241 4628 2073 696d  img = PerAF( sim
-000341e0: 6769 6d70 2c20 626d 6173 6b20 290a 2020  gimp, bmask ).  
-000341f0: 666f 7220 6b20 696e 2070 6f69 6e74 7261  for k in pointra
-00034200: 6e67 653a 0a20 2020 2061 6e61 746e 616d  nge:.    anatnam
-00034210: 653d 2820 7074 7332 626f 6c64 5b27 4141  e=( pts2bold['AA
-00034220: 4c27 5d5b 6b5d 2029 0a20 2020 2069 6620  L'][k] ).    if 
-00034230: 6973 696e 7374 616e 6365 2861 6e61 746e  isinstance(anatn
-00034240: 616d 652c 2073 7472 293a 0a20 2020 2020  ame, str):.     
-00034250: 2020 2061 6e61 746e 616d 6520 3d20 7265     anatname = re
-00034260: 2e73 7562 2822 5f22 2c22 222c 616e 6174  .sub("_","",anat
-00034270: 6e61 6d65 290a 2020 2020 656c 7365 3a0a  name).    else:.
-00034280: 2020 2020 2020 2020 616e 6174 6e61 6d65          anatname
-00034290: 3d27 556e 6b27 0a20 2020 2069 6620 706f  ='Unk'.    if po
-000342a0: 7765 7273 3a0a 2020 2020 2020 2020 6b6b  wers:.        kk
-000342b0: 203d 2066 227b 6b3a 303e 337d 222b 225f   = f"{k:0>3}"+"_
-000342c0: 220a 2020 2020 656c 7365 3a0a 2020 2020  ".    else:.    
-000342d0: 2020 2020 6b6b 203d 2066 227b 6b20 2520      kk = f"{k % 
-000342e0: 696e 7428 6e50 6f69 6e74 732f 3229 3a30  int(nPoints/2):0
-000342f0: 3e33 7d22 2b22 5f22 0a20 2020 2066 6e61  >3}"+"_".    fna
-00034300: 6d65 3d27 6661 6c66 6650 6f69 6e74 272b  me='falffPoint'+
-00034310: 6b6b 2b61 6e61 746e 616d 650a 2020 2020  kk+anatname.    
-00034320: 616e 616d 653d 2761 6c66 6650 6f69 6e74  aname='alffPoint
-00034330: 272b 6b6b 2b61 6e61 746e 616d 650a 2020  '+kk+anatname.  
-00034340: 2020 706e 616d 653d 2770 6572 6166 506f    pname='perafPo
-00034350: 696e 7427 2b6b 6b2b 616e 6174 6e61 6d65  int'+kk+anatname
-00034360: 0a20 2020 206c 6f63 616c 7365 6c20 3d20  .    localsel = 
-00034370: 7074 496d 6720 3d3d 206b 0a20 2020 2069  ptImg == k.    i
-00034380: 6620 6c6f 6361 6c73 656c 2e73 756d 2829  f localsel.sum()
-00034390: 203e 2030 203a 2023 2063 6865 636b 2069   > 0 : # check i
-000343a0: 6620 6e6f 6e2d 656d 7074 790a 2020 2020  f non-empty.    
-000343b0: 2020 2020 6f75 7464 6963 745b 666e 616d      outdict[fnam
-000343c0: 655d 3d28 6f75 7464 6963 745b 2766 616c  e]=(outdict['fal
-000343d0: 6666 275d 5b6c 6f63 616c 7365 6c5d 292e  ff'][localsel]).
-000343e0: 6d65 616e 2829 0a20 2020 2020 2020 206f  mean().        o
-000343f0: 7574 6469 6374 5b61 6e61 6d65 5d3d 286f  utdict[aname]=(o
-00034400: 7574 6469 6374 5b27 616c 6666 275d 5b6c  utdict['alff'][l
-00034410: 6f63 616c 7365 6c5d 292e 6d65 616e 2829  ocalsel]).mean()
-00034420: 0a20 2020 2020 2020 206f 7574 6469 6374  .        outdict
-00034430: 5b70 6e61 6d65 5d3d 2870 6572 6166 696d  [pname]=(perafim
-00034440: 675b 6c6f 6361 6c73 656c 5d29 2e6d 6561  g[localsel]).mea
-00034450: 6e28 290a 2020 2020 656c 7365 3a0a 2020  n().    else:.  
-00034460: 2020 2020 2020 6f75 7464 6963 745b 666e        outdict[fn
-00034470: 616d 655d 3d6d 6174 682e 6e61 6e0a 2020  ame]=math.nan.  
-00034480: 2020 2020 2020 6f75 7464 6963 745b 616e        outdict[an
-00034490: 616d 655d 3d6d 6174 682e 6e61 6e0a 2020  ame]=math.nan.  
-000344a0: 2020 2020 2020 6f75 7464 6963 745b 706e        outdict[pn
-000344b0: 616d 655d 3d6d 6174 682e 6e61 6e0a 0a20  ame]=math.nan.. 
-000344c0: 2072 7366 4e75 6973 616e 6365 203d 2070   rsfNuisance = p
-000344d0: 642e 4461 7461 4672 616d 6528 206e 7569  d.DataFrame( nui
-000344e0: 7361 6e63 6520 290a 2020 6966 2072 656d  sance ).  if rem
-000344f0: 6f76 655f 6974 3a0a 2020 2020 696d 706f  ove_it:.    impo
-00034500: 7274 2073 6875 7469 6c0a 2020 2020 7368  rt shutil.    sh
-00034510: 7574 696c 2e72 6d74 7265 6528 6f75 7470  util.rmtree(outp
-00034520: 7574 5f64 6972 6563 746f 7279 2c20 6967  ut_directory, ig
-00034530: 6e6f 7265 5f65 7272 6f72 733d 5472 7565  nore_errors=True
-00034540: 2029 0a0a 2020 6966 206e 6f74 2070 6f77   )..  if not pow
-00034550: 6572 733a 0a20 2020 2064 666e 7375 6d3d  ers:.    dfnsum=
-00034560: 6f75 7464 6963 745b 2744 6566 6175 6c74  outdict['Default
-00034570: 4127 5d2b 6f75 7464 6963 745b 2744 6566  A']+outdict['Def
-00034580: 6175 6c74 4227 5d2b 6f75 7464 6963 745b  aultB']+outdict[
-00034590: 2744 6566 6175 6c74 4327 5d0a 2020 2020  'DefaultC'].    
-000345a0: 6f75 7464 6963 745b 2744 6566 6175 6c74  outdict['Default
-000345b0: 4d6f 6465 275d 3d64 666e 7375 6d0a 2020  Mode']=dfnsum.  
-000345c0: 2020 6466 6e73 756d 3d6f 7574 6469 6374    dfnsum=outdict
-000345d0: 5b27 5669 7343 656e 7427 5d2b 6f75 7464  ['VisCent']+outd
-000345e0: 6963 745b 2756 6973 5065 7269 275d 0a20  ict['VisPeri']. 
-000345f0: 2020 206f 7574 6469 6374 5b27 5669 7375     outdict['Visu
-00034600: 616c 275d 3d64 666e 7375 6d0a 0a20 206e  al']=dfnsum..  n
-00034610: 6f6e 6272 6169 6e6d 6173 6b20 3d20 616e  onbrainmask = an
-00034620: 7473 2e69 4d61 7468 2820 626d 6173 6b2c  ts.iMath( bmask,
-00034630: 2022 4d44 222c 3229 202d 2062 6d61 736b   "MD",2) - bmask
-00034640: 0a20 2074 7269 6d6d 6173 6b20 3d20 616e  .  trimmask = an
-00034650: 7473 2e69 4d61 7468 2820 626d 6173 6b2c  ts.iMath( bmask,
-00034660: 2022 4d45 222c 3229 0a20 2065 6467 656d   "ME",2).  edgem
-00034670: 6173 6b20 3d20 616e 7473 2e69 4d61 7468  ask = ants.iMath
-00034680: 2820 626d 6173 6b2c 2022 4d45 222c 3129  ( bmask, "ME",1)
-00034690: 202d 2074 7269 6d6d 6173 6b0a 2020 6f75   - trimmask.  ou
-000346a0: 7464 6963 745b 276d 6f74 696f 6e5f 636f  tdict['motion_co
-000346b0: 7272 6563 7465 6427 5d20 3d20 636f 7272  rrected'] = corr
-000346c0: 6d6f 5b27 6d6f 7469 6f6e 5f63 6f72 7265  mo['motion_corre
-000346d0: 6374 6564 275d 0a20 206f 7574 6469 6374  cted'].  outdict
-000346e0: 5b27 6e75 6973 616e 6365 275d 203d 2072  ['nuisance'] = r
-000346f0: 7366 4e75 6973 616e 6365 0a20 206f 7574  sfNuisance.  out
-00034700: 6469 6374 5b27 5065 7241 4627 5d20 3d20  dict['PerAF'] = 
-00034710: 7065 7261 6669 6d67 0a20 206f 7574 6469  perafimg.  outdi
-00034720: 6374 5b27 7473 6e72 275d 203d 206d 7974  ct['tsnr'] = myt
-00034730: 736e 720a 2020 6f75 7464 6963 745b 2773  snr.  outdict['s
-00034740: 736e 7227 5d20 3d20 736c 6963 655f 736e  snr'] = slice_sn
-00034750: 7228 2063 6f72 726d 6f5b 276d 6f74 696f  r( corrmo['motio
-00034760: 6e5f 636f 7272 6563 7465 6427 5d2c 2063  n_corrected'], c
-00034770: 7366 416e 6457 4d2c 2067 6d73 6567 2029  sfAndWM, gmseg )
-00034780: 0a20 206f 7574 6469 6374 5b27 6476 6172  .  outdict['dvar
-00034790: 7327 5d20 3d20 6476 6172 7328 2063 6f72  s'] = dvars( cor
-000347a0: 726d 6f5b 276d 6f74 696f 6e5f 636f 7272  rmo['motion_corr
-000347b0: 6563 7465 6427 5d2c 2067 6d73 6567 2029  ected'], gmseg )
-000347c0: 0a20 206f 7574 6469 6374 5b27 6261 6e64  .  outdict['band
-000347d0: 7061 7373 5f66 7265 715f 3027 5d3d 665b  pass_freq_0']=f[
-000347e0: 305d 0a20 206f 7574 6469 6374 5b27 6261  0].  outdict['ba
-000347f0: 6e64 7061 7373 5f66 7265 715f 3127 5d3d  ndpass_freq_1']=
-00034800: 665b 315d 0a20 206f 7574 6469 6374 5b27  f[1].  outdict['
-00034810: 6365 6e73 6f72 275d 3d69 6e74 2863 656e  censor']=int(cen
-00034820: 736f 7229 0a20 206f 7574 6469 6374 5b27  sor).  outdict['
-00034830: 7370 6174 6961 6c5f 736d 6f6f 7468 696e  spatial_smoothin
-00034840: 6727 5d3d 7370 610a 2020 6f75 7464 6963  g']=spa.  outdic
-00034850: 745b 276f 7574 6c69 6572 5f74 6872 6573  t['outlier_thres
-00034860: 686f 6c64 275d 3d6f 7574 6c69 6572 5f74  hold']=outlier_t
-00034870: 6872 6573 686f 6c64 0a20 206f 7574 6469  hreshold.  outdi
-00034880: 6374 5b27 4644 5f74 6872 6573 686f 6c64  ct['FD_threshold
-00034890: 275d 3d6f 7574 6c69 6572 5f74 6872 6573  ']=outlier_thres
-000348a0: 686f 6c64 0a20 206f 7574 6469 6374 5b27  hold.  outdict['
-000348b0: 6869 6768 5f6d 6f74 696f 6e5f 636f 756e  high_motion_coun
-000348c0: 7427 5d20 3d20 6869 6768 5f6d 6f74 696f  t'] = high_motio
-000348d0: 6e5f 636f 756e 740a 2020 6f75 7464 6963  n_count.  outdic
-000348e0: 745b 2768 6967 685f 6d6f 7469 6f6e 5f70  t['high_motion_p
-000348f0: 6374 275d 203d 2068 6967 685f 6d6f 7469  ct'] = high_moti
-00034900: 6f6e 5f70 6374 0a20 206f 7574 6469 6374  on_pct.  outdict
-00034910: 5b27 6465 7370 696b 696e 675f 636f 756e  ['despiking_coun
-00034920: 745f 7375 6d6d 6172 7927 5d20 3d20 6465  t_summary'] = de
-00034930: 7370 696b 696e 675f 636f 756e 745f 7375  spiking_count_su
-00034940: 6d6d 6172 790a 2020 6f75 7464 6963 745b  mmary.  outdict[
-00034950: 2746 445f 6d61 7827 5d20 3d20 636f 7272  'FD_max'] = corr
-00034960: 6d6f 5b27 4644 275d 2e6d 6178 2829 0a20  mo['FD'].max(). 
-00034970: 206f 7574 6469 6374 5b27 4644 5f6d 6561   outdict['FD_mea
-00034980: 6e27 5d20 3d20 636f 7272 6d6f 5b27 4644  n'] = corrmo['FD
-00034990: 275d 2e6d 6561 6e28 290a 2020 6f75 7464  '].mean().  outd
-000349a0: 6963 745b 2746 445f 7364 275d 203d 2063  ict['FD_sd'] = c
-000349b0: 6f72 726d 6f5b 2746 4427 5d2e 7374 6428  orrmo['FD'].std(
-000349c0: 290a 2020 6f75 7464 6963 745b 2762 6f6c  ).  outdict['bol
-000349d0: 645f 6576 7227 5d20 3d20 2061 6e74 7370  d_evr'] =  antsp
-000349e0: 7974 3177 2e70 6174 6368 5f65 6967 656e  yt1w.patch_eigen
-000349f0: 7661 6c75 655f 7261 7469 6f28 2075 6e64  value_ratio( und
-00034a00: 2c20 3531 322c 205b 3136 2c31 362c 3136  , 512, [16,16,16
-00034a10: 5d2c 2065 7664 6570 7468 203d 2030 2e39  ], evdepth = 0.9
-00034a20: 2c20 6d61 736b 203d 2062 6d61 736b 2029  , mask = bmask )
-00034a30: 0a20 206f 7574 6469 6374 5b27 6e5f 6f75  .  outdict['n_ou
-00034a40: 746c 6965 7273 275d 203d 206c 656e 2868  tliers'] = len(h
-00034a50: 6c69 6e64 7329 0a20 206f 7574 6469 6374  linds).  outdict
-00034a60: 5b27 6e63 5f77 6d27 5d20 3d20 696e 7428  ['nc_wm'] = int(
-00034a70: 6e63 5f77 6d29 0a20 206f 7574 6469 6374  nc_wm).  outdict
-00034a80: 5b27 6e63 5f63 7366 275d 203d 2069 6e74  ['nc_csf'] = int
-00034a90: 286e 635f 6373 6629 0a20 206f 7574 6469  (nc_csf).  outdi
-00034aa0: 6374 5b27 6d69 6e75 7465 735f 6f72 6967  ct['minutes_orig
-00034ab0: 696e 616c 5f64 6174 6127 5d20 3d20 2820  inal_data'] = ( 
-00034ac0: 7472 202a 2066 6d72 692e 7368 6170 655b  tr * fmri.shape[
-00034ad0: 335d 2029 202f 2036 302e 3020 2320 6d69  3] ) / 60.0 # mi
-00034ae0: 6e75 7465 7320 6f66 2075 7365 6675 6c20  nutes of useful 
-00034af0: 6461 7461 0a20 206f 7574 6469 6374 5b27  data.  outdict['
-00034b00: 6d69 6e75 7465 735f 6365 6e73 6f72 6564  minutes_censored
-00034b10: 5f64 6174 6127 5d20 3d20 2820 7472 202a  _data'] = ( tr *
-00034b20: 2073 696d 672e 7368 6170 655b 335d 2029   simg.shape[3] )
-00034b30: 202f 2036 302e 3020 2320 6d69 6e75 7465   / 60.0 # minute
-00034b40: 7320 6f66 2075 7365 6675 6c20 6461 7461  s of useful data
-00034b50: 0a20 2072 6574 7572 6e20 636f 6e76 6572  .  return conver
-00034b60: 745f 6e70 5f69 6e5f 6469 6374 2820 6f75  t_np_in_dict( ou
-00034b70: 7464 6963 7420 290a 0a0a 6465 6620 6361  tdict )...def ca
-00034b80: 6c63 756c 6174 655f 4342 4628 4465 6c74  lculate_CBF(Delt
-00034b90: 615f 4d2c 204d 5f30 2c20 6d61 736b 2c0a  a_M, M_0, mask,.
-00034ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034bb0: 2020 4c61 6d62 6461 3d30 2e39 2c20 545f    Lambda=0.9, T_
-00034bc0: 313d 302e 3637 2c20 416c 7068 613d 302e  1=0.67, Alpha=0.
-00034bd0: 3638 2c20 773d 312e 302c 2054 6175 3d31  68, w=1.0, Tau=1
-00034be0: 2e35 293a 0a20 2020 2022 2222 0a20 2020  .5):.    """.   
-00034bf0: 2043 616c 6375 6c61 7465 2074 6865 2043   Calculate the C
-00034c00: 6572 6562 7261 6c20 426c 6f6f 6420 466c  erebral Blood Fl
-00034c10: 6f77 2028 4342 4629 2077 6865 7265 2044  ow (CBF) where D
-00034c20: 656c 7461 5f4d 2061 6e64 204d 5f30 2061  elta_M and M_0 a
-00034c30: 7265 2061 6e74 7349 6d61 6765 7320 0a20  re antsImages . 
-00034c40: 2020 2061 6e64 2074 6865 206f 7468 6572     and the other
-00034c50: 2076 6172 6961 626c 6573 2061 7265 2073   variables are s
-00034c60: 6361 6c61 7273 2e20 2047 7565 7373 6573  calars.  Guesses
-00034c70: 2061 7420 6465 6661 756c 7420 7661 6c75   at default valu
-00034c80: 6573 2061 7265 2075 7365 6420 6865 7265  es are used here
-00034c90: 2e20 0a20 2020 2057 6520 7573 6520 7468  . .    We use th
-00034ca0: 6520 7043 4153 4c20 6571 7561 7469 6f6e  e pCASL equation
-00034cb0: 2e20 204e 4f54 2059 4554 2054 4553 5445  .  NOT YET TESTE
-00034cc0: 442e 0a0a 2020 2020 5061 7261 6d65 7465  D...    Paramete
-00034cd0: 7273 3a0a 2020 2020 4465 6c74 615f 4d20  rs:.    Delta_M 
-00034ce0: 2861 6e74 7349 6d61 6765 293a 2043 6861  (antsImage): Cha
-00034cf0: 6e67 6520 696e 206d 6167 6e65 7469 7a61  nge in magnetiza
-00034d00: 7469 6f6e 2028 6d61 7472 6978 290a 2020  tion (matrix).  
-00034d10: 2020 4d5f 3020 2861 6e74 7349 6d61 6765    M_0 (antsImage
-00034d20: 293a 2049 6e69 7469 616c 206d 6167 6e65  ): Initial magne
-00034d30: 7469 7a61 7469 6f6e 2028 6d61 7472 6978  tization (matrix
-00034d40: 290a 2020 2020 6d61 736b 2028 2061 6e74  ).    mask ( ant
-00034d50: 7349 6d61 6765 2029 3a20 7768 6572 6520  sImage ): where 
-00034d60: 746f 2064 6f20 7468 6520 6361 6c63 756c  to do the calcul
-00034d70: 6174 696f 6e0a 2020 2020 4c61 6d62 6461  ation.    Lambda
-00034d80: 2028 666c 6f61 7429 3a20 5363 616c 6172   (float): Scalar
-00034d90: 0a20 2020 2054 5f31 2028 666c 6f61 7429  .    T_1 (float)
-00034da0: 3a20 5363 616c 6172 2072 6570 7265 7365  : Scalar represe
-00034db0: 6e74 696e 6720 7265 6c61 7861 7469 6f6e  nting relaxation
-00034dc0: 2074 696d 650a 2020 2020 416c 7068 6120   time.    Alpha 
-00034dd0: 2866 6c6f 6174 293a 2053 6361 6c61 7220  (float): Scalar 
-00034de0: 7265 7072 6573 656e 7469 6e67 2066 6c69  representing fli
-00034df0: 7020 616e 676c 650a 2020 2020 7720 2866  p angle.    w (f
-00034e00: 6c6f 6174 293a 2053 6361 6c61 720a 2020  loat): Scalar.  
-00034e10: 2020 5461 7520 2866 6c6f 6174 293a 2053    Tau (float): S
-00034e20: 6361 6c61 720a 0a20 2020 2052 6574 7572  calar..    Retur
-00034e30: 6e73 3a0a 2020 2020 6e70 2e6e 6461 7272  ns:.    np.ndarr
-00034e40: 6179 3a20 4342 4620 7661 6c75 6573 2028  ay: CBF values (
-00034e50: 6d61 7472 6978 290a 2020 2020 2222 220a  matrix).    """.
-00034e60: 2020 2020 6362 6620 3d20 4d5f 3020 2a20      cbf = M_0 * 
-00034e70: 302e 300a 2020 2020 6d30 7468 7265 7368  0.0.    m0thresh
-00034e80: 203d 206e 702e 7175 616e 7469 6c65 2820   = np.quantile( 
-00034e90: 4d5f 305b 6d61 736b 3d3d 315d 2c20 302e  M_0[mask==1], 0.
-00034ea0: 3120 290a 2020 2020 7365 6c20 3d20 6d61  1 ).    sel = ma
-00034eb0: 736b 203d 3d20 3120 616e 6420 4d5f 3020  sk == 1 and M_0 
-00034ec0: 3e20 6d30 7468 7265 7368 0a20 2020 2063  > m0thresh.    c
-00034ed0: 6266 5b20 7365 6c20 5d20 3d20 4465 6c74  bf[ sel ] = Delt
-00034ee0: 615f 4d5b 2073 656c 205d 202a 2036 302e  a_M[ sel ] * 60.
-00034ef0: 202a 2031 3030 2e20 2a20 284c 616d 6264   * 100. * (Lambd
-00034f00: 6120 2a20 545f 3129 2f28 204d 5f30 5b73  a * T_1)/( M_0[s
-00034f10: 656c 5d20 2a20 322e 3020 2a20 416c 7068  el] * 2.0 * Alph
-00034f20: 6120 2a20 0a20 2020 2020 2020 2028 6e70  a * .        (np
-00034f30: 2e65 7870 2820 2d77 202a 2054 5f31 2920  .exp( -w * T_1) 
-00034f40: 2d20 6e70 2e65 7870 282d 2854 6175 202b  - np.exp(-(Tau +
-00034f50: 2077 2920 2a20 545f 3129 2929 0a20 2020   w) * T_1))).   
-00034f60: 2063 6266 5b20 6362 6620 3c20 302e 305d   cbf[ cbf < 0.0]
-00034f70: 3d30 2e30 0a20 2020 2072 6574 7572 6e20  =0.0.    return 
-00034f80: 6362 660a 0a64 6566 2064 6573 7069 6b65  cbf..def despike
-00034f90: 5f74 696d 655f 7365 7269 6573 5f61 666e  _time_series_afn
-00034fa0: 6928 696d 6167 652c 2063 313d 322e 352c  i(image, c1=2.5,
-00034fb0: 2063 323d 3429 3a0a 2020 2020 2222 220a   c2=4):.    """.
-00034fc0: 2020 2020 4465 7370 696b 6520 6120 7469      Despike a ti
-00034fd0: 6d65 2073 6572 6965 7320 696d 6167 6520  me series image 
-00034fe0: 7573 696e 6720 4c31 2070 6f6c 796e 6f6d  using L1 polynom
-00034ff0: 6961 6c20 6669 7474 696e 6720 616e 6420  ial fitting and 
-00035000: 6e6f 6e6c 696e 6561 7220 6669 6c74 6572  nonlinear filter
-00035010: 696e 672e 0a20 2020 2042 6173 6564 206f  ing..    Based o
-00035020: 6e20 6166 6e69 2033 6444 6573 7069 6b65  n afni 3dDespike
-00035030: 0a0a 2020 2020 3a70 6172 616d 2069 6d61  ..    :param ima
-00035040: 6765 3a20 414e 5473 5079 2069 6d61 6765  ge: ANTsPy image
-00035050: 206f 626a 6563 7420 636f 6e74 6169 6e69   object containi
-00035060: 6e67 2074 696d 6520 7365 7269 6573 2064  ng time series d
-00035070: 6174 612e 0a20 2020 203a 7061 7261 6d20  ata..    :param 
-00035080: 6331 3a20 5370 696b 6520 7468 7265 7368  c1: Spike thresh
-00035090: 6f6c 6420 7661 6c75 652e 2044 6566 6175  old value. Defau
-000350a0: 6c74 2069 7320 322e 352e 0a20 2020 203a  lt is 2.5..    :
-000350b0: 7061 7261 6d20 6332 3a20 5570 7065 7220  param c2: Upper 
-000350c0: 7261 6e67 6520 6f66 2061 6c6c 6f77 6564  range of allowed
-000350d0: 2064 6576 6961 7469 6f6e 2e20 4465 6661   deviation. Defa
-000350e0: 756c 7420 6973 2034 2e0a 2020 2020 3a72  ult is 4..    :r
-000350f0: 6574 7572 6e3a 2044 6573 7069 6b65 6420  eturn: Despiked 
-00035100: 414e 5473 5079 2069 6d61 6765 206f 626a  ANTsPy image obj
-00035110: 6563 742e 0a20 2020 2022 2222 0a20 2020  ect..    """.   
-00035120: 2064 6174 6120 3d20 696d 6167 652e 6e75   data = image.nu
-00035130: 6d70 7928 2920 2023 2043 6f6e 7665 7274  mpy()  # Convert
-00035140: 2074 6f20 6e75 6d70 7920 6172 7261 790a   to numpy array.
-00035150: 2020 2020 6465 7370 696b 6564 5f64 6174      despiked_dat
-00035160: 6120 3d20 6e70 2e63 6f70 7928 6461 7461  a = np.copy(data
-00035170: 2920 2023 2043 7265 6174 6520 6120 636f  )  # Create a co
-00035180: 7079 2066 6f72 2064 6573 7069 6b65 6420  py for despiked 
-00035190: 6461 7461 0a20 2020 2063 7572 7665 203d  data.    curve =
-000351a0: 2064 6573 7069 6b65 645f 6461 7461 202a   despiked_data *
-000351b0: 2030 2e30 0a0a 2020 2020 6465 6620 6c31   0.0..    def l1
-000351c0: 5f66 6974 5f70 6f6c 796e 6f6d 6961 6c28  _fit_polynomial(
-000351d0: 7469 6d65 5f73 6572 6965 732c 2064 6567  time_series, deg
-000351e0: 7265 653d 3229 3a0a 2020 2020 2020 2020  ree=2):.        
-000351f0: 2222 220a 2020 2020 2020 2020 4669 7420  """.        Fit 
-00035200: 6120 706f 6c79 6e6f 6d69 616c 206f 6620  a polynomial of 
-00035210: 6769 7665 6e20 6465 6772 6565 2074 6f20  given degree to 
-00035220: 7468 6520 7469 6d65 2073 6572 6965 7320  the time series 
-00035230: 7573 696e 6720 6c65 6173 7420 7371 7561  using least squa
-00035240: 7265 732e 0a20 2020 2020 2020 200a 2020  res..        .  
-00035250: 2020 2020 2020 3a70 6172 616d 2074 696d        :param tim
-00035260: 655f 7365 7269 6573 3a20 3144 206e 756d  e_series: 1D num
-00035270: 7079 2061 7272 6179 206f 6620 766f 7865  py array of voxe
-00035280: 6c20 7469 6d65 2073 6572 6965 7320 6461  l time series da
-00035290: 7461 2e0a 2020 2020 2020 2020 3a70 6172  ta..        :par
-000352a0: 616d 2064 6567 7265 653a 2044 6567 7265  am degree: Degre
-000352b0: 6520 6f66 2074 6865 2070 6f6c 796e 6f6d  e of the polynom
-000352c0: 6961 6c20 746f 2066 6974 2e0a 2020 2020  ial to fit..    
-000352d0: 2020 2020 3a72 6574 7572 6e3a 2046 6974      :return: Fit
-000352e0: 7465 6420 706f 6c79 6e6f 6d69 616c 2076  ted polynomial v
-000352f0: 616c 7565 7320 666f 7220 7468 6520 7469  alues for the ti
-00035300: 6d65 2073 6572 6965 732e 0a20 2020 2020  me series..     
-00035310: 2020 2022 2222 0a20 2020 2020 2020 2074     """.        t
-00035320: 203d 206e 702e 6172 616e 6765 286c 656e   = np.arange(len
-00035330: 2874 696d 655f 7365 7269 6573 2929 0a20  (time_series)). 
-00035340: 2020 2020 2020 2063 6f65 6673 203d 206e         coefs = n
-00035350: 702e 706f 6c79 6669 7428 742c 2074 696d  p.polyfit(t, tim
-00035360: 655f 7365 7269 6573 2c20 6465 6772 6565  e_series, degree
-00035370: 290a 2020 2020 2020 2020 706f 6c79 6e6f  ).        polyno
-00035380: 6d69 616c 203d 206e 702e 706f 6c79 7661  mial = np.polyva
-00035390: 6c28 636f 6566 732c 2074 290a 2020 2020  l(coefs, t).    
-000353a0: 2020 2020 7265 7475 726e 2070 6f6c 796e      return polyn
-000353b0: 6f6d 6961 6c0a 0a20 2020 2023 204c 3120  omial..    # L1 
-000353c0: 6669 7420 6120 736d 6f6f 7468 2d69 7368  fit a smooth-ish
-000353d0: 2063 7572 7665 2074 6f20 6561 6368 2076   curve to each v
-000353e0: 6f78 656c 2074 696d 6520 7365 7269 6573  oxel time series
-000353f0: 0a20 2020 2023 2043 7572 7665 2066 6974  .    # Curve fit
-00035400: 7469 6e67 2066 6f72 2065 6163 6820 766f  ting for each vo
-00035410: 7865 6c0a 2020 2020 666f 7220 7820 696e  xel.    for x in
-00035420: 2072 616e 6765 2864 6174 612e 7368 6170   range(data.shap
-00035430: 655b 305d 293a 0a20 2020 2020 2020 2066  e[0]):.        f
-00035440: 6f72 2079 2069 6e20 7261 6e67 6528 6461  or y in range(da
-00035450: 7461 2e73 6861 7065 5b31 5d29 3a0a 2020  ta.shape[1]):.  
-00035460: 2020 2020 2020 2020 2020 666f 7220 7a20            for z 
-00035470: 696e 2072 616e 6765 2864 6174 612e 7368  in range(data.sh
-00035480: 6170 655b 325d 293a 0a20 2020 2020 2020  ape[2]):.       
-00035490: 2020 2020 2020 2020 2076 6f78 656c 5f74           voxel_t
-000354a0: 696d 655f 7365 7269 6573 203d 2064 6174  ime_series = dat
-000354b0: 615b 782c 2079 2c20 7a2c 203a 5d0a 2020  a[x, y, z, :].  
-000354c0: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-000354d0: 7276 655b 782c 2079 2c20 7a2c 203a 5d20  rve[x, y, z, :] 
-000354e0: 3d20 6c31 5f66 6974 5f70 6f6c 796e 6f6d  = l1_fit_polynom
-000354f0: 6961 6c28 766f 7865 6c5f 7469 6d65 5f73  ial(voxel_time_s
-00035500: 6572 6965 732c 2064 6567 7265 653d 3229  eries, degree=2)
-00035510: 0a0a 2020 2020 2320 436f 6d70 7574 6520  ..    # Compute 
-00035520: 7468 6520 4d41 4420 6f66 2074 6865 2072  the MAD of the r
-00035530: 6573 6964 7561 6c73 0a20 2020 2072 6573  esiduals.    res
-00035540: 6964 7561 6c73 203d 2064 6174 6120 2d20  iduals = data - 
-00035550: 6375 7276 650a 2020 2020 6d61 6420 3d20  curve.    mad = 
-00035560: 6e70 2e6d 6564 6961 6e28 6e70 2e61 6273  np.median(np.abs
-00035570: 2872 6573 6964 7561 6c73 202d 206e 702e  (residuals - np.
-00035580: 6d65 6469 616e 2872 6573 6964 7561 6c73  median(residuals
-00035590: 2c20 6178 6973 3d2d 312c 206b 6565 7064  , axis=-1, keepd
-000355a0: 696d 733d 5472 7565 2929 2c20 6178 6973  ims=True)), axis
-000355b0: 3d2d 312c 206b 6565 7064 696d 733d 5472  =-1, keepdims=Tr
-000355c0: 7565 290a 2020 2020 7369 676d 6120 3d20  ue).    sigma = 
-000355d0: 6e70 2e73 7172 7428 6e70 2e70 6920 2f20  np.sqrt(np.pi / 
-000355e0: 3229 202a 206d 6164 0a20 2020 2023 2045  2) * mad.    # E
-000355f0: 6e73 7572 6520 7369 676d 6120 6973 206e  nsure sigma is n
-00035600: 6f74 207a 6572 6f20 746f 2061 766f 6964  ot zero to avoid
-00035610: 2064 6976 6973 696f 6e20 6279 207a 6572   division by zer
-00035620: 6f0a 2020 2020 7369 676d 615f 7361 6665  o.    sigma_safe
-00035630: 203d 206e 702e 7768 6572 6528 7369 676d   = np.where(sigm
-00035640: 6120 3d3d 2030 2c20 3165 2d31 302c 2073  a == 0, 1e-10, s
-00035650: 6967 6d61 290a 0a20 2020 2023 204f 7074  igma)..    # Opt
-00035660: 696f 6e61 6c6c 792c 2068 616e 646c 6520  ionally, handle 
-00035670: 4e61 4e20 6f72 2069 6e66 2076 616c 7565  NaN or inf value
-00035680: 7320 696e 2064 6174 612c 2063 7572 7665  s in data, curve
-00035690: 2c20 6f72 2073 6967 6d61 0a20 2020 2064  , or sigma.    d
-000356a0: 6174 6120 3d20 6e70 2e6e 616e 5f74 6f5f  ata = np.nan_to_
-000356b0: 6e75 6d28 6461 7461 2c20 6e61 6e3d 302e  num(data, nan=0.
-000356c0: 302c 2070 6f73 696e 663d 6e70 2e66 696e  0, posinf=np.fin
-000356d0: 666f 286e 702e 666c 6f61 7436 3429 2e6d  fo(np.float64).m
-000356e0: 6178 2c20 6e65 6769 6e66 3d6e 702e 6669  ax, neginf=np.fi
-000356f0: 6e66 6f28 6e70 2e66 6c6f 6174 3634 292e  nfo(np.float64).
-00035700: 6d69 6e29 0a20 2020 2063 7572 7665 203d  min).    curve =
-00035710: 206e 702e 6e61 6e5f 746f 5f6e 756d 2863   np.nan_to_num(c
-00035720: 7572 7665 2c20 6e61 6e3d 302e 302c 2070  urve, nan=0.0, p
-00035730: 6f73 696e 663d 6e70 2e66 696e 666f 286e  osinf=np.finfo(n
-00035740: 702e 666c 6f61 7436 3429 2e6d 6178 2c20  p.float64).max, 
-00035750: 6e65 6769 6e66 3d6e 702e 6669 6e66 6f28  neginf=np.finfo(
-00035760: 6e70 2e66 6c6f 6174 3634 292e 6d69 6e29  np.float64).min)
-00035770: 0a20 2020 2073 6967 6d61 5f73 6166 6520  .    sigma_safe 
-00035780: 3d20 6e70 2e6e 616e 5f74 6f5f 6e75 6d28  = np.nan_to_num(
-00035790: 7369 676d 615f 7361 6665 2c20 6e61 6e3d  sigma_safe, nan=
-000357a0: 3165 2d31 302c 2070 6f73 696e 663d 6e70  1e-10, posinf=np
-000357b0: 2e66 696e 666f 286e 702e 666c 6f61 7436  .finfo(np.float6
-000357c0: 3429 2e6d 6178 2c20 6e65 6769 6e66 3d6e  4).max, neginf=n
-000357d0: 702e 6669 6e66 6f28 6e70 2e66 6c6f 6174  p.finfo(np.float
-000357e0: 3634 292e 6d69 6e29 0a0a 2020 2020 2320  64).min)..    # 
-000357f0: 4465 7370 696b 6520 616c 676f 7269 7468  Despike algorith
-00035800: 6d0a 2020 2020 7370 696b 655f 636f 756e  m.    spike_coun
-00035810: 7473 203d 206e 702e 7a65 726f 7328 2069  ts = np.zeros( i
-00035820: 6d61 6765 2e73 6861 7065 5b33 5d20 290a  mage.shape[3] ).
-00035830: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-00035840: 6765 2864 6174 612e 7368 6170 655b 2d31  ge(data.shape[-1
-00035850: 5d29 3a0a 2020 2020 2020 2020 7320 3d20  ]):.        s = 
-00035860: 2864 6174 615b 2e2e 2e2c 2069 5d20 2d20  (data[..., i] - 
-00035870: 6375 7276 655b 2e2e 2e2c 2069 5d29 202f  curve[..., i]) /
-00035880: 2073 6967 6d61 5f73 6166 655b 2e2e 2e2c   sigma_safe[...,
-00035890: 2030 5d0a 2020 2020 2020 2020 7777 203d   0].        ww =
-000358a0: 2073 203e 2063 310a 2020 2020 2020 2020   s > c1.        
-000358b0: 735f 7072 696d 6520 3d20 6e70 2e77 6865  s_prime = np.whe
-000358c0: 7265 2820 7777 2c20 6331 202b 2028 6332  re( ww, c1 + (c2
-000358d0: 202d 2063 3129 202a 206e 702e 7461 6e68   - c1) * np.tanh
-000358e0: 2828 7320 2d20 6331 2920 2f20 2863 3220  ((s - c1) / (c2 
-000358f0: 2d20 6331 2929 2c20 7329 0a20 2020 2020  - c1)), s).     
-00035900: 2020 2073 7069 6b65 5f63 6f75 6e74 735b     spike_counts[
-00035910: 695d 203d 2077 772e 7375 6d28 290a 2020  i] = ww.sum().  
-00035920: 2020 2020 2020 6465 7370 696b 6564 5f64        despiked_d
-00035930: 6174 615b 2e2e 2e2c 2069 5d20 3d20 6375  ata[..., i] = cu
-00035940: 7276 655b 2e2e 2e2c 2069 5d20 2b20 735f  rve[..., i] + s_
-00035950: 7072 696d 6520 2a20 7369 676d 615b 2e2e  prime * sigma[..
-00035960: 2e2c 2030 5d0a 0a20 2020 2023 2043 6f6e  ., 0]..    # Con
-00035970: 7665 7274 2062 6163 6b20 746f 2041 4e54  vert back to ANT
-00035980: 7350 7920 696d 6167 650a 2020 2020 6465  sPy image.    de
-00035990: 7370 696b 6564 5f69 6d61 6765 203d 2061  spiked_image = a
-000359a0: 6e74 732e 6672 6f6d 5f6e 756d 7079 2864  nts.from_numpy(d
-000359b0: 6573 7069 6b65 645f 6461 7461 290a 2020  espiked_data).  
-000359c0: 2020 7265 7475 726e 2061 6e74 732e 636f    return ants.co
-000359d0: 7079 5f69 6d61 6765 5f69 6e66 6f28 2069  py_image_info( i
-000359e0: 6d61 6765 2c20 6465 7370 696b 6564 5f69  mage, despiked_i
-000359f0: 6d61 6765 2029 2c20 7370 696b 655f 636f  mage ), spike_co
-00035a00: 756e 7473 0a0a 6465 6620 6465 7370 696b  unts..def despik
-00035a10: 655f 7469 6d65 5f73 6572 6965 7328 696d  e_time_series(im
-00035a20: 6167 652c 2074 6872 6573 686f 6c64 3d33  age, threshold=3
-00035a30: 2e30 2c20 7265 706c 6163 656d 656e 743d  .0, replacement=
-00035a40: 2774 6872 6573 686f 6c64 2720 293a 0a20  'threshold' ):. 
-00035a50: 2020 2022 2222 0a20 2020 2044 6573 7069     """.    Despi
-00035a60: 6b65 2061 2074 696d 6520 7365 7269 6573  ke a time series
-00035a70: 2069 6d61 6765 2e0a 2020 2020 0a20 2020   image..    .   
-00035a80: 203a 7061 7261 6d20 696d 6167 653a 2041   :param image: A
-00035a90: 4e54 7350 7920 696d 6167 6520 6f62 6a65  NTsPy image obje
-00035aa0: 6374 2063 6f6e 7461 696e 696e 6720 7469  ct containing ti
-00035ab0: 6d65 2073 6572 6965 7320 6461 7461 2e0a  me series data..
-00035ac0: 2020 2020 3a70 6172 616d 2074 6872 6573      :param thres
-00035ad0: 686f 6c64 3a20 7a2d 7363 6f72 6520 7661  hold: z-score va
-00035ae0: 6c75 6520 746f 2069 6465 6e74 6966 7920  lue to identify 
-00035af0: 7370 696b 6573 2e20 4465 6661 756c 7420  spikes. Default 
-00035b00: 6973 2033 2e0a 2020 2020 3a70 6172 616d  is 3..    :param
-00035b10: 2072 6570 6c61 6365 6d65 6e74 3a20 6d65   replacement: me
-00035b20: 6469 616e 206f 7220 7468 7265 7368 6f6c  dian or threshol
-00035b30: 6420 2d20 7468 6520 6c61 7474 6572 2069  d - the latter i
-00035b40: 7320 7369 6d69 6c61 7220 3344 4465 7370  s similar 3DDesp
-00035b50: 696b 6520 6275 7420 7369 6d70 6c65 720a  ike but simpler.
-00035b60: 2020 2020 3a72 6574 7572 6e3a 2044 6573      :return: Des
-00035b70: 7069 6b65 6420 414e 5473 5079 2069 6d61  piked ANTsPy ima
-00035b80: 6765 206f 626a 6563 742e 0a20 2020 2022  ge object..    "
-00035b90: 2222 0a20 2020 2023 2043 6f6e 7665 7274  "".    # Convert
-00035ba0: 2069 6d61 6765 2074 6f20 6e75 6d70 7920   image to numpy 
-00035bb0: 6172 7261 790a 2020 2020 6461 7461 203d  array.    data =
-00035bc0: 2069 6d61 6765 2e6e 756d 7079 2829 0a20   image.numpy(). 
-00035bd0: 2020 200a 2020 2020 2320 4361 6c63 756c     .    # Calcul
-00035be0: 6174 6520 7468 6520 6d65 616e 2061 6e64  ate the mean and
-00035bf0: 2073 7461 6e64 6172 6420 6465 7669 6174   standard deviat
-00035c00: 696f 6e20 616c 6f6e 6720 7468 6520 7469  ion along the ti
-00035c10: 6d65 2061 7869 730a 2020 2020 6d65 616e  me axis.    mean
-00035c20: 203d 206e 702e 6d65 616e 2864 6174 612c   = np.mean(data,
-00035c30: 2061 7869 733d 2d31 290a 2020 2020 7374   axis=-1).    st
-00035c40: 6420 3d20 6e70 2e73 7464 2864 6174 612c  d = np.std(data,
-00035c50: 2061 7869 733d 2d31 290a 0a20 2020 2023   axis=-1)..    #
-00035c60: 2049 6465 6e74 6966 7920 7370 696b 6573   Identify spikes
-00035c70: 3a20 706f 696e 7473 2077 6865 7265 2074  : points where t
-00035c80: 6865 2064 6576 6961 7469 6f6e 2066 726f  he deviation fro
-00035c90: 6d20 7468 6520 6d65 616e 2065 7863 6565  m the mean excee
-00035ca0: 6473 2074 6865 2074 6872 6573 686f 6c64  ds the threshold
-00035cb0: 0a20 2020 2073 7069 6b65 7320 3d20 6e70  .    spikes = np
-00035cc0: 2e61 6273 2864 6174 6120 2d20 6d65 616e  .abs(data - mean
-00035cd0: 5b2e 2e2e 2c20 6e70 2e6e 6577 6178 6973  [..., np.newaxis
-00035ce0: 5d29 203e 2074 6872 6573 686f 6c64 202a  ]) > threshold *
-00035cf0: 2073 7464 5b2e 2e2e 2c20 6e70 2e6e 6577   std[..., np.new
-00035d00: 6178 6973 5d0a 0a20 2020 2023 2052 6570  axis]..    # Rep
-00035d10: 6c61 6365 2073 7069 6b65 2076 616c 7565  lace spike value
-00035d20: 730a 2020 2020 7370 696b 655f 636f 756e  s.    spike_coun
-00035d30: 7473 203d 206e 702e 7a65 726f 7328 2069  ts = np.zeros( i
-00035d40: 6d61 6765 2e73 6861 7065 5b33 5d20 290a  mage.shape[3] ).
-00035d50: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-00035d60: 6765 2864 6174 612e 7368 6170 655b 2d31  ge(data.shape[-1
-00035d70: 5d29 3a0a 2020 2020 2020 2020 736c 6963  ]):.        slic
-00035d80: 6520 3d20 6461 7461 5b2e 2e2e 2c20 695d  e = data[..., i]
-00035d90: 0a20 2020 2020 2020 2073 7069 6b65 5f6c  .        spike_l
-00035da0: 6f63 6174 696f 6e73 203d 2073 7069 6b65  ocations = spike
-00035db0: 735b 2e2e 2e2c 2069 5d0a 2020 2020 2020  s[..., i].      
-00035dc0: 2020 7370 696b 655f 636f 756e 7473 5b69    spike_counts[i
-00035dd0: 5d20 3d20 7370 696b 655f 6c6f 6361 7469  ] = spike_locati
-00035de0: 6f6e 732e 7375 6d28 290a 2020 2020 2020  ons.sum().      
-00035df0: 2020 6966 2072 6570 6c61 6365 6d65 6e74    if replacement
-00035e00: 203d 3d20 276d 6564 6961 6e27 3a0a 2020   == 'median':.  
-00035e10: 2020 2020 2020 2020 2020 736c 6963 655b            slice[
-00035e20: 7370 696b 655f 6c6f 6361 7469 6f6e 735d  spike_locations]
-00035e30: 203d 206e 702e 6d65 6469 616e 2873 6c69   = np.median(sli
-00035e40: 6365 2920 2023 2052 6570 6c61 6365 2077  ce)  # Replace w
-00035e50: 6974 6820 6d65 6469 616e 206f 7220 616e  ith median or an
-00035e60: 6f74 6865 7220 6d65 7468 6f64 0a20 2020  other method.   
-00035e70: 2020 2020 2065 6c73 653a 0a09 2020 2020       else:..    
-00035e80: 2320 4361 6c63 756c 6174 6520 7468 7265  # Calculate thre
-00035e90: 7368 6f6c 6420 7661 6c75 6573 2028 6d65  shold values (me
-00035ea0: 616e 20c2 b120 7468 7265 7368 6f6c 6420  an .. threshold 
-00035eb0: 2a20 7374 6429 0a20 2020 2020 2020 2020  * std).         
-00035ec0: 2020 2074 6872 6573 686f 6c64 5f76 616c     threshold_val
-00035ed0: 7565 7320 3d20 6d65 616e 202b 206e 702e  ues = mean + np.
-00035ee0: 7369 676e 2873 6c69 6365 202d 206d 6561  sign(slice - mea
-00035ef0: 6e29 202a 2074 6872 6573 686f 6c64 202a  n) * threshold *
-00035f00: 2073 7464 0a20 2020 2020 2020 2020 2020   std.           
-00035f10: 2073 6c69 6365 5b73 7069 6b65 5f6c 6f63   slice[spike_loc
-00035f20: 6174 696f 6e73 5d20 3d20 7468 7265 7368  ations] = thresh
-00035f30: 6f6c 645f 7661 6c75 6573 5b73 7069 6b65  old_values[spike
-00035f40: 5f6c 6f63 6174 696f 6e73 5d0a 2020 2020  _locations].    
-00035f50: 2020 2020 6461 7461 5b2e 2e2e 2c20 695d      data[..., i]
-00035f60: 203d 2073 6c69 6365 0a20 2020 2023 2043   = slice.    # C
-00035f70: 6f6e 7665 7274 2062 6163 6b20 746f 2041  onvert back to A
-00035f80: 4e54 7350 7920 696d 6167 650a 2020 2020  NTsPy image.    
-00035f90: 6465 7370 696b 655f 696d 6167 6520 3d20  despike_image = 
-00035fa0: 616e 7473 2e66 726f 6d5f 6e75 6d70 7928  ants.from_numpy(
-00035fb0: 6461 7461 290a 2020 2020 6465 7370 696b  data).    despik
-00035fc0: 655f 696d 6167 6520 3d20 616e 7473 2e63  e_image = ants.c
-00035fd0: 6f70 795f 696d 6167 655f 696e 666f 2820  opy_image_info( 
-00035fe0: 696d 6167 652c 2064 6573 7069 6b65 5f69  image, despike_i
-00035ff0: 6d61 6765 2029 0a20 2020 2072 6574 7572  mage ).    retur
-00036000: 6e20 6465 7370 696b 655f 696d 6167 652c  n despike_image,
-00036010: 2073 7069 6b65 5f63 6f75 6e74 730a 0a0a   spike_counts...
-00036020: 0a64 6566 2062 6f6c 645f 7065 7266 7573  .def bold_perfus
-00036030: 696f 6e5f 6d69 6e69 6d61 6c28 200a 2020  ion_minimal( .  
-00036040: 2020 2020 2020 666d 7269 2c20 0a20 2020        fmri, .   
-00036050: 2020 2020 206d 305f 696d 6167 6520 3d20       m0_image = 
-00036060: 4e6f 6e65 2c0a 2020 2020 2020 2020 7370  None,.        sp
-00036070: 6120 3d20 2830 2e2c 2030 2e2c 2030 2e2c  a = (0., 0., 0.,
-00036080: 2030 2e29 2c0a 2020 2020 2020 2020 6e63   0.),.        nc
-00036090: 2020 3d20 302c 0a20 2020 2020 2020 2074    = 0,.        t
-000360a0: 633d 2761 6c74 6572 6e61 7469 6e67 272c  c='alternating',
-000360b0: 0a20 2020 2020 2020 206e 5f74 6f5f 7472  .        n_to_tr
-000360c0: 696d 3d30 2c0a 2020 2020 2020 2020 6f75  im=0,.        ou
-000360d0: 746c 6965 725f 7468 7265 7368 6f6c 643d  tlier_threshold=
-000360e0: 302e 3235 302c 0a20 2020 2020 2020 2070  0.250,.        p
-000360f0: 6c6f 745f 6272 6169 6e5f 6d61 736b 3d46  lot_brain_mask=F
-00036100: 616c 7365 2c0a 2020 2020 2020 2020 7665  alse,.        ve
-00036110: 7262 6f73 653d 4661 6c73 6520 293a 0a20  rbose=False ):. 
-00036120: 2022 2222 0a20 2045 7374 696d 6174 6520   """.  Estimate 
-00036130: 7065 7266 7573 696f 6e20 6672 6f6d 2061  perfusion from a
-00036140: 2042 4f4c 4420 7469 6d65 2073 6572 6965   BOLD time serie
-00036150: 7320 696d 6167 652e 2020 5769 6c6c 2061  s image.  Will a
-00036160: 7474 656d 7074 2074 6f20 6669 6775 7265  ttempt to figure
-00036170: 206f 7574 2074 6865 2054 2d43 206c 6162   out the T-C lab
-00036180: 656c 7320 6672 6f6d 2074 6865 2064 6174  els from the dat
-00036190: 612e 2020 5468 6520 6675 6e63 7469 6f6e  a.  The function
-000361a0: 2075 7365 7320 6465 6661 756c 7473 2074   uses defaults t
-000361b0: 6f20 7175 616e 7469 6679 2043 4246 2062  o quantify CBF b
-000361c0: 7574 2074 6865 7365 2077 696c 6c20 7573  ut these will us
-000361d0: 7561 6c6c 7920 6e6f 7420 6265 2063 6f72  ually not be cor
-000361e0: 7265 6374 2066 6f72 2079 6f75 7220 6f77  rect for your ow
-000361f0: 6e20 6461 7461 2e20 2053 6565 2074 6865  n data.  See the
-00036200: 2066 756e 6374 696f 6e20 6361 6c63 756c   function calcul
-00036210: 6174 655f 4342 4620 666f 7220 616e 2065  ate_CBF for an e
-00036220: 7861 6d70 6c65 206f 6620 686f 7720 6f6e  xample of how on
-00036230: 6520 6d69 6768 7420 646f 2071 7561 6e74  e might do quant
-00036240: 6966 6963 6174 696f 6e20 6261 7365 6420  ification based 
-00036250: 6f6e 2074 6865 206f 7574 7075 7473 206f  on the outputs o
-00036260: 6620 7468 6973 2066 756e 6374 696f 6e20  f this function 
-00036270: 7370 6563 6966 6963 616c 6c79 2074 6865  specifically the
-00036280: 2070 6572 6675 7369 6f6e 2c20 6d30 2061   perfusion, m0 a
-00036290: 6e64 206d 6173 6b20 696d 6167 6573 2074  nd mask images t
-000362a0: 6861 7420 6172 6520 7061 7274 206f 6620  hat are part of 
-000362b0: 7468 6520 6f75 7470 7574 2064 6963 7469  the output dicti
-000362c0: 6f6e 6172 792e 0a0a 2020 5468 6973 2066  onary...  This f
-000362d0: 756e 6374 696f 6e20 6973 2069 6e74 656e  unction is inten
-000362e0: 6465 6420 666f 7220 7573 6520 696e 2064  ded for use in d
-000362f0: 6562 7567 6769 6e67 2f74 6573 7469 6e67  ebugging/testing
-00036300: 206f 7220 7768 656e 206f 6e65 206c 6163   or when one lac
-00036310: 6b73 2061 2054 3177 2069 6d61 6765 2e0a  ks a T1w image..
-00036320: 0a20 2041 7267 756d 656e 7473 0a20 202d  .  Arguments.  -
-00036330: 2d2d 2d2d 2d2d 2d2d 0a0a 2020 666d 7269  --------..  fmri
-00036340: 203a 2042 4f4c 4420 666d 7269 2061 6e74   : BOLD fmri ant
-00036350: 7349 6d61 6765 0a0a 2020 6d30 5f69 6d61  sImage..  m0_ima
-00036360: 6765 3a20 6120 7072 652d 6465 6669 6e65  ge: a pre-define
-00036370: 6420 6d30 2061 6e74 7349 6d61 6765 0a0a  d m0 antsImage..
-00036380: 2020 7370 6120 3a20 6761 7573 7369 616e    spa : gaussian
-00036390: 2073 6d6f 6f74 6869 6e67 2066 6f72 2073   smoothing for s
-000363a0: 7061 7469 616c 2061 6e64 2074 656d 706f  patial and tempo
-000363b0: 7261 6c20 636f 6d70 6f6e 656e 7420 652e  ral component e.
-000363c0: 672e 2028 312c 312c 312c 3029 2069 6e20  g. (1,1,1,0) in 
-000363d0: 7068 7973 6963 616c 2073 7061 6365 2063  physical space c
-000363e0: 6f6f 7264 696e 6174 6573 0a0a 2020 6e63  oordinates..  nc
-000363f0: 2020 3a20 6e75 6d62 6572 206f 6620 636f    : number of co
-00036400: 6d70 6f6e 656e 7473 2066 6f72 2063 6f6d  mponents for com
-00036410: 7063 6f72 2066 696c 7465 7269 6e67 0a0a  pcor filtering..
-00036420: 2020 7463 3a20 7374 7269 6e67 2065 6974    tc: string eit
-00036430: 6865 7220 616c 7465 726e 6174 696e 6720  her alternating 
-00036440: 6f72 2073 706c 6974 2028 6465 6661 756c  or split (defaul
-00036450: 7420 6973 2061 6c74 6572 6e61 7469 6e67  t is alternating
-00036460: 2069 6520 4354 4354 4354 3b20 7370 6c69   ie CTCTCT; spli
-00036470: 7420 6973 2043 4343 4354 5454 5429 0a0a  t is CCCCTTTT)..
-00036480: 2020 6e5f 746f 5f74 7269 6d3a 206e 756d    n_to_trim: num
-00036490: 6265 7220 6f66 2076 6f6c 756d 6573 2074  ber of volumes t
-000364a0: 6f20 7472 696d 206f 6666 2074 6865 2066  o trim off the f
-000364b0: 726f 6e74 206f 6620 7468 6520 7469 6d65  ront of the time
-000364c0: 2073 6572 6965 7320 746f 2061 6363 6f75   series to accou
-000364d0: 6e74 2066 6f72 2069 6e69 7469 616c 206d  nt for initial m
-000364e0: 6167 6e65 7469 6320 7361 7475 7261 7469  agnetic saturati
-000364f0: 6f6e 2065 6666 6563 7473 206f 7220 746f  on effects or to
-00036500: 2061 6c6c 6f77 2074 6865 2073 6967 6e61   allow the signa
-00036510: 6c20 746f 2072 6561 6368 2061 2073 7465  l to reach a ste
-00036520: 6164 7920 7374 6174 652e 2069 6e20 736f  ady state. in so
-00036530: 6d65 2063 6173 6573 2c20 7472 6169 6c69  me cases, traili
-00036540: 6e67 2076 6f6c 756d 6573 206f 7220 6f74  ng volumes or ot
-00036550: 6865 7220 6f75 746c 6965 7220 766f 6c75  her outlier volu
-00036560: 6d65 7320 6d61 7920 6e65 6564 2074 6f20  mes may need to 
-00036570: 6265 2072 656a 6563 7465 642e 2020 7468  be rejected.  th
-00036580: 6973 2063 6f64 6520 646f 6573 206e 6f74  is code does not
-00036590: 2063 7572 7265 6e74 6c79 2068 616e 646c   currently handl
-000365a0: 6520 7468 6174 2069 7373 7565 2e0a 0a20  e that issue... 
-000365b0: 206f 7574 6c69 6572 5f74 6872 6573 686f   outlier_thresho
-000365c0: 6c64 2028 6e75 6d65 7269 6329 3a20 6265  ld (numeric): be
-000365d0: 7477 6565 6e20 7a65 726f 2028 7265 6d6f  tween zero (remo
-000365e0: 7665 2061 6c6c 2920 616e 6420 6f6e 6520  ve all) and one 
-000365f0: 2872 656d 6f76 6520 6e6f 6e65 293b 2061  (remove none); a
-00036600: 7574 6f6d 6174 6963 616c 6c79 2063 616c  utomatically cal
-00036610: 6375 6c61 7465 7320 6f75 746c 6965 726e  culates outliern
-00036620: 6573 7320 616e 6420 7573 6573 2069 7420  ess and uses it 
-00036630: 746f 2063 656e 736f 7220 7468 6520 7469  to censor the ti
-00036640: 6d65 2073 6572 6965 732e 0a0a 2020 706c  me series...  pl
-00036650: 6f74 5f62 7261 696e 5f6d 6173 6b20 3a20  ot_brain_mask : 
-00036660: 626f 6f6c 6561 6e20 6361 6e20 6865 6c70  boolean can help
-00036670: 2077 6974 6820 6368 6563 6b69 6e67 2064   with checking d
-00036680: 6174 6120 7175 616c 6974 7920 7669 7375  ata quality visu
-00036690: 616c 6c79 0a0a 2020 7665 7262 6f73 6520  ally..  verbose 
-000366a0: 3a20 626f 6f6c 6561 6e0a 0a20 2052 6574  : boolean..  Ret
-000366b0: 7572 6e73 0a20 202d 2d2d 2d2d 2d2d 2d2d  urns.  ---------
-000366c0: 0a20 2061 2064 6963 7469 6f6e 6172 7920  .  a dictionary 
-000366d0: 636f 6e74 6169 6e69 6e67 2074 6865 2064  containing the d
-000366e0: 6572 6976 6564 206e 6574 776f 726b 206d  erived network m
-000366f0: 6170 730a 0a20 2022 2222 0a20 2069 6d70  aps..  """.  imp
-00036700: 6f72 7420 6e75 6d70 7920 6173 206e 700a  ort numpy as np.
-00036710: 2020 696d 706f 7274 2070 616e 6461 7320    import pandas 
-00036720: 6173 2070 640a 2020 696d 706f 7274 2072  as pd.  import r
-00036730: 650a 2020 696d 706f 7274 206d 6174 680a  e.  import math.
-00036740: 2020 6672 6f6d 2073 6b6c 6561 726e 2e6c    from sklearn.l
-00036750: 696e 6561 725f 6d6f 6465 6c20 696d 706f  inear_model impo
-00036760: 7274 2052 414e 5341 4352 6567 7265 7373  rt RANSACRegress
-00036770: 6f72 2c20 5468 6569 6c53 656e 5265 6772  or, TheilSenRegr
-00036780: 6573 736f 722c 2048 7562 6572 5265 6772  essor, HuberRegr
-00036790: 6573 736f 722c 2051 7561 6e74 696c 6552  essor, QuantileR
-000367a0: 6567 7265 7373 6f72 2c20 4c69 6e65 6172  egressor, Linear
-000367b0: 5265 6772 6573 7369 6f6e 2c20 5347 4452  Regression, SGDR
-000367c0: 6567 7265 7373 6f72 0a20 2066 726f 6d20  egressor.  from 
-000367d0: 736b 6c65 6172 6e2e 6d75 6c74 696f 7574  sklearn.multiout
-000367e0: 7075 7420 696d 706f 7274 204d 756c 7469  put import Multi
-000367f0: 4f75 7470 7574 5265 6772 6573 736f 720a  OutputRegressor.
-00036800: 2020 6672 6f6d 2073 6b6c 6561 726e 2e70    from sklearn.p
-00036810: 7265 7072 6f63 6573 7369 6e67 2069 6d70  reprocessing imp
-00036820: 6f72 7420 5374 616e 6461 7264 5363 616c  ort StandardScal
-00036830: 6572 0a0a 2020 6465 6620 7265 706c 6963  er..  def replic
-00036840: 6174 655f 6c69 7374 2875 7365 725f 6c69  ate_list(user_li
-00036850: 7374 2c20 7461 7267 6574 5f73 697a 6529  st, target_size)
-00036860: 3a0a 2020 2020 2320 4361 6c63 756c 6174  :.    # Calculat
-00036870: 6520 7468 6520 6e75 6d62 6572 206f 6620  e the number of 
-00036880: 7469 6d65 7320 7468 6520 6c69 7374 2073  times the list s
-00036890: 686f 756c 6420 6265 2072 6570 6c69 6361  hould be replica
-000368a0: 7465 640a 2020 2020 7265 706c 6963 6174  ted.    replicat
-000368b0: 696f 6e5f 6661 6374 6f72 203d 2074 6172  ion_factor = tar
-000368c0: 6765 745f 7369 7a65 202f 2f20 6c65 6e28  get_size // len(
-000368d0: 7573 6572 5f6c 6973 7429 0a20 2020 2023  user_list).    #
-000368e0: 2052 6570 6c69 6361 7465 2074 6865 206c   Replicate the l
-000368f0: 6973 7420 616e 6420 6861 6e64 6c65 2061  ist and handle a
-00036900: 6e79 2072 656d 6169 6e69 6e67 2065 6c65  ny remaining ele
-00036910: 6d65 6e74 730a 2020 2020 7265 706c 6963  ments.    replic
-00036920: 6174 6564 5f6c 6973 7420 3d20 7573 6572  ated_list = user
-00036930: 5f6c 6973 7420 2a20 7265 706c 6963 6174  _list * replicat
-00036940: 696f 6e5f 6661 6374 6f72 0a20 2020 2072  ion_factor.    r
-00036950: 656d 6169 6e69 6e67 5f65 6c65 6d65 6e74  emaining_element
-00036960: 7320 3d20 7461 7267 6574 5f73 697a 6520  s = target_size 
-00036970: 2520 6c65 6e28 7573 6572 5f6c 6973 7429  % len(user_list)
-00036980: 0a20 2020 2072 6570 6c69 6361 7465 645f  .    replicated_
-00036990: 6c69 7374 202b 3d20 7573 6572 5f6c 6973  list += user_lis
-000369a0: 745b 3a72 656d 6169 6e69 6e67 5f65 6c65  t[:remaining_ele
-000369b0: 6d65 6e74 735d 0a20 2020 2072 6574 7572  ments].    retur
-000369c0: 6e20 7265 706c 6963 6174 6564 5f6c 6973  n replicated_lis
-000369d0: 740a 0a20 2064 6566 206f 6e65 5f68 6f74  t..  def one_hot
-000369e0: 5f65 6e63 6f64 6528 6368 6172 5f6c 6973  _encode(char_lis
-000369f0: 7429 3a0a 2020 2020 756e 6971 7565 5f63  t):.    unique_c
-00036a00: 6861 7273 203d 206c 6973 7428 7365 7428  hars = list(set(
-00036a10: 6368 6172 5f6c 6973 7429 290a 2020 2020  char_list)).    
-00036a20: 656e 636f 6469 6e67 5f64 6963 7420 3d20  encoding_dict = 
-00036a30: 7b63 6861 723a 205b 3120 6966 2063 6861  {char: [1 if cha
-00036a40: 7220 3d3d 2063 2065 6c73 6520 3020 666f  r == c else 0 fo
-00036a50: 7220 6320 696e 2075 6e69 7175 655f 6368  r c in unique_ch
-00036a60: 6172 735d 2066 6f72 2063 6861 7220 696e  ars] for char in
-00036a70: 2075 6e69 7175 655f 6368 6172 737d 0a20   unique_chars}. 
-00036a80: 2020 2065 6e63 6f64 6564 5f6d 6174 7269     encoded_matri
-00036a90: 7820 3d20 6e70 2e61 7272 6179 285b 656e  x = np.array([en
-00036aa0: 636f 6469 6e67 5f64 6963 745b 6368 6172  coding_dict[char
-00036ab0: 5d20 666f 7220 6368 6172 2069 6e20 6368  ] for char in ch
-00036ac0: 6172 5f6c 6973 745d 290a 2020 2020 7265  ar_list]).    re
-00036ad0: 7475 726e 2065 6e63 6f64 6564 5f6d 6174  turn encoded_mat
-00036ae0: 7269 780a 2020 0a20 2041 203d 206e 702e  rix.  .  A = np.
-00036af0: 7a65 726f 7328 2831 2c31 2929 0a20 2066  zeros((1,1)).  f
-00036b00: 6d72 695f 7465 6d70 6c61 7465 203d 2061  mri_template = a
-00036b10: 6e74 732e 6765 745f 6176 6572 6167 655f  nts.get_average_
-00036b20: 6f66 5f74 696d 6573 6572 6965 7328 2066  of_timeseries( f
-00036b30: 6d72 6920 290a 2020 6966 206e 5f74 6f5f  mri ).  if n_to_
-00036b40: 7472 696d 2069 7320 4e6f 6e65 3a0a 2020  trim is None:.  
-00036b50: 2020 6e5f 746f 5f74 7269 6d3d 300a 2020    n_to_trim=0.  
-00036b60: 6d79 7472 696d 3d6e 5f74 6f5f 7472 696d  mytrim=n_to_trim
-00036b70: 0a20 2070 6572 665f 746f 7461 6c5f 7369  .  perf_total_si
-00036b80: 676d 6120 3d20 312e 350a 2020 636f 7272  gma = 1.5.  corr
-00036b90: 6d6f 203d 2074 696d 6573 6572 6965 735f  mo = timeseries_
-00036ba0: 7265 6728 0a20 2020 2066 6d72 692c 2066  reg(.    fmri, f
-00036bb0: 6d72 695f 7465 6d70 6c61 7465 2c0a 2020  mri_template,.  
-00036bc0: 2020 7479 7065 5f6f 665f 7472 616e 7366    type_of_transf
-00036bd0: 6f72 6d3d 2752 6967 6964 272c 0a20 2020  orm='Rigid',.   
-00036be0: 2074 6f74 616c 5f73 6967 6d61 3d70 6572   total_sigma=per
-00036bf0: 665f 746f 7461 6c5f 7369 676d 612c 0a20  f_total_sigma,. 
-00036c00: 2020 2066 644f 6666 7365 743d 322e 302c     fdOffset=2.0,
-00036c10: 0a20 2020 2074 7269 6d20 3d20 6d79 7472  .    trim = mytr
-00036c20: 696d 2c0a 2020 2020 6f75 7470 7574 5f64  im,.    output_d
-00036c30: 6972 6563 746f 7279 3d4e 6f6e 652c 0a20  irectory=None,. 
-00036c40: 2020 2076 6572 626f 7365 3d76 6572 626f     verbose=verbo
-00036c50: 7365 2c0a 2020 2020 7379 6e5f 6d65 7472  se,.    syn_metr
-00036c60: 6963 3d27 6363 272c 0a20 2020 2073 796e  ic='cc',.    syn
-00036c70: 5f73 616d 706c 696e 673d 322c 0a20 2020  _sampling=2,.   
-00036c80: 2072 6567 5f69 7465 7261 7469 6f6e 733d   reg_iterations=
-00036c90: 5b34 302c 3230 2c35 5d20 290a 2020 6966  [40,20,5] ).  if
-00036ca0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-00036cb0: 7072 696e 7428 2245 6e64 2072 7366 6d72  print("End rsfmr
-00036cc0: 6920 6d6f 7469 6f6e 2063 6f72 7265 6374  i motion correct
-00036cd0: 696f 6e22 290a 0a20 2069 6620 6d30 5f69  ion")..  if m0_i
-00036ce0: 6d61 6765 2069 7320 6e6f 7420 4e6f 6e65  mage is not None
-00036cf0: 3a0a 2020 2020 2020 6d30 203d 206d 305f  :.      m0 = m0_
-00036d00: 696d 6167 650a 0a20 206e 7470 203d 2063  image..  ntp = c
-00036d10: 6f72 726d 6f5b 276d 6f74 696f 6e5f 636f  orrmo['motion_co
-00036d20: 7272 6563 7465 6427 5d2e 7368 6170 655b  rrected'].shape[
-00036d30: 335d 0a20 2066 6d72 695f 7465 6d70 6c61  3].  fmri_templa
-00036d40: 7465 203d 2061 6e74 732e 6765 745f 6176  te = ants.get_av
-00036d50: 6572 6167 655f 6f66 5f74 696d 6573 6572  erage_of_timeser
-00036d60: 6965 7328 2063 6f72 726d 6f5b 276d 6f74  ies( corrmo['mot
-00036d70: 696f 6e5f 636f 7272 6563 7465 6427 5d20  ion_corrected'] 
-00036d80: 290a 2020 626d 6173 6b20 3d20 616e 7473  ).  bmask = ants
-00036d90: 7079 6e65 742e 6272 6169 6e5f 6578 7472  pynet.brain_extr
-00036da0: 6163 7469 6f6e 2820 666d 7269 5f74 656d  action( fmri_tem
-00036db0: 706c 6174 652c 2027 626f 6c64 2720 292e  plate, 'bold' ).
-00036dc0: 7468 7265 7368 6f6c 645f 696d 6167 6528  threshold_image(
-00036dd0: 302e 352c 3129 2e69 4d61 7468 2822 4765  0.5,1).iMath("Ge
-00036de0: 744c 6172 6765 7374 436f 6d70 6f6e 656e  tLargestComponen
-00036df0: 7422 292e 6d6f 7270 686f 6c6f 6779 2822  t").morphology("
-00036e00: 636c 6f73 6522 2c32 292e 694d 6174 6828  close",2).iMath(
-00036e10: 2246 696c 6c48 6f6c 6573 2229 0a20 2069  "FillHoles").  i
-00036e20: 6620 706c 6f74 5f62 7261 696e 5f6d 6173  f plot_brain_mas
-00036e30: 6b3a 0a20 2020 2061 6e74 732e 706c 6f74  k:.    ants.plot
-00036e40: 2820 666d 7269 5f74 656d 706c 6174 652c  ( fmri_template,
-00036e50: 2062 6d61 736b 2c20 6178 6973 3d31 2c20   bmask, axis=1, 
-00036e60: 6372 6f70 3d54 7275 6520 290a 2020 2020  crop=True ).    
-00036e70: 616e 7473 2e70 6c6f 7428 2066 6d72 695f  ants.plot( fmri_
-00036e80: 7465 6d70 6c61 7465 2c20 626d 6173 6b2c  template, bmask,
-00036e90: 2061 7869 733d 322c 2063 726f 703d 5472   axis=2, crop=Tr
-00036ea0: 7565 2029 0a0a 2020 6966 2074 6320 3d3d  ue )..  if tc ==
-00036eb0: 2027 616c 7465 726e 6174 696e 6727 3a0a   'alternating':.
-00036ec0: 2020 2020 2020 7463 6c69 7374 203d 2072        tclist = r
-00036ed0: 6570 6c69 6361 7465 5f6c 6973 7428 205b  eplicate_list( [
-00036ee0: 2743 272c 2754 275d 2c20 6e74 7020 290a  'C','T'], ntp ).
-00036ef0: 2020 656c 7365 3a0a 2020 2020 2020 7463    else:.      tc
-00036f00: 6c69 7374 203d 2072 6570 6c69 6361 7465  list = replicate
-00036f10: 5f6c 6973 7428 205b 2743 275d 2c20 696e  _list( ['C'], in
-00036f20: 7428 6e74 702f 3229 2029 202b 2072 6570  t(ntp/2) ) + rep
-00036f30: 6c69 6361 7465 5f6c 6973 7428 205b 2754  licate_list( ['T
-00036f40: 275d 2c20 2069 6e74 286e 7470 2f32 2920  '],  int(ntp/2) 
-00036f50: 290a 0a20 2074 636c 6973 7420 3d20 6f6e  )..  tclist = on
-00036f60: 655f 686f 745f 656e 636f 6465 2820 7463  e_hot_encode( tc
-00036f70: 6c69 7374 5b30 3a6e 7470 205d 2029 0a20  list[0:ntp ] ). 
-00036f80: 2066 6d72 696d 6f74 636f 7272 3d63 6f72   fmrimotcorr=cor
-00036f90: 726d 6f5b 276d 6f74 696f 6e5f 636f 7272  rmo['motion_corr
-00036fa0: 6563 7465 6427 5d0a 2020 686c 696e 6473  ected'].  hlinds
-00036fb0: 203d 204e 6f6e 650a 2020 6966 206f 7574   = None.  if out
-00036fc0: 6c69 6572 5f74 6872 6573 686f 6c64 203c  lier_threshold <
-00036fd0: 2031 2e30 2061 6e64 206f 7574 6c69 6572   1.0 and outlier
-00036fe0: 5f74 6872 6573 686f 6c64 203e 2030 2e30  _threshold > 0.0
-00036ff0: 3a0a 2020 2020 666d 7269 6d6f 7463 6f72  :.    fmrimotcor
-00037000: 722c 2068 6c69 6e64 7320 3d20 6c6f 6f70  r, hlinds = loop
-00037010: 5f74 696d 6573 6572 6965 735f 6365 6e73  _timeseries_cens
-00037020: 6f72 696e 6728 2066 6d72 696d 6f74 636f  oring( fmrimotco
-00037030: 7272 2c20 6f75 746c 6965 725f 7468 7265  rr, outlier_thre
-00037040: 7368 6f6c 642c 206d 6173 6b3d 4e6f 6e65  shold, mask=None
-00037050: 2c20 7665 7262 6f73 653d 7665 7262 6f73  , verbose=verbos
-00037060: 6520 290a 2020 2020 7463 6c69 7374 203d  e ).    tclist =
-00037070: 2072 656d 6f76 655f 656c 656d 656e 7473   remove_elements
-00037080: 5f66 726f 6d5f 6e75 6d70 795f 6172 7261  _from_numpy_arra
-00037090: 7928 2074 636c 6973 742c 2068 6c69 6e64  y( tclist, hlind
-000370a0: 7329 0a20 2020 2063 6f72 726d 6f5b 2746  s).    corrmo['F
-000370b0: 4427 5d20 3d20 7265 6d6f 7665 5f65 6c65  D'] = remove_ele
-000370c0: 6d65 6e74 735f 6672 6f6d 5f6e 756d 7079  ments_from_numpy
-000370d0: 5f61 7272 6179 2820 636f 7272 6d6f 5b27  _array( corrmo['
-000370e0: 4644 275d 2c20 686c 696e 6473 2029 0a0a  FD'], hlinds )..
-000370f0: 2020 2320 7265 646f 2074 656d 706c 6174    # redo templat
-00037100: 6520 616e 6420 7265 6769 7374 7261 7469  e and registrati
-00037110: 6f6e 2061 7420 2870 6f74 656e 7469 616c  on at (potential
-00037120: 6c79 2920 7570 7361 6d70 6c65 6420 7363  ly) upsampled sc
-00037130: 616c 650a 2020 666d 7269 5f74 656d 706c  ale.  fmri_templ
-00037140: 6174 6520 3d20 616e 7473 2e69 4d61 7468  ate = ants.iMath
-00037150: 2820 616e 7473 2e67 6574 5f61 7665 7261  ( ants.get_avera
-00037160: 6765 5f6f 665f 7469 6d65 7365 7269 6573  ge_of_timeseries
-00037170: 2820 666d 7269 6d6f 7463 6f72 7220 292c  ( fmrimotcorr ),
-00037180: 2022 4e6f 726d 616c 697a 6522 2029 0a20   "Normalize" ). 
-00037190: 2063 6f72 726d 6f20 3d20 7469 6d65 7365   corrmo = timese
-000371a0: 7269 6573 5f72 6567 280a 2020 2020 2020  ries_reg(.      
-000371b0: 2020 666d 7269 2c20 666d 7269 5f74 656d    fmri, fmri_tem
-000371c0: 706c 6174 652c 0a20 2020 2020 2020 2074  plate,.        t
-000371d0: 7970 655f 6f66 5f74 7261 6e73 666f 726d  ype_of_transform
-000371e0: 3d27 5269 6769 6427 2c0a 2020 2020 2020  ='Rigid',.      
-000371f0: 2020 746f 7461 6c5f 7369 676d 613d 7065    total_sigma=pe
-00037200: 7266 5f74 6f74 616c 5f73 6967 6d61 2c0a  rf_total_sigma,.
-00037210: 2020 2020 2020 2020 6664 4f66 6673 6574          fdOffset
-00037220: 3d32 2e30 2c0a 2020 2020 2020 2020 7472  =2.0,.        tr
-00037230: 696d 203d 206d 7974 7269 6d2c 0a20 2020  im = mytrim,.   
-00037240: 2020 2020 206f 7574 7075 745f 6469 7265       output_dire
-00037250: 6374 6f72 793d 4e6f 6e65 2c0a 2020 2020  ctory=None,.    
-00037260: 2020 2020 7665 7262 6f73 653d 7665 7262      verbose=verb
-00037270: 6f73 652c 0a20 2020 2020 2020 2073 796e  ose,.        syn
-00037280: 5f6d 6574 7269 633d 2763 6327 2c0a 2020  _metric='cc',.  
-00037290: 2020 2020 2020 7379 6e5f 7361 6d70 6c69        syn_sampli
-000372a0: 6e67 3d32 2c0a 2020 2020 2020 2020 7265  ng=2,.        re
-000372b0: 675f 6974 6572 6174 696f 6e73 3d5b 3430  g_iterations=[40
-000372c0: 2c32 302c 355d 2029 0a20 2069 6620 7665  ,20,5] ).  if ve
-000372d0: 7262 6f73 653a 0a20 2020 2020 2020 2070  rbose:.        p
-000372e0: 7269 6e74 2822 456e 6420 326e 6420 7273  rint("End 2nd rs
-000372f0: 666d 7269 206d 6f74 696f 6e20 636f 7272  fmri motion corr
-00037300: 6563 7469 6f6e 2229 0a0a 2020 6966 206f  ection")..  if o
-00037310: 7574 6c69 6572 5f74 6872 6573 686f 6c64  utlier_threshold
-00037320: 203c 2031 2e30 2061 6e64 206f 7574 6c69   < 1.0 and outli
-00037330: 6572 5f74 6872 6573 686f 6c64 203e 2030  er_threshold > 0
-00037340: 2e30 3a0a 2020 2020 636f 7272 6d6f 5b27  .0:.    corrmo['
-00037350: 6d6f 7469 6f6e 5f63 6f72 7265 6374 6564  motion_corrected
-00037360: 275d 203d 2072 656d 6f76 655f 766f 6c75  '] = remove_volu
-00037370: 6d65 735f 6672 6f6d 5f74 696d 6573 6572  mes_from_timeser
-00037380: 6965 7328 2063 6f72 726d 6f5b 276d 6f74  ies( corrmo['mot
-00037390: 696f 6e5f 636f 7272 6563 7465 6427 5d2c  ion_corrected'],
-000373a0: 2068 6c69 6e64 7320 290a 2020 2020 636f   hlinds ).    co
-000373b0: 7272 6d6f 5b27 4644 275d 203d 2072 656d  rrmo['FD'] = rem
-000373c0: 6f76 655f 656c 656d 656e 7473 5f66 726f  ove_elements_fro
-000373d0: 6d5f 6e75 6d70 795f 6172 7261 7928 2063  m_numpy_array( c
-000373e0: 6f72 726d 6f5b 2746 4427 5d2c 2068 6c69  orrmo['FD'], hli
-000373f0: 6e64 7320 290a 0a20 2062 6d61 736b 203d  nds )..  bmask =
-00037400: 2061 6e74 7370 796e 6574 2e62 7261 696e   antspynet.brain
-00037410: 5f65 7874 7261 6374 696f 6e28 2066 6d72  _extraction( fmr
-00037420: 695f 7465 6d70 6c61 7465 2c20 2762 6f6c  i_template, 'bol
-00037430: 6427 2029 2e74 6872 6573 686f 6c64 5f69  d' ).threshold_i
-00037440: 6d61 6765 2830 2e35 2c31 292e 694d 6174  mage(0.5,1).iMat
-00037450: 6828 2247 6574 4c61 7267 6573 7443 6f6d  h("GetLargestCom
-00037460: 706f 6e65 6e74 2229 2e6d 6f72 7068 6f6c  ponent").morphol
-00037470: 6f67 7928 2263 6c6f 7365 222c 3229 2e69  ogy("close",2).i
-00037480: 4d61 7468 2822 4669 6c6c 486f 6c65 7322  Math("FillHoles"
-00037490: 290a 2020 6966 2070 6c6f 745f 6272 6169  ).  if plot_brai
-000374a0: 6e5f 6d61 736b 3a0a 2020 2020 616e 7473  n_mask:.    ants
-000374b0: 2e70 6c6f 7428 2066 6d72 695f 7465 6d70  .plot( fmri_temp
-000374c0: 6c61 7465 2c20 626d 6173 6b2c 2061 7869  late, bmask, axi
-000374d0: 733d 312c 2063 726f 703d 5472 7565 2029  s=1, crop=True )
-000374e0: 0a20 2020 2061 6e74 732e 706c 6f74 2820  .    ants.plot( 
-000374f0: 666d 7269 5f74 656d 706c 6174 652c 2062  fmri_template, b
-00037500: 6d61 736b 2c20 6178 6973 3d32 2c20 6372  mask, axis=2, cr
-00037510: 6f70 3d54 7275 6520 290a 0a20 2072 6567  op=True )..  reg
-00037520: 7265 7373 696f 6e5f 6d61 736b 203d 2062  ression_mask = b
-00037530: 6d61 736b 2e63 6c6f 6e65 2829 0a20 206d  mask.clone().  m
-00037540: 7974 736e 7220 3d20 7473 6e72 2820 636f  ytsnr = tsnr( co
-00037550: 7272 6d6f 5b27 6d6f 7469 6f6e 5f63 6f72  rrmo['motion_cor
-00037560: 7265 6374 6564 275d 2c20 626d 6173 6b20  rected'], bmask 
-00037570: 290a 2020 6d79 7473 6e72 5468 7265 7368  ).  mytsnrThresh
-00037580: 203d 206e 702e 7175 616e 7469 6c65 2820   = np.quantile( 
-00037590: 6d79 7473 6e72 2e6e 756d 7079 2829 2c20  mytsnr.numpy(), 
-000375a0: 302e 3939 3520 290a 2020 7473 6e72 6d61  0.995 ).  tsnrma
-000375b0: 736b 203d 2061 6e74 732e 7468 7265 7368  sk = ants.thresh
-000375c0: 6f6c 645f 696d 6167 6528 206d 7974 736e  old_image( mytsn
-000375d0: 722c 2030 2c20 6d79 7473 6e72 5468 7265  r, 0, mytsnrThre
-000375e0: 7368 2029 2e6d 6f72 7068 6f6c 6f67 7928  sh ).morphology(
-000375f0: 2263 6c6f 7365 222c 3329 0a20 2062 6d61  "close",3).  bma
-00037600: 736b 203d 2062 6d61 736b 202a 2061 6e74  sk = bmask * ant
-00037610: 732e 694d 6174 6828 2074 736e 726d 6173  s.iMath( tsnrmas
-00037620: 6b2c 2022 4669 6c6c 486f 6c65 7322 2029  k, "FillHoles" )
-00037630: 0a20 2066 6d72 696d 6f74 636f 7272 3d63  .  fmrimotcorr=c
-00037640: 6f72 726d 6f5b 276d 6f74 696f 6e5f 636f  orrmo['motion_co
-00037650: 7272 6563 7465 6427 5d0a 2020 756e 6420  rrected'].  und 
-00037660: 3d20 666d 7269 5f74 656d 706c 6174 6520  = fmri_template 
-00037670: 2a20 626d 6173 6b0a 2020 636f 6d70 636f  * bmask.  compco
-00037680: 7271 7561 6e74 696c 653d 302e 3530 0a20  rquantile=0.50. 
-00037690: 206d 7963 6f6d 7063 6f72 203d 2061 6e74   mycompcor = ant
-000376a0: 732e 636f 6d70 636f 7228 2066 6d72 696d  s.compcor( fmrim
-000376b0: 6f74 636f 7272 2c0a 2020 2020 6e63 6f6d  otcorr,.    ncom
-000376c0: 7063 6f72 3d6e 632c 2071 7561 6e74 696c  pcor=nc, quantil
-000376d0: 653d 636f 6d70 636f 7271 7561 6e74 696c  e=compcorquantil
-000376e0: 652c 206d 6173 6b20 3d20 626d 6173 6b2c  e, mask = bmask,
-000376f0: 0a20 2020 2066 696c 7465 725f 7479 7065  .    filter_type
-00037700: 3d27 706f 6c79 6e6f 6d69 616c 272c 2064  ='polynomial', d
-00037710: 6567 7265 653d 3220 290a 2020 7472 203d  egree=2 ).  tr =
-00037720: 2061 6e74 732e 6765 745f 7370 6163 696e   ants.get_spacin
-00037730: 6728 2066 6d72 696d 6f74 636f 7272 2029  g( fmrimotcorr )
-00037740: 5b33 5d0a 2020 7369 6d67 203d 2061 6e74  [3].  simg = ant
-00037750: 732e 736d 6f6f 7468 5f69 6d61 6765 2866  s.smooth_image(f
-00037760: 6d72 696d 6f74 636f 7272 2c20 7370 612c  mrimotcorr, spa,
-00037770: 2073 6967 6d61 5f69 6e5f 7068 7973 6963   sigma_in_physic
-00037780: 616c 5f63 6f6f 7264 696e 6174 6573 203d  al_coordinates =
-00037790: 2054 7275 6520 290a 2020 6e75 6973 616e   True ).  nuisan
-000377a0: 6365 203d 206d 7963 6f6d 7063 6f72 5b27  ce = mycompcor['
-000377b0: 6261 7369 7327 5d0a 2020 6e75 6973 616e  basis'].  nuisan
-000377c0: 6365 203d 206e 702e 635f 5b20 6e75 6973  ce = np.c_[ nuis
-000377d0: 616e 6365 2c20 6d79 636f 6d70 636f 725b  ance, mycompcor[
-000377e0: 2763 6f6d 706f 6e65 6e74 7327 5d20 5d0a  'components'] ].
-000377f0: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-00037800: 2020 7072 696e 7428 226d 616b 6520 7375    print("make su
-00037810: 7265 206e 7569 7361 6e63 6520 6973 2069  re nuisance is i
-00037820: 6e64 6570 656e 6465 6e74 206f 6620 5443  ndependent of TC
-00037830: 2229 0a20 206e 7569 7361 6e63 6520 3d20  ").  nuisance = 
-00037840: 616e 7473 2e72 6567 7265 7373 5f63 6f6d  ants.regress_com
-00037850: 706f 6e65 6e74 7328 206e 7569 7361 6e63  ponents( nuisanc
-00037860: 652c 2074 636c 6973 7420 290a 2020 7265  e, tclist ).  re
-00037870: 6772 6573 7369 6f6e 5f6d 6173 6b20 3d20  gression_mask = 
-00037880: 626d 6173 6b2e 636c 6f6e 6528 290a 2020  bmask.clone().  
-00037890: 676d 6d61 7420 3d20 616e 7473 2e74 696d  gmmat = ants.tim
-000378a0: 6573 6572 6965 735f 746f 5f6d 6174 7269  eseries_to_matri
-000378b0: 7828 2073 696d 672c 2072 6567 7265 7373  x( simg, regress
-000378c0: 696f 6e5f 6d61 736b 2029 0a20 2072 6567  ion_mask ).  reg
-000378d0: 7661 7273 203d 206e 702e 6873 7461 636b  vars = np.hstack
-000378e0: 2820 286e 7569 7361 6e63 652c 2074 636c  ( (nuisance, tcl
-000378f0: 6973 7420 2929 0a20 2063 6f65 6669 6e64  ist )).  coefind
-00037900: 203d 2072 6567 7661 7273 2e73 6861 7065   = regvars.shape
-00037910: 5b31 5d2d 310a 2020 7265 6776 6172 7320  [1]-1.  regvars 
-00037920: 3d20 7265 6776 6172 735b 3a2c 7261 6e67  = regvars[:,rang
-00037930: 6528 636f 6566 696e 6429 5d0a 2020 7072  e(coefind)].  pr
-00037940: 6564 6963 746f 725f 6f66 5f69 6e74 6572  edictor_of_inter
-00037950: 6573 745f 6964 7820 3d20 7265 6776 6172  est_idx = regvar
-00037960: 732e 7368 6170 655b 315d 2d31 0a20 2076  s.shape[1]-1.  v
-00037970: 616c 6964 5f70 6572 665f 6d6f 6465 6c73  alid_perf_models
-00037980: 203d 205b 2768 7562 6572 272c 2771 7561   = ['huber','qua
-00037990: 6e74 696c 6527 2c27 7468 6569 6c73 656e  ntile','theilsen
-000379a0: 272c 2772 616e 7361 6327 2c20 2773 6764  ','ransac', 'sgd
-000379b0: 272c 2027 6c69 6e65 6172 272c 2753 4d27  ', 'linear','SM'
-000379c0: 5d0a 2020 7065 7266 7573 696f 6e5f 7265  ].  perfusion_re
-000379d0: 6772 6573 7369 6f6e 5f6d 6f64 656c 3d27  gression_model='
-000379e0: 6c69 6e65 6172 270a 2020 6966 2076 6572  linear'.  if ver
-000379f0: 626f 7365 3a0a 2020 2020 7072 696e 7428  bose:.    print(
-00037a00: 2022 6265 6769 6e20 7065 7266 7573 696f   "begin perfusio
-00037a10: 6e20 6573 7469 6d61 7469 6f6e 2077 6974  n estimation wit
-00037a20: 6820 2220 2b20 7065 7266 7573 696f 6e5f  h " + perfusion_
-00037a30: 7265 6772 6573 7369 6f6e 5f6d 6f64 656c  regression_model
-00037a40: 202b 2022 206d 6f64 656c 2022 2029 0a20   + " model " ). 
-00037a50: 2072 6567 7265 7373 696f 6e5f 6d6f 6465   regression_mode
-00037a60: 6c20 3d20 4c69 6e65 6172 5265 6772 6573  l = LinearRegres
-00037a70: 7369 6f6e 2829 0a20 2072 6567 7265 7373  sion().  regress
-00037a80: 696f 6e5f 6d6f 6465 6c2e 6669 7428 2072  ion_model.fit( r
-00037a90: 6567 7661 7273 2c20 676d 6d61 7420 290a  egvars, gmmat ).
-00037aa0: 2020 636f 6566 696e 6420 3d20 7265 6772    coefind = regr
-00037ab0: 6573 7369 6f6e 5f6d 6f64 656c 2e63 6f65  ession_model.coe
-00037ac0: 665f 2e73 6861 7065 5b31 5d2d 310a 2020  f_.shape[1]-1.  
-00037ad0: 7065 7266 696d 6720 3d20 616e 7473 2e6d  perfimg = ants.m
-00037ae0: 616b 655f 696d 6167 6528 2072 6567 7265  ake_image( regre
-00037af0: 7373 696f 6e5f 6d61 736b 2c20 7265 6772  ssion_mask, regr
-00037b00: 6573 7369 6f6e 5f6d 6f64 656c 2e63 6f65  ession_model.coe
-00037b10: 665f 5b3a 2c63 6f65 6669 6e64 5d20 290a  f_[:,coefind] ).
-00037b20: 2020 676d 7365 6720 3d20 616e 7473 2e69    gmseg = ants.i
-00037b30: 6d61 6765 5f63 6c6f 6e65 2820 626d 6173  mage_clone( bmas
-00037b40: 6b20 290a 2020 6d65 616e 676d 7661 6c20  k ).  meangmval 
-00037b50: 3d20 2820 7065 7266 696d 675b 2067 6d73  = ( perfimg[ gms
-00037b60: 6567 203d 3d20 3120 5d20 292e 6d65 616e  eg == 1 ] ).mean
-00037b70: 2829 0a20 2069 6620 6d65 616e 676d 7661  ().  if meangmva
-00037b80: 6c20 3c20 303a 0a20 2020 2020 2070 6572  l < 0:.      per
-00037b90: 6669 6d67 203d 2070 6572 6669 6d67 202a  fimg = perfimg *
-00037ba0: 2028 2d31 2e30 290a 2020 6e65 6761 7469   (-1.0).  negati
-00037bb0: 7665 5f76 6f78 656c 7320 3d20 2820 7065  ve_voxels = ( pe
-00037bc0: 7266 696d 6720 3c20 302e 3020 292e 7375  rfimg < 0.0 ).su
-00037bd0: 6d28 2920 2f20 6e70 2e70 726f 6428 2070  m() / np.prod( p
-00037be0: 6572 6669 6d67 2e73 6861 7065 2029 202a  erfimg.shape ) *
-00037bf0: 2031 3030 2e30 0a20 2070 6572 6669 6d67   100.0.  perfimg
-00037c00: 5b20 7065 7266 696d 6720 3c20 302e 3020  [ perfimg < 0.0 
-00037c10: 5d20 3d20 302e 3020 2320 6e6f 6e2d 7068  ] = 0.0 # non-ph
-00037c20: 7973 696f 6c6f 6769 6361 6c0a 0a20 2069  ysiological..  i
-00037c30: 6620 6d30 5f69 6d61 6765 2069 7320 4e6f  f m0_image is No
-00037c40: 6e65 3a0a 2020 2020 6d30 203d 2061 6e74  ne:.    m0 = ant
-00037c50: 732e 6765 745f 6176 6572 6167 655f 6f66  s.get_average_of
-00037c60: 5f74 696d 6573 6572 6965 7328 2066 6d72  _timeseries( fmr
-00037c70: 696d 6f74 636f 7272 2029 0a20 2065 6c73  imotcorr ).  els
-00037c80: 653a 0a20 2020 2023 2072 6567 6973 7465  e:.    # registe
-00037c90: 7220 6d30 2074 6f20 6375 7272 656e 7420  r m0 to current 
-00037ca0: 7465 6d70 6c61 7465 0a20 2020 206d 3072  template.    m0r
-00037cb0: 6567 203d 2061 6e74 732e 7265 6769 7374  eg = ants.regist
-00037cc0: 7261 7469 6f6e 2820 666d 7269 5f74 656d  ration( fmri_tem
-00037cd0: 706c 6174 652c 206d 302c 2027 5269 6769  plate, m0, 'Rigi
-00037ce0: 6427 2c20 7665 7262 6f73 653d 4661 6c73  d', verbose=Fals
-00037cf0: 6520 290a 2020 2020 6d30 203d 206d 3072  e ).    m0 = m0r
-00037d00: 6567 5b27 7761 7270 6564 6d6f 766f 7574  eg['warpedmovout
-00037d10: 275d 0a0a 2020 6966 206e 7470 203d 3d20  ']..  if ntp == 
-00037d20: 3220 3a0a 2020 2020 2020 696d 6730 203d  2 :.      img0 =
-00037d30: 2061 6e74 732e 736c 6963 655f 696d 6167   ants.slice_imag
-00037d40: 6528 2063 6f72 726d 6f5b 276d 6f74 696f  e( corrmo['motio
-00037d50: 6e5f 636f 7272 6563 7465 6427 5d2c 2061  n_corrected'], a
-00037d60: 7869 733d 332c 2069 6478 3d30 2029 0a20  xis=3, idx=0 ). 
-00037d70: 2020 2020 2069 6d67 3120 3d20 616e 7473       img1 = ants
-00037d80: 2e73 6c69 6365 5f69 6d61 6765 2820 636f  .slice_image( co
-00037d90: 7272 6d6f 5b27 6d6f 7469 6f6e 5f63 6f72  rrmo['motion_cor
-00037da0: 7265 6374 6564 275d 2c20 6178 6973 3d33  rected'], axis=3
-00037db0: 2c20 6964 783d 3120 290a 2020 2020 2020  , idx=1 ).      
-00037dc0: 6966 206d 305f 696d 6167 6520 6973 204e  if m0_image is N
-00037dd0: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
-00037de0: 696d 6730 2e6d 6561 6e28 2920 3c20 696d  img0.mean() < im
-00037df0: 6731 2e6d 6561 6e28 293a 0a20 2020 2020  g1.mean():.     
-00037e00: 2020 2020 2020 2070 6572 6669 6d67 3d69         perfimg=i
-00037e10: 6d67 300a 2020 2020 2020 2020 2020 2020  mg0.            
-00037e20: 6d30 3d69 6d67 310a 2020 2020 2020 2020  m0=img1.        
-00037e30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00037e40: 2020 7065 7266 696d 673d 696d 6731 0a20    perfimg=img1. 
-00037e50: 2020 2020 2020 2020 2020 206d 303d 696d             m0=im
-00037e60: 6730 0a20 2020 2020 2065 6c73 653a 0a20  g0.      else:. 
-00037e70: 2020 2020 2020 2069 6620 696d 6730 2e6d         if img0.m
-00037e80: 6561 6e28 2920 3c20 696d 6731 2e6d 6561  ean() < img1.mea
-00037e90: 6e28 293a 0a20 2020 2020 2020 2020 2020  n():.           
-00037ea0: 2070 6572 6669 6d67 3d69 6d67 312d 696d   perfimg=img1-im
-00037eb0: 6730 0a20 2020 2020 2020 2065 6c73 653a  g0.        else:
-00037ec0: 0a20 2020 2020 2020 2020 2020 2070 6572  .            per
-00037ed0: 6669 6d67 3d69 6d67 302d 696d 6731 0a20  fimg=img0-img1. 
-00037ee0: 200a 2020 6362 6620 3d20 6361 6c63 756c   .  cbf = calcul
-00037ef0: 6174 655f 4342 4628 2044 656c 7461 5f4d  ate_CBF( Delta_M
-00037f00: 3d70 6572 6669 6d67 2c20 4d5f 303d 6d30  =perfimg, M_0=m0
-00037f10: 2c20 6d61 736b 3d62 6d61 736b 2029 0a20  , mask=bmask ). 
-00037f20: 206d 6561 6e67 6d76 616c 203d 2028 2070   meangmval = ( p
-00037f30: 6572 6669 6d67 5b20 676d 7365 6720 3d3d  erfimg[ gmseg ==
-00037f40: 2031 205d 2029 2e6d 6561 6e28 2920 2020   1 ] ).mean()   
-00037f50: 2020 2020 200a 2020 6d65 616e 676d 7661       .  meangmva
-00037f60: 6c63 6266 203d 2028 2063 6266 5b20 676d  lcbf = ( cbf[ gm
-00037f70: 7365 6720 3d3d 2031 205d 2029 2e6d 6561  seg == 1 ] ).mea
-00037f80: 6e28 290a 2020 6966 2076 6572 626f 7365  n().  if verbose
-00037f90: 3a0a 2020 2020 7072 696e 7428 2270 6572  :.    print("per
-00037fa0: 6669 6d67 2e6d 6178 2829 2022 202b 2073  fimg.max() " + s
-00037fb0: 7472 2820 2070 6572 6669 6d67 2e6d 6178  tr(  perfimg.max
-00037fc0: 2829 2029 2029 0a20 206f 7574 6469 6374  () ) ).  outdict
-00037fd0: 203d 207b 7d0a 2020 6f75 7464 6963 745b   = {}.  outdict[
-00037fe0: 276d 6561 6e42 6f6c 6427 5d20 3d20 756e  'meanBold'] = un
-00037ff0: 640a 2020 6f75 7464 6963 745b 2762 7261  d.  outdict['bra
-00038000: 696e 6d61 736b 275d 203d 2062 6d61 736b  inmask'] = bmask
-00038010: 0a20 2072 7366 4e75 6973 616e 6365 203d  .  rsfNuisance =
-00038020: 2070 642e 4461 7461 4672 616d 6528 206e   pd.DataFrame( n
-00038030: 7569 7361 6e63 6520 290a 2020 7273 664e  uisance ).  rsfN
-00038040: 7569 7361 6e63 655b 2746 4427 5d3d 636f  uisance['FD']=co
-00038050: 7272 6d6f 5b27 4644 275d 0a20 206f 7574  rrmo['FD'].  out
-00038060: 6469 6374 5b27 7065 7266 7573 696f 6e27  dict['perfusion'
-00038070: 5d3d 7065 7266 696d 670a 2020 6f75 7464  ]=perfimg.  outd
-00038080: 6963 745b 2763 6266 275d 3d63 6266 0a20  ict['cbf']=cbf. 
-00038090: 206f 7574 6469 6374 5b27 6d30 275d 3d6d   outdict['m0']=m
-000380a0: 300a 2020 6f75 7464 6963 745b 2770 6572  0.  outdict['per
-000380b0: 6675 7369 6f6e 5f67 6d5f 6d65 616e 275d  fusion_gm_mean']
-000380c0: 3d6d 6561 6e67 6d76 616c 0a20 206f 7574  =meangmval.  out
-000380d0: 6469 6374 5b27 6362 665f 676d 5f6d 6561  dict['cbf_gm_mea
-000380e0: 6e27 5d3d 6d65 616e 676d 7661 6c63 6266  n']=meangmvalcbf
-000380f0: 0a20 206f 7574 6469 6374 5b27 6d6f 7469  .  outdict['moti
-00038100: 6f6e 5f63 6f72 7265 6374 6564 275d 203d  on_corrected'] =
-00038110: 2063 6f72 726d 6f5b 276d 6f74 696f 6e5f   corrmo['motion_
-00038120: 636f 7272 6563 7465 6427 5d0a 2020 6f75  corrected'].  ou
-00038130: 7464 6963 745b 2762 7261 696e 5f6d 6173  tdict['brain_mas
-00038140: 6b27 5d20 3d20 626d 6173 6b0a 2020 6f75  k'] = bmask.  ou
-00038150: 7464 6963 745b 276e 7569 7361 6e63 6527  tdict['nuisance'
-00038160: 5d20 3d20 7273 664e 7569 7361 6e63 650a  ] = rsfNuisance.
-00038170: 2020 6f75 7464 6963 745b 2774 736e 7227    outdict['tsnr'
-00038180: 5d20 3d20 6d79 7473 6e72 0a20 206f 7574  ] = mytsnr.  out
-00038190: 6469 6374 5b27 6476 6172 7327 5d20 3d20  dict['dvars'] = 
-000381a0: 6476 6172 7328 2063 6f72 726d 6f5b 276d  dvars( corrmo['m
-000381b0: 6f74 696f 6e5f 636f 7272 6563 7465 6427  otion_corrected'
-000381c0: 5d2c 2067 6d73 6567 2029 0a20 206f 7574  ], gmseg ).  out
-000381d0: 6469 6374 5b27 4644 5f6d 6178 275d 203d  dict['FD_max'] =
-000381e0: 2072 7366 4e75 6973 616e 6365 5b27 4644   rsfNuisance['FD
-000381f0: 275d 2e6d 6178 2829 0a20 206f 7574 6469  '].max().  outdi
-00038200: 6374 5b27 4644 5f6d 6561 6e27 5d20 3d20  ct['FD_mean'] = 
-00038210: 7273 664e 7569 7361 6e63 655b 2746 4427  rsfNuisance['FD'
-00038220: 5d2e 6d65 616e 2829 0a20 206f 7574 6469  ].mean().  outdi
-00038230: 6374 5b27 4644 5f73 6427 5d20 3d20 7273  ct['FD_sd'] = rs
-00038240: 664e 7569 7361 6e63 655b 2746 4427 5d2e  fNuisance['FD'].
-00038250: 7374 6428 290a 2020 6f75 7464 6963 745b  std().  outdict[
-00038260: 276f 7574 6c69 6572 5f76 6f6c 756d 6573  'outlier_volumes
-00038270: 275d 3d68 6c69 6e64 730a 2020 6f75 7464  ']=hlinds.  outd
-00038280: 6963 745b 276e 6567 6174 6976 655f 766f  ict['negative_vo
-00038290: 7865 6c73 275d 3d6e 6567 6174 6976 655f  xels']=negative_
-000382a0: 766f 7865 6c73 0a20 2072 6574 7572 6e20  voxels.  return 
-000382b0: 636f 6e76 6572 745f 6e70 5f69 6e5f 6469  convert_np_in_di
-000382c0: 6374 2820 6f75 7464 6963 7420 290a 0a0a  ct( outdict )...
-000382d0: 6465 6620 626f 6c64 5f70 6572 6675 7369  def bold_perfusi
-000382e0: 6f6e 2820 666d 7269 2c20 7431 6865 6164  on( fmri, t1head
-000382f0: 2c20 7431 2c20 7431 7365 676d 656e 7461  , t1, t1segmenta
-00038300: 7469 6f6e 2c20 7431 646b 7463 6974 2c0a  tion, t1dktcit,.
-00038310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038320: 2020 2046 445f 7468 7265 7368 6f6c 643d     FD_threshold=
-00038330: 302e 352c 0a20 2020 2020 2020 2020 2020  0.5,.           
-00038340: 2020 2020 2020 2020 7370 6120 3d20 2830          spa = (0
-00038350: 2e2c 2030 2e2c 2030 2e2c 2030 2e29 2c0a  ., 0., 0., 0.),.
-00038360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038370: 2020 206e 6320 3d20 332c 0a20 2020 2020     nc = 3,.     
-00038380: 2020 2020 2020 2020 2020 2020 2020 7479                ty
-00038390: 7065 5f6f 665f 7472 616e 7366 6f72 6d3d  pe_of_transform=
-000383a0: 2752 6967 6964 272c 0a20 2020 2020 2020  'Rigid',.       
-000383b0: 2020 2020 2020 2020 2020 2020 7463 3d27              tc='
-000383c0: 616c 7465 726e 6174 696e 6727 2c0a 2020  alternating',.  
-000383d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000383e0: 206e 5f74 6f5f 7472 696d 3d30 2c0a 2020   n_to_trim=0,.  
-000383f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038400: 206d 305f 696d 6167 6520 3d20 4e6f 6e65   m0_image = None
-00038410: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00038420: 2020 2020 206d 305f 696e 6469 6365 733d       m0_indices=
-00038430: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00038440: 2020 2020 2020 2020 206f 7574 6c69 6572           outlier
-00038450: 5f74 6872 6573 686f 6c64 3d30 2e32 3530  _threshold=0.250
-00038460: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00038470: 2020 2020 2061 6464 5f46 445f 746f 5f6e       add_FD_to_n
-00038480: 7569 7361 6e63 653d 4661 6c73 652c 0a20  uisance=False,. 
-00038490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000384a0: 2020 6e33 3d46 616c 7365 2c0a 2020 2020    n3=False,.    
-000384b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000384c0: 6567 6d65 6e74 5f74 696d 6573 6572 6965  egment_timeserie
-000384d0: 733d 4661 6c73 652c 0a20 2020 2020 2020  s=False,.       
-000384e0: 2020 2020 2020 2020 2020 2020 7472 696d              trim
-000384f0: 5f74 6865 5f6d 6173 6b3d 342e 3235 2c0a  _the_mask=4.25,.
-00038500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038510: 2020 2075 7073 616d 706c 653d 5472 7565     upsample=True
-00038520: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00038530: 2020 2020 2070 6572 6675 7369 6f6e 5f72       perfusion_r
-00038540: 6567 7265 7373 696f 6e5f 6d6f 6465 6c3d  egression_model=
-00038550: 276c 696e 6561 7227 2c0a 2020 2020 2020  'linear',.      
-00038560: 2020 2020 2020 2020 2020 2020 2076 6572               ver
-00038570: 626f 7365 3d46 616c 7365 2029 3a0a 2020  bose=False ):.  
-00038580: 2222 220a 2020 4573 7469 6d61 7465 2070  """.  Estimate p
-00038590: 6572 6675 7369 6f6e 2066 726f 6d20 6120  erfusion from a 
-000385a0: 424f 4c44 2074 696d 6520 7365 7269 6573  BOLD time series
-000385b0: 2069 6d61 6765 2e20 2057 696c 6c20 6174   image.  Will at
-000385c0: 7465 6d70 7420 746f 2066 6967 7572 6520  tempt to figure 
-000385d0: 6f75 7420 7468 6520 542d 4320 6c61 6265  out the T-C labe
-000385e0: 6c73 2066 726f 6d20 7468 6520 6461 7461  ls from the data
-000385f0: 2e20 2054 6865 2066 756e 6374 696f 6e20  .  The function 
-00038600: 7573 6573 2064 6566 6175 6c74 7320 746f  uses defaults to
-00038610: 2071 7561 6e74 6966 7920 4342 4620 6275   quantify CBF bu
-00038620: 7420 7468 6573 6520 7769 6c6c 2075 7375  t these will usu
-00038630: 616c 6c79 206e 6f74 2062 6520 636f 7272  ally not be corr
-00038640: 6563 7420 666f 7220 796f 7572 206f 776e  ect for your own
-00038650: 2064 6174 612e 2020 5365 6520 7468 6520   data.  See the 
-00038660: 6675 6e63 7469 6f6e 2063 616c 6375 6c61  function calcula
-00038670: 7465 5f43 4246 2066 6f72 2061 6e20 6578  te_CBF for an ex
-00038680: 616d 706c 6520 6f66 2068 6f77 206f 6e65  ample of how one
-00038690: 206d 6967 6874 2064 6f20 7175 616e 7469   might do quanti
-000386a0: 6669 6361 7469 6f6e 2062 6173 6564 206f  fication based o
-000386b0: 6e20 7468 6520 6f75 7470 7574 7320 6f66  n the outputs of
-000386c0: 2074 6869 7320 6675 6e63 7469 6f6e 2073   this function s
-000386d0: 7065 6369 6669 6361 6c6c 7920 7468 6520  pecifically the 
-000386e0: 7065 7266 7573 696f 6e2c 206d 3020 616e  perfusion, m0 an
-000386f0: 6420 6d61 736b 2069 6d61 6765 7320 7468  d mask images th
-00038700: 6174 2061 7265 2070 6172 7420 6f66 2074  at are part of t
-00038710: 6865 206f 7574 7075 7420 6469 6374 696f  he output dictio
-00038720: 6e61 7279 2e0a 0a20 2041 7267 756d 656e  nary...  Argumen
-00038730: 7473 0a20 202d 2d2d 2d2d 2d2d 2d2d 0a20  ts.  ---------. 
-00038740: 2066 6d72 6920 3a20 424f 4c44 2066 6d72   fmri : BOLD fmr
-00038750: 6920 616e 7473 496d 6167 650a 0a20 2066  i antsImage..  f
-00038760: 6d72 695f 7465 6d70 6c61 7465 203a 2072  mri_template : r
-00038770: 6566 6572 656e 6365 2073 7061 6365 2066  eference space f
-00038780: 6f72 2042 4f4c 440a 0a20 2074 3168 6561  or BOLD..  t1hea
-00038790: 6420 3a20 414e 5473 496d 6167 650a 2020  d : ANTsImage.  
-000387a0: 2020 696e 7075 7420 332d 4420 5431 2062    input 3-D T1 b
-000387b0: 7261 696e 2069 6d61 6765 2028 6e6f 7420  rain image (not 
-000387c0: 6272 6169 6e20 6578 7472 6163 7465 6429  brain extracted)
-000387d0: 0a0a 2020 7431 203a 2041 4e54 7349 6d61  ..  t1 : ANTsIma
-000387e0: 6765 0a20 2020 2069 6e70 7574 2033 2d44  ge.    input 3-D
-000387f0: 2054 3120 6272 6169 6e20 696d 6167 6520   T1 brain image 
-00038800: 2862 7261 696e 2065 7874 7261 6374 6564  (brain extracted
-00038810: 290a 0a20 2074 3173 6567 6d65 6e74 6174  )..  t1segmentat
-00038820: 696f 6e20 3a20 414e 5473 496d 6167 650a  ion : ANTsImage.
-00038830: 2020 2020 7431 2073 6567 6d65 6e74 6174      t1 segmentat
-00038840: 696f 6e20 2d20 6120 7369 7820 7469 7373  ion - a six tiss
-00038850: 7565 2073 6567 6d65 6e74 6174 696f 6e20  ue segmentation 
-00038860: 696d 6167 6520 696e 2054 3120 7370 6163  image in T1 spac
-00038870: 650a 0a20 2074 3164 6b74 6369 7420 3a20  e..  t1dktcit : 
-00038880: 414e 5473 496d 6167 650a 2020 2020 7431  ANTsImage.    t1
-00038890: 2064 6b74 2063 6f72 7465 7820 706c 7573   dkt cortex plus
-000388a0: 2063 6974 2070 6172 6365 6c6c 6174 696f   cit parcellatio
-000388b0: 6e0a 0a20 2073 7061 203a 2067 6175 7373  n..  spa : gauss
-000388c0: 6961 6e20 736d 6f6f 7468 696e 6720 666f  ian smoothing fo
-000388d0: 7220 7370 6174 6961 6c20 616e 6420 7465  r spatial and te
-000388e0: 6d70 6f72 616c 2063 6f6d 706f 6e65 6e74  mporal component
-000388f0: 2065 2e67 2e20 2831 2c31 2c31 2c30 2920   e.g. (1,1,1,0) 
-00038900: 696e 2070 6879 7369 6361 6c20 7370 6163  in physical spac
-00038910: 6520 636f 6f72 6469 6e61 7465 730a 0a20  e coordinates.. 
-00038920: 206e 6320 203a 206e 756d 6265 7220 6f66   nc  : number of
-00038930: 2063 6f6d 706f 6e65 6e74 7320 666f 7220   components for 
-00038940: 636f 6d70 636f 7220 6669 6c74 6572 696e  compcor filterin
-00038950: 670a 0a20 2074 7970 655f 6f66 5f74 7261  g..  type_of_tra
-00038960: 6e73 666f 726d 203a 2053 794e 206f 7220  nsform : SyN or 
-00038970: 5269 6769 640a 0a20 2074 633a 2073 7472  Rigid..  tc: str
-00038980: 696e 6720 6569 7468 6572 2061 6c74 6572  ing either alter
-00038990: 6e61 7469 6e67 206f 7220 7370 6c69 7420  nating or split 
-000389a0: 2864 6566 6175 6c74 2069 7320 616c 7465  (default is alte
-000389b0: 726e 6174 696e 6720 6965 2043 5443 5443  rnating ie CTCTC
-000389c0: 543b 2073 706c 6974 2069 7320 4343 4343  T; split is CCCC
-000389d0: 5454 5454 290a 0a20 206e 5f74 6f5f 7472  TTTT)..  n_to_tr
-000389e0: 696d 3a20 6e75 6d62 6572 206f 6620 766f  im: number of vo
-000389f0: 6c75 6d65 7320 746f 2074 7269 6d20 6f66  lumes to trim of
-00038a00: 6620 7468 6520 6672 6f6e 7420 6f66 2074  f the front of t
-00038a10: 6865 2074 696d 6520 7365 7269 6573 2074  he time series t
-00038a20: 6f20 6163 636f 756e 7420 666f 7220 696e  o account for in
-00038a30: 6974 6961 6c20 6d61 676e 6574 6963 2073  itial magnetic s
-00038a40: 6174 7572 6174 696f 6e20 6566 6665 6374  aturation effect
-00038a50: 7320 6f72 2074 6f20 616c 6c6f 7720 7468  s or to allow th
-00038a60: 6520 7369 676e 616c 2074 6f20 7265 6163  e signal to reac
-00038a70: 6820 6120 7374 6561 6479 2073 7461 7465  h a steady state
-00038a80: 2e20 696e 2073 6f6d 6520 6361 7365 732c  . in some cases,
-00038a90: 2074 7261 696c 696e 6720 766f 6c75 6d65   trailing volume
-00038aa0: 7320 6f72 206f 7468 6572 206f 7574 6c69  s or other outli
-00038ab0: 6572 2076 6f6c 756d 6573 206d 6179 206e  er volumes may n
-00038ac0: 6565 6420 746f 2062 6520 7265 6a65 6374  eed to be reject
-00038ad0: 6564 2e20 2074 6869 7320 636f 6465 2064  ed.  this code d
-00038ae0: 6f65 7320 6e6f 7420 6375 7272 656e 746c  oes not currentl
-00038af0: 7920 6861 6e64 6c65 2074 6861 7420 6973  y handle that is
-00038b00: 7375 652e 0a0a 2020 6d30 5f69 6d61 6765  sue...  m0_image
-00038b10: 3a20 6120 7072 652d 6465 6669 6e65 6420  : a pre-defined 
-00038b20: 6d30 2069 6d61 6765 202d 2077 6520 6578  m0 image - we ex
-00038b30: 7065 6374 2074 6869 7320 746f 2062 6520  pect this to be 
-00038b40: 3344 2e20 2069 6620 6974 2069 7320 6e6f  3D.  if it is no
-00038b50: 742c 2077 6520 6e61 6976 656c 7920 0a20  t, we naively . 
-00038b60: 2020 2061 7665 7261 6765 206f 7665 7220     average over 
-00038b70: 7468 6520 3474 6820 6469 6d65 6e73 696f  the 4th dimensio
-00038b80: 6e2e 0a0a 2020 6d30 5f69 6e64 6963 6573  n...  m0_indices
-00038b90: 3a20 7768 6963 6820 696e 6469 6365 7320  : which indices 
-00038ba0: 696e 2074 6865 2070 6572 6675 7369 6f6e  in the perfusion
-00038bb0: 2069 6d61 6765 2061 7265 2074 6865 206d   image are the m
-00038bc0: 302e 2020 6966 2073 6574 2c20 6e5f 746f  0.  if set, n_to
-00038bd0: 5f74 7269 6d20 7769 6c6c 2062 6520 6967  _trim will be ig
-00038be0: 6e6f 7265 642e 0a0a 2020 6f75 746c 6965  nored...  outlie
-00038bf0: 725f 7468 7265 7368 6f6c 6420 286e 756d  r_threshold (num
-00038c00: 6572 6963 293a 2062 6574 7765 656e 207a  eric): between z
-00038c10: 6572 6f20 2872 656d 6f76 6520 616c 6c29  ero (remove all)
-00038c20: 2061 6e64 206f 6e65 2028 7265 6d6f 7665   and one (remove
-00038c30: 206e 6f6e 6529 3b20 6175 746f 6d61 7469   none); automati
-00038c40: 6361 6c6c 7920 6361 6c63 756c 6174 6573  cally calculates
-00038c50: 206f 7574 6c69 6572 6e65 7373 2061 6e64   outlierness and
-00038c60: 2075 7365 7320 6974 2074 6f20 6365 6e73   uses it to cens
-00038c70: 6f72 2074 6865 2074 696d 6520 7365 7269  or the time seri
-00038c80: 6573 2e0a 0a20 2061 6464 5f46 445f 746f  es...  add_FD_to
-00038c90: 5f6e 7569 7361 6e63 653a 2062 6f6f 6c65  _nuisance: boole
-00038ca0: 616e 0a0a 2020 6e33 3a20 626f 6f6c 6561  an..  n3: boolea
-00038cb0: 6e0a 0a20 2073 6567 6d65 6e74 5f74 696d  n..  segment_tim
-00038cc0: 6573 6572 6965 7320 3a20 626f 6f6c 6561  eseries : boolea
-00038cd0: 6e0a 0a20 2074 7269 6d5f 7468 655f 6d61  n..  trim_the_ma
-00038ce0: 736b 203a 2066 6c6f 6174 203e 3d20 3020  sk : float >= 0 
-00038cf0: 706f 7374 2d68 6f63 206d 6574 686f 6420  post-hoc method 
-00038d00: 666f 7220 7472 696d 6d69 6e67 2074 6865  for trimming the
-00038d10: 206d 6173 6b0a 0a20 2075 7073 616d 706c   mask..  upsampl
-00038d20: 653a 2062 6f6f 6c65 616e 0a0a 2020 7065  e: boolean..  pe
-00038d30: 7266 7573 696f 6e5f 7265 6772 6573 7369  rfusion_regressi
-00038d40: 6f6e 5f6d 6f64 656c 3a20 7374 7269 6e67  on_model: string
-00038d50: 2027 6c69 6e65 6172 272c 2027 7261 6e73   'linear', 'rans
-00038d60: 6163 272c 2027 7468 6569 6c73 656e 272c  ac', 'theilsen',
-00038d70: 2027 6875 6265 7227 2c20 2771 7561 6e74   'huber', 'quant
-00038d80: 696c 6527 2c20 2773 6764 273b 2027 6c69  ile', 'sgd'; 'li
-00038d90: 6e65 6172 2720 616e 6420 2768 7562 6572  near' and 'huber
-00038da0: 2720 6172 6520 7468 6520 6f6e 6c79 206f  ' are the only o
-00038db0: 6e65 7320 7468 6174 2077 6f72 6b20 6f6b  nes that work ok
-00038dc0: 2062 7920 6465 6661 756c 7420 616e 6420   by default and 
-00038dd0: 6172 6520 7265 6c61 7469 7665 6c79 2071  are relatively q
-00038de0: 7569 636b 2074 6f20 636f 6d70 7574 652e  uick to compute.
-00038df0: 0a0a 2020 7665 7262 6f73 6520 3a20 626f  ..  verbose : bo
-00038e00: 6f6c 6561 6e0a 0a20 2052 6574 7572 6e73  olean..  Returns
-00038e10: 0a20 202d 2d2d 2d2d 2d2d 2d2d 0a20 2061  .  ---------.  a
-00038e20: 2064 6963 7469 6f6e 6172 7920 636f 6e74   dictionary cont
-00038e30: 6169 6e69 6e67 2074 6865 2064 6572 6976  aining the deriv
-00038e40: 6564 206e 6574 776f 726b 206d 6170 730a  ed network maps.
-00038e50: 0a20 2022 2222 0a20 2069 6d70 6f72 7420  .  """.  import 
-00038e60: 6e75 6d70 7920 6173 206e 700a 2020 696d  numpy as np.  im
-00038e70: 706f 7274 2070 616e 6461 7320 6173 2070  port pandas as p
-00038e80: 640a 2020 696d 706f 7274 2072 650a 2020  d.  import re.  
-00038e90: 696d 706f 7274 206d 6174 680a 2020 6672  import math.  fr
-00038ea0: 6f6d 2073 6b6c 6561 726e 2e6c 696e 6561  om sklearn.linea
-00038eb0: 725f 6d6f 6465 6c20 696d 706f 7274 2052  r_model import R
-00038ec0: 414e 5341 4352 6567 7265 7373 6f72 2c20  ANSACRegressor, 
-00038ed0: 5468 6569 6c53 656e 5265 6772 6573 736f  TheilSenRegresso
-00038ee0: 722c 2048 7562 6572 5265 6772 6573 736f  r, HuberRegresso
-00038ef0: 722c 2051 7561 6e74 696c 6552 6567 7265  r, QuantileRegre
-00038f00: 7373 6f72 2c20 4c69 6e65 6172 5265 6772  ssor, LinearRegr
-00038f10: 6573 7369 6f6e 2c20 5347 4452 6567 7265  ession, SGDRegre
-00038f20: 7373 6f72 0a20 2066 726f 6d20 736b 6c65  ssor.  from skle
-00038f30: 6172 6e2e 6d75 6c74 696f 7574 7075 7420  arn.multioutput 
-00038f40: 696d 706f 7274 204d 756c 7469 4f75 7470  import MultiOutp
-00038f50: 7574 5265 6772 6573 736f 720a 2020 6672  utRegressor.  fr
-00038f60: 6f6d 2073 6b6c 6561 726e 2e70 7265 7072  om sklearn.prepr
-00038f70: 6f63 6573 7369 6e67 2069 6d70 6f72 7420  ocessing import 
-00038f80: 5374 616e 6461 7264 5363 616c 6572 0a0a  StandardScaler..
-00038f90: 2020 2320 7265 6d6f 7665 206f 7574 6c69    # remove outli
-00038fa0: 6572 2076 6f6c 756d 6573 0a20 2069 6620  er volumes.  if 
-00038fb0: 7365 676d 656e 745f 7469 6d65 7365 7269  segment_timeseri
-00038fc0: 6573 3a0a 2020 2020 6c6f 5f76 735f 6869  es:.    lo_vs_hi
-00038fd0: 6768 203d 2073 6567 6d65 6e74 5f74 696d  gh = segment_tim
-00038fe0: 6573 6572 6965 735f 6279 5f6d 6561 6e76  eseries_by_meanv
-00038ff0: 616c 7565 2866 6d72 6929 0a20 2020 2066  alue(fmri).    f
-00039000: 6d72 6920 3d20 7265 6d6f 7665 5f76 6f6c  mri = remove_vol
-00039010: 756d 6573 5f66 726f 6d5f 7469 6d65 7365  umes_from_timese
-00039020: 7269 6573 2820 666d 7269 2c20 6c6f 5f76  ries( fmri, lo_v
-00039030: 735f 6869 6768 5b27 6c6f 7765 726d 6561  s_high['lowermea
-00039040: 6e73 275d 2029 0a0a 2020 6578 5f70 6174  ns'] )..  ex_pat
-00039050: 6820 3d20 6f73 2e70 6174 682e 6578 7061  h = os.path.expa
-00039060: 6e64 7573 6572 2820 227e 2f2e 616e 7473  nduser( "~/.ants
-00039070: 7079 7431 772f 2220 290a 2020 636e 7863  pyt1w/" ).  cnxc
-00039080: 7376 666e 203d 2065 785f 7061 7468 202b  svfn = ex_path +
-00039090: 2022 646b 745f 636f 7274 6578 5f63 6974   "dkt_cortex_cit
-000390a0: 5f64 6565 705f 6272 6169 6e2e 6373 7622  _deep_brain.csv"
-000390b0: 0a0a 2020 6966 206e 333a 0a20 2020 2066  ..  if n3:.    f
-000390c0: 6d72 6920 3d20 7469 6d65 7365 7269 6573  mri = timeseries
-000390d0: 5f6e 3328 2066 6d72 6920 290a 0a20 2069  _n3( fmri )..  i
-000390e0: 6620 6d30 5f69 6d61 6765 2069 7320 6e6f  f m0_image is no
-000390f0: 7420 4e6f 6e65 3a0a 2020 2020 6966 206d  t None:.    if m
-00039100: 305f 696d 6167 652e 6469 6d65 6e73 696f  0_image.dimensio
-00039110: 6e20 3d3d 2034 3a0a 2020 2020 2020 6d30  n == 4:.      m0
-00039120: 5f69 6d61 6765 203d 2061 6e74 732e 6765  _image = ants.ge
-00039130: 745f 6176 6572 6167 655f 6f66 5f74 696d  t_average_of_tim
-00039140: 6573 6572 6965 7328 206d 305f 696d 6167  eseries( m0_imag
-00039150: 6520 290a 0a20 2064 6566 2073 656c 6563  e )..  def selec
-00039160: 745f 7265 6772 6573 7369 6f6e 5f6d 6f64  t_regression_mod
-00039170: 656c 2872 6567 7265 7373 696f 6e5f 6d6f  el(regression_mo
-00039180: 6465 6c2c 206d 696e 5f73 616d 706c 6573  del, min_samples
-00039190: 3d31 3020 293a 0a20 2020 2069 6620 7265  =10 ):.    if re
-000391a0: 6772 6573 7369 6f6e 5f6d 6f64 656c 203d  gression_model =
-000391b0: 3d20 2773 6764 2720 3a0a 2020 2020 2020  = 'sgd' :.      
-000391c0: 7367 645f 7265 6772 6573 736f 7220 3d20  sgd_regressor = 
-000391d0: 5347 4452 6567 7265 7373 6f72 2870 656e  SGDRegressor(pen
-000391e0: 616c 7479 3d27 656c 6173 7469 636e 6574  alty='elasticnet
-000391f0: 272c 2061 6c70 6861 3d31 652d 352c 206c  ', alpha=1e-5, l
-00039200: 315f 7261 7469 6f3d 302e 3135 2c20 6d61  1_ratio=0.15, ma
-00039210: 785f 6974 6572 3d32 3030 3030 2c20 746f  x_iter=20000, to
-00039220: 6c3d 3165 2d33 2c20 7261 6e64 6f6d 5f73  l=1e-3, random_s
-00039230: 7461 7465 3d34 3229 0a20 2020 2020 2072  tate=42).      r
-00039240: 6574 7572 6e20 7367 645f 7265 6772 6573  eturn sgd_regres
-00039250: 736f 720a 2020 2020 656c 6966 2072 6567  sor.    elif reg
-00039260: 7265 7373 696f 6e5f 6d6f 6465 6c20 3d3d  ression_model ==
-00039270: 2027 7261 6e73 6163 273a 0a20 2020 2020   'ransac':.     
-00039280: 2072 616e 7361 6320 3d20 5241 4e53 4143   ransac = RANSAC
-00039290: 5265 6772 6573 736f 7228 0a20 2020 2020  Regressor(.     
-000392a0: 2020 2020 2020 206d 696e 5f73 616d 706c         min_sampl
-000392b0: 6573 3d30 2e38 2c0a 2020 2020 2020 2020  es=0.8,.        
-000392c0: 2020 2020 6d61 785f 7472 6961 6c73 3d31      max_trials=1
-000392d0: 302c 2020 2020 2020 2020 2023 204d 6178  0,         # Max
-000392e0: 696d 756d 206e 756d 6265 7220 6f66 2069  imum number of i
-000392f0: 7465 7261 7469 6f6e 730a 2320 2020 2020  terations.#     
-00039300: 2020 2020 2020 206d 696e 5f73 616d 706c         min_sampl
-00039310: 6573 3d6d 696e 5f73 616d 706c 6573 2c20  es=min_samples, 
-00039320: 2320 4d69 6e69 6d75 6d20 6e75 6d62 6572  # Minimum number
-00039330: 2073 616d 706c 6573 2074 6f20 6265 2063   samples to be c
-00039340: 686f 7365 6e20 6173 2069 6e6c 6965 7273  hosen as inliers
-00039350: 2069 6e20 6561 6368 2069 7465 7261 7469   in each iterati
-00039360: 6f6e 0a23 2020 2020 2020 2020 2020 2020  on.#            
-00039370: 7374 6f70 5f70 726f 6261 6269 6c69 7479  stop_probability
-00039380: 3d30 2e38 302c 2020 2320 5072 6f62 6162  =0.80,  # Probab
-00039390: 696c 6974 7920 746f 2073 746f 7020 7468  ility to stop th
-000393a0: 6520 616c 676f 7269 7468 6d20 6966 2061  e algorithm if a
-000393b0: 2067 6f6f 6420 7375 6273 6574 2069 7320   good subset is 
-000393c0: 666f 756e 640a 2320 2020 2020 2020 2020  found.#         
-000393d0: 2020 2073 746f 705f 6e5f 696e 6c69 6572     stop_n_inlier
-000393e0: 733d 3430 2c20 2020 2020 2023 2053 746f  s=40,      # Sto
-000393f0: 7020 6966 2074 6869 7320 6e75 6d62 6572  p if this number
-00039400: 206f 6620 696e 6c69 6572 7320 6973 2066   of inliers is f
-00039410: 6f75 6e64 0a23 2020 2020 2020 2020 2020  ound.#          
-00039420: 2020 7374 6f70 5f73 636f 7265 3d30 2e38    stop_score=0.8
-00039430: 2c20 2020 2020 2020 2020 2320 5374 6f70  ,         # Stop
-00039440: 2069 6620 7468 6520 6d6f 6465 6c20 7363   if the model sc
-00039450: 6f72 6520 7265 6163 6865 7320 7468 6973  ore reaches this
-00039460: 2076 616c 7565 0a23 2020 2020 2020 2020   value.#        
-00039470: 2020 2020 6e5f 6a6f 6273 3d69 6e74 286f      n_jobs=int(o
-00039480: 732e 6765 7465 6e76 2822 4954 4b5f 474c  s.getenv("ITK_GL
-00039490: 4f42 414c 5f44 4546 4155 4c54 5f4e 554d  OBAL_DEFAULT_NUM
-000394a0: 4245 525f 4f46 5f54 4852 4541 4453 2229  BER_OF_THREADS")
-000394b0: 2920 2320 5573 6520 616c 6c20 6176 6169  ) # Use all avai
-000394c0: 6c61 626c 6520 4350 5520 636f 7265 7320  lable CPU cores 
-000394d0: 666f 7220 7061 7261 6c6c 656c 2070 726f  for parallel pro
-000394e0: 6365 7373 696e 670a 2020 2020 2020 2020  cessing.        
-000394f0: 290a 2020 2020 2020 7265 7475 726e 2072  ).      return r
-00039500: 616e 7361 630a 2020 2020 6d6f 6465 6c73  ansac.    models
-00039510: 203d 207b 0a20 2020 2020 2020 2027 7367   = {.        'sg
-00039520: 6427 3a53 4744 5265 6772 6573 736f 722c  d':SGDRegressor,
-00039530: 0a20 2020 2020 2020 2027 7261 6e73 6163  .        'ransac
-00039540: 273a 2052 414e 5341 4352 6567 7265 7373  ': RANSACRegress
-00039550: 6f72 2c0a 2020 2020 2020 2020 2774 6865  or,.        'the
-00039560: 696c 7365 6e27 3a20 5468 6569 6c53 656e  ilsen': TheilSen
-00039570: 5265 6772 6573 736f 722c 0a20 2020 2020  Regressor,.     
-00039580: 2020 2027 6875 6265 7227 3a20 4875 6265     'huber': Hube
-00039590: 7252 6567 7265 7373 6f72 2c0a 2020 2020  rRegressor,.    
-000395a0: 2020 2020 2771 7561 6e74 696c 6527 3a20      'quantile': 
-000395b0: 5175 616e 7469 6c65 5265 6772 6573 736f  QuantileRegresso
-000395c0: 720a 2020 2020 7d0a 2020 2020 7265 7475  r.    }.    retu
-000395d0: 726e 206d 6f64 656c 732e 6765 7428 7265  rn models.get(re
-000395e0: 6772 6573 7369 6f6e 5f6d 6f64 656c 2e6c  gression_model.l
-000395f0: 6f77 6572 2829 2c20 4c69 6e65 6172 5265  ower(), LinearRe
-00039600: 6772 6573 7369 6f6e 2928 290a 0a20 2064  gression)()..  d
-00039610: 6566 2072 6570 6c69 6361 7465 5f6c 6973  ef replicate_lis
-00039620: 7428 7573 6572 5f6c 6973 742c 2074 6172  t(user_list, tar
-00039630: 6765 745f 7369 7a65 293a 0a20 2020 2023  get_size):.    #
-00039640: 2043 616c 6375 6c61 7465 2074 6865 206e   Calculate the n
-00039650: 756d 6265 7220 6f66 2074 696d 6573 2074  umber of times t
-00039660: 6865 206c 6973 7420 7368 6f75 6c64 2062  he list should b
-00039670: 6520 7265 706c 6963 6174 6564 0a20 2020  e replicated.   
-00039680: 2072 6570 6c69 6361 7469 6f6e 5f66 6163   replication_fac
-00039690: 746f 7220 3d20 7461 7267 6574 5f73 697a  tor = target_siz
-000396a0: 6520 2f2f 206c 656e 2875 7365 725f 6c69  e // len(user_li
-000396b0: 7374 290a 2020 2020 2320 5265 706c 6963  st).    # Replic
-000396c0: 6174 6520 7468 6520 6c69 7374 2061 6e64  ate the list and
-000396d0: 2068 616e 646c 6520 616e 7920 7265 6d61   handle any rema
-000396e0: 696e 696e 6720 656c 656d 656e 7473 0a20  ining elements. 
-000396f0: 2020 2072 6570 6c69 6361 7465 645f 6c69     replicated_li
-00039700: 7374 203d 2075 7365 725f 6c69 7374 202a  st = user_list *
-00039710: 2072 6570 6c69 6361 7469 6f6e 5f66 6163   replication_fac
-00039720: 746f 720a 2020 2020 7265 6d61 696e 696e  tor.    remainin
-00039730: 675f 656c 656d 656e 7473 203d 2074 6172  g_elements = tar
-00039740: 6765 745f 7369 7a65 2025 206c 656e 2875  get_size % len(u
-00039750: 7365 725f 6c69 7374 290a 2020 2020 7265  ser_list).    re
-00039760: 706c 6963 6174 6564 5f6c 6973 7420 2b3d  plicated_list +=
-00039770: 2075 7365 725f 6c69 7374 5b3a 7265 6d61   user_list[:rema
-00039780: 696e 696e 675f 656c 656d 656e 7473 5d0a  ining_elements].
-00039790: 2020 2020 7265 7475 726e 2072 6570 6c69      return repli
-000397a0: 6361 7465 645f 6c69 7374 0a0a 2020 6465  cated_list..  de
-000397b0: 6620 6f6e 655f 686f 745f 656e 636f 6465  f one_hot_encode
-000397c0: 2863 6861 725f 6c69 7374 293a 0a20 2020  (char_list):.   
-000397d0: 2075 6e69 7175 655f 6368 6172 7320 3d20   unique_chars = 
-000397e0: 6c69 7374 2873 6574 2863 6861 725f 6c69  list(set(char_li
-000397f0: 7374 2929 0a20 2020 2065 6e63 6f64 696e  st)).    encodin
-00039800: 675f 6469 6374 203d 207b 6368 6172 3a20  g_dict = {char: 
-00039810: 5b31 2069 6620 6368 6172 203d 3d20 6320  [1 if char == c 
-00039820: 656c 7365 2030 2066 6f72 2063 2069 6e20  else 0 for c in 
-00039830: 756e 6971 7565 5f63 6861 7273 5d20 666f  unique_chars] fo
-00039840: 7220 6368 6172 2069 6e20 756e 6971 7565  r char in unique
-00039850: 5f63 6861 7273 7d0a 2020 2020 656e 636f  _chars}.    enco
-00039860: 6465 645f 6d61 7472 6978 203d 206e 702e  ded_matrix = np.
-00039870: 6172 7261 7928 5b65 6e63 6f64 696e 675f  array([encoding_
-00039880: 6469 6374 5b63 6861 725d 2066 6f72 2063  dict[char] for c
-00039890: 6861 7220 696e 2063 6861 725f 6c69 7374  har in char_list
-000398a0: 5d29 0a20 2020 2072 6574 7572 6e20 656e  ]).    return en
-000398b0: 636f 6465 645f 6d61 7472 6978 0a20 200a  coded_matrix.  .
-000398c0: 2020 4120 3d20 6e70 2e7a 6572 6f73 2828    A = np.zeros((
-000398d0: 312c 3129 290a 2020 2320 666d 7269 203d  1,1)).  # fmri =
-000398e0: 2061 6e74 732e 694d 6174 6828 2066 6d72   ants.iMath( fmr
-000398f0: 692c 2027 4e6f 726d 616c 697a 6527 2029  i, 'Normalize' )
-00039900: 0a20 2066 6d72 695f 7465 6d70 6c61 7465  .  fmri_template
-00039910: 2c20 686c 696e 6473 203d 206c 6f6f 705f  , hlinds = loop_
-00039920: 7469 6d65 7365 7269 6573 5f63 656e 736f  timeseries_censo
-00039930: 7269 6e67 2820 666d 7269 2c20 302e 3130  ring( fmri, 0.10
-00039940: 2029 0a20 2066 6d72 695f 7465 6d70 6c61   ).  fmri_templa
-00039950: 7465 203d 2061 6e74 732e 6765 745f 6176  te = ants.get_av
-00039960: 6572 6167 655f 6f66 5f74 696d 6573 6572  erage_of_timeser
-00039970: 6965 7328 2066 6d72 695f 7465 6d70 6c61  ies( fmri_templa
-00039980: 7465 2029 0a20 2064 656c 2068 6c69 6e64  te ).  del hlind
-00039990: 730a 2020 7269 6720 3d20 616e 7473 2e72  s.  rig = ants.r
-000399a0: 6567 6973 7472 6174 696f 6e28 2066 6d72  egistration( fmr
-000399b0: 695f 7465 6d70 6c61 7465 2c20 7431 6865  i_template, t1he
-000399c0: 6164 2c20 2742 4f4c 4452 6967 6964 2720  ad, 'BOLDRigid' 
-000399d0: 290a 2020 626d 6173 6b20 3d20 616e 7473  ).  bmask = ants
-000399e0: 2e61 7070 6c79 5f74 7261 6e73 666f 726d  .apply_transform
-000399f0: 7328 2066 6d72 695f 7465 6d70 6c61 7465  s( fmri_template
-00039a00: 2c20 616e 7473 2e74 6872 6573 686f 6c64  , ants.threshold
-00039a10: 5f69 6d61 6765 2874 3173 6567 6d65 6e74  _image(t1segment
-00039a20: 6174 696f 6e2c 312c 3629 2c20 7269 675b  ation,1,6), rig[
-00039a30: 2766 7764 7472 616e 7366 6f72 6d73 275d  'fwdtransforms']
-00039a40: 5b30 5d2c 2069 6e74 6572 706f 6c61 746f  [0], interpolato
-00039a50: 723d 2767 656e 6572 6963 4c61 6265 6c27  r='genericLabel'
-00039a60: 2029 0a20 2069 6620 6d30 5f69 6e64 6963   ).  if m0_indic
-00039a70: 6573 2069 7320 4e6f 6e65 3a0a 2020 2020  es is None:.    
-00039a80: 6966 206e 5f74 6f5f 7472 696d 2069 7320  if n_to_trim is 
-00039a90: 4e6f 6e65 3a0a 2020 2020 2020 2020 6e5f  None:.        n_
-00039aa0: 746f 5f74 7269 6d3d 300a 2020 2020 6d79  to_trim=0.    my
-00039ab0: 7472 696d 3d6e 5f74 6f5f 7472 696d 0a20  trim=n_to_trim. 
-00039ac0: 2065 6c73 653a 0a20 2020 206d 7974 7269   else:.    mytri
-00039ad0: 6d20 3d20 300a 2020 7065 7266 5f74 6f74  m = 0.  perf_tot
-00039ae0: 616c 5f73 6967 6d61 203d 2031 2e35 0a20  al_sigma = 1.5. 
-00039af0: 2063 6f72 726d 6f20 3d20 7469 6d65 7365   corrmo = timese
-00039b00: 7269 6573 5f72 6567 280a 2020 2020 666d  ries_reg(.    fm
-00039b10: 7269 2c20 666d 7269 5f74 656d 706c 6174  ri, fmri_templat
-00039b20: 652c 0a20 2020 2074 7970 655f 6f66 5f74  e,.    type_of_t
-00039b30: 7261 6e73 666f 726d 3d74 7970 655f 6f66  ransform=type_of
-00039b40: 5f74 7261 6e73 666f 726d 2c0a 2020 2020  _transform,.    
-00039b50: 746f 7461 6c5f 7369 676d 613d 7065 7266  total_sigma=perf
-00039b60: 5f74 6f74 616c 5f73 6967 6d61 2c0a 2020  _total_sigma,.  
-00039b70: 2020 6664 4f66 6673 6574 3d32 2e30 2c0a    fdOffset=2.0,.
-00039b80: 2020 2020 7472 696d 203d 206d 7974 7269      trim = mytri
-00039b90: 6d2c 0a20 2020 206f 7574 7075 745f 6469  m,.    output_di
-00039ba0: 7265 6374 6f72 793d 4e6f 6e65 2c0a 2020  rectory=None,.  
-00039bb0: 2020 7665 7262 6f73 653d 7665 7262 6f73    verbose=verbos
-00039bc0: 652c 0a20 2020 2073 796e 5f6d 6574 7269  e,.    syn_metri
-00039bd0: 633d 2763 6327 2c0a 2020 2020 7379 6e5f  c='cc',.    syn_
-00039be0: 7361 6d70 6c69 6e67 3d32 2c0a 2020 2020  sampling=2,.    
-00039bf0: 7265 675f 6974 6572 6174 696f 6e73 3d5b  reg_iterations=[
-00039c00: 3430 2c32 302c 355d 2029 0a20 2069 6620  40,20,5] ).  if 
-00039c10: 7665 7262 6f73 653a 0a20 2020 2020 2070  verbose:.      p
-00039c20: 7269 6e74 2822 456e 6420 7273 666d 7269  rint("End rsfmri
-00039c30: 206d 6f74 696f 6e20 636f 7272 6563 7469   motion correcti
-00039c40: 6f6e 2229 0a0a 2020 6966 206d 305f 696d  on")..  if m0_im
-00039c50: 6167 6520 6973 206e 6f74 204e 6f6e 653a  age is not None:
-00039c60: 0a20 2020 2020 206d 3020 3d20 6d30 5f69  .      m0 = m0_i
-00039c70: 6d61 6765 0a20 2065 6c69 6620 6d30 5f69  mage.  elif m0_i
-00039c80: 6e64 6963 6573 2069 7320 6e6f 7420 4e6f  ndices is not No
-00039c90: 6e65 3a0a 2020 2020 6e6f 745f 6d30 203d  ne:.    not_m0 =
-00039ca0: 206c 6973 7428 2072 616e 6765 2820 666d   list( range( fm
-00039cb0: 7269 2e73 6861 7065 5b33 5d20 2920 290a  ri.shape[3] ) ).
-00039cc0: 2020 2020 6e6f 745f 6d30 203d 205b 7820      not_m0 = [x 
-00039cd0: 666f 7220 7820 696e 206e 6f74 5f6d 3020  for x in not_m0 
-00039ce0: 6966 2078 206e 6f74 2069 6e20 6d30 5f69  if x not in m0_i
-00039cf0: 6e64 6963 6573 5d0a 2020 2020 6966 2076  ndices].    if v
-00039d00: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-00039d10: 7072 696e 7428 206d 305f 696e 6469 6365  print( m0_indice
-00039d20: 7320 290a 2020 2020 2020 2020 7072 696e  s ).        prin
-00039d30: 7428 206e 6f74 5f6d 3020 290a 2020 2020  t( not_m0 ).    
-00039d40: 2320 7468 656e 2072 656d 6f76 6520 6974  # then remove it
-00039d50: 2066 726f 6d20 7468 6520 7469 6d65 2073   from the time s
-00039d60: 6572 6965 730a 2020 2020 6d30 203d 2072  eries.    m0 = r
-00039d70: 656d 6f76 655f 766f 6c75 6d65 735f 6672  emove_volumes_fr
-00039d80: 6f6d 5f74 696d 6573 6572 6965 7328 2063  om_timeseries( c
-00039d90: 6f72 726d 6f5b 276d 6f74 696f 6e5f 636f  orrmo['motion_co
-00039da0: 7272 6563 7465 6427 5d2c 206e 6f74 5f6d  rrected'], not_m
-00039db0: 3020 290a 2020 2020 6d30 203d 2061 6e74  0 ).    m0 = ant
-00039dc0: 732e 6765 745f 6176 6572 6167 655f 6f66  s.get_average_of
-00039dd0: 5f74 696d 6573 6572 6965 7328 206d 3020  _timeseries( m0 
-00039de0: 290a 2020 2020 636f 7272 6d6f 5b27 6d6f  ).    corrmo['mo
-00039df0: 7469 6f6e 5f63 6f72 7265 6374 6564 275d  tion_corrected']
-00039e00: 203d 2072 656d 6f76 655f 766f 6c75 6d65   = remove_volume
-00039e10: 735f 6672 6f6d 5f74 696d 6573 6572 6965  s_from_timeserie
-00039e20: 7328 200a 2020 2020 2020 2020 636f 7272  s( .        corr
-00039e30: 6d6f 5b27 6d6f 7469 6f6e 5f63 6f72 7265  mo['motion_corre
-00039e40: 6374 6564 275d 2c20 6d30 5f69 6e64 6963  cted'], m0_indic
-00039e50: 6573 2029 0a20 2020 2063 6f72 726d 6f5b  es ).    corrmo[
-00039e60: 2746 4427 5d20 3d20 7265 6d6f 7665 5f65  'FD'] = remove_e
-00039e70: 6c65 6d65 6e74 735f 6672 6f6d 5f6e 756d  lements_from_num
-00039e80: 7079 5f61 7272 6179 2820 636f 7272 6d6f  py_array( corrmo
-00039e90: 5b27 4644 275d 2c20 6d30 5f69 6e64 6963  ['FD'], m0_indic
-00039ea0: 6573 2029 0a20 2020 2066 6d72 6920 3d20  es ).    fmri = 
-00039eb0: 7265 6d6f 7665 5f76 6f6c 756d 6573 5f66  remove_volumes_f
-00039ec0: 726f 6d5f 7469 6d65 7365 7269 6573 2820  rom_timeseries( 
-00039ed0: 666d 7269 2c20 6d30 5f69 6e64 6963 6573  fmri, m0_indices
-00039ee0: 2029 0a0a 2020 6e74 7020 3d20 636f 7272   )..  ntp = corr
-00039ef0: 6d6f 5b27 6d6f 7469 6f6e 5f63 6f72 7265  mo['motion_corre
-00039f00: 6374 6564 275d 2e73 6861 7065 5b33 5d0a  cted'].shape[3].
-00039f10: 2020 6966 2074 6320 3d3d 2027 616c 7465    if tc == 'alte
-00039f20: 726e 6174 696e 6727 3a0a 2020 2020 2020  rnating':.      
-00039f30: 7463 6c69 7374 203d 2072 6570 6c69 6361  tclist = replica
-00039f40: 7465 5f6c 6973 7428 205b 2743 272c 2754  te_list( ['C','T
-00039f50: 275d 2c20 6e74 7020 290a 2020 656c 7365  '], ntp ).  else
-00039f60: 3a0a 2020 2020 2020 7463 6c69 7374 203d  :.      tclist =
-00039f70: 2072 6570 6c69 6361 7465 5f6c 6973 7428   replicate_list(
-00039f80: 205b 2743 275d 2c20 696e 7428 6e74 702f   ['C'], int(ntp/
-00039f90: 3229 2029 202b 2072 6570 6c69 6361 7465  2) ) + replicate
-00039fa0: 5f6c 6973 7428 205b 2754 275d 2c20 2069  _list( ['T'],  i
-00039fb0: 6e74 286e 7470 2f32 2920 290a 0a20 2074  nt(ntp/2) )..  t
-00039fc0: 636c 6973 7420 3d20 6f6e 655f 686f 745f  clist = one_hot_
-00039fd0: 656e 636f 6465 2820 7463 6c69 7374 5b30  encode( tclist[0
-00039fe0: 3a6e 7470 205d 2029 0a20 2066 6d72 696d  :ntp ] ).  fmrim
-00039ff0: 6f74 636f 7272 3d63 6f72 726d 6f5b 276d  otcorr=corrmo['m
-0003a000: 6f74 696f 6e5f 636f 7272 6563 7465 6427  otion_corrected'
-0003a010: 5d0a 2020 6966 206f 7574 6c69 6572 5f74  ].  if outlier_t
-0003a020: 6872 6573 686f 6c64 203c 2031 2e30 2061  hreshold < 1.0 a
-0003a030: 6e64 206f 7574 6c69 6572 5f74 6872 6573  nd outlier_thres
-0003a040: 686f 6c64 203e 2030 2e30 3a0a 2020 2020  hold > 0.0:.    
-0003a050: 666d 7269 6d6f 7463 6f72 722c 2068 6c69  fmrimotcorr, hli
-0003a060: 6e64 7320 3d20 6c6f 6f70 5f74 696d 6573  nds = loop_times
-0003a070: 6572 6965 735f 6365 6e73 6f72 696e 6728  eries_censoring(
-0003a080: 2066 6d72 696d 6f74 636f 7272 2c20 6f75   fmrimotcorr, ou
-0003a090: 746c 6965 725f 7468 7265 7368 6f6c 642c  tlier_threshold,
-0003a0a0: 206d 6173 6b3d 4e6f 6e65 2c20 7665 7262   mask=None, verb
-0003a0b0: 6f73 653d 7665 7262 6f73 6520 290a 2020  ose=verbose ).  
-0003a0c0: 2020 7463 6c69 7374 203d 2072 656d 6f76    tclist = remov
-0003a0d0: 655f 656c 656d 656e 7473 5f66 726f 6d5f  e_elements_from_
-0003a0e0: 6e75 6d70 795f 6172 7261 7928 2074 636c  numpy_array( tcl
-0003a0f0: 6973 742c 2068 6c69 6e64 7329 0a20 2020  ist, hlinds).   
-0003a100: 2063 6f72 726d 6f5b 2746 4427 5d20 3d20   corrmo['FD'] = 
-0003a110: 7265 6d6f 7665 5f65 6c65 6d65 6e74 735f  remove_elements_
-0003a120: 6672 6f6d 5f6e 756d 7079 5f61 7272 6179  from_numpy_array
-0003a130: 2820 636f 7272 6d6f 5b27 4644 275d 2c20  ( corrmo['FD'], 
-0003a140: 686c 696e 6473 2029 0a0a 2020 2320 7265  hlinds )..  # re
-0003a150: 646f 2074 656d 706c 6174 6520 616e 6420  do template and 
-0003a160: 7265 6769 7374 7261 7469 6f6e 2061 7420  registration at 
-0003a170: 2870 6f74 656e 7469 616c 6c79 2920 7570  (potentially) up
-0003a180: 7361 6d70 6c65 6420 7363 616c 650a 2020  sampled scale.  
-0003a190: 666d 7269 5f74 656d 706c 6174 6520 3d20  fmri_template = 
-0003a1a0: 616e 7473 2e69 4d61 7468 2820 616e 7473  ants.iMath( ants
-0003a1b0: 2e67 6574 5f61 7665 7261 6765 5f6f 665f  .get_average_of_
-0003a1c0: 7469 6d65 7365 7269 6573 2820 666d 7269  timeseries( fmri
-0003a1d0: 6d6f 7463 6f72 7220 292c 2022 4e6f 726d  motcorr ), "Norm
-0003a1e0: 616c 697a 6522 2029 0a20 2069 6620 7570  alize" ).  if up
-0003a1f0: 7361 6d70 6c65 3a0a 2020 2020 2020 7370  sample:.      sp
-0003a200: 6320 3d20 616e 7473 2e67 6574 5f73 7061  c = ants.get_spa
-0003a210: 6369 6e67 2820 666d 7269 2029 0a20 2020  cing( fmri ).   
-0003a220: 2020 206d 696e 7370 6320 3d20 322e 300a     minspc = 2.0.
-0003a230: 2020 2020 2020 6966 206d 696e 2873 7063        if min(spc
-0003a240: 5b30 3a33 5d29 203c 206d 696e 7370 633a  [0:3]) < minspc:
-0003a250: 0a20 2020 2020 2020 2020 206d 696e 7370  .          minsp
-0003a260: 6320 3d20 6d69 6e28 7370 635b 303a 335d  c = min(spc[0:3]
-0003a270: 290a 2020 2020 2020 6e65 7773 7063 203d  ).      newspc =
-0003a280: 205b 6d69 6e73 7063 2c6d 696e 7370 632c   [minspc,minspc,
-0003a290: 6d69 6e73 7063 5d0a 2020 2020 2020 666d  minspc].      fm
-0003a2a0: 7269 5f74 656d 706c 6174 6520 3d20 616e  ri_template = an
-0003a2b0: 7473 2e72 6573 616d 706c 655f 696d 6167  ts.resample_imag
-0003a2c0: 6528 2066 6d72 695f 7465 6d70 6c61 7465  e( fmri_template
-0003a2d0: 2c20 6e65 7773 7063 2c20 696e 7465 7270  , newspc, interp
-0003a2e0: 5f74 7970 653d 3020 290a 0a20 2072 6967  _type=0 )..  rig
-0003a2f0: 203d 2061 6e74 732e 7265 6769 7374 7261   = ants.registra
-0003a300: 7469 6f6e 2820 666d 7269 5f74 656d 706c  tion( fmri_templ
-0003a310: 6174 652c 2074 3168 6561 642c 2027 424f  ate, t1head, 'BO
-0003a320: 4c44 5269 6769 6427 2029 0a20 2062 6d61  LDRigid' ).  bma
-0003a330: 736b 203d 2061 6e74 732e 6170 706c 795f  sk = ants.apply_
-0003a340: 7472 616e 7366 6f72 6d73 2820 666d 7269  transforms( fmri
-0003a350: 5f74 656d 706c 6174 652c 200a 2020 2020  _template, .    
-0003a360: 616e 7473 2e74 6872 6573 686f 6c64 5f69  ants.threshold_i
-0003a370: 6d61 6765 2874 3173 6567 6d65 6e74 6174  mage(t1segmentat
-0003a380: 696f 6e2c 312c 3629 2c20 0a20 2020 2072  ion,1,6), .    r
-0003a390: 6967 5b27 6677 6474 7261 6e73 666f 726d  ig['fwdtransform
-0003a3a0: 7327 5d5b 305d 2c20 0a20 2020 2069 6e74  s'][0], .    int
-0003a3b0: 6572 706f 6c61 746f 723d 2767 656e 6572  erpolator='gener
-0003a3c0: 6963 4c61 6265 6c27 2029 0a20 2063 6f72  icLabel' ).  cor
-0003a3d0: 726d 6f20 3d20 7469 6d65 7365 7269 6573  rmo = timeseries
-0003a3e0: 5f72 6567 280a 2020 2020 2020 2020 666d  _reg(.        fm
-0003a3f0: 7269 2c20 666d 7269 5f74 656d 706c 6174  ri, fmri_templat
-0003a400: 652c 0a20 2020 2020 2020 2074 7970 655f  e,.        type_
-0003a410: 6f66 5f74 7261 6e73 666f 726d 3d74 7970  of_transform=typ
-0003a420: 655f 6f66 5f74 7261 6e73 666f 726d 2c0a  e_of_transform,.
-0003a430: 2020 2020 2020 2020 746f 7461 6c5f 7369          total_si
-0003a440: 676d 613d 7065 7266 5f74 6f74 616c 5f73  gma=perf_total_s
-0003a450: 6967 6d61 2c0a 2020 2020 2020 2020 6664  igma,.        fd
-0003a460: 4f66 6673 6574 3d32 2e30 2c0a 2020 2020  Offset=2.0,.    
-0003a470: 2020 2020 7472 696d 203d 206d 7974 7269      trim = mytri
-0003a480: 6d2c 0a20 2020 2020 2020 206f 7574 7075  m,.        outpu
-0003a490: 745f 6469 7265 6374 6f72 793d 4e6f 6e65  t_directory=None
-0003a4a0: 2c0a 2020 2020 2020 2020 7665 7262 6f73  ,.        verbos
-0003a4b0: 653d 7665 7262 6f73 652c 0a20 2020 2020  e=verbose,.     
-0003a4c0: 2020 2073 796e 5f6d 6574 7269 633d 2763     syn_metric='c
-0003a4d0: 6327 2c0a 2020 2020 2020 2020 7379 6e5f  c',.        syn_
-0003a4e0: 7361 6d70 6c69 6e67 3d32 2c0a 2020 2020  sampling=2,.    
-0003a4f0: 2020 2020 7265 675f 6974 6572 6174 696f      reg_iteratio
-0003a500: 6e73 3d5b 3430 2c32 302c 355d 2029 0a20  ns=[40,20,5] ). 
-0003a510: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
-0003a520: 2020 2020 2070 7269 6e74 2822 456e 6420       print("End 
-0003a530: 326e 6420 7273 666d 7269 206d 6f74 696f  2nd rsfmri motio
-0003a540: 6e20 636f 7272 6563 7469 6f6e 2229 0a0a  n correction")..
-0003a550: 2020 6966 206f 7574 6c69 6572 5f74 6872    if outlier_thr
-0003a560: 6573 686f 6c64 203c 2031 2e30 2061 6e64  eshold < 1.0 and
-0003a570: 206f 7574 6c69 6572 5f74 6872 6573 686f   outlier_thresho
-0003a580: 6c64 203e 2030 2e30 3a0a 2020 2020 636f  ld > 0.0:.    co
-0003a590: 7272 6d6f 5b27 6d6f 7469 6f6e 5f63 6f72  rrmo['motion_cor
-0003a5a0: 7265 6374 6564 275d 203d 2072 656d 6f76  rected'] = remov
-0003a5b0: 655f 766f 6c75 6d65 735f 6672 6f6d 5f74  e_volumes_from_t
-0003a5c0: 696d 6573 6572 6965 7328 2063 6f72 726d  imeseries( corrm
-0003a5d0: 6f5b 276d 6f74 696f 6e5f 636f 7272 6563  o['motion_correc
-0003a5e0: 7465 6427 5d2c 2068 6c69 6e64 7320 290a  ted'], hlinds ).
-0003a5f0: 2020 2020 636f 7272 6d6f 5b27 4644 275d      corrmo['FD']
-0003a600: 203d 2072 656d 6f76 655f 656c 656d 656e   = remove_elemen
-0003a610: 7473 5f66 726f 6d5f 6e75 6d70 795f 6172  ts_from_numpy_ar
-0003a620: 7261 7928 2063 6f72 726d 6f5b 2746 4427  ray( corrmo['FD'
-0003a630: 5d2c 2068 6c69 6e64 7320 290a 0a20 2072  ], hlinds )..  r
-0003a640: 6567 7265 7373 696f 6e5f 6d61 736b 203d  egression_mask =
-0003a650: 2062 6d61 736b 2e63 6c6f 6e65 2829 0a20   bmask.clone(). 
-0003a660: 206d 7974 736e 7220 3d20 7473 6e72 2820   mytsnr = tsnr( 
-0003a670: 636f 7272 6d6f 5b27 6d6f 7469 6f6e 5f63  corrmo['motion_c
-0003a680: 6f72 7265 6374 6564 275d 2c20 626d 6173  orrected'], bmas
-0003a690: 6b20 290a 2020 6d79 7473 6e72 5468 7265  k ).  mytsnrThre
-0003a6a0: 7368 203d 206e 702e 7175 616e 7469 6c65  sh = np.quantile
-0003a6b0: 2820 6d79 7473 6e72 2e6e 756d 7079 2829  ( mytsnr.numpy()
-0003a6c0: 2c20 302e 3939 3520 290a 2020 7473 6e72  , 0.995 ).  tsnr
-0003a6d0: 6d61 736b 203d 2061 6e74 732e 7468 7265  mask = ants.thre
-0003a6e0: 7368 6f6c 645f 696d 6167 6528 206d 7974  shold_image( myt
-0003a6f0: 736e 722c 2030 2c20 6d79 7473 6e72 5468  snr, 0, mytsnrTh
-0003a700: 7265 7368 2029 2e6d 6f72 7068 6f6c 6f67  resh ).morpholog
-0003a710: 7928 2263 6c6f 7365 222c 3329 0a20 2062  y("close",3).  b
-0003a720: 6d61 736b 203d 2062 6d61 736b 202a 2061  mask = bmask * a
-0003a730: 6e74 732e 694d 6174 6828 2074 736e 726d  nts.iMath( tsnrm
-0003a740: 6173 6b2c 2022 4669 6c6c 486f 6c65 7322  ask, "FillHoles"
-0003a750: 2029 0a20 2066 6d72 696d 6f74 636f 7272   ).  fmrimotcorr
-0003a760: 3d63 6f72 726d 6f5b 276d 6f74 696f 6e5f  =corrmo['motion_
-0003a770: 636f 7272 6563 7465 6427 5d0a 2020 756e  corrected'].  un
-0003a780: 6420 3d20 666d 7269 5f74 656d 706c 6174  d = fmri_templat
-0003a790: 6520 2a20 626d 6173 6b0a 2020 7431 7265  e * bmask.  t1re
-0003a7a0: 6720 3d20 616e 7473 2e72 6567 6973 7472  g = ants.registr
-0003a7b0: 6174 696f 6e28 2075 6e64 2c20 7431 2c20  ation( und, t1, 
-0003a7c0: 2253 794e 426f 6c64 2220 290a 2020 676d  "SyNBold" ).  gm
-0003a7d0: 7365 6720 3d20 616e 7473 2e74 6872 6573  seg = ants.thres
-0003a7e0: 686f 6c64 5f69 6d61 6765 2820 7431 7365  hold_image( t1se
-0003a7f0: 676d 656e 7461 7469 6f6e 2c20 322c 2032  gmentation, 2, 2
-0003a800: 2029 0a20 2067 6d73 6567 203d 2067 6d73   ).  gmseg = gms
-0003a810: 6567 202b 2061 6e74 732e 7468 7265 7368  eg + ants.thresh
-0003a820: 6f6c 645f 696d 6167 6528 2074 3173 6567  old_image( t1seg
-0003a830: 6d65 6e74 6174 696f 6e2c 2034 2c20 3420  mentation, 4, 4 
-0003a840: 290a 2020 676d 7365 6720 3d20 616e 7473  ).  gmseg = ants
-0003a850: 2e74 6872 6573 686f 6c64 5f69 6d61 6765  .threshold_image
-0003a860: 2820 676d 7365 672c 2031 2c20 3420 290a  ( gmseg, 1, 4 ).
-0003a870: 2020 676d 7365 6720 3d20 616e 7473 2e69    gmseg = ants.i
-0003a880: 4d61 7468 2820 676d 7365 672c 2027 4d44  Math( gmseg, 'MD
-0003a890: 272c 2031 2029 0a20 2067 6d73 6567 203d  ', 1 ).  gmseg =
-0003a8a0: 2061 6e74 732e 6170 706c 795f 7472 616e   ants.apply_tran
-0003a8b0: 7366 6f72 6d73 2820 756e 642c 2067 6d73  sforms( und, gms
-0003a8c0: 6567 2c0a 2020 2020 7431 7265 675b 2766  eg,.    t1reg['f
-0003a8d0: 7764 7472 616e 7366 6f72 6d73 275d 2c20  wdtransforms'], 
-0003a8e0: 696e 7465 7270 6f6c 6174 6f72 203d 2027  interpolator = '
-0003a8f0: 6765 6e65 7269 634c 6162 656c 2720 2920  genericLabel' ) 
-0003a900: 2a20 626d 6173 6b0a 2020 6373 6673 6567  * bmask.  csfseg
-0003a910: 203d 2061 6e74 732e 7468 7265 7368 6f6c   = ants.threshol
-0003a920: 645f 696d 6167 6528 2074 3173 6567 6d65  d_image( t1segme
-0003a930: 6e74 6174 696f 6e2c 2031 2c20 3120 290a  ntation, 1, 1 ).
-0003a940: 2020 776d 7365 6720 3d20 616e 7473 2e74    wmseg = ants.t
-0003a950: 6872 6573 686f 6c64 5f69 6d61 6765 2820  hreshold_image( 
-0003a960: 7431 7365 676d 656e 7461 7469 6f6e 2c20  t1segmentation, 
-0003a970: 332c 2033 2029 0a20 2063 7366 416e 6457  3, 3 ).  csfAndW
-0003a980: 4d20 3d20 2820 6373 6673 6567 202b 2077  M = ( csfseg + w
-0003a990: 6d73 6567 2029 2e6d 6f72 7068 6f6c 6f67  mseg ).morpholog
-0003a9a0: 7928 2265 726f 6465 222c 3129 0a20 2063  y("erode",1).  c
-0003a9b0: 7366 416e 6457 4d20 3d20 616e 7473 2e61  sfAndWM = ants.a
-0003a9c0: 7070 6c79 5f74 7261 6e73 666f 726d 7328  pply_transforms(
-0003a9d0: 2075 6e64 2c20 6373 6641 6e64 574d 2c0a   und, csfAndWM,.
-0003a9e0: 2020 2020 7431 7265 675b 2766 7764 7472      t1reg['fwdtr
-0003a9f0: 616e 7366 6f72 6d73 275d 2c20 696e 7465  ansforms'], inte
-0003aa00: 7270 6f6c 6174 6f72 203d 2027 6e65 6172  rpolator = 'near
-0003aa10: 6573 744e 6569 6768 626f 7227 2029 2020  estNeighbor' )  
-0003aa20: 2a20 626d 6173 6b0a 2020 6373 6673 6567  * bmask.  csfseg
-0003aa30: 203d 2061 6e74 732e 6170 706c 795f 7472   = ants.apply_tr
-0003aa40: 616e 7366 6f72 6d73 2820 756e 642c 2063  ansforms( und, c
-0003aa50: 7366 7365 672c 0a20 2020 2074 3172 6567  sfseg,.    t1reg
-0003aa60: 5b27 6677 6474 7261 6e73 666f 726d 7327  ['fwdtransforms'
-0003aa70: 5d2c 2069 6e74 6572 706f 6c61 746f 7220  ], interpolator 
-0003aa80: 3d20 276e 6561 7265 7374 4e65 6967 6862  = 'nearestNeighb
-0003aa90: 6f72 2720 2920 202a 2062 6d61 736b 0a20  or' )  * bmask. 
-0003aaa0: 2077 6d73 6567 203d 2061 6e74 732e 6170   wmseg = ants.ap
-0003aab0: 706c 795f 7472 616e 7366 6f72 6d73 2820  ply_transforms( 
-0003aac0: 756e 642c 2077 6d73 6567 2c0a 2020 2020  und, wmseg,.    
-0003aad0: 7431 7265 675b 2766 7764 7472 616e 7366  t1reg['fwdtransf
-0003aae0: 6f72 6d73 275d 2c20 696e 7465 7270 6f6c  orms'], interpol
-0003aaf0: 6174 6f72 203d 2027 6e65 6172 6573 744e  ator = 'nearestN
-0003ab00: 6569 6768 626f 7227 2029 2020 2a20 626d  eighbor' )  * bm
-0003ab10: 6173 6b0a 2020 636f 6d70 636f 7271 7561  ask.  compcorqua
-0003ab20: 6e74 696c 653d 302e 3530 0a20 206d 7963  ntile=0.50.  myc
-0003ab30: 6f6d 7063 6f72 203d 2061 6e74 732e 636f  ompcor = ants.co
-0003ab40: 6d70 636f 7228 2066 6d72 696d 6f74 636f  mpcor( fmrimotco
-0003ab50: 7272 2c0a 2020 2020 6e63 6f6d 7063 6f72  rr,.    ncompcor
-0003ab60: 3d6e 632c 2071 7561 6e74 696c 653d 636f  =nc, quantile=co
-0003ab70: 6d70 636f 7271 7561 6e74 696c 652c 206d  mpcorquantile, m
-0003ab80: 6173 6b20 3d20 6373 6641 6e64 574d 2c0a  ask = csfAndWM,.
-0003ab90: 2020 2020 6669 6c74 6572 5f74 7970 653d      filter_type=
-0003aba0: 2770 6f6c 796e 6f6d 6961 6c27 2c20 6465  'polynomial', de
-0003abb0: 6772 6565 3d32 2029 0a20 2074 7220 3d20  gree=2 ).  tr = 
-0003abc0: 616e 7473 2e67 6574 5f73 7061 6369 6e67  ants.get_spacing
-0003abd0: 2820 666d 7269 6d6f 7463 6f72 7220 295b  ( fmrimotcorr )[
-0003abe0: 335d 0a20 2073 696d 6720 3d20 616e 7473  3].  simg = ants
-0003abf0: 2e73 6d6f 6f74 685f 696d 6167 6528 666d  .smooth_image(fm
-0003ac00: 7269 6d6f 7463 6f72 722c 2073 7061 2c20  rimotcorr, spa, 
-0003ac10: 7369 676d 615f 696e 5f70 6879 7369 6361  sigma_in_physica
-0003ac20: 6c5f 636f 6f72 6469 6e61 7465 7320 3d20  l_coordinates = 
-0003ac30: 5472 7565 2029 0a20 206e 7569 7361 6e63  True ).  nuisanc
-0003ac40: 6520 3d20 6d79 636f 6d70 636f 725b 2762  e = mycompcor['b
-0003ac50: 6173 6973 275d 0a20 206e 7569 7361 6e63  asis'].  nuisanc
-0003ac60: 6520 3d20 6e70 2e63 5f5b 206e 7569 7361  e = np.c_[ nuisa
-0003ac70: 6e63 652c 206d 7963 6f6d 7063 6f72 5b27  nce, mycompcor['
-0003ac80: 636f 6d70 6f6e 656e 7473 275d 205d 0a20  components'] ]. 
-0003ac90: 2069 6620 6164 645f 4644 5f74 6f5f 6e75   if add_FD_to_nu
-0003aca0: 6973 616e 6365 3a0a 2020 2020 6e75 6973  isance:.    nuis
-0003acb0: 616e 6365 203d 206e 702e 635f 5b20 6e75  ance = np.c_[ nu
-0003acc0: 6973 616e 6365 2c20 636f 7272 6d6f 5b27  isance, corrmo['
-0003acd0: 4644 275d 205d 0a20 2069 6620 7665 7262  FD'] ].  if verb
-0003ace0: 6f73 653a 0a20 2020 2070 7269 6e74 2822  ose:.    print("
-0003acf0: 6d61 6b65 2073 7572 6520 6e75 6973 616e  make sure nuisan
-0003ad00: 6365 2069 7320 696e 6465 7065 6e64 656e  ce is independen
-0003ad10: 7420 6f66 2054 4322 290a 2020 6e75 6973  t of TC").  nuis
-0003ad20: 616e 6365 203d 2061 6e74 732e 7265 6772  ance = ants.regr
-0003ad30: 6573 735f 636f 6d70 6f6e 656e 7473 2820  ess_components( 
-0003ad40: 6e75 6973 616e 6365 2c20 7463 6c69 7374  nuisance, tclist
-0003ad50: 2029 0a20 2072 6567 7265 7373 696f 6e5f   ).  regression_
-0003ad60: 6d61 736b 203d 2062 6d61 736b 2e63 6c6f  mask = bmask.clo
-0003ad70: 6e65 2829 0a20 2067 6d6d 6174 203d 2061  ne().  gmmat = a
-0003ad80: 6e74 732e 7469 6d65 7365 7269 6573 5f74  nts.timeseries_t
-0003ad90: 6f5f 6d61 7472 6978 2820 7369 6d67 2c20  o_matrix( simg, 
-0003ada0: 7265 6772 6573 7369 6f6e 5f6d 6173 6b20  regression_mask 
-0003adb0: 290a 2020 7265 6776 6172 7320 3d20 6e70  ).  regvars = np
-0003adc0: 2e68 7374 6163 6b28 2028 6e75 6973 616e  .hstack( (nuisan
-0003add0: 6365 2c20 7463 6c69 7374 2029 290a 2020  ce, tclist )).  
-0003ade0: 636f 6566 696e 6420 3d20 7265 6776 6172  coefind = regvar
-0003adf0: 732e 7368 6170 655b 315d 2d31 0a20 2072  s.shape[1]-1.  r
-0003ae00: 6567 7661 7273 203d 2072 6567 7661 7273  egvars = regvars
-0003ae10: 5b3a 2c72 616e 6765 2863 6f65 6669 6e64  [:,range(coefind
-0003ae20: 295d 0a20 2070 7265 6469 6374 6f72 5f6f  )].  predictor_o
-0003ae30: 665f 696e 7465 7265 7374 5f69 6478 203d  f_interest_idx =
-0003ae40: 2072 6567 7661 7273 2e73 6861 7065 5b31   regvars.shape[1
-0003ae50: 5d2d 310a 2020 7661 6c69 645f 7065 7266  ]-1.  valid_perf
-0003ae60: 5f6d 6f64 656c 7320 3d20 5b27 6875 6265  _models = ['hube
-0003ae70: 7227 2c27 7175 616e 7469 6c65 272c 2774  r','quantile','t
-0003ae80: 6865 696c 7365 6e27 2c27 7261 6e73 6163  heilsen','ransac
-0003ae90: 272c 2027 7367 6427 2c20 276c 696e 6561  ', 'sgd', 'linea
-0003aea0: 7227 2c27 534d 275d 0a20 2069 6620 7665  r','SM'].  if ve
-0003aeb0: 7262 6f73 653a 0a20 2020 2070 7269 6e74  rbose:.    print
-0003aec0: 2820 2262 6567 696e 2070 6572 6675 7369  ( "begin perfusi
-0003aed0: 6f6e 2065 7374 696d 6174 696f 6e20 7769  on estimation wi
-0003aee0: 7468 2022 202b 2070 6572 6675 7369 6f6e  th " + perfusion
-0003aef0: 5f72 6567 7265 7373 696f 6e5f 6d6f 6465  _regression_mode
-0003af00: 6c20 2b20 2220 6d6f 6465 6c20 2220 290a  l + " model " ).
-0003af10: 2020 6966 2070 6572 6675 7369 6f6e 5f72    if perfusion_r
-0003af20: 6567 7265 7373 696f 6e5f 6d6f 6465 6c20  egression_model 
-0003af30: 3d3d 2027 6c69 6e65 6172 273a 0a20 2020  == 'linear':.   
-0003af40: 2072 6567 7265 7373 696f 6e5f 6d6f 6465   regression_mode
-0003af50: 6c20 3d20 4c69 6e65 6172 5265 6772 6573  l = LinearRegres
-0003af60: 7369 6f6e 2829 0a20 2020 2072 6567 7265  sion().    regre
-0003af70: 7373 696f 6e5f 6d6f 6465 6c2e 6669 7428  ssion_model.fit(
-0003af80: 2072 6567 7661 7273 2c20 676d 6d61 7420   regvars, gmmat 
-0003af90: 290a 2020 2020 636f 6566 696e 6420 3d20  ).    coefind = 
-0003afa0: 7265 6772 6573 7369 6f6e 5f6d 6f64 656c  regression_model
-0003afb0: 2e63 6f65 665f 2e73 6861 7065 5b31 5d2d  .coef_.shape[1]-
-0003afc0: 310a 2020 2020 7065 7266 696d 6720 3d20  1.    perfimg = 
-0003afd0: 616e 7473 2e6d 616b 655f 696d 6167 6528  ants.make_image(
-0003afe0: 2072 6567 7265 7373 696f 6e5f 6d61 736b   regression_mask
-0003aff0: 2c20 7265 6772 6573 7369 6f6e 5f6d 6f64  , regression_mod
-0003b000: 656c 2e63 6f65 665f 5b3a 2c63 6f65 6669  el.coef_[:,coefi
-0003b010: 6e64 5d20 290a 2020 656c 6966 2070 6572  nd] ).  elif per
-0003b020: 6675 7369 6f6e 5f72 6567 7265 7373 696f  fusion_regressio
-0003b030: 6e5f 6d6f 6465 6c20 3d3d 2027 534d 273a  n_model == 'SM':
-0003b040: 2023 0a20 2020 2069 6d70 6f72 7420 7374   #.    import st
-0003b050: 6174 736d 6f64 656c 732e 6170 6920 6173  atsmodels.api as
-0003b060: 2073 6d0a 2020 2020 636f 6566 6673 203d   sm.    coeffs =
-0003b070: 206e 702e 7a65 726f 7328 2067 6d6d 6174   np.zeros( gmmat
-0003b080: 2e73 6861 7065 5b31 5d20 290a 2020 2020  .shape[1] ).    
-0003b090: 2320 4c6f 6f70 206f 7665 7220 6561 6368  # Loop over each
-0003b0a0: 206f 7574 636f 6d65 2063 6f6c 756d 6e20   outcome column 
-0003b0b0: 696e 2074 6865 206f 7574 636f 6d65 7320  in the outcomes 
-0003b0c0: 6d61 7472 6978 0a20 2020 2066 6f72 206f  matrix.    for o
-0003b0d0: 7574 636f 6d65 5f69 6478 2069 6e20 7261  utcome_idx in ra
-0003b0e0: 6e67 6528 676d 6d61 742e 7368 6170 655b  nge(gmmat.shape[
-0003b0f0: 315d 293a 0a20 2020 2020 2020 206f 7574  1]):.        out
-0003b100: 636f 6d65 203d 2067 6d6d 6174 5b3a 2c20  come = gmmat[:, 
-0003b110: 6f75 7463 6f6d 655f 6964 785d 2020 2320  outcome_idx]  # 
-0003b120: 5365 6c65 6374 206f 6e65 206f 7574 636f  Select one outco
-0003b130: 6d65 2063 6f6c 756d 6e0a 2020 2020 2020  me column.      
-0003b140: 2020 6d6f 6465 6c20 3d20 736d 2e52 4c4d    model = sm.RLM
-0003b150: 286f 7574 636f 6d65 2c20 736d 2e61 6464  (outcome, sm.add
-0003b160: 5f63 6f6e 7374 616e 7428 7265 6776 6172  _constant(regvar
-0003b170: 7329 2c20 4d3d 736d 2e72 6f62 7573 742e  s), M=sm.robust.
-0003b180: 6e6f 726d 732e 4875 6265 7254 2829 2920  norms.HuberT()) 
-0003b190: 2023 2048 7562 6572 2773 2054 206e 6f72   # Huber's T nor
-0003b1a0: 6d20 666f 7220 726f 6275 7374 2072 6567  m for robust reg
-0003b1b0: 7265 7373 696f 6e0a 2020 2020 2020 2020  ression.        
-0003b1c0: 7265 7375 6c74 7320 3d20 6d6f 6465 6c2e  results = model.
-0003b1d0: 6669 7428 290a 2020 2020 2020 2020 636f  fit().        co
-0003b1e0: 6566 6669 6369 656e 7473 203d 2072 6573  efficients = res
-0003b1f0: 756c 7473 2e70 6172 616d 7320 2023 2043  ults.params  # C
-0003b200: 6f65 6666 6963 6965 6e74 7320 6f66 2061  oefficients of a
-0003b210: 6c6c 2070 7265 6469 6374 6f72 730a 2020  ll predictors.  
-0003b220: 2020 2020 2020 636f 6566 6673 5b6f 7574        coeffs[out
-0003b230: 636f 6d65 5f69 6478 5d20 3d20 636f 6566  come_idx] = coef
-0003b240: 6669 6369 656e 7473 5b70 7265 6469 6374  ficients[predict
-0003b250: 6f72 5f6f 665f 696e 7465 7265 7374 5f69  or_of_interest_i
-0003b260: 6478 5d0a 2020 2020 7065 7266 696d 6720  dx].    perfimg 
-0003b270: 3d20 616e 7473 2e6d 616b 655f 696d 6167  = ants.make_imag
-0003b280: 6528 2072 6567 7265 7373 696f 6e5f 6d61  e( regression_ma
-0003b290: 736b 2c20 636f 6566 6673 2029 0a20 2065  sk, coeffs ).  e
-0003b2a0: 6c69 6620 7065 7266 7573 696f 6e5f 7265  lif perfusion_re
-0003b2b0: 6772 6573 7369 6f6e 5f6d 6f64 656c 2069  gression_model i
-0003b2c0: 6e20 7661 6c69 645f 7065 7266 5f6d 6f64  n valid_perf_mod
-0003b2d0: 656c 7320 3a0a 2020 2020 7363 616c 6572  els :.    scaler
-0003b2e0: 203d 2053 7461 6e64 6172 6453 6361 6c65   = StandardScale
-0003b2f0: 7228 290a 2020 2020 676d 6d61 7420 3d20  r().    gmmat = 
-0003b300: 7363 616c 6572 2e66 6974 5f74 7261 6e73  scaler.fit_trans
-0003b310: 666f 726d 2867 6d6d 6174 290a 2020 2020  form(gmmat).    
-0003b320: 636f 6566 6673 203d 206e 702e 7a65 726f  coeffs = np.zero
-0003b330: 7328 2067 6d6d 6174 2e73 6861 7065 5b31  s( gmmat.shape[1
-0003b340: 5d20 290a 2020 2020 6875 6265 725f 7265  ] ).    huber_re
-0003b350: 6772 6573 736f 7220 3d20 7365 6c65 6374  gressor = select
-0003b360: 5f72 6567 7265 7373 696f 6e5f 6d6f 6465  _regression_mode
-0003b370: 6c28 2070 6572 6675 7369 6f6e 5f72 6567  l( perfusion_reg
-0003b380: 7265 7373 696f 6e5f 6d6f 6465 6c20 290a  ression_model ).
-0003b390: 2020 2020 6d75 6c74 696f 7574 7075 745f      multioutput_
-0003b3a0: 6d6f 6465 6c20 3d20 4d75 6c74 694f 7574  model = MultiOut
-0003b3b0: 7075 7452 6567 7265 7373 6f72 2868 7562  putRegressor(hub
-0003b3c0: 6572 5f72 6567 7265 7373 6f72 290a 2020  er_regressor).  
-0003b3d0: 2020 6d75 6c74 696f 7574 7075 745f 6d6f    multioutput_mo
-0003b3e0: 6465 6c2e 6669 7428 2072 6567 7661 7273  del.fit( regvars
-0003b3f0: 2c20 676d 6d61 7420 290a 2020 2020 6374  , gmmat ).    ct
-0003b400: 3d30 0a20 2020 2066 6f72 2069 2c20 6573  =0.    for i, es
-0003b410: 7469 6d61 746f 7220 696e 2065 6e75 6d65  timator in enume
-0003b420: 7261 7465 286d 756c 7469 6f75 7470 7574  rate(multioutput
-0003b430: 5f6d 6f64 656c 2e65 7374 696d 6174 6f72  _model.estimator
-0003b440: 735f 293a 0a20 2020 2020 2063 6f65 6666  s_):.      coeff
-0003b450: 6963 6965 6e74 7320 3d20 6573 7469 6d61  icients = estima
-0003b460: 746f 722e 636f 6566 5f0a 2020 2020 2020  tor.coef_.      
-0003b470: 636f 6566 6673 5b63 745d 3d63 6f65 6666  coeffs[ct]=coeff
-0003b480: 6963 6965 6e74 735b 7072 6564 6963 746f  icients[predicto
-0003b490: 725f 6f66 5f69 6e74 6572 6573 745f 6964  r_of_interest_id
-0003b4a0: 785d 0a20 2020 2020 2063 743d 6374 2b31  x].      ct=ct+1
-0003b4b0: 0a20 2020 2070 6572 6669 6d67 203d 2061  .    perfimg = a
-0003b4c0: 6e74 732e 6d61 6b65 5f69 6d61 6765 2820  nts.make_image( 
-0003b4d0: 7265 6772 6573 7369 6f6e 5f6d 6173 6b2c  regression_mask,
-0003b4e0: 2063 6f65 6666 7320 290a 2020 656c 7365   coeffs ).  else
-0003b4f0: 3a0a 2020 2020 7261 6973 6520 5661 6c75  :.    raise Valu
-0003b500: 6545 7272 6f72 2820 7065 7266 7573 696f  eError( perfusio
-0003b510: 6e5f 7265 6772 6573 7369 6f6e 5f6d 6f64  n_regression_mod
-0003b520: 656c 202b 2022 2072 6567 7265 7373 696f  el + " regressio
-0003b530: 6e20 6d6f 6465 6c20 6973 206e 6f74 2066  n model is not f
-0003b540: 6f75 6e64 2e22 290a 2020 6d65 616e 676d  ound.").  meangm
-0003b550: 7661 6c20 3d20 2820 7065 7266 696d 675b  val = ( perfimg[
-0003b560: 2067 6d73 6567 203d 3d20 3120 5d20 292e   gmseg == 1 ] ).
-0003b570: 6d65 616e 2829 0a20 2069 6620 6d65 616e  mean().  if mean
-0003b580: 676d 7661 6c20 3c20 303a 0a20 2020 2020  gmval < 0:.     
-0003b590: 2070 6572 6669 6d67 203d 2070 6572 6669   perfimg = perfi
-0003b5a0: 6d67 202a 2028 2d31 2e30 290a 2020 6e65  mg * (-1.0).  ne
-0003b5b0: 6761 7469 7665 5f76 6f78 656c 7320 3d20  gative_voxels = 
-0003b5c0: 2820 7065 7266 696d 6720 3c20 302e 3020  ( perfimg < 0.0 
-0003b5d0: 292e 7375 6d28 2920 2f20 6e70 2e70 726f  ).sum() / np.pro
-0003b5e0: 6428 2070 6572 6669 6d67 2e73 6861 7065  d( perfimg.shape
-0003b5f0: 2029 202a 2031 3030 2e30 0a20 2070 6572   ) * 100.0.  per
-0003b600: 6669 6d67 5b20 7065 7266 696d 6720 3c20  fimg[ perfimg < 
-0003b610: 302e 3020 5d20 3d20 302e 3020 2320 6e6f  0.0 ] = 0.0 # no
-0003b620: 6e2d 7068 7973 696f 6c6f 6769 6361 6c0a  n-physiological.
-0003b630: 0a20 2023 204c 6154 6558 2063 6f64 6520  .  # LaTeX code 
-0003b640: 666f 7220 4365 7265 6272 616c 2042 6c6f  for Cerebral Blo
-0003b650: 6f64 2046 6c6f 7720 2843 4246 2920 6361  od Flow (CBF) ca
-0003b660: 6c63 756c 6174 696f 6e20 7573 696e 6720  lculation using 
-0003b670: 4153 4c20 4d52 490a 2020 2222 220a 4342  ASL MRI.  """.CB
-0003b680: 4620 3d20 5c5c 6672 6163 7b5c 5c44 656c  F = \\frac{\\Del
-0003b690: 7461 204d 205c 5c63 646f 7420 5c5c 6c61  ta M \\cdot \\la
-0003b6a0: 6d62 6461 7d7b 3220 5c5c 6364 6f74 2054  mbda}{2 \\cdot T
-0003b6b0: 5f31 205c 5c63 646f 7420 5c5c 616c 7068  _1 \\cdot \\alph
-0003b6c0: 6120 5c5c 6364 6f74 204d 5f30 205c 5c63  a \\cdot M_0 \\c
-0003b6d0: 646f 7420 2865 5e7b 2d5c 5c66 7261 637b  dot (e^{-\\frac{
-0003b6e0: 777d 7b54 5f31 7d7d 202d 2065 5e7b 2d5c  w}{T_1}} - e^{-\
-0003b6f0: 5c66 7261 637b 7720 2b20 5c5c 7461 757d  \frac{w + \\tau}
-0003b700: 7b54 5f31 7d7d 297d 0a0a 5768 6572 653a  {T_1}})}..Where:
-0003b710: 0a2d 205c 5c44 656c 7461 204d 2069 7320  .- \\Delta M is 
-0003b720: 7468 6520 6469 6666 6572 656e 6365 2069  the difference i
-0003b730: 6e20 6d61 676e 6574 697a 6174 696f 6e20  n magnetization 
-0003b740: 6265 7477 6565 6e20 6c61 6265 6c65 6420  between labeled 
-0003b750: 616e 6420 636f 6e74 726f 6c20 696d 6167  and control imag
-0003b760: 6573 2e0a 2d20 5c5c 6c61 6d62 6461 2069  es..- \\lambda i
-0003b770: 7320 7468 6520 6272 6169 6e2d 626c 6f6f  s the brain-bloo
-0003b780: 6420 7061 7274 6974 696f 6e20 636f 6566  d partition coef
-0003b790: 6669 6369 656e 742c 2074 7970 6963 616c  ficient, typical
-0003b7a0: 6c79 2061 726f 756e 6420 302e 3920 6d4c  ly around 0.9 mL
-0003b7b0: 2f67 2e0a 2d20 545f 3120 6973 2074 6865  /g..- T_1 is the
-0003b7c0: 206c 6f6e 6769 7475 6469 6e61 6c20 7265   longitudinal re
-0003b7d0: 6c61 7861 7469 6f6e 2074 696d 6520 6f66  laxation time of
-0003b7e0: 2062 6c6f 6f64 2c20 7768 6963 6820 6973   blood, which is
-0003b7f0: 2061 2074 6973 7375 652d 7370 6563 6966   a tissue-specif
-0003b800: 6963 2063 6f6e 7374 616e 742e 0a2d 205c  ic constant..- \
-0003b810: 5c61 6c70 6861 2069 7320 7468 6520 6c61  \alpha is the la
-0003b820: 6265 6c69 6e67 2065 6666 6963 6965 6e63  beling efficienc
-0003b830: 792e 0a2d 204d 5f30 2069 7320 7468 6520  y..- M_0 is the 
-0003b840: 6571 7569 6c69 6272 6975 6d20 6d61 676e  equilibrium magn
-0003b850: 6574 697a 6174 696f 6e20 6f66 2062 7261  etization of bra
-0003b860: 696e 2074 6973 7375 6520 2866 726f 6d20  in tissue (from 
-0003b870: 7468 6520 4d30 2069 6d61 6765 292e 0a2d  the M0 image)..-
-0003b880: 2077 2069 7320 7468 6520 706f 7374 2d6c   w is the post-l
-0003b890: 6162 656c 696e 6720 6465 6c61 792c 2074  abeling delay, t
-0003b8a0: 6865 2074 696d 6520 6265 7477 6565 6e20  he time between 
-0003b8b0: 7468 6520 656e 6420 6f66 2074 6865 206c  the end of the l
-0003b8c0: 6162 656c 696e 6720 616e 6420 7468 6520  abeling and the 
-0003b8d0: 6163 7175 6973 6974 696f 6e20 6f66 2074  acquisition of t
-0003b8e0: 6865 2069 6d61 6765 2e0a 2d20 5c5c 7461  he image..- \\ta
-0003b8f0: 7520 6973 2074 6865 206c 6162 656c 696e  u is the labelin
-0003b900: 6720 6475 7261 7469 6f6e 2e0a 2020 2222  g duration..  ""
-0003b910: 220a 2020 6966 206d 305f 696e 6469 6365  ".  if m0_indice
-0003b920: 7320 6973 204e 6f6e 6520 616e 6420 6d30  s is None and m0
-0003b930: 5f69 6d61 6765 2069 7320 4e6f 6e65 3a0a  _image is None:.
-0003b940: 2020 2020 6d30 203d 2061 6e74 732e 6765      m0 = ants.ge
-0003b950: 745f 6176 6572 6167 655f 6f66 5f74 696d  t_average_of_tim
-0003b960: 6573 6572 6965 7328 2066 6d72 696d 6f74  eseries( fmrimot
-0003b970: 636f 7272 2029 0a20 2065 6c73 653a 0a20  corr ).  else:. 
-0003b980: 2020 2023 2072 6567 6973 7465 7220 6d30     # register m0
-0003b990: 2074 6f20 6375 7272 656e 7420 7465 6d70   to current temp
-0003b9a0: 6c61 7465 0a20 2020 206d 3072 6567 203d  late.    m0reg =
-0003b9b0: 2061 6e74 732e 7265 6769 7374 7261 7469   ants.registrati
-0003b9c0: 6f6e 2820 666d 7269 5f74 656d 706c 6174  on( fmri_templat
-0003b9d0: 652c 206d 302c 2027 5269 6769 6427 2c20  e, m0, 'Rigid', 
-0003b9e0: 7665 7262 6f73 653d 4661 6c73 6520 290a  verbose=False ).
-0003b9f0: 2020 2020 6d30 203d 206d 3072 6567 5b27      m0 = m0reg['
-0003ba00: 7761 7270 6564 6d6f 766f 7574 275d 0a0a  warpedmovout']..
-0003ba10: 2020 6966 206e 7470 203d 3d20 3220 3a0a    if ntp == 2 :.
-0003ba20: 2020 2020 2020 696d 6730 203d 2061 6e74        img0 = ant
-0003ba30: 732e 736c 6963 655f 696d 6167 6528 2063  s.slice_image( c
-0003ba40: 6f72 726d 6f5b 276d 6f74 696f 6e5f 636f  orrmo['motion_co
-0003ba50: 7272 6563 7465 6427 5d2c 2061 7869 733d  rrected'], axis=
-0003ba60: 332c 2069 6478 3d30 2029 0a20 2020 2020  3, idx=0 ).     
-0003ba70: 2069 6d67 3120 3d20 616e 7473 2e73 6c69   img1 = ants.sli
-0003ba80: 6365 5f69 6d61 6765 2820 636f 7272 6d6f  ce_image( corrmo
-0003ba90: 5b27 6d6f 7469 6f6e 5f63 6f72 7265 6374  ['motion_correct
-0003baa0: 6564 275d 2c20 6178 6973 3d33 2c20 6964  ed'], axis=3, id
-0003bab0: 783d 3120 290a 2020 2020 2020 6966 206d  x=1 ).      if m
-0003bac0: 305f 696d 6167 6520 6973 204e 6f6e 653a  0_image is None:
-0003bad0: 0a20 2020 2020 2020 2069 6620 696d 6730  .        if img0
-0003bae0: 2e6d 6561 6e28 2920 3c20 696d 6731 2e6d  .mean() < img1.m
-0003baf0: 6561 6e28 293a 0a20 2020 2020 2020 2020  ean():.         
-0003bb00: 2020 2070 6572 6669 6d67 3d69 6d67 300a     perfimg=img0.
-0003bb10: 2020 2020 2020 2020 2020 2020 6d30 3d69              m0=i
-0003bb20: 6d67 310a 2020 2020 2020 2020 656c 7365  mg1.        else
-0003bb30: 3a0a 2020 2020 2020 2020 2020 2020 7065  :.            pe
-0003bb40: 7266 696d 673d 696d 6731 0a20 2020 2020  rfimg=img1.     
-0003bb50: 2020 2020 2020 206d 303d 696d 6730 0a20         m0=img0. 
-0003bb60: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0003bb70: 2020 2069 6620 696d 6730 2e6d 6561 6e28     if img0.mean(
-0003bb80: 2920 3c20 696d 6731 2e6d 6561 6e28 293a  ) < img1.mean():
-0003bb90: 0a20 2020 2020 2020 2020 2020 2070 6572  .            per
-0003bba0: 6669 6d67 3d69 6d67 312d 696d 6730 0a20  fimg=img1-img0. 
-0003bbb0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0003bbc0: 2020 2020 2020 2020 2070 6572 6669 6d67           perfimg
-0003bbd0: 3d69 6d67 302d 696d 6731 0a0a 2020 6362  =img0-img1..  cb
-0003bbe0: 6620 3d20 6361 6c63 756c 6174 655f 4342  f = calculate_CB
-0003bbf0: 4628 0a20 2020 2020 2044 656c 7461 5f4d  F(.      Delta_M
-0003bc00: 3d70 6572 6669 6d67 2c20 4d5f 303d 6d30  =perfimg, M_0=m0
-0003bc10: 2c20 6d61 736b 3d62 6d61 736b 2029 0a20  , mask=bmask ). 
-0003bc20: 2069 6620 7472 696d 5f74 6865 5f6d 6173   if trim_the_mas
-0003bc30: 6b20 3e20 302e 3020 3a0a 2020 2020 626d  k > 0.0 :.    bm
-0003bc40: 6173 6b20 3d20 7472 696d 5f64 7469 5f6d  ask = trim_dti_m
-0003bc50: 6173 6b28 2063 6266 2c20 626d 6173 6b2c  ask( cbf, bmask,
-0003bc60: 2074 7269 6d5f 7468 655f 6d61 736b 2029   trim_the_mask )
-0003bc70: 0a20 2020 2070 6572 6669 6d67 203d 2070  .    perfimg = p
-0003bc80: 6572 6669 6d67 202a 2062 6d61 736b 0a20  erfimg * bmask. 
-0003bc90: 2020 2063 6266 203d 2063 6266 202a 2062     cbf = cbf * b
-0003bca0: 6d61 736b 0a0a 2020 6d65 616e 676d 7661  mask..  meangmva
-0003bcb0: 6c20 3d20 2820 7065 7266 696d 675b 2067  l = ( perfimg[ g
-0003bcc0: 6d73 6567 203d 3d20 3120 5d20 292e 6d65  mseg == 1 ] ).me
-0003bcd0: 616e 2829 2020 2020 2020 2020 0a20 206d  an()        .  m
-0003bce0: 6561 6e67 6d76 616c 6362 6620 3d20 2820  eangmvalcbf = ( 
-0003bcf0: 6362 665b 2067 6d73 6567 203d 3d20 3120  cbf[ gmseg == 1 
-0003bd00: 5d20 292e 6d65 616e 2829 0a20 2069 6620  ] ).mean().  if 
-0003bd10: 7665 7262 6f73 653a 0a20 2020 2070 7269  verbose:.    pri
-0003bd20: 6e74 2822 7065 7266 696d 672e 6d61 7828  nt("perfimg.max(
-0003bd30: 2920 2220 2b20 7374 7228 2020 7065 7266  ) " + str(  perf
-0003bd40: 696d 672e 6d61 7828 2920 2920 290a 2020  img.max() ) ).  
-0003bd50: 6f75 7464 6963 7420 3d20 7b7d 0a20 206f  outdict = {}.  o
-0003bd60: 7574 6469 6374 5b27 6d65 616e 426f 6c64  utdict['meanBold
-0003bd70: 275d 203d 2075 6e64 0a20 206f 7574 6469  '] = und.  outdi
-0003bd80: 6374 5b27 6272 6169 6e6d 6173 6b27 5d20  ct['brainmask'] 
-0003bd90: 3d20 626d 6173 6b0a 2020 7273 664e 7569  = bmask.  rsfNui
-0003bda0: 7361 6e63 6520 3d20 7064 2e44 6174 6146  sance = pd.DataF
-0003bdb0: 7261 6d65 2820 6e75 6973 616e 6365 2029  rame( nuisance )
-0003bdc0: 0a20 2072 7366 4e75 6973 616e 6365 5b27  .  rsfNuisance['
-0003bdd0: 4644 275d 3d63 6f72 726d 6f5b 2746 4427  FD']=corrmo['FD'
-0003bde0: 5d0a 0a20 2069 6620 7665 7262 6f73 653a  ]..  if verbose:
-0003bdf0: 0a20 2020 2020 2070 7269 6e74 2822 7065  .      print("pe
-0003be00: 7266 7573 696f 6e20 6461 7461 6672 616d  rfusion datafram
-0003be10: 6520 6265 6769 6e22 290a 2020 646b 7473  e begin").  dkts
-0003be20: 6567 203d 2061 6e74 732e 6170 706c 795f  eg = ants.apply_
-0003be30: 7472 616e 7366 6f72 6d73 2820 756e 642c  transforms( und,
-0003be40: 2074 3164 6b74 6369 742c 0a20 2020 2074   t1dktcit,.    t
-0003be50: 3172 6567 5b27 6677 6474 7261 6e73 666f  1reg['fwdtransfo
-0003be60: 726d 7327 5d2c 2069 6e74 6572 706f 6c61  rms'], interpola
-0003be70: 746f 7220 3d20 2767 656e 6572 6963 4c61  tor = 'genericLa
-0003be80: 6265 6c27 2029 202a 2062 6d61 736b 0a20  bel' ) * bmask. 
-0003be90: 2064 665f 7065 7266 203d 2061 6e74 7370   df_perf = antsp
-0003bea0: 7974 3177 2e6d 6170 5f69 6e74 656e 7369  yt1w.map_intensi
-0003beb0: 7479 5f74 6f5f 6461 7461 6672 616d 6528  ty_to_dataframe(
-0003bec0: 0a20 2020 2020 2020 2027 646b 745f 636f  .        'dkt_co
-0003bed0: 7274 6578 5f63 6974 5f64 6565 705f 6272  rtex_cit_deep_br
-0003bee0: 6169 6e27 2c0a 2020 2020 2020 2020 7065  ain',.        pe
-0003bef0: 7266 696d 672c 0a20 2020 2020 2020 2064  rfimg,.        d
-0003bf00: 6b74 7365 6729 0a20 2064 665f 7065 7266  ktseg).  df_perf
-0003bf10: 203d 2061 6e74 7370 7974 3177 2e6d 6572   = antspyt1w.mer
-0003bf20: 6765 5f68 6965 7261 7263 6869 6361 6c5f  ge_hierarchical_
-0003bf30: 6373 7673 5f74 6f5f 7769 6465 5f66 6f72  csvs_to_wide_for
-0003bf40: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
-0003bf50: 2020 207b 2770 6572 6627 203a 2064 665f     {'perf' : df_
-0003bf60: 7065 7266 7d2c 0a20 2020 2020 2020 2020  perf},.         
-0003bf70: 2020 2020 2063 6f6c 5f6e 616d 6573 203d       col_names =
-0003bf80: 205b 274d 6561 6e27 5d20 290a 2020 6466   ['Mean'] ).  df
-0003bf90: 5f63 6266 203d 2061 6e74 7370 7974 3177  _cbf = antspyt1w
-0003bfa0: 2e6d 6170 5f69 6e74 656e 7369 7479 5f74  .map_intensity_t
-0003bfb0: 6f5f 6461 7461 6672 616d 6528 0a20 2020  o_dataframe(.   
-0003bfc0: 2020 2020 2027 646b 745f 636f 7274 6578       'dkt_cortex
-0003bfd0: 5f63 6974 5f64 6565 705f 6272 6169 6e27  _cit_deep_brain'
-0003bfe0: 2c0a 2020 2020 2020 2020 6362 662c 0a20  ,.        cbf,. 
-0003bff0: 2020 2020 2020 2064 6b74 7365 6729 0a20         dktseg). 
-0003c000: 2064 665f 6362 6620 3d20 616e 7473 7079   df_cbf = antspy
-0003c010: 7431 772e 6d65 7267 655f 6869 6572 6172  t1w.merge_hierar
-0003c020: 6368 6963 616c 5f63 7376 735f 746f 5f77  chical_csvs_to_w
-0003c030: 6964 655f 666f 726d 6174 280a 2020 2020  ide_format(.    
-0003c040: 2020 2020 2020 2020 2020 7b27 6362 6627            {'cbf'
-0003c050: 203a 2064 665f 6362 667d 2c0a 2020 2020   : df_cbf},.    
-0003c060: 2020 2020 2020 2020 2020 636f 6c5f 6e61            col_na
-0003c070: 6d65 7320 3d20 5b27 4d65 616e 275d 2029  mes = ['Mean'] )
-0003c080: 0a20 2064 665f 6362 6620 3d20 6466 5f63  .  df_cbf = df_c
-0003c090: 6266 2e61 6464 5f70 7265 6669 7828 2763  bf.add_prefix('c
-0003c0a0: 6266 5f27 290a 2020 6466 5f70 6572 6620  bf_').  df_perf 
-0003c0b0: 3d20 7064 2e63 6f6e 6361 7428 205b 6466  = pd.concat( [df
-0003c0c0: 5f70 6572 662c 6466 5f63 6266 5d2c 2061  _perf,df_cbf], a
-0003c0d0: 7869 733d 312c 2069 676e 6f72 655f 696e  xis=1, ignore_in
-0003c0e0: 6465 783d 4661 6c73 6520 290a 2020 6966  dex=False ).  if
-0003c0f0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-0003c100: 7072 696e 7428 2270 6572 6675 7369 6f6e  print("perfusion
-0003c110: 2064 6174 6166 7261 6d65 2065 6e64 2229   dataframe end")
-0003c120: 0a0a 2020 6f75 7464 6963 745b 2770 6572  ..  outdict['per
-0003c130: 6675 7369 6f6e 275d 3d70 6572 6669 6d67  fusion']=perfimg
-0003c140: 0a20 206f 7574 6469 6374 5b27 6362 6627  .  outdict['cbf'
-0003c150: 5d3d 6362 660a 2020 6f75 7464 6963 745b  ]=cbf.  outdict[
-0003c160: 276d 3027 5d3d 6d30 0a20 206f 7574 6469  'm0']=m0.  outdi
-0003c170: 6374 5b27 7065 7266 7573 696f 6e5f 676d  ct['perfusion_gm
-0003c180: 5f6d 6561 6e27 5d3d 6d65 616e 676d 7661  _mean']=meangmva
-0003c190: 6c0a 2020 6f75 7464 6963 745b 2763 6266  l.  outdict['cbf
-0003c1a0: 5f67 6d5f 6d65 616e 275d 3d6d 6561 6e67  _gm_mean']=meang
-0003c1b0: 6d76 616c 6362 660a 2020 6f75 7464 6963  mvalcbf.  outdic
-0003c1c0: 745b 2770 6572 665f 6461 7461 6672 616d  t['perf_datafram
-0003c1d0: 6527 5d3d 6466 5f70 6572 660a 2020 6f75  e']=df_perf.  ou
-0003c1e0: 7464 6963 745b 276d 6f74 696f 6e5f 636f  tdict['motion_co
-0003c1f0: 7272 6563 7465 6427 5d20 3d20 636f 7272  rrected'] = corr
-0003c200: 6d6f 5b27 6d6f 7469 6f6e 5f63 6f72 7265  mo['motion_corre
-0003c210: 6374 6564 275d 0a20 206f 7574 6469 6374  cted'].  outdict
-0003c220: 5b27 676d 7365 6727 5d20 3d20 676d 7365  ['gmseg'] = gmse
-0003c230: 670a 2020 6f75 7464 6963 745b 2762 7261  g.  outdict['bra
-0003c240: 696e 5f6d 6173 6b27 5d20 3d20 626d 6173  in_mask'] = bmas
-0003c250: 6b0a 2020 6f75 7464 6963 745b 276e 7569  k.  outdict['nui
-0003c260: 7361 6e63 6527 5d20 3d20 7273 664e 7569  sance'] = rsfNui
-0003c270: 7361 6e63 650a 2020 6f75 7464 6963 745b  sance.  outdict[
-0003c280: 2774 736e 7227 5d20 3d20 6d79 7473 6e72  'tsnr'] = mytsnr
-0003c290: 0a20 206f 7574 6469 6374 5b27 7373 6e72  .  outdict['ssnr
-0003c2a0: 275d 203d 2073 6c69 6365 5f73 6e72 2820  '] = slice_snr( 
-0003c2b0: 636f 7272 6d6f 5b27 6d6f 7469 6f6e 5f63  corrmo['motion_c
-0003c2c0: 6f72 7265 6374 6564 275d 2c20 6373 6641  orrected'], csfA
-0003c2d0: 6e64 574d 2c20 676d 7365 6720 290a 2020  ndWM, gmseg ).  
-0003c2e0: 6f75 7464 6963 745b 2764 7661 7273 275d  outdict['dvars']
-0003c2f0: 203d 2064 7661 7273 2820 636f 7272 6d6f   = dvars( corrmo
-0003c300: 5b27 6d6f 7469 6f6e 5f63 6f72 7265 6374  ['motion_correct
-0003c310: 6564 275d 2c20 676d 7365 6720 290a 2020  ed'], gmseg ).  
-0003c320: 6f75 7464 6963 745b 2768 6967 685f 6d6f  outdict['high_mo
-0003c330: 7469 6f6e 5f63 6f75 6e74 275d 203d 2028  tion_count'] = (
-0003c340: 7273 664e 7569 7361 6e63 655b 2746 4427  rsfNuisance['FD'
-0003c350: 5d20 3e20 4644 5f74 6872 6573 686f 6c64  ] > FD_threshold
-0003c360: 2029 2e73 756d 2829 0a20 206f 7574 6469   ).sum().  outdi
-0003c370: 6374 5b27 6869 6768 5f6d 6f74 696f 6e5f  ct['high_motion_
-0003c380: 7063 7427 5d20 3d20 2872 7366 4e75 6973  pct'] = (rsfNuis
-0003c390: 616e 6365 5b27 4644 275d 203e 2046 445f  ance['FD'] > FD_
-0003c3a0: 7468 7265 7368 6f6c 6420 292e 7375 6d28  threshold ).sum(
-0003c3b0: 2920 2f20 7273 664e 7569 7361 6e63 652e  ) / rsfNuisance.
-0003c3c0: 7368 6170 655b 305d 0a20 206f 7574 6469  shape[0].  outdi
-0003c3d0: 6374 5b27 4644 5f6d 6178 275d 203d 2072  ct['FD_max'] = r
-0003c3e0: 7366 4e75 6973 616e 6365 5b27 4644 275d  sfNuisance['FD']
-0003c3f0: 2e6d 6178 2829 0a20 206f 7574 6469 6374  .max().  outdict
-0003c400: 5b27 4644 5f6d 6561 6e27 5d20 3d20 7273  ['FD_mean'] = rs
-0003c410: 664e 7569 7361 6e63 655b 2746 4427 5d2e  fNuisance['FD'].
-0003c420: 6d65 616e 2829 0a20 206f 7574 6469 6374  mean().  outdict
-0003c430: 5b27 4644 5f73 6427 5d20 3d20 7273 664e  ['FD_sd'] = rsfN
-0003c440: 7569 7361 6e63 655b 2746 4427 5d2e 7374  uisance['FD'].st
-0003c450: 6428 290a 2020 6f75 7464 6963 745b 2762  d().  outdict['b
-0003c460: 6f6c 645f 6576 7227 5d20 3d20 2061 6e74  old_evr'] =  ant
-0003c470: 7370 7974 3177 2e70 6174 6368 5f65 6967  spyt1w.patch_eig
-0003c480: 656e 7661 6c75 655f 7261 7469 6f28 2075  envalue_ratio( u
-0003c490: 6e64 2c20 3531 322c 205b 3136 2c31 362c  nd, 512, [16,16,
-0003c4a0: 3136 5d2c 2065 7664 6570 7468 203d 2030  16], evdepth = 0
-0003c4b0: 2e39 2c20 6d61 736b 203d 2062 6d61 736b  .9, mask = bmask
-0003c4c0: 2029 0a20 206f 7574 6469 6374 5b27 7431   ).  outdict['t1
-0003c4d0: 7265 6727 5d20 3d20 7431 7265 670a 2020  reg'] = t1reg.  
-0003c4e0: 6f75 7464 6963 745b 276f 7574 6c69 6572  outdict['outlier
-0003c4f0: 5f76 6f6c 756d 6573 275d 3d68 6c69 6e64  _volumes']=hlind
-0003c500: 730a 2020 6f75 7464 6963 745b 276e 5f6f  s.  outdict['n_o
-0003c510: 7574 6c69 6572 7327 5d3d 6c65 6e28 686c  utliers']=len(hl
-0003c520: 696e 6473 290a 2020 6f75 7464 6963 745b  inds).  outdict[
-0003c530: 276e 6567 6174 6976 655f 766f 7865 6c73  'negative_voxels
-0003c540: 275d 3d6e 6567 6174 6976 655f 766f 7865  ']=negative_voxe
-0003c550: 6c73 0a20 2072 6574 7572 6e20 636f 6e76  ls.  return conv
-0003c560: 6572 745f 6e70 5f69 6e5f 6469 6374 2820  ert_np_in_dict( 
-0003c570: 6f75 7464 6963 7420 290a 0a0a 6465 6620  outdict )...def 
-0003c580: 7772 6974 655f 6276 616c 735f 6276 6563  write_bvals_bvec
-0003c590: 7328 6276 616c 732c 2062 7665 6373 2c20  s(bvals, bvecs, 
-0003c5a0: 7072 6566 6978 2029 3a0a 2020 2020 2727  prefix ):.    ''
-0003c5b0: 2720 5772 6974 6520 4653 4c20 4644 5420  ' Write FSL FDT 
-0003c5c0: 6276 616c 7320 616e 6420 6276 6563 7320  bvals and bvecs 
-0003c5d0: 6669 6c65 730a 0a20 2020 2061 6461 7074  files..    adapt
-0003c5e0: 6564 2066 726f 6d20 6469 7079 2e65 7874  ed from dipy.ext
-0003c5f0: 6572 6e61 6c20 636f 6465 0a0a 2020 2020  ernal code..    
-0003c600: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-0003c610: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
-0003c620: 2062 7661 6c73 203a 2028 4e2c 2920 7365   bvals : (N,) se
-0003c630: 7175 656e 6365 0a20 2020 2020 2020 5665  quence.       Ve
-0003c640: 6374 6f72 2077 6974 6820 6469 6666 7573  ctor with diffus
-0003c650: 696f 6e20 6772 6164 6965 6e74 2073 7472  ion gradient str
-0003c660: 656e 6774 6820 286f 6e65 2070 6572 2064  ength (one per d
-0003c670: 6966 6675 7369 6f6e 0a20 2020 2020 2020  iffusion.       
-0003c680: 6163 7175 6973 6974 696f 6e2c 204e 3d6e  acquisition, N=n
-0003c690: 6f20 6f66 2061 6371 7569 7369 7469 6f6e  o of acquisition
-0003c6a0: 7329 0a20 2020 2062 7665 6373 203a 2028  s).    bvecs : (
-0003c6b0: 4e2c 2033 2920 6172 7261 792d 6c69 6b65  N, 3) array-like
-0003c6c0: 0a20 2020 2020 2020 6469 6666 7573 696f  .       diffusio
-0003c6d0: 6e20 6772 6164 6965 6e74 2064 6972 6563  n gradient direc
-0003c6e0: 7469 6f6e 730a 2020 2020 7072 6566 6978  tions.    prefix
-0003c6f0: 203a 2073 7472 696e 670a 2020 2020 2020   : string.      
-0003c700: 2070 6174 6820 746f 2077 7269 7465 2046   path to write F
-0003c710: 4454 2062 7661 6c73 2c20 6276 6563 7320  DT bvals, bvecs 
-0003c720: 7465 7874 2066 696c 6573 0a20 2020 2020  text files.     
-0003c730: 2020 4e6f 6e65 2072 6573 756c 7473 2069    None results i
-0003c740: 6e20 6375 7272 656e 7420 776f 726b 696e  n current workin
-0003c750: 6720 6469 7265 6374 6f72 792e 0a20 2020  g directory..   
-0003c760: 2027 2727 0a20 2020 205f 5641 4c5f 464d   '''.    _VAL_FM
-0003c770: 5420 3d20 2720 2020 2565 270a 2020 2020  T = '   %e'.    
-0003c780: 6276 616c 7320 3d20 7475 706c 6528 6276  bvals = tuple(bv
-0003c790: 616c 7329 0a20 2020 2062 7665 6373 203d  als).    bvecs =
-0003c7a0: 206e 702e 6173 6172 7261 7928 6276 6563   np.asarray(bvec
-0003c7b0: 7329 0a20 2020 2062 7665 6373 5b6e 702e  s).    bvecs[np.
-0003c7c0: 6973 6e61 6e28 6276 6563 7329 5d20 3d20  isnan(bvecs)] = 
-0003c7d0: 300a 2020 2020 4e20 3d20 6c65 6e28 6276  0.    N = len(bv
-0003c7e0: 616c 7329 0a20 2020 2066 6e61 6d65 203d  als).    fname =
-0003c7f0: 2070 7265 6669 7820 2b20 272e 6276 616c   prefix + '.bval
-0003c800: 270a 2020 2020 666d 7420 3d20 5f56 414c  '.    fmt = _VAL
-0003c810: 5f46 4d54 202a 204e 202b 2027 5c6e 270a  _FMT * N + '\n'.
-0003c820: 2020 2020 6d79 6669 6c65 203d 206f 7065      myfile = ope
-0003c830: 6e28 666e 616d 652c 2027 7774 2729 0a20  n(fname, 'wt'). 
-0003c840: 2020 206d 7966 696c 652e 7772 6974 6528     myfile.write(
-0003c850: 666d 7420 2520 6276 616c 7329 0a20 2020  fmt % bvals).   
-0003c860: 206d 7966 696c 652e 636c 6f73 6528 290a   myfile.close().
-0003c870: 2020 2020 666e 616d 6520 3d20 7072 6566      fname = pref
-0003c880: 6978 202b 2027 2e62 7665 6327 0a20 2020  ix + '.bvec'.   
-0003c890: 2062 7666 203d 206f 7065 6e28 666e 616d   bvf = open(fnam
-0003c8a0: 652c 2027 7774 2729 0a20 2020 2066 6f72  e, 'wt').    for
-0003c8b0: 2064 696d 5f76 616c 7320 696e 2062 7665   dim_vals in bve
-0003c8c0: 6373 2e54 3a0a 2020 2020 2020 2020 6276  cs.T:.        bv
-0003c8d0: 662e 7772 6974 6528 666d 7420 2520 7475  f.write(fmt % tu
-0003c8e0: 706c 6528 6469 6d5f 7661 6c73 2929 0a20  ple(dim_vals)). 
-0003c8f0: 2020 2062 7666 2e63 6c6f 7365 2829 0a20     bvf.close(). 
-0003c900: 2020 200a 0a64 6566 2063 726f 705f 6d63     ..def crop_mc
-0003c910: 696d 6167 6528 2078 2c20 6d61 736b 2c20  image( x, mask, 
-0003c920: 7061 6464 6572 3d4e 6f6e 6520 293a 0a20  padder=None ):. 
-0003c930: 2020 2022 2222 0a20 2020 2063 726f 7020     """.    crop 
-0003c940: 6120 7469 6d65 2073 6572 6965 7320 2834  a time series (4
-0003c950: 4429 2069 6d61 6765 2062 7920 6120 3344  D) image by a 3D
-0003c960: 206d 6173 6b0a 0a20 2020 2050 6172 616d   mask..    Param
-0003c970: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
-0003c980: 2d2d 2d2d 2d2d 2d0a 0a20 2020 2078 203a  -------..    x :
-0003c990: 2072 6177 2069 6d61 6765 0a0a 2020 2020   raw image..    
-0003c9a0: 6d61 736b 2020 3a20 6d61 736b 2066 6f72  mask  : mask for
-0003c9b0: 2063 726f 7070 696e 670a 0a20 2020 2022   cropping..    "
-0003c9c0: 2222 0a20 2020 2063 726f 706d 6173 6b20  "".    cropmask 
-0003c9d0: 3d20 616e 7473 2e63 726f 705f 696d 6167  = ants.crop_imag
-0003c9e0: 6528 206d 6173 6b2c 206d 6173 6b20 290a  e( mask, mask ).
-0003c9f0: 2020 2020 6d79 6f72 6967 203d 206c 6973      myorig = lis
-0003ca00: 7428 2061 6e74 732e 6765 745f 6f72 6967  t( ants.get_orig
-0003ca10: 696e 2863 726f 706d 6173 6b29 2029 0a20  in(cropmask) ). 
-0003ca20: 2020 206d 796f 7269 672e 6170 7065 6e64     myorig.append
-0003ca30: 2820 616e 7473 2e67 6574 5f6f 7269 6769  ( ants.get_origi
-0003ca40: 6e28 2078 2029 5b33 5d20 290a 2020 2020  n( x )[3] ).    
-0003ca50: 6372 6f70 6c69 7374 203d 205b 5d0a 2020  croplist = [].  
-0003ca60: 2020 6966 206c 656e 2878 2e73 6861 7065    if len(x.shape
-0003ca70: 2920 3e20 333a 0a20 2020 2020 2020 2066  ) > 3:.        f
-0003ca80: 6f72 206b 2069 6e20 7261 6e67 6528 782e  or k in range(x.
-0003ca90: 7368 6170 655b 335d 293a 0a20 2020 2020  shape[3]):.     
-0003caa0: 2020 2020 2020 2074 656d 7020 3d20 616e         temp = an
-0003cab0: 7473 2e73 6c69 6365 5f69 6d61 6765 2820  ts.slice_image( 
-0003cac0: 782c 2061 7869 733d 332c 2069 6478 3d6b  x, axis=3, idx=k
-0003cad0: 2029 0a20 2020 2020 2020 2020 2020 2074   ).            t
-0003cae0: 656d 7020 3d20 616e 7473 2e63 726f 705f  emp = ants.crop_
-0003caf0: 696d 6167 6528 2074 656d 702c 206d 6173  image( temp, mas
-0003cb00: 6b20 290a 2020 2020 2020 2020 2020 2020  k ).            
-0003cb10: 6966 2070 6164 6465 7220 6973 206e 6f74  if padder is not
-0003cb20: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0003cb30: 2020 2020 2020 2074 656d 7020 3d20 616e         temp = an
-0003cb40: 7473 2e70 6164 5f69 6d61 6765 2820 7465  ts.pad_image( te
-0003cb50: 6d70 2c20 7061 645f 7769 6474 683d 7061  mp, pad_width=pa
-0003cb60: 6464 6572 2029 0a20 2020 2020 2020 2020  dder ).         
-0003cb70: 2020 2063 726f 706c 6973 742e 6170 7065     croplist.appe
-0003cb80: 6e64 2820 7465 6d70 2029 0a20 2020 2020  nd( temp ).     
-0003cb90: 2020 2074 656d 7020 3d20 616e 7473 2e6c     temp = ants.l
-0003cba0: 6973 745f 746f 5f6e 6469 6d61 6765 2820  ist_to_ndimage( 
-0003cbb0: 782c 2063 726f 706c 6973 7420 290a 2020  x, croplist ).  
-0003cbc0: 2020 2020 2020 7465 6d70 2e73 6574 5f6f        temp.set_o
-0003cbd0: 7269 6769 6e28 206d 796f 7269 6720 290a  rigin( myorig ).
-0003cbe0: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-0003cbf0: 656d 700a 2020 2020 656c 7365 3a0a 2020  emp.    else:.  
-0003cc00: 2020 2020 2020 7265 7475 726e 2820 616e        return( an
-0003cc10: 7473 2e63 726f 705f 696d 6167 6528 2078  ts.crop_image( x
-0003cc20: 2c20 6d61 736b 2029 2029 0a0a 0a64 6566  , mask ) )...def
-0003cc30: 206d 6d28 0a20 2020 2074 315f 696d 6167   mm(.    t1_imag
-0003cc40: 652c 0a20 2020 2068 6965 722c 0a20 2020  e,.    hier,.   
-0003cc50: 2072 7366 5f69 6d61 6765 3d5b 5d2c 0a20   rsf_image=[],. 
-0003cc60: 2020 2066 6c61 6972 5f69 6d61 6765 3d4e     flair_image=N
-0003cc70: 6f6e 652c 0a20 2020 206e 6d5f 696d 6167  one,.    nm_imag
-0003cc80: 655f 6c69 7374 3d4e 6f6e 652c 0a20 2020  e_list=None,.   
-0003cc90: 2064 775f 696d 6167 653d 5b5d 2c20 6276   dw_image=[], bv
-0003cca0: 616c 733d 5b5d 2c20 6276 6563 733d 5b5d  als=[], bvecs=[]
-0003ccb0: 2c0a 2020 2020 7065 7266 7573 696f 6e5f  ,.    perfusion_
-0003ccc0: 696d 6167 653d 4e6f 6e65 2c0a 2020 2020  image=None,.    
-0003ccd0: 7372 6d6f 6465 6c3d 4e6f 6e65 2c0a 2020  srmodel=None,.  
-0003cce0: 2020 646f 5f74 7261 6374 6f67 7261 7068    do_tractograph
-0003ccf0: 7920 3d20 4661 6c73 652c 0a20 2020 2064  y = False,.    d
-0003cd00: 6f5f 6b6b 203d 2046 616c 7365 2c0a 2020  o_kk = False,.  
-0003cd10: 2020 646f 5f6e 6f72 6d61 6c69 7a61 7469    do_normalizati
-0003cd20: 6f6e 203d 204e 6f6e 652c 0a20 2020 2067  on = None,.    g
-0003cd30: 726f 7570 5f74 656d 706c 6174 6520 3d20  roup_template = 
-0003cd40: 4e6f 6e65 2c0a 2020 2020 6772 6f75 705f  None,.    group_
-0003cd50: 7472 616e 7366 6f72 6d20 3d20 4e6f 6e65  transform = None
-0003cd60: 2c0a 2020 2020 7461 7267 6574 5f72 616e  ,.    target_ran
-0003cd70: 6765 203d 205b 302c 315d 2c0a 2020 2020  ge = [0,1],.    
-0003cd80: 6474 695f 6d6f 7469 6f6e 5f63 6f72 7265  dti_motion_corre
-0003cd90: 6374 203d 2027 5269 6769 6427 2c0a 2020  ct = 'Rigid',.  
-0003cda0: 2020 6474 695f 6465 6e6f 6973 6520 3d20    dti_denoise = 
-0003cdb0: 4661 6c73 652c 0a20 2020 2070 6572 6675  False,.    perfu
-0003cdc0: 7369 6f6e 5f74 7269 6d3d 3130 2c0a 2020  sion_trim=10,.  
-0003cdd0: 2020 7065 7266 7573 696f 6e5f 6d30 5f69    perfusion_m0_i
-0003cde0: 6d61 6765 3d4e 6f6e 652c 0a20 2020 2070  mage=None,.    p
-0003cdf0: 6572 6675 7369 6f6e 5f6d 303d 4e6f 6e65  erfusion_m0=None
-0003ce00: 2c0a 2020 2020 7273 665f 7570 7361 6d70  ,.    rsf_upsamp
-0003ce10: 6c69 6e67 3d33 2e30 2c0a 2020 2020 7465  ling=3.0,.    te
-0003ce20: 7374 5f72 756e 203d 2046 616c 7365 2c0a  st_run = False,.
-0003ce30: 2020 2020 7665 7262 6f73 6520 3d20 4661      verbose = Fa
-0003ce40: 6c73 6520 293a 0a20 2020 2022 2222 0a20  lse ):.    """. 
-0003ce50: 2020 204d 756c 7469 706c 6520 6d6f 6461     Multiple moda
-0003ce60: 6c69 7479 2070 726f 6365 7373 696e 6720  lity processing 
-0003ce70: 616e 6420 6e6f 726d 616c 697a 6174 696f  and normalizatio
-0003ce80: 6e0a 0a20 2020 2061 6767 7265 6761 7465  n..    aggregate
-0003ce90: 7320 6d6f 6461 6c69 7479 2d73 7065 6369  s modality-speci
-0003cea0: 6669 6320 7072 6f63 6573 7369 6e67 2075  fic processing u
-0003ceb0: 6e64 6572 206f 6e65 2072 6f6f 662e 2020  nder one roof.  
-0003cec0: 7365 6520 696e 6469 7669 6475 616c 0a20  see individual. 
-0003ced0: 2020 206d 6f64 616c 6974 7920 7370 6563     modality spec
-0003cee0: 6966 6963 2066 756e 6374 696f 6e73 2066  ific functions f
-0003cef0: 6f72 2064 6574 6169 6c73 2e0a 0a20 2020  or details...   
-0003cf00: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-0003cf10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 0a20  -------------.. 
-0003cf20: 2020 2074 315f 696d 6167 6520 3a20 7261     t1_image : ra
-0003cf30: 7720 7431 2069 6d61 6765 0a0a 2020 2020  w t1 image..    
-0003cf40: 6869 6572 2020 3a20 6f75 7470 7574 206f  hier  : output o
-0003cf50: 6620 616e 7473 7079 7431 772e 6869 6572  f antspyt1w.hier
-0003cf60: 6172 6368 6963 616c 2028 2073 6565 2072  archical ( see r
-0003cf70: 6561 6420 6869 6572 6172 6368 6963 616c  ead hierarchical
-0003cf80: 2029 0a0a 2020 2020 7273 665f 696d 6167   )..    rsf_imag
-0003cf90: 6520 3a20 6c69 7374 206f 6620 7265 7374  e : list of rest
-0003cfa0: 696e 6720 7374 6174 6520 666d 7269 0a0a  ing state fmri..
-0003cfb0: 2020 2020 666c 6169 725f 696d 6167 6520      flair_image 
-0003cfc0: 3a20 666c 6169 720a 0a20 2020 206e 6d5f  : flair..    nm_
-0003cfd0: 696d 6167 655f 6c69 7374 203a 206c 6973  image_list : lis
-0003cfe0: 7420 6f66 206e 6575 726f 6d65 6c61 6e69  t of neuromelani
-0003cff0: 6e20 696d 6167 6573 0a0a 2020 2020 6477  n images..    dw
-0003d000: 5f69 6d61 6765 203a 206c 6973 7420 6f66  _image : list of
-0003d010: 2064 6966 6675 7369 6f6e 2077 6569 6768   diffusion weigh
-0003d020: 7465 6420 696d 6167 6573 0a0a 2020 2020  ted images..    
-0003d030: 6276 616c 7320 3a20 6c69 7374 206f 6620  bvals : list of 
-0003d040: 6276 616c 7320 6669 6c65 206e 616d 6573  bvals file names
-0003d050: 0a0a 2020 2020 6276 6563 7320 3a20 6c69  ..    bvecs : li
-0003d060: 7374 206f 6620 6276 6563 7320 6669 6c65  st of bvecs file
-0003d070: 206e 616d 6573 0a0a 2020 2020 7065 7266   names..    perf
-0003d080: 7573 696f 6e5f 696d 6167 6520 3a20 7369  usion_image : si
-0003d090: 6e67 6c65 2070 6572 6675 7369 6f6e 2069  ngle perfusion i
-0003d0a0: 6d61 6765 0a0a 2020 2020 7372 6d6f 6465  mage..    srmode
-0003d0b0: 6c20 3a20 6f70 7469 6f6e 616c 2073 726d  l : optional srm
-0003d0c0: 6f64 656c 0a0a 2020 2020 646f 5f74 7261  odel..    do_tra
-0003d0d0: 6374 6f67 7261 7068 7920 3a20 626f 6f6c  ctography : bool
-0003d0e0: 6561 6e0a 0a20 2020 2064 6f5f 6b6b 203a  ean..    do_kk :
-0003d0f0: 2062 6f6f 6c65 616e 2074 6f20 636f 6e74   boolean to cont
-0003d100: 726f 6c20 7768 6574 6865 7220 7765 2063  rol whether we c
-0003d110: 6f6d 7075 7465 206b 656c 6c79 206b 6170  ompute kelly kap
-0003d120: 6f77 736b 6920 7468 6963 6b6e 6573 7320  owski thickness 
-0003d130: 696d 6167 6520 2873 6c6f 7729 0a0a 2020  image (slow)..  
-0003d140: 2020 646f 5f6e 6f72 6d61 6c69 7a61 7469    do_normalizati
-0003d150: 6f6e 203a 2074 656d 706c 6174 6520 7472  on : template tr
-0003d160: 616e 7366 6f72 6d61 7469 6f6e 2069 6620  ansformation if 
-0003d170: 6176 6169 6c61 626c 650a 0a20 2020 2067  available..    g
-0003d180: 726f 7570 5f74 656d 706c 6174 6520 3a20  roup_template : 
-0003d190: 6f70 7469 6f6e 616c 2072 6566 6572 656e  optional referen
-0003d1a0: 6365 2074 656d 706c 6174 6520 636f 7272  ce template corr
-0003d1b0: 6573 706f 6e64 696e 6720 746f 2074 6865  esponding to the
-0003d1c0: 2067 726f 7570 5f74 7261 6e73 666f 726d   group_transform
-0003d1d0: 0a0a 2020 2020 6772 6f75 705f 7472 616e  ..    group_tran
-0003d1e0: 7366 6f72 6d20 3a20 6f70 7469 6f6e 616c  sform : optional
-0003d1f0: 2074 7261 6e73 666f 726d 7320 636f 7272   transforms corr
-0003d200: 6573 706f 6e64 696e 6720 746f 2074 6865  esponding to the
-0003d210: 2067 726f 7570 5f74 656d 706c 6174 650a   group_template.
-0003d220: 0a20 2020 2074 6172 6765 745f 7261 6e67  .    target_rang
-0003d230: 6520 3a20 322d 656c 656d 656e 7420 7475  e : 2-element tu
-0003d240: 706c 650a 2020 2020 2020 2020 6120 7475  ple.        a tu
-0003d250: 706c 6520 6f72 2061 7272 6179 2064 6566  ple or array def
-0003d260: 696e 696e 6720 7468 6520 286d 696e 2c20  ining the (min, 
-0003d270: 6d61 7829 206f 6620 7468 6520 696e 7075  max) of the inpu
-0003d280: 7420 696d 6167 650a 2020 2020 2020 2020  t image.        
-0003d290: 2865 2e67 2e2c 205b 2d31 3237 2e35 2c20  (e.g., [-127.5, 
-0003d2a0: 3132 372e 355d 206f 7220 5b30 2c31 5d29  127.5] or [0,1])
-0003d2b0: 2e20 204f 7574 7075 7420 696d 6167 6573  .  Output images
-0003d2c0: 2077 696c 6c20 6265 2073 6361 6c65 6420   will be scaled 
-0003d2d0: 6261 636b 2074 6f20 6f72 6967 696e 616c  back to original
-0003d2e0: 0a20 2020 2020 2020 2069 6e74 656e 7369  .        intensi
-0003d2f0: 7479 2e20 5468 6973 2072 616e 6765 2073  ty. This range s
-0003d300: 686f 756c 6420 6d61 7463 6820 7468 6520  hould match the 
-0003d310: 6d61 7070 696e 6720 7573 6564 2069 6e20  mapping used in 
-0003d320: 7468 6520 7472 6169 6e69 6e67 0a20 2020  the training.   
-0003d330: 2020 2020 206f 6620 7468 6520 6e65 7477       of the netw
-0003d340: 6f72 6b2e 0a20 2020 200a 2020 2020 6474  ork..    .    dt
-0003d350: 695f 6d6f 7469 6f6e 5f63 6f72 7265 6374  i_motion_correct
-0003d360: 203a 204e 6f6e 6520 5269 6769 6420 6f72   : None Rigid or
-0003d370: 2053 794e 0a0a 2020 2020 6474 695f 6465   SyN..    dti_de
-0003d380: 6e6f 6973 6520 3a20 626f 6f6c 6561 6e0a  noise : boolean.
-0003d390: 0a20 2020 2070 6572 6675 7369 6f6e 5f74  .    perfusion_t
-0003d3a0: 7269 6d20 3a20 6f70 7469 6f6e 616c 2069  rim : optional i
-0003d3b0: 6e74 6567 6572 206e 756d 6265 7220 6f66  nteger number of
-0003d3c0: 2074 696d 6520 766f 6c75 6d65 7320 746f   time volumes to
-0003d3d0: 2065 7863 6c75 6465 2066 726f 6d20 7468   exclude from th
-0003d3e0: 6520 6672 6f6e 7420 6f66 2074 6865 2070  e front of the p
-0003d3f0: 6572 6675 7369 6f6e 2074 696d 6520 7365  erfusion time se
-0003d400: 7269 6573 0a0a 2020 2020 7065 7266 7573  ries..    perfus
-0003d410: 696f 6e5f 6d30 5f69 6d61 6765 203a 206f  ion_m0_image : o
-0003d420: 7074 696f 6e61 6c20 616e 7473 496d 6167  ptional antsImag
-0003d430: 6520 6d30 2061 7373 6f63 6961 7465 6420  e m0 associated 
-0003d440: 7769 7468 2074 6865 2070 6572 6675 7369  with the perfusi
-0003d450: 6f6e 2074 696d 6520 7365 7269 6573 0a0a  on time series..
-0003d460: 2020 2020 7065 7266 7573 696f 6e5f 6d30      perfusion_m0
-0003d470: 203a 206f 7074 696f 6e61 6c20 6c69 7374   : optional list
-0003d480: 2063 6f6e 7461 696e 696e 6720 696e 6469   containing indi
-0003d490: 6365 7320 6f66 2074 6865 206d 3020 696e  ces of the m0 in
-0003d4a0: 2074 6865 2070 6572 6675 7369 6f6e 2074   the perfusion t
-0003d4b0: 696d 6520 7365 7269 6573 0a0a 2020 2020  ime series..    
-0003d4c0: 7273 665f 7570 7361 6d70 6c69 6e67 203a  rsf_upsampling :
-0003d4d0: 206f 7074 696f 6e61 6c20 7570 7361 6d70   optional upsamp
-0003d4e0: 6c69 6e67 2070 6172 616d 6574 6572 2076  ling parameter v
-0003d4f0: 616c 7565 2069 6e20 6d6d 3b20 6966 2073  alue in mm; if s
-0003d500: 6574 2074 6f20 7a65 726f 2c20 6e6f 2075  et to zero, no u
-0003d510: 7073 616d 706c 696e 6720 6973 2064 6f6e  psampling is don
-0003d520: 650a 0a20 2020 2074 6573 745f 7275 6e20  e..    test_run 
-0003d530: 3a20 626f 6f6c 6561 6e20 0a0a 2020 2020  : boolean ..    
-0003d540: 7665 7262 6f73 6520 3a20 626f 6f6c 6561  verbose : boolea
-0003d550: 6e0a 0a20 2020 2022 2222 0a20 2020 2066  n..    """.    f
-0003d560: 726f 6d20 6f73 2e70 6174 6820 696d 706f  rom os.path impo
-0003d570: 7274 2065 7869 7374 730a 2020 2020 6578  rt exists.    ex
-0003d580: 5f70 6174 6820 3d20 6f73 2e70 6174 682e  _path = os.path.
-0003d590: 6578 7061 6e64 7573 6572 2820 227e 2f2e  expanduser( "~/.
-0003d5a0: 616e 7473 7079 7431 772f 2220 290a 2020  antspyt1w/" ).  
-0003d5b0: 2020 6578 5f70 6174 685f 6d6d 203d 206f    ex_path_mm = o
-0003d5c0: 732e 7061 7468 2e65 7870 616e 6475 7365  s.path.expanduse
-0003d5d0: 7228 2022 7e2f 2e61 6e74 7370 796d 6d2f  r( "~/.antspymm/
-0003d5e0: 2220 290a 2020 2020 6d79 6373 7666 6e20  " ).    mycsvfn 
-0003d5f0: 3d20 6578 5f70 6174 6820 2b20 2246 415f  = ex_path + "FA_
-0003d600: 4a48 555f 6c61 6265 6c73 5f65 6469 7465  JHU_labels_edite
-0003d610: 642e 6373 7622 0a20 2020 2063 6974 6373  d.csv".    citcs
-0003d620: 7666 6e20 3d20 6578 5f70 6174 6820 2b20  vfn = ex_path + 
-0003d630: 2243 4954 3136 385f 5265 696e 665f 4c65  "CIT168_Reinf_Le
-0003d640: 6172 6e5f 7631 5f6c 6162 656c 5f64 6573  arn_v1_label_des
-0003d650: 6372 6970 7469 6f6e 735f 7061 642e 6373  criptions_pad.cs
-0003d660: 7622 0a20 2020 2064 6b74 6373 7666 6e20  v".    dktcsvfn 
-0003d670: 3d20 6578 5f70 6174 6820 2b20 2264 6b74  = ex_path + "dkt
-0003d680: 2e63 7376 220a 2020 2020 636e 7863 7376  .csv".    cnxcsv
-0003d690: 666e 203d 2065 785f 7061 7468 202b 2022  fn = ex_path + "
-0003d6a0: 646b 745f 636f 7274 6578 5f63 6974 5f64  dkt_cortex_cit_d
-0003d6b0: 6565 705f 6272 6169 6e2e 6373 7622 0a20  eep_brain.csv". 
-0003d6c0: 2020 204a 4855 5f61 746c 6173 666e 203d     JHU_atlasfn =
-0003d6d0: 2065 785f 7061 7468 202b 2027 4a48 552d   ex_path + 'JHU-
-0003d6e0: 4943 424d 2d46 412d 316d 6d2e 6e69 692e  ICBM-FA-1mm.nii.
-0003d6f0: 677a 2720 2320 5265 6164 2069 6e20 4a48  gz' # Read in JH
-0003d700: 5520 6174 6c61 730a 2020 2020 4a48 555f  U atlas.    JHU_
-0003d710: 6c61 6265 6c73 666e 203d 2065 785f 7061  labelsfn = ex_pa
-0003d720: 7468 202b 2027 4a48 552d 4943 424d 2d6c  th + 'JHU-ICBM-l
-0003d730: 6162 656c 732d 316d 6d2e 6e69 692e 677a  abels-1mm.nii.gz
-0003d740: 2720 2320 5265 6164 2069 6e20 4a48 5520  ' # Read in JHU 
-0003d750: 6c61 6265 6c73 0a20 2020 2074 656d 706c  labels.    templ
-0003d760: 6174 6566 6e20 3d20 6578 5f70 6174 6820  atefn = ex_path 
-0003d770: 2b20 2743 4954 3136 385f 5431 775f 3730  + 'CIT168_T1w_70
-0003d780: 3075 6d5f 7061 645f 6164 6e69 2e6e 6969  0um_pad_adni.nii
-0003d790: 2e67 7a27 0a20 2020 2069 6620 6e6f 7420  .gz'.    if not 
-0003d7a0: 6578 6973 7473 2820 6d79 6373 7666 6e20  exists( mycsvfn 
-0003d7b0: 2920 6f72 206e 6f74 2065 7869 7374 7328  ) or not exists(
-0003d7c0: 2063 6974 6373 7666 6e20 2920 6f72 206e   citcsvfn ) or n
-0003d7d0: 6f74 2065 7869 7374 7328 2063 6e78 6373  ot exists( cnxcs
-0003d7e0: 7666 6e20 2920 6f72 206e 6f74 2065 7869  vfn ) or not exi
-0003d7f0: 7374 7328 2064 6b74 6373 7666 6e20 2920  sts( dktcsvfn ) 
-0003d800: 6f72 206e 6f74 2065 7869 7374 7328 204a  or not exists( J
-0003d810: 4855 5f61 746c 6173 666e 2029 206f 7220  HU_atlasfn ) or 
-0003d820: 6e6f 7420 6578 6973 7473 2820 4a48 555f  not exists( JHU_
-0003d830: 6c61 6265 6c73 666e 2029 206f 7220 6e6f  labelsfn ) or no
-0003d840: 7420 6578 6973 7473 2820 7465 6d70 6c61  t exists( templa
-0003d850: 7465 666e 2029 3a0a 2020 2020 2020 2020  tefn ):.        
-0003d860: 7072 696e 7428 2022 2a2a 6d69 7373 696e  print( "**missin
-0003d870: 6720 6669 6c65 732a 2a20 3d3e 2063 616c  g files** => cal
-0003d880: 6c20 6765 745f 6461 7461 2066 726f 6d20  l get_data from 
-0003d890: 6c61 7465 7374 2061 6e74 7370 7974 3177  latest antspyt1w
-0003d8a0: 2061 6e64 2061 6e74 7370 796d 6d2e 2220   and antspymm." 
-0003d8b0: 290a 2020 2020 2020 2020 7261 6973 6520  ).        raise 
-0003d8c0: 5661 6c75 6545 7272 6f72 2827 2a2a 6d69  ValueError('**mi
-0003d8d0: 7373 696e 6720 6669 6c65 732a 2a20 3d3e  ssing files** =>
-0003d8e0: 2063 616c 6c20 6765 745f 6461 7461 2066   call get_data f
-0003d8f0: 726f 6d20 6c61 7465 7374 2061 6e74 7370  rom latest antsp
-0003d900: 7974 3177 2061 6e64 2061 6e74 7370 796d  yt1w and antspym
-0003d910: 6d2e 2729 0a20 2020 206d 7963 7376 203d  m.').    mycsv =
-0003d920: 2070 642e 7265 6164 5f63 7376 2820 206d   pd.read_csv(  m
-0003d930: 7963 7376 666e 2029 0a20 2020 2063 6974  ycsvfn ).    cit
-0003d940: 6373 7620 3d20 7064 2e72 6561 645f 6373  csv = pd.read_cs
-0003d950: 7628 2020 6f73 2e70 6174 682e 6578 7061  v(  os.path.expa
-0003d960: 6e64 7573 6572 2820 6369 7463 7376 666e  nduser( citcsvfn
-0003d970: 2029 2029 0a20 2020 2064 6b74 6373 7620   ) ).    dktcsv 
-0003d980: 3d20 7064 2e72 6561 645f 6373 7628 2020  = pd.read_csv(  
-0003d990: 6f73 2e70 6174 682e 6578 7061 6e64 7573  os.path.expandus
-0003d9a0: 6572 2820 646b 7463 7376 666e 2029 2029  er( dktcsvfn ) )
-0003d9b0: 0a20 2020 2063 6e78 6373 7620 3d20 7064  .    cnxcsv = pd
-0003d9c0: 2e72 6561 645f 6373 7628 2020 6f73 2e70  .read_csv(  os.p
-0003d9d0: 6174 682e 6578 7061 6e64 7573 6572 2820  ath.expanduser( 
-0003d9e0: 636e 7863 7376 666e 2029 2029 0a20 2020  cnxcsvfn ) ).   
-0003d9f0: 204a 4855 5f61 746c 6173 203d 206d 6d5f   JHU_atlas = mm_
-0003da00: 7265 6164 2820 4a48 555f 6174 6c61 7366  read( JHU_atlasf
-0003da10: 6e20 2920 2320 5265 6164 2069 6e20 4a48  n ) # Read in JH
-0003da20: 5520 6174 6c61 730a 2020 2020 4a48 555f  U atlas.    JHU_
-0003da30: 6c61 6265 6c73 203d 206d 6d5f 7265 6164  labels = mm_read
-0003da40: 2820 4a48 555f 6c61 6265 6c73 666e 2029  ( JHU_labelsfn )
-0003da50: 2023 2052 6561 6420 696e 204a 4855 206c   # Read in JHU l
-0003da60: 6162 656c 730a 2020 2020 7465 6d70 6c61  abels.    templa
-0003da70: 7465 203d 206d 6d5f 7265 6164 2820 7465  te = mm_read( te
-0003da80: 6d70 6c61 7465 666e 2029 2023 2052 6561  mplatefn ) # Rea
-0003da90: 6420 696e 2074 656d 706c 6174 650a 2020  d in template.  
-0003daa0: 2020 6966 2067 726f 7570 5f74 656d 706c    if group_templ
-0003dab0: 6174 6520 6973 204e 6f6e 653a 0a20 2020  ate is None:.   
-0003dac0: 2020 2020 2067 726f 7570 5f74 656d 706c       group_templ
-0003dad0: 6174 6520 3d20 7465 6d70 6c61 7465 0a20  ate = template. 
-0003dae0: 2020 2020 2020 2067 726f 7570 5f74 7261         group_tra
-0003daf0: 6e73 666f 726d 203d 2064 6f5f 6e6f 726d  nsform = do_norm
-0003db00: 616c 697a 6174 696f 6e5b 2766 7764 7472  alization['fwdtr
-0003db10: 616e 7366 6f72 6d73 275d 0a20 2020 2069  ansforms'].    i
-0003db20: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-0003db30: 2020 2070 7269 6e74 2822 5573 696e 6720     print("Using 
-0003db40: 6772 6f75 7020 7465 6d70 6c61 7465 3a22  group template:"
-0003db50: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
-0003db60: 2067 726f 7570 5f74 656d 706c 6174 6520   group_template 
-0003db70: 290a 2020 2020 2323 2323 2323 2323 2323  ).    ##########
-0003db80: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
-0003db90: 2320 2054 3120 6869 6572 6172 6368 6963  #  T1 hierarchic
-0003dba0: 616c 2020 230a 2020 2020 2323 2323 2323  al  #.    ######
-0003dbb0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-0003dbc0: 2020 2020 7431 696d 6762 726e 203d 2068      t1imgbrn = h
-0003dbd0: 6965 725b 2762 7261 696e 5f6e 345f 646e  ier['brain_n4_dn
-0003dbe0: 7a27 5d0a 2020 2020 7431 6174 726f 706f  z'].    t1atropo
-0003dbf0: 7320 3d20 6869 6572 5b27 646b 745f 7061  s = hier['dkt_pa
-0003dc00: 7263 275d 5b27 7469 7373 7565 5f73 6567  rc']['tissue_seg
-0003dc10: 6d65 6e74 6174 696f 6e27 5d0a 2020 2020  mentation'].    
-0003dc20: 6f75 7470 7574 5f64 6963 7420 3d20 7b0a  output_dict = {.
-0003dc30: 2020 2020 2020 2020 276b 6b27 3a20 4e6f          'kk': No
-0003dc40: 6e65 2c0a 2020 2020 2020 2020 2772 7366  ne,.        'rsf
-0003dc50: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-0003dc60: 2027 666c 6169 7227 203a 204e 6f6e 652c   'flair' : None,
-0003dc70: 0a20 2020 2020 2020 2027 4e4d 2720 3a20  .        'NM' : 
-0003dc80: 4e6f 6e65 2c0a 2020 2020 2020 2020 2744  None,.        'D
-0003dc90: 5449 2720 3a20 4e6f 6e65 2c0a 2020 2020  TI' : None,.    
-0003dca0: 2020 2020 2746 415f 7375 6d6d 2720 3a20      'FA_summ' : 
-0003dcb0: 4e6f 6e65 2c0a 2020 2020 2020 2020 274d  None,.        'M
-0003dcc0: 445f 7375 6d6d 2720 3a20 4e6f 6e65 2c0a  D_summ' : None,.
-0003dcd0: 2020 2020 2020 2020 2774 7261 6374 6f67          'tractog
-0003dce0: 7261 7068 7927 203a 204e 6f6e 652c 0a20  raphy' : None,. 
-0003dcf0: 2020 2020 2020 2027 7472 6163 746f 6772         'tractogr
-0003dd00: 6170 6879 5f63 6f6e 6e65 6374 6976 6974  aphy_connectivit
-0003dd10: 7927 203a 204e 6f6e 652c 0a20 2020 2020  y' : None,.     
-0003dd20: 2020 2027 7065 7266 2720 3a20 4e6f 6e65     'perf' : None
-0003dd30: 2c0a 2020 2020 7d0a 2020 2020 6e6f 726d  ,.    }.    norm
-0003dd40: 616c 697a 6174 696f 6e5f 6469 6374 203d  alization_dict =
-0003dd50: 207b 0a20 2020 2020 2020 2027 6b6b 5f6e   {.        'kk_n
-0003dd60: 6f72 6d27 3a20 4e6f 6e65 2c0a 2020 2020  orm': None,.    
-0003dd70: 2020 2020 274e 4d5f 6e6f 726d 2720 3a20      'NM_norm' : 
-0003dd80: 4e6f 6e65 2c0a 2020 2020 2020 2020 2744  None,.        'D
-0003dd90: 5449 5f6e 6f72 6d27 3a20 4e6f 6e65 2c0a  TI_norm': None,.
-0003dda0: 2020 2020 2020 2020 2746 415f 6e6f 726d          'FA_norm
-0003ddb0: 2720 3a20 4e6f 6e65 2c0a 2020 2020 2020  ' : None,.      
-0003ddc0: 2020 274d 445f 6e6f 726d 2720 3a20 4e6f    'MD_norm' : No
-0003ddd0: 6e65 2c0a 2020 2020 2020 2020 2770 6572  ne,.        'per
-0003dde0: 665f 6e6f 726d 2720 3a20 4e6f 6e65 2c0a  f_norm' : None,.
-0003ddf0: 2020 2020 2020 2020 2761 6c66 665f 6e6f          'alff_no
-0003de00: 726d 2720 3a20 4e6f 6e65 2c0a 2020 2020  rm' : None,.    
-0003de10: 2020 2020 2766 616c 6666 5f6e 6f72 6d27      'falff_norm'
-0003de20: 203a 204e 6f6e 652c 0a20 2020 2020 2020   : None,.       
-0003de30: 2027 4369 6e67 756c 6f6f 7065 7263 756c   'Cinguloopercul
-0003de40: 6172 5461 736b 436f 6e74 726f 6c5f 6e6f  arTaskControl_no
-0003de50: 726d 2720 3a20 4e6f 6e65 2c0a 2020 2020  rm' : None,.    
-0003de60: 2020 2020 2744 6566 6175 6c74 4d6f 6465      'DefaultMode
-0003de70: 5f6e 6f72 6d27 203a 204e 6f6e 652c 0a20  _norm' : None,. 
-0003de80: 2020 2020 2020 2027 4d65 6d6f 7279 5265         'MemoryRe
-0003de90: 7472 6965 7661 6c5f 6e6f 726d 2720 3a20  trieval_norm' : 
-0003dea0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2756  None,.        'V
-0003deb0: 656e 7472 616c 4174 7465 6e74 696f 6e5f  entralAttention_
-0003dec0: 6e6f 726d 2720 3a20 4e6f 6e65 2c0a 2020  norm' : None,.  
-0003ded0: 2020 2020 2020 2756 6973 7561 6c5f 6e6f        'Visual_no
-0003dee0: 726d 2720 3a20 4e6f 6e65 2c0a 2020 2020  rm' : None,.    
-0003def0: 2020 2020 2746 726f 6e74 6f70 6172 6965      'Frontoparie
-0003df00: 7461 6c54 6173 6b43 6f6e 7472 6f6c 5f6e  talTaskControl_n
-0003df10: 6f72 6d27 203a 204e 6f6e 652c 0a20 2020  orm' : None,.   
-0003df20: 2020 2020 2027 5361 6c69 656e 6365 5f6e       'Salience_n
-0003df30: 6f72 6d27 203a 204e 6f6e 652c 0a20 2020  orm' : None,.   
-0003df40: 2020 2020 2027 5375 6263 6f72 7469 6361       'Subcortica
-0003df50: 6c5f 6e6f 726d 2720 3a20 4e6f 6e65 2c0a  l_norm' : None,.
-0003df60: 2020 2020 2020 2020 2744 6f72 7361 6c41          'DorsalA
-0003df70: 7474 656e 7469 6f6e 5f6e 6f72 6d27 203a  ttention_norm' :
-0003df80: 204e 6f6e 650a 2020 2020 7d0a 2020 2020   None.    }.    
-0003df90: 6966 2074 6573 745f 7275 6e3a 0a20 2020  if test_run:.   
-0003dfa0: 2020 2020 2072 6574 7572 6e20 6f75 7470       return outp
-0003dfb0: 7574 5f64 6963 742c 206e 6f72 6d61 6c69  ut_dict, normali
-0003dfc0: 7a61 7469 6f6e 5f64 6963 740a 0a20 2020  zation_dict..   
-0003dfd0: 2069 6620 646f 5f6b 6b3a 0a20 2020 2020   if do_kk:.     
-0003dfe0: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
-0003dff0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0003e000: 2827 6b6b 2729 0a20 2020 2020 2020 206f  ('kk').        o
-0003e010: 7574 7075 745f 6469 6374 5b27 6b6b 275d  utput_dict['kk']
-0003e020: 203d 2061 6e74 7370 7974 3177 2e6b 656c   = antspyt1w.kel
-0003e030: 6c79 5f6b 6170 6f77 736b 695f 7468 6963  ly_kapowski_thic
-0003e040: 6b6e 6573 7328 2068 6965 725b 2762 7261  kness( hier['bra
-0003e050: 696e 5f6e 345f 646e 7a27 5d2c 0a20 2020  in_n4_dnz'],.   
-0003e060: 2020 2020 2020 2020 206c 6162 656c 733d           labels=
-0003e070: 6869 6572 5b27 646b 745f 7061 7263 275d  hier['dkt_parc']
-0003e080: 5b27 646b 745f 636f 7274 6578 275d 2c20  ['dkt_cortex'], 
-0003e090: 6974 6572 6174 696f 6e73 3d34 3520 290a  iterations=45 ).
-0003e0a0: 2020 2020 6966 2020 7065 7266 7573 696f      if  perfusio
-0003e0b0: 6e5f 696d 6167 6520 6973 206e 6f74 204e  n_image is not N
-0003e0c0: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
-0003e0d0: 7065 7266 7573 696f 6e5f 696d 6167 652e  perfusion_image.
-0003e0e0: 7368 6170 655b 335d 203e 2031 3a20 2320  shape[3] > 1: # 
-0003e0f0: 4649 584d 4520 2d20 6265 7474 6572 2068  FIXME - better h
-0003e100: 6575 7269 7374 6963 3f0a 2020 2020 2020  euristic?.      
-0003e110: 2020 2020 2020 6f75 7470 7574 5f64 6963        output_dic
-0003e120: 745b 2770 6572 6627 5d20 3d20 626f 6c64  t['perf'] = bold
-0003e130: 5f70 6572 6675 7369 6f6e 280a 2020 2020  _perfusion(.    
-0003e140: 2020 2020 2020 2020 2020 2020 7065 7266              perf
-0003e150: 7573 696f 6e5f 696d 6167 652c 0a20 2020  usion_image,.   
-0003e160: 2020 2020 2020 2020 2020 2020 2074 315f               t1_
-0003e170: 696d 6167 652c 0a20 2020 2020 2020 2020  image,.         
-0003e180: 2020 2020 2020 2068 6965 725b 2762 7261         hier['bra
-0003e190: 696e 5f6e 345f 646e 7a27 5d2c 0a20 2020  in_n4_dnz'],.   
-0003e1a0: 2020 2020 2020 2020 2020 2020 2074 3161               t1a
-0003e1b0: 7472 6f70 6f73 2c0a 2020 2020 2020 2020  tropos,.        
-0003e1c0: 2020 2020 2020 2020 6869 6572 5b27 646b          hier['dk
-0003e1d0: 745f 7061 7263 275d 5b27 646b 745f 636f  t_parc']['dkt_co
-0003e1e0: 7274 6578 275d 202b 2068 6965 725b 2763  rtex'] + hier['c
-0003e1f0: 6974 3136 386c 6162 275d 2c0a 2020 2020  it168lab'],.    
-0003e200: 2020 2020 2020 2020 2020 2020 6e5f 746f              n_to
-0003e210: 5f74 7269 6d20 3d20 7065 7266 7573 696f  _trim = perfusio
-0003e220: 6e5f 7472 696d 2c0a 2020 2020 2020 2020  n_trim,.        
-0003e230: 2020 2020 2020 2020 6d30 5f69 6d61 6765          m0_image
-0003e240: 203d 2070 6572 6675 7369 6f6e 5f6d 305f   = perfusion_m0_
-0003e250: 696d 6167 652c 0a20 2020 2020 2020 2020  image,.         
-0003e260: 2020 2020 2020 206d 305f 696e 6469 6365         m0_indice
-0003e270: 7320 3d20 7065 7266 7573 696f 6e5f 6d30  s = perfusion_m0
-0003e280: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003e290: 2020 7665 7262 6f73 653d 7665 7262 6f73    verbose=verbos
-0003e2a0: 6520 290a 2020 2020 2323 2323 2323 2323  e ).    ########
-0003e2b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0003e2c0: 2323 2323 2323 2323 2323 2064 6f20 7468  ########## do th
-0003e2d0: 6520 7273 6620 2e2e 2e2e 2e0a 2020 2020  e rsf ......    
-0003e2e0: 6966 206c 656e 2872 7366 5f69 6d61 6765  if len(rsf_image
-0003e2f0: 2920 3e20 303a 0a20 2020 2020 2020 206d  ) > 0:.        m
-0003e300: 795f 6d6f 7469 6f6e 5f74 7820 3d20 2752  y_motion_tx = 'R
-0003e310: 6967 6964 270a 2020 2020 2020 2020 7273  igid'.        rs
-0003e320: 665f 696d 6167 6520 3d20 5b69 2066 6f72  f_image = [i for
-0003e330: 2069 2069 6e20 7273 665f 696d 6167 6520   i in rsf_image 
-0003e340: 6966 2069 2069 7320 6e6f 7420 4e6f 6e65  if i is not None
-0003e350: 5d0a 2020 2020 2020 2020 6966 2076 6572  ].        if ver
-0003e360: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-0003e370: 2020 7072 696e 7428 2772 7366 206c 656e    print('rsf len
-0003e380: 6774 6820 2720 2b20 7374 7228 206c 656e  gth ' + str( len
-0003e390: 2820 7273 665f 696d 6167 6520 2920 2920  ( rsf_image ) ) 
-0003e3a0: 290a 2020 2020 2020 2020 6966 206c 656e  ).        if len
-0003e3b0: 2820 7273 665f 696d 6167 6520 2920 3e3d  ( rsf_image ) >=
-0003e3c0: 2032 3a20 2320 6173 7375 6d65 2032 2069   2: # assume 2 i
-0003e3d0: 7320 7468 6520 6c61 7267 6573 7420 706f  s the largest po
-0003e3e0: 7373 6962 6c65 2076 616c 7565 0a20 2020  ssible value.   
-0003e3f0: 2020 2020 2020 2020 2072 7366 5f69 6d61           rsf_ima
-0003e400: 6765 3120 3d20 7273 665f 696d 6167 655b  ge1 = rsf_image[
-0003e410: 305d 0a20 2020 2020 2020 2020 2020 2072  0].            r
-0003e420: 7366 5f69 6d61 6765 3220 3d20 7273 665f  sf_image2 = rsf_
-0003e430: 696d 6167 655b 315d 0a20 2020 2020 2020  image[1].       
-0003e440: 2020 2020 2023 2062 7569 6c64 2061 2074       # build a t
-0003e450: 656d 706c 6174 6520 7468 656e 206a 6f69  emplate then joi
-0003e460: 6e20 7468 6520 696d 6167 6573 0a20 2020  n the images.   
-0003e470: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
-0003e480: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-0003e490: 2020 2020 2070 7269 6e74 2822 696e 6974       print("init
-0003e4a0: 6961 6c20 6176 6572 6167 6520 666f 7220  ial average for 
-0003e4b0: 7273 6622 290a 2020 2020 2020 2020 2020  rsf").          
-0003e4c0: 2020 7273 6661 7667 312c 2068 6c69 6e64    rsfavg1, hlind
-0003e4d0: 7320 3d20 6c6f 6f70 5f74 696d 6573 6572  s = loop_timeser
-0003e4e0: 6965 735f 6365 6e73 6f72 696e 6728 2072  ies_censoring( r
-0003e4f0: 7366 5f69 6d61 6765 312c 2030 2e31 2029  sf_image1, 0.1 )
-0003e500: 0a20 2020 2020 2020 2020 2020 2072 7366  .            rsf
-0003e510: 6176 6731 3d67 6574 5f61 7665 7261 6765  avg1=get_average
-0003e520: 5f72 7366 2872 7366 6176 6731 290a 2020  _rsf(rsfavg1).  
-0003e530: 2020 2020 2020 2020 2020 7273 6661 7667            rsfavg
-0003e540: 322c 2068 6c69 6e64 7320 3d20 6c6f 6f70  2, hlinds = loop
-0003e550: 5f74 696d 6573 6572 6965 735f 6365 6e73  _timeseries_cens
-0003e560: 6f72 696e 6728 2072 7366 5f69 6d61 6765  oring( rsf_image
-0003e570: 322c 2030 2e31 2029 0a20 2020 2020 2020  2, 0.1 ).       
-0003e580: 2020 2020 2072 7366 6176 6732 3d67 6574       rsfavg2=get
-0003e590: 5f61 7665 7261 6765 5f72 7366 2872 7366  _average_rsf(rsf
-0003e5a0: 6176 6732 290a 2020 2020 2020 2020 2020  avg2).          
-0003e5b0: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-0003e5c0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0003e5d0: 696e 7428 2274 656d 706c 6174 6520 6176  int("template av
-0003e5e0: 6572 6167 6520 666f 7220 7273 6622 290a  erage for rsf").
-0003e5f0: 2020 2020 2020 2020 2020 2020 696e 6974              init
-0003e600: 5f74 656d 7020 3d20 616e 7473 2e69 6d61  _temp = ants.ima
-0003e610: 6765 5f63 6c6f 6e65 2820 7273 6661 7667  ge_clone( rsfavg
-0003e620: 3120 290a 2020 2020 2020 2020 2020 2020  1 ).            
-0003e630: 6966 2072 7366 5f69 6d61 6765 312e 7368  if rsf_image1.sh
-0003e640: 6170 655b 335d 203c 2072 7366 5f69 6d61  ape[3] < rsf_ima
-0003e650: 6765 322e 7368 6170 655b 335d 3a0a 2020  ge2.shape[3]:.  
-0003e660: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0003e670: 6974 5f74 656d 7020 3d20 616e 7473 2e69  it_temp = ants.i
-0003e680: 6d61 6765 5f63 6c6f 6e65 2820 7273 6661  mage_clone( rsfa
-0003e690: 7667 3220 290a 2020 2020 2020 2020 2020  vg2 ).          
-0003e6a0: 2020 626f 6c64 5465 6d70 6c61 7465 203d    boldTemplate =
-0003e6b0: 2061 6e74 732e 6275 696c 645f 7465 6d70   ants.build_temp
-0003e6c0: 6c61 7465 280a 2020 2020 2020 2020 2020  late(.          
-0003e6d0: 2020 2020 2020 696e 6974 6961 6c5f 7465        initial_te
-0003e6e0: 6d70 6c61 7465 203d 2069 6e69 745f 7465  mplate = init_te
-0003e6f0: 6d70 2c0a 2020 2020 2020 2020 2020 2020  mp,.            
-0003e700: 2020 2020 696d 6167 655f 6c69 7374 3d5b      image_list=[
-0003e710: 7273 6661 7667 312c 7273 6661 7667 325d  rsfavg1,rsfavg2]
-0003e720: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003e730: 2020 6974 6572 6174 696f 6e73 3d35 2c20    iterations=5, 
-0003e740: 7665 7262 6f73 653d 4661 6c73 6520 290a  verbose=False ).
-0003e750: 2020 2020 2020 2020 2020 2020 6966 2076              if v
-0003e760: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-0003e770: 2020 2020 2020 2020 7072 696e 7428 226a          print("j
-0003e780: 6f69 6e20 7468 6520 3220 7273 6622 290a  oin the 2 rsf").
-0003e790: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-0003e7a0: 7366 5f69 6d61 6765 312e 7368 6170 655b  sf_image1.shape[
-0003e7b0: 335d 203e 2031 3020 616e 6420 7273 665f  3] > 10 and rsf_
-0003e7c0: 696d 6167 6532 2e73 6861 7065 5b33 5d20  image2.shape[3] 
-0003e7d0: 3e20 3130 3a0a 2020 2020 2020 2020 2020  > 10:.          
-0003e7e0: 2020 2020 2020 6c65 6164 766f 6c73 203d        leadvols =
-0003e7f0: 206c 6973 7428 7261 6e67 6528 3829 290a   list(range(8)).
-0003e800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e810: 7273 665f 696d 6167 6532 203d 2072 656d  rsf_image2 = rem
-0003e820: 6f76 655f 766f 6c75 6d65 735f 6672 6f6d  ove_volumes_from
-0003e830: 5f74 696d 6573 6572 6965 7328 2072 7366  _timeseries( rsf
-0003e840: 5f69 6d61 6765 322c 206c 6561 6476 6f6c  _image2, leadvol
-0003e850: 7320 290a 2020 2020 2020 2020 2020 2020  s ).            
-0003e860: 2020 2020 7273 665f 696d 6167 6520 3d20      rsf_image = 
-0003e870: 6d65 7267 655f 7469 6d65 7365 7269 6573  merge_timeseries
-0003e880: 5f64 6174 6128 2072 7366 5f69 6d61 6765  _data( rsf_image
-0003e890: 312c 2072 7366 5f69 6d61 6765 3220 290a  1, rsf_image2 ).
-0003e8a0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-0003e8b0: 2072 7366 5f69 6d61 6765 312e 7368 6170   rsf_image1.shap
-0003e8c0: 655b 335d 203e 2072 7366 5f69 6d61 6765  e[3] > rsf_image
-0003e8d0: 322e 7368 6170 655b 335d 3a0a 2020 2020  2.shape[3]:.    
-0003e8e0: 2020 2020 2020 2020 2020 2020 7273 665f              rsf_
-0003e8f0: 696d 6167 6520 3d20 7273 665f 696d 6167  image = rsf_imag
-0003e900: 6531 0a20 2020 2020 2020 2020 2020 2065  e1.            e
-0003e910: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0003e920: 2020 2020 2072 7366 5f69 6d61 6765 203d       rsf_image =
-0003e930: 2072 7366 5f69 6d61 6765 320a 2020 2020   rsf_image2.    
-0003e940: 2020 2020 656c 6966 206c 656e 2820 7273      elif len( rs
-0003e950: 665f 696d 6167 6520 2920 3d3d 2031 3a0a  f_image ) == 1:.
-0003e960: 2020 2020 2020 2020 2020 2020 7273 665f              rsf_
-0003e970: 696d 6167 6520 3d20 7273 665f 696d 6167  image = rsf_imag
-0003e980: 655b 305d 0a20 2020 2020 2020 2020 2020  e[0].           
-0003e990: 2062 6f6c 6454 656d 706c 6174 652c 2068   boldTemplate, h
-0003e9a0: 6c69 6e64 7320 3d20 6c6f 6f70 5f74 696d  linds = loop_tim
-0003e9b0: 6573 6572 6965 735f 6365 6e73 6f72 696e  eseries_censorin
-0003e9c0: 6728 2072 7366 5f69 6d61 6765 2c20 302e  g( rsf_image, 0.
-0003e9d0: 3120 290a 2020 2020 2020 2020 2020 2020  1 ).            
-0003e9e0: 626f 6c64 5465 6d70 6c61 7465 203d 2067  boldTemplate = g
-0003e9f0: 6574 5f61 7665 7261 6765 5f72 7366 2862  et_average_rsf(b
-0003ea00: 6f6c 6454 656d 706c 6174 6529 0a20 2020  oldTemplate).   
-0003ea10: 2020 2020 2069 6620 7273 665f 696d 6167       if rsf_imag
-0003ea20: 652e 7368 6170 655b 335d 203e 2031 303a  e.shape[3] > 10:
-0003ea30: 2023 2046 4958 4d45 202d 2062 6574 7465   # FIXME - bette
-0003ea40: 7220 6865 7572 6973 7469 633f 0a20 2020  r heuristic?.   
-0003ea50: 2020 2020 2020 2020 2072 7366 7072 6f6c           rsfprol
-0003ea60: 6973 7420 3d20 5b5d 2023 2046 4958 4d45  ist = [] # FIXME
-0003ea70: 5253 460a 2020 2020 2020 2020 2020 2020  RSF.            
-0003ea80: 2320 4372 6561 7465 2074 6865 2070 6172  # Create the par
-0003ea90: 616d 6574 6572 2044 6174 6146 7261 6d65  ameter DataFrame
-0003eaa0: 0a20 2020 2020 2020 2020 2020 2064 6620  .            df 
-0003eab0: 3d20 7064 2e44 6174 6146 7261 6d65 287b  = pd.DataFrame({
-0003eac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003ead0: 2022 6e75 6d22 3a20 5b31 3334 2c20 3132   "num": [134, 12
-0003eae0: 322c 2031 3239 5d2c 0a20 2020 2020 2020  2, 129],.       
-0003eaf0: 2020 2020 2020 2020 2022 6c6f 6f70 223a           "loop":
-0003eb00: 205b 302e 3530 2c20 302e 3235 2c20 302e   [0.50, 0.25, 0.
-0003eb10: 3530 5d2c 0a20 2020 2020 2020 2020 2020  50],.           
-0003eb20: 2020 2020 2022 6365 6e73 223a 205b 5472       "cens": [Tr
-0003eb30: 7565 2c20 5472 7565 2c20 5472 7565 5d2c  ue, True, True],
-0003eb40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003eb50: 2022 484d 223a 205b 312e 302c 2035 2e30   "HM": [1.0, 5.0
-0003eb60: 2c20 302e 355d 2c0a 2020 2020 2020 2020  , 0.5],.        
-0003eb70: 2020 2020 2020 2020 2266 6622 3a20 5b22          "ff": ["
-0003eb80: 7469 6768 7422 2c20 2274 6967 6874 222c  tight", "tight",
-0003eb90: 2022 7469 6768 7422 5d2c 0a20 2020 2020   "tight"],.     
-0003eba0: 2020 2020 2020 2020 2020 2022 4343 223a             "CC":
-0003ebb0: 205b 352c 2035 2c20 302e 385d 2c0a 2020   [5, 5, 0.8],.  
-0003ebc0: 2020 2020 2020 2020 2020 2020 2020 2269                "i
-0003ebd0: 6d70 223a 205b 5472 7565 2c20 5472 7565  mp": [True, True
-0003ebe0: 2c20 5472 7565 5d2c 0a20 2020 2020 2020  , True],.       
-0003ebf0: 2020 2020 2020 2020 2022 7570 223a 205b           "up": [
-0003ec00: 7273 665f 7570 7361 6d70 6c69 6e67 2c20  rsf_upsampling, 
-0003ec10: 7273 665f 7570 7361 6d70 6c69 6e67 2c20  rsf_upsampling, 
-0003ec20: 7273 665f 7570 7361 6d70 6c69 6e67 5d2c  rsf_upsampling],
-0003ec30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003ec40: 2022 636f 6f72 6473 223a 205b 4661 6c73   "coords": [Fals
-0003ec50: 652c 4661 6c73 652c 4661 6c73 655d 0a20  e,False,False]. 
-0003ec60: 2020 2020 2020 2020 2020 207d 2c20 696e             }, in
-0003ec70: 6465 783d 5b30 2c20 312c 2032 5d29 0a20  dex=[0, 1, 2]). 
-0003ec80: 2020 2020 2020 2020 2020 2066 6f72 2070             for p
-0003ec90: 2069 6e20 7261 6e67 6528 6466 2e73 6861   in range(df.sha
-0003eca0: 7065 5b30 5d29 3a0a 2020 2020 2020 2020  pe[0]):.        
-0003ecb0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-0003ecc0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0003ecd0: 2020 2020 2020 2020 7072 696e 7428 2272          print("r
-0003ece0: 7366 2070 6172 616d 6574 6572 7322 290a  sf parameters").
-0003ecf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ed00: 2020 2020 7072 696e 7428 2064 662e 696c      print( df.il
-0003ed10: 6f63 5b70 5d20 290a 2020 2020 2020 2020  oc[p] ).        
-0003ed20: 2020 2020 2020 2020 6966 2064 665b 2766          if df['f
-0003ed30: 6627 5d2e 696c 6f63 5b70 5d20 3d3d 2027  f'].iloc[p] == '
-0003ed40: 6272 6f61 6427 3a0a 2020 2020 2020 2020  broad':.        
-0003ed50: 2020 2020 2020 2020 2020 2020 663d 5b20              f=[ 
-0003ed60: 302e 3030 382c 2030 2e31 3520 5d0a 2020  0.008, 0.15 ].  
-0003ed70: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0003ed80: 6966 2064 665b 2766 6627 5d2e 696c 6f63  if df['ff'].iloc
-0003ed90: 5b70 5d20 3d3d 2027 7469 6768 7427 3a0a  [p] == 'tight':.
-0003eda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003edb0: 2020 2020 663d 5b20 302e 3033 2c20 302e      f=[ 0.03, 0.
-0003edc0: 3038 205d 0a20 2020 2020 2020 2020 2020  08 ].           
-0003edd0: 2020 2020 2065 6c69 6620 6466 5b27 6666       elif df['ff
-0003ede0: 275d 2e69 6c6f 635b 705d 203d 3d20 276d  '].iloc[p] == 'm
-0003edf0: 6964 273a 0a20 2020 2020 2020 2020 2020  id':.           
-0003ee00: 2020 2020 2020 2020 2066 3d5b 2030 2e30           f=[ 0.0
-0003ee10: 312c 2030 2e31 205d 0a20 2020 2020 2020  1, 0.1 ].       
-0003ee20: 2020 2020 2020 2020 2065 6c69 6620 6466           elif df
-0003ee30: 5b27 6666 275d 2e69 6c6f 635b 705d 203d  ['ff'].iloc[p] =
-0003ee40: 3d20 276d 6964 3227 3a0a 2020 2020 2020  = 'mid2':.      
-0003ee50: 2020 2020 2020 2020 2020 2020 2020 663d                f=
-0003ee60: 5b20 302e 3031 2c20 302e 3038 205d 0a20  [ 0.01, 0.08 ]. 
-0003ee70: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0003ee80: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0003ee90: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-0003eea0: 616c 7565 4572 726f 7228 2277 6520 646f  alueError("we do
-0003eeb0: 206e 6f74 2072 6563 6f67 6e69 7a65 2074   not recognize t
-0003eec0: 6869 7320 7061 7261 6d65 7465 7220 6368  his parameter ch
-0003eed0: 6f69 6365 2066 6f72 2066 7265 7175 656e  oice for frequen
-0003eee0: 6379 2066 696c 7465 7269 6e67 3a20 2220  cy filtering: " 
-0003eef0: 2b20 6466 5b27 6666 275d 2e69 6c6f 635b  + df['ff'].iloc[
-0003ef00: 705d 2029 0a20 2020 2020 2020 2020 2020  p] ).           
-0003ef10: 2020 2020 2048 4d20 3d20 6466 5b27 484d       HM = df['HM
-0003ef20: 275d 2e69 6c6f 635b 705d 0a20 2020 2020  '].iloc[p].     
-0003ef30: 2020 2020 2020 2020 2020 2043 4320 3d20             CC = 
-0003ef40: 6466 5b27 4343 275d 2e69 6c6f 635b 705d  df['CC'].iloc[p]
-0003ef50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003ef60: 206c 6f6f 703d 2064 665b 276c 6f6f 7027   loop= df['loop'
-0003ef70: 5d2e 696c 6f63 5b70 5d0a 2020 2020 2020  ].iloc[p].      
-0003ef80: 2020 2020 2020 2020 2020 6365 6e73 203d            cens =
-0003ef90: 6466 5b27 6365 6e73 275d 2e69 6c6f 635b  df['cens'].iloc[
-0003efa0: 705d 0a20 2020 2020 2020 2020 2020 2020  p].             
-0003efb0: 2020 2069 6d70 203d 2064 665b 2769 6d70     imp = df['imp
-0003efc0: 275d 2e69 6c6f 635b 705d 0a20 2020 2020  '].iloc[p].     
-0003efd0: 2020 2020 2020 2020 2020 2072 7366 3020             rsf0 
-0003efe0: 3d20 7265 7374 696e 675f 7374 6174 655f  = resting_state_
-0003eff0: 666d 7269 5f6e 6574 776f 726b 7328 0a20  fmri_networks(. 
-0003f000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f020: 2020 2020 2020 2020 2020 2072 7366 5f69             rsf_i
-0003f030: 6d61 6765 2c0a 2020 2020 2020 2020 2020  mage,.          
-0003f040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f060: 2020 626f 6c64 5465 6d70 6c61 7465 2c0a    boldTemplate,.
-0003f070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f090: 2020 2020 2020 2020 2020 2020 6869 6572              hier
-0003f0a0: 5b27 6272 6169 6e5f 6e34 5f64 6e7a 275d  ['brain_n4_dnz']
-0003f0b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003f0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f0d0: 2020 2020 2020 2020 2020 2020 2020 7431                t1
-0003f0e0: 6174 726f 706f 732c 0a20 2020 2020 2020  atropos,.       
-0003f0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f110: 2020 2020 2066 3d66 2c0a 2020 2020 2020       f=f,.      
-0003f120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f140: 2020 2020 2020 4644 5f74 6872 6573 686f        FD_thresho
-0003f150: 6c64 3d48 4d2c 200a 2020 2020 2020 2020  ld=HM, .        
-0003f160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f180: 2020 2020 7370 6120 3d20 4e6f 6e65 2c20      spa = None, 
-0003f190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003f1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f1b0: 2020 2020 2020 2020 2020 2020 2073 7074               spt
-0003f1c0: 203d 204e 6f6e 652c 200a 2020 2020 2020   = None, .      
-0003f1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d6d0: 0a0a 2020 7272 5f6d 6173 6b20 3d20 616e  ..  rr_mask = an
+0002d6e0: 7473 2e6d 6173 6b5f 696d 6167 6528 206c  ts.mask_image( l
+0002d6f0: 6162 656c 7332 6e6d 2c20 6c61 6265 6c73  abels2nm, labels
+0002d700: 326e 6d2c 205b 3333 2c33 345d 202c 2062  2nm, [33,34] , b
+0002d710: 696e 6172 697a 653d 5472 7565 2029 0a20  inarize=True ). 
+0002d720: 2073 6e5f 6d61 736b 203d 2061 6e74 732e   sn_mask = ants.
+0002d730: 6d61 736b 5f69 6d61 6765 2820 6c61 6265  mask_image( labe
+0002d740: 6c73 326e 6d2c 206c 6162 656c 7332 6e6d  ls2nm, labels2nm
+0002d750: 2c20 5b37 2c39 2c32 332c 3235 5d20 2c20  , [7,9,23,25] , 
+0002d760: 6269 6e61 7269 7a65 3d54 7275 6520 290a  binarize=True ).
+0002d770: 2020 6e6d 6176 6773 6e72 203d 206d 6173    nmavgsnr = mas
+0002d780: 6b5f 736e 7228 206e 6d5f 6176 675f 6372  k_snr( nm_avg_cr
+0002d790: 6f70 7065 642c 2072 725f 6d61 736b 2c20  opped, rr_mask, 
+0002d7a0: 736e 5f6d 6173 6b2c 2062 6961 735f 636f  sn_mask, bias_co
+0002d7b0: 7272 6563 7420 3d20 4661 6c73 6520 290a  rrect = False ).
+0002d7c0: 0a20 2073 6e61 7667 203d 206e 6d5f 6176  .  snavg = nm_av
+0002d7d0: 675f 6372 6f70 7065 645b 2073 6e5f 6d61  g_cropped[ sn_ma
+0002d7e0: 736b 203d 3d20 315d 2e6d 6561 6e28 290a  sk == 1].mean().
+0002d7f0: 2020 7272 6176 6720 3d20 6e6d 5f61 7667    rravg = nm_avg
+0002d800: 5f63 726f 7070 6564 5b20 7272 5f6d 6173  _cropped[ rr_mas
+0002d810: 6b20 3d3d 2031 5d2e 6d65 616e 2829 0a20  k == 1].mean(). 
+0002d820: 2073 6e73 7464 203d 206e 6d5f 6176 675f   snstd = nm_avg_
+0002d830: 6372 6f70 7065 645b 2073 6e5f 6d61 736b  cropped[ sn_mask
+0002d840: 203d 3d20 315d 2e73 7464 2829 0a20 2072   == 1].std().  r
+0002d850: 7273 7464 203d 206e 6d5f 6176 675f 6372  rstd = nm_avg_cr
+0002d860: 6f70 7065 645b 2072 725f 6d61 736b 203d  opped[ rr_mask =
+0002d870: 3d20 315d 2e73 7464 2829 0a20 2076 6f6c  = 1].std().  vol
+0002d880: 5f65 6c65 6d65 6e74 203d 206e 702e 7072  _element = np.pr
+0002d890: 6f64 2820 616e 7473 2e67 6574 5f73 7061  od( ants.get_spa
+0002d8a0: 6369 6e67 2873 6e5f 6d61 736b 2920 290a  cing(sn_mask) ).
+0002d8b0: 2020 736e 766f 6c20 3d20 766f 6c5f 656c    snvol = vol_el
+0002d8c0: 656d 656e 7420 2a20 736e 5f6d 6173 6b2e  ement * sn_mask.
+0002d8d0: 7375 6d28 290a 0a20 2023 2067 6574 2074  sum()..  # get t
+0002d8e0: 6865 206d 6561 6e20 766f 7865 6c20 706f  he mean voxel po
+0002d8f0: 7369 7469 6f6e 206f 6620 7468 6520 534e  sition of the SN
+0002d900: 0a20 2069 6620 736e 766f 6c20 3e20 303a  .  if snvol > 0:
+0002d910: 0a20 2020 2020 2073 6e5f 7a20 3d20 616e  .      sn_z = an
+0002d920: 7473 2e74 7261 6e73 666f 726d 5f70 6879  ts.transform_phy
+0002d930: 7369 6361 6c5f 706f 696e 745f 746f 5f69  sical_point_to_i
+0002d940: 6e64 6578 2820 736e 5f6d 6173 6b2c 2061  ndex( sn_mask, a
+0002d950: 6e74 732e 6765 745f 6365 6e74 6572 5f6f  nts.get_center_o
+0002d960: 665f 6d61 7373 2873 6e5f 6d61 736b 2029  f_mass(sn_mask )
+0002d970: 295b 325d 0a20 2020 2020 2073 6e5f 7a20  )[2].      sn_z 
+0002d980: 3d20 736e 5f7a 2f73 6e5f 6d61 736b 2e73  = sn_z/sn_mask.s
+0002d990: 6861 7065 5b32 5d20 2320 6172 6f75 6e64  hape[2] # around
+0002d9a0: 2030 2e35 2077 6f75 6c64 2062 6520 6e69   0.5 would be ni
+0002d9b0: 6365 0a20 2065 6c73 653a 0a20 2020 2020  ce.  else:.     
+0002d9c0: 2073 6e5f 7a20 3d20 6d61 7468 2e6e 616e   sn_z = math.nan
+0002d9d0: 0a0a 2020 6e6d 5f65 7672 203d 2030 2e30  ..  nm_evr = 0.0
+0002d9e0: 0a20 2069 6620 6372 6f70 7065 7232 6e6d  .  if cropper2nm
+0002d9f0: 2e73 756d 2829 203e 2030 3a0a 2020 2020  .sum() > 0:.    
+0002da00: 6e6d 5f65 7672 203d 2061 6e74 7370 7974  nm_evr = antspyt
+0002da10: 3177 2e70 6174 6368 5f65 6967 656e 7661  1w.patch_eigenva
+0002da20: 6c75 655f 7261 7469 6f28 206e 6d5f 6176  lue_ratio( nm_av
+0002da30: 672c 2035 3132 2c20 5b36 2c36 2c36 5d2c  g, 512, [6,6,6],
+0002da40: 200a 2020 2020 2020 2020 6576 6465 7074   .        evdept
+0002da50: 6820 3d20 302e 392c 206d 6173 6b3d 6372  h = 0.9, mask=cr
+0002da60: 6f70 7065 7232 6e6d 2029 0a0a 2020 7369  opper2nm )..  si
+0002da70: 6d67 203d 2061 6e74 732e 736d 6f6f 7468  mg = ants.smooth
+0002da80: 5f69 6d61 6765 2820 6e6d 5f61 7667 5f63  _image( nm_avg_c
+0002da90: 726f 7070 6564 2c20 6e70 2e6d 696e 2861  ropped, np.min(a
+0002daa0: 6e74 732e 6765 745f 7370 6163 696e 6728  nts.get_spacing(
+0002dab0: 6e6d 5f61 7667 5f63 726f 7070 6564 2929  nm_avg_cropped))
+0002dac0: 2029 0a20 206b 203d 2032 2e30 0a20 2072   ).  k = 2.0.  r
+0002dad0: 7274 6872 6573 6820 3d20 2872 7261 7667  rthresh = (rravg
+0002dae0: 202b 206b 202a 2072 7273 7464 290a 2020   + k * rrstd).  
+0002daf0: 6e6d 6162 6f76 656b 7468 7265 7368 5f6d  nmabovekthresh_m
+0002db00: 6173 6b20 3d20 736e 5f6d 6173 6b20 2a20  ask = sn_mask * 
+0002db10: 616e 7473 2e74 6872 6573 686f 6c64 5f69  ants.threshold_i
+0002db20: 6d61 6765 2820 7369 6d67 2c20 7272 7468  mage( simg, rrth
+0002db30: 7265 7368 2c20 6d61 7468 2e69 6e66 290a  resh, math.inf).
+0002db40: 2020 736e 766f 6c61 626f 7665 7468 7265    snvolabovethre
+0002db50: 7368 203d 2076 6f6c 5f65 6c65 6d65 6e74  sh = vol_element
+0002db60: 202a 206e 6d61 626f 7665 6b74 6872 6573   * nmabovekthres
+0002db70: 685f 6d61 736b 2e73 756d 2829 0a20 2073  h_mask.sum().  s
+0002db80: 6e69 6e74 6d65 616e 6162 6f76 6574 6872  nintmeanabovethr
+0002db90: 6573 6820 3d20 2820 7369 6d67 202a 206e  esh = ( simg * n
+0002dba0: 6d61 626f 7665 6b74 6872 6573 685f 6d61  mabovekthresh_ma
+0002dbb0: 736b 2029 2e6d 6561 6e28 290a 2020 736e  sk ).mean().  sn
+0002dbc0: 696e 7473 756d 6162 6f76 6574 6872 6573  intsumabovethres
+0002dbd0: 6820 3d20 2820 7369 6d67 202a 206e 6d61  h = ( simg * nma
+0002dbe0: 626f 7665 6b74 6872 6573 685f 6d61 736b  bovekthresh_mask
+0002dbf0: 2029 2e73 756d 2829 0a20 200a 2020 6966   ).sum().  .  if
+0002dc00: 2076 6572 626f 7365 3a0a 2020 2020 7072   verbose:.    pr
+0002dc10: 696e 7428 2022 6e6d 2076 6f6c 2040 3273  int( "nm vol @2s
+0002dc20: 7464 2061 626f 7665 2072 726d 6561 6e3a  td above rrmean:
+0002dc30: 2022 202b 2073 7472 2820 736e 766f 6c61   " + str( snvola
+0002dc40: 626f 7665 7468 7265 7368 2029 2029 0a20  bovethresh ) ). 
+0002dc50: 2020 2070 7269 6e74 2820 226e 6d20 696e     print( "nm in
+0002dc60: 746d 6561 6e20 4032 7374 6420 6162 6f76  tmean @2std abov
+0002dc70: 6520 7272 6d65 616e 3a20 2220 2b20 7374  e rrmean: " + st
+0002dc80: 7228 2073 6e69 6e74 6d65 616e 6162 6f76  r( snintmeanabov
+0002dc90: 6574 6872 6573 6820 2920 290a 2020 2020  ethresh ) ).    
+0002dca0: 7072 696e 7428 2022 6e6d 2069 6e74 7375  print( "nm intsu
+0002dcb0: 6d20 4032 7374 6420 6162 6f76 6520 7272  m @2std above rr
+0002dcc0: 6d65 616e 3a20 2220 2b20 7374 7228 2073  mean: " + str( s
+0002dcd0: 6e69 6e74 7375 6d61 626f 7665 7468 7265  nintsumabovethre
+0002dce0: 7368 2029 2029 0a20 2020 2070 7269 6e74  sh ) ).    print
+0002dcf0: 2820 226e 6d20 646f 6e65 2220 290a 0a20  ( "nm done" ).. 
+0002dd00: 2072 6574 7572 6e7b 0a20 2020 2020 2027   return{.      '
+0002dd10: 4e4d 5f61 7667 2720 3a20 6e6d 5f61 7667  NM_avg' : nm_avg
+0002dd20: 2c0a 2020 2020 2020 274e 4d5f 6176 675f  ,.      'NM_avg_
+0002dd30: 6372 6f70 7065 6427 203a 206e 6d5f 6176  cropped' : nm_av
+0002dd40: 675f 6372 6f70 7065 642c 0a20 2020 2020  g_cropped,.     
+0002dd50: 2027 4e4d 5f6c 6162 656c 7327 3a20 6c61   'NM_labels': la
+0002dd60: 6265 6c73 326e 6d2c 0a20 2020 2020 2027  bels2nm,.      '
+0002dd70: 4e4d 5f63 726f 7070 6564 273a 2063 726f  NM_cropped': cro
+0002dd80: 705f 6e6d 5f6c 6973 742c 0a20 2020 2020  p_nm_list,.     
+0002dd90: 2027 4e4d 5f6d 6964 6272 6169 6e52 4f49   'NM_midbrainROI
+0002dda0: 273a 2063 726f 7070 6572 326e 6d2c 0a20  ': cropper2nm,. 
+0002ddb0: 2020 2020 2027 4e4d 5f64 6174 6166 7261       'NM_datafra
+0002ddc0: 6d65 273a 206e 6d64 662c 0a20 2020 2020  me': nmdf,.     
+0002ddd0: 2027 4e4d 5f64 6174 6166 7261 6d65 5f77   'NM_dataframe_w
+0002dde0: 6964 6527 3a20 6e6d 6466 5f77 6964 652c  ide': nmdf_wide,
+0002ddf0: 0a20 2020 2020 2027 7431 5f74 6f5f 4e4d  .      't1_to_NM
+0002de00: 273a 2073 6c61 6272 6567 5b27 7761 7270  ': slabreg['warp
+0002de10: 6564 6d6f 766f 7574 275d 2c0a 2020 2020  edmovout'],.    
+0002de20: 2020 2774 315f 746f 5f4e 4d5f 7472 616e    't1_to_NM_tran
+0002de30: 7366 6f72 6d27 203a 2073 6c61 6272 6567  sform' : slabreg
+0002de40: 5b27 6677 6474 7261 6e73 666f 726d 7327  ['fwdtransforms'
+0002de50: 5d2c 0a20 2020 2020 2027 4e4d 5f61 7667  ],.      'NM_avg
+0002de60: 5f73 6967 6e61 6c74 6f6e 6f69 7365 2720  _signaltonoise' 
+0002de70: 3a20 6e6d 6176 6773 6e72 2c0a 2020 2020  : nmavgsnr,.    
+0002de80: 2020 274e 4d5f 6176 675f 7375 6273 7461    'NM_avg_substa
+0002de90: 6e74 6961 6e69 6772 6127 203a 2073 6e61  ntianigra' : sna
+0002dea0: 7667 2c0a 2020 2020 2020 274e 4d5f 7374  vg,.      'NM_st
+0002deb0: 645f 7375 6273 7461 6e74 6961 6e69 6772  d_substantianigr
+0002dec0: 6127 203a 2073 6e73 7464 2c0a 2020 2020  a' : snstd,.    
+0002ded0: 2020 274e 4d5f 766f 6c75 6d65 5f73 7562    'NM_volume_sub
+0002dee0: 7374 616e 7469 616e 6967 7261 2720 3a20  stantianigra' : 
+0002def0: 736e 766f 6c2c 0a20 2020 2020 2027 4e4d  snvol,.      'NM
+0002df00: 5f76 6f6c 756d 655f 7375 6273 7461 6e74  _volume_substant
+0002df10: 6961 6e69 6772 615f 6162 6f76 655f 6b5f  ianigra_above_k_
+0002df20: 7468 7265 7368 2720 3a20 736e 766f 6c61  thresh' : snvola
+0002df30: 626f 7665 7468 7265 7368 2c0a 2020 2020  bovethresh,.    
+0002df40: 2020 274e 4d5f 696e 746d 6561 6e5f 7375    'NM_intmean_su
+0002df50: 6273 7461 6e74 6961 6e69 6772 615f 6162  bstantianigra_ab
+0002df60: 6f76 655f 6b5f 7468 7265 7368 2720 3a20  ove_k_thresh' : 
+0002df70: 736e 696e 746d 6561 6e61 626f 7665 7468  snintmeanaboveth
+0002df80: 7265 7368 2c0a 2020 2020 2020 274e 4d5f  resh,.      'NM_
+0002df90: 696e 7473 756d 5f73 7562 7374 616e 7469  intsum_substanti
+0002dfa0: 616e 6967 7261 5f61 626f 7665 5f6b 5f74  anigra_above_k_t
+0002dfb0: 6872 6573 6827 203a 2073 6e69 6e74 7375  hresh' : snintsu
+0002dfc0: 6d61 626f 7665 7468 7265 7368 2c0a 2020  mabovethresh,.  
+0002dfd0: 2020 2020 274e 4d5f 6176 675f 7265 6672      'NM_avg_refr
+0002dfe0: 6567 696f 6e27 203a 2072 7261 7667 2c0a  egion' : rravg,.
+0002dff0: 2020 2020 2020 274e 4d5f 7374 645f 7265        'NM_std_re
+0002e000: 6672 6567 696f 6e27 203a 2072 7273 7464  fregion' : rrstd
+0002e010: 2c0a 2020 2020 2020 274e 4d5f 6d69 6e27  ,.      'NM_min'
+0002e020: 203a 206e 6d5f 6176 675f 6372 6f70 7065   : nm_avg_croppe
+0002e030: 642e 6d69 6e28 292c 0a20 2020 2020 2027  d.min(),.      '
+0002e040: 4e4d 5f6d 6178 2720 3a20 6e6d 5f61 7667  NM_max' : nm_avg
+0002e050: 5f63 726f 7070 6564 2e6d 6178 2829 2c0a  _cropped.max(),.
+0002e060: 2020 2020 2020 274e 4d5f 6d65 616e 2720        'NM_mean' 
+0002e070: 3a20 6e6d 5f61 7667 5f63 726f 7070 6564  : nm_avg_cropped
+0002e080: 2e6e 756d 7079 2829 2e6d 6561 6e28 292c  .numpy().mean(),
+0002e090: 0a20 2020 2020 2027 4e4d 5f73 6427 203a  .      'NM_sd' :
+0002e0a0: 206e 702e 7374 6428 206e 6d5f 6176 675f   np.std( nm_avg_
+0002e0b0: 6372 6f70 7065 642e 6e75 6d70 7928 2920  cropped.numpy() 
+0002e0c0: 292c 0a20 2020 2020 2027 4e4d 5f71 3070  ),.      'NM_q0p
+0002e0d0: 7430 3527 203a 206e 702e 7175 616e 7469  t05' : np.quanti
+0002e0e0: 6c65 2820 6e6d 5f61 7667 5f63 726f 7070  le( nm_avg_cropp
+0002e0f0: 6564 2e6e 756d 7079 2829 2c20 302e 3035  ed.numpy(), 0.05
+0002e100: 2029 2c0a 2020 2020 2020 274e 4d5f 7130   ),.      'NM_q0
+0002e110: 7074 3130 2720 3a20 6e70 2e71 7561 6e74  pt10' : np.quant
+0002e120: 696c 6528 206e 6d5f 6176 675f 6372 6f70  ile( nm_avg_crop
+0002e130: 7065 642e 6e75 6d70 7928 292c 2030 2e31  ped.numpy(), 0.1
+0002e140: 3020 292c 0a20 2020 2020 2027 4e4d 5f71  0 ),.      'NM_q
+0002e150: 3070 7439 3027 203a 206e 702e 7175 616e  0pt90' : np.quan
+0002e160: 7469 6c65 2820 6e6d 5f61 7667 5f63 726f  tile( nm_avg_cro
+0002e170: 7070 6564 2e6e 756d 7079 2829 2c20 302e  pped.numpy(), 0.
+0002e180: 3930 2029 2c0a 2020 2020 2020 274e 4d5f  90 ),.      'NM_
+0002e190: 7130 7074 3935 2720 3a20 6e70 2e71 7561  q0pt95' : np.qua
+0002e1a0: 6e74 696c 6528 206e 6d5f 6176 675f 6372  ntile( nm_avg_cr
+0002e1b0: 6f70 7065 642e 6e75 6d70 7928 292c 2030  opped.numpy(), 0
+0002e1c0: 2e39 3520 292c 0a20 2020 2020 2027 4e4d  .95 ),.      'NM
+0002e1d0: 5f73 7562 7374 616e 7469 616e 6967 7261  _substantianigra
+0002e1e0: 5f7a 5f63 6f6f 7264 696e 6174 6527 203a  _z_coordinate' :
+0002e1f0: 2073 6e5f 7a2c 0a20 2020 2020 2027 4e4d   sn_z,.      'NM
+0002e200: 5f65 7672 2720 3a20 6e6d 5f65 7672 2c0a  _evr' : nm_evr,.
+0002e210: 2020 2020 2020 274e 4d5f 636f 756e 7427        'NM_count'
+0002e220: 3a20 6c65 6e28 206c 6973 745f 6e6d 5f69  : len( list_nm_i
+0002e230: 6d61 6765 7320 290a 2020 2020 2020 207d  mages ).       }
+0002e240: 0a0a 0a0a 6465 6620 6573 7469 6d61 7465  ....def estimate
+0002e250: 5f6f 7074 696d 616c 5f70 6361 5f63 6f6d  _optimal_pca_com
+0002e260: 706f 6e65 6e74 7328 6461 7461 2c20 7661  ponents(data, va
+0002e270: 7269 616e 6365 5f74 6872 6573 686f 6c64  riance_threshold
+0002e280: 3d30 2e38 302c 2070 6c6f 743d 4661 6c73  =0.80, plot=Fals
+0002e290: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
+0002e2a0: 4573 7469 6d61 7465 2074 6865 206f 7074  Estimate the opt
+0002e2b0: 696d 616c 206e 756d 6265 7220 6f66 2050  imal number of P
+0002e2c0: 4341 2063 6f6d 706f 6e65 6e74 7320 746f  CA components to
+0002e2d0: 2072 6570 7265 7365 6e74 2074 6865 2067   represent the g
+0002e2e0: 6976 656e 2064 6174 612e 0a0a 2020 2020  iven data...    
+0002e2f0: 3a70 6172 616d 2064 6174 613a 2054 6865  :param data: The
+0002e300: 2064 6174 6120 6d61 7472 6978 2028 7361   data matrix (sa
+0002e310: 6d70 6c65 7320 7820 6665 6174 7572 6573  mples x features
+0002e320: 292e 0a20 2020 203a 7061 7261 6d20 7661  )..    :param va
+0002e330: 7269 616e 6365 5f74 6872 6573 686f 6c64  riance_threshold
+0002e340: 3a20 5468 7265 7368 6f6c 6420 666f 7220  : Threshold for 
+0002e350: 6375 6d75 6c61 7469 7665 2065 7870 6c61  cumulative expla
+0002e360: 696e 6564 2076 6172 6961 6e63 6520 2864  ined variance (d
+0002e370: 6566 6175 6c74 2030 2e39 3529 2e0a 2020  efault 0.95)..  
+0002e380: 2020 3a70 6172 616d 2070 6c6f 743a 2049    :param plot: I
+0002e390: 6620 5472 7565 2c20 706c 6f74 2074 6865  f True, plot the
+0002e3a0: 2063 756d 756c 6174 6976 6520 6578 706c   cumulative expl
+0002e3b0: 6169 6e65 6420 7661 7269 616e 6365 2067  ained variance g
+0002e3c0: 7261 7068 2028 6465 6661 756c 7420 4661  raph (default Fa
+0002e3d0: 6c73 6529 2e0a 2020 2020 3a72 6574 7572  lse)..    :retur
+0002e3e0: 6e3a 2054 6865 206f 7074 696d 616c 206e  n: The optimal n
+0002e3f0: 756d 6265 7220 6f66 2070 7269 6e63 6970  umber of princip
+0002e400: 616c 2063 6f6d 706f 6e65 6e74 732e 0a20  al components.. 
+0002e410: 2020 2022 2222 0a20 2020 2069 6d70 6f72     """.    impor
+0002e420: 7420 6e75 6d70 7920 6173 206e 700a 2020  t numpy as np.  
+0002e430: 2020 6672 6f6d 2073 6b6c 6561 726e 2e64    from sklearn.d
+0002e440: 6563 6f6d 706f 7369 7469 6f6e 2069 6d70  ecomposition imp
+0002e450: 6f72 7420 5043 410a 2020 2020 696d 706f  ort PCA.    impo
+0002e460: 7274 206d 6174 706c 6f74 6c69 622e 7079  rt matplotlib.py
+0002e470: 706c 6f74 2061 7320 706c 740a 0a20 2020  plot as plt..   
+0002e480: 2023 2050 6572 666f 726d 2050 4341 0a20   # Perform PCA. 
+0002e490: 2020 2070 6361 203d 2050 4341 2829 0a20     pca = PCA(). 
+0002e4a0: 2020 2070 6361 2e66 6974 2864 6174 6129     pca.fit(data)
+0002e4b0: 0a0a 2020 2020 2320 4361 6c63 756c 6174  ..    # Calculat
+0002e4c0: 6520 6375 6d75 6c61 7469 7665 2065 7870  e cumulative exp
+0002e4d0: 6c61 696e 6564 2076 6172 6961 6e63 650a  lained variance.
+0002e4e0: 2020 2020 6375 6d75 6c61 7469 7665 5f76      cumulative_v
+0002e4f0: 6172 6961 6e63 6520 3d20 6e70 2e63 756d  ariance = np.cum
+0002e500: 7375 6d28 7063 612e 6578 706c 6169 6e65  sum(pca.explaine
+0002e510: 645f 7661 7269 616e 6365 5f72 6174 696f  d_variance_ratio
+0002e520: 5f29 0a0a 2020 2020 2320 4465 7465 726d  _)..    # Determ
+0002e530: 696e 6520 7468 6520 6e75 6d62 6572 206f  ine the number o
+0002e540: 6620 636f 6d70 6f6e 656e 7473 2066 6f72  f components for
+0002e550: 2064 6573 6972 6564 2065 7870 6c61 696e   desired explain
+0002e560: 6564 2076 6172 6961 6e63 650a 2020 2020  ed variance.    
+0002e570: 6e5f 636f 6d70 6f6e 656e 7473 203d 206e  n_components = n
+0002e580: 702e 7768 6572 6528 6375 6d75 6c61 7469  p.where(cumulati
+0002e590: 7665 5f76 6172 6961 6e63 6520 3e3d 2076  ve_variance >= v
+0002e5a0: 6172 6961 6e63 655f 7468 7265 7368 6f6c  ariance_threshol
+0002e5b0: 6429 5b30 5d5b 305d 202b 2031 0a0a 2020  d)[0][0] + 1..  
+0002e5c0: 2020 2320 4f70 7469 6f6e 616c 6c79 2070    # Optionally p
+0002e5d0: 6c6f 7420 7468 6520 6578 706c 6169 6e65  lot the explaine
+0002e5e0: 6420 7661 7269 616e 6365 0a20 2020 2069  d variance.    i
+0002e5f0: 6620 706c 6f74 3a0a 2020 2020 2020 2020  f plot:.        
+0002e600: 706c 742e 6669 6775 7265 2866 6967 7369  plt.figure(figsi
+0002e610: 7a65 3d28 382c 2034 2929 0a20 2020 2020  ze=(8, 4)).     
+0002e620: 2020 2070 6c74 2e70 6c6f 7428 6375 6d75     plt.plot(cumu
+0002e630: 6c61 7469 7665 5f76 6172 6961 6e63 652c  lative_variance,
+0002e640: 206c 696e 6577 6964 7468 3d32 290a 2020   linewidth=2).  
+0002e650: 2020 2020 2020 706c 742e 6178 686c 696e        plt.axhlin
+0002e660: 6528 793d 7661 7269 616e 6365 5f74 6872  e(y=variance_thr
+0002e670: 6573 686f 6c64 2c20 636f 6c6f 723d 2772  eshold, color='r
+0002e680: 272c 206c 696e 6573 7479 6c65 3d27 2d2d  ', linestyle='--
+0002e690: 2729 0a20 2020 2020 2020 2070 6c74 2e61  ').        plt.a
+0002e6a0: 7876 6c69 6e65 2878 3d6e 5f63 6f6d 706f  xvline(x=n_compo
+0002e6b0: 6e65 6e74 7320 2d20 312c 2063 6f6c 6f72  nents - 1, color
+0002e6c0: 3d27 7227 2c20 6c69 6e65 7374 796c 653d  ='r', linestyle=
+0002e6d0: 272d 2d27 290a 2020 2020 2020 2020 706c  '--').        pl
+0002e6e0: 742e 786c 6162 656c 2827 4e75 6d62 6572  t.xlabel('Number
+0002e6f0: 206f 6620 436f 6d70 6f6e 656e 7473 2729   of Components')
+0002e700: 0a20 2020 2020 2020 2070 6c74 2e79 6c61  .        plt.yla
+0002e710: 6265 6c28 2743 756d 756c 6174 6976 6520  bel('Cumulative 
+0002e720: 4578 706c 6169 6e65 6420 5661 7269 616e  Explained Varian
+0002e730: 6365 2729 0a20 2020 2020 2020 2070 6c74  ce').        plt
+0002e740: 2e74 6974 6c65 2827 4578 706c 6169 6e65  .title('Explaine
+0002e750: 6420 5661 7269 616e 6365 2062 7920 4e75  d Variance by Nu
+0002e760: 6d62 6572 206f 6620 5072 696e 6369 7061  mber of Principa
+0002e770: 6c20 436f 6d70 6f6e 656e 7473 2729 0a20  l Components'). 
+0002e780: 2020 2020 2020 2070 6c74 2e73 686f 7728         plt.show(
+0002e790: 290a 0a20 2020 2072 6574 7572 6e20 6e5f  )..    return n_
+0002e7a0: 636f 6d70 6f6e 656e 7473 0a0a 696d 706f  components..impo
+0002e7b0: 7274 206e 756d 7079 2061 7320 6e70 0a0a  rt numpy as np..
+0002e7c0: 6465 6620 636f 6d70 7574 655f 5065 7241  def compute_PerA
+0002e7d0: 465f 766f 7865 6c28 7469 6d65 5f73 6572  F_voxel(time_ser
+0002e7e0: 6965 7329 3a0a 2020 2020 2222 220a 2020  ies):.    """.  
+0002e7f0: 2020 436f 6d70 7574 6520 7468 6520 5065    Compute the Pe
+0002e800: 7263 656e 7461 6765 2041 6d70 6c69 7475  rcentage Amplitu
+0002e810: 6465 2046 6c75 6374 7561 7469 6f6e 2028  de Fluctuation (
+0002e820: 5065 7241 4629 2066 6f72 2061 2067 6976  PerAF) for a giv
+0002e830: 656e 2074 696d 6520 7365 7269 6573 2e0a  en time series..
+0002e840: 0a20 2020 2031 302e 3133 3731 2f6a 6f75  .    10.1371/jou
+0002e850: 726e 616c 2e70 6f6e 652e 3032 3237 3032  rnal.pone.022702
+0002e860: 310a 0a20 2020 2050 6572 4146 203d 2031  1..    PerAF = 1
+0002e870: 3030 2f6e 202a 2073 756d 287c 2878 5f69  00/n * sum(|(x_i
+0002e880: 202d 206d 292f 6d7c 2920 0a20 2020 2077   - m)/m|) .    w
+0002e890: 6865 7265 206d 203d 2031 2f6e 202a 2073  here m = 1/n * s
+0002e8a0: 756d 2878 5f69 292c 2078 5f69 2069 7320  um(x_i), x_i is 
+0002e8b0: 7468 6520 7369 676e 616c 2069 6e74 656e  the signal inten
+0002e8c0: 7369 7479 2061 7420 6561 6368 2074 696d  sity at each tim
+0002e8d0: 6520 706f 696e 742c 200a 2020 2020 616e  e point, .    an
+0002e8e0: 6420 6e20 6973 2074 6865 2074 6f74 616c  d n is the total
+0002e8f0: 206e 756d 6265 7220 6f66 2074 696d 6520   number of time 
+0002e900: 706f 696e 7473 2e0a 0a20 2020 203a 7061  points...    :pa
+0002e910: 7261 6d20 7469 6d65 5f73 6572 6965 733a  ram time_series:
+0002e920: 204e 756d 7079 2061 7272 6179 206f 6620   Numpy array of 
+0002e930: 7469 6d65 2073 6572 6965 7320 6461 7461  time series data
+0002e940: 0a20 2020 203a 7265 7475 726e 3a20 436f  .    :return: Co
+0002e950: 6d70 7574 6564 2050 6572 4146 2076 616c  mputed PerAF val
+0002e960: 7565 0a20 2020 2022 2222 0a20 2020 206e  ue.    """.    n
+0002e970: 203d 206c 656e 2874 696d 655f 7365 7269   = len(time_seri
+0002e980: 6573 290a 2020 2020 6d20 3d20 6e70 2e6d  es).    m = np.m
+0002e990: 6561 6e28 7469 6d65 5f73 6572 6965 7329  ean(time_series)
+0002e9a0: 0a20 2020 2070 6572 4146 203d 2031 3030  .    perAF = 100
+0002e9b0: 202f 206e 202a 206e 702e 7375 6d28 6e70   / n * np.sum(np
+0002e9c0: 2e61 6273 2828 7469 6d65 5f73 6572 6965  .abs((time_serie
+0002e9d0: 7320 2d20 6d29 202f 206d 2929 0a20 2020  s - m) / m)).   
+0002e9e0: 2072 6574 7572 6e20 7065 7241 460a 0a64   return perAF..d
+0002e9f0: 6566 2063 616c 6375 6c61 7465 5f74 7269  ef calculate_tri
+0002ea00: 6d6d 6564 5f6d 6561 6e28 6461 7461 2c20  mmed_mean(data, 
+0002ea10: 7072 6f70 6f72 7469 6f6e 5f74 6f5f 7472  proportion_to_tr
+0002ea20: 696d 293a 0a20 2020 2022 2222 0a20 2020  im):.    """.   
+0002ea30: 2043 616c 6375 6c61 7465 2074 6865 2074   Calculate the t
+0002ea40: 7269 6d6d 6564 206d 6561 6e20 666f 7220  rimmed mean for 
+0002ea50: 6120 6769 7665 6e20 6461 7461 2061 7272  a given data arr
+0002ea60: 6179 2e0a 0a20 2020 203a 7061 7261 6d20  ay...    :param 
+0002ea70: 6461 7461 3a20 4120 6e75 6d70 7920 6172  data: A numpy ar
+0002ea80: 7261 7920 6f66 2064 6174 612e 0a20 2020  ray of data..   
+0002ea90: 203a 7061 7261 6d20 7072 6f70 6f72 7469   :param proporti
+0002eaa0: 6f6e 5f74 6f5f 7472 696d 3a20 5072 6f70  on_to_trim: Prop
+0002eab0: 6f72 7469 6f6e 2028 3020 746f 2030 2e35  ortion (0 to 0.5
+0002eac0: 2920 6f66 2064 6174 6120 746f 2074 7269  ) of data to tri
+0002ead0: 6d20 6672 6f6d 2065 6163 6820 656e 642e  m from each end.
+0002eae0: 0a20 2020 203a 7265 7475 726e 3a20 5468  .    :return: Th
+0002eaf0: 6520 7472 696d 6d65 6420 6d65 616e 206f  e trimmed mean o
+0002eb00: 6620 7468 6520 6461 7461 2e0a 2020 2020  f the data..    
+0002eb10: 2222 220a 2020 2020 6672 6f6d 2073 6369  """.    from sci
+0002eb20: 7079 2069 6d70 6f72 7420 7374 6174 730a  py import stats.
+0002eb30: 2020 2020 7265 7475 726e 2073 7461 7473      return stats
+0002eb40: 2e74 7269 6d5f 6d65 616e 2864 6174 612c  .trim_mean(data,
+0002eb50: 2070 726f 706f 7274 696f 6e5f 746f 5f74   proportion_to_t
+0002eb60: 7269 6d29 0a0a 6465 6620 5065 7241 4628  rim)..def PerAF(
+0002eb70: 2078 2c20 6d61 736b 2c20 676c 6f62 616c   x, mask, global
+0002eb80: 6d65 616e 3d54 7275 6520 293a 0a20 2020  mean=True ):.   
+0002eb90: 2022 2222 0a20 2020 2043 6f6d 7075 7465   """.    Compute
+0002eba0: 2074 6865 2050 6572 6365 6e74 6167 6520   the Percentage 
+0002ebb0: 416d 706c 6974 7564 6520 466c 7563 7475  Amplitude Fluctu
+0002ebc0: 6174 696f 6e20 2850 6572 4146 2920 666f  ation (PerAF) fo
+0002ebd0: 7220 6120 6769 7665 6e20 7469 6d65 2073  r a given time s
+0002ebe0: 6572 6965 732e 0a0a 2020 2020 3130 2e31  eries...    10.1
+0002ebf0: 3337 312f 6a6f 7572 6e61 6c2e 706f 6e65  371/journal.pone
+0002ec00: 2e30 3232 3730 3231 0a0a 2020 2020 5065  .0227021..    Pe
+0002ec10: 7241 4620 3d20 3130 302f 6e20 2a20 7375  rAF = 100/n * su
+0002ec20: 6d28 7c28 785f 6920 2d20 6d29 2f6d 7c29  m(|(x_i - m)/m|)
+0002ec30: 200a 2020 2020 7768 6572 6520 6d20 3d20   .    where m = 
+0002ec40: 312f 6e20 2a20 7375 6d28 785f 6929 2c20  1/n * sum(x_i), 
+0002ec50: 785f 6920 6973 2074 6865 2073 6967 6e61  x_i is the signa
+0002ec60: 6c20 696e 7465 6e73 6974 7920 6174 2065  l intensity at e
+0002ec70: 6163 6820 7469 6d65 2070 6f69 6e74 2c20  ach time point, 
+0002ec80: 0a20 2020 2061 6e64 206e 2069 7320 7468  .    and n is th
+0002ec90: 6520 746f 7461 6c20 6e75 6d62 6572 206f  e total number o
+0002eca0: 6620 7469 6d65 2070 6f69 6e74 732e 0a0a  f time points...
+0002ecb0: 2020 2020 3a70 6172 616d 2078 3a20 7469      :param x: ti
+0002ecc0: 6d65 2073 6572 6965 7320 616e 7473 496d  me series antsIm
+0002ecd0: 6167 650a 2020 2020 3a70 6172 616d 206d  age.    :param m
+0002ece0: 6173 6b3a 2062 7261 696e 206d 6173 6b0a  ask: brain mask.
+0002ecf0: 2020 2020 3a70 6172 616d 2067 6c6f 6261      :param globa
+0002ed00: 6c6d 6561 6e3a 2062 6f6f 6c65 616e 2069  lmean: boolean i
+0002ed10: 6620 5472 7565 2064 6976 6964 6520 6279  f True divide by
+0002ed20: 2074 6865 2067 6c6f 6261 6c6d 6561 6e20   the globalmean 
+0002ed30: 696e 2074 6865 2062 7261 696e 206d 6173  in the brain mas
+0002ed40: 6b0a 2020 2020 3a72 6574 7572 6e3a 2043  k.    :return: C
+0002ed50: 6f6d 7075 7465 6420 5065 7241 4620 696d  omputed PerAF im
+0002ed60: 6167 650a 2020 2020 2222 220a 2020 2020  age.    """.    
+0002ed70: 7469 6d65 5f73 6572 6965 7320 3d20 616e  time_series = an
+0002ed80: 7473 2e74 696d 6573 6572 6965 735f 746f  ts.timeseries_to
+0002ed90: 5f6d 6174 7269 7828 2078 2c20 6d61 736b  _matrix( x, mask
+0002eda0: 2029 0a20 2020 206e 203d 2074 696d 655f   ).    n = time_
+0002edb0: 7365 7269 6573 2e73 6861 7065 5b31 5d0a  series.shape[1].
+0002edc0: 2020 2020 7665 6320 3d20 6e70 2e7a 6572      vec = np.zer
+0002edd0: 6f73 2820 6e20 290a 2020 2020 666f 7220  os( n ).    for 
+0002ede0: 6920 696e 2072 616e 6765 286e 293a 0a20  i in range(n):. 
+0002edf0: 2020 2020 2020 2076 6563 5b69 5d20 3d20         vec[i] = 
+0002ee00: 636f 6d70 7574 655f 5065 7241 465f 766f  compute_PerAF_vo
+0002ee10: 7865 6c28 2074 696d 655f 7365 7269 6573  xel( time_series
+0002ee20: 5b3a 2c69 5d20 290a 2020 2020 6f75 7469  [:,i] ).    outi
+0002ee30: 6d67 203d 2061 6e74 732e 6d61 6b65 5f69  mg = ants.make_i
+0002ee40: 6d61 6765 2820 6d61 736b 2c20 7665 6320  mage( mask, vec 
+0002ee50: 290a 2020 2020 6966 2067 6c6f 6261 6c6d  ).    if globalm
+0002ee60: 6561 6e3a 0a20 2020 2020 2020 206f 7574  ean:.        out
+0002ee70: 696d 6720 3d20 6f75 7469 6d67 202f 2063  img = outimg / c
+0002ee80: 616c 6375 6c61 7465 5f74 7269 6d6d 6564  alculate_trimmed
+0002ee90: 5f6d 6561 6e28 2076 6563 2c20 302e 3031  _mean( vec, 0.01
+0002eea0: 2029 0a20 2020 2072 6574 7572 6e20 6f75   ).    return ou
+0002eeb0: 7469 6d67 0a0a 0a64 6566 2072 6573 7469  timg...def resti
+0002eec0: 6e67 5f73 7461 7465 5f66 6d72 695f 6e65  ng_state_fmri_ne
+0002eed0: 7477 6f72 6b73 2820 666d 7269 2c20 666d  tworks( fmri, fm
+0002eee0: 7269 5f74 656d 706c 6174 652c 2074 312c  ri_template, t1,
+0002eef0: 2074 3173 6567 6d65 6e74 6174 696f 6e2c   t1segmentation,
+0002ef00: 0a20 2020 2066 3d5b 302e 3033 2c20 302e  .    f=[0.03, 0.
+0002ef10: 3038 5d2c 0a20 2020 2046 445f 7468 7265  08],.    FD_thre
+0002ef20: 7368 6f6c 643d 352e 302c 0a20 2020 2073  shold=5.0,.    s
+0002ef30: 7061 203d 204e 6f6e 652c 0a20 2020 2073  pa = None,.    s
+0002ef40: 7074 203d 204e 6f6e 652c 0a20 2020 206e  pt = None,.    n
+0002ef50: 6320 3d20 352c 0a20 2020 206f 7574 6c69  c = 5,.    outli
+0002ef60: 6572 5f74 6872 6573 686f 6c64 3d30 2e32  er_threshold=0.2
+0002ef70: 3530 2c0a 2020 2020 6963 615f 636f 6d70  50,.    ica_comp
+0002ef80: 6f6e 656e 7473 203d 2030 2c0a 2020 2020  onents = 0,.    
+0002ef90: 696d 7075 7465 203d 2054 7275 652c 0a20  impute = True,. 
+0002efa0: 2020 2063 656e 736f 7220 3d20 5472 7565     censor = True
+0002efb0: 2c0a 2020 2020 6465 7370 696b 6520 3d20  ,.    despike = 
+0002efc0: 322e 352c 0a20 2020 206d 6f74 696f 6e5f  2.5,.    motion_
+0002efd0: 6173 5f6e 7569 7361 6e63 6520 3d20 5472  as_nuisance = Tr
+0002efe0: 7565 2c0a 2020 2020 706f 7765 7273 203d  ue,.    powers =
+0002eff0: 2046 616c 7365 2c0a 2020 2020 7570 7361   False,.    upsa
+0002f000: 6d70 6c65 203d 2033 2e30 2c0a 2020 2020  mple = 3.0,.    
+0002f010: 636c 6561 6e5f 746d 7020 3d20 4e6f 6e65  clean_tmp = None
+0002f020: 2c0a 2020 2020 7061 7261 6d73 6574 3d27  ,.    paramset='
+0002f030: 756e 7365 7427 2c0a 2020 2020 7665 7262  unset',.    verb
+0002f040: 6f73 653d 4661 6c73 6520 293a 0a20 2022  ose=False ):.  "
+0002f050: 2222 0a20 2043 6f6d 7075 7465 2072 6573  "".  Compute res
+0002f060: 7469 6e67 2073 7461 7465 206e 6574 776f  ting state netwo
+0002f070: 726b 2063 6f72 7265 6c61 7469 6f6e 206d  rk correlation m
+0002f080: 6170 7320 6261 7365 6420 6f6e 2074 6865  aps based on the
+0002f090: 204a 2050 6f77 6572 206c 6162 656c 732e   J Power labels.
+0002f0a0: 0a20 2054 6869 7320 7769 6c6c 206f 7574  .  This will out
+0002f0b0: 7075 7420 6120 6d61 7020 666f 7220 6561  put a map for ea
+0002f0c0: 6368 206f 6620 7468 6520 6d61 6a6f 7220  ch of the major 
+0002f0d0: 6e65 7477 6f72 6b20 7379 7374 656d 732e  network systems.
+0002f0e0: 2020 5468 6973 2066 756e 6374 696f 6e20    This function 
+0002f0f0: 0a20 2077 696c 6c20 6279 206f 7074 696f  .  will by optio
+0002f100: 6e61 6c6c 7920 7570 7361 6d70 6c65 2064  nally upsample d
+0002f110: 6174 6120 746f 2032 6d6d 2064 7572 696e  ata to 2mm durin
+0002f120: 6720 7468 6520 7265 6769 7374 7261 7469  g the registrati
+0002f130: 6f6e 2070 726f 6365 7373 2069 6620 6461  on process if da
+0002f140: 7461 200a 2020 6973 2062 656c 6f77 2074  ta .  is below t
+0002f150: 6861 7420 7265 736f 6c75 7469 6f6e 2e0a  hat resolution..
+0002f160: 0a20 2072 6567 6973 7472 6174 696f 6e20  .  registration 
+0002f170: 2d20 6465 7370 696b 6520 2d20 616e 6174  - despike - anat
+0002f180: 6f6d 7920 2d20 736d 6f6f 7468 202d 206e  omy - smooth - n
+0002f190: 7569 7361 6e63 6520 2d20 6261 6e64 7061  uisance - bandpa
+0002f1a0: 7373 202d 2072 6567 7265 7373 2e6e 7569  ss - regress.nui
+0002f1b0: 7361 6e63 6520 2d20 6365 6e73 6f72 202d  sance - censor -
+0002f1c0: 2066 616c 6666 202d 2063 6f72 7265 6c61   falff - correla
+0002f1d0: 7469 6f6e 730a 0a20 2041 7267 756d 656e  tions..  Argumen
+0002f1e0: 7473 0a20 202d 2d2d 2d2d 2d2d 2d2d 0a20  ts.  ---------. 
+0002f1f0: 2066 6d72 6920 3a20 424f 4c44 2066 6d72   fmri : BOLD fmr
+0002f200: 6920 616e 7473 496d 6167 650a 0a20 2066  i antsImage..  f
+0002f210: 6d72 695f 7465 6d70 6c61 7465 203a 2072  mri_template : r
+0002f220: 6566 6572 656e 6365 2073 7061 6365 2066  eference space f
+0002f230: 6f72 2042 4f4c 440a 0a20 2074 3120 3a20  or BOLD..  t1 : 
+0002f240: 414e 5473 496d 6167 650a 2020 2020 696e  ANTsImage.    in
+0002f250: 7075 7420 332d 4420 5431 2062 7261 696e  put 3-D T1 brain
+0002f260: 2069 6d61 6765 2028 6272 6169 6e20 6578   image (brain ex
+0002f270: 7472 6163 7465 6429 0a0a 2020 7431 7365  tracted)..  t1se
+0002f280: 676d 656e 7461 7469 6f6e 203a 2041 4e54  gmentation : ANT
+0002f290: 7349 6d61 6765 0a20 2020 2074 3120 7365  sImage.    t1 se
+0002f2a0: 676d 656e 7461 7469 6f6e 202d 2061 2073  gmentation - a s
+0002f2b0: 6978 2074 6973 7375 6520 7365 676d 656e  ix tissue segmen
+0002f2c0: 7461 7469 6f6e 2069 6d61 6765 2069 6e20  tation image in 
+0002f2d0: 5431 2073 7061 6365 0a0a 2020 6620 3a20  T1 space..  f : 
+0002f2e0: 6261 6e64 2070 6173 7320 6c69 6d69 7473  band pass limits
+0002f2f0: 2066 6f72 2066 7265 7175 656e 6379 2066   for frequency f
+0002f300: 696c 7465 7269 6e67 3b20 7765 2075 7365  iltering; we use
+0002f310: 2068 6967 682d 7061 7373 2068 6572 6520   high-pass here 
+0002f320: 6173 2070 6572 2053 6869 7265 7220 3230  as per Shirer 20
+0002f330: 3135 0a0a 2020 7370 6120 3a20 6761 7573  15..  spa : gaus
+0002f340: 7369 616e 2073 6d6f 6f74 6869 6e67 2066  sian smoothing f
+0002f350: 6f72 2073 7061 7469 616c 2063 6f6d 706f  or spatial compo
+0002f360: 6e65 6e74 2028 7068 7973 6963 616c 2063  nent (physical c
+0002f370: 6f6f 7264 696e 6174 6573 290a 0a20 2073  oordinates)..  s
+0002f380: 7074 203a 2067 6175 7373 6961 6e20 736d  pt : gaussian sm
+0002f390: 6f6f 7468 696e 6720 666f 7220 7465 6d70  oothing for temp
+0002f3a0: 6f72 616c 2063 6f6d 706f 6e65 6e74 0a0a  oral component..
+0002f3b0: 2020 6e63 2020 3a20 6e75 6d62 6572 206f    nc  : number o
+0002f3c0: 6620 636f 6d70 6f6e 656e 7473 2066 6f72  f components for
+0002f3d0: 2063 6f6d 7063 6f72 2066 696c 7465 7269   compcor filteri
+0002f3e0: 6e67 3b20 6966 206c 6573 7320 7468 616e  ng; if less than
+0002f3f0: 2031 2077 6520 6573 7469 6d61 7465 206f   1 we estimate o
+0002f400: 6e20 7468 6520 666c 7920 6261 7365 6420  n the fly based 
+0002f410: 6f6e 2065 7870 6c61 696e 6564 2076 6172  on explained var
+0002f420: 6961 6e63 653b 2031 3020 7772 7420 5368  iance; 10 wrt Sh
+0002f430: 6972 6572 2032 3031 3520 3520 6672 6f6d  irer 2015 5 from
+0002f440: 2063 7366 2061 6e64 2035 2066 726f 6d20   csf and 5 from 
+0002f450: 776d 0a0a 2020 6963 615f 636f 6d70 6f6e  wm..  ica_compon
+0002f460: 656e 7473 203a 2069 6e74 6567 6572 2069  ents : integer i
+0002f470: 6620 6772 6561 7465 7220 7468 616e 2030  f greater than 0
+0002f480: 2074 6865 6e20 696e 636c 7564 6520 6963   then include ic
+0002f490: 6120 636f 6d70 6f6e 656e 7473 0a0a 2020  a components..  
+0002f4a0: 696d 7075 7465 203a 2062 6f6f 6c65 616e  impute : boolean
+0002f4b0: 2069 6620 5472 7565 2c20 7468 656e 2075   if True, then u
+0002f4c0: 7365 2069 6d70 7574 6174 696f 6e20 696e  se imputation in
+0002f4d0: 2066 2f41 4c46 462c 2050 6572 4146 2063   f/ALFF, PerAF c
+0002f4e0: 616c 6375 6c61 7469 6f6e 0a0a 2020 6365  alculation..  ce
+0002f4f0: 6e73 6f72 203a 2062 6f6f 6c65 616e 2069  nsor : boolean i
+0002f500: 6620 5472 7565 2c20 7468 656e 2075 7365  f True, then use
+0002f510: 2063 656e 736f 7269 6e67 2028 6365 6e73   censoring (cens
+0002f520: 6f72 696e 6729 0a0a 2020 6465 7370 696b  oring)..  despik
+0002f530: 6520 3a20 6966 2074 6869 7320 6973 2067  e : if this is g
+0002f540: 7265 6174 6572 2074 6861 6e20 7a65 726f  reater than zero
+0002f550: 2077 696c 6c20 7275 6e20 766f 7865 6c2d   will run voxel-
+0002f560: 7769 7365 2064 6573 7069 6b69 6e67 2069  wise despiking i
+0002f570: 6e20 7468 6520 3364 4465 7370 696b 6520  n the 3dDespike 
+0002f580: 2861 666e 6929 2073 656e 7365 3b20 6166  (afni) sense; af
+0002f590: 7465 7220 6d6f 7469 6f6e 2d63 6f72 7265  ter motion-corre
+0002f5a0: 6374 696f 6e0a 0a20 206d 6f74 696f 6e5f  ction..  motion_
+0002f5b0: 6173 5f6e 7569 7361 6e63 653a 2062 6f6f  as_nuisance: boo
+0002f5c0: 6c65 616e 2077 696c 6c20 6164 6420 6d6f  lean will add mo
+0002f5d0: 7469 6f6e 2061 6e64 2066 6972 7374 2064  tion and first d
+0002f5e0: 6572 6976 6174 6976 6520 6f66 206d 6f74  erivative of mot
+0002f5f0: 696f 6e20 6173 206e 7569 7361 6e63 650a  ion as nuisance.
+0002f600: 0a20 2070 6f77 6572 7320 3a20 626f 6f6c  .  powers : bool
+0002f610: 6561 6e20 6966 2054 7275 6520 7573 6520  ean if True use 
+0002f620: 506f 7765 7273 206e 6f64 6573 206f 7468  Powers nodes oth
+0002f630: 6572 7769 7365 2032 3032 3320 5965 6f20  erwise 2023 Yeo 
+0002f640: 3530 3020 686f 6d6f 746f 7069 6320 6e6f  500 homotopic no
+0002f650: 6465 7320 2831 302e 3130 3136 2f6a 2e6e  des (10.1016/j.n
+0002f660: 6575 726f 696d 6167 652e 3230 3233 2e31  euroimage.2023.1
+0002f670: 3230 3031 3029 0a0a 2020 7570 7361 6d70  20010)..  upsamp
+0002f680: 6c65 203a 2066 6c6f 6174 206f 7074 696f  le : float optio
+0002f690: 6e61 6c6c 7920 6973 6f74 726f 7069 6361  nally isotropica
+0002f6a0: 6c6c 7920 7570 7361 6d70 6c65 2064 6174  lly upsample dat
+0002f6b0: 6120 746f 2075 7073 616d 706c 6520 2874  a to upsample (t
+0002f6c0: 6865 2070 6172 616d 6574 6572 2076 616c  he parameter val
+0002f6d0: 7565 2920 696e 206d 6d20 6475 7269 6e67  ue) in mm during
+0002f6e0: 2074 6865 2072 6567 6973 7472 6174 696f   the registratio
+0002f6f0: 6e20 7072 6f63 6573 7320 6966 2064 6174  n process if dat
+0002f700: 6120 6973 2062 656c 6f77 2074 6861 7420  a is below that 
+0002f710: 7265 736f 6c75 7469 6f6e 3b20 6966 2074  resolution; if t
+0002f720: 6865 2069 6e70 7574 2073 7061 6369 6e67  he input spacing
+0002f730: 2069 7320 6c65 7373 2074 6861 6e20 7468   is less than th
+0002f740: 6174 2070 726f 7669 6465 6420 6279 2074  at provided by t
+0002f750: 6865 2075 7365 722c 2074 6865 2064 6174  he user, the dat
+0002f760: 6120 7769 6c6c 2073 696d 706c 7920 6265  a will simply be
+0002f770: 2072 6573 616d 706c 6564 2074 6f20 6973   resampled to is
+0002f780: 6f74 726f 7069 6320 7265 736f 6c75 7469  otropic resoluti
+0002f790: 6f6e 0a0a 2020 636c 6561 6e5f 746d 7020  on..  clean_tmp 
+0002f7a0: 3a20 7769 6c6c 2061 7574 6f6d 6174 6963  : will automatic
+0002f7b0: 616c 6c79 2074 7279 2074 6f20 636c 6561  ally try to clea
+0002f7c0: 6e20 7468 6520 746d 7020 6469 7265 6374  n the tmp direct
+0002f7d0: 6f72 7920 2d20 6e6f 7420 7265 636f 6d6d  ory - not recomm
+0002f7e0: 656e 6465 6420 6275 7420 6361 6e20 6265  ended but can be
+0002f7f0: 2075 7365 6420 696e 2064 6973 7472 6962   used in distrib
+0002f800: 7574 6564 2063 6f6d 7075 7469 6e67 2073  uted computing s
+0002f810: 7973 7465 6d73 2074 6f20 6865 6c70 2070  ystems to help p
+0002f820: 7265 7665 6e74 2066 6169 6c75 7265 7320  revent failures 
+0002f830: 6475 6520 746f 2061 6363 756d 756c 6174  due to accumulat
+0002f840: 696f 6e20 6f66 2074 6d70 2066 696c 6573  ion of tmp files
+0002f850: 2077 6865 6e20 646f 696e 6720 6c61 7267   when doing larg
+0002f860: 652d 7363 616c 6520 7072 6f63 6573 7369  e-scale processi
+0002f870: 6e67 2e20 2069 6620 7468 6973 2069 7320  ng.  if this is 
+0002f880: 7365 742c 2074 6865 2066 6c6f 6174 2076  set, the float v
+0002f890: 616c 7565 2063 6c65 616e 5f74 6d70 2077  alue clean_tmp w
+0002f8a0: 696c 6c20 6265 2069 6e74 6572 7072 6574  ill be interpret
+0002f8b0: 6564 2061 7320 7468 6520 6167 6520 696e  ed as the age in
+0002f8c0: 2068 6f75 7273 206f 6620 6669 6c65 7320   hours of files 
+0002f8d0: 746f 2062 6520 636c 6561 6e65 642e 0a0a  to be cleaned...
+0002f8e0: 2020 7665 7262 6f73 6520 3a20 626f 6f6c    verbose : bool
+0002f8f0: 6561 6e0a 0a20 2052 6574 7572 6e73 0a20  ean..  Returns. 
+0002f900: 202d 2d2d 2d2d 2d2d 2d2d 0a20 2061 2064   ---------.  a d
+0002f910: 6963 7469 6f6e 6172 7920 636f 6e74 6169  ictionary contai
+0002f920: 6e69 6e67 2074 6865 2064 6572 6976 6564  ning the derived
+0002f930: 206e 6574 776f 726b 206d 6170 730a 0a20   network maps.. 
+0002f940: 2052 6566 6572 656e 6365 730a 2020 2d2d   References.  --
+0002f950: 2d2d 2d2d 2d2d 2d0a 0a20 2031 302e 3131  -------..  10.11
+0002f960: 3632 2f6e 6574 6e5f 615f 3030 3037 3120  62/netn_a_00071 
+0002f970: 224d 6574 686f 6473 2074 6861 7420 696e  "Methods that in
+0002f980: 636c 7564 6564 2067 6c6f 6261 6c20 7369  cluded global si
+0002f990: 676e 616c 2072 6567 7265 7373 696f 6e20  gnal regression 
+0002f9a0: 7765 7265 2074 6865 206d 6f73 7420 636f  were the most co
+0002f9b0: 6e73 6973 7465 6e74 6c79 2065 6666 6563  nsistently effec
+0002f9c0: 7469 7665 2064 652d 6e6f 6973 696e 6720  tive de-noising 
+0002f9d0: 7374 7261 7465 6769 6573 2e22 0a0a 2020  strategies."..  
+0002f9e0: 3130 2e31 3031 362f 6a2e 6e65 7572 6f69  10.1016/j.neuroi
+0002f9f0: 6d61 6765 2e32 3031 392e 3131 3631 3537  mage.2019.116157
+0002fa00: 2022 6672 6f6e 7461 6c20 616e 6420 6465   "frontal and de
+0002fa10: 6661 756c 7420 6d6f 6465 6c20 6e65 7477  fault model netw
+0002fa20: 6f72 6b73 2061 7265 206d 6f73 7420 7265  orks are most re
+0002fa30: 6c69 6162 6c65 2077 6865 7265 6173 2073  liable whereas s
+0002fa40: 7562 636f 7274 6963 616c 206e 6574 6577  ubcortical netew
+0002fa50: 6f72 6b73 2061 7265 206c 6561 7374 2072  orks are least r
+0002fa60: 656c 6961 626c 6522 2020 2274 6865 206d  eliable"  "the m
+0002fa70: 6f73 7420 636f 6d70 7265 6865 6e73 6976  ost comprehensiv
+0002fa80: 6520 7374 7564 6965 7320 6f66 2070 6970  e studies of pip
+0002fa90: 656c 696e 6520 6566 6665 6374 7320 6f6e  eline effects on
+0002faa0: 2065 6467 652d 6c65 7665 6c20 7265 6c69   edge-level reli
+0002fab0: 6162 696c 6974 7920 6861 7665 2062 6565  ability have bee
+0002fac0: 6e20 646f 6e65 2062 7920 7368 6972 6572  n done by shirer
+0002fad0: 2028 3230 3135 2920 616e 6420 5061 726b   (2015) and Park
+0002fae0: 6573 2028 3230 3138 2922 2022 736c 6963  es (2018)" "slic
+0002faf0: 6520 7469 6d69 6e67 2063 6f72 7265 6374  e timing correct
+0002fb00: 696f 6e20 6861 7320 6d69 6e69 6d61 6c20  ion has minimal 
+0002fb10: 696d 7061 6374 2220 2275 7365 206f 6620  impact" "use of 
+0002fb20: 6c6f 772d 7061 7373 206f 7220 6e61 7272  low-pass or narr
+0002fb30: 6f77 2066 696c 7465 7220 2864 6973 6361  ow filter (disca
+0002fb40: 7264 696e 6720 2068 6967 6820 6672 6571  rding  high freq
+0002fb50: 7565 6e63 7920 696e 666f 726d 6174 696f  uency informatio
+0002fb60: 6e29 2072 6564 7563 6564 2062 6f74 6820  n) reduced both 
+0002fb70: 7265 6c69 6162 696c 6974 7920 616e 6420  reliability and 
+0002fb80: 7369 676e 616c 2d6e 6f69 7365 2073 6570  signal-noise sep
+0002fb90: 6172 6174 696f 6e22 0a0a 2020 3130 2e31  aration"..  10.1
+0002fba0: 3031 362f 6a2e 6e65 7572 6f69 6d61 6765  016/j.neuroimage
+0002fbb0: 2e32 3031 372e 3132 2e30 3733 3a20 4f75  .2017.12.073: Ou
+0002fbc0: 7220 7265 7375 6c74 7320 696e 6469 6361  r results indica
+0002fbd0: 7465 2074 6861 7420 2831 2920 7369 6d70  te that (1) simp
+0002fbe0: 6c65 206c 696e 6561 7220 7265 6772 6573  le linear regres
+0002fbf0: 7369 6f6e 206f 6620 7265 6769 6f6e 616c  sion of regional
+0002fc00: 2066 4d52 4920 7469 6d65 2073 6572 6965   fMRI time serie
+0002fc10: 7320 6167 6169 6e73 7420 6865 6164 206d  s against head m
+0002fc20: 6f74 696f 6e20 7061 7261 6d65 7465 7273  otion parameters
+0002fc30: 2061 6e64 2057 4d2f 4353 4620 7369 676e   and WM/CSF sign
+0002fc40: 616c 7320 2877 6974 6820 6f72 2077 6974  als (with or wit
+0002fc50: 686f 7574 2065 7870 616e 7369 6f6e 2074  hout expansion t
+0002fc60: 6572 6d73 2920 6973 206e 6f74 2073 7566  erms) is not suf
+0002fc70: 6669 6369 656e 7420 746f 2072 656d 6f76  ficient to remov
+0002fc80: 6520 6865 6164 206d 6f74 696f 6e20 6172  e head motion ar
+0002fc90: 7465 6661 6374 733b 2028 3229 2061 436f  tefacts; (2) aCo
+0002fca0: 6d70 436f 7220 7069 7065 6c69 6e65 7320  mpCor pipelines 
+0002fcb0: 6d61 7920 6f6e 6c79 2062 6520 7669 6162  may only be viab
+0002fcc0: 6c65 2069 6e20 6c6f 772d 6d6f 7469 6f6e  le in low-motion
+0002fcd0: 2064 6174 613b 2028 3329 2076 6f6c 756d   data; (3) volum
+0002fce0: 6520 6365 6e73 6f72 696e 6720 7065 7266  e censoring perf
+0002fcf0: 6f72 6d73 2077 656c 6c20 6174 206d 696e  orms well at min
+0002fd00: 696d 6973 696e 6720 6d6f 7469 6f6e 2d72  imising motion-r
+0002fd10: 656c 6174 6564 2061 7274 6566 6163 7420  elated artefact 
+0002fd20: 6275 7420 6120 6d61 6a6f 7220 6265 6e65  but a major bene
+0002fd30: 6669 7420 6f66 2074 6869 7320 6170 7072  fit of this appr
+0002fd40: 6f61 6368 2064 6572 6976 6573 2066 726f  oach derives fro
+0002fd50: 6d20 7468 6520 6578 636c 7573 696f 6e20  m the exclusion 
+0002fd60: 6f66 2068 6967 682d 6d6f 7469 6f6e 2069  of high-motion i
+0002fd70: 6e64 6976 6964 7561 6c73 3b20 2834 2920  ndividuals; (4) 
+0002fd80: 7768 696c 6520 6e6f 7420 6173 2065 6666  while not as eff
+0002fd90: 6563 7469 7665 2061 7320 766f 6c75 6d65  ective as volume
+0002fda0: 2063 656e 736f 7269 6e67 2c20 4943 412d   censoring, ICA-
+0002fdb0: 4152 4f4d 4120 7065 7266 6f72 6d65 6420  AROMA performed 
+0002fdc0: 7765 6c6c 2061 6372 6f73 7320 6f75 7220  well across our 
+0002fdd0: 6265 6e63 686d 6172 6b73 2066 6f72 2072  benchmarks for r
+0002fde0: 656c 6174 6976 656c 7920 6c6f 7720 636f  elatively low co
+0002fdf0: 7374 2069 6e20 7465 726d 7320 6f66 2064  st in terms of d
+0002fe00: 6174 6120 6c6f 7373 3b20 2835 2920 7468  ata loss; (5) th
+0002fe10: 6520 6164 6469 7469 6f6e 206f 6620 676c  e addition of gl
+0002fe20: 6f62 616c 2073 6967 6e61 6c20 7265 6772  obal signal regr
+0002fe30: 6573 7369 6f6e 2069 6d70 726f 7665 6420  ession improved 
+0002fe40: 7468 6520 7065 7266 6f72 6d61 6e63 6520  the performance 
+0002fe50: 6f66 206e 6561 726c 7920 616c 6c20 7069  of nearly all pi
+0002fe60: 7065 6c69 6e65 7320 6f6e 206d 6f73 7420  pelines on most 
+0002fe70: 6265 6e63 686d 6172 6b73 2c20 6275 7420  benchmarks, but 
+0002fe80: 6578 6163 6572 6261 7465 6420 7468 6520  exacerbated the 
+0002fe90: 6469 7374 616e 6365 2d64 6570 656e 6465  distance-depende
+0002fea0: 6e63 6520 6f66 2063 6f72 7265 6c61 7469  nce of correlati
+0002feb0: 6f6e 7320 6265 7477 6565 6e20 6d6f 7469  ons between moti
+0002fec0: 6f6e 2061 6e64 2066 756e 6374 696f 6e61  on and functiona
+0002fed0: 6c20 636f 6e6e 6563 2d20 7469 7669 7479  l connec- tivity
+0002fee0: 3b20 616e 6420 2836 2920 6772 6f75 7020  ; and (6) group 
+0002fef0: 636f 6d70 6172 6973 6f6e 7320 696e 2066  comparisons in f
+0002ff00: 756e 6374 696f 6e61 6c20 636f 6e6e 6563  unctional connec
+0002ff10: 7469 7669 7479 2062 6574 7765 656e 2068  tivity between h
+0002ff20: 6561 6c74 6879 2063 6f6e 7472 6f6c 7320  ealthy controls 
+0002ff30: 616e 6420 7363 6869 7a6f 7068 7265 6e69  and schizophreni
+0002ff40: 6120 7061 7469 656e 7473 2061 7265 2068  a patients are h
+0002ff50: 6967 686c 7920 6465 7065 6e64 656e 7420  ighly dependent 
+0002ff60: 6f6e 2070 7265 7072 6f63 6573 7369 6e67  on preprocessing
+0002ff70: 2073 7472 6174 6567 792e 2057 6520 6f66   strategy. We of
+0002ff80: 6665 7220 736f 6d65 2072 6563 6f6d 6d65  fer some recomme
+0002ff90: 6e64 6174 696f 6e73 2066 6f72 2062 6573  ndations for bes
+0002ffa0: 7420 7072 6163 7469 6365 2061 6e64 206f  t practice and o
+0002ffb0: 7574 6c69 6e65 2073 696d 706c 6520 616e  utline simple an
+0002ffc0: 616c 7973 6573 2074 6f20 6661 6369 6c69  alyses to facili
+0002ffd0: 7461 7465 2074 7261 6e73 7061 7265 6e74  tate transparent
+0002ffe0: 2072 6570 6f72 7469 6e67 206f 6620 7468   reporting of th
+0002fff0: 6520 6465 6772 6565 2074 6f20 7768 6963  e degree to whic
+00030000: 6820 6120 6769 7665 6e20 7365 7420 6f66  h a given set of
+00030010: 2066 696e 6469 6e67 7320 6d61 7920 6265   findings may be
+00030020: 2061 6666 6563 7465 6420 6279 206d 6f74   affected by mot
+00030030: 696f 6e2d 7265 6c61 7465 6420 6172 7465  ion-related arte
+00030040: 6661 6374 2e0a 0a20 2031 302e 3130 3136  fact...  10.1016
+00030050: 2f6a 2e64 636e 2e32 3032 322e 3130 3130  /j.dcn.2022.1010
+00030060: 3837 203a 2057 6520 666f 756e 6420 7468  87 : We found th
+00030070: 6174 3a20 3129 2074 6865 206d 6f73 7420  at: 1) the most 
+00030080: 6566 6669 6361 6369 6f75 7320 7069 7065  efficacious pipe
+00030090: 6c69 6e65 2066 6f72 2062 6f74 6820 6e6f  line for both no
+000300a0: 6973 6520 7265 6d6f 7661 6c20 616e 6420  ise removal and 
+000300b0: 696e 666f 726d 6174 696f 6e20 7265 636f  information reco
+000300c0: 7665 7279 2069 6e63 6c75 6465 6420 6365  very included ce
+000300d0: 6e73 6f72 696e 672c 2047 5352 2c20 6261  nsoring, GSR, ba
+000300e0: 6e64 7061 7373 2066 696c 7465 7269 6e67  ndpass filtering
+000300f0: 2c20 616e 6420 6865 6164 206d 6f74 696f  , and head motio
+00030100: 6e20 7061 7261 6d65 7465 7220 2848 4d50  n parameter (HMP
+00030110: 2920 7265 6772 6573 7369 6f6e 2c20 3229  ) regression, 2)
+00030120: 2049 4341 2d41 524f 4d41 2070 6572 666f   ICA-AROMA perfo
+00030130: 726d 6564 2073 696d 696c 6172 6c79 2074  rmed similarly t
+00030140: 6f20 484d 5020 7265 6772 6573 7369 6f6e  o HMP regression
+00030150: 2061 6e64 2064 6964 206e 6f74 206f 6276   and did not obv
+00030160: 6961 7465 2074 6865 206e 6565 6420 666f  iate the need fo
+00030170: 7220 6365 6e73 6f72 696e 672c 2033 2920  r censoring, 3) 
+00030180: 4753 5220 6861 6420 6120 6d69 6e69 6d61  GSR had a minima
+00030190: 6c20 696d 7061 6374 206f 6e20 636f 6e6e  l impact on conn
+000301a0: 6563 746f 6d65 2066 696e 6765 7270 7269  ectome fingerpri
+000301b0: 6e74 696e 6720 6275 7420 696d 7072 6f76  nting but improv
+000301c0: 6564 2049 5343 2c20 616e 6420 3429 2074  ed ISC, and 4) t
+000301d0: 6865 2073 7472 6963 7465 7374 2063 656e  he strictest cen
+000301e0: 736f 7269 6e67 2061 7070 726f 6163 6865  soring approache
+000301f0: 7320 7265 6475 6365 6420 6d6f 7469 6f6e  s reduced motion
+00030200: 2063 6f72 7265 6c61 7465 6420 6564 6765   correlated edge
+00030210: 7320 6275 7420 6e65 6761 7469 7665 6c79  s but negatively
+00030220: 2069 6d70 6163 7465 6420 6964 656e 7469   impacted identi
+00030230: 6669 6162 696c 6974 792e 0a0a 2020 2222  fiability...  ""
+00030240: 220a 0a20 2069 6d70 6f72 7420 7761 726e  "..  import warn
+00030250: 696e 6773 0a0a 2020 6966 2063 6c65 616e  ings..  if clean
+00030260: 5f74 6d70 2069 7320 6e6f 7420 4e6f 6e65  _tmp is not None
+00030270: 3a0a 2020 2020 636c 6561 6e5f 746d 705f  :.    clean_tmp_
+00030280: 6469 7265 6374 6f72 7928 2061 6765 5f68  directory( age_h
+00030290: 6f75 7273 203d 2063 6c65 616e 5f74 6d70  ours = clean_tmp
+000302a0: 2029 0a0a 2020 6966 206e 6320 3e20 313a   )..  if nc > 1:
+000302b0: 0a20 2020 206e 6320 3d20 696e 7428 6e63  .    nc = int(nc
+000302c0: 290a 2020 656c 7365 3a0a 2020 2020 6e63  ).  else:.    nc
+000302d0: 3d66 6c6f 6174 286e 6329 0a0a 2020 7479  =float(nc)..  ty
+000302e0: 7065 5f6f 665f 7472 616e 7366 6f72 6d3d  pe_of_transform=
+000302f0: 2752 6967 6964 2720 2320 2c20 2320 7368  'Rigid' # , # sh
+00030300: 6f75 6c64 2070 726f 6261 626c 7920 6e6f  ould probably no
+00030310: 7420 6368 616e 6765 2074 6869 730a 2020  t change this.  
+00030320: 7265 6d6f 7665 5f69 743d 5472 7565 0a20  remove_it=True. 
+00030330: 206f 7574 7075 745f 6469 7265 6374 6f72   output_director
+00030340: 7920 3d20 7465 6d70 6669 6c65 2e6d 6b64  y = tempfile.mkd
+00030350: 7465 6d70 2829 0a20 206f 7574 7075 745f  temp().  output_
+00030360: 6469 7265 6374 6f72 795f 7720 3d20 6f75  directory_w = ou
+00030370: 7470 7574 5f64 6972 6563 746f 7279 202b  tput_directory +
+00030380: 2022 2f74 735f 7431 5f72 6567 2f22 0a20   "/ts_t1_reg/". 
+00030390: 206f 732e 6d61 6b65 6469 7273 286f 7574   os.makedirs(out
+000303a0: 7075 745f 6469 7265 6374 6f72 795f 772c  put_directory_w,
+000303b0: 6578 6973 745f 6f6b 3d54 7275 6529 0a20  exist_ok=True). 
+000303c0: 206f 666e 7431 7478 203d 2074 656d 7066   ofnt1tx = tempf
+000303d0: 696c 652e 4e61 6d65 6454 656d 706f 7261  ile.NamedTempora
+000303e0: 7279 4669 6c65 2864 656c 6574 653d 4661  ryFile(delete=Fa
+000303f0: 6c73 652c 7375 6666 6978 3d27 7431 5f64  lse,suffix='t1_d
+00030400: 6566 6f72 6d61 7469 6f6e 272c 6469 723d  eformation',dir=
+00030410: 6f75 7470 7574 5f64 6972 6563 746f 7279  output_directory
+00030420: 5f77 292e 6e61 6d65 0a0a 2020 696d 706f  _w).name..  impo
+00030430: 7274 206e 756d 7079 2061 7320 6e70 0a23  rt numpy as np.#
+00030440: 2041 7373 756d 696e 6720 636f 7265 2061   Assuming core a
+00030450: 6e64 2075 7469 6c73 2061 7265 206d 6f64  nd utils are mod
+00030460: 756c 6573 206f 7220 7061 636b 6167 6573  ules or packages
+00030470: 2077 6974 6820 6e65 6365 7373 6172 7920   with necessary 
+00030480: 6675 6e63 7469 6f6e 730a 0a20 2069 6620  functions..  if 
+00030490: 7570 7361 6d70 6c65 203e 2030 2e30 3a0a  upsample > 0.0:.
+000304a0: 2020 2020 2020 7370 6320 3d20 616e 7473        spc = ants
+000304b0: 2e67 6574 5f73 7061 6369 6e67 2820 666d  .get_spacing( fm
+000304c0: 7269 2029 0a20 2020 2020 206d 696e 7370  ri ).      minsp
+000304d0: 6320 3d20 7570 7361 6d70 6c65 0a20 2020  c = upsample.   
+000304e0: 2020 2069 6620 6d69 6e28 7370 635b 303a     if min(spc[0:
+000304f0: 335d 2920 3c20 6d69 6e73 7063 3a0a 2020  3]) < minspc:.  
+00030500: 2020 2020 2020 2020 6d69 6e73 7063 203d          minspc =
+00030510: 206d 696e 2873 7063 5b30 3a33 5d29 0a20   min(spc[0:3]). 
+00030520: 2020 2020 206e 6577 7370 6320 3d20 5b6d       newspc = [m
+00030530: 696e 7370 632c 6d69 6e73 7063 2c6d 696e  inspc,minspc,min
+00030540: 7370 635d 0a20 2020 2020 2066 6d72 695f  spc].      fmri_
+00030550: 7465 6d70 6c61 7465 203d 2061 6e74 732e  template = ants.
+00030560: 7265 7361 6d70 6c65 5f69 6d61 6765 2820  resample_image( 
+00030570: 666d 7269 5f74 656d 706c 6174 652c 206e  fmri_template, n
+00030580: 6577 7370 632c 2069 6e74 6572 705f 7479  ewspc, interp_ty
+00030590: 7065 3d30 2029 0a0a 2020 6465 6620 7465  pe=0 )..  def te
+000305a0: 6d70 6f72 616c 5f64 6572 6976 6174 6976  mporal_derivativ
+000305b0: 655f 7361 6d65 5f73 6861 7065 2861 7272  e_same_shape(arr
+000305c0: 6179 293a 0a20 2020 2022 2222 0a20 2020  ay):.    """.   
+000305d0: 2043 6f6d 7075 7465 2074 6865 2074 656d   Compute the tem
+000305e0: 706f 7261 6c20 6465 7269 7661 7469 7665  poral derivative
+000305f0: 206f 6620 6120 3244 206e 756d 7079 2061   of a 2D numpy a
+00030600: 7272 6179 2061 6c6f 6e67 2074 6865 2030  rray along the 0
+00030610: 7468 2061 7869 7320 2874 696d 6529 0a20  th axis (time). 
+00030620: 2020 2061 6e64 2065 6e73 7572 6520 7468     and ensure th
+00030630: 6520 6f75 7470 7574 2068 6173 2074 6865  e output has the
+00030640: 2073 616d 6520 7368 6170 6520 6173 2074   same shape as t
+00030650: 6865 2069 6e70 7574 2e0a 0a20 2020 203a  he input...    :
+00030660: 7061 7261 6d20 6172 7261 793a 2032 4420  param array: 2D 
+00030670: 6e75 6d70 7920 6172 7261 7920 7769 7468  numpy array with
+00030680: 2074 696d 6520 6173 2074 6865 2030 7468   time as the 0th
+00030690: 2061 7869 732e 0a20 2020 203a 7265 7475   axis..    :retu
+000306a0: 726e 3a20 3244 206e 756d 7079 2061 7272  rn: 2D numpy arr
+000306b0: 6179 206f 6620 7468 6520 7465 6d70 6f72  ay of the tempor
+000306c0: 616c 2064 6572 6976 6174 6976 6520 7769  al derivative wi
+000306d0: 7468 2074 6865 2073 616d 6520 7368 6170  th the same shap
+000306e0: 6520 6173 2069 6e70 7574 2e0a 2020 2020  e as input..    
+000306f0: 2222 220a 2020 2020 6465 7269 7661 7469  """.    derivati
+00030700: 7665 203d 206e 702e 6469 6666 2861 7272  ve = np.diff(arr
+00030710: 6179 2c20 6178 6973 3d30 290a 2020 2020  ay, axis=0).    
+00030720: 0a20 2020 2023 2041 7070 656e 6420 6120  .    # Append a 
+00030730: 726f 7720 746f 206d 6169 6e74 6169 6e20  row to maintain 
+00030740: 7468 6520 7361 6d65 2073 6861 7065 0a20  the same shape. 
+00030750: 2020 2023 2059 6f75 2063 616e 2063 686f     # You can cho
+00030760: 6f73 6520 746f 2061 7070 656e 6420 6120  ose to append a 
+00030770: 726f 7720 6f66 207a 6572 6f73 206f 7220  row of zeros or 
+00030780: 7468 6520 6c61 7374 2072 6f77 206f 6620  the last row of 
+00030790: 7468 6520 6465 7269 7661 7469 7665 0a20  the derivative. 
+000307a0: 2020 2023 2048 6572 652c 2061 2072 6f77     # Here, a row
+000307b0: 206f 6620 7a65 726f 7320 6973 2061 7070   of zeros is app
+000307c0: 656e 6465 640a 2020 2020 7a65 726f 735f  ended.    zeros_
+000307d0: 726f 7720 3d20 6e70 2e7a 6572 6f73 2828  row = np.zeros((
+000307e0: 312c 2061 7272 6179 2e73 6861 7065 5b31  1, array.shape[1
+000307f0: 5d29 290a 2020 2020 7265 7475 726e 206e  ])).    return n
+00030800: 702e 7673 7461 636b 2828 7a65 726f 735f  p.vstack((zeros_
+00030810: 726f 772c 2064 6572 6976 6174 6976 6520  row, derivative 
+00030820: 2929 0a0a 2020 6465 6620 636f 6d70 7574  ))..  def comput
+00030830: 655f 7453 5444 284d 2c20 7175 616e 7469  e_tSTD(M, quanti
+00030840: 6c65 2c20 783d 302c 2061 7869 733d 3029  le, x=0, axis=0)
+00030850: 3a0a 2020 2020 7374 644d 203d 206e 702e  :.    stdM = np.
+00030860: 7374 6428 4d2c 2061 7869 733d 6178 6973  std(M, axis=axis
+00030870: 290a 2020 2020 2320 7365 7420 6261 6420  ).    # set bad 
+00030880: 7661 6c75 6573 2074 6f20 780a 2020 2020  values to x.    
+00030890: 7374 644d 5b73 7464 4d20 3d3d 2030 5d20  stdM[stdM == 0] 
+000308a0: 3d20 780a 2020 2020 7374 644d 5b6e 702e  = x.    stdM[np.
+000308b0: 6973 6e61 6e28 7374 644d 295d 203d 2078  isnan(stdM)] = x
+000308c0: 0a20 2020 2074 7420 3d20 726f 756e 6428  .    tt = round(
+000308d0: 7175 616e 7469 6c65 202a 2031 3030 290a  quantile * 100).
+000308e0: 2020 2020 7468 7265 7368 6f6c 645f 7374      threshold_st
+000308f0: 6420 3d20 6e70 2e70 6572 6365 6e74 696c  d = np.percentil
+00030900: 6528 7374 644d 2c20 7474 290a 2020 2020  e(stdM, tt).    
+00030910: 7265 7475 726e 207b 2774 5354 4427 3a20  return {'tSTD': 
+00030920: 7374 644d 2c20 2774 6872 6573 686f 6c64  stdM, 'threshold
+00030930: 5f73 7464 273a 2074 6872 6573 686f 6c64  _std': threshold
+00030940: 5f73 7464 7d0a 0a20 2064 6566 2067 6574  _std}..  def get
+00030950: 5f63 6f6d 7063 6f72 5f6d 6174 7269 7828  _compcor_matrix(
+00030960: 626f 6c64 496d 6167 652c 206d 6173 6b2c  boldImage, mask,
+00030970: 2071 7561 6e74 696c 6529 3a0a 2020 2020   quantile):.    
+00030980: 2222 220a 2020 2020 436f 6d70 7574 6520  """.    Compute 
+00030990: 7468 6520 636f 6d70 636f 7220 6d61 7472  the compcor matr
+000309a0: 6978 2e0a 0a20 2020 203a 7061 7261 6d20  ix...    :param 
+000309b0: 626f 6c64 496d 6167 653a 2054 6865 2062  boldImage: The b
+000309c0: 6f6c 6420 696d 6167 652e 0a20 2020 203a  old image..    :
+000309d0: 7061 7261 6d20 6d61 736b 3a20 5468 6520  param mask: The 
+000309e0: 6d61 736b 2074 6f20 6170 706c 792c 2069  mask to apply, i
+000309f0: 6620 4e6f 6e65 2c20 6974 2077 696c 6c20  f None, it will 
+00030a00: 6265 2063 6f6d 7075 7465 642e 0a20 2020  be computed..   
+00030a10: 203a 7061 7261 6d20 7175 616e 7469 6c65   :param quantile
+00030a20: 3a20 5175 616e 7469 6c65 2066 6f72 2063  : Quantile for c
+00030a30: 6f6d 7075 7469 6e67 2074 6872 6573 686f  omputing thresho
+00030a40: 6c64 2069 6e20 7453 5444 2e0a 2020 2020  ld in tSTD..    
+00030a50: 3a72 6574 7572 6e3a 2054 6865 2063 6f6d  :return: The com
+00030a60: 706f 7220 6d61 7472 6978 2e0a 2020 2020  por matrix..    
+00030a70: 2222 220a 2020 2020 6966 206d 6173 6b20  """.    if mask 
+00030a80: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00030a90: 2074 656d 7020 3d20 616e 7473 2e73 6c69   temp = ants.sli
+00030aa0: 6365 5f69 6d61 6765 2862 6f6c 6449 6d61  ce_image(boldIma
+00030ab0: 6765 2c20 6178 6973 3d62 6f6c 6449 6d61  ge, axis=boldIma
+00030ac0: 6765 2e64 696d 656e 7369 6f6e 202d 2031  ge.dimension - 1
+00030ad0: 2c20 6964 783d 3029 0a20 2020 2020 2020  , idx=0).       
+00030ae0: 206d 6173 6b20 3d20 616e 7473 2e67 6574   mask = ants.get
+00030af0: 5f6d 6173 6b28 7465 6d70 290a 0a20 2020  _mask(temp)..   
+00030b00: 2069 6d61 6765 6d61 7472 6978 203d 2061   imagematrix = a
+00030b10: 6e74 732e 7469 6d65 7365 7269 6573 5f74  nts.timeseries_t
+00030b20: 6f5f 6d61 7472 6978 2862 6f6c 6449 6d61  o_matrix(boldIma
+00030b30: 6765 2c20 6d61 736b 290a 2020 2020 7465  ge, mask).    te
+00030b40: 6d70 203d 2063 6f6d 7075 7465 5f74 5354  mp = compute_tST
+00030b50: 4428 696d 6167 656d 6174 7269 782c 2071  D(imagematrix, q
+00030b60: 7561 6e74 696c 652c 2030 290a 2020 2020  uantile, 0).    
+00030b70: 7473 6e72 6d61 736b 203d 2061 6e74 732e  tsnrmask = ants.
+00030b80: 6d61 6b65 5f69 6d61 6765 286d 6173 6b2c  make_image(mask,
+00030b90: 2074 656d 705b 2774 5354 4427 5d29 0a20   temp['tSTD']). 
+00030ba0: 2020 2074 736e 726d 6173 6b20 3d20 616e     tsnrmask = an
+00030bb0: 7473 2e74 6872 6573 686f 6c64 5f69 6d61  ts.threshold_ima
+00030bc0: 6765 2874 736e 726d 6173 6b2c 2074 656d  ge(tsnrmask, tem
+00030bd0: 705b 2774 6872 6573 686f 6c64 5f73 7464  p['threshold_std
+00030be0: 275d 2c20 7465 6d70 5b27 7453 5444 275d  '], temp['tSTD']
+00030bf0: 2e6d 6178 2829 290a 2020 2020 4d20 3d20  .max()).    M = 
+00030c00: 616e 7473 2e74 696d 6573 6572 6965 735f  ants.timeseries_
+00030c10: 746f 5f6d 6174 7269 7828 626f 6c64 496d  to_matrix(boldIm
+00030c20: 6167 652c 2074 736e 726d 6173 6b29 0a20  age, tsnrmask). 
+00030c30: 2020 2072 6574 7572 6e20 4d0a 0a0a 2020     return M...  
+00030c40: 6672 6f6d 2073 6b6c 6561 726e 2e64 6563  from sklearn.dec
+00030c50: 6f6d 706f 7369 7469 6f6e 2069 6d70 6f72  omposition impor
+00030c60: 7420 4661 7374 4943 410a 2020 6465 6620  t FastICA.  def 
+00030c70: 6669 6e64 5f69 6e64 6963 6573 286c 7374  find_indices(lst
+00030c80: 2c20 7661 6c75 6529 3a0a 2020 2020 7265  , value):.    re
+00030c90: 7475 726e 205b 696e 6465 7820 666f 7220  turn [index for 
+00030ca0: 696e 6465 782c 2065 6c65 6d65 6e74 2069  index, element i
+00030cb0: 6e20 656e 756d 6572 6174 6528 6c73 7429  n enumerate(lst)
+00030cc0: 2069 6620 656c 656d 656e 7420 3e20 7661   if element > va
+00030cd0: 6c75 655d 0a0a 2020 6465 6620 6d65 616e  lue]..  def mean
+00030ce0: 5f6f 665f 6c69 7374 286c 7374 293a 0a20  _of_list(lst):. 
+00030cf0: 2020 2069 6620 6e6f 7420 6c73 743a 2020     if not lst:  
+00030d00: 2320 4368 6563 6b20 6966 2074 6865 206c  # Check if the l
+00030d10: 6973 7420 6973 206e 6f74 2065 6d70 7479  ist is not empty
+00030d20: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00030d30: 3020 2023 2052 6574 7572 6e20 3020 6f72  0  # Return 0 or
+00030d40: 2061 7070 726f 7072 6961 7465 2076 616c   appropriate val
+00030d50: 7565 2066 6f72 2061 6e20 656d 7074 7920  ue for an empty 
+00030d60: 6c69 7374 0a20 2020 2072 6574 7572 6e20  list.    return 
+00030d70: 7375 6d28 6c73 7429 202f 206c 656e 286c  sum(lst) / len(l
+00030d80: 7374 290a 2020 666d 7269 7370 6320 3d20  st).  fmrispc = 
+00030d90: 6c69 7374 2820 616e 7473 2e67 6574 5f73  list( ants.get_s
+00030da0: 7061 6369 6e67 2820 666d 7269 2029 2029  pacing( fmri ) )
+00030db0: 0a20 2069 6620 7370 6120 6973 204e 6f6e  .  if spa is Non
+00030dc0: 653a 0a20 2020 2073 7061 203d 206d 6561  e:.    spa = mea
+00030dd0: 6e5f 6f66 5f6c 6973 7428 2066 6d72 6973  n_of_list( fmris
+00030de0: 7063 5b30 3a33 5d20 2920 2a20 312e 300a  pc[0:3] ) * 1.0.
+00030df0: 2020 6966 2073 7074 2069 7320 4e6f 6e65    if spt is None
+00030e00: 3a0a 2020 2020 7370 7420 3d20 666d 7269  :.    spt = fmri
+00030e10: 7370 635b 335d 202a 2030 2e35 0a20 2020  spc[3] * 0.5.   
+00030e20: 2020 200a 2020 696d 706f 7274 206e 756d     .  import num
+00030e30: 7079 2061 7320 6e70 0a20 2069 6d70 6f72  py as np.  impor
+00030e40: 7420 7061 6e64 6173 2061 7320 7064 0a20  t pandas as pd. 
+00030e50: 2069 6d70 6f72 7420 7265 0a20 2069 6d70   import re.  imp
+00030e60: 6f72 7420 6d61 7468 0a20 2023 2070 6f69  ort math.  # poi
+00030e70: 6e74 2064 6174 6120 7265 736f 7572 6365  nt data resource
+00030e80: 730a 2020 4120 3d20 6e70 2e7a 6572 6f73  s.  A = np.zeros
+00030e90: 2828 312c 3129 290a 2020 6466 6e6e 616d  ((1,1)).  dfnnam
+00030ea0: 653d 2744 6566 6175 6c74 4d6f 6465 270a  e='DefaultMode'.
+00030eb0: 2020 6966 2070 6f77 6572 733a 0a20 2020    if powers:.   
+00030ec0: 2020 2070 6f77 6572 735f 6172 6561 6c5f     powers_areal_
+00030ed0: 6d6e 695f 6974 6b20 3d20 7064 2e72 6561  mni_itk = pd.rea
+00030ee0: 645f 6373 7628 2067 6574 5f64 6174 6128  d_csv( get_data(
+00030ef0: 2770 6f77 6572 735f 6d6e 695f 6974 6b27  'powers_mni_itk'
+00030f00: 2c20 7461 7267 6574 5f65 7874 656e 7369  , target_extensi
+00030f10: 6f6e 3d22 2e63 7376 2229 2920 2320 706f  on=".csv")) # po
+00030f20: 7765 7220 636f 6f72 6469 6e61 7465 730a  wer coordinates.
+00030f30: 2020 2020 2020 636f 6f72 6473 3d27 706f        coords='po
+00030f40: 7765 7273 270a 2020 656c 7365 3a0a 2020  wers'.  else:.  
+00030f50: 2020 2020 706f 7765 7273 5f61 7265 616c      powers_areal
+00030f60: 5f6d 6e69 5f69 746b 203d 2070 642e 7265  _mni_itk = pd.re
+00030f70: 6164 5f63 7376 2820 6765 745f 6461 7461  ad_csv( get_data
+00030f80: 2827 7070 6d69 5f74 656d 706c 6174 655f  ('ppmi_template_
+00030f90: 3530 3050 6172 6365 6c73 5f59 656f 3230  500Parcels_Yeo20
+00030fa0: 3131 5f31 374e 6574 776f 726b 735f 3230  11_17Networks_20
+00030fb0: 3233 5f68 6f6d 6f74 6f70 6963 272c 2074  23_homotopic', t
+00030fc0: 6172 6765 745f 6578 7465 6e73 696f 6e3d  arget_extension=
+00030fd0: 222e 6373 7622 2929 2023 2079 656f 2032  ".csv")) # yeo 2
+00030fe0: 3032 3320 636f 6f72 6469 6e61 7465 730a  023 coordinates.
+00030ff0: 2020 2020 2020 636f 6f72 6473 3d27 7965        coords='ye
+00031000: 6f5f 3137 5f35 3030 5f32 3032 3327 0a20  o_17_500_2023'. 
+00031010: 2066 6d72 6920 3d20 616e 7473 2e69 4d61   fmri = ants.iMa
+00031020: 7468 2820 666d 7269 2c20 274e 6f72 6d61  th( fmri, 'Norma
+00031030: 6c69 7a65 2720 290a 2020 626d 6173 6b20  lize' ).  bmask 
+00031040: 3d20 616e 7473 7079 6e65 742e 6272 6169  = antspynet.brai
+00031050: 6e5f 6578 7472 6163 7469 6f6e 2820 666d  n_extraction( fm
+00031060: 7269 5f74 656d 706c 6174 652c 2027 626f  ri_template, 'bo
+00031070: 6c64 2720 292e 7468 7265 7368 6f6c 645f  ld' ).threshold_
+00031080: 696d 6167 6528 302e 352c 3129 2e69 4d61  image(0.5,1).iMa
+00031090: 7468 2822 4669 6c6c 486f 6c65 7322 290a  th("FillHoles").
+000310a0: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+000310b0: 2020 2020 7072 696e 7428 2242 6567 696e      print("Begin
+000310c0: 2072 7366 6d72 6920 6d6f 7469 6f6e 2063   rsfmri motion c
+000310d0: 6f72 7265 6374 696f 6e22 290a 2020 6465  orrection").  de
+000310e0: 6275 673d 4661 6c73 650a 2020 6966 2064  bug=False.  if d
+000310f0: 6562 7567 3a0a 2020 2020 2020 616e 7473  ebug:.      ants
+00031100: 2e69 6d61 6765 5f77 7269 7465 2820 666d  .image_write( fm
+00031110: 7269 5f74 656d 706c 6174 652c 2027 2f74  ri_template, '/t
+00031120: 6d70 2f66 6d72 695f 7465 6d70 6c61 7465  mp/fmri_template
+00031130: 2e6e 6969 2e67 7a27 2029 0a20 2020 2020  .nii.gz' ).     
+00031140: 2061 6e74 732e 696d 6167 655f 7772 6974   ants.image_writ
+00031150: 6528 2066 6d72 692c 2027 2f74 6d70 2f66  e( fmri, '/tmp/f
+00031160: 6d72 692e 6e69 692e 677a 2720 290a 2020  mri.nii.gz' ).  
+00031170: 2020 2020 7072 696e 7428 2264 6562 7567      print("debug
+00031180: 2077 726f 7465 2066 6d72 6920 616e 6420   wrote fmri and 
+00031190: 666d 7269 5f74 656d 706c 6174 6522 290a  fmri_template").
+000311a0: 2020 2320 6d6f 742d 636f 0a20 2063 6f72    # mot-co.  cor
+000311b0: 726d 6f20 3d20 7469 6d65 7365 7269 6573  rmo = timeseries
+000311c0: 5f72 6567 280a 2020 2020 666d 7269 2c20  _reg(.    fmri, 
+000311d0: 666d 7269 5f74 656d 706c 6174 652c 0a20  fmri_template,. 
+000311e0: 2020 2074 7970 655f 6f66 5f74 7261 6e73     type_of_trans
+000311f0: 666f 726d 3d74 7970 655f 6f66 5f74 7261  form=type_of_tra
+00031200: 6e73 666f 726d 2c0a 2020 2020 746f 7461  nsform,.    tota
+00031210: 6c5f 7369 676d 613d 302e 352c 0a20 2020  l_sigma=0.5,.   
+00031220: 2066 644f 6666 7365 743d 322e 302c 0a20   fdOffset=2.0,. 
+00031230: 2020 2074 7269 6d20 3d20 382c 0a20 2020     trim = 8,.   
+00031240: 206f 7574 7075 745f 6469 7265 6374 6f72   output_director
+00031250: 793d 4e6f 6e65 2c0a 2020 2020 7665 7262  y=None,.    verb
+00031260: 6f73 653d 7665 7262 6f73 652c 0a20 2020  ose=verbose,.   
+00031270: 2073 796e 5f6d 6574 7269 633d 2763 6327   syn_metric='cc'
+00031280: 2c0a 2020 2020 7379 6e5f 7361 6d70 6c69  ,.    syn_sampli
+00031290: 6e67 3d32 2c0a 2020 2020 7265 675f 6974  ng=2,.    reg_it
+000312a0: 6572 6174 696f 6e73 3d5b 3430 2c32 302c  erations=[40,20,
+000312b0: 355d 2c0a 2020 2020 7265 7475 726e 5f6e  5],.    return_n
+000312c0: 756d 7079 5f6d 6f74 696f 6e5f 7061 7261  umpy_motion_para
+000312d0: 6d65 7465 7273 3d54 7275 6520 290a 2020  meters=True ).  
+000312e0: 0a20 2069 6620 7665 7262 6f73 653a 0a20  .  if verbose:. 
+000312f0: 2020 2020 2070 7269 6e74 2822 456e 6420       print("End 
+00031300: 7273 666d 7269 206d 6f74 696f 6e20 636f  rsfmri motion co
+00031310: 7272 6563 7469 6f6e 2229 0a20 2020 2020  rrection").     
+00031320: 2070 7269 6e74 2822 3d3d 3d20 6e65 7874   print("=== next
+00031330: 2061 6e61 746f 6d69 6361 6c6c 7920 6261   anatomically ba
+00031340: 7365 6420 6d61 7070 696e 6720 3d3d 3d22  sed mapping ==="
+00031350: 290a 0a20 2064 6573 7069 6b69 6e67 5f63  )..  despiking_c
+00031360: 6f75 6e74 203d 206e 702e 7a65 726f 7328  ount = np.zeros(
+00031370: 2063 6f72 726d 6f5b 276d 6f74 696f 6e5f   corrmo['motion_
+00031380: 636f 7272 6563 7465 6427 5d2e 7368 6170  corrected'].shap
+00031390: 655b 335d 2029 0a20 2069 6620 6465 7370  e[3] ).  if desp
+000313a0: 696b 6520 3e20 302e 303a 0a20 2020 2020  ike > 0.0:.     
+000313b0: 2063 6f72 726d 6f5b 276d 6f74 696f 6e5f   corrmo['motion_
+000313c0: 636f 7272 6563 7465 6427 5d2c 2064 6573  corrected'], des
+000313d0: 7069 6b69 6e67 5f63 6f75 6e74 203d 2064  piking_count = d
+000313e0: 6573 7069 6b65 5f74 696d 655f 7365 7269  espike_time_seri
+000313f0: 6573 5f61 666e 6928 2063 6f72 726d 6f5b  es_afni( corrmo[
+00031400: 276d 6f74 696f 6e5f 636f 7272 6563 7465  'motion_correcte
+00031410: 6427 5d2c 2063 313d 6465 7370 696b 6520  d'], c1=despike 
+00031420: 290a 0a20 2064 6573 7069 6b69 6e67 5f63  )..  despiking_c
+00031430: 6f75 6e74 5f73 756d 6d61 7279 203d 2064  ount_summary = d
+00031440: 6573 7069 6b69 6e67 5f63 6f75 6e74 2e73  espiking_count.s
+00031450: 756d 2829 202f 206e 702e 7072 6f64 2820  um() / np.prod( 
+00031460: 636f 7272 6d6f 5b27 6d6f 7469 6f6e 5f63  corrmo['motion_c
+00031470: 6f72 7265 6374 6564 275d 2e73 6861 7065  orrected'].shape
+00031480: 2029 0a20 2068 6967 685f 6d6f 7469 6f6e   ).  high_motion
+00031490: 5f63 6f75 6e74 3d28 636f 7272 6d6f 5b27  _count=(corrmo['
+000314a0: 4644 275d 203e 2046 445f 7468 7265 7368  FD'] > FD_thresh
+000314b0: 6f6c 6420 292e 7375 6d28 290a 2020 6869  old ).sum().  hi
+000314c0: 6768 5f6d 6f74 696f 6e5f 7063 743d 6869  gh_motion_pct=hi
+000314d0: 6768 5f6d 6f74 696f 6e5f 636f 756e 7420  gh_motion_count 
+000314e0: 2f20 666d 7269 2e73 6861 7065 5b33 5d0a  / fmri.shape[3].
+000314f0: 0a20 2023 2066 696c 7465 7220 6d61 736b  .  # filter mask
+00031500: 2062 6173 6564 206f 6e20 5453 4e52 0a20   based on TSNR. 
+00031510: 206d 7974 736e 7220 3d20 7473 6e72 2820   mytsnr = tsnr( 
+00031520: 636f 7272 6d6f 5b27 6d6f 7469 6f6e 5f63  corrmo['motion_c
+00031530: 6f72 7265 6374 6564 275d 2c20 626d 6173  orrected'], bmas
+00031540: 6b20 290a 2020 6d79 7473 6e72 5468 7265  k ).  mytsnrThre
+00031550: 7368 203d 206e 702e 7175 616e 7469 6c65  sh = np.quantile
+00031560: 2820 6d79 7473 6e72 2e6e 756d 7079 2829  ( mytsnr.numpy()
+00031570: 2c20 302e 3939 3520 290a 2020 7473 6e72  , 0.995 ).  tsnr
+00031580: 6d61 736b 203d 2061 6e74 732e 7468 7265  mask = ants.thre
+00031590: 7368 6f6c 645f 696d 6167 6528 206d 7974  shold_image( myt
+000315a0: 736e 722c 2030 2c20 6d79 7473 6e72 5468  snr, 0, mytsnrTh
+000315b0: 7265 7368 2029 2e6d 6f72 7068 6f6c 6f67  resh ).morpholog
+000315c0: 7928 2263 6c6f 7365 222c 3229 0a20 2062  y("close",2).  b
+000315d0: 6d61 736b 203d 2062 6d61 736b 202a 2074  mask = bmask * t
+000315e0: 736e 726d 6173 6b0a 0a20 2023 2061 6e61  snrmask..  # ana
+000315f0: 746f 6d69 6361 6c20 6d61 7070 696e 670a  tomical mapping.
+00031600: 2020 756e 6420 3d20 666d 7269 5f74 656d    und = fmri_tem
+00031610: 706c 6174 6520 2a20 626d 6173 6b0a 2020  plate * bmask.  
+00031620: 7431 7265 6720 3d20 616e 7473 2e72 6567  t1reg = ants.reg
+00031630: 6973 7472 6174 696f 6e28 2075 6e64 2c20  istration( und, 
+00031640: 7431 2c0a 2020 2020 2253 794e 426f 6c64  t1,.    "SyNBold
+00031650: 222c 206f 7574 7072 6566 6978 3d6f 666e  ", outprefix=ofn
+00031660: 7431 7478 2029 0a20 2069 6620 7665 7262  t1tx ).  if verb
+00031670: 6f73 653a 0a20 2020 2070 7269 6e74 2822  ose:.    print("
+00031680: 7431 2032 2062 6f6c 6420 646f 6e65 2229  t1 2 bold done")
+00031690: 0a20 2067 6d73 6567 203d 2061 6e74 732e  .  gmseg = ants.
+000316a0: 7468 7265 7368 6f6c 645f 696d 6167 6528  threshold_image(
+000316b0: 2074 3173 6567 6d65 6e74 6174 696f 6e2c   t1segmentation,
+000316c0: 2032 2c20 3220 290a 2020 676d 7365 6720   2, 2 ).  gmseg 
+000316d0: 3d20 676d 7365 6720 2b20 616e 7473 2e74  = gmseg + ants.t
+000316e0: 6872 6573 686f 6c64 5f69 6d61 6765 2820  hreshold_image( 
+000316f0: 7431 7365 676d 656e 7461 7469 6f6e 2c20  t1segmentation, 
+00031700: 342c 2034 2029 0a20 2067 6d73 6567 203d  4, 4 ).  gmseg =
+00031710: 2061 6e74 732e 7468 7265 7368 6f6c 645f   ants.threshold_
+00031720: 696d 6167 6528 2067 6d73 6567 2c20 312c  image( gmseg, 1,
+00031730: 2034 2029 0a20 2067 6d73 6567 203d 2061   4 ).  gmseg = a
+00031740: 6e74 732e 694d 6174 6828 2067 6d73 6567  nts.iMath( gmseg
+00031750: 2c20 274d 4427 2c20 3120 2920 2320 4649  , 'MD', 1 ) # FI
+00031760: 584d 4552 5346 0a20 2067 6d73 6567 203d  XMERSF.  gmseg =
+00031770: 2061 6e74 732e 6170 706c 795f 7472 616e   ants.apply_tran
+00031780: 7366 6f72 6d73 2820 756e 642c 2067 6d73  sforms( und, gms
+00031790: 6567 2c0a 2020 2020 7431 7265 675b 2766  eg,.    t1reg['f
+000317a0: 7764 7472 616e 7366 6f72 6d73 275d 2c20  wdtransforms'], 
+000317b0: 696e 7465 7270 6f6c 6174 6f72 203d 2027  interpolator = '
+000317c0: 6e65 6172 6573 744e 6569 6768 626f 7227  nearestNeighbor'
+000317d0: 2029 202a 2062 6d61 736b 0a20 2063 7366   ) * bmask.  csf
+000317e0: 416e 6457 4d20 3d20 2820 616e 7473 2e74  AndWM = ( ants.t
+000317f0: 6872 6573 686f 6c64 5f69 6d61 6765 2820  hreshold_image( 
+00031800: 7431 7365 676d 656e 7461 7469 6f6e 2c20  t1segmentation, 
+00031810: 312c 2031 2029 202b 0a20 2020 2020 2020  1, 1 ) +.       
+00031820: 2020 2020 2020 2020 616e 7473 2e74 6872          ants.thr
+00031830: 6573 686f 6c64 5f69 6d61 6765 2820 7431  eshold_image( t1
+00031840: 7365 676d 656e 7461 7469 6f6e 2c20 332c  segmentation, 3,
+00031850: 2033 2029 2029 2e6d 6f72 7068 6f6c 6f67   3 ) ).morpholog
+00031860: 7928 2265 726f 6465 222c 3129 0a20 2063  y("erode",1).  c
+00031870: 7366 416e 6457 4d20 3d20 616e 7473 2e61  sfAndWM = ants.a
+00031880: 7070 6c79 5f74 7261 6e73 666f 726d 7328  pply_transforms(
+00031890: 2075 6e64 2c20 6373 6641 6e64 574d 2c0a   und, csfAndWM,.
+000318a0: 2020 2020 7431 7265 675b 2766 7764 7472      t1reg['fwdtr
+000318b0: 616e 7366 6f72 6d73 275d 2c20 696e 7465  ansforms'], inte
+000318c0: 7270 6f6c 6174 6f72 203d 2027 6e65 6172  rpolator = 'near
+000318d0: 6573 744e 6569 6768 626f 7227 2029 2020  estNeighbor' )  
+000318e0: 2a20 626d 6173 6b0a 2020 6373 6620 3d20  * bmask.  csf = 
+000318f0: 616e 7473 2e74 6872 6573 686f 6c64 5f69  ants.threshold_i
+00031900: 6d61 6765 2820 7431 7365 676d 656e 7461  mage( t1segmenta
+00031910: 7469 6f6e 2c20 312c 2031 2029 0a20 2063  tion, 1, 1 ).  c
+00031920: 7366 203d 2061 6e74 732e 6170 706c 795f  sf = ants.apply_
+00031930: 7472 616e 7366 6f72 6d73 2820 756e 642c  transforms( und,
+00031940: 2063 7366 2c20 7431 7265 675b 2766 7764   csf, t1reg['fwd
+00031950: 7472 616e 7366 6f72 6d73 275d 2c20 696e  transforms'], in
+00031960: 7465 7270 6f6c 6174 6f72 203d 2027 6e65  terpolator = 'ne
+00031970: 6172 6573 744e 6569 6768 626f 7227 2029  arestNeighbor' )
+00031980: 2020 2a20 626d 6173 6b0a 2020 776d 203d    * bmask.  wm =
+00031990: 2061 6e74 732e 7468 7265 7368 6f6c 645f   ants.threshold_
+000319a0: 696d 6167 6528 2074 3173 6567 6d65 6e74  image( t1segment
+000319b0: 6174 696f 6e2c 2033 2c20 3320 292e 6d6f  ation, 3, 3 ).mo
+000319c0: 7270 686f 6c6f 6779 2822 6572 6f64 6522  rphology("erode"
+000319d0: 2c31 290a 2020 776d 203d 2061 6e74 732e  ,1).  wm = ants.
+000319e0: 6170 706c 795f 7472 616e 7366 6f72 6d73  apply_transforms
+000319f0: 2820 756e 642c 2077 6d2c 2074 3172 6567  ( und, wm, t1reg
+00031a00: 5b27 6677 6474 7261 6e73 666f 726d 7327  ['fwdtransforms'
+00031a10: 5d2c 2069 6e74 6572 706f 6c61 746f 7220  ], interpolator 
+00031a20: 3d20 276e 6561 7265 7374 4e65 6967 6862  = 'nearestNeighb
+00031a30: 6f72 2720 2920 202a 2062 6d61 736b 0a20  or' )  * bmask. 
+00031a40: 2069 6620 706f 7765 7273 3a0a 2020 2020   if powers:.    
+00031a50: 6368 3220 3d20 6d6d 5f72 6561 6428 2061  ch2 = mm_read( a
+00031a60: 6e74 732e 6765 745f 616e 7473 5f64 6174  nts.get_ants_dat
+00031a70: 6128 2022 6368 3222 2029 2029 0a20 2065  a( "ch2" ) ).  e
+00031a80: 6c73 653a 0a20 2020 2063 6832 203d 206d  lse:.    ch2 = m
+00031a90: 6d5f 7265 6164 2820 6765 745f 6461 7461  m_read( get_data
+00031aa0: 2820 2250 504d 495f 7465 6d70 6c61 7465  ( "PPMI_template
+00031ab0: 305f 6272 6169 6e22 2c20 7461 7267 6574  0_brain", target
+00031ac0: 5f65 7874 656e 7369 6f6e 3d27 2e6e 6969  _extension='.nii
+00031ad0: 2e67 7a27 2029 2029 0a20 2074 7265 6720  .gz' ) ).  treg 
+00031ae0: 3d20 616e 7473 2e72 6567 6973 7472 6174  = ants.registrat
+00031af0: 696f 6e28 200a 2020 2020 2320 7468 6973  ion( .    # this
+00031b00: 2069 7320 746f 206d 616b 6520 7468 6520   is to make the 
+00031b10: 696d 7061 6374 206f 6620 7265 736f 6c75  impact of resolu
+00031b20: 7469 6f6e 2063 6f6e 7369 7374 656e 740a  tion consistent.
+00031b30: 2020 2020 616e 7473 2e72 6573 616d 706c      ants.resampl
+00031b40: 655f 696d 6167 6528 7431 2c20 5b31 2e30  e_image(t1, [1.0
+00031b50: 2c31 2e30 2c31 2e30 5d2c 2069 6e74 6572  ,1.0,1.0], inter
+00031b60: 705f 7479 7065 3d30 292c 200a 2020 2020  p_type=0), .    
+00031b70: 6368 322c 2022 616e 7473 5265 6769 7374  ch2, "antsRegist
+00031b80: 7261 7469 6f6e 5379 4e51 7569 636b 5265  rationSyNQuickRe
+00031b90: 7072 6f5b 735d 2220 290a 2020 6966 2070  pro[s]" ).  if p
+00031ba0: 6f77 6572 733a 0a20 2020 2063 6f6e 6361  owers:.    conca
+00031bb0: 7478 3220 3d20 7472 6567 5b27 696e 7674  tx2 = treg['invt
+00031bc0: 7261 6e73 666f 726d 7327 5d20 2b20 7431  ransforms'] + t1
+00031bd0: 7265 675b 2769 6e76 7472 616e 7366 6f72  reg['invtransfor
+00031be0: 6d73 275d 0a20 2020 2070 7473 3262 6f6c  ms'].    pts2bol
+00031bf0: 6420 3d20 616e 7473 2e61 7070 6c79 5f74  d = ants.apply_t
+00031c00: 7261 6e73 666f 726d 735f 746f 5f70 6f69  ransforms_to_poi
+00031c10: 6e74 7328 2033 2c20 706f 7765 7273 5f61  nts( 3, powers_a
+00031c20: 7265 616c 5f6d 6e69 5f69 746b 2c20 636f  real_mni_itk, co
+00031c30: 6e63 6174 7832 2c0a 2020 2020 2020 2020  ncatx2,.        
+00031c40: 7768 6963 6874 6f69 6e76 6572 7420 3d20  whichtoinvert = 
+00031c50: 2820 5472 7565 2c20 4661 6c73 652c 2054  ( True, False, T
+00031c60: 7275 652c 2046 616c 7365 2029 2029 0a20  rue, False ) ). 
+00031c70: 2020 206c 6f63 6174 696f 6e73 203d 2070     locations = p
+00031c80: 7473 3262 6f6c 642e 696c 6f63 5b3a 2c3a  ts2bold.iloc[:,:
+00031c90: 335d 2e76 616c 7565 730a 2020 2020 7074  3].values.    pt
+00031ca0: 496d 6720 3d20 616e 7473 2e6d 616b 655f  Img = ants.make_
+00031cb0: 706f 696e 7473 5f69 6d61 6765 2820 6c6f  points_image( lo
+00031cc0: 6361 7469 6f6e 732c 2062 6d61 736b 2c20  cations, bmask, 
+00031cd0: 7261 6469 7573 203d 2032 2029 0a20 2065  radius = 2 ).  e
+00031ce0: 6c73 653a 0a20 2020 2063 6f6e 6361 7478  lse:.    concatx
+00031cf0: 3220 3d20 7431 7265 675b 2766 7764 7472  2 = t1reg['fwdtr
+00031d00: 616e 7366 6f72 6d73 275d 202b 2074 7265  ansforms'] + tre
+00031d10: 675b 2766 7764 7472 616e 7366 6f72 6d73  g['fwdtransforms
+00031d20: 275d 2020 2020 0a20 2020 2072 7366 7365  ']    .    rsfse
+00031d30: 6766 6e20 3d20 6765 745f 6461 7461 2827  gfn = get_data('
+00031d40: 7070 6d69 5f74 656d 706c 6174 655f 3530  ppmi_template_50
+00031d50: 3050 6172 6365 6c73 5f59 656f 3230 3131  0Parcels_Yeo2011
+00031d60: 5f31 374e 6574 776f 726b 735f 3230 3233  _17Networks_2023
+00031d70: 5f68 6f6d 6f74 6f70 6963 272c 2074 6172  _homotopic', tar
+00031d80: 6765 745f 6578 7465 6e73 696f 6e3d 222e  get_extension=".
+00031d90: 6e69 692e 677a 2229 0a20 2020 2072 7366  nii.gz").    rsf
+00031da0: 7365 6769 6d67 203d 2061 6e74 732e 696d  segimg = ants.im
+00031db0: 6167 655f 7265 6164 2820 7273 6673 6567  age_read( rsfseg
+00031dc0: 666e 2029 0a20 2020 2070 7449 6d67 203d  fn ).    ptImg =
+00031dd0: 2061 6e74 732e 6170 706c 795f 7472 616e   ants.apply_tran
+00031de0: 7366 6f72 6d73 2820 756e 642c 2072 7366  sforms( und, rsf
+00031df0: 7365 6769 6d67 2c20 636f 6e63 6174 7832  segimg, concatx2
+00031e00: 2c20 696e 7465 7270 6f6c 6174 6f72 3d27  , interpolator='
+00031e10: 6e65 6172 6573 744e 6569 6768 626f 7227  nearestNeighbor'
+00031e20: 2029 202a 2062 6d61 736b 0a20 2020 2070   ) * bmask.    p
+00031e30: 7473 3262 6f6c 6420 3d20 706f 7765 7273  ts2bold = powers
+00031e40: 5f61 7265 616c 5f6d 6e69 5f69 746b 0a20  _areal_mni_itk. 
+00031e50: 2020 2023 2061 6e74 732e 706c 6f74 2820     # ants.plot( 
+00031e60: 756e 642c 2070 7449 6d67 2c20 6372 6f70  und, ptImg, crop
+00031e70: 3d54 7275 652c 2061 7869 733d 3220 290a  =True, axis=2 ).
+00031e80: 0a20 2023 206f 7074 696f 6e61 6c20 736d  .  # optional sm
+00031e90: 6f6f 7468 696e 670a 2020 7472 203d 2061  oothing.  tr = a
+00031ea0: 6e74 732e 6765 745f 7370 6163 696e 6728  nts.get_spacing(
+00031eb0: 2063 6f72 726d 6f5b 276d 6f74 696f 6e5f   corrmo['motion_
+00031ec0: 636f 7272 6563 7465 6427 5d20 295b 335d  corrected'] )[3]
+00031ed0: 0a20 2073 6d74 6820 3d20 2820 7370 612c  .  smth = ( spa,
+00031ee0: 2073 7061 2c20 7370 612c 2073 7074 2029   spa, spa, spt )
+00031ef0: 2023 2074 6869 7320 6973 2066 6f72 2073   # this is for s
+00031f00: 6967 6d61 496e 5068 7973 6963 616c 436f  igmaInPhysicalCo
+00031f10: 6f72 6469 6e61 7465 7320 3d20 5452 5545  ordinates = TRUE
+00031f20: 0a20 2073 696d 6720 3d20 616e 7473 2e73  .  simg = ants.s
+00031f30: 6d6f 6f74 685f 696d 6167 6528 2063 6f72  mooth_image( cor
+00031f40: 726d 6f5b 276d 6f74 696f 6e5f 636f 7272  rmo['motion_corr
+00031f50: 6563 7465 6427 5d2c 2073 6d74 682c 2073  ected'], smth, s
+00031f60: 6967 6d61 5f69 6e5f 7068 7973 6963 616c  igma_in_physical
+00031f70: 5f63 6f6f 7264 696e 6174 6573 203d 2054  _coordinates = T
+00031f80: 7275 6520 290a 0a20 2023 2063 6f6c 6c65  rue )..  # colle
+00031f90: 6374 2063 656e 736f 7269 6e67 2069 6e64  ct censoring ind
+00031fa0: 6963 6573 0a20 2068 6c69 6e64 7320 3d20  ices.  hlinds = 
+00031fb0: 6669 6e64 5f69 6e64 6963 6573 2820 636f  find_indices( co
+00031fc0: 7272 6d6f 5b27 4644 275d 2c20 4644 5f74  rrmo['FD'], FD_t
+00031fd0: 6872 6573 686f 6c64 2029 0a20 2069 6620  hreshold ).  if 
+00031fe0: 7665 7262 6f73 653a 0a20 2020 2070 7269  verbose:.    pri
+00031ff0: 6e74 2822 6869 6768 206d 6f74 696f 6e20  nt("high motion 
+00032000: 696e 6469 6365 7322 290a 2020 2020 7072  indices").    pr
+00032010: 696e 7428 2068 6c69 6e64 7320 290a 2020  int( hlinds ).  
+00032020: 6966 206f 7574 6c69 6572 5f74 6872 6573  if outlier_thres
+00032030: 686f 6c64 203c 2031 2e30 2061 6e64 206f  hold < 1.0 and o
+00032040: 7574 6c69 6572 5f74 6872 6573 686f 6c64  utlier_threshold
+00032050: 203e 2030 2e30 3a0a 2020 2020 666d 7269   > 0.0:.    fmri
+00032060: 6d6f 7463 6f72 722c 2068 6c69 6e64 7332  motcorr, hlinds2
+00032070: 203d 206c 6f6f 705f 7469 6d65 7365 7269   = loop_timeseri
+00032080: 6573 5f63 656e 736f 7269 6e67 2820 636f  es_censoring( co
+00032090: 7272 6d6f 5b27 6d6f 7469 6f6e 5f63 6f72  rrmo['motion_cor
+000320a0: 7265 6374 6564 275d 2c20 0a20 2020 2020  rected'], .     
+000320b0: 2074 6872 6573 686f 6c64 3d6f 7574 6c69   threshold=outli
+000320c0: 6572 5f74 6872 6573 686f 6c64 2c20 7665  er_threshold, ve
+000320d0: 7262 6f73 653d 7665 7262 6f73 6520 290a  rbose=verbose ).
+000320e0: 2020 2020 686c 696e 6473 2e65 7874 656e      hlinds.exten
+000320f0: 6428 2068 6c69 6e64 7332 2029 0a20 2020  d( hlinds2 ).   
+00032100: 2064 656c 2066 6d72 696d 6f74 636f 7272   del fmrimotcorr
+00032110: 0a20 2068 6c69 6e64 7320 3d20 6c69 7374  .  hlinds = list
+00032120: 2873 6574 2868 6c69 6e64 7329 2920 2320  (set(hlinds)) # 
+00032130: 6d61 6b65 2075 6e69 7175 650a 0a20 2023  make unique..  #
+00032140: 206e 7569 7361 6e63 650a 2020 676c 6f62   nuisance.  glob
+00032150: 616c 6d61 7420 3d20 616e 7473 2e74 696d  almat = ants.tim
+00032160: 6573 6572 6965 735f 746f 5f6d 6174 7269  eseries_to_matri
+00032170: 7828 2063 6f72 726d 6f5b 276d 6f74 696f  x( corrmo['motio
+00032180: 6e5f 636f 7272 6563 7465 6427 5d2c 2062  n_corrected'], b
+00032190: 6d61 736b 2029 0a20 2067 6c6f 6261 6c73  mask ).  globals
+000321a0: 6967 6e61 6c20 3d20 6e70 2e6e 616e 6d65  ignal = np.nanme
+000321b0: 616e 2820 676c 6f62 616c 6d61 742c 2061  an( globalmat, a
+000321c0: 7869 7320 3d20 3120 290a 2020 6465 6c20  xis = 1 ).  del 
+000321d0: 676c 6f62 616c 6d61 740a 2020 636f 6d70  globalmat.  comp
+000321e0: 636f 7271 7561 6e74 696c 653d 302e 3530  corquantile=0.50
+000321f0: 0a20 206e 635f 776d 3d6e 635f 6373 663d  .  nc_wm=nc_csf=
+00032200: 6e63 0a20 2069 6620 6e63 203c 2031 3a0a  nc.  if nc < 1:.
+00032210: 2020 2020 676c 6f62 616c 6d61 7420 3d20      globalmat = 
+00032220: 6765 745f 636f 6d70 636f 725f 6d61 7472  get_compcor_matr
+00032230: 6978 2820 636f 7272 6d6f 5b27 6d6f 7469  ix( corrmo['moti
+00032240: 6f6e 5f63 6f72 7265 6374 6564 275d 2c20  on_corrected'], 
+00032250: 776d 2c20 636f 6d70 636f 7271 7561 6e74  wm, compcorquant
+00032260: 696c 6520 290a 2020 2020 6e63 5f77 6d20  ile ).    nc_wm 
+00032270: 3d20 696e 7428 6573 7469 6d61 7465 5f6f  = int(estimate_o
+00032280: 7074 696d 616c 5f70 6361 5f63 6f6d 706f  ptimal_pca_compo
+00032290: 6e65 6e74 7328 2064 6174 613d 676c 6f62  nents( data=glob
+000322a0: 616c 6d61 742c 2076 6172 6961 6e63 655f  almat, variance_
+000322b0: 7468 7265 7368 6f6c 643d 6e63 2929 0a20  threshold=nc)). 
+000322c0: 2020 2067 6c6f 6261 6c6d 6174 203d 2067     globalmat = g
+000322d0: 6574 5f63 6f6d 7063 6f72 5f6d 6174 7269  et_compcor_matri
+000322e0: 7828 2063 6f72 726d 6f5b 276d 6f74 696f  x( corrmo['motio
+000322f0: 6e5f 636f 7272 6563 7465 6427 5d2c 2063  n_corrected'], c
+00032300: 7366 2c20 636f 6d70 636f 7271 7561 6e74  sf, compcorquant
+00032310: 696c 6520 290a 2020 2020 6e63 5f63 7366  ile ).    nc_csf
+00032320: 203d 2069 6e74 2865 7374 696d 6174 655f   = int(estimate_
+00032330: 6f70 7469 6d61 6c5f 7063 615f 636f 6d70  optimal_pca_comp
+00032340: 6f6e 656e 7473 2820 6461 7461 3d67 6c6f  onents( data=glo
+00032350: 6261 6c6d 6174 2c20 7661 7269 616e 6365  balmat, variance
+00032360: 5f74 6872 6573 686f 6c64 3d6e 6329 290a  _threshold=nc)).
+00032370: 2020 2020 6465 6c20 676c 6f62 616c 6d61      del globalma
+00032380: 740a 2020 6966 2076 6572 626f 7365 3a0a  t.  if verbose:.
+00032390: 2020 2020 7072 696e 7428 2269 6e63 6c75      print("inclu
+000323a0: 6465 2063 6f6d 7063 6f72 2063 6f6d 706f  de compcor compo
+000323b0: 6e65 6e74 7320 6173 206e 7569 7361 6e63  nents as nuisanc
+000323c0: 653a 2063 7366 2022 202b 2073 7472 286e  e: csf " + str(n
+000323d0: 635f 6373 6629 202b 2022 2077 6d20 2220  c_csf) + " wm " 
+000323e0: 2b20 7374 7228 6e63 5f77 6d29 290a 2020  + str(nc_wm)).  
+000323f0: 6d79 636f 6d70 636f 725f 6373 6620 3d20  mycompcor_csf = 
+00032400: 616e 7473 2e63 6f6d 7063 6f72 2820 636f  ants.compcor( co
+00032410: 7272 6d6f 5b27 6d6f 7469 6f6e 5f63 6f72  rrmo['motion_cor
+00032420: 7265 6374 6564 275d 2c0a 2020 2020 6e63  rected'],.    nc
+00032430: 6f6d 7063 6f72 3d6e 635f 6373 662c 2071  ompcor=nc_csf, q
+00032440: 7561 6e74 696c 653d 636f 6d70 636f 7271  uantile=compcorq
+00032450: 7561 6e74 696c 652c 206d 6173 6b20 3d20  uantile, mask = 
+00032460: 6373 662c 0a20 2020 2066 696c 7465 725f  csf,.    filter_
+00032470: 7479 7065 3d27 706f 6c79 6e6f 6d69 616c  type='polynomial
+00032480: 272c 2064 6567 7265 653d 3220 290a 2020  ', degree=2 ).  
+00032490: 6d79 636f 6d70 636f 725f 776d 203d 2061  mycompcor_wm = a
+000324a0: 6e74 732e 636f 6d70 636f 7228 2063 6f72  nts.compcor( cor
+000324b0: 726d 6f5b 276d 6f74 696f 6e5f 636f 7272  rmo['motion_corr
+000324c0: 6563 7465 6427 5d2c 0a20 2020 206e 636f  ected'],.    nco
+000324d0: 6d70 636f 723d 6e63 5f77 6d2c 2071 7561  mpcor=nc_wm, qua
+000324e0: 6e74 696c 653d 636f 6d70 636f 7271 7561  ntile=compcorqua
+000324f0: 6e74 696c 652c 206d 6173 6b20 3d20 776d  ntile, mask = wm
+00032500: 2c0a 2020 2020 6669 6c74 6572 5f74 7970  ,.    filter_typ
+00032510: 653d 2770 6f6c 796e 6f6d 6961 6c27 2c20  e='polynomial', 
+00032520: 6465 6772 6565 3d32 2029 0a20 206e 7569  degree=2 ).  nui
+00032530: 7361 6e63 6520 3d20 6e70 2e63 5f5b 206d  sance = np.c_[ m
+00032540: 7963 6f6d 7063 6f72 5f63 7366 5b20 2763  ycompcor_csf[ 'c
+00032550: 6f6d 706f 6e65 6e74 7327 205d 2c20 6d79  omponents' ], my
+00032560: 636f 6d70 636f 725f 776d 5b20 2763 6f6d  compcor_wm[ 'com
+00032570: 706f 6e65 6e74 7327 205d 205d 0a0a 2020  ponents' ] ]..  
+00032580: 6966 206d 6f74 696f 6e5f 6173 5f6e 7569  if motion_as_nui
+00032590: 7361 6e63 653a 0a20 2020 2020 2069 6620  sance:.      if 
+000325a0: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+000325b0: 2020 2070 7269 6e74 2822 696e 636c 7564     print("includ
+000325c0: 6520 6d6f 7469 6f6e 2061 7320 6e75 6973  e motion as nuis
+000325d0: 616e 6365 2229 0a20 2020 2020 2020 2020  ance").         
+000325e0: 2070 7269 6e74 2820 636f 7272 6d6f 5b27   print( corrmo['
+000325f0: 6d6f 7469 6f6e 5f70 6172 616d 6574 6572  motion_parameter
+00032600: 7327 5d2e 7368 6170 6520 290a 2020 2020  s'].shape ).    
+00032610: 2020 6465 7269 7620 3d20 7465 6d70 6f72    deriv = tempor
+00032620: 616c 5f64 6572 6976 6174 6976 655f 7361  al_derivative_sa
+00032630: 6d65 5f73 6861 7065 2820 636f 7272 6d6f  me_shape( corrmo
+00032640: 5b27 6d6f 7469 6f6e 5f70 6172 616d 6574  ['motion_paramet
+00032650: 6572 7327 5d20 2029 0a20 2020 2020 206e  ers']  ).      n
+00032660: 7569 7361 6e63 6520 3d20 6e70 2e63 5f5b  uisance = np.c_[
+00032670: 206e 7569 7361 6e63 652c 2063 6f72 726d   nuisance, corrm
+00032680: 6f5b 276d 6f74 696f 6e5f 7061 7261 6d65  o['motion_parame
+00032690: 7465 7273 275d 2c20 6465 7269 7620 5d0a  ters'], deriv ].
+000326a0: 0a20 2069 6620 6963 615f 636f 6d70 6f6e  .  if ica_compon
+000326b0: 656e 7473 203e 2030 3a0a 2020 2020 6966  ents > 0:.    if
+000326c0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+000326d0: 2020 7072 696e 7428 2269 6e63 6c75 6465    print("include
+000326e0: 2069 6361 2063 6f6d 706f 6e65 6e74 7320   ica components 
+000326f0: 6173 206e 7569 7361 6e63 653a 2022 202b  as nuisance: " +
+00032700: 2073 7472 2869 6361 5f63 6f6d 706f 6e65   str(ica_compone
+00032710: 6e74 7329 290a 2020 2020 6963 6120 3d20  nts)).    ica = 
+00032720: 4661 7374 4943 4128 6e5f 636f 6d70 6f6e  FastICA(n_compon
+00032730: 656e 7473 3d69 6361 5f63 6f6d 706f 6e65  ents=ica_compone
+00032740: 6e74 732c 206d 6178 5f69 7465 723d 3130  nts, max_iter=10
+00032750: 3030 302c 2074 6f6c 3d30 2e30 3031 2c20  000, tol=0.001, 
+00032760: 7261 6e64 6f6d 5f73 7461 7465 3d34 3220  random_state=42 
+00032770: 290a 2020 2020 676c 6f62 616c 6d61 7420  ).    globalmat 
+00032780: 3d20 616e 7473 2e74 696d 6573 6572 6965  = ants.timeserie
+00032790: 735f 746f 5f6d 6174 7269 7828 2063 6f72  s_to_matrix( cor
+000327a0: 726d 6f5b 276d 6f74 696f 6e5f 636f 7272  rmo['motion_corr
+000327b0: 6563 7465 6427 5d2c 2063 7366 416e 6457  ected'], csfAndW
+000327c0: 4d20 290a 2020 2020 6e75 6973 616e 6365  M ).    nuisance
+000327d0: 5f69 6361 203d 2069 6361 2e66 6974 5f74  _ica = ica.fit_t
+000327e0: 7261 6e73 666f 726d 2867 6c6f 6261 6c6d  ransform(globalm
+000327f0: 6174 2920 2023 2052 6563 6f6e 7374 7275  at)  # Reconstru
+00032800: 6374 2073 6967 6e61 6c73 0a20 2020 206e  ct signals.    n
+00032810: 7569 7361 6e63 6520 3d20 6e70 2e63 5f5b  uisance = np.c_[
+00032820: 206e 7569 7361 6e63 652c 206e 7569 7361   nuisance, nuisa
+00032830: 6e63 655f 6963 6120 5d0a 2020 2020 6465  nce_ica ].    de
+00032840: 6c20 676c 6f62 616c 6d61 740a 0a20 2023  l globalmat..  #
+00032850: 2063 6f6e 6361 7420 616c 6c20 6e75 6973   concat all nuis
+00032860: 616e 6365 2064 6174 610a 2020 2320 6e75  ance data.  # nu
+00032870: 6973 616e 6365 203d 206e 702e 635f 5b20  isance = np.c_[ 
+00032880: 6e75 6973 616e 6365 2c20 6d79 636f 6d70  nuisance, mycomp
+00032890: 636f 725b 2762 6173 6973 275d 205d 0a20  cor['basis'] ]. 
+000328a0: 2023 206e 7569 7361 6e63 6520 3d20 6e70   # nuisance = np
+000328b0: 2e63 5f5b 206e 7569 7361 6e63 652c 2063  .c_[ nuisance, c
+000328c0: 6f72 726d 6f5b 2746 4427 5d20 5d0a 2020  orrmo['FD'] ].  
+000328d0: 6e75 6973 616e 6365 203d 206e 702e 635f  nuisance = np.c_
+000328e0: 5b20 6e75 6973 616e 6365 2c20 676c 6f62  [ nuisance, glob
+000328f0: 616c 7369 676e 616c 205d 0a0a 2020 6966  alsignal ]..  if
+00032900: 2069 6d70 7574 653a 0a20 2020 2073 696d   impute:.    sim
+00032910: 6769 6d70 203d 2069 6d70 7574 655f 7469  gimp = impute_ti
+00032920: 6d65 7365 7269 6573 2820 7369 6d67 2c20  meseries( simg, 
+00032930: 686c 696e 6473 2c20 6d65 7468 6f64 3d27  hlinds, method='
+00032940: 6c69 6e65 6172 2729 0a20 2065 6c73 653a  linear').  else:
+00032950: 0a20 2020 2073 696d 6769 6d70 203d 2073  .    simgimp = s
+00032960: 696d 670a 0a20 2023 2066 616c 6666 2f61  img..  # falff/a
+00032970: 6c66 6620 7374 7566 6620 2064 6566 2061  lff stuff  def a
+00032980: 6c66 665f 696d 6167 6528 2078 2c20 6d61  lff_image( x, ma
+00032990: 736b 2c20 666c 6f3d 302e 3031 2c20 6668  sk, flo=0.01, fh
+000329a0: 693d 302e 312c 206e 7569 7361 6e63 653d  i=0.1, nuisance=
+000329b0: 4e6f 6e65 2029 3a0a 2020 6d79 6661 6c66  None ):.  myfalf
+000329c0: 663d 616c 6666 5f69 6d61 6765 2820 7369  f=alff_image( si
+000329d0: 6d67 696d 702c 2062 6d61 736b 2c20 666c  mgimp, bmask, fl
+000329e0: 6f3d 665b 305d 2c20 6668 693d 665b 315d  o=f[0], fhi=f[1]
+000329f0: 2c20 6e75 6973 616e 6365 3d6e 7569 7361  , nuisance=nuisa
+00032a00: 6e63 6520 2029 0a0a 2020 2320 6261 6e64  nce  )..  # band
+00032a10: 7061 7373 2061 6e79 2064 6174 6120 636f  pass any data co
+00032a20: 6c6c 6563 7465 6420 6265 666f 7265 2068  llected before h
+00032a30: 6572 6520 2d2d 2069 6620 6261 6e64 7061  ere -- if bandpa
+00032a40: 7373 2072 6571 7565 7374 6564 0a20 2069  ss requested.  i
+00032a50: 6620 665b 305d 203e 2030 2061 6e64 2066  f f[0] > 0 and f
+00032a60: 5b31 5d20 3c20 312e 303a 0a20 2020 2069  [1] < 1.0:.    i
+00032a70: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+00032a80: 2020 2070 7269 6e74 2820 2262 616e 6470     print( "bandp
+00032a90: 6173 733a 2022 202b 2073 7472 2866 5b30  ass: " + str(f[0
+00032aa0: 5d29 202b 2022 203c 3d3e 2022 202b 2073  ]) + " <=> " + s
+00032ab0: 7472 2820 665b 315d 2029 2029 0a20 2020  tr( f[1] ) ).   
+00032ac0: 206e 7569 7361 6e63 6520 3d20 616e 7473   nuisance = ants
+00032ad0: 2e62 616e 6470 6173 735f 6669 6c74 6572  .bandpass_filter
+00032ae0: 5f6d 6174 7269 7828 206e 7569 7361 6e63  _matrix( nuisanc
+00032af0: 652c 2074 7220 3d20 7472 2c20 6c6f 7766  e, tr = tr, lowf
+00032b00: 3d66 5b30 5d2c 2068 6967 6866 3d66 5b31  =f[0], highf=f[1
+00032b10: 5d20 2920 2320 736f 6d65 2077 6f75 6c64  ] ) # some would
+00032b20: 2061 7267 7565 2061 6761 696e 7374 2074   argue against t
+00032b30: 6869 730a 2020 2020 676c 6f62 616c 6d61  his.    globalma
+00032b40: 7420 3d20 616e 7473 2e74 696d 6573 6572  t = ants.timeser
+00032b50: 6965 735f 746f 5f6d 6174 7269 7828 2073  ies_to_matrix( s
+00032b60: 696d 672c 2062 6d61 736b 2029 0a20 2020  img, bmask ).   
+00032b70: 2067 6c6f 6261 6c6d 6174 203d 2061 6e74   globalmat = ant
+00032b80: 732e 6261 6e64 7061 7373 5f66 696c 7465  s.bandpass_filte
+00032b90: 725f 6d61 7472 6978 2820 676c 6f62 616c  r_matrix( global
+00032ba0: 6d61 742c 2074 7220 3d20 7472 2c20 6c6f  mat, tr = tr, lo
+00032bb0: 7766 3d66 5b30 5d2c 2068 6967 6866 3d66  wf=f[0], highf=f
+00032bc0: 5b31 5d20 2920 2320 736f 6d65 2077 6f75  [1] ) # some wou
+00032bd0: 6c64 2061 7267 7565 2061 6761 696e 7374  ld argue against
+00032be0: 2074 6869 730a 2020 2020 7369 6d67 203d   this.    simg =
+00032bf0: 2061 6e74 732e 6d61 7472 6978 5f74 6f5f   ants.matrix_to_
+00032c00: 7469 6d65 7365 7269 6573 2820 7369 6d67  timeseries( simg
+00032c10: 2c20 676c 6f62 616c 6d61 742c 2062 6d61  , globalmat, bma
+00032c20: 736b 2029 0a0a 2020 6966 2076 6572 626f  sk )..  if verbo
+00032c30: 7365 3a0a 2020 2020 7072 696e 7428 226e  se:.    print("n
+00032c40: 6f77 2072 6567 7265 7373 206e 7569 7361  ow regress nuisa
+00032c50: 6e63 6522 290a 0a0a 2020 6966 206c 656e  nce")...  if len
+00032c60: 2820 686c 696e 6473 2029 203e 2030 203a  ( hlinds ) > 0 :
+00032c70: 0a20 2020 2069 6620 6365 6e73 6f72 3a0a  .    if censor:.
+00032c80: 2020 2020 2020 2020 6e75 6973 616e 6365          nuisance
+00032c90: 203d 2072 656d 6f76 655f 656c 656d 656e   = remove_elemen
+00032ca0: 7473 5f66 726f 6d5f 6e75 6d70 795f 6172  ts_from_numpy_ar
+00032cb0: 7261 7928 206e 7569 7361 6e63 652c 2068  ray( nuisance, h
+00032cc0: 6c69 6e64 7320 2029 0a20 2020 2020 2020  linds  ).       
+00032cd0: 2073 696d 6720 3d20 7265 6d6f 7665 5f76   simg = remove_v
+00032ce0: 6f6c 756d 6573 5f66 726f 6d5f 7469 6d65  olumes_from_time
+00032cf0: 7365 7269 6573 2820 7369 6d67 2c20 686c  series( simg, hl
+00032d00: 696e 6473 2029 0a0a 2020 676d 6d61 7420  inds )..  gmmat 
+00032d10: 3d20 616e 7473 2e74 696d 6573 6572 6965  = ants.timeserie
+00032d20: 735f 746f 5f6d 6174 7269 7828 2073 696d  s_to_matrix( sim
+00032d30: 672c 2062 6d61 736b 2029 0a20 2067 6d6d  g, bmask ).  gmm
+00032d40: 6174 203d 2061 6e74 732e 7265 6772 6573  at = ants.regres
+00032d50: 735f 636f 6d70 6f6e 656e 7473 2820 676d  s_components( gm
+00032d60: 6d61 742c 206e 7569 7361 6e63 6520 290a  mat, nuisance ).
+00032d70: 2020 7369 6d67 203d 2061 6e74 732e 6d61    simg = ants.ma
+00032d80: 7472 6978 5f74 6f5f 7469 6d65 7365 7269  trix_to_timeseri
+00032d90: 6573 2873 696d 672c 2067 6d6d 6174 2c20  es(simg, gmmat, 
+00032da0: 626d 6173 6b29 0a0a 0a20 2023 2073 7472  bmask)...  # str
+00032db0: 7563 7475 7265 2074 6865 206f 7574 7075  ucture the outpu
+00032dc0: 7420 6461 7461 0a20 206f 7574 6469 6374  t data.  outdict
+00032dd0: 203d 207b 7d0a 2020 6f75 7464 6963 745b   = {}.  outdict[
+00032de0: 2770 6172 616d 7365 7427 5d20 3d20 7061  'paramset'] = pa
+00032df0: 7261 6d73 6574 0a20 206f 7574 6469 6374  ramset.  outdict
+00032e00: 5b27 7570 7361 6d70 6c69 6e67 275d 203d  ['upsampling'] =
+00032e10: 2075 7073 616d 706c 650a 2020 6f75 7464   upsample.  outd
+00032e20: 6963 745b 2763 6f6f 7264 7327 5d20 3d20  ict['coords'] = 
+00032e30: 636f 6f72 6473 0a20 206f 7574 6469 6374  coords.  outdict
+00032e40: 5b27 6466 6e6e 616d 6527 5d3d 6466 6e6e  ['dfnname']=dfnn
+00032e50: 616d 650a 2020 6f75 7464 6963 745b 276d  ame.  outdict['m
+00032e60: 6561 6e42 6f6c 6427 5d20 3d20 756e 640a  eanBold'] = und.
+00032e70: 0a20 2023 2061 6464 2063 6f72 7265 6c61  .  # add correla
+00032e80: 7469 6f6e 206d 6174 7269 7820 7468 6174  tion matrix that
+00032e90: 2063 6170 7475 7265 7320 6561 6368 206e   captures each n
+00032ea0: 6f64 6520 7061 6972 0a20 2023 2073 6f6d  ode pair.  # som
+00032eb0: 6520 6f66 2074 6865 2073 7068 6572 6573  e of the spheres
+00032ec0: 206f 7665 726c 6170 2073 6f20 6578 7472   overlap so extr
+00032ed0: 6163 7420 7365 7061 7261 7465 6c79 2066  act separately f
+00032ee0: 726f 6d20 6561 6368 2052 4f49 0a20 2069  rom each ROI.  i
+00032ef0: 6620 706f 7765 7273 3a0a 2020 2020 6e50  f powers:.    nP
+00032f00: 6f69 6e74 7320 3d20 696e 7428 7074 7332  oints = int(pts2
+00032f10: 626f 6c64 5b27 524f 4927 5d2e 6d61 7828  bold['ROI'].max(
+00032f20: 2929 0a20 2020 2070 6f69 6e74 7261 6e67  )).    pointrang
+00032f30: 6520 3d20 6c69 7374 2872 616e 6765 2869  e = list(range(i
+00032f40: 6e74 286e 506f 696e 7473 2929 290a 2020  nt(nPoints))).  
+00032f50: 656c 7365 3a0a 2020 2020 6e50 6f69 6e74  else:.    nPoint
+00032f60: 7320 3d20 696e 7428 7074 496d 672e 6d61  s = int(ptImg.ma
+00032f70: 7828 2929 0a20 2020 2070 6f69 6e74 7261  x()).    pointra
+00032f80: 6e67 6520 3d20 6c69 7374 2872 616e 6765  nge = list(range
+00032f90: 2869 6e74 286e 506f 696e 7473 2929 290a  (int(nPoints))).
+00032fa0: 2020 6e56 6f6c 756d 6573 203d 2073 696d    nVolumes = sim
+00032fb0: 672e 7368 6170 655b 335d 0a20 206d 6561  g.shape[3].  mea
+00032fc0: 6e52 4f49 203d 206e 702e 7a65 726f 7328  nROI = np.zeros(
+00032fd0: 5b6e 566f 6c75 6d65 732c 206e 506f 696e  [nVolumes, nPoin
+00032fe0: 7473 5d29 0a20 2072 6f69 4e61 6d65 7320  ts]).  roiNames 
+00032ff0: 3d20 5b5d 0a20 2069 6620 6465 6275 673a  = [].  if debug:
+00033000: 0a20 2020 2020 2070 7449 6d67 416c 6c20  .      ptImgAll 
+00033010: 3d20 756e 6420 2a20 302e 0a20 2066 6f72  = und * 0..  for
+00033020: 2069 2069 6e20 706f 696e 7472 616e 6765   i in pointrange
+00033030: 3a0a 2020 2020 2320 7370 6563 6966 7920  :.    # specify 
+00033040: 6e61 6d65 2066 6f72 206d 6174 7269 7820  name for matrix 
+00033050: 656e 7472 6965 7320 7468 6174 2773 206c  entries that's l
+00033060: 696e 6b73 2062 6163 6b20 746f 2052 4f49  inks back to ROI
+00033070: 206e 756d 6265 7220 616e 6420 6e65 7477   number and netw
+00033080: 6f72 6b3b 2065 2e67 2e2c 2052 4f49 315f  ork; e.g., ROI1_
+00033090: 556e 6365 7274 6169 6e0a 2020 2020 6e65  Uncertain.    ne
+000330a0: 744c 6162 656c 203d 2072 652e 7375 6228  tLabel = re.sub(
+000330b0: 2022 2022 2c20 2222 2c20 7074 7332 626f   " ", "", pts2bo
+000330c0: 6c64 2e6c 6f63 5b69 2c27 5379 7374 656d  ld.loc[i,'System
+000330d0: 4e61 6d65 275d 290a 2020 2020 6e65 744c  Name']).    netL
+000330e0: 6162 656c 203d 2072 652e 7375 6228 2022  abel = re.sub( "
+000330f0: 2d22 2c20 2222 2c20 6e65 744c 6162 656c  -", "", netLabel
+00033100: 2029 0a20 2020 206e 6574 4c61 6265 6c20   ).    netLabel 
+00033110: 3d20 7265 2e73 7562 2820 222f 222c 2022  = re.sub( "/", "
+00033120: 222c 206e 6574 4c61 6265 6c20 290a 2020  ", netLabel ).  
+00033130: 2020 726f 694c 6162 656c 203d 2022 524f    roiLabel = "RO
+00033140: 4922 202b 2073 7472 2870 7473 3262 6f6c  I" + str(pts2bol
+00033150: 642e 6c6f 635b 692c 2752 4f49 275d 2920  d.loc[i,'ROI']) 
+00033160: 2b20 275f 2720 2b20 6e65 744c 6162 656c  + '_' + netLabel
+00033170: 0a20 2020 2072 6f69 4e61 6d65 732e 6170  .    roiNames.ap
+00033180: 7065 6e64 2820 726f 694c 6162 656c 2029  pend( roiLabel )
+00033190: 0a20 2020 2069 6620 706f 7765 7273 3a0a  .    if powers:.
+000331a0: 2020 2020 2020 2020 7074 496d 6167 6520          ptImage 
+000331b0: 3d20 616e 7473 2e6d 616b 655f 706f 696e  = ants.make_poin
+000331c0: 7473 5f69 6d61 6765 2870 7473 3262 6f6c  ts_image(pts2bol
+000331d0: 642e 696c 6f63 5b5b 695d 2c3a 335d 2e76  d.iloc[[i],:3].v
+000331e0: 616c 7565 732c 2062 6d61 736b 2c20 7261  alues, bmask, ra
+000331f0: 6469 7573 3d31 292e 7468 7265 7368 6f6c  dius=1).threshol
+00033200: 645f 696d 6167 6528 2031 2c20 3165 3920  d_image( 1, 1e9 
+00033210: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00033220: 2020 2020 2370 7269 6e74 2822 446f 696e      #print("Doin
+00033230: 6720 2220 2b20 7074 7332 626f 6c64 2e6c  g " + pts2bold.l
+00033240: 6f63 5b69 2c27 5379 7374 656d 4e61 6d65  oc[i,'SystemName
+00033250: 275d 202b 2022 2061 7420 2220 2b20 7374  '] + " at " + st
+00033260: 7228 6929 2029 0a20 2020 2020 2020 2023  r(i) ).        #
+00033270: 7074 496d 6167 6520 3d20 616e 7473 2e6d  ptImage = ants.m
+00033280: 6173 6b5f 696d 6167 6528 2070 7449 6d67  ask_image( ptImg
+00033290: 2c20 7074 496d 672c 206c 6576 656c 3d70  , ptImg, level=p
+000332a0: 7473 3262 6f6c 645b 2752 4f49 275d 5b70  ts2bold['ROI'][p
+000332b0: 7473 3262 6f6c 645b 2753 7973 7465 6d4e  ts2bold['SystemN
+000332c0: 616d 6527 5d3d 3d70 7473 3262 6f6c 642e  ame']==pts2bold.
+000332d0: 6c6f 635b 692c 2753 7973 7465 6d4e 616d  loc[i,'SystemNam
+000332e0: 6527 5d5d 2c62 696e 6172 697a 653d 5472  e']],binarize=Tr
+000332f0: 7565 290a 2020 2020 2020 2020 7074 496d  ue).        ptIm
+00033300: 6167 653d 616e 7473 2e74 6872 6573 686f  age=ants.thresho
+00033310: 6c64 5f69 6d61 6765 2820 7074 496d 672c  ld_image( ptImg,
+00033320: 2070 7473 3262 6f6c 642e 6c6f 635b 692c   pts2bold.loc[i,
+00033330: 2752 4f49 275d 2c20 7074 7332 626f 6c64  'ROI'], pts2bold
+00033340: 2e6c 6f63 5b69 2c27 524f 4927 5d20 290a  .loc[i,'ROI'] ).
+00033350: 2020 2020 6966 2064 6562 7567 3a0a 2020      if debug:.  
+00033360: 2020 2020 7074 496d 6741 6c6c 203d 2070      ptImgAll = p
+00033370: 7449 6d67 416c 6c20 2b20 7074 496d 6167  tImgAll + ptImag
+00033380: 650a 2020 2020 6966 2070 7449 6d61 6765  e.    if ptImage
+00033390: 2e73 756d 2829 203e 2030 203a 0a20 2020  .sum() > 0 :.   
+000333a0: 2020 2020 206d 6561 6e52 4f49 5b3a 2c69       meanROI[:,i
+000333b0: 5d20 3d20 616e 7473 2e74 696d 6573 6572  ] = ants.timeser
+000333c0: 6965 735f 746f 5f6d 6174 7269 7828 2073  ies_to_matrix( s
+000333d0: 696d 672c 2070 7449 6d61 6765 292e 6d65  img, ptImage).me
+000333e0: 616e 2861 7869 733d 3129 0a0a 2020 6966  an(axis=1)..  if
+000333f0: 2064 6562 7567 3a0a 2020 2020 2020 616e   debug:.      an
+00033400: 7473 2e69 6d61 6765 5f77 7269 7465 2820  ts.image_write( 
+00033410: 7369 6d67 2c20 272f 746d 702f 7369 6d67  simg, '/tmp/simg
+00033420: 2e6e 6969 2e67 7a27 2029 0a20 2020 2020  .nii.gz' ).     
+00033430: 2061 6e74 732e 696d 6167 655f 7772 6974   ants.image_writ
+00033440: 6528 2070 7449 6d67 416c 6c2c 2027 2f74  e( ptImgAll, '/t
+00033450: 6d70 2f70 7449 6d67 416c 6c2e 6e69 692e  mp/ptImgAll.nii.
+00033460: 677a 2720 290a 2020 2020 2020 616e 7473  gz' ).      ants
+00033470: 2e69 6d61 6765 5f77 7269 7465 2820 756e  .image_write( un
+00033480: 642c 2027 2f74 6d70 2f75 6e64 2e6e 6969  d, '/tmp/und.nii
+00033490: 2e67 7a27 2029 0a20 2020 2020 2061 6e74  .gz' ).      ant
+000334a0: 732e 696d 6167 655f 7772 6974 6528 2075  s.image_write( u
+000334b0: 6e64 2c20 272f 746d 702f 756e 642e 6e69  nd, '/tmp/und.ni
+000334c0: 692e 677a 2720 290a 0a20 2023 2067 6574  i.gz' )..  # get
+000334d0: 2066 756c 6c20 636f 7272 656c 6174 696f   full correlatio
+000334e0: 6e20 6d61 7472 6978 0a20 2063 6f72 4d61  n matrix.  corMa
+000334f0: 7420 3d20 6e70 2e63 6f72 7263 6f65 6628  t = np.corrcoef(
+00033500: 6d65 616e 524f 492c 2072 6f77 7661 723d  meanROI, rowvar=
+00033510: 4661 6c73 6529 0a20 206f 7574 7075 744d  False).  outputM
+00033520: 6174 203d 2070 642e 4461 7461 4672 616d  at = pd.DataFram
+00033530: 6528 636f 724d 6174 290a 2020 6f75 7470  e(corMat).  outp
+00033540: 7574 4d61 742e 636f 6c75 6d6e 7320 3d20  utMat.columns = 
+00033550: 726f 694e 616d 6573 0a20 206f 7574 7075  roiNames.  outpu
+00033560: 744d 6174 5b27 524f 4973 275d 203d 2072  tMat['ROIs'] = r
+00033570: 6f69 4e61 6d65 730a 2020 2320 6164 6420  oiNames.  # add 
+00033580: 746f 2064 6963 7469 6f6e 6172 790a 2020  to dictionary.  
+00033590: 6f75 7464 6963 745b 2766 756c 6c43 6f72  outdict['fullCor
+000335a0: 724d 6174 275d 203d 206f 7574 7075 744d  rMat'] = outputM
+000335b0: 6174 0a0a 2020 6e65 7477 6f72 6b73 203d  at..  networks =
+000335c0: 2070 6f77 6572 735f 6172 6561 6c5f 6d6e   powers_areal_mn
+000335d0: 695f 6974 6b5b 2753 7973 7465 6d4e 616d  i_itk['SystemNam
+000335e0: 6527 5d2e 756e 6971 7565 2829 0a20 2023  e'].unique().  #
+000335f0: 2074 6869 7320 6973 206a 7573 7420 666f   this is just fo
+00033600: 7220 6875 6d61 6e20 7265 6164 6162 696c  r human readabil
+00033610: 6974 7920 2d20 7265 6d69 6e64 7320 7573  ity - reminds us
+00033620: 206f 6620 7768 6963 6820 7765 2063 686f   of which we cho
+00033630: 6f73 6520 6279 2064 6566 6175 6c74 0a20  ose by default. 
+00033640: 2069 6620 706f 7765 7273 3a0a 2020 2020   if powers:.    
+00033650: 6e65 746e 616d 6573 203d 205b 2743 696e  netnames = ['Cin
+00033660: 6775 6c6f 2d6f 7065 7263 756c 6172 2054  gulo-opercular T
+00033670: 6173 6b20 436f 6e74 726f 6c27 2c20 2744  ask Control', 'D
+00033680: 6566 6175 6c74 204d 6f64 6527 2c0a 2020  efault Mode',.  
+00033690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000336a0: 2020 274d 656d 6f72 7920 5265 7472 6965    'Memory Retrie
+000336b0: 7661 6c27 2c20 2756 656e 7472 616c 2041  val', 'Ventral A
+000336c0: 7474 656e 7469 6f6e 272c 2027 5669 7375  ttention', 'Visu
+000336d0: 616c 272c 0a20 2020 2020 2020 2020 2020  al',.           
+000336e0: 2020 2020 2020 2020 2027 4672 6f6e 746f           'Fronto
+000336f0: 2d70 6172 6965 7461 6c20 5461 736b 2043  -parietal Task C
+00033700: 6f6e 7472 6f6c 272c 2027 5361 6c69 656e  ontrol', 'Salien
+00033710: 6365 272c 2027 5375 6263 6f72 7469 6361  ce', 'Subcortica
+00033720: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00033730: 2020 2020 2020 2020 2744 6f72 7361 6c20          'Dorsal 
+00033740: 4174 7465 6e74 696f 6e27 5d0a 2020 2020  Attention'].    
+00033750: 6e75 6d6f 666e 6574 7320 3d20 5b33 2c35  numofnets = [3,5
+00033760: 2c36 2c37 2c38 2c39 2c31 302c 3131 2c31  ,6,7,8,9,10,11,1
+00033770: 335d 0a20 2065 6c73 653a 0a20 2020 206e  3].  else:.    n
+00033780: 6574 6e61 6d65 7320 3d20 6e65 7477 6f72  etnames = networ
+00033790: 6b73 0a20 2020 206e 756d 6f66 6e65 7473  ks.    numofnets
+000337a0: 203d 206c 6973 7428 7261 6e67 6528 6c65   = list(range(le
+000337b0: 6e28 6e65 746e 616d 6573 2929 290a 200a  n(netnames))). .
+000337c0: 2020 6374 203d 2030 0a20 2066 6f72 206d    ct = 0.  for m
+000337d0: 796e 6574 2069 6e20 6e75 6d6f 666e 6574  ynet in numofnet
+000337e0: 733a 0a20 2020 206e 6574 6e61 6d65 203d  s:.    netname =
+000337f0: 2072 652e 7375 6228 2022 2022 2c20 2222   re.sub( " ", ""
+00033800: 2c20 6e65 7477 6f72 6b73 5b6d 796e 6574  , networks[mynet
+00033810: 5d20 290a 2020 2020 6e65 746e 616d 6520  ] ).    netname 
+00033820: 3d20 7265 2e73 7562 2820 222d 222c 2022  = re.sub( "-", "
+00033830: 222c 206e 6574 6e61 6d65 2029 0a20 2020  ", netname ).   
+00033840: 2077 7720 3d20 6e70 2e77 6865 7265 2820   ww = np.where( 
+00033850: 706f 7765 7273 5f61 7265 616c 5f6d 6e69  powers_areal_mni
+00033860: 5f69 746b 5b27 5379 7374 656d 4e61 6d65  _itk['SystemName
+00033870: 275d 203d 3d20 6e65 7477 6f72 6b73 5b6d  '] == networks[m
+00033880: 796e 6574 5d20 295b 305d 0a20 2020 2069  ynet] )[0].    i
+00033890: 6620 706f 7765 7273 3a0a 2020 2020 2020  f powers:.      
+000338a0: 2020 6466 6e49 6d67 203d 2061 6e74 732e    dfnImg = ants.
+000338b0: 6d61 6b65 5f70 6f69 6e74 735f 696d 6167  make_points_imag
+000338c0: 6528 7074 7332 626f 6c64 2e69 6c6f 635b  e(pts2bold.iloc[
+000338d0: 7777 2c3a 335d 2e76 616c 7565 732c 2062  ww,:3].values, b
+000338e0: 6d61 736b 2c20 7261 6469 7573 3d31 292e  mask, radius=1).
+000338f0: 7468 7265 7368 6f6c 645f 696d 6167 6528  threshold_image(
+00033900: 2031 2c20 3165 3920 290a 2020 2020 656c   1, 1e9 ).    el
+00033910: 7365 3a0a 2020 2020 2020 2020 6466 6e49  se:.        dfnI
+00033920: 6d67 203d 2061 6e74 732e 6d61 736b 5f69  mg = ants.mask_i
+00033930: 6d61 6765 2820 7074 496d 672c 2070 7449  mage( ptImg, ptI
+00033940: 6d67 2c20 6c65 7665 6c3d 7074 7332 626f  mg, level=pts2bo
+00033950: 6c64 5b27 524f 4927 5d5b 7074 7332 626f  ld['ROI'][pts2bo
+00033960: 6c64 5b27 5379 7374 656d 4e61 6d65 275d  ld['SystemName']
+00033970: 3d3d 6e65 7477 6f72 6b73 5b6d 796e 6574  ==networks[mynet
+00033980: 5d5d 2c62 696e 6172 697a 653d 5472 7565  ]],binarize=True
+00033990: 290a 2020 2020 6966 2064 666e 496d 672e  ).    if dfnImg.
+000339a0: 6d61 7828 2920 3e3d 2031 3a0a 2020 2020  max() >= 1:.    
+000339b0: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
+000339c0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+000339d0: 7428 2244 4f3a 2022 202b 2063 6f6f 7264  t("DO: " + coord
+000339e0: 7320 2b20 2220 2220 2b20 6e65 746e 616d  s + " " + netnam
+000339f0: 6520 290a 2020 2020 2020 2020 6466 6e6d  e ).        dfnm
+00033a00: 6174 203d 2061 6e74 732e 7469 6d65 7365  at = ants.timese
+00033a10: 7269 6573 5f74 6f5f 6d61 7472 6978 2820  ries_to_matrix( 
+00033a20: 7369 6d67 2c20 616e 7473 2e74 6872 6573  simg, ants.thres
+00033a30: 686f 6c64 5f69 6d61 6765 2820 6466 6e49  hold_image( dfnI
+00033a40: 6d67 2c20 312c 2064 666e 496d 672e 6d61  mg, 1, dfnImg.ma
+00033a50: 7828 2920 2920 290a 2020 2020 2020 2020  x() ) ).        
+00033a60: 6466 6e73 6967 6e61 6c20 3d20 6e70 2e6e  dfnsignal = np.n
+00033a70: 616e 6d65 616e 2820 6466 6e6d 6174 2c20  anmean( dfnmat, 
+00033a80: 6178 6973 203d 2031 2029 0a20 2020 2020  axis = 1 ).     
+00033a90: 2020 206e 616e 5f63 6f75 6e74 5f64 666e     nan_count_dfn
+00033aa0: 203d 206e 702e 636f 756e 745f 6e6f 6e7a   = np.count_nonz
+00033ab0: 6572 6f28 206e 702e 6973 6e61 6e28 2064  ero( np.isnan( d
+00033ac0: 666e 7369 676e 616c 2920 290a 2020 2020  fnsignal) ).    
+00033ad0: 2020 2020 6966 206e 616e 5f63 6f75 6e74      if nan_count
+00033ae0: 5f64 666e 203e 2030 203a 0a20 2020 2020  _dfn > 0 :.     
+00033af0: 2020 2020 2020 2077 6172 6e69 6e67 732e         warnings.
+00033b00: 7761 726e 2820 2220 6d79 6e65 7420 2220  warn( " mynet " 
+00033b10: 2b20 6e65 746e 616d 6573 5b20 6d79 6e65  + netnames[ myne
+00033b20: 7420 5d20 2b20 2220 7673 2022 202b 2020  t ] + " vs " +  
+00033b30: 2220 6d65 616e 2d73 6967 6e61 6c20 6861  " mean-signal ha
+00033b40: 7320 6e61 6e73 2022 202b 2073 7472 2820  s nans " + str( 
+00033b50: 6e61 6e5f 636f 756e 745f 6466 6e20 2920  nan_count_dfn ) 
+00033b60: 2920 0a20 2020 2020 2020 2067 6d6d 6174  ) .        gmmat
+00033b70: 4446 4e43 6f72 7220 3d20 6e70 2e7a 6572  DFNCorr = np.zer
+00033b80: 6f73 2820 676d 6d61 742e 7368 6170 655b  os( gmmat.shape[
+00033b90: 315d 2029 0a20 2020 2020 2020 2069 6620  1] ).        if 
+00033ba0: 6e61 6e5f 636f 756e 745f 6466 6e20 3d3d  nan_count_dfn ==
+00033bb0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00033bc0: 666f 7220 6b20 696e 2072 616e 6765 2820  for k in range( 
+00033bd0: 676d 6d61 742e 7368 6170 655b 315d 2029  gmmat.shape[1] )
+00033be0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00033bf0: 2020 6e61 6e5f 636f 756e 745f 676d 203d    nan_count_gm =
+00033c00: 206e 702e 636f 756e 745f 6e6f 6e7a 6572   np.count_nonzer
+00033c10: 6f28 206e 702e 6973 6e61 6e28 2067 6d6d  o( np.isnan( gmm
+00033c20: 6174 5b3a 2c6b 5d29 2029 0a20 2020 2020  at[:,k]) ).     
+00033c30: 2020 2020 2020 2020 2020 2069 6620 6465             if de
+00033c40: 6275 6720 616e 6420 4661 6c73 653a 0a20  bug and False:. 
+00033c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033c60: 2020 2070 7269 6e74 2820 7374 7228 206b     print( str( k
+00033c70: 2029 202b 2020 2220 6e61 6e73 2067 6d20   ) +  " nans gm 
+00033c80: 2220 2b20 7374 7228 6e61 6e5f 636f 756e  " + str(nan_coun
+00033c90: 745f 676d 2920 2029 0a20 2020 2020 2020  t_gm)  ).       
+00033ca0: 2020 2020 2020 2020 2069 6620 6e61 6e5f           if nan_
+00033cb0: 636f 756e 745f 676d 203d 3d20 303a 0a20  count_gm == 0:. 
+00033cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033cd0: 2020 2067 6d6d 6174 4446 4e43 6f72 725b     gmmatDFNCorr[
+00033ce0: 206b 205d 203d 2070 6561 7273 6f6e 7228   k ] = pearsonr(
+00033cf0: 2064 666e 7369 676e 616c 2c20 676d 6d61   dfnsignal, gmma
+00033d00: 745b 3a2c 6b5d 2029 5b30 5d0a 2020 2020  t[:,k] )[0].    
+00033d10: 2020 2020 636f 7272 496d 6720 3d20 616e      corrImg = an
+00033d20: 7473 2e6d 616b 655f 696d 6167 6528 2062  ts.make_image( b
+00033d30: 6d61 736b 2c20 676d 6d61 7444 464e 436f  mask, gmmatDFNCo
+00033d40: 7272 2020 290a 2020 2020 2020 2020 6f75  rr  ).        ou
+00033d50: 7464 6963 745b 206e 6574 6e61 6d65 205d  tdict[ netname ]
+00033d60: 203d 2063 6f72 7249 6d67 202a 2067 6d73   = corrImg * gms
+00033d70: 6567 0a20 2020 2065 6c73 653a 0a20 2020  eg.    else:.   
+00033d80: 2020 2020 206f 7574 6469 6374 5b20 6e65       outdict[ ne
+00033d90: 746e 616d 6520 5d20 3d20 4e6f 6e65 0a20  tname ] = None. 
+00033da0: 2020 2063 7420 3d20 6374 202b 2031 0a0a     ct = ct + 1..
+00033db0: 2020 4120 3d20 6e70 2e7a 6572 6f73 2820    A = np.zeros( 
+00033dc0: 2820 6c65 6e28 206e 756d 6f66 6e65 7473  ( len( numofnets
+00033dd0: 2029 202c 206c 656e 2820 6e75 6d6f 666e   ) , len( numofn
+00033de0: 6574 7320 2920 2920 290a 2020 415f 7769  ets ) ) ).  A_wi
+00033df0: 6465 203d 206e 702e 7a65 726f 7328 2028  de = np.zeros( (
+00033e00: 2031 2c20 6c65 6e28 206e 756d 6f66 6e65   1, len( numofne
+00033e10: 7473 2029 202a 206c 656e 2820 6e75 6d6f  ts ) * len( numo
+00033e20: 666e 6574 7320 2920 2920 290a 2020 6e65  fnets ) ) ).  ne
+00033e30: 776e 616d 6573 3d5b 5d0a 2020 6e65 776e  wnames=[].  newn
+00033e40: 616d 6573 5f77 6964 653d 5b5d 0a20 2063  ames_wide=[].  c
+00033e50: 7420 3d20 300a 2020 666f 7220 6920 696e  t = 0.  for i in
+00033e60: 2072 616e 6765 2820 6c65 6e28 206e 756d   range( len( num
+00033e70: 6f66 6e65 7473 2029 2029 3a0a 2020 2020  ofnets ) ):.    
+00033e80: 2020 6e65 746e 616d 6569 203d 2072 652e    netnamei = re.
+00033e90: 7375 6228 2022 2022 2c20 2222 2c20 6e65  sub( " ", "", ne
+00033ea0: 7477 6f72 6b73 5b6e 756d 6f66 6e65 7473  tworks[numofnets
+00033eb0: 5b69 5d5d 2029 0a20 2020 2020 206e 6574  [i]] ).      net
+00033ec0: 6e61 6d65 6920 3d20 7265 2e73 7562 2820  namei = re.sub( 
+00033ed0: 222d 222c 2022 222c 206e 6574 6e61 6d65  "-", "", netname
+00033ee0: 6920 290a 2020 2020 2020 6e65 776e 616d  i ).      newnam
+00033ef0: 6573 2e61 7070 656e 6428 206e 6574 6e61  es.append( netna
+00033f00: 6d65 6920 2029 0a20 2020 2020 2077 7720  mei  ).      ww 
+00033f10: 3d20 6e70 2e77 6865 7265 2820 706f 7765  = np.where( powe
+00033f20: 7273 5f61 7265 616c 5f6d 6e69 5f69 746b  rs_areal_mni_itk
+00033f30: 5b27 5379 7374 656d 4e61 6d65 275d 203d  ['SystemName'] =
+00033f40: 3d20 6e65 7477 6f72 6b73 5b6e 756d 6f66  = networks[numof
+00033f50: 6e65 7473 5b69 5d5d 2029 5b30 5d0a 2020  nets[i]] )[0].  
+00033f60: 2020 2020 6966 2070 6f77 6572 733a 0a20      if powers:. 
+00033f70: 2020 2020 2020 2020 2064 666e 496d 6720           dfnImg 
+00033f80: 3d20 616e 7473 2e6d 616b 655f 706f 696e  = ants.make_poin
+00033f90: 7473 5f69 6d61 6765 2870 7473 3262 6f6c  ts_image(pts2bol
+00033fa0: 642e 696c 6f63 5b77 772c 3a33 5d2e 7661  d.iloc[ww,:3].va
+00033fb0: 6c75 6573 2c20 626d 6173 6b2c 2072 6164  lues, bmask, rad
+00033fc0: 6975 733d 3129 2e74 6872 6573 686f 6c64  ius=1).threshold
+00033fd0: 5f69 6d61 6765 2820 312c 2031 6539 2029  _image( 1, 1e9 )
+00033fe0: 0a20 2020 2020 2065 6c73 653a 0a20 2020  .      else:.   
+00033ff0: 2020 2020 2020 2064 666e 496d 6720 3d20         dfnImg = 
+00034000: 616e 7473 2e6d 6173 6b5f 696d 6167 6528  ants.mask_image(
+00034010: 2070 7449 6d67 2c20 7074 496d 672c 206c   ptImg, ptImg, l
+00034020: 6576 656c 3d70 7473 3262 6f6c 645b 2752  evel=pts2bold['R
+00034030: 4f49 275d 5b70 7473 3262 6f6c 645b 2753  OI'][pts2bold['S
+00034040: 7973 7465 6d4e 616d 6527 5d3d 3d6e 6574  ystemName']==net
+00034050: 776f 726b 735b 6e75 6d6f 666e 6574 735b  works[numofnets[
+00034060: 695d 5d5d 2c62 696e 6172 697a 653d 5472  i]]],binarize=Tr
+00034070: 7565 290a 2020 2020 2020 666f 7220 6a20  ue).      for j 
+00034080: 696e 2072 616e 6765 2820 6c65 6e28 206e  in range( len( n
+00034090: 756d 6f66 6e65 7473 2029 2029 3a0a 2020  umofnets ) ):.  
+000340a0: 2020 2020 2020 2020 6e65 746e 616d 656a          netnamej
+000340b0: 203d 2072 652e 7375 6228 2022 2022 2c20   = re.sub( " ", 
+000340c0: 2222 2c20 6e65 7477 6f72 6b73 5b6e 756d  "", networks[num
+000340d0: 6f66 6e65 7473 5b6a 5d5d 2029 0a20 2020  ofnets[j]] ).   
+000340e0: 2020 2020 2020 206e 6574 6e61 6d65 6a20         netnamej 
+000340f0: 3d20 7265 2e73 7562 2820 222d 222c 2022  = re.sub( "-", "
+00034100: 222c 206e 6574 6e61 6d65 6a20 290a 2020  ", netnamej ).  
+00034110: 2020 2020 2020 2020 6e65 776e 616d 6573          newnames
+00034120: 5f77 6964 652e 6170 7065 6e64 2820 6e65  _wide.append( ne
+00034130: 746e 616d 6569 202b 2022 5f32 5f22 202b  tnamei + "_2_" +
+00034140: 206e 6574 6e61 6d65 6a20 290a 2020 2020   netnamej ).    
+00034150: 2020 2020 2020 415b 692c 6a5d 203d 2030        A[i,j] = 0
+00034160: 0a20 2020 2020 2020 2020 2069 6620 6466  .          if df
+00034170: 6e49 6d67 2069 7320 6e6f 7420 4e6f 6e65  nImg is not None
+00034180: 2061 6e64 206e 6574 6e61 6d65 6a20 6973   and netnamej is
+00034190: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+000341a0: 2020 2020 2020 2073 7562 6269 7420 3d20         subbit = 
+000341b0: 6466 6e49 6d67 203d 3d20 310a 2020 2020  dfnImg == 1.    
+000341c0: 2020 2020 2020 2020 6966 2073 7562 6269          if subbi
+000341d0: 7420 6973 206e 6f74 204e 6f6e 653a 0a20  t is not None:. 
+000341e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000341f0: 6620 7375 6262 6974 2e73 756d 2829 203e  f subbit.sum() >
+00034200: 2030 2061 6e64 206e 6574 6e61 6d65 6a20   0 and netnamej 
+00034210: 696e 206f 7574 6469 6374 3a0a 2020 2020  in outdict:.    
+00034220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034230: 415b 692c 6a5d 203d 206f 7574 6469 6374  A[i,j] = outdict
+00034240: 5b20 6e65 746e 616d 656a 205d 5b20 7375  [ netnamej ][ su
+00034250: 6262 6974 205d 2e6d 6561 6e28 290a 2020  bbit ].mean().  
+00034260: 2020 2020 2020 2020 415f 7769 6465 5b30          A_wide[0
+00034270: 2c63 745d 203d 2041 5b69 2c6a 5d0a 2020  ,ct] = A[i,j].  
+00034280: 2020 2020 2020 2020 6374 3d63 742b 310a          ct=ct+1.
+00034290: 0a20 2041 203d 2070 642e 4461 7461 4672  .  A = pd.DataFr
+000342a0: 616d 6528 2041 2029 0a20 2041 2e63 6f6c  ame( A ).  A.col
+000342b0: 756d 6e73 203d 206e 6577 6e61 6d65 730a  umns = newnames.
+000342c0: 2020 415b 276e 6574 776f 726b 7327 5d3d    A['networks']=
+000342d0: 6e65 776e 616d 6573 0a20 2041 5f77 6964  newnames.  A_wid
+000342e0: 6520 3d20 7064 2e44 6174 6146 7261 6d65  e = pd.DataFrame
+000342f0: 2820 415f 7769 6465 2029 0a20 2041 5f77  ( A_wide ).  A_w
+00034300: 6964 652e 636f 6c75 6d6e 7320 3d20 6e65  ide.columns = ne
+00034310: 776e 616d 6573 5f77 6964 650a 2020 6f75  wnames_wide.  ou
+00034320: 7464 6963 745b 2763 6f72 7227 5d20 3d20  tdict['corr'] = 
+00034330: 410a 2020 6f75 7464 6963 745b 2763 6f72  A.  outdict['cor
+00034340: 725f 7769 6465 275d 203d 2041 5f77 6964  r_wide'] = A_wid
+00034350: 650a 2020 6f75 7464 6963 745b 2766 6d72  e.  outdict['fmr
+00034360: 695f 7465 6d70 6c61 7465 275d 203d 2066  i_template'] = f
+00034370: 6d72 695f 7465 6d70 6c61 7465 0a20 206f  mri_template.  o
+00034380: 7574 6469 6374 5b27 6272 6169 6e6d 6173  utdict['brainmas
+00034390: 6b27 5d20 3d20 626d 6173 6b0a 2020 6f75  k'] = bmask.  ou
+000343a0: 7464 6963 745b 2767 6d6d 6173 6b27 5d20  tdict['gmmask'] 
+000343b0: 3d20 676d 7365 670a 2020 6f75 7464 6963  = gmseg.  outdic
+000343c0: 745b 2761 6c66 6627 5d20 3d20 6d79 6661  t['alff'] = myfa
+000343d0: 6c66 665b 2761 6c66 6627 5d0a 2020 6f75  lff['alff'].  ou
+000343e0: 7464 6963 745b 2766 616c 6666 275d 203d  tdict['falff'] =
+000343f0: 206d 7966 616c 6666 5b27 6661 6c66 6627   myfalff['falff'
+00034400: 5d0a 2020 2320 6164 6420 676c 6f62 616c  ].  # add global
+00034410: 206d 6561 6e20 616e 6420 7374 616e 6461   mean and standa
+00034420: 7264 2064 6576 6961 7469 6f6e 2066 6f72  rd deviation for
+00034430: 2070 6f73 742d 686f 6320 7a2d 7363 6f72   post-hoc z-scor
+00034440: 696e 670a 2020 6f75 7464 6963 745b 2761  ing.  outdict['a
+00034450: 6c66 665f 6d65 616e 275d 203d 2028 6d79  lff_mean'] = (my
+00034460: 6661 6c66 665b 2761 6c66 6627 5d5b 6d79  falff['alff'][my
+00034470: 6661 6c66 665b 2761 6c66 6627 5d21 3d30  falff['alff']!=0
+00034480: 5d29 2e6d 6561 6e28 290a 2020 6f75 7464  ]).mean().  outd
+00034490: 6963 745b 2761 6c66 665f 7364 275d 203d  ict['alff_sd'] =
+000344a0: 2028 6d79 6661 6c66 665b 2761 6c66 6627   (myfalff['alff'
+000344b0: 5d5b 6d79 6661 6c66 665b 2761 6c66 6627  ][myfalff['alff'
+000344c0: 5d21 3d30 5d29 2e73 7464 2829 0a20 206f  ]!=0]).std().  o
+000344d0: 7574 6469 6374 5b27 6661 6c66 665f 6d65  utdict['falff_me
+000344e0: 616e 275d 203d 2028 6d79 6661 6c66 665b  an'] = (myfalff[
+000344f0: 2766 616c 6666 275d 5b6d 7966 616c 6666  'falff'][myfalff
+00034500: 5b27 6661 6c66 6627 5d21 3d30 5d29 2e6d  ['falff']!=0]).m
+00034510: 6561 6e28 290a 2020 6f75 7464 6963 745b  ean().  outdict[
+00034520: 2766 616c 6666 5f73 6427 5d20 3d20 286d  'falff_sd'] = (m
+00034530: 7966 616c 6666 5b27 6661 6c66 6627 5d5b  yfalff['falff'][
+00034540: 6d79 6661 6c66 665b 2766 616c 6666 275d  myfalff['falff']
+00034550: 213d 305d 292e 7374 6428 290a 0a20 2070  !=0]).std()..  p
+00034560: 6572 6166 696d 6720 3d20 5065 7241 4628  erafimg = PerAF(
+00034570: 2073 696d 6769 6d70 2c20 626d 6173 6b20   simgimp, bmask 
+00034580: 290a 2020 666f 7220 6b20 696e 2070 6f69  ).  for k in poi
+00034590: 6e74 7261 6e67 653a 0a20 2020 2061 6e61  ntrange:.    ana
+000345a0: 746e 616d 653d 2820 7074 7332 626f 6c64  tname=( pts2bold
+000345b0: 5b27 4141 4c27 5d5b 6b5d 2029 0a20 2020  ['AAL'][k] ).   
+000345c0: 2069 6620 6973 696e 7374 616e 6365 2861   if isinstance(a
+000345d0: 6e61 746e 616d 652c 2073 7472 293a 0a20  natname, str):. 
+000345e0: 2020 2020 2020 2061 6e61 746e 616d 6520         anatname 
+000345f0: 3d20 7265 2e73 7562 2822 5f22 2c22 222c  = re.sub("_","",
+00034600: 616e 6174 6e61 6d65 290a 2020 2020 656c  anatname).    el
+00034610: 7365 3a0a 2020 2020 2020 2020 616e 6174  se:.        anat
+00034620: 6e61 6d65 3d27 556e 6b27 0a20 2020 2069  name='Unk'.    i
+00034630: 6620 706f 7765 7273 3a0a 2020 2020 2020  f powers:.      
+00034640: 2020 6b6b 203d 2066 227b 6b3a 303e 337d    kk = f"{k:0>3}
+00034650: 222b 225f 220a 2020 2020 656c 7365 3a0a  "+"_".    else:.
+00034660: 2020 2020 2020 2020 6b6b 203d 2066 227b          kk = f"{
+00034670: 6b20 2520 696e 7428 6e50 6f69 6e74 732f  k % int(nPoints/
+00034680: 3229 3a30 3e33 7d22 2b22 5f22 0a20 2020  2):0>3}"+"_".   
+00034690: 2066 6e61 6d65 3d27 6661 6c66 6650 6f69   fname='falffPoi
+000346a0: 6e74 272b 6b6b 2b61 6e61 746e 616d 650a  nt'+kk+anatname.
+000346b0: 2020 2020 616e 616d 653d 2761 6c66 6650      aname='alffP
+000346c0: 6f69 6e74 272b 6b6b 2b61 6e61 746e 616d  oint'+kk+anatnam
+000346d0: 650a 2020 2020 706e 616d 653d 2770 6572  e.    pname='per
+000346e0: 6166 506f 696e 7427 2b6b 6b2b 616e 6174  afPoint'+kk+anat
+000346f0: 6e61 6d65 0a20 2020 206c 6f63 616c 7365  name.    localse
+00034700: 6c20 3d20 7074 496d 6720 3d3d 206b 0a20  l = ptImg == k. 
+00034710: 2020 2069 6620 6c6f 6361 6c73 656c 2e73     if localsel.s
+00034720: 756d 2829 203e 2030 203a 2023 2063 6865  um() > 0 : # che
+00034730: 636b 2069 6620 6e6f 6e2d 656d 7074 790a  ck if non-empty.
+00034740: 2020 2020 2020 2020 6f75 7464 6963 745b          outdict[
+00034750: 666e 616d 655d 3d28 6f75 7464 6963 745b  fname]=(outdict[
+00034760: 2766 616c 6666 275d 5b6c 6f63 616c 7365  'falff'][localse
+00034770: 6c5d 292e 6d65 616e 2829 0a20 2020 2020  l]).mean().     
+00034780: 2020 206f 7574 6469 6374 5b61 6e61 6d65     outdict[aname
+00034790: 5d3d 286f 7574 6469 6374 5b27 616c 6666  ]=(outdict['alff
+000347a0: 275d 5b6c 6f63 616c 7365 6c5d 292e 6d65  '][localsel]).me
+000347b0: 616e 2829 0a20 2020 2020 2020 206f 7574  an().        out
+000347c0: 6469 6374 5b70 6e61 6d65 5d3d 2870 6572  dict[pname]=(per
+000347d0: 6166 696d 675b 6c6f 6361 6c73 656c 5d29  afimg[localsel])
+000347e0: 2e6d 6561 6e28 290a 2020 2020 656c 7365  .mean().    else
+000347f0: 3a0a 2020 2020 2020 2020 6f75 7464 6963  :.        outdic
+00034800: 745b 666e 616d 655d 3d6d 6174 682e 6e61  t[fname]=math.na
+00034810: 6e0a 2020 2020 2020 2020 6f75 7464 6963  n.        outdic
+00034820: 745b 616e 616d 655d 3d6d 6174 682e 6e61  t[aname]=math.na
+00034830: 6e0a 2020 2020 2020 2020 6f75 7464 6963  n.        outdic
+00034840: 745b 706e 616d 655d 3d6d 6174 682e 6e61  t[pname]=math.na
+00034850: 6e0a 0a20 2072 7366 4e75 6973 616e 6365  n..  rsfNuisance
+00034860: 203d 2070 642e 4461 7461 4672 616d 6528   = pd.DataFrame(
+00034870: 206e 7569 7361 6e63 6520 290a 2020 6966   nuisance ).  if
+00034880: 2072 656d 6f76 655f 6974 3a0a 2020 2020   remove_it:.    
+00034890: 696d 706f 7274 2073 6875 7469 6c0a 2020  import shutil.  
+000348a0: 2020 7368 7574 696c 2e72 6d74 7265 6528    shutil.rmtree(
+000348b0: 6f75 7470 7574 5f64 6972 6563 746f 7279  output_directory
+000348c0: 2c20 6967 6e6f 7265 5f65 7272 6f72 733d  , ignore_errors=
+000348d0: 5472 7565 2029 0a0a 2020 6966 206e 6f74  True )..  if not
+000348e0: 2070 6f77 6572 733a 0a20 2020 2064 666e   powers:.    dfn
+000348f0: 7375 6d3d 6f75 7464 6963 745b 2744 6566  sum=outdict['Def
+00034900: 6175 6c74 4127 5d2b 6f75 7464 6963 745b  aultA']+outdict[
+00034910: 2744 6566 6175 6c74 4227 5d2b 6f75 7464  'DefaultB']+outd
+00034920: 6963 745b 2744 6566 6175 6c74 4327 5d0a  ict['DefaultC'].
+00034930: 2020 2020 6f75 7464 6963 745b 2744 6566      outdict['Def
+00034940: 6175 6c74 4d6f 6465 275d 3d64 666e 7375  aultMode']=dfnsu
+00034950: 6d0a 2020 2020 6466 6e73 756d 3d6f 7574  m.    dfnsum=out
+00034960: 6469 6374 5b27 5669 7343 656e 7427 5d2b  dict['VisCent']+
+00034970: 6f75 7464 6963 745b 2756 6973 5065 7269  outdict['VisPeri
+00034980: 275d 0a20 2020 206f 7574 6469 6374 5b27  '].    outdict['
+00034990: 5669 7375 616c 275d 3d64 666e 7375 6d0a  Visual']=dfnsum.
+000349a0: 0a20 206e 6f6e 6272 6169 6e6d 6173 6b20  .  nonbrainmask 
+000349b0: 3d20 616e 7473 2e69 4d61 7468 2820 626d  = ants.iMath( bm
+000349c0: 6173 6b2c 2022 4d44 222c 3229 202d 2062  ask, "MD",2) - b
+000349d0: 6d61 736b 0a20 2074 7269 6d6d 6173 6b20  mask.  trimmask 
+000349e0: 3d20 616e 7473 2e69 4d61 7468 2820 626d  = ants.iMath( bm
+000349f0: 6173 6b2c 2022 4d45 222c 3229 0a20 2065  ask, "ME",2).  e
+00034a00: 6467 656d 6173 6b20 3d20 616e 7473 2e69  dgemask = ants.i
+00034a10: 4d61 7468 2820 626d 6173 6b2c 2022 4d45  Math( bmask, "ME
+00034a20: 222c 3129 202d 2074 7269 6d6d 6173 6b0a  ",1) - trimmask.
+00034a30: 2020 6f75 7464 6963 745b 276d 6f74 696f    outdict['motio
+00034a40: 6e5f 636f 7272 6563 7465 6427 5d20 3d20  n_corrected'] = 
+00034a50: 636f 7272 6d6f 5b27 6d6f 7469 6f6e 5f63  corrmo['motion_c
+00034a60: 6f72 7265 6374 6564 275d 0a20 206f 7574  orrected'].  out
+00034a70: 6469 6374 5b27 6e75 6973 616e 6365 275d  dict['nuisance']
+00034a80: 203d 2072 7366 4e75 6973 616e 6365 0a20   = rsfNuisance. 
+00034a90: 206f 7574 6469 6374 5b27 5065 7241 4627   outdict['PerAF'
+00034aa0: 5d20 3d20 7065 7261 6669 6d67 0a20 206f  ] = perafimg.  o
+00034ab0: 7574 6469 6374 5b27 7473 6e72 275d 203d  utdict['tsnr'] =
+00034ac0: 206d 7974 736e 720a 2020 6f75 7464 6963   mytsnr.  outdic
+00034ad0: 745b 2773 736e 7227 5d20 3d20 736c 6963  t['ssnr'] = slic
+00034ae0: 655f 736e 7228 2063 6f72 726d 6f5b 276d  e_snr( corrmo['m
+00034af0: 6f74 696f 6e5f 636f 7272 6563 7465 6427  otion_corrected'
+00034b00: 5d2c 2063 7366 416e 6457 4d2c 2067 6d73  ], csfAndWM, gms
+00034b10: 6567 2029 0a20 206f 7574 6469 6374 5b27  eg ).  outdict['
+00034b20: 6476 6172 7327 5d20 3d20 6476 6172 7328  dvars'] = dvars(
+00034b30: 2063 6f72 726d 6f5b 276d 6f74 696f 6e5f   corrmo['motion_
+00034b40: 636f 7272 6563 7465 6427 5d2c 2067 6d73  corrected'], gms
+00034b50: 6567 2029 0a20 206f 7574 6469 6374 5b27  eg ).  outdict['
+00034b60: 6261 6e64 7061 7373 5f66 7265 715f 3027  bandpass_freq_0'
+00034b70: 5d3d 665b 305d 0a20 206f 7574 6469 6374  ]=f[0].  outdict
+00034b80: 5b27 6261 6e64 7061 7373 5f66 7265 715f  ['bandpass_freq_
+00034b90: 3127 5d3d 665b 315d 0a20 206f 7574 6469  1']=f[1].  outdi
+00034ba0: 6374 5b27 6365 6e73 6f72 275d 3d69 6e74  ct['censor']=int
+00034bb0: 2863 656e 736f 7229 0a20 206f 7574 6469  (censor).  outdi
+00034bc0: 6374 5b27 7370 6174 6961 6c5f 736d 6f6f  ct['spatial_smoo
+00034bd0: 7468 696e 6727 5d3d 7370 610a 2020 6f75  thing']=spa.  ou
+00034be0: 7464 6963 745b 276f 7574 6c69 6572 5f74  tdict['outlier_t
+00034bf0: 6872 6573 686f 6c64 275d 3d6f 7574 6c69  hreshold']=outli
+00034c00: 6572 5f74 6872 6573 686f 6c64 0a20 206f  er_threshold.  o
+00034c10: 7574 6469 6374 5b27 4644 5f74 6872 6573  utdict['FD_thres
+00034c20: 686f 6c64 275d 3d6f 7574 6c69 6572 5f74  hold']=outlier_t
+00034c30: 6872 6573 686f 6c64 0a20 206f 7574 6469  hreshold.  outdi
+00034c40: 6374 5b27 6869 6768 5f6d 6f74 696f 6e5f  ct['high_motion_
+00034c50: 636f 756e 7427 5d20 3d20 6869 6768 5f6d  count'] = high_m
+00034c60: 6f74 696f 6e5f 636f 756e 740a 2020 6f75  otion_count.  ou
+00034c70: 7464 6963 745b 2768 6967 685f 6d6f 7469  tdict['high_moti
+00034c80: 6f6e 5f70 6374 275d 203d 2068 6967 685f  on_pct'] = high_
+00034c90: 6d6f 7469 6f6e 5f70 6374 0a20 206f 7574  motion_pct.  out
+00034ca0: 6469 6374 5b27 6465 7370 696b 696e 675f  dict['despiking_
+00034cb0: 636f 756e 745f 7375 6d6d 6172 7927 5d20  count_summary'] 
+00034cc0: 3d20 6465 7370 696b 696e 675f 636f 756e  = despiking_coun
+00034cd0: 745f 7375 6d6d 6172 790a 2020 6f75 7464  t_summary.  outd
+00034ce0: 6963 745b 2746 445f 6d61 7827 5d20 3d20  ict['FD_max'] = 
+00034cf0: 636f 7272 6d6f 5b27 4644 275d 2e6d 6178  corrmo['FD'].max
+00034d00: 2829 0a20 206f 7574 6469 6374 5b27 4644  ().  outdict['FD
+00034d10: 5f6d 6561 6e27 5d20 3d20 636f 7272 6d6f  _mean'] = corrmo
+00034d20: 5b27 4644 275d 2e6d 6561 6e28 290a 2020  ['FD'].mean().  
+00034d30: 6f75 7464 6963 745b 2746 445f 7364 275d  outdict['FD_sd']
+00034d40: 203d 2063 6f72 726d 6f5b 2746 4427 5d2e   = corrmo['FD'].
+00034d50: 7374 6428 290a 2020 6f75 7464 6963 745b  std().  outdict[
+00034d60: 2762 6f6c 645f 6576 7227 5d20 3d20 2061  'bold_evr'] =  a
+00034d70: 6e74 7370 7974 3177 2e70 6174 6368 5f65  ntspyt1w.patch_e
+00034d80: 6967 656e 7661 6c75 655f 7261 7469 6f28  igenvalue_ratio(
+00034d90: 2075 6e64 2c20 3531 322c 205b 3136 2c31   und, 512, [16,1
+00034da0: 362c 3136 5d2c 2065 7664 6570 7468 203d  6,16], evdepth =
+00034db0: 2030 2e39 2c20 6d61 736b 203d 2062 6d61   0.9, mask = bma
+00034dc0: 736b 2029 0a20 206f 7574 6469 6374 5b27  sk ).  outdict['
+00034dd0: 6e5f 6f75 746c 6965 7273 275d 203d 206c  n_outliers'] = l
+00034de0: 656e 2868 6c69 6e64 7329 0a20 206f 7574  en(hlinds).  out
+00034df0: 6469 6374 5b27 6e63 5f77 6d27 5d20 3d20  dict['nc_wm'] = 
+00034e00: 696e 7428 6e63 5f77 6d29 0a20 206f 7574  int(nc_wm).  out
+00034e10: 6469 6374 5b27 6e63 5f63 7366 275d 203d  dict['nc_csf'] =
+00034e20: 2069 6e74 286e 635f 6373 6629 0a20 206f   int(nc_csf).  o
+00034e30: 7574 6469 6374 5b27 6d69 6e75 7465 735f  utdict['minutes_
+00034e40: 6f72 6967 696e 616c 5f64 6174 6127 5d20  original_data'] 
+00034e50: 3d20 2820 7472 202a 2066 6d72 692e 7368  = ( tr * fmri.sh
+00034e60: 6170 655b 335d 2029 202f 2036 302e 3020  ape[3] ) / 60.0 
+00034e70: 2320 6d69 6e75 7465 7320 6f66 2075 7365  # minutes of use
+00034e80: 6675 6c20 6461 7461 0a20 206f 7574 6469  ful data.  outdi
+00034e90: 6374 5b27 6d69 6e75 7465 735f 6365 6e73  ct['minutes_cens
+00034ea0: 6f72 6564 5f64 6174 6127 5d20 3d20 2820  ored_data'] = ( 
+00034eb0: 7472 202a 2073 696d 672e 7368 6170 655b  tr * simg.shape[
+00034ec0: 335d 2029 202f 2036 302e 3020 2320 6d69  3] ) / 60.0 # mi
+00034ed0: 6e75 7465 7320 6f66 2075 7365 6675 6c20  nutes of useful 
+00034ee0: 6461 7461 0a20 2072 6574 7572 6e20 636f  data.  return co
+00034ef0: 6e76 6572 745f 6e70 5f69 6e5f 6469 6374  nvert_np_in_dict
+00034f00: 2820 6f75 7464 6963 7420 290a 0a0a 6465  ( outdict )...de
+00034f10: 6620 6361 6c63 756c 6174 655f 4342 4628  f calculate_CBF(
+00034f20: 4465 6c74 615f 4d2c 204d 5f30 2c20 6d61  Delta_M, M_0, ma
+00034f30: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
+00034f40: 2020 2020 2020 4c61 6d62 6461 3d30 2e39        Lambda=0.9
+00034f50: 2c20 545f 313d 302e 3637 2c20 416c 7068  , T_1=0.67, Alph
+00034f60: 613d 302e 3638 2c20 773d 312e 302c 2054  a=0.68, w=1.0, T
+00034f70: 6175 3d31 2e35 293a 0a20 2020 2022 2222  au=1.5):.    """
+00034f80: 0a20 2020 2043 616c 6375 6c61 7465 2074  .    Calculate t
+00034f90: 6865 2043 6572 6562 7261 6c20 426c 6f6f  he Cerebral Bloo
+00034fa0: 6420 466c 6f77 2028 4342 4629 2077 6865  d Flow (CBF) whe
+00034fb0: 7265 2044 656c 7461 5f4d 2061 6e64 204d  re Delta_M and M
+00034fc0: 5f30 2061 7265 2061 6e74 7349 6d61 6765  _0 are antsImage
+00034fd0: 7320 0a20 2020 2061 6e64 2074 6865 206f  s .    and the o
+00034fe0: 7468 6572 2076 6172 6961 626c 6573 2061  ther variables a
+00034ff0: 7265 2073 6361 6c61 7273 2e20 2047 7565  re scalars.  Gue
+00035000: 7373 6573 2061 7420 6465 6661 756c 7420  sses at default 
+00035010: 7661 6c75 6573 2061 7265 2075 7365 6420  values are used 
+00035020: 6865 7265 2e20 0a20 2020 2057 6520 7573  here. .    We us
+00035030: 6520 7468 6520 7043 4153 4c20 6571 7561  e the pCASL equa
+00035040: 7469 6f6e 2e20 204e 4f54 2059 4554 2054  tion.  NOT YET T
+00035050: 4553 5445 442e 0a0a 2020 2020 5061 7261  ESTED...    Para
+00035060: 6d65 7465 7273 3a0a 2020 2020 4465 6c74  meters:.    Delt
+00035070: 615f 4d20 2861 6e74 7349 6d61 6765 293a  a_M (antsImage):
+00035080: 2043 6861 6e67 6520 696e 206d 6167 6e65   Change in magne
+00035090: 7469 7a61 7469 6f6e 2028 6d61 7472 6978  tization (matrix
+000350a0: 290a 2020 2020 4d5f 3020 2861 6e74 7349  ).    M_0 (antsI
+000350b0: 6d61 6765 293a 2049 6e69 7469 616c 206d  mage): Initial m
+000350c0: 6167 6e65 7469 7a61 7469 6f6e 2028 6d61  agnetization (ma
+000350d0: 7472 6978 290a 2020 2020 6d61 736b 2028  trix).    mask (
+000350e0: 2061 6e74 7349 6d61 6765 2029 3a20 7768   antsImage ): wh
+000350f0: 6572 6520 746f 2064 6f20 7468 6520 6361  ere to do the ca
+00035100: 6c63 756c 6174 696f 6e0a 2020 2020 4c61  lculation.    La
+00035110: 6d62 6461 2028 666c 6f61 7429 3a20 5363  mbda (float): Sc
+00035120: 616c 6172 0a20 2020 2054 5f31 2028 666c  alar.    T_1 (fl
+00035130: 6f61 7429 3a20 5363 616c 6172 2072 6570  oat): Scalar rep
+00035140: 7265 7365 6e74 696e 6720 7265 6c61 7861  resenting relaxa
+00035150: 7469 6f6e 2074 696d 650a 2020 2020 416c  tion time.    Al
+00035160: 7068 6120 2866 6c6f 6174 293a 2053 6361  pha (float): Sca
+00035170: 6c61 7220 7265 7072 6573 656e 7469 6e67  lar representing
+00035180: 2066 6c69 7020 616e 676c 650a 2020 2020   flip angle.    
+00035190: 7720 2866 6c6f 6174 293a 2053 6361 6c61  w (float): Scala
+000351a0: 720a 2020 2020 5461 7520 2866 6c6f 6174  r.    Tau (float
+000351b0: 293a 2053 6361 6c61 720a 0a20 2020 2052  ): Scalar..    R
+000351c0: 6574 7572 6e73 3a0a 2020 2020 6e70 2e6e  eturns:.    np.n
+000351d0: 6461 7272 6179 3a20 4342 4620 7661 6c75  darray: CBF valu
+000351e0: 6573 2028 6d61 7472 6978 290a 2020 2020  es (matrix).    
+000351f0: 2222 220a 2020 2020 6362 6620 3d20 4d5f  """.    cbf = M_
+00035200: 3020 2a20 302e 300a 2020 2020 6d30 7468  0 * 0.0.    m0th
+00035210: 7265 7368 203d 206e 702e 7175 616e 7469  resh = np.quanti
+00035220: 6c65 2820 4d5f 305b 6d61 736b 3d3d 315d  le( M_0[mask==1]
+00035230: 2c20 302e 3120 290a 2020 2020 7365 6c20  , 0.1 ).    sel 
+00035240: 3d20 6d61 736b 203d 3d20 3120 616e 6420  = mask == 1 and 
+00035250: 4d5f 3020 3e20 6d30 7468 7265 7368 0a20  M_0 > m0thresh. 
+00035260: 2020 2063 6266 5b20 7365 6c20 5d20 3d20     cbf[ sel ] = 
+00035270: 4465 6c74 615f 4d5b 2073 656c 205d 202a  Delta_M[ sel ] *
+00035280: 2036 302e 202a 2031 3030 2e20 2a20 284c   60. * 100. * (L
+00035290: 616d 6264 6120 2a20 545f 3129 2f28 204d  ambda * T_1)/( M
+000352a0: 5f30 5b73 656c 5d20 2a20 322e 3020 2a20  _0[sel] * 2.0 * 
+000352b0: 416c 7068 6120 2a20 0a20 2020 2020 2020  Alpha * .       
+000352c0: 2028 6e70 2e65 7870 2820 2d77 202a 2054   (np.exp( -w * T
+000352d0: 5f31 2920 2d20 6e70 2e65 7870 282d 2854  _1) - np.exp(-(T
+000352e0: 6175 202b 2077 2920 2a20 545f 3129 2929  au + w) * T_1)))
+000352f0: 0a20 2020 2063 6266 5b20 6362 6620 3c20  .    cbf[ cbf < 
+00035300: 302e 305d 3d30 2e30 0a20 2020 2072 6574  0.0]=0.0.    ret
+00035310: 7572 6e20 6362 660a 0a64 6566 2064 6573  urn cbf..def des
+00035320: 7069 6b65 5f74 696d 655f 7365 7269 6573  pike_time_series
+00035330: 5f61 666e 6928 696d 6167 652c 2063 313d  _afni(image, c1=
+00035340: 322e 352c 2063 323d 3429 3a0a 2020 2020  2.5, c2=4):.    
+00035350: 2222 220a 2020 2020 4465 7370 696b 6520  """.    Despike 
+00035360: 6120 7469 6d65 2073 6572 6965 7320 696d  a time series im
+00035370: 6167 6520 7573 696e 6720 4c31 2070 6f6c  age using L1 pol
+00035380: 796e 6f6d 6961 6c20 6669 7474 696e 6720  ynomial fitting 
+00035390: 616e 6420 6e6f 6e6c 696e 6561 7220 6669  and nonlinear fi
+000353a0: 6c74 6572 696e 672e 0a20 2020 2042 6173  ltering..    Bas
+000353b0: 6564 206f 6e20 6166 6e69 2033 6444 6573  ed on afni 3dDes
+000353c0: 7069 6b65 0a0a 2020 2020 3a70 6172 616d  pike..    :param
+000353d0: 2069 6d61 6765 3a20 414e 5473 5079 2069   image: ANTsPy i
+000353e0: 6d61 6765 206f 626a 6563 7420 636f 6e74  mage object cont
+000353f0: 6169 6e69 6e67 2074 696d 6520 7365 7269  aining time seri
+00035400: 6573 2064 6174 612e 0a20 2020 203a 7061  es data..    :pa
+00035410: 7261 6d20 6331 3a20 5370 696b 6520 7468  ram c1: Spike th
+00035420: 7265 7368 6f6c 6420 7661 6c75 652e 2044  reshold value. D
+00035430: 6566 6175 6c74 2069 7320 322e 352e 0a20  efault is 2.5.. 
+00035440: 2020 203a 7061 7261 6d20 6332 3a20 5570     :param c2: Up
+00035450: 7065 7220 7261 6e67 6520 6f66 2061 6c6c  per range of all
+00035460: 6f77 6564 2064 6576 6961 7469 6f6e 2e20  owed deviation. 
+00035470: 4465 6661 756c 7420 6973 2034 2e0a 2020  Default is 4..  
+00035480: 2020 3a72 6574 7572 6e3a 2044 6573 7069    :return: Despi
+00035490: 6b65 6420 414e 5473 5079 2069 6d61 6765  ked ANTsPy image
+000354a0: 206f 626a 6563 742e 0a20 2020 2022 2222   object..    """
+000354b0: 0a20 2020 2064 6174 6120 3d20 696d 6167  .    data = imag
+000354c0: 652e 6e75 6d70 7928 2920 2023 2043 6f6e  e.numpy()  # Con
+000354d0: 7665 7274 2074 6f20 6e75 6d70 7920 6172  vert to numpy ar
+000354e0: 7261 790a 2020 2020 6465 7370 696b 6564  ray.    despiked
+000354f0: 5f64 6174 6120 3d20 6e70 2e63 6f70 7928  _data = np.copy(
+00035500: 6461 7461 2920 2023 2043 7265 6174 6520  data)  # Create 
+00035510: 6120 636f 7079 2066 6f72 2064 6573 7069  a copy for despi
+00035520: 6b65 6420 6461 7461 0a20 2020 2063 7572  ked data.    cur
+00035530: 7665 203d 2064 6573 7069 6b65 645f 6461  ve = despiked_da
+00035540: 7461 202a 2030 2e30 0a0a 2020 2020 6465  ta * 0.0..    de
+00035550: 6620 6c31 5f66 6974 5f70 6f6c 796e 6f6d  f l1_fit_polynom
+00035560: 6961 6c28 7469 6d65 5f73 6572 6965 732c  ial(time_series,
+00035570: 2064 6567 7265 653d 3229 3a0a 2020 2020   degree=2):.    
+00035580: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00035590: 4669 7420 6120 706f 6c79 6e6f 6d69 616c  Fit a polynomial
+000355a0: 206f 6620 6769 7665 6e20 6465 6772 6565   of given degree
+000355b0: 2074 6f20 7468 6520 7469 6d65 2073 6572   to the time ser
+000355c0: 6965 7320 7573 696e 6720 6c65 6173 7420  ies using least 
+000355d0: 7371 7561 7265 732e 0a20 2020 2020 2020  squares..       
+000355e0: 200a 2020 2020 2020 2020 3a70 6172 616d   .        :param
+000355f0: 2074 696d 655f 7365 7269 6573 3a20 3144   time_series: 1D
+00035600: 206e 756d 7079 2061 7272 6179 206f 6620   numpy array of 
+00035610: 766f 7865 6c20 7469 6d65 2073 6572 6965  voxel time serie
+00035620: 7320 6461 7461 2e0a 2020 2020 2020 2020  s data..        
+00035630: 3a70 6172 616d 2064 6567 7265 653a 2044  :param degree: D
+00035640: 6567 7265 6520 6f66 2074 6865 2070 6f6c  egree of the pol
+00035650: 796e 6f6d 6961 6c20 746f 2066 6974 2e0a  ynomial to fit..
+00035660: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+00035670: 2046 6974 7465 6420 706f 6c79 6e6f 6d69   Fitted polynomi
+00035680: 616c 2076 616c 7565 7320 666f 7220 7468  al values for th
+00035690: 6520 7469 6d65 2073 6572 6965 732e 0a20  e time series.. 
+000356a0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000356b0: 2020 2074 203d 206e 702e 6172 616e 6765     t = np.arange
+000356c0: 286c 656e 2874 696d 655f 7365 7269 6573  (len(time_series
+000356d0: 2929 0a20 2020 2020 2020 2063 6f65 6673  )).        coefs
+000356e0: 203d 206e 702e 706f 6c79 6669 7428 742c   = np.polyfit(t,
+000356f0: 2074 696d 655f 7365 7269 6573 2c20 6465   time_series, de
+00035700: 6772 6565 290a 2020 2020 2020 2020 706f  gree).        po
+00035710: 6c79 6e6f 6d69 616c 203d 206e 702e 706f  lynomial = np.po
+00035720: 6c79 7661 6c28 636f 6566 732c 2074 290a  lyval(coefs, t).
+00035730: 2020 2020 2020 2020 7265 7475 726e 2070          return p
+00035740: 6f6c 796e 6f6d 6961 6c0a 0a20 2020 2023  olynomial..    #
+00035750: 204c 3120 6669 7420 6120 736d 6f6f 7468   L1 fit a smooth
+00035760: 2d69 7368 2063 7572 7665 2074 6f20 6561  -ish curve to ea
+00035770: 6368 2076 6f78 656c 2074 696d 6520 7365  ch voxel time se
+00035780: 7269 6573 0a20 2020 2023 2043 7572 7665  ries.    # Curve
+00035790: 2066 6974 7469 6e67 2066 6f72 2065 6163   fitting for eac
+000357a0: 6820 766f 7865 6c0a 2020 2020 666f 7220  h voxel.    for 
+000357b0: 7820 696e 2072 616e 6765 2864 6174 612e  x in range(data.
+000357c0: 7368 6170 655b 305d 293a 0a20 2020 2020  shape[0]):.     
+000357d0: 2020 2066 6f72 2079 2069 6e20 7261 6e67     for y in rang
+000357e0: 6528 6461 7461 2e73 6861 7065 5b31 5d29  e(data.shape[1])
+000357f0: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
+00035800: 7220 7a20 696e 2072 616e 6765 2864 6174  r z in range(dat
+00035810: 612e 7368 6170 655b 325d 293a 0a20 2020  a.shape[2]):.   
+00035820: 2020 2020 2020 2020 2020 2020 2076 6f78               vox
+00035830: 656c 5f74 696d 655f 7365 7269 6573 203d  el_time_series =
+00035840: 2064 6174 615b 782c 2079 2c20 7a2c 203a   data[x, y, z, :
+00035850: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00035860: 2020 6375 7276 655b 782c 2079 2c20 7a2c    curve[x, y, z,
+00035870: 203a 5d20 3d20 6c31 5f66 6974 5f70 6f6c   :] = l1_fit_pol
+00035880: 796e 6f6d 6961 6c28 766f 7865 6c5f 7469  ynomial(voxel_ti
+00035890: 6d65 5f73 6572 6965 732c 2064 6567 7265  me_series, degre
+000358a0: 653d 3229 0a0a 2020 2020 2320 436f 6d70  e=2)..    # Comp
+000358b0: 7574 6520 7468 6520 4d41 4420 6f66 2074  ute the MAD of t
+000358c0: 6865 2072 6573 6964 7561 6c73 0a20 2020  he residuals.   
+000358d0: 2072 6573 6964 7561 6c73 203d 2064 6174   residuals = dat
+000358e0: 6120 2d20 6375 7276 650a 2020 2020 6d61  a - curve.    ma
+000358f0: 6420 3d20 6e70 2e6d 6564 6961 6e28 6e70  d = np.median(np
+00035900: 2e61 6273 2872 6573 6964 7561 6c73 202d  .abs(residuals -
+00035910: 206e 702e 6d65 6469 616e 2872 6573 6964   np.median(resid
+00035920: 7561 6c73 2c20 6178 6973 3d2d 312c 206b  uals, axis=-1, k
+00035930: 6565 7064 696d 733d 5472 7565 2929 2c20  eepdims=True)), 
+00035940: 6178 6973 3d2d 312c 206b 6565 7064 696d  axis=-1, keepdim
+00035950: 733d 5472 7565 290a 2020 2020 7369 676d  s=True).    sigm
+00035960: 6120 3d20 6e70 2e73 7172 7428 6e70 2e70  a = np.sqrt(np.p
+00035970: 6920 2f20 3229 202a 206d 6164 0a20 2020  i / 2) * mad.   
+00035980: 2023 2045 6e73 7572 6520 7369 676d 6120   # Ensure sigma 
+00035990: 6973 206e 6f74 207a 6572 6f20 746f 2061  is not zero to a
+000359a0: 766f 6964 2064 6976 6973 696f 6e20 6279  void division by
+000359b0: 207a 6572 6f0a 2020 2020 7369 676d 615f   zero.    sigma_
+000359c0: 7361 6665 203d 206e 702e 7768 6572 6528  safe = np.where(
+000359d0: 7369 676d 6120 3d3d 2030 2c20 3165 2d31  sigma == 0, 1e-1
+000359e0: 302c 2073 6967 6d61 290a 0a20 2020 2023  0, sigma)..    #
+000359f0: 204f 7074 696f 6e61 6c6c 792c 2068 616e   Optionally, han
+00035a00: 646c 6520 4e61 4e20 6f72 2069 6e66 2076  dle NaN or inf v
+00035a10: 616c 7565 7320 696e 2064 6174 612c 2063  alues in data, c
+00035a20: 7572 7665 2c20 6f72 2073 6967 6d61 0a20  urve, or sigma. 
+00035a30: 2020 2064 6174 6120 3d20 6e70 2e6e 616e     data = np.nan
+00035a40: 5f74 6f5f 6e75 6d28 6461 7461 2c20 6e61  _to_num(data, na
+00035a50: 6e3d 302e 302c 2070 6f73 696e 663d 6e70  n=0.0, posinf=np
+00035a60: 2e66 696e 666f 286e 702e 666c 6f61 7436  .finfo(np.float6
+00035a70: 3429 2e6d 6178 2c20 6e65 6769 6e66 3d6e  4).max, neginf=n
+00035a80: 702e 6669 6e66 6f28 6e70 2e66 6c6f 6174  p.finfo(np.float
+00035a90: 3634 292e 6d69 6e29 0a20 2020 2063 7572  64).min).    cur
+00035aa0: 7665 203d 206e 702e 6e61 6e5f 746f 5f6e  ve = np.nan_to_n
+00035ab0: 756d 2863 7572 7665 2c20 6e61 6e3d 302e  um(curve, nan=0.
+00035ac0: 302c 2070 6f73 696e 663d 6e70 2e66 696e  0, posinf=np.fin
+00035ad0: 666f 286e 702e 666c 6f61 7436 3429 2e6d  fo(np.float64).m
+00035ae0: 6178 2c20 6e65 6769 6e66 3d6e 702e 6669  ax, neginf=np.fi
+00035af0: 6e66 6f28 6e70 2e66 6c6f 6174 3634 292e  nfo(np.float64).
+00035b00: 6d69 6e29 0a20 2020 2073 6967 6d61 5f73  min).    sigma_s
+00035b10: 6166 6520 3d20 6e70 2e6e 616e 5f74 6f5f  afe = np.nan_to_
+00035b20: 6e75 6d28 7369 676d 615f 7361 6665 2c20  num(sigma_safe, 
+00035b30: 6e61 6e3d 3165 2d31 302c 2070 6f73 696e  nan=1e-10, posin
+00035b40: 663d 6e70 2e66 696e 666f 286e 702e 666c  f=np.finfo(np.fl
+00035b50: 6f61 7436 3429 2e6d 6178 2c20 6e65 6769  oat64).max, negi
+00035b60: 6e66 3d6e 702e 6669 6e66 6f28 6e70 2e66  nf=np.finfo(np.f
+00035b70: 6c6f 6174 3634 292e 6d69 6e29 0a0a 2020  loat64).min)..  
+00035b80: 2020 2320 4465 7370 696b 6520 616c 676f    # Despike algo
+00035b90: 7269 7468 6d0a 2020 2020 7370 696b 655f  rithm.    spike_
+00035ba0: 636f 756e 7473 203d 206e 702e 7a65 726f  counts = np.zero
+00035bb0: 7328 2069 6d61 6765 2e73 6861 7065 5b33  s( image.shape[3
+00035bc0: 5d20 290a 2020 2020 666f 7220 6920 696e  ] ).    for i in
+00035bd0: 2072 616e 6765 2864 6174 612e 7368 6170   range(data.shap
+00035be0: 655b 2d31 5d29 3a0a 2020 2020 2020 2020  e[-1]):.        
+00035bf0: 7320 3d20 2864 6174 615b 2e2e 2e2c 2069  s = (data[..., i
+00035c00: 5d20 2d20 6375 7276 655b 2e2e 2e2c 2069  ] - curve[..., i
+00035c10: 5d29 202f 2073 6967 6d61 5f73 6166 655b  ]) / sigma_safe[
+00035c20: 2e2e 2e2c 2030 5d0a 2020 2020 2020 2020  ..., 0].        
+00035c30: 7777 203d 2073 203e 2063 310a 2020 2020  ww = s > c1.    
+00035c40: 2020 2020 735f 7072 696d 6520 3d20 6e70      s_prime = np
+00035c50: 2e77 6865 7265 2820 7777 2c20 6331 202b  .where( ww, c1 +
+00035c60: 2028 6332 202d 2063 3129 202a 206e 702e   (c2 - c1) * np.
+00035c70: 7461 6e68 2828 7320 2d20 6331 2920 2f20  tanh((s - c1) / 
+00035c80: 2863 3220 2d20 6331 2929 2c20 7329 0a20  (c2 - c1)), s). 
+00035c90: 2020 2020 2020 2073 7069 6b65 5f63 6f75         spike_cou
+00035ca0: 6e74 735b 695d 203d 2077 772e 7375 6d28  nts[i] = ww.sum(
+00035cb0: 290a 2020 2020 2020 2020 6465 7370 696b  ).        despik
+00035cc0: 6564 5f64 6174 615b 2e2e 2e2c 2069 5d20  ed_data[..., i] 
+00035cd0: 3d20 6375 7276 655b 2e2e 2e2c 2069 5d20  = curve[..., i] 
+00035ce0: 2b20 735f 7072 696d 6520 2a20 7369 676d  + s_prime * sigm
+00035cf0: 615b 2e2e 2e2c 2030 5d0a 0a20 2020 2023  a[..., 0]..    #
+00035d00: 2043 6f6e 7665 7274 2062 6163 6b20 746f   Convert back to
+00035d10: 2041 4e54 7350 7920 696d 6167 650a 2020   ANTsPy image.  
+00035d20: 2020 6465 7370 696b 6564 5f69 6d61 6765    despiked_image
+00035d30: 203d 2061 6e74 732e 6672 6f6d 5f6e 756d   = ants.from_num
+00035d40: 7079 2864 6573 7069 6b65 645f 6461 7461  py(despiked_data
+00035d50: 290a 2020 2020 7265 7475 726e 2061 6e74  ).    return ant
+00035d60: 732e 636f 7079 5f69 6d61 6765 5f69 6e66  s.copy_image_inf
+00035d70: 6f28 2069 6d61 6765 2c20 6465 7370 696b  o( image, despik
+00035d80: 6564 5f69 6d61 6765 2029 2c20 7370 696b  ed_image ), spik
+00035d90: 655f 636f 756e 7473 0a0a 6465 6620 6465  e_counts..def de
+00035da0: 7370 696b 655f 7469 6d65 5f73 6572 6965  spike_time_serie
+00035db0: 7328 696d 6167 652c 2074 6872 6573 686f  s(image, thresho
+00035dc0: 6c64 3d33 2e30 2c20 7265 706c 6163 656d  ld=3.0, replacem
+00035dd0: 656e 743d 2774 6872 6573 686f 6c64 2720  ent='threshold' 
+00035de0: 293a 0a20 2020 2022 2222 0a20 2020 2044  ):.    """.    D
+00035df0: 6573 7069 6b65 2061 2074 696d 6520 7365  espike a time se
+00035e00: 7269 6573 2069 6d61 6765 2e0a 2020 2020  ries image..    
+00035e10: 0a20 2020 203a 7061 7261 6d20 696d 6167  .    :param imag
+00035e20: 653a 2041 4e54 7350 7920 696d 6167 6520  e: ANTsPy image 
+00035e30: 6f62 6a65 6374 2063 6f6e 7461 696e 696e  object containin
+00035e40: 6720 7469 6d65 2073 6572 6965 7320 6461  g time series da
+00035e50: 7461 2e0a 2020 2020 3a70 6172 616d 2074  ta..    :param t
+00035e60: 6872 6573 686f 6c64 3a20 7a2d 7363 6f72  hreshold: z-scor
+00035e70: 6520 7661 6c75 6520 746f 2069 6465 6e74  e value to ident
+00035e80: 6966 7920 7370 696b 6573 2e20 4465 6661  ify spikes. Defa
+00035e90: 756c 7420 6973 2033 2e0a 2020 2020 3a70  ult is 3..    :p
+00035ea0: 6172 616d 2072 6570 6c61 6365 6d65 6e74  aram replacement
+00035eb0: 3a20 6d65 6469 616e 206f 7220 7468 7265  : median or thre
+00035ec0: 7368 6f6c 6420 2d20 7468 6520 6c61 7474  shold - the latt
+00035ed0: 6572 2069 7320 7369 6d69 6c61 7220 3344  er is similar 3D
+00035ee0: 4465 7370 696b 6520 6275 7420 7369 6d70  Despike but simp
+00035ef0: 6c65 720a 2020 2020 3a72 6574 7572 6e3a  ler.    :return:
+00035f00: 2044 6573 7069 6b65 6420 414e 5473 5079   Despiked ANTsPy
+00035f10: 2069 6d61 6765 206f 626a 6563 742e 0a20   image object.. 
+00035f20: 2020 2022 2222 0a20 2020 2023 2043 6f6e     """.    # Con
+00035f30: 7665 7274 2069 6d61 6765 2074 6f20 6e75  vert image to nu
+00035f40: 6d70 7920 6172 7261 790a 2020 2020 6461  mpy array.    da
+00035f50: 7461 203d 2069 6d61 6765 2e6e 756d 7079  ta = image.numpy
+00035f60: 2829 0a20 2020 200a 2020 2020 2320 4361  ().    .    # Ca
+00035f70: 6c63 756c 6174 6520 7468 6520 6d65 616e  lculate the mean
+00035f80: 2061 6e64 2073 7461 6e64 6172 6420 6465   and standard de
+00035f90: 7669 6174 696f 6e20 616c 6f6e 6720 7468  viation along th
+00035fa0: 6520 7469 6d65 2061 7869 730a 2020 2020  e time axis.    
+00035fb0: 6d65 616e 203d 206e 702e 6d65 616e 2864  mean = np.mean(d
+00035fc0: 6174 612c 2061 7869 733d 2d31 290a 2020  ata, axis=-1).  
+00035fd0: 2020 7374 6420 3d20 6e70 2e73 7464 2864    std = np.std(d
+00035fe0: 6174 612c 2061 7869 733d 2d31 290a 0a20  ata, axis=-1).. 
+00035ff0: 2020 2023 2049 6465 6e74 6966 7920 7370     # Identify sp
+00036000: 696b 6573 3a20 706f 696e 7473 2077 6865  ikes: points whe
+00036010: 7265 2074 6865 2064 6576 6961 7469 6f6e  re the deviation
+00036020: 2066 726f 6d20 7468 6520 6d65 616e 2065   from the mean e
+00036030: 7863 6565 6473 2074 6865 2074 6872 6573  xceeds the thres
+00036040: 686f 6c64 0a20 2020 2073 7069 6b65 7320  hold.    spikes 
+00036050: 3d20 6e70 2e61 6273 2864 6174 6120 2d20  = np.abs(data - 
+00036060: 6d65 616e 5b2e 2e2e 2c20 6e70 2e6e 6577  mean[..., np.new
+00036070: 6178 6973 5d29 203e 2074 6872 6573 686f  axis]) > thresho
+00036080: 6c64 202a 2073 7464 5b2e 2e2e 2c20 6e70  ld * std[..., np
+00036090: 2e6e 6577 6178 6973 5d0a 0a20 2020 2023  .newaxis]..    #
+000360a0: 2052 6570 6c61 6365 2073 7069 6b65 2076   Replace spike v
+000360b0: 616c 7565 730a 2020 2020 7370 696b 655f  alues.    spike_
+000360c0: 636f 756e 7473 203d 206e 702e 7a65 726f  counts = np.zero
+000360d0: 7328 2069 6d61 6765 2e73 6861 7065 5b33  s( image.shape[3
+000360e0: 5d20 290a 2020 2020 666f 7220 6920 696e  ] ).    for i in
+000360f0: 2072 616e 6765 2864 6174 612e 7368 6170   range(data.shap
+00036100: 655b 2d31 5d29 3a0a 2020 2020 2020 2020  e[-1]):.        
+00036110: 736c 6963 6520 3d20 6461 7461 5b2e 2e2e  slice = data[...
+00036120: 2c20 695d 0a20 2020 2020 2020 2073 7069  , i].        spi
+00036130: 6b65 5f6c 6f63 6174 696f 6e73 203d 2073  ke_locations = s
+00036140: 7069 6b65 735b 2e2e 2e2c 2069 5d0a 2020  pikes[..., i].  
+00036150: 2020 2020 2020 7370 696b 655f 636f 756e        spike_coun
+00036160: 7473 5b69 5d20 3d20 7370 696b 655f 6c6f  ts[i] = spike_lo
+00036170: 6361 7469 6f6e 732e 7375 6d28 290a 2020  cations.sum().  
+00036180: 2020 2020 2020 6966 2072 6570 6c61 6365        if replace
+00036190: 6d65 6e74 203d 3d20 276d 6564 6961 6e27  ment == 'median'
+000361a0: 3a0a 2020 2020 2020 2020 2020 2020 736c  :.            sl
+000361b0: 6963 655b 7370 696b 655f 6c6f 6361 7469  ice[spike_locati
+000361c0: 6f6e 735d 203d 206e 702e 6d65 6469 616e  ons] = np.median
+000361d0: 2873 6c69 6365 2920 2023 2052 6570 6c61  (slice)  # Repla
+000361e0: 6365 2077 6974 6820 6d65 6469 616e 206f  ce with median o
+000361f0: 7220 616e 6f74 6865 7220 6d65 7468 6f64  r another method
+00036200: 0a20 2020 2020 2020 2065 6c73 653a 0a09  .        else:..
+00036210: 2020 2020 2320 4361 6c63 756c 6174 6520      # Calculate 
+00036220: 7468 7265 7368 6f6c 6420 7661 6c75 6573  threshold values
+00036230: 2028 6d65 616e 20c2 b120 7468 7265 7368   (mean .. thresh
+00036240: 6f6c 6420 2a20 7374 6429 0a20 2020 2020  old * std).     
+00036250: 2020 2020 2020 2074 6872 6573 686f 6c64         threshold
+00036260: 5f76 616c 7565 7320 3d20 6d65 616e 202b  _values = mean +
+00036270: 206e 702e 7369 676e 2873 6c69 6365 202d   np.sign(slice -
+00036280: 206d 6561 6e29 202a 2074 6872 6573 686f   mean) * thresho
+00036290: 6c64 202a 2073 7464 0a20 2020 2020 2020  ld * std.       
+000362a0: 2020 2020 2073 6c69 6365 5b73 7069 6b65       slice[spike
+000362b0: 5f6c 6f63 6174 696f 6e73 5d20 3d20 7468  _locations] = th
+000362c0: 7265 7368 6f6c 645f 7661 6c75 6573 5b73  reshold_values[s
+000362d0: 7069 6b65 5f6c 6f63 6174 696f 6e73 5d0a  pike_locations].
+000362e0: 2020 2020 2020 2020 6461 7461 5b2e 2e2e          data[...
+000362f0: 2c20 695d 203d 2073 6c69 6365 0a20 2020  , i] = slice.   
+00036300: 2023 2043 6f6e 7665 7274 2062 6163 6b20   # Convert back 
+00036310: 746f 2041 4e54 7350 7920 696d 6167 650a  to ANTsPy image.
+00036320: 2020 2020 6465 7370 696b 655f 696d 6167      despike_imag
+00036330: 6520 3d20 616e 7473 2e66 726f 6d5f 6e75  e = ants.from_nu
+00036340: 6d70 7928 6461 7461 290a 2020 2020 6465  mpy(data).    de
+00036350: 7370 696b 655f 696d 6167 6520 3d20 616e  spike_image = an
+00036360: 7473 2e63 6f70 795f 696d 6167 655f 696e  ts.copy_image_in
+00036370: 666f 2820 696d 6167 652c 2064 6573 7069  fo( image, despi
+00036380: 6b65 5f69 6d61 6765 2029 0a20 2020 2072  ke_image ).    r
+00036390: 6574 7572 6e20 6465 7370 696b 655f 696d  eturn despike_im
+000363a0: 6167 652c 2073 7069 6b65 5f63 6f75 6e74  age, spike_count
+000363b0: 730a 0a0a 0a64 6566 2062 6f6c 645f 7065  s....def bold_pe
+000363c0: 7266 7573 696f 6e5f 6d69 6e69 6d61 6c28  rfusion_minimal(
+000363d0: 200a 2020 2020 2020 2020 666d 7269 2c20   .        fmri, 
+000363e0: 0a20 2020 2020 2020 206d 305f 696d 6167  .        m0_imag
+000363f0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+00036400: 2020 7370 6120 3d20 2830 2e2c 2030 2e2c    spa = (0., 0.,
+00036410: 2030 2e2c 2030 2e29 2c0a 2020 2020 2020   0., 0.),.      
+00036420: 2020 6e63 2020 3d20 302c 0a20 2020 2020    nc  = 0,.     
+00036430: 2020 2074 633d 2761 6c74 6572 6e61 7469     tc='alternati
+00036440: 6e67 272c 0a20 2020 2020 2020 206e 5f74  ng',.        n_t
+00036450: 6f5f 7472 696d 3d30 2c0a 2020 2020 2020  o_trim=0,.      
+00036460: 2020 6f75 746c 6965 725f 7468 7265 7368    outlier_thresh
+00036470: 6f6c 643d 302e 3235 302c 0a20 2020 2020  old=0.250,.     
+00036480: 2020 2070 6c6f 745f 6272 6169 6e5f 6d61     plot_brain_ma
+00036490: 736b 3d46 616c 7365 2c0a 2020 2020 2020  sk=False,.      
+000364a0: 2020 7665 7262 6f73 653d 4661 6c73 6520    verbose=False 
+000364b0: 293a 0a20 2022 2222 0a20 2045 7374 696d  ):.  """.  Estim
+000364c0: 6174 6520 7065 7266 7573 696f 6e20 6672  ate perfusion fr
+000364d0: 6f6d 2061 2042 4f4c 4420 7469 6d65 2073  om a BOLD time s
+000364e0: 6572 6965 7320 696d 6167 652e 2020 5769  eries image.  Wi
+000364f0: 6c6c 2061 7474 656d 7074 2074 6f20 6669  ll attempt to fi
+00036500: 6775 7265 206f 7574 2074 6865 2054 2d43  gure out the T-C
+00036510: 206c 6162 656c 7320 6672 6f6d 2074 6865   labels from the
+00036520: 2064 6174 612e 2020 5468 6520 6675 6e63   data.  The func
+00036530: 7469 6f6e 2075 7365 7320 6465 6661 756c  tion uses defaul
+00036540: 7473 2074 6f20 7175 616e 7469 6679 2043  ts to quantify C
+00036550: 4246 2062 7574 2074 6865 7365 2077 696c  BF but these wil
+00036560: 6c20 7573 7561 6c6c 7920 6e6f 7420 6265  l usually not be
+00036570: 2063 6f72 7265 6374 2066 6f72 2079 6f75   correct for you
+00036580: 7220 6f77 6e20 6461 7461 2e20 2053 6565  r own data.  See
+00036590: 2074 6865 2066 756e 6374 696f 6e20 6361   the function ca
+000365a0: 6c63 756c 6174 655f 4342 4620 666f 7220  lculate_CBF for 
+000365b0: 616e 2065 7861 6d70 6c65 206f 6620 686f  an example of ho
+000365c0: 7720 6f6e 6520 6d69 6768 7420 646f 2071  w one might do q
+000365d0: 7561 6e74 6966 6963 6174 696f 6e20 6261  uantification ba
+000365e0: 7365 6420 6f6e 2074 6865 206f 7574 7075  sed on the outpu
+000365f0: 7473 206f 6620 7468 6973 2066 756e 6374  ts of this funct
+00036600: 696f 6e20 7370 6563 6966 6963 616c 6c79  ion specifically
+00036610: 2074 6865 2070 6572 6675 7369 6f6e 2c20   the perfusion, 
+00036620: 6d30 2061 6e64 206d 6173 6b20 696d 6167  m0 and mask imag
+00036630: 6573 2074 6861 7420 6172 6520 7061 7274  es that are part
+00036640: 206f 6620 7468 6520 6f75 7470 7574 2064   of the output d
+00036650: 6963 7469 6f6e 6172 792e 0a0a 2020 5468  ictionary...  Th
+00036660: 6973 2066 756e 6374 696f 6e20 6973 2069  is function is i
+00036670: 6e74 656e 6465 6420 666f 7220 7573 6520  ntended for use 
+00036680: 696e 2064 6562 7567 6769 6e67 2f74 6573  in debugging/tes
+00036690: 7469 6e67 206f 7220 7768 656e 206f 6e65  ting or when one
+000366a0: 206c 6163 6b73 2061 2054 3177 2069 6d61   lacks a T1w ima
+000366b0: 6765 2e0a 0a20 2041 7267 756d 656e 7473  ge...  Arguments
+000366c0: 0a20 202d 2d2d 2d2d 2d2d 2d2d 0a0a 2020  .  ---------..  
+000366d0: 666d 7269 203a 2042 4f4c 4420 666d 7269  fmri : BOLD fmri
+000366e0: 2061 6e74 7349 6d61 6765 0a0a 2020 6d30   antsImage..  m0
+000366f0: 5f69 6d61 6765 3a20 6120 7072 652d 6465  _image: a pre-de
+00036700: 6669 6e65 6420 6d30 2061 6e74 7349 6d61  fined m0 antsIma
+00036710: 6765 0a0a 2020 7370 6120 3a20 6761 7573  ge..  spa : gaus
+00036720: 7369 616e 2073 6d6f 6f74 6869 6e67 2066  sian smoothing f
+00036730: 6f72 2073 7061 7469 616c 2061 6e64 2074  or spatial and t
+00036740: 656d 706f 7261 6c20 636f 6d70 6f6e 656e  emporal componen
+00036750: 7420 652e 672e 2028 312c 312c 312c 3029  t e.g. (1,1,1,0)
+00036760: 2069 6e20 7068 7973 6963 616c 2073 7061   in physical spa
+00036770: 6365 2063 6f6f 7264 696e 6174 6573 0a0a  ce coordinates..
+00036780: 2020 6e63 2020 3a20 6e75 6d62 6572 206f    nc  : number o
+00036790: 6620 636f 6d70 6f6e 656e 7473 2066 6f72  f components for
+000367a0: 2063 6f6d 7063 6f72 2066 696c 7465 7269   compcor filteri
+000367b0: 6e67 0a0a 2020 7463 3a20 7374 7269 6e67  ng..  tc: string
+000367c0: 2065 6974 6865 7220 616c 7465 726e 6174   either alternat
+000367d0: 696e 6720 6f72 2073 706c 6974 2028 6465  ing or split (de
+000367e0: 6661 756c 7420 6973 2061 6c74 6572 6e61  fault is alterna
+000367f0: 7469 6e67 2069 6520 4354 4354 4354 3b20  ting ie CTCTCT; 
+00036800: 7370 6c69 7420 6973 2043 4343 4354 5454  split is CCCCTTT
+00036810: 5429 0a0a 2020 6e5f 746f 5f74 7269 6d3a  T)..  n_to_trim:
+00036820: 206e 756d 6265 7220 6f66 2076 6f6c 756d   number of volum
+00036830: 6573 2074 6f20 7472 696d 206f 6666 2074  es to trim off t
+00036840: 6865 2066 726f 6e74 206f 6620 7468 6520  he front of the 
+00036850: 7469 6d65 2073 6572 6965 7320 746f 2061  time series to a
+00036860: 6363 6f75 6e74 2066 6f72 2069 6e69 7469  ccount for initi
+00036870: 616c 206d 6167 6e65 7469 6320 7361 7475  al magnetic satu
+00036880: 7261 7469 6f6e 2065 6666 6563 7473 206f  ration effects o
+00036890: 7220 746f 2061 6c6c 6f77 2074 6865 2073  r to allow the s
+000368a0: 6967 6e61 6c20 746f 2072 6561 6368 2061  ignal to reach a
+000368b0: 2073 7465 6164 7920 7374 6174 652e 2069   steady state. i
+000368c0: 6e20 736f 6d65 2063 6173 6573 2c20 7472  n some cases, tr
+000368d0: 6169 6c69 6e67 2076 6f6c 756d 6573 206f  ailing volumes o
+000368e0: 7220 6f74 6865 7220 6f75 746c 6965 7220  r other outlier 
+000368f0: 766f 6c75 6d65 7320 6d61 7920 6e65 6564  volumes may need
+00036900: 2074 6f20 6265 2072 656a 6563 7465 642e   to be rejected.
+00036910: 2020 7468 6973 2063 6f64 6520 646f 6573    this code does
+00036920: 206e 6f74 2063 7572 7265 6e74 6c79 2068   not currently h
+00036930: 616e 646c 6520 7468 6174 2069 7373 7565  andle that issue
+00036940: 2e0a 0a20 206f 7574 6c69 6572 5f74 6872  ...  outlier_thr
+00036950: 6573 686f 6c64 2028 6e75 6d65 7269 6329  eshold (numeric)
+00036960: 3a20 6265 7477 6565 6e20 7a65 726f 2028  : between zero (
+00036970: 7265 6d6f 7665 2061 6c6c 2920 616e 6420  remove all) and 
+00036980: 6f6e 6520 2872 656d 6f76 6520 6e6f 6e65  one (remove none
+00036990: 293b 2061 7574 6f6d 6174 6963 616c 6c79  ); automatically
+000369a0: 2063 616c 6375 6c61 7465 7320 6f75 746c   calculates outl
+000369b0: 6965 726e 6573 7320 616e 6420 7573 6573  ierness and uses
+000369c0: 2069 7420 746f 2063 656e 736f 7220 7468   it to censor th
+000369d0: 6520 7469 6d65 2073 6572 6965 732e 0a0a  e time series...
+000369e0: 2020 706c 6f74 5f62 7261 696e 5f6d 6173    plot_brain_mas
+000369f0: 6b20 3a20 626f 6f6c 6561 6e20 6361 6e20  k : boolean can 
+00036a00: 6865 6c70 2077 6974 6820 6368 6563 6b69  help with checki
+00036a10: 6e67 2064 6174 6120 7175 616c 6974 7920  ng data quality 
+00036a20: 7669 7375 616c 6c79 0a0a 2020 7665 7262  visually..  verb
+00036a30: 6f73 6520 3a20 626f 6f6c 6561 6e0a 0a20  ose : boolean.. 
+00036a40: 2052 6574 7572 6e73 0a20 202d 2d2d 2d2d   Returns.  -----
+00036a50: 2d2d 2d2d 0a20 2061 2064 6963 7469 6f6e  ----.  a diction
+00036a60: 6172 7920 636f 6e74 6169 6e69 6e67 2074  ary containing t
+00036a70: 6865 2064 6572 6976 6564 206e 6574 776f  he derived netwo
+00036a80: 726b 206d 6170 730a 0a20 2022 2222 0a20  rk maps..  """. 
+00036a90: 2069 6d70 6f72 7420 6e75 6d70 7920 6173   import numpy as
+00036aa0: 206e 700a 2020 696d 706f 7274 2070 616e   np.  import pan
+00036ab0: 6461 7320 6173 2070 640a 2020 696d 706f  das as pd.  impo
+00036ac0: 7274 2072 650a 2020 696d 706f 7274 206d  rt re.  import m
+00036ad0: 6174 680a 2020 6672 6f6d 2073 6b6c 6561  ath.  from sklea
+00036ae0: 726e 2e6c 696e 6561 725f 6d6f 6465 6c20  rn.linear_model 
+00036af0: 696d 706f 7274 2052 414e 5341 4352 6567  import RANSACReg
+00036b00: 7265 7373 6f72 2c20 5468 6569 6c53 656e  ressor, TheilSen
+00036b10: 5265 6772 6573 736f 722c 2048 7562 6572  Regressor, Huber
+00036b20: 5265 6772 6573 736f 722c 2051 7561 6e74  Regressor, Quant
+00036b30: 696c 6552 6567 7265 7373 6f72 2c20 4c69  ileRegressor, Li
+00036b40: 6e65 6172 5265 6772 6573 7369 6f6e 2c20  nearRegression, 
+00036b50: 5347 4452 6567 7265 7373 6f72 0a20 2066  SGDRegressor.  f
+00036b60: 726f 6d20 736b 6c65 6172 6e2e 6d75 6c74  rom sklearn.mult
+00036b70: 696f 7574 7075 7420 696d 706f 7274 204d  ioutput import M
+00036b80: 756c 7469 4f75 7470 7574 5265 6772 6573  ultiOutputRegres
+00036b90: 736f 720a 2020 6672 6f6d 2073 6b6c 6561  sor.  from sklea
+00036ba0: 726e 2e70 7265 7072 6f63 6573 7369 6e67  rn.preprocessing
+00036bb0: 2069 6d70 6f72 7420 5374 616e 6461 7264   import Standard
+00036bc0: 5363 616c 6572 0a0a 2020 6465 6620 7265  Scaler..  def re
+00036bd0: 706c 6963 6174 655f 6c69 7374 2875 7365  plicate_list(use
+00036be0: 725f 6c69 7374 2c20 7461 7267 6574 5f73  r_list, target_s
+00036bf0: 697a 6529 3a0a 2020 2020 2320 4361 6c63  ize):.    # Calc
+00036c00: 756c 6174 6520 7468 6520 6e75 6d62 6572  ulate the number
+00036c10: 206f 6620 7469 6d65 7320 7468 6520 6c69   of times the li
+00036c20: 7374 2073 686f 756c 6420 6265 2072 6570  st should be rep
+00036c30: 6c69 6361 7465 640a 2020 2020 7265 706c  licated.    repl
+00036c40: 6963 6174 696f 6e5f 6661 6374 6f72 203d  ication_factor =
+00036c50: 2074 6172 6765 745f 7369 7a65 202f 2f20   target_size // 
+00036c60: 6c65 6e28 7573 6572 5f6c 6973 7429 0a20  len(user_list). 
+00036c70: 2020 2023 2052 6570 6c69 6361 7465 2074     # Replicate t
+00036c80: 6865 206c 6973 7420 616e 6420 6861 6e64  he list and hand
+00036c90: 6c65 2061 6e79 2072 656d 6169 6e69 6e67  le any remaining
+00036ca0: 2065 6c65 6d65 6e74 730a 2020 2020 7265   elements.    re
+00036cb0: 706c 6963 6174 6564 5f6c 6973 7420 3d20  plicated_list = 
+00036cc0: 7573 6572 5f6c 6973 7420 2a20 7265 706c  user_list * repl
+00036cd0: 6963 6174 696f 6e5f 6661 6374 6f72 0a20  ication_factor. 
+00036ce0: 2020 2072 656d 6169 6e69 6e67 5f65 6c65     remaining_ele
+00036cf0: 6d65 6e74 7320 3d20 7461 7267 6574 5f73  ments = target_s
+00036d00: 697a 6520 2520 6c65 6e28 7573 6572 5f6c  ize % len(user_l
+00036d10: 6973 7429 0a20 2020 2072 6570 6c69 6361  ist).    replica
+00036d20: 7465 645f 6c69 7374 202b 3d20 7573 6572  ted_list += user
+00036d30: 5f6c 6973 745b 3a72 656d 6169 6e69 6e67  _list[:remaining
+00036d40: 5f65 6c65 6d65 6e74 735d 0a20 2020 2072  _elements].    r
+00036d50: 6574 7572 6e20 7265 706c 6963 6174 6564  eturn replicated
+00036d60: 5f6c 6973 740a 0a20 2064 6566 206f 6e65  _list..  def one
+00036d70: 5f68 6f74 5f65 6e63 6f64 6528 6368 6172  _hot_encode(char
+00036d80: 5f6c 6973 7429 3a0a 2020 2020 756e 6971  _list):.    uniq
+00036d90: 7565 5f63 6861 7273 203d 206c 6973 7428  ue_chars = list(
+00036da0: 7365 7428 6368 6172 5f6c 6973 7429 290a  set(char_list)).
+00036db0: 2020 2020 656e 636f 6469 6e67 5f64 6963      encoding_dic
+00036dc0: 7420 3d20 7b63 6861 723a 205b 3120 6966  t = {char: [1 if
+00036dd0: 2063 6861 7220 3d3d 2063 2065 6c73 6520   char == c else 
+00036de0: 3020 666f 7220 6320 696e 2075 6e69 7175  0 for c in uniqu
+00036df0: 655f 6368 6172 735d 2066 6f72 2063 6861  e_chars] for cha
+00036e00: 7220 696e 2075 6e69 7175 655f 6368 6172  r in unique_char
+00036e10: 737d 0a20 2020 2065 6e63 6f64 6564 5f6d  s}.    encoded_m
+00036e20: 6174 7269 7820 3d20 6e70 2e61 7272 6179  atrix = np.array
+00036e30: 285b 656e 636f 6469 6e67 5f64 6963 745b  ([encoding_dict[
+00036e40: 6368 6172 5d20 666f 7220 6368 6172 2069  char] for char i
+00036e50: 6e20 6368 6172 5f6c 6973 745d 290a 2020  n char_list]).  
+00036e60: 2020 7265 7475 726e 2065 6e63 6f64 6564    return encoded
+00036e70: 5f6d 6174 7269 780a 2020 0a20 2041 203d  _matrix.  .  A =
+00036e80: 206e 702e 7a65 726f 7328 2831 2c31 2929   np.zeros((1,1))
+00036e90: 0a20 2066 6d72 695f 7465 6d70 6c61 7465  .  fmri_template
+00036ea0: 203d 2061 6e74 732e 6765 745f 6176 6572   = ants.get_aver
+00036eb0: 6167 655f 6f66 5f74 696d 6573 6572 6965  age_of_timeserie
+00036ec0: 7328 2066 6d72 6920 290a 2020 6966 206e  s( fmri ).  if n
+00036ed0: 5f74 6f5f 7472 696d 2069 7320 4e6f 6e65  _to_trim is None
+00036ee0: 3a0a 2020 2020 6e5f 746f 5f74 7269 6d3d  :.    n_to_trim=
+00036ef0: 300a 2020 6d79 7472 696d 3d6e 5f74 6f5f  0.  mytrim=n_to_
+00036f00: 7472 696d 0a20 2070 6572 665f 746f 7461  trim.  perf_tota
+00036f10: 6c5f 7369 676d 6120 3d20 312e 350a 2020  l_sigma = 1.5.  
+00036f20: 636f 7272 6d6f 203d 2074 696d 6573 6572  corrmo = timeser
+00036f30: 6965 735f 7265 6728 0a20 2020 2066 6d72  ies_reg(.    fmr
+00036f40: 692c 2066 6d72 695f 7465 6d70 6c61 7465  i, fmri_template
+00036f50: 2c0a 2020 2020 7479 7065 5f6f 665f 7472  ,.    type_of_tr
+00036f60: 616e 7366 6f72 6d3d 2752 6967 6964 272c  ansform='Rigid',
+00036f70: 0a20 2020 2074 6f74 616c 5f73 6967 6d61  .    total_sigma
+00036f80: 3d70 6572 665f 746f 7461 6c5f 7369 676d  =perf_total_sigm
+00036f90: 612c 0a20 2020 2066 644f 6666 7365 743d  a,.    fdOffset=
+00036fa0: 322e 302c 0a20 2020 2074 7269 6d20 3d20  2.0,.    trim = 
+00036fb0: 6d79 7472 696d 2c0a 2020 2020 6f75 7470  mytrim,.    outp
+00036fc0: 7574 5f64 6972 6563 746f 7279 3d4e 6f6e  ut_directory=Non
+00036fd0: 652c 0a20 2020 2076 6572 626f 7365 3d76  e,.    verbose=v
+00036fe0: 6572 626f 7365 2c0a 2020 2020 7379 6e5f  erbose,.    syn_
+00036ff0: 6d65 7472 6963 3d27 6363 272c 0a20 2020  metric='cc',.   
+00037000: 2073 796e 5f73 616d 706c 696e 673d 322c   syn_sampling=2,
+00037010: 0a20 2020 2072 6567 5f69 7465 7261 7469  .    reg_iterati
+00037020: 6f6e 733d 5b34 302c 3230 2c35 5d20 290a  ons=[40,20,5] ).
+00037030: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+00037040: 2020 2020 7072 696e 7428 2245 6e64 2072      print("End r
+00037050: 7366 6d72 6920 6d6f 7469 6f6e 2063 6f72  sfmri motion cor
+00037060: 7265 6374 696f 6e22 290a 0a20 2069 6620  rection")..  if 
+00037070: 6d30 5f69 6d61 6765 2069 7320 6e6f 7420  m0_image is not 
+00037080: 4e6f 6e65 3a0a 2020 2020 2020 6d30 203d  None:.      m0 =
+00037090: 206d 305f 696d 6167 650a 0a20 206e 7470   m0_image..  ntp
+000370a0: 203d 2063 6f72 726d 6f5b 276d 6f74 696f   = corrmo['motio
+000370b0: 6e5f 636f 7272 6563 7465 6427 5d2e 7368  n_corrected'].sh
+000370c0: 6170 655b 335d 0a20 2066 6d72 695f 7465  ape[3].  fmri_te
+000370d0: 6d70 6c61 7465 203d 2061 6e74 732e 6765  mplate = ants.ge
+000370e0: 745f 6176 6572 6167 655f 6f66 5f74 696d  t_average_of_tim
+000370f0: 6573 6572 6965 7328 2063 6f72 726d 6f5b  eseries( corrmo[
+00037100: 276d 6f74 696f 6e5f 636f 7272 6563 7465  'motion_correcte
+00037110: 6427 5d20 290a 2020 626d 6173 6b20 3d20  d'] ).  bmask = 
+00037120: 616e 7473 7079 6e65 742e 6272 6169 6e5f  antspynet.brain_
+00037130: 6578 7472 6163 7469 6f6e 2820 666d 7269  extraction( fmri
+00037140: 5f74 656d 706c 6174 652c 2027 626f 6c64  _template, 'bold
+00037150: 2720 292e 7468 7265 7368 6f6c 645f 696d  ' ).threshold_im
+00037160: 6167 6528 302e 352c 3129 2e69 4d61 7468  age(0.5,1).iMath
+00037170: 2822 4765 744c 6172 6765 7374 436f 6d70  ("GetLargestComp
+00037180: 6f6e 656e 7422 292e 6d6f 7270 686f 6c6f  onent").morpholo
+00037190: 6779 2822 636c 6f73 6522 2c32 292e 694d  gy("close",2).iM
+000371a0: 6174 6828 2246 696c 6c48 6f6c 6573 2229  ath("FillHoles")
+000371b0: 0a20 2069 6620 706c 6f74 5f62 7261 696e  .  if plot_brain
+000371c0: 5f6d 6173 6b3a 0a20 2020 2061 6e74 732e  _mask:.    ants.
+000371d0: 706c 6f74 2820 666d 7269 5f74 656d 706c  plot( fmri_templ
+000371e0: 6174 652c 2062 6d61 736b 2c20 6178 6973  ate, bmask, axis
+000371f0: 3d31 2c20 6372 6f70 3d54 7275 6520 290a  =1, crop=True ).
+00037200: 2020 2020 616e 7473 2e70 6c6f 7428 2066      ants.plot( f
+00037210: 6d72 695f 7465 6d70 6c61 7465 2c20 626d  mri_template, bm
+00037220: 6173 6b2c 2061 7869 733d 322c 2063 726f  ask, axis=2, cro
+00037230: 703d 5472 7565 2029 0a0a 2020 6966 2074  p=True )..  if t
+00037240: 6320 3d3d 2027 616c 7465 726e 6174 696e  c == 'alternatin
+00037250: 6727 3a0a 2020 2020 2020 7463 6c69 7374  g':.      tclist
+00037260: 203d 2072 6570 6c69 6361 7465 5f6c 6973   = replicate_lis
+00037270: 7428 205b 2743 272c 2754 275d 2c20 6e74  t( ['C','T'], nt
+00037280: 7020 290a 2020 656c 7365 3a0a 2020 2020  p ).  else:.    
+00037290: 2020 7463 6c69 7374 203d 2072 6570 6c69    tclist = repli
+000372a0: 6361 7465 5f6c 6973 7428 205b 2743 275d  cate_list( ['C']
+000372b0: 2c20 696e 7428 6e74 702f 3229 2029 202b  , int(ntp/2) ) +
+000372c0: 2072 6570 6c69 6361 7465 5f6c 6973 7428   replicate_list(
+000372d0: 205b 2754 275d 2c20 2069 6e74 286e 7470   ['T'],  int(ntp
+000372e0: 2f32 2920 290a 0a20 2074 636c 6973 7420  /2) )..  tclist 
+000372f0: 3d20 6f6e 655f 686f 745f 656e 636f 6465  = one_hot_encode
+00037300: 2820 7463 6c69 7374 5b30 3a6e 7470 205d  ( tclist[0:ntp ]
+00037310: 2029 0a20 2066 6d72 696d 6f74 636f 7272   ).  fmrimotcorr
+00037320: 3d63 6f72 726d 6f5b 276d 6f74 696f 6e5f  =corrmo['motion_
+00037330: 636f 7272 6563 7465 6427 5d0a 2020 686c  corrected'].  hl
+00037340: 696e 6473 203d 204e 6f6e 650a 2020 6966  inds = None.  if
+00037350: 206f 7574 6c69 6572 5f74 6872 6573 686f   outlier_thresho
+00037360: 6c64 203c 2031 2e30 2061 6e64 206f 7574  ld < 1.0 and out
+00037370: 6c69 6572 5f74 6872 6573 686f 6c64 203e  lier_threshold >
+00037380: 2030 2e30 3a0a 2020 2020 666d 7269 6d6f   0.0:.    fmrimo
+00037390: 7463 6f72 722c 2068 6c69 6e64 7320 3d20  tcorr, hlinds = 
+000373a0: 6c6f 6f70 5f74 696d 6573 6572 6965 735f  loop_timeseries_
+000373b0: 6365 6e73 6f72 696e 6728 2066 6d72 696d  censoring( fmrim
+000373c0: 6f74 636f 7272 2c20 6f75 746c 6965 725f  otcorr, outlier_
+000373d0: 7468 7265 7368 6f6c 642c 206d 6173 6b3d  threshold, mask=
+000373e0: 4e6f 6e65 2c20 7665 7262 6f73 653d 7665  None, verbose=ve
+000373f0: 7262 6f73 6520 290a 2020 2020 7463 6c69  rbose ).    tcli
+00037400: 7374 203d 2072 656d 6f76 655f 656c 656d  st = remove_elem
+00037410: 656e 7473 5f66 726f 6d5f 6e75 6d70 795f  ents_from_numpy_
+00037420: 6172 7261 7928 2074 636c 6973 742c 2068  array( tclist, h
+00037430: 6c69 6e64 7329 0a20 2020 2063 6f72 726d  linds).    corrm
+00037440: 6f5b 2746 4427 5d20 3d20 7265 6d6f 7665  o['FD'] = remove
+00037450: 5f65 6c65 6d65 6e74 735f 6672 6f6d 5f6e  _elements_from_n
+00037460: 756d 7079 5f61 7272 6179 2820 636f 7272  umpy_array( corr
+00037470: 6d6f 5b27 4644 275d 2c20 686c 696e 6473  mo['FD'], hlinds
+00037480: 2029 0a0a 2020 2320 7265 646f 2074 656d   )..  # redo tem
+00037490: 706c 6174 6520 616e 6420 7265 6769 7374  plate and regist
+000374a0: 7261 7469 6f6e 2061 7420 2870 6f74 656e  ration at (poten
+000374b0: 7469 616c 6c79 2920 7570 7361 6d70 6c65  tially) upsample
+000374c0: 6420 7363 616c 650a 2020 666d 7269 5f74  d scale.  fmri_t
+000374d0: 656d 706c 6174 6520 3d20 616e 7473 2e69  emplate = ants.i
+000374e0: 4d61 7468 2820 616e 7473 2e67 6574 5f61  Math( ants.get_a
+000374f0: 7665 7261 6765 5f6f 665f 7469 6d65 7365  verage_of_timese
+00037500: 7269 6573 2820 666d 7269 6d6f 7463 6f72  ries( fmrimotcor
+00037510: 7220 292c 2022 4e6f 726d 616c 697a 6522  r ), "Normalize"
+00037520: 2029 0a20 2063 6f72 726d 6f20 3d20 7469   ).  corrmo = ti
+00037530: 6d65 7365 7269 6573 5f72 6567 280a 2020  meseries_reg(.  
+00037540: 2020 2020 2020 666d 7269 2c20 666d 7269        fmri, fmri
+00037550: 5f74 656d 706c 6174 652c 0a20 2020 2020  _template,.     
+00037560: 2020 2074 7970 655f 6f66 5f74 7261 6e73     type_of_trans
+00037570: 666f 726d 3d27 5269 6769 6427 2c0a 2020  form='Rigid',.  
+00037580: 2020 2020 2020 746f 7461 6c5f 7369 676d        total_sigm
+00037590: 613d 7065 7266 5f74 6f74 616c 5f73 6967  a=perf_total_sig
+000375a0: 6d61 2c0a 2020 2020 2020 2020 6664 4f66  ma,.        fdOf
+000375b0: 6673 6574 3d32 2e30 2c0a 2020 2020 2020  fset=2.0,.      
+000375c0: 2020 7472 696d 203d 206d 7974 7269 6d2c    trim = mytrim,
+000375d0: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
+000375e0: 6469 7265 6374 6f72 793d 4e6f 6e65 2c0a  directory=None,.
+000375f0: 2020 2020 2020 2020 7665 7262 6f73 653d          verbose=
+00037600: 7665 7262 6f73 652c 0a20 2020 2020 2020  verbose,.       
+00037610: 2073 796e 5f6d 6574 7269 633d 2763 6327   syn_metric='cc'
+00037620: 2c0a 2020 2020 2020 2020 7379 6e5f 7361  ,.        syn_sa
+00037630: 6d70 6c69 6e67 3d32 2c0a 2020 2020 2020  mpling=2,.      
+00037640: 2020 7265 675f 6974 6572 6174 696f 6e73    reg_iterations
+00037650: 3d5b 3430 2c32 302c 355d 2029 0a20 2069  =[40,20,5] ).  i
+00037660: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+00037670: 2020 2070 7269 6e74 2822 456e 6420 326e     print("End 2n
+00037680: 6420 7273 666d 7269 206d 6f74 696f 6e20  d rsfmri motion 
+00037690: 636f 7272 6563 7469 6f6e 2229 0a0a 2020  correction")..  
+000376a0: 6966 206f 7574 6c69 6572 5f74 6872 6573  if outlier_thres
+000376b0: 686f 6c64 203c 2031 2e30 2061 6e64 206f  hold < 1.0 and o
+000376c0: 7574 6c69 6572 5f74 6872 6573 686f 6c64  utlier_threshold
+000376d0: 203e 2030 2e30 3a0a 2020 2020 636f 7272   > 0.0:.    corr
+000376e0: 6d6f 5b27 6d6f 7469 6f6e 5f63 6f72 7265  mo['motion_corre
+000376f0: 6374 6564 275d 203d 2072 656d 6f76 655f  cted'] = remove_
+00037700: 766f 6c75 6d65 735f 6672 6f6d 5f74 696d  volumes_from_tim
+00037710: 6573 6572 6965 7328 2063 6f72 726d 6f5b  eseries( corrmo[
+00037720: 276d 6f74 696f 6e5f 636f 7272 6563 7465  'motion_correcte
+00037730: 6427 5d2c 2068 6c69 6e64 7320 290a 2020  d'], hlinds ).  
+00037740: 2020 636f 7272 6d6f 5b27 4644 275d 203d    corrmo['FD'] =
+00037750: 2072 656d 6f76 655f 656c 656d 656e 7473   remove_elements
+00037760: 5f66 726f 6d5f 6e75 6d70 795f 6172 7261  _from_numpy_arra
+00037770: 7928 2063 6f72 726d 6f5b 2746 4427 5d2c  y( corrmo['FD'],
+00037780: 2068 6c69 6e64 7320 290a 0a20 2062 6d61   hlinds )..  bma
+00037790: 736b 203d 2061 6e74 7370 796e 6574 2e62  sk = antspynet.b
+000377a0: 7261 696e 5f65 7874 7261 6374 696f 6e28  rain_extraction(
+000377b0: 2066 6d72 695f 7465 6d70 6c61 7465 2c20   fmri_template, 
+000377c0: 2762 6f6c 6427 2029 2e74 6872 6573 686f  'bold' ).thresho
+000377d0: 6c64 5f69 6d61 6765 2830 2e35 2c31 292e  ld_image(0.5,1).
+000377e0: 694d 6174 6828 2247 6574 4c61 7267 6573  iMath("GetLarges
+000377f0: 7443 6f6d 706f 6e65 6e74 2229 2e6d 6f72  tComponent").mor
+00037800: 7068 6f6c 6f67 7928 2263 6c6f 7365 222c  phology("close",
+00037810: 3229 2e69 4d61 7468 2822 4669 6c6c 486f  2).iMath("FillHo
+00037820: 6c65 7322 290a 2020 6966 2070 6c6f 745f  les").  if plot_
+00037830: 6272 6169 6e5f 6d61 736b 3a0a 2020 2020  brain_mask:.    
+00037840: 616e 7473 2e70 6c6f 7428 2066 6d72 695f  ants.plot( fmri_
+00037850: 7465 6d70 6c61 7465 2c20 626d 6173 6b2c  template, bmask,
+00037860: 2061 7869 733d 312c 2063 726f 703d 5472   axis=1, crop=Tr
+00037870: 7565 2029 0a20 2020 2061 6e74 732e 706c  ue ).    ants.pl
+00037880: 6f74 2820 666d 7269 5f74 656d 706c 6174  ot( fmri_templat
+00037890: 652c 2062 6d61 736b 2c20 6178 6973 3d32  e, bmask, axis=2
+000378a0: 2c20 6372 6f70 3d54 7275 6520 290a 0a20  , crop=True ).. 
+000378b0: 2072 6567 7265 7373 696f 6e5f 6d61 736b   regression_mask
+000378c0: 203d 2062 6d61 736b 2e63 6c6f 6e65 2829   = bmask.clone()
+000378d0: 0a20 206d 7974 736e 7220 3d20 7473 6e72  .  mytsnr = tsnr
+000378e0: 2820 636f 7272 6d6f 5b27 6d6f 7469 6f6e  ( corrmo['motion
+000378f0: 5f63 6f72 7265 6374 6564 275d 2c20 626d  _corrected'], bm
+00037900: 6173 6b20 290a 2020 6d79 7473 6e72 5468  ask ).  mytsnrTh
+00037910: 7265 7368 203d 206e 702e 7175 616e 7469  resh = np.quanti
+00037920: 6c65 2820 6d79 7473 6e72 2e6e 756d 7079  le( mytsnr.numpy
+00037930: 2829 2c20 302e 3939 3520 290a 2020 7473  (), 0.995 ).  ts
+00037940: 6e72 6d61 736b 203d 2061 6e74 732e 7468  nrmask = ants.th
+00037950: 7265 7368 6f6c 645f 696d 6167 6528 206d  reshold_image( m
+00037960: 7974 736e 722c 2030 2c20 6d79 7473 6e72  ytsnr, 0, mytsnr
+00037970: 5468 7265 7368 2029 2e6d 6f72 7068 6f6c  Thresh ).morphol
+00037980: 6f67 7928 2263 6c6f 7365 222c 3329 0a20  ogy("close",3). 
+00037990: 2062 6d61 736b 203d 2062 6d61 736b 202a   bmask = bmask *
+000379a0: 2061 6e74 732e 694d 6174 6828 2074 736e   ants.iMath( tsn
+000379b0: 726d 6173 6b2c 2022 4669 6c6c 486f 6c65  rmask, "FillHole
+000379c0: 7322 2029 0a20 2066 6d72 696d 6f74 636f  s" ).  fmrimotco
+000379d0: 7272 3d63 6f72 726d 6f5b 276d 6f74 696f  rr=corrmo['motio
+000379e0: 6e5f 636f 7272 6563 7465 6427 5d0a 2020  n_corrected'].  
+000379f0: 756e 6420 3d20 666d 7269 5f74 656d 706c  und = fmri_templ
+00037a00: 6174 6520 2a20 626d 6173 6b0a 2020 636f  ate * bmask.  co
+00037a10: 6d70 636f 7271 7561 6e74 696c 653d 302e  mpcorquantile=0.
+00037a20: 3530 0a20 206d 7963 6f6d 7063 6f72 203d  50.  mycompcor =
+00037a30: 2061 6e74 732e 636f 6d70 636f 7228 2066   ants.compcor( f
+00037a40: 6d72 696d 6f74 636f 7272 2c0a 2020 2020  mrimotcorr,.    
+00037a50: 6e63 6f6d 7063 6f72 3d6e 632c 2071 7561  ncompcor=nc, qua
+00037a60: 6e74 696c 653d 636f 6d70 636f 7271 7561  ntile=compcorqua
+00037a70: 6e74 696c 652c 206d 6173 6b20 3d20 626d  ntile, mask = bm
+00037a80: 6173 6b2c 0a20 2020 2066 696c 7465 725f  ask,.    filter_
+00037a90: 7479 7065 3d27 706f 6c79 6e6f 6d69 616c  type='polynomial
+00037aa0: 272c 2064 6567 7265 653d 3220 290a 2020  ', degree=2 ).  
+00037ab0: 7472 203d 2061 6e74 732e 6765 745f 7370  tr = ants.get_sp
+00037ac0: 6163 696e 6728 2066 6d72 696d 6f74 636f  acing( fmrimotco
+00037ad0: 7272 2029 5b33 5d0a 2020 7369 6d67 203d  rr )[3].  simg =
+00037ae0: 2061 6e74 732e 736d 6f6f 7468 5f69 6d61   ants.smooth_ima
+00037af0: 6765 2866 6d72 696d 6f74 636f 7272 2c20  ge(fmrimotcorr, 
+00037b00: 7370 612c 2073 6967 6d61 5f69 6e5f 7068  spa, sigma_in_ph
+00037b10: 7973 6963 616c 5f63 6f6f 7264 696e 6174  ysical_coordinat
+00037b20: 6573 203d 2054 7275 6520 290a 2020 6e75  es = True ).  nu
+00037b30: 6973 616e 6365 203d 206d 7963 6f6d 7063  isance = mycompc
+00037b40: 6f72 5b27 6261 7369 7327 5d0a 2020 6e75  or['basis'].  nu
+00037b50: 6973 616e 6365 203d 206e 702e 635f 5b20  isance = np.c_[ 
+00037b60: 6e75 6973 616e 6365 2c20 6d79 636f 6d70  nuisance, mycomp
+00037b70: 636f 725b 2763 6f6d 706f 6e65 6e74 7327  cor['components'
+00037b80: 5d20 5d0a 2020 6966 2076 6572 626f 7365  ] ].  if verbose
+00037b90: 3a0a 2020 2020 7072 696e 7428 226d 616b  :.    print("mak
+00037ba0: 6520 7375 7265 206e 7569 7361 6e63 6520  e sure nuisance 
+00037bb0: 6973 2069 6e64 6570 656e 6465 6e74 206f  is independent o
+00037bc0: 6620 5443 2229 0a20 206e 7569 7361 6e63  f TC").  nuisanc
+00037bd0: 6520 3d20 616e 7473 2e72 6567 7265 7373  e = ants.regress
+00037be0: 5f63 6f6d 706f 6e65 6e74 7328 206e 7569  _components( nui
+00037bf0: 7361 6e63 652c 2074 636c 6973 7420 290a  sance, tclist ).
+00037c00: 2020 7265 6772 6573 7369 6f6e 5f6d 6173    regression_mas
+00037c10: 6b20 3d20 626d 6173 6b2e 636c 6f6e 6528  k = bmask.clone(
+00037c20: 290a 2020 676d 6d61 7420 3d20 616e 7473  ).  gmmat = ants
+00037c30: 2e74 696d 6573 6572 6965 735f 746f 5f6d  .timeseries_to_m
+00037c40: 6174 7269 7828 2073 696d 672c 2072 6567  atrix( simg, reg
+00037c50: 7265 7373 696f 6e5f 6d61 736b 2029 0a20  ression_mask ). 
+00037c60: 2072 6567 7661 7273 203d 206e 702e 6873   regvars = np.hs
+00037c70: 7461 636b 2820 286e 7569 7361 6e63 652c  tack( (nuisance,
+00037c80: 2074 636c 6973 7420 2929 0a20 2063 6f65   tclist )).  coe
+00037c90: 6669 6e64 203d 2072 6567 7661 7273 2e73  find = regvars.s
+00037ca0: 6861 7065 5b31 5d2d 310a 2020 7265 6776  hape[1]-1.  regv
+00037cb0: 6172 7320 3d20 7265 6776 6172 735b 3a2c  ars = regvars[:,
+00037cc0: 7261 6e67 6528 636f 6566 696e 6429 5d0a  range(coefind)].
+00037cd0: 2020 7072 6564 6963 746f 725f 6f66 5f69    predictor_of_i
+00037ce0: 6e74 6572 6573 745f 6964 7820 3d20 7265  nterest_idx = re
+00037cf0: 6776 6172 732e 7368 6170 655b 315d 2d31  gvars.shape[1]-1
+00037d00: 0a20 2076 616c 6964 5f70 6572 665f 6d6f  .  valid_perf_mo
+00037d10: 6465 6c73 203d 205b 2768 7562 6572 272c  dels = ['huber',
+00037d20: 2771 7561 6e74 696c 6527 2c27 7468 6569  'quantile','thei
+00037d30: 6c73 656e 272c 2772 616e 7361 6327 2c20  lsen','ransac', 
+00037d40: 2773 6764 272c 2027 6c69 6e65 6172 272c  'sgd', 'linear',
+00037d50: 2753 4d27 5d0a 2020 7065 7266 7573 696f  'SM'].  perfusio
+00037d60: 6e5f 7265 6772 6573 7369 6f6e 5f6d 6f64  n_regression_mod
+00037d70: 656c 3d27 6c69 6e65 6172 270a 2020 6966  el='linear'.  if
+00037d80: 2076 6572 626f 7365 3a0a 2020 2020 7072   verbose:.    pr
+00037d90: 696e 7428 2022 6265 6769 6e20 7065 7266  int( "begin perf
+00037da0: 7573 696f 6e20 6573 7469 6d61 7469 6f6e  usion estimation
+00037db0: 2077 6974 6820 2220 2b20 7065 7266 7573   with " + perfus
+00037dc0: 696f 6e5f 7265 6772 6573 7369 6f6e 5f6d  ion_regression_m
+00037dd0: 6f64 656c 202b 2022 206d 6f64 656c 2022  odel + " model "
+00037de0: 2029 0a20 2072 6567 7265 7373 696f 6e5f   ).  regression_
+00037df0: 6d6f 6465 6c20 3d20 4c69 6e65 6172 5265  model = LinearRe
+00037e00: 6772 6573 7369 6f6e 2829 0a20 2072 6567  gression().  reg
+00037e10: 7265 7373 696f 6e5f 6d6f 6465 6c2e 6669  ression_model.fi
+00037e20: 7428 2072 6567 7661 7273 2c20 676d 6d61  t( regvars, gmma
+00037e30: 7420 290a 2020 636f 6566 696e 6420 3d20  t ).  coefind = 
+00037e40: 7265 6772 6573 7369 6f6e 5f6d 6f64 656c  regression_model
+00037e50: 2e63 6f65 665f 2e73 6861 7065 5b31 5d2d  .coef_.shape[1]-
+00037e60: 310a 2020 7065 7266 696d 6720 3d20 616e  1.  perfimg = an
+00037e70: 7473 2e6d 616b 655f 696d 6167 6528 2072  ts.make_image( r
+00037e80: 6567 7265 7373 696f 6e5f 6d61 736b 2c20  egression_mask, 
+00037e90: 7265 6772 6573 7369 6f6e 5f6d 6f64 656c  regression_model
+00037ea0: 2e63 6f65 665f 5b3a 2c63 6f65 6669 6e64  .coef_[:,coefind
+00037eb0: 5d20 290a 2020 676d 7365 6720 3d20 616e  ] ).  gmseg = an
+00037ec0: 7473 2e69 6d61 6765 5f63 6c6f 6e65 2820  ts.image_clone( 
+00037ed0: 626d 6173 6b20 290a 2020 6d65 616e 676d  bmask ).  meangm
+00037ee0: 7661 6c20 3d20 2820 7065 7266 696d 675b  val = ( perfimg[
+00037ef0: 2067 6d73 6567 203d 3d20 3120 5d20 292e   gmseg == 1 ] ).
+00037f00: 6d65 616e 2829 0a20 2069 6620 6d65 616e  mean().  if mean
+00037f10: 676d 7661 6c20 3c20 303a 0a20 2020 2020  gmval < 0:.     
+00037f20: 2070 6572 6669 6d67 203d 2070 6572 6669   perfimg = perfi
+00037f30: 6d67 202a 2028 2d31 2e30 290a 2020 6e65  mg * (-1.0).  ne
+00037f40: 6761 7469 7665 5f76 6f78 656c 7320 3d20  gative_voxels = 
+00037f50: 2820 7065 7266 696d 6720 3c20 302e 3020  ( perfimg < 0.0 
+00037f60: 292e 7375 6d28 2920 2f20 6e70 2e70 726f  ).sum() / np.pro
+00037f70: 6428 2070 6572 6669 6d67 2e73 6861 7065  d( perfimg.shape
+00037f80: 2029 202a 2031 3030 2e30 0a20 2070 6572   ) * 100.0.  per
+00037f90: 6669 6d67 5b20 7065 7266 696d 6720 3c20  fimg[ perfimg < 
+00037fa0: 302e 3020 5d20 3d20 302e 3020 2320 6e6f  0.0 ] = 0.0 # no
+00037fb0: 6e2d 7068 7973 696f 6c6f 6769 6361 6c0a  n-physiological.
+00037fc0: 0a20 2069 6620 6d30 5f69 6d61 6765 2069  .  if m0_image i
+00037fd0: 7320 4e6f 6e65 3a0a 2020 2020 6d30 203d  s None:.    m0 =
+00037fe0: 2061 6e74 732e 6765 745f 6176 6572 6167   ants.get_averag
+00037ff0: 655f 6f66 5f74 696d 6573 6572 6965 7328  e_of_timeseries(
+00038000: 2066 6d72 696d 6f74 636f 7272 2029 0a20   fmrimotcorr ). 
+00038010: 2065 6c73 653a 0a20 2020 2023 2072 6567   else:.    # reg
+00038020: 6973 7465 7220 6d30 2074 6f20 6375 7272  ister m0 to curr
+00038030: 656e 7420 7465 6d70 6c61 7465 0a20 2020  ent template.   
+00038040: 206d 3072 6567 203d 2061 6e74 732e 7265   m0reg = ants.re
+00038050: 6769 7374 7261 7469 6f6e 2820 666d 7269  gistration( fmri
+00038060: 5f74 656d 706c 6174 652c 206d 302c 2027  _template, m0, '
+00038070: 5269 6769 6427 2c20 7665 7262 6f73 653d  Rigid', verbose=
+00038080: 4661 6c73 6520 290a 2020 2020 6d30 203d  False ).    m0 =
+00038090: 206d 3072 6567 5b27 7761 7270 6564 6d6f   m0reg['warpedmo
+000380a0: 766f 7574 275d 0a0a 2020 6966 206e 7470  vout']..  if ntp
+000380b0: 203d 3d20 3220 3a0a 2020 2020 2020 696d   == 2 :.      im
+000380c0: 6730 203d 2061 6e74 732e 736c 6963 655f  g0 = ants.slice_
+000380d0: 696d 6167 6528 2063 6f72 726d 6f5b 276d  image( corrmo['m
+000380e0: 6f74 696f 6e5f 636f 7272 6563 7465 6427  otion_corrected'
+000380f0: 5d2c 2061 7869 733d 332c 2069 6478 3d30  ], axis=3, idx=0
+00038100: 2029 0a20 2020 2020 2069 6d67 3120 3d20   ).      img1 = 
+00038110: 616e 7473 2e73 6c69 6365 5f69 6d61 6765  ants.slice_image
+00038120: 2820 636f 7272 6d6f 5b27 6d6f 7469 6f6e  ( corrmo['motion
+00038130: 5f63 6f72 7265 6374 6564 275d 2c20 6178  _corrected'], ax
+00038140: 6973 3d33 2c20 6964 783d 3120 290a 2020  is=3, idx=1 ).  
+00038150: 2020 2020 6966 206d 305f 696d 6167 6520      if m0_image 
+00038160: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00038170: 2069 6620 696d 6730 2e6d 6561 6e28 2920   if img0.mean() 
+00038180: 3c20 696d 6731 2e6d 6561 6e28 293a 0a20  < img1.mean():. 
+00038190: 2020 2020 2020 2020 2020 2070 6572 6669             perfi
+000381a0: 6d67 3d69 6d67 300a 2020 2020 2020 2020  mg=img0.        
+000381b0: 2020 2020 6d30 3d69 6d67 310a 2020 2020      m0=img1.    
+000381c0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000381d0: 2020 2020 2020 7065 7266 696d 673d 696d        perfimg=im
+000381e0: 6731 0a20 2020 2020 2020 2020 2020 206d  g1.            m
+000381f0: 303d 696d 6730 0a20 2020 2020 2065 6c73  0=img0.      els
+00038200: 653a 0a20 2020 2020 2020 2069 6620 696d  e:.        if im
+00038210: 6730 2e6d 6561 6e28 2920 3c20 696d 6731  g0.mean() < img1
+00038220: 2e6d 6561 6e28 293a 0a20 2020 2020 2020  .mean():.       
+00038230: 2020 2020 2070 6572 6669 6d67 3d69 6d67       perfimg=img
+00038240: 312d 696d 6730 0a20 2020 2020 2020 2065  1-img0.        e
+00038250: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00038260: 2070 6572 6669 6d67 3d69 6d67 302d 696d   perfimg=img0-im
+00038270: 6731 0a20 200a 2020 6362 6620 3d20 6361  g1.  .  cbf = ca
+00038280: 6c63 756c 6174 655f 4342 4628 2044 656c  lculate_CBF( Del
+00038290: 7461 5f4d 3d70 6572 6669 6d67 2c20 4d5f  ta_M=perfimg, M_
+000382a0: 303d 6d30 2c20 6d61 736b 3d62 6d61 736b  0=m0, mask=bmask
+000382b0: 2029 0a20 206d 6561 6e67 6d76 616c 203d   ).  meangmval =
+000382c0: 2028 2070 6572 6669 6d67 5b20 676d 7365   ( perfimg[ gmse
+000382d0: 6720 3d3d 2031 205d 2029 2e6d 6561 6e28  g == 1 ] ).mean(
+000382e0: 2920 2020 2020 2020 200a 2020 6d65 616e  )        .  mean
+000382f0: 676d 7661 6c63 6266 203d 2028 2063 6266  gmvalcbf = ( cbf
+00038300: 5b20 676d 7365 6720 3d3d 2031 205d 2029  [ gmseg == 1 ] )
+00038310: 2e6d 6561 6e28 290a 2020 6966 2076 6572  .mean().  if ver
+00038320: 626f 7365 3a0a 2020 2020 7072 696e 7428  bose:.    print(
+00038330: 2270 6572 6669 6d67 2e6d 6178 2829 2022  "perfimg.max() "
+00038340: 202b 2073 7472 2820 2070 6572 6669 6d67   + str(  perfimg
+00038350: 2e6d 6178 2829 2029 2029 0a20 206f 7574  .max() ) ).  out
+00038360: 6469 6374 203d 207b 7d0a 2020 6f75 7464  dict = {}.  outd
+00038370: 6963 745b 276d 6561 6e42 6f6c 6427 5d20  ict['meanBold'] 
+00038380: 3d20 756e 640a 2020 6f75 7464 6963 745b  = und.  outdict[
+00038390: 2762 7261 696e 6d61 736b 275d 203d 2062  'brainmask'] = b
+000383a0: 6d61 736b 0a20 2072 7366 4e75 6973 616e  mask.  rsfNuisan
+000383b0: 6365 203d 2070 642e 4461 7461 4672 616d  ce = pd.DataFram
+000383c0: 6528 206e 7569 7361 6e63 6520 290a 2020  e( nuisance ).  
+000383d0: 7273 664e 7569 7361 6e63 655b 2746 4427  rsfNuisance['FD'
+000383e0: 5d3d 636f 7272 6d6f 5b27 4644 275d 0a20  ]=corrmo['FD']. 
+000383f0: 206f 7574 6469 6374 5b27 7065 7266 7573   outdict['perfus
+00038400: 696f 6e27 5d3d 7065 7266 696d 670a 2020  ion']=perfimg.  
+00038410: 6f75 7464 6963 745b 2763 6266 275d 3d63  outdict['cbf']=c
+00038420: 6266 0a20 206f 7574 6469 6374 5b27 6d30  bf.  outdict['m0
+00038430: 275d 3d6d 300a 2020 6f75 7464 6963 745b  ']=m0.  outdict[
+00038440: 2770 6572 6675 7369 6f6e 5f67 6d5f 6d65  'perfusion_gm_me
+00038450: 616e 275d 3d6d 6561 6e67 6d76 616c 0a20  an']=meangmval. 
+00038460: 206f 7574 6469 6374 5b27 6362 665f 676d   outdict['cbf_gm
+00038470: 5f6d 6561 6e27 5d3d 6d65 616e 676d 7661  _mean']=meangmva
+00038480: 6c63 6266 0a20 206f 7574 6469 6374 5b27  lcbf.  outdict['
+00038490: 6d6f 7469 6f6e 5f63 6f72 7265 6374 6564  motion_corrected
+000384a0: 275d 203d 2063 6f72 726d 6f5b 276d 6f74  '] = corrmo['mot
+000384b0: 696f 6e5f 636f 7272 6563 7465 6427 5d0a  ion_corrected'].
+000384c0: 2020 6f75 7464 6963 745b 2762 7261 696e    outdict['brain
+000384d0: 5f6d 6173 6b27 5d20 3d20 626d 6173 6b0a  _mask'] = bmask.
+000384e0: 2020 6f75 7464 6963 745b 276e 7569 7361    outdict['nuisa
+000384f0: 6e63 6527 5d20 3d20 7273 664e 7569 7361  nce'] = rsfNuisa
+00038500: 6e63 650a 2020 6f75 7464 6963 745b 2774  nce.  outdict['t
+00038510: 736e 7227 5d20 3d20 6d79 7473 6e72 0a20  snr'] = mytsnr. 
+00038520: 206f 7574 6469 6374 5b27 6476 6172 7327   outdict['dvars'
+00038530: 5d20 3d20 6476 6172 7328 2063 6f72 726d  ] = dvars( corrm
+00038540: 6f5b 276d 6f74 696f 6e5f 636f 7272 6563  o['motion_correc
+00038550: 7465 6427 5d2c 2067 6d73 6567 2029 0a20  ted'], gmseg ). 
+00038560: 206f 7574 6469 6374 5b27 4644 5f6d 6178   outdict['FD_max
+00038570: 275d 203d 2072 7366 4e75 6973 616e 6365  '] = rsfNuisance
+00038580: 5b27 4644 275d 2e6d 6178 2829 0a20 206f  ['FD'].max().  o
+00038590: 7574 6469 6374 5b27 4644 5f6d 6561 6e27  utdict['FD_mean'
+000385a0: 5d20 3d20 7273 664e 7569 7361 6e63 655b  ] = rsfNuisance[
+000385b0: 2746 4427 5d2e 6d65 616e 2829 0a20 206f  'FD'].mean().  o
+000385c0: 7574 6469 6374 5b27 4644 5f73 6427 5d20  utdict['FD_sd'] 
+000385d0: 3d20 7273 664e 7569 7361 6e63 655b 2746  = rsfNuisance['F
+000385e0: 4427 5d2e 7374 6428 290a 2020 6f75 7464  D'].std().  outd
+000385f0: 6963 745b 276f 7574 6c69 6572 5f76 6f6c  ict['outlier_vol
+00038600: 756d 6573 275d 3d68 6c69 6e64 730a 2020  umes']=hlinds.  
+00038610: 6f75 7464 6963 745b 276e 6567 6174 6976  outdict['negativ
+00038620: 655f 766f 7865 6c73 275d 3d6e 6567 6174  e_voxels']=negat
+00038630: 6976 655f 766f 7865 6c73 0a20 2072 6574  ive_voxels.  ret
+00038640: 7572 6e20 636f 6e76 6572 745f 6e70 5f69  urn convert_np_i
+00038650: 6e5f 6469 6374 2820 6f75 7464 6963 7420  n_dict( outdict 
+00038660: 290a 0a0a 6465 6620 626f 6c64 5f70 6572  )...def bold_per
+00038670: 6675 7369 6f6e 2820 666d 7269 2c20 7431  fusion( fmri, t1
+00038680: 6865 6164 2c20 7431 2c20 7431 7365 676d  head, t1, t1segm
+00038690: 656e 7461 7469 6f6e 2c20 7431 646b 7463  entation, t1dktc
+000386a0: 6974 2c0a 2020 2020 2020 2020 2020 2020  it,.            
+000386b0: 2020 2020 2020 2046 445f 7468 7265 7368         FD_thresh
+000386c0: 6f6c 643d 302e 352c 0a20 2020 2020 2020  old=0.5,.       
+000386d0: 2020 2020 2020 2020 2020 2020 7370 6120              spa 
+000386e0: 3d20 2830 2e2c 2030 2e2c 2030 2e2c 2030  = (0., 0., 0., 0
+000386f0: 2e29 2c0a 2020 2020 2020 2020 2020 2020  .),.            
+00038700: 2020 2020 2020 206e 6320 3d20 332c 0a20         nc = 3,. 
+00038710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038720: 2020 7479 7065 5f6f 665f 7472 616e 7366    type_of_transf
+00038730: 6f72 6d3d 2752 6967 6964 272c 0a20 2020  orm='Rigid',.   
+00038740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038750: 7463 3d27 616c 7465 726e 6174 696e 6727  tc='alternating'
+00038760: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00038770: 2020 2020 206e 5f74 6f5f 7472 696d 3d30       n_to_trim=0
+00038780: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00038790: 2020 2020 206d 305f 696d 6167 6520 3d20       m0_image = 
+000387a0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+000387b0: 2020 2020 2020 2020 206d 305f 696e 6469           m0_indi
+000387c0: 6365 733d 4e6f 6e65 2c0a 2020 2020 2020  ces=None,.      
+000387d0: 2020 2020 2020 2020 2020 2020 206f 7574               out
+000387e0: 6c69 6572 5f74 6872 6573 686f 6c64 3d30  lier_threshold=0
+000387f0: 2e32 3530 2c0a 2020 2020 2020 2020 2020  .250,.          
+00038800: 2020 2020 2020 2020 2061 6464 5f46 445f           add_FD_
+00038810: 746f 5f6e 7569 7361 6e63 653d 4661 6c73  to_nuisance=Fals
+00038820: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00038830: 2020 2020 2020 6e33 3d46 616c 7365 2c0a        n3=False,.
+00038840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038850: 2020 2073 6567 6d65 6e74 5f74 696d 6573     segment_times
+00038860: 6572 6965 733d 4661 6c73 652c 0a20 2020  eries=False,.   
+00038870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038880: 7472 696d 5f74 6865 5f6d 6173 6b3d 342e  trim_the_mask=4.
+00038890: 3235 2c0a 2020 2020 2020 2020 2020 2020  25,.            
+000388a0: 2020 2020 2020 2075 7073 616d 706c 653d         upsample=
+000388b0: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+000388c0: 2020 2020 2020 2020 2070 6572 6675 7369           perfusi
+000388d0: 6f6e 5f72 6567 7265 7373 696f 6e5f 6d6f  on_regression_mo
+000388e0: 6465 6c3d 276c 696e 6561 7227 2c0a 2020  del='linear',.  
+000388f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038900: 2076 6572 626f 7365 3d46 616c 7365 2029   verbose=False )
+00038910: 3a0a 2020 2222 220a 2020 4573 7469 6d61  :.  """.  Estima
+00038920: 7465 2070 6572 6675 7369 6f6e 2066 726f  te perfusion fro
+00038930: 6d20 6120 424f 4c44 2074 696d 6520 7365  m a BOLD time se
+00038940: 7269 6573 2069 6d61 6765 2e20 2057 696c  ries image.  Wil
+00038950: 6c20 6174 7465 6d70 7420 746f 2066 6967  l attempt to fig
+00038960: 7572 6520 6f75 7420 7468 6520 542d 4320  ure out the T-C 
+00038970: 6c61 6265 6c73 2066 726f 6d20 7468 6520  labels from the 
+00038980: 6461 7461 2e20 2054 6865 2066 756e 6374  data.  The funct
+00038990: 696f 6e20 7573 6573 2064 6566 6175 6c74  ion uses default
+000389a0: 7320 746f 2071 7561 6e74 6966 7920 4342  s to quantify CB
+000389b0: 4620 6275 7420 7468 6573 6520 7769 6c6c  F but these will
+000389c0: 2075 7375 616c 6c79 206e 6f74 2062 6520   usually not be 
+000389d0: 636f 7272 6563 7420 666f 7220 796f 7572  correct for your
+000389e0: 206f 776e 2064 6174 612e 2020 5365 6520   own data.  See 
+000389f0: 7468 6520 6675 6e63 7469 6f6e 2063 616c  the function cal
+00038a00: 6375 6c61 7465 5f43 4246 2066 6f72 2061  culate_CBF for a
+00038a10: 6e20 6578 616d 706c 6520 6f66 2068 6f77  n example of how
+00038a20: 206f 6e65 206d 6967 6874 2064 6f20 7175   one might do qu
+00038a30: 616e 7469 6669 6361 7469 6f6e 2062 6173  antification bas
+00038a40: 6564 206f 6e20 7468 6520 6f75 7470 7574  ed on the output
+00038a50: 7320 6f66 2074 6869 7320 6675 6e63 7469  s of this functi
+00038a60: 6f6e 2073 7065 6369 6669 6361 6c6c 7920  on specifically 
+00038a70: 7468 6520 7065 7266 7573 696f 6e2c 206d  the perfusion, m
+00038a80: 3020 616e 6420 6d61 736b 2069 6d61 6765  0 and mask image
+00038a90: 7320 7468 6174 2061 7265 2070 6172 7420  s that are part 
+00038aa0: 6f66 2074 6865 206f 7574 7075 7420 6469  of the output di
+00038ab0: 6374 696f 6e61 7279 2e0a 0a20 2041 7267  ctionary...  Arg
+00038ac0: 756d 656e 7473 0a20 202d 2d2d 2d2d 2d2d  uments.  -------
+00038ad0: 2d2d 0a20 2066 6d72 6920 3a20 424f 4c44  --.  fmri : BOLD
+00038ae0: 2066 6d72 6920 616e 7473 496d 6167 650a   fmri antsImage.
+00038af0: 0a20 2066 6d72 695f 7465 6d70 6c61 7465  .  fmri_template
+00038b00: 203a 2072 6566 6572 656e 6365 2073 7061   : reference spa
+00038b10: 6365 2066 6f72 2042 4f4c 440a 0a20 2074  ce for BOLD..  t
+00038b20: 3168 6561 6420 3a20 414e 5473 496d 6167  1head : ANTsImag
+00038b30: 650a 2020 2020 696e 7075 7420 332d 4420  e.    input 3-D 
+00038b40: 5431 2062 7261 696e 2069 6d61 6765 2028  T1 brain image (
+00038b50: 6e6f 7420 6272 6169 6e20 6578 7472 6163  not brain extrac
+00038b60: 7465 6429 0a0a 2020 7431 203a 2041 4e54  ted)..  t1 : ANT
+00038b70: 7349 6d61 6765 0a20 2020 2069 6e70 7574  sImage.    input
+00038b80: 2033 2d44 2054 3120 6272 6169 6e20 696d   3-D T1 brain im
+00038b90: 6167 6520 2862 7261 696e 2065 7874 7261  age (brain extra
+00038ba0: 6374 6564 290a 0a20 2074 3173 6567 6d65  cted)..  t1segme
+00038bb0: 6e74 6174 696f 6e20 3a20 414e 5473 496d  ntation : ANTsIm
+00038bc0: 6167 650a 2020 2020 7431 2073 6567 6d65  age.    t1 segme
+00038bd0: 6e74 6174 696f 6e20 2d20 6120 7369 7820  ntation - a six 
+00038be0: 7469 7373 7565 2073 6567 6d65 6e74 6174  tissue segmentat
+00038bf0: 696f 6e20 696d 6167 6520 696e 2054 3120  ion image in T1 
+00038c00: 7370 6163 650a 0a20 2074 3164 6b74 6369  space..  t1dktci
+00038c10: 7420 3a20 414e 5473 496d 6167 650a 2020  t : ANTsImage.  
+00038c20: 2020 7431 2064 6b74 2063 6f72 7465 7820    t1 dkt cortex 
+00038c30: 706c 7573 2063 6974 2070 6172 6365 6c6c  plus cit parcell
+00038c40: 6174 696f 6e0a 0a20 2073 7061 203a 2067  ation..  spa : g
+00038c50: 6175 7373 6961 6e20 736d 6f6f 7468 696e  aussian smoothin
+00038c60: 6720 666f 7220 7370 6174 6961 6c20 616e  g for spatial an
+00038c70: 6420 7465 6d70 6f72 616c 2063 6f6d 706f  d temporal compo
+00038c80: 6e65 6e74 2065 2e67 2e20 2831 2c31 2c31  nent e.g. (1,1,1
+00038c90: 2c30 2920 696e 2070 6879 7369 6361 6c20  ,0) in physical 
+00038ca0: 7370 6163 6520 636f 6f72 6469 6e61 7465  space coordinate
+00038cb0: 730a 0a20 206e 6320 203a 206e 756d 6265  s..  nc  : numbe
+00038cc0: 7220 6f66 2063 6f6d 706f 6e65 6e74 7320  r of components 
+00038cd0: 666f 7220 636f 6d70 636f 7220 6669 6c74  for compcor filt
+00038ce0: 6572 696e 670a 0a20 2074 7970 655f 6f66  ering..  type_of
+00038cf0: 5f74 7261 6e73 666f 726d 203a 2053 794e  _transform : SyN
+00038d00: 206f 7220 5269 6769 640a 0a20 2074 633a   or Rigid..  tc:
+00038d10: 2073 7472 696e 6720 6569 7468 6572 2061   string either a
+00038d20: 6c74 6572 6e61 7469 6e67 206f 7220 7370  lternating or sp
+00038d30: 6c69 7420 2864 6566 6175 6c74 2069 7320  lit (default is 
+00038d40: 616c 7465 726e 6174 696e 6720 6965 2043  alternating ie C
+00038d50: 5443 5443 543b 2073 706c 6974 2069 7320  TCTCT; split is 
+00038d60: 4343 4343 5454 5454 290a 0a20 206e 5f74  CCCCTTTT)..  n_t
+00038d70: 6f5f 7472 696d 3a20 6e75 6d62 6572 206f  o_trim: number o
+00038d80: 6620 766f 6c75 6d65 7320 746f 2074 7269  f volumes to tri
+00038d90: 6d20 6f66 6620 7468 6520 6672 6f6e 7420  m off the front 
+00038da0: 6f66 2074 6865 2074 696d 6520 7365 7269  of the time seri
+00038db0: 6573 2074 6f20 6163 636f 756e 7420 666f  es to account fo
+00038dc0: 7220 696e 6974 6961 6c20 6d61 676e 6574  r initial magnet
+00038dd0: 6963 2073 6174 7572 6174 696f 6e20 6566  ic saturation ef
+00038de0: 6665 6374 7320 6f72 2074 6f20 616c 6c6f  fects or to allo
+00038df0: 7720 7468 6520 7369 676e 616c 2074 6f20  w the signal to 
+00038e00: 7265 6163 6820 6120 7374 6561 6479 2073  reach a steady s
+00038e10: 7461 7465 2e20 696e 2073 6f6d 6520 6361  tate. in some ca
+00038e20: 7365 732c 2074 7261 696c 696e 6720 766f  ses, trailing vo
+00038e30: 6c75 6d65 7320 6f72 206f 7468 6572 206f  lumes or other o
+00038e40: 7574 6c69 6572 2076 6f6c 756d 6573 206d  utlier volumes m
+00038e50: 6179 206e 6565 6420 746f 2062 6520 7265  ay need to be re
+00038e60: 6a65 6374 6564 2e20 2074 6869 7320 636f  jected.  this co
+00038e70: 6465 2064 6f65 7320 6e6f 7420 6375 7272  de does not curr
+00038e80: 656e 746c 7920 6861 6e64 6c65 2074 6861  ently handle tha
+00038e90: 7420 6973 7375 652e 0a0a 2020 6d30 5f69  t issue...  m0_i
+00038ea0: 6d61 6765 3a20 6120 7072 652d 6465 6669  mage: a pre-defi
+00038eb0: 6e65 6420 6d30 2069 6d61 6765 202d 2077  ned m0 image - w
+00038ec0: 6520 6578 7065 6374 2074 6869 7320 746f  e expect this to
+00038ed0: 2062 6520 3344 2e20 2069 6620 6974 2069   be 3D.  if it i
+00038ee0: 7320 6e6f 742c 2077 6520 6e61 6976 656c  s not, we naivel
+00038ef0: 7920 0a20 2020 2061 7665 7261 6765 206f  y .    average o
+00038f00: 7665 7220 7468 6520 3474 6820 6469 6d65  ver the 4th dime
+00038f10: 6e73 696f 6e2e 0a0a 2020 6d30 5f69 6e64  nsion...  m0_ind
+00038f20: 6963 6573 3a20 7768 6963 6820 696e 6469  ices: which indi
+00038f30: 6365 7320 696e 2074 6865 2070 6572 6675  ces in the perfu
+00038f40: 7369 6f6e 2069 6d61 6765 2061 7265 2074  sion image are t
+00038f50: 6865 206d 302e 2020 6966 2073 6574 2c20  he m0.  if set, 
+00038f60: 6e5f 746f 5f74 7269 6d20 7769 6c6c 2062  n_to_trim will b
+00038f70: 6520 6967 6e6f 7265 642e 0a0a 2020 6f75  e ignored...  ou
+00038f80: 746c 6965 725f 7468 7265 7368 6f6c 6420  tlier_threshold 
+00038f90: 286e 756d 6572 6963 293a 2062 6574 7765  (numeric): betwe
+00038fa0: 656e 207a 6572 6f20 2872 656d 6f76 6520  en zero (remove 
+00038fb0: 616c 6c29 2061 6e64 206f 6e65 2028 7265  all) and one (re
+00038fc0: 6d6f 7665 206e 6f6e 6529 3b20 6175 746f  move none); auto
+00038fd0: 6d61 7469 6361 6c6c 7920 6361 6c63 756c  matically calcul
+00038fe0: 6174 6573 206f 7574 6c69 6572 6e65 7373  ates outlierness
+00038ff0: 2061 6e64 2075 7365 7320 6974 2074 6f20   and uses it to 
+00039000: 6365 6e73 6f72 2074 6865 2074 696d 6520  censor the time 
+00039010: 7365 7269 6573 2e0a 0a20 2061 6464 5f46  series...  add_F
+00039020: 445f 746f 5f6e 7569 7361 6e63 653a 2062  D_to_nuisance: b
+00039030: 6f6f 6c65 616e 0a0a 2020 6e33 3a20 626f  oolean..  n3: bo
+00039040: 6f6c 6561 6e0a 0a20 2073 6567 6d65 6e74  olean..  segment
+00039050: 5f74 696d 6573 6572 6965 7320 3a20 626f  _timeseries : bo
+00039060: 6f6c 6561 6e0a 0a20 2074 7269 6d5f 7468  olean..  trim_th
+00039070: 655f 6d61 736b 203a 2066 6c6f 6174 203e  e_mask : float >
+00039080: 3d20 3020 706f 7374 2d68 6f63 206d 6574  = 0 post-hoc met
+00039090: 686f 6420 666f 7220 7472 696d 6d69 6e67  hod for trimming
+000390a0: 2074 6865 206d 6173 6b0a 0a20 2075 7073   the mask..  ups
+000390b0: 616d 706c 653a 2062 6f6f 6c65 616e 0a0a  ample: boolean..
+000390c0: 2020 7065 7266 7573 696f 6e5f 7265 6772    perfusion_regr
+000390d0: 6573 7369 6f6e 5f6d 6f64 656c 3a20 7374  ession_model: st
+000390e0: 7269 6e67 2027 6c69 6e65 6172 272c 2027  ring 'linear', '
+000390f0: 7261 6e73 6163 272c 2027 7468 6569 6c73  ransac', 'theils
+00039100: 656e 272c 2027 6875 6265 7227 2c20 2771  en', 'huber', 'q
+00039110: 7561 6e74 696c 6527 2c20 2773 6764 273b  uantile', 'sgd';
+00039120: 2027 6c69 6e65 6172 2720 616e 6420 2768   'linear' and 'h
+00039130: 7562 6572 2720 6172 6520 7468 6520 6f6e  uber' are the on
+00039140: 6c79 206f 6e65 7320 7468 6174 2077 6f72  ly ones that wor
+00039150: 6b20 6f6b 2062 7920 6465 6661 756c 7420  k ok by default 
+00039160: 616e 6420 6172 6520 7265 6c61 7469 7665  and are relative
+00039170: 6c79 2071 7569 636b 2074 6f20 636f 6d70  ly quick to comp
+00039180: 7574 652e 0a0a 2020 7665 7262 6f73 6520  ute...  verbose 
+00039190: 3a20 626f 6f6c 6561 6e0a 0a20 2052 6574  : boolean..  Ret
+000391a0: 7572 6e73 0a20 202d 2d2d 2d2d 2d2d 2d2d  urns.  ---------
+000391b0: 0a20 2061 2064 6963 7469 6f6e 6172 7920  .  a dictionary 
+000391c0: 636f 6e74 6169 6e69 6e67 2074 6865 2064  containing the d
+000391d0: 6572 6976 6564 206e 6574 776f 726b 206d  erived network m
+000391e0: 6170 730a 0a20 2022 2222 0a20 2069 6d70  aps..  """.  imp
+000391f0: 6f72 7420 6e75 6d70 7920 6173 206e 700a  ort numpy as np.
+00039200: 2020 696d 706f 7274 2070 616e 6461 7320    import pandas 
+00039210: 6173 2070 640a 2020 696d 706f 7274 2072  as pd.  import r
+00039220: 650a 2020 696d 706f 7274 206d 6174 680a  e.  import math.
+00039230: 2020 6672 6f6d 2073 6b6c 6561 726e 2e6c    from sklearn.l
+00039240: 696e 6561 725f 6d6f 6465 6c20 696d 706f  inear_model impo
+00039250: 7274 2052 414e 5341 4352 6567 7265 7373  rt RANSACRegress
+00039260: 6f72 2c20 5468 6569 6c53 656e 5265 6772  or, TheilSenRegr
+00039270: 6573 736f 722c 2048 7562 6572 5265 6772  essor, HuberRegr
+00039280: 6573 736f 722c 2051 7561 6e74 696c 6552  essor, QuantileR
+00039290: 6567 7265 7373 6f72 2c20 4c69 6e65 6172  egressor, Linear
+000392a0: 5265 6772 6573 7369 6f6e 2c20 5347 4452  Regression, SGDR
+000392b0: 6567 7265 7373 6f72 0a20 2066 726f 6d20  egressor.  from 
+000392c0: 736b 6c65 6172 6e2e 6d75 6c74 696f 7574  sklearn.multiout
+000392d0: 7075 7420 696d 706f 7274 204d 756c 7469  put import Multi
+000392e0: 4f75 7470 7574 5265 6772 6573 736f 720a  OutputRegressor.
+000392f0: 2020 6672 6f6d 2073 6b6c 6561 726e 2e70    from sklearn.p
+00039300: 7265 7072 6f63 6573 7369 6e67 2069 6d70  reprocessing imp
+00039310: 6f72 7420 5374 616e 6461 7264 5363 616c  ort StandardScal
+00039320: 6572 0a0a 2020 2320 7265 6d6f 7665 206f  er..  # remove o
+00039330: 7574 6c69 6572 2076 6f6c 756d 6573 0a20  utlier volumes. 
+00039340: 2069 6620 7365 676d 656e 745f 7469 6d65   if segment_time
+00039350: 7365 7269 6573 3a0a 2020 2020 6c6f 5f76  series:.    lo_v
+00039360: 735f 6869 6768 203d 2073 6567 6d65 6e74  s_high = segment
+00039370: 5f74 696d 6573 6572 6965 735f 6279 5f6d  _timeseries_by_m
+00039380: 6561 6e76 616c 7565 2866 6d72 6929 0a20  eanvalue(fmri). 
+00039390: 2020 2066 6d72 6920 3d20 7265 6d6f 7665     fmri = remove
+000393a0: 5f76 6f6c 756d 6573 5f66 726f 6d5f 7469  _volumes_from_ti
+000393b0: 6d65 7365 7269 6573 2820 666d 7269 2c20  meseries( fmri, 
+000393c0: 6c6f 5f76 735f 6869 6768 5b27 6c6f 7765  lo_vs_high['lowe
+000393d0: 726d 6561 6e73 275d 2029 0a0a 2020 6578  rmeans'] )..  ex
+000393e0: 5f70 6174 6820 3d20 6f73 2e70 6174 682e  _path = os.path.
+000393f0: 6578 7061 6e64 7573 6572 2820 227e 2f2e  expanduser( "~/.
+00039400: 616e 7473 7079 7431 772f 2220 290a 2020  antspyt1w/" ).  
+00039410: 636e 7863 7376 666e 203d 2065 785f 7061  cnxcsvfn = ex_pa
+00039420: 7468 202b 2022 646b 745f 636f 7274 6578  th + "dkt_cortex
+00039430: 5f63 6974 5f64 6565 705f 6272 6169 6e2e  _cit_deep_brain.
+00039440: 6373 7622 0a0a 2020 6966 206e 333a 0a20  csv"..  if n3:. 
+00039450: 2020 2066 6d72 6920 3d20 7469 6d65 7365     fmri = timese
+00039460: 7269 6573 5f6e 3328 2066 6d72 6920 290a  ries_n3( fmri ).
+00039470: 0a20 2069 6620 6d30 5f69 6d61 6765 2069  .  if m0_image i
+00039480: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00039490: 6966 206d 305f 696d 6167 652e 6469 6d65  if m0_image.dime
+000394a0: 6e73 696f 6e20 3d3d 2034 3a0a 2020 2020  nsion == 4:.    
+000394b0: 2020 6d30 5f69 6d61 6765 203d 2061 6e74    m0_image = ant
+000394c0: 732e 6765 745f 6176 6572 6167 655f 6f66  s.get_average_of
+000394d0: 5f74 696d 6573 6572 6965 7328 206d 305f  _timeseries( m0_
+000394e0: 696d 6167 6520 290a 0a20 2064 6566 2073  image )..  def s
+000394f0: 656c 6563 745f 7265 6772 6573 7369 6f6e  elect_regression
+00039500: 5f6d 6f64 656c 2872 6567 7265 7373 696f  _model(regressio
+00039510: 6e5f 6d6f 6465 6c2c 206d 696e 5f73 616d  n_model, min_sam
+00039520: 706c 6573 3d31 3020 293a 0a20 2020 2069  ples=10 ):.    i
+00039530: 6620 7265 6772 6573 7369 6f6e 5f6d 6f64  f regression_mod
+00039540: 656c 203d 3d20 2773 6764 2720 3a0a 2020  el == 'sgd' :.  
+00039550: 2020 2020 7367 645f 7265 6772 6573 736f      sgd_regresso
+00039560: 7220 3d20 5347 4452 6567 7265 7373 6f72  r = SGDRegressor
+00039570: 2870 656e 616c 7479 3d27 656c 6173 7469  (penalty='elasti
+00039580: 636e 6574 272c 2061 6c70 6861 3d31 652d  cnet', alpha=1e-
+00039590: 352c 206c 315f 7261 7469 6f3d 302e 3135  5, l1_ratio=0.15
+000395a0: 2c20 6d61 785f 6974 6572 3d32 3030 3030  , max_iter=20000
+000395b0: 2c20 746f 6c3d 3165 2d33 2c20 7261 6e64  , tol=1e-3, rand
+000395c0: 6f6d 5f73 7461 7465 3d34 3229 0a20 2020  om_state=42).   
+000395d0: 2020 2072 6574 7572 6e20 7367 645f 7265     return sgd_re
+000395e0: 6772 6573 736f 720a 2020 2020 656c 6966  gressor.    elif
+000395f0: 2072 6567 7265 7373 696f 6e5f 6d6f 6465   regression_mode
+00039600: 6c20 3d3d 2027 7261 6e73 6163 273a 0a20  l == 'ransac':. 
+00039610: 2020 2020 2072 616e 7361 6320 3d20 5241       ransac = RA
+00039620: 4e53 4143 5265 6772 6573 736f 7228 0a20  NSACRegressor(. 
+00039630: 2020 2020 2020 2020 2020 206d 696e 5f73             min_s
+00039640: 616d 706c 6573 3d30 2e38 2c0a 2020 2020  amples=0.8,.    
+00039650: 2020 2020 2020 2020 6d61 785f 7472 6961          max_tria
+00039660: 6c73 3d31 302c 2020 2020 2020 2020 2023  ls=10,         #
+00039670: 204d 6178 696d 756d 206e 756d 6265 7220   Maximum number 
+00039680: 6f66 2069 7465 7261 7469 6f6e 730a 2320  of iterations.# 
+00039690: 2020 2020 2020 2020 2020 206d 696e 5f73             min_s
+000396a0: 616d 706c 6573 3d6d 696e 5f73 616d 706c  amples=min_sampl
+000396b0: 6573 2c20 2320 4d69 6e69 6d75 6d20 6e75  es, # Minimum nu
+000396c0: 6d62 6572 2073 616d 706c 6573 2074 6f20  mber samples to 
+000396d0: 6265 2063 686f 7365 6e20 6173 2069 6e6c  be chosen as inl
+000396e0: 6965 7273 2069 6e20 6561 6368 2069 7465  iers in each ite
+000396f0: 7261 7469 6f6e 0a23 2020 2020 2020 2020  ration.#        
+00039700: 2020 2020 7374 6f70 5f70 726f 6261 6269      stop_probabi
+00039710: 6c69 7479 3d30 2e38 302c 2020 2320 5072  lity=0.80,  # Pr
+00039720: 6f62 6162 696c 6974 7920 746f 2073 746f  obability to sto
+00039730: 7020 7468 6520 616c 676f 7269 7468 6d20  p the algorithm 
+00039740: 6966 2061 2067 6f6f 6420 7375 6273 6574  if a good subset
+00039750: 2069 7320 666f 756e 640a 2320 2020 2020   is found.#     
+00039760: 2020 2020 2020 2073 746f 705f 6e5f 696e         stop_n_in
+00039770: 6c69 6572 733d 3430 2c20 2020 2020 2023  liers=40,      #
+00039780: 2053 746f 7020 6966 2074 6869 7320 6e75   Stop if this nu
+00039790: 6d62 6572 206f 6620 696e 6c69 6572 7320  mber of inliers 
+000397a0: 6973 2066 6f75 6e64 0a23 2020 2020 2020  is found.#      
+000397b0: 2020 2020 2020 7374 6f70 5f73 636f 7265        stop_score
+000397c0: 3d30 2e38 2c20 2020 2020 2020 2020 2320  =0.8,         # 
+000397d0: 5374 6f70 2069 6620 7468 6520 6d6f 6465  Stop if the mode
+000397e0: 6c20 7363 6f72 6520 7265 6163 6865 7320  l score reaches 
+000397f0: 7468 6973 2076 616c 7565 0a23 2020 2020  this value.#    
+00039800: 2020 2020 2020 2020 6e5f 6a6f 6273 3d69          n_jobs=i
+00039810: 6e74 286f 732e 6765 7465 6e76 2822 4954  nt(os.getenv("IT
+00039820: 4b5f 474c 4f42 414c 5f44 4546 4155 4c54  K_GLOBAL_DEFAULT
+00039830: 5f4e 554d 4245 525f 4f46 5f54 4852 4541  _NUMBER_OF_THREA
+00039840: 4453 2229 2920 2320 5573 6520 616c 6c20  DS")) # Use all 
+00039850: 6176 6169 6c61 626c 6520 4350 5520 636f  available CPU co
+00039860: 7265 7320 666f 7220 7061 7261 6c6c 656c  res for parallel
+00039870: 2070 726f 6365 7373 696e 670a 2020 2020   processing.    
+00039880: 2020 2020 290a 2020 2020 2020 7265 7475      ).      retu
+00039890: 726e 2072 616e 7361 630a 2020 2020 6d6f  rn ransac.    mo
+000398a0: 6465 6c73 203d 207b 0a20 2020 2020 2020  dels = {.       
+000398b0: 2027 7367 6427 3a53 4744 5265 6772 6573   'sgd':SGDRegres
+000398c0: 736f 722c 0a20 2020 2020 2020 2027 7261  sor,.        'ra
+000398d0: 6e73 6163 273a 2052 414e 5341 4352 6567  nsac': RANSACReg
+000398e0: 7265 7373 6f72 2c0a 2020 2020 2020 2020  ressor,.        
+000398f0: 2774 6865 696c 7365 6e27 3a20 5468 6569  'theilsen': Thei
+00039900: 6c53 656e 5265 6772 6573 736f 722c 0a20  lSenRegressor,. 
+00039910: 2020 2020 2020 2027 6875 6265 7227 3a20         'huber': 
+00039920: 4875 6265 7252 6567 7265 7373 6f72 2c0a  HuberRegressor,.
+00039930: 2020 2020 2020 2020 2771 7561 6e74 696c          'quantil
+00039940: 6527 3a20 5175 616e 7469 6c65 5265 6772  e': QuantileRegr
+00039950: 6573 736f 720a 2020 2020 7d0a 2020 2020  essor.    }.    
+00039960: 7265 7475 726e 206d 6f64 656c 732e 6765  return models.ge
+00039970: 7428 7265 6772 6573 7369 6f6e 5f6d 6f64  t(regression_mod
+00039980: 656c 2e6c 6f77 6572 2829 2c20 4c69 6e65  el.lower(), Line
+00039990: 6172 5265 6772 6573 7369 6f6e 2928 290a  arRegression)().
+000399a0: 0a20 2064 6566 2072 6570 6c69 6361 7465  .  def replicate
+000399b0: 5f6c 6973 7428 7573 6572 5f6c 6973 742c  _list(user_list,
+000399c0: 2074 6172 6765 745f 7369 7a65 293a 0a20   target_size):. 
+000399d0: 2020 2023 2043 616c 6375 6c61 7465 2074     # Calculate t
+000399e0: 6865 206e 756d 6265 7220 6f66 2074 696d  he number of tim
+000399f0: 6573 2074 6865 206c 6973 7420 7368 6f75  es the list shou
+00039a00: 6c64 2062 6520 7265 706c 6963 6174 6564  ld be replicated
+00039a10: 0a20 2020 2072 6570 6c69 6361 7469 6f6e  .    replication
+00039a20: 5f66 6163 746f 7220 3d20 7461 7267 6574  _factor = target
+00039a30: 5f73 697a 6520 2f2f 206c 656e 2875 7365  _size // len(use
+00039a40: 725f 6c69 7374 290a 2020 2020 2320 5265  r_list).    # Re
+00039a50: 706c 6963 6174 6520 7468 6520 6c69 7374  plicate the list
+00039a60: 2061 6e64 2068 616e 646c 6520 616e 7920   and handle any 
+00039a70: 7265 6d61 696e 696e 6720 656c 656d 656e  remaining elemen
+00039a80: 7473 0a20 2020 2072 6570 6c69 6361 7465  ts.    replicate
+00039a90: 645f 6c69 7374 203d 2075 7365 725f 6c69  d_list = user_li
+00039aa0: 7374 202a 2072 6570 6c69 6361 7469 6f6e  st * replication
+00039ab0: 5f66 6163 746f 720a 2020 2020 7265 6d61  _factor.    rema
+00039ac0: 696e 696e 675f 656c 656d 656e 7473 203d  ining_elements =
+00039ad0: 2074 6172 6765 745f 7369 7a65 2025 206c   target_size % l
+00039ae0: 656e 2875 7365 725f 6c69 7374 290a 2020  en(user_list).  
+00039af0: 2020 7265 706c 6963 6174 6564 5f6c 6973    replicated_lis
+00039b00: 7420 2b3d 2075 7365 725f 6c69 7374 5b3a  t += user_list[:
+00039b10: 7265 6d61 696e 696e 675f 656c 656d 656e  remaining_elemen
+00039b20: 7473 5d0a 2020 2020 7265 7475 726e 2072  ts].    return r
+00039b30: 6570 6c69 6361 7465 645f 6c69 7374 0a0a  eplicated_list..
+00039b40: 2020 6465 6620 6f6e 655f 686f 745f 656e    def one_hot_en
+00039b50: 636f 6465 2863 6861 725f 6c69 7374 293a  code(char_list):
+00039b60: 0a20 2020 2075 6e69 7175 655f 6368 6172  .    unique_char
+00039b70: 7320 3d20 6c69 7374 2873 6574 2863 6861  s = list(set(cha
+00039b80: 725f 6c69 7374 2929 0a20 2020 2065 6e63  r_list)).    enc
+00039b90: 6f64 696e 675f 6469 6374 203d 207b 6368  oding_dict = {ch
+00039ba0: 6172 3a20 5b31 2069 6620 6368 6172 203d  ar: [1 if char =
+00039bb0: 3d20 6320 656c 7365 2030 2066 6f72 2063  = c else 0 for c
+00039bc0: 2069 6e20 756e 6971 7565 5f63 6861 7273   in unique_chars
+00039bd0: 5d20 666f 7220 6368 6172 2069 6e20 756e  ] for char in un
+00039be0: 6971 7565 5f63 6861 7273 7d0a 2020 2020  ique_chars}.    
+00039bf0: 656e 636f 6465 645f 6d61 7472 6978 203d  encoded_matrix =
+00039c00: 206e 702e 6172 7261 7928 5b65 6e63 6f64   np.array([encod
+00039c10: 696e 675f 6469 6374 5b63 6861 725d 2066  ing_dict[char] f
+00039c20: 6f72 2063 6861 7220 696e 2063 6861 725f  or char in char_
+00039c30: 6c69 7374 5d29 0a20 2020 2072 6574 7572  list]).    retur
+00039c40: 6e20 656e 636f 6465 645f 6d61 7472 6978  n encoded_matrix
+00039c50: 0a20 200a 2020 4120 3d20 6e70 2e7a 6572  .  .  A = np.zer
+00039c60: 6f73 2828 312c 3129 290a 2020 2320 666d  os((1,1)).  # fm
+00039c70: 7269 203d 2061 6e74 732e 694d 6174 6828  ri = ants.iMath(
+00039c80: 2066 6d72 692c 2027 4e6f 726d 616c 697a   fmri, 'Normaliz
+00039c90: 6527 2029 0a20 2066 6d72 695f 7465 6d70  e' ).  fmri_temp
+00039ca0: 6c61 7465 2c20 686c 696e 6473 203d 206c  late, hlinds = l
+00039cb0: 6f6f 705f 7469 6d65 7365 7269 6573 5f63  oop_timeseries_c
+00039cc0: 656e 736f 7269 6e67 2820 666d 7269 2c20  ensoring( fmri, 
+00039cd0: 302e 3130 2029 0a20 2066 6d72 695f 7465  0.10 ).  fmri_te
+00039ce0: 6d70 6c61 7465 203d 2061 6e74 732e 6765  mplate = ants.ge
+00039cf0: 745f 6176 6572 6167 655f 6f66 5f74 696d  t_average_of_tim
+00039d00: 6573 6572 6965 7328 2066 6d72 695f 7465  eseries( fmri_te
+00039d10: 6d70 6c61 7465 2029 0a20 2064 656c 2068  mplate ).  del h
+00039d20: 6c69 6e64 730a 2020 7269 6720 3d20 616e  linds.  rig = an
+00039d30: 7473 2e72 6567 6973 7472 6174 696f 6e28  ts.registration(
+00039d40: 2066 6d72 695f 7465 6d70 6c61 7465 2c20   fmri_template, 
+00039d50: 7431 6865 6164 2c20 2742 4f4c 4452 6967  t1head, 'BOLDRig
+00039d60: 6964 2720 290a 2020 626d 6173 6b20 3d20  id' ).  bmask = 
+00039d70: 616e 7473 2e61 7070 6c79 5f74 7261 6e73  ants.apply_trans
+00039d80: 666f 726d 7328 2066 6d72 695f 7465 6d70  forms( fmri_temp
+00039d90: 6c61 7465 2c20 616e 7473 2e74 6872 6573  late, ants.thres
+00039da0: 686f 6c64 5f69 6d61 6765 2874 3173 6567  hold_image(t1seg
+00039db0: 6d65 6e74 6174 696f 6e2c 312c 3629 2c20  mentation,1,6), 
+00039dc0: 7269 675b 2766 7764 7472 616e 7366 6f72  rig['fwdtransfor
+00039dd0: 6d73 275d 5b30 5d2c 2069 6e74 6572 706f  ms'][0], interpo
+00039de0: 6c61 746f 723d 2767 656e 6572 6963 4c61  lator='genericLa
+00039df0: 6265 6c27 2029 0a20 2069 6620 6d30 5f69  bel' ).  if m0_i
+00039e00: 6e64 6963 6573 2069 7320 4e6f 6e65 3a0a  ndices is None:.
+00039e10: 2020 2020 6966 206e 5f74 6f5f 7472 696d      if n_to_trim
+00039e20: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00039e30: 2020 6e5f 746f 5f74 7269 6d3d 300a 2020    n_to_trim=0.  
+00039e40: 2020 6d79 7472 696d 3d6e 5f74 6f5f 7472    mytrim=n_to_tr
+00039e50: 696d 0a20 2065 6c73 653a 0a20 2020 206d  im.  else:.    m
+00039e60: 7974 7269 6d20 3d20 300a 2020 7065 7266  ytrim = 0.  perf
+00039e70: 5f74 6f74 616c 5f73 6967 6d61 203d 2031  _total_sigma = 1
+00039e80: 2e35 0a20 2063 6f72 726d 6f20 3d20 7469  .5.  corrmo = ti
+00039e90: 6d65 7365 7269 6573 5f72 6567 280a 2020  meseries_reg(.  
+00039ea0: 2020 666d 7269 2c20 666d 7269 5f74 656d    fmri, fmri_tem
+00039eb0: 706c 6174 652c 0a20 2020 2074 7970 655f  plate,.    type_
+00039ec0: 6f66 5f74 7261 6e73 666f 726d 3d74 7970  of_transform=typ
+00039ed0: 655f 6f66 5f74 7261 6e73 666f 726d 2c0a  e_of_transform,.
+00039ee0: 2020 2020 746f 7461 6c5f 7369 676d 613d      total_sigma=
+00039ef0: 7065 7266 5f74 6f74 616c 5f73 6967 6d61  perf_total_sigma
+00039f00: 2c0a 2020 2020 6664 4f66 6673 6574 3d32  ,.    fdOffset=2
+00039f10: 2e30 2c0a 2020 2020 7472 696d 203d 206d  .0,.    trim = m
+00039f20: 7974 7269 6d2c 0a20 2020 206f 7574 7075  ytrim,.    outpu
+00039f30: 745f 6469 7265 6374 6f72 793d 4e6f 6e65  t_directory=None
+00039f40: 2c0a 2020 2020 7665 7262 6f73 653d 7665  ,.    verbose=ve
+00039f50: 7262 6f73 652c 0a20 2020 2073 796e 5f6d  rbose,.    syn_m
+00039f60: 6574 7269 633d 2763 6327 2c0a 2020 2020  etric='cc',.    
+00039f70: 7379 6e5f 7361 6d70 6c69 6e67 3d32 2c0a  syn_sampling=2,.
+00039f80: 2020 2020 7265 675f 6974 6572 6174 696f      reg_iteratio
+00039f90: 6e73 3d5b 3430 2c32 302c 355d 2029 0a20  ns=[40,20,5] ). 
+00039fa0: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+00039fb0: 2020 2070 7269 6e74 2822 456e 6420 7273     print("End rs
+00039fc0: 666d 7269 206d 6f74 696f 6e20 636f 7272  fmri motion corr
+00039fd0: 6563 7469 6f6e 2229 0a0a 2020 6966 206d  ection")..  if m
+00039fe0: 305f 696d 6167 6520 6973 206e 6f74 204e  0_image is not N
+00039ff0: 6f6e 653a 0a20 2020 2020 206d 3020 3d20  one:.      m0 = 
+0003a000: 6d30 5f69 6d61 6765 0a20 2065 6c69 6620  m0_image.  elif 
+0003a010: 6d30 5f69 6e64 6963 6573 2069 7320 6e6f  m0_indices is no
+0003a020: 7420 4e6f 6e65 3a0a 2020 2020 6e6f 745f  t None:.    not_
+0003a030: 6d30 203d 206c 6973 7428 2072 616e 6765  m0 = list( range
+0003a040: 2820 666d 7269 2e73 6861 7065 5b33 5d20  ( fmri.shape[3] 
+0003a050: 2920 290a 2020 2020 6e6f 745f 6d30 203d  ) ).    not_m0 =
+0003a060: 205b 7820 666f 7220 7820 696e 206e 6f74   [x for x in not
+0003a070: 5f6d 3020 6966 2078 206e 6f74 2069 6e20  _m0 if x not in 
+0003a080: 6d30 5f69 6e64 6963 6573 5d0a 2020 2020  m0_indices].    
+0003a090: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+0003a0a0: 2020 2020 7072 696e 7428 206d 305f 696e      print( m0_in
+0003a0b0: 6469 6365 7320 290a 2020 2020 2020 2020  dices ).        
+0003a0c0: 7072 696e 7428 206e 6f74 5f6d 3020 290a  print( not_m0 ).
+0003a0d0: 2020 2020 2320 7468 656e 2072 656d 6f76      # then remov
+0003a0e0: 6520 6974 2066 726f 6d20 7468 6520 7469  e it from the ti
+0003a0f0: 6d65 2073 6572 6965 730a 2020 2020 6d30  me series.    m0
+0003a100: 203d 2072 656d 6f76 655f 766f 6c75 6d65   = remove_volume
+0003a110: 735f 6672 6f6d 5f74 696d 6573 6572 6965  s_from_timeserie
+0003a120: 7328 2063 6f72 726d 6f5b 276d 6f74 696f  s( corrmo['motio
+0003a130: 6e5f 636f 7272 6563 7465 6427 5d2c 206e  n_corrected'], n
+0003a140: 6f74 5f6d 3020 290a 2020 2020 6d30 203d  ot_m0 ).    m0 =
+0003a150: 2061 6e74 732e 6765 745f 6176 6572 6167   ants.get_averag
+0003a160: 655f 6f66 5f74 696d 6573 6572 6965 7328  e_of_timeseries(
+0003a170: 206d 3020 290a 2020 2020 636f 7272 6d6f   m0 ).    corrmo
+0003a180: 5b27 6d6f 7469 6f6e 5f63 6f72 7265 6374  ['motion_correct
+0003a190: 6564 275d 203d 2072 656d 6f76 655f 766f  ed'] = remove_vo
+0003a1a0: 6c75 6d65 735f 6672 6f6d 5f74 696d 6573  lumes_from_times
+0003a1b0: 6572 6965 7328 200a 2020 2020 2020 2020  eries( .        
+0003a1c0: 636f 7272 6d6f 5b27 6d6f 7469 6f6e 5f63  corrmo['motion_c
+0003a1d0: 6f72 7265 6374 6564 275d 2c20 6d30 5f69  orrected'], m0_i
+0003a1e0: 6e64 6963 6573 2029 0a20 2020 2063 6f72  ndices ).    cor
+0003a1f0: 726d 6f5b 2746 4427 5d20 3d20 7265 6d6f  rmo['FD'] = remo
+0003a200: 7665 5f65 6c65 6d65 6e74 735f 6672 6f6d  ve_elements_from
+0003a210: 5f6e 756d 7079 5f61 7272 6179 2820 636f  _numpy_array( co
+0003a220: 7272 6d6f 5b27 4644 275d 2c20 6d30 5f69  rrmo['FD'], m0_i
+0003a230: 6e64 6963 6573 2029 0a20 2020 2066 6d72  ndices ).    fmr
+0003a240: 6920 3d20 7265 6d6f 7665 5f76 6f6c 756d  i = remove_volum
+0003a250: 6573 5f66 726f 6d5f 7469 6d65 7365 7269  es_from_timeseri
+0003a260: 6573 2820 666d 7269 2c20 6d30 5f69 6e64  es( fmri, m0_ind
+0003a270: 6963 6573 2029 0a0a 2020 6e74 7020 3d20  ices )..  ntp = 
+0003a280: 636f 7272 6d6f 5b27 6d6f 7469 6f6e 5f63  corrmo['motion_c
+0003a290: 6f72 7265 6374 6564 275d 2e73 6861 7065  orrected'].shape
+0003a2a0: 5b33 5d0a 2020 6966 2074 6320 3d3d 2027  [3].  if tc == '
+0003a2b0: 616c 7465 726e 6174 696e 6727 3a0a 2020  alternating':.  
+0003a2c0: 2020 2020 7463 6c69 7374 203d 2072 6570      tclist = rep
+0003a2d0: 6c69 6361 7465 5f6c 6973 7428 205b 2743  licate_list( ['C
+0003a2e0: 272c 2754 275d 2c20 6e74 7020 290a 2020  ','T'], ntp ).  
+0003a2f0: 656c 7365 3a0a 2020 2020 2020 7463 6c69  else:.      tcli
+0003a300: 7374 203d 2072 6570 6c69 6361 7465 5f6c  st = replicate_l
+0003a310: 6973 7428 205b 2743 275d 2c20 696e 7428  ist( ['C'], int(
+0003a320: 6e74 702f 3229 2029 202b 2072 6570 6c69  ntp/2) ) + repli
+0003a330: 6361 7465 5f6c 6973 7428 205b 2754 275d  cate_list( ['T']
+0003a340: 2c20 2069 6e74 286e 7470 2f32 2920 290a  ,  int(ntp/2) ).
+0003a350: 0a20 2074 636c 6973 7420 3d20 6f6e 655f  .  tclist = one_
+0003a360: 686f 745f 656e 636f 6465 2820 7463 6c69  hot_encode( tcli
+0003a370: 7374 5b30 3a6e 7470 205d 2029 0a20 2066  st[0:ntp ] ).  f
+0003a380: 6d72 696d 6f74 636f 7272 3d63 6f72 726d  mrimotcorr=corrm
+0003a390: 6f5b 276d 6f74 696f 6e5f 636f 7272 6563  o['motion_correc
+0003a3a0: 7465 6427 5d0a 2020 6966 206f 7574 6c69  ted'].  if outli
+0003a3b0: 6572 5f74 6872 6573 686f 6c64 203c 2031  er_threshold < 1
+0003a3c0: 2e30 2061 6e64 206f 7574 6c69 6572 5f74  .0 and outlier_t
+0003a3d0: 6872 6573 686f 6c64 203e 2030 2e30 3a0a  hreshold > 0.0:.
+0003a3e0: 2020 2020 666d 7269 6d6f 7463 6f72 722c      fmrimotcorr,
+0003a3f0: 2068 6c69 6e64 7320 3d20 6c6f 6f70 5f74   hlinds = loop_t
+0003a400: 696d 6573 6572 6965 735f 6365 6e73 6f72  imeseries_censor
+0003a410: 696e 6728 2066 6d72 696d 6f74 636f 7272  ing( fmrimotcorr
+0003a420: 2c20 6f75 746c 6965 725f 7468 7265 7368  , outlier_thresh
+0003a430: 6f6c 642c 206d 6173 6b3d 4e6f 6e65 2c20  old, mask=None, 
+0003a440: 7665 7262 6f73 653d 7665 7262 6f73 6520  verbose=verbose 
+0003a450: 290a 2020 2020 7463 6c69 7374 203d 2072  ).    tclist = r
+0003a460: 656d 6f76 655f 656c 656d 656e 7473 5f66  emove_elements_f
+0003a470: 726f 6d5f 6e75 6d70 795f 6172 7261 7928  rom_numpy_array(
+0003a480: 2074 636c 6973 742c 2068 6c69 6e64 7329   tclist, hlinds)
+0003a490: 0a20 2020 2063 6f72 726d 6f5b 2746 4427  .    corrmo['FD'
+0003a4a0: 5d20 3d20 7265 6d6f 7665 5f65 6c65 6d65  ] = remove_eleme
+0003a4b0: 6e74 735f 6672 6f6d 5f6e 756d 7079 5f61  nts_from_numpy_a
+0003a4c0: 7272 6179 2820 636f 7272 6d6f 5b27 4644  rray( corrmo['FD
+0003a4d0: 275d 2c20 686c 696e 6473 2029 0a0a 2020  '], hlinds )..  
+0003a4e0: 2320 7265 646f 2074 656d 706c 6174 6520  # redo template 
+0003a4f0: 616e 6420 7265 6769 7374 7261 7469 6f6e  and registration
+0003a500: 2061 7420 2870 6f74 656e 7469 616c 6c79   at (potentially
+0003a510: 2920 7570 7361 6d70 6c65 6420 7363 616c  ) upsampled scal
+0003a520: 650a 2020 666d 7269 5f74 656d 706c 6174  e.  fmri_templat
+0003a530: 6520 3d20 616e 7473 2e69 4d61 7468 2820  e = ants.iMath( 
+0003a540: 616e 7473 2e67 6574 5f61 7665 7261 6765  ants.get_average
+0003a550: 5f6f 665f 7469 6d65 7365 7269 6573 2820  _of_timeseries( 
+0003a560: 666d 7269 6d6f 7463 6f72 7220 292c 2022  fmrimotcorr ), "
+0003a570: 4e6f 726d 616c 697a 6522 2029 0a20 2069  Normalize" ).  i
+0003a580: 6620 7570 7361 6d70 6c65 3a0a 2020 2020  f upsample:.    
+0003a590: 2020 7370 6320 3d20 616e 7473 2e67 6574    spc = ants.get
+0003a5a0: 5f73 7061 6369 6e67 2820 666d 7269 2029  _spacing( fmri )
+0003a5b0: 0a20 2020 2020 206d 696e 7370 6320 3d20  .      minspc = 
+0003a5c0: 322e 300a 2020 2020 2020 6966 206d 696e  2.0.      if min
+0003a5d0: 2873 7063 5b30 3a33 5d29 203c 206d 696e  (spc[0:3]) < min
+0003a5e0: 7370 633a 0a20 2020 2020 2020 2020 206d  spc:.          m
+0003a5f0: 696e 7370 6320 3d20 6d69 6e28 7370 635b  inspc = min(spc[
+0003a600: 303a 335d 290a 2020 2020 2020 6e65 7773  0:3]).      news
+0003a610: 7063 203d 205b 6d69 6e73 7063 2c6d 696e  pc = [minspc,min
+0003a620: 7370 632c 6d69 6e73 7063 5d0a 2020 2020  spc,minspc].    
+0003a630: 2020 666d 7269 5f74 656d 706c 6174 6520    fmri_template 
+0003a640: 3d20 616e 7473 2e72 6573 616d 706c 655f  = ants.resample_
+0003a650: 696d 6167 6528 2066 6d72 695f 7465 6d70  image( fmri_temp
+0003a660: 6c61 7465 2c20 6e65 7773 7063 2c20 696e  late, newspc, in
+0003a670: 7465 7270 5f74 7970 653d 3020 290a 0a20  terp_type=0 ).. 
+0003a680: 2072 6967 203d 2061 6e74 732e 7265 6769   rig = ants.regi
+0003a690: 7374 7261 7469 6f6e 2820 666d 7269 5f74  stration( fmri_t
+0003a6a0: 656d 706c 6174 652c 2074 3168 6561 642c  emplate, t1head,
+0003a6b0: 2027 424f 4c44 5269 6769 6427 2029 0a20   'BOLDRigid' ). 
+0003a6c0: 2062 6d61 736b 203d 2061 6e74 732e 6170   bmask = ants.ap
+0003a6d0: 706c 795f 7472 616e 7366 6f72 6d73 2820  ply_transforms( 
+0003a6e0: 666d 7269 5f74 656d 706c 6174 652c 200a  fmri_template, .
+0003a6f0: 2020 2020 616e 7473 2e74 6872 6573 686f      ants.thresho
+0003a700: 6c64 5f69 6d61 6765 2874 3173 6567 6d65  ld_image(t1segme
+0003a710: 6e74 6174 696f 6e2c 312c 3629 2c20 0a20  ntation,1,6), . 
+0003a720: 2020 2072 6967 5b27 6677 6474 7261 6e73     rig['fwdtrans
+0003a730: 666f 726d 7327 5d5b 305d 2c20 0a20 2020  forms'][0], .   
+0003a740: 2069 6e74 6572 706f 6c61 746f 723d 2767   interpolator='g
+0003a750: 656e 6572 6963 4c61 6265 6c27 2029 0a20  enericLabel' ). 
+0003a760: 2063 6f72 726d 6f20 3d20 7469 6d65 7365   corrmo = timese
+0003a770: 7269 6573 5f72 6567 280a 2020 2020 2020  ries_reg(.      
+0003a780: 2020 666d 7269 2c20 666d 7269 5f74 656d    fmri, fmri_tem
+0003a790: 706c 6174 652c 0a20 2020 2020 2020 2074  plate,.        t
+0003a7a0: 7970 655f 6f66 5f74 7261 6e73 666f 726d  ype_of_transform
+0003a7b0: 3d74 7970 655f 6f66 5f74 7261 6e73 666f  =type_of_transfo
+0003a7c0: 726d 2c0a 2020 2020 2020 2020 746f 7461  rm,.        tota
+0003a7d0: 6c5f 7369 676d 613d 7065 7266 5f74 6f74  l_sigma=perf_tot
+0003a7e0: 616c 5f73 6967 6d61 2c0a 2020 2020 2020  al_sigma,.      
+0003a7f0: 2020 6664 4f66 6673 6574 3d32 2e30 2c0a    fdOffset=2.0,.
+0003a800: 2020 2020 2020 2020 7472 696d 203d 206d          trim = m
+0003a810: 7974 7269 6d2c 0a20 2020 2020 2020 206f  ytrim,.        o
+0003a820: 7574 7075 745f 6469 7265 6374 6f72 793d  utput_directory=
+0003a830: 4e6f 6e65 2c0a 2020 2020 2020 2020 7665  None,.        ve
+0003a840: 7262 6f73 653d 7665 7262 6f73 652c 0a20  rbose=verbose,. 
+0003a850: 2020 2020 2020 2073 796e 5f6d 6574 7269         syn_metri
+0003a860: 633d 2763 6327 2c0a 2020 2020 2020 2020  c='cc',.        
+0003a870: 7379 6e5f 7361 6d70 6c69 6e67 3d32 2c0a  syn_sampling=2,.
+0003a880: 2020 2020 2020 2020 7265 675f 6974 6572          reg_iter
+0003a890: 6174 696f 6e73 3d5b 3430 2c32 302c 355d  ations=[40,20,5]
+0003a8a0: 2029 0a20 2069 6620 7665 7262 6f73 653a   ).  if verbose:
+0003a8b0: 0a20 2020 2020 2020 2070 7269 6e74 2822  .        print("
+0003a8c0: 456e 6420 326e 6420 7273 666d 7269 206d  End 2nd rsfmri m
+0003a8d0: 6f74 696f 6e20 636f 7272 6563 7469 6f6e  otion correction
+0003a8e0: 2229 0a0a 2020 6966 206f 7574 6c69 6572  ")..  if outlier
+0003a8f0: 5f74 6872 6573 686f 6c64 203c 2031 2e30  _threshold < 1.0
+0003a900: 2061 6e64 206f 7574 6c69 6572 5f74 6872   and outlier_thr
+0003a910: 6573 686f 6c64 203e 2030 2e30 3a0a 2020  eshold > 0.0:.  
+0003a920: 2020 636f 7272 6d6f 5b27 6d6f 7469 6f6e    corrmo['motion
+0003a930: 5f63 6f72 7265 6374 6564 275d 203d 2072  _corrected'] = r
+0003a940: 656d 6f76 655f 766f 6c75 6d65 735f 6672  emove_volumes_fr
+0003a950: 6f6d 5f74 696d 6573 6572 6965 7328 2063  om_timeseries( c
+0003a960: 6f72 726d 6f5b 276d 6f74 696f 6e5f 636f  orrmo['motion_co
+0003a970: 7272 6563 7465 6427 5d2c 2068 6c69 6e64  rrected'], hlind
+0003a980: 7320 290a 2020 2020 636f 7272 6d6f 5b27  s ).    corrmo['
+0003a990: 4644 275d 203d 2072 656d 6f76 655f 656c  FD'] = remove_el
+0003a9a0: 656d 656e 7473 5f66 726f 6d5f 6e75 6d70  ements_from_nump
+0003a9b0: 795f 6172 7261 7928 2063 6f72 726d 6f5b  y_array( corrmo[
+0003a9c0: 2746 4427 5d2c 2068 6c69 6e64 7320 290a  'FD'], hlinds ).
+0003a9d0: 0a20 2072 6567 7265 7373 696f 6e5f 6d61  .  regression_ma
+0003a9e0: 736b 203d 2062 6d61 736b 2e63 6c6f 6e65  sk = bmask.clone
+0003a9f0: 2829 0a20 206d 7974 736e 7220 3d20 7473  ().  mytsnr = ts
+0003aa00: 6e72 2820 636f 7272 6d6f 5b27 6d6f 7469  nr( corrmo['moti
+0003aa10: 6f6e 5f63 6f72 7265 6374 6564 275d 2c20  on_corrected'], 
+0003aa20: 626d 6173 6b20 290a 2020 6d79 7473 6e72  bmask ).  mytsnr
+0003aa30: 5468 7265 7368 203d 206e 702e 7175 616e  Thresh = np.quan
+0003aa40: 7469 6c65 2820 6d79 7473 6e72 2e6e 756d  tile( mytsnr.num
+0003aa50: 7079 2829 2c20 302e 3939 3520 290a 2020  py(), 0.995 ).  
+0003aa60: 7473 6e72 6d61 736b 203d 2061 6e74 732e  tsnrmask = ants.
+0003aa70: 7468 7265 7368 6f6c 645f 696d 6167 6528  threshold_image(
+0003aa80: 206d 7974 736e 722c 2030 2c20 6d79 7473   mytsnr, 0, myts
+0003aa90: 6e72 5468 7265 7368 2029 2e6d 6f72 7068  nrThresh ).morph
+0003aaa0: 6f6c 6f67 7928 2263 6c6f 7365 222c 3329  ology("close",3)
+0003aab0: 0a20 2062 6d61 736b 203d 2062 6d61 736b  .  bmask = bmask
+0003aac0: 202a 2061 6e74 732e 694d 6174 6828 2074   * ants.iMath( t
+0003aad0: 736e 726d 6173 6b2c 2022 4669 6c6c 486f  snrmask, "FillHo
+0003aae0: 6c65 7322 2029 0a20 2066 6d72 696d 6f74  les" ).  fmrimot
+0003aaf0: 636f 7272 3d63 6f72 726d 6f5b 276d 6f74  corr=corrmo['mot
+0003ab00: 696f 6e5f 636f 7272 6563 7465 6427 5d0a  ion_corrected'].
+0003ab10: 2020 756e 6420 3d20 666d 7269 5f74 656d    und = fmri_tem
+0003ab20: 706c 6174 6520 2a20 626d 6173 6b0a 2020  plate * bmask.  
+0003ab30: 7431 7265 6720 3d20 616e 7473 2e72 6567  t1reg = ants.reg
+0003ab40: 6973 7472 6174 696f 6e28 2075 6e64 2c20  istration( und, 
+0003ab50: 7431 2c20 2253 794e 426f 6c64 2220 290a  t1, "SyNBold" ).
+0003ab60: 2020 676d 7365 6720 3d20 616e 7473 2e74    gmseg = ants.t
+0003ab70: 6872 6573 686f 6c64 5f69 6d61 6765 2820  hreshold_image( 
+0003ab80: 7431 7365 676d 656e 7461 7469 6f6e 2c20  t1segmentation, 
+0003ab90: 322c 2032 2029 0a20 2067 6d73 6567 203d  2, 2 ).  gmseg =
+0003aba0: 2067 6d73 6567 202b 2061 6e74 732e 7468   gmseg + ants.th
+0003abb0: 7265 7368 6f6c 645f 696d 6167 6528 2074  reshold_image( t
+0003abc0: 3173 6567 6d65 6e74 6174 696f 6e2c 2034  1segmentation, 4
+0003abd0: 2c20 3420 290a 2020 676d 7365 6720 3d20  , 4 ).  gmseg = 
+0003abe0: 616e 7473 2e74 6872 6573 686f 6c64 5f69  ants.threshold_i
+0003abf0: 6d61 6765 2820 676d 7365 672c 2031 2c20  mage( gmseg, 1, 
+0003ac00: 3420 290a 2020 676d 7365 6720 3d20 616e  4 ).  gmseg = an
+0003ac10: 7473 2e69 4d61 7468 2820 676d 7365 672c  ts.iMath( gmseg,
+0003ac20: 2027 4d44 272c 2031 2029 0a20 2067 6d73   'MD', 1 ).  gms
+0003ac30: 6567 203d 2061 6e74 732e 6170 706c 795f  eg = ants.apply_
+0003ac40: 7472 616e 7366 6f72 6d73 2820 756e 642c  transforms( und,
+0003ac50: 2067 6d73 6567 2c0a 2020 2020 7431 7265   gmseg,.    t1re
+0003ac60: 675b 2766 7764 7472 616e 7366 6f72 6d73  g['fwdtransforms
+0003ac70: 275d 2c20 696e 7465 7270 6f6c 6174 6f72  '], interpolator
+0003ac80: 203d 2027 6765 6e65 7269 634c 6162 656c   = 'genericLabel
+0003ac90: 2720 2920 2a20 626d 6173 6b0a 2020 6373  ' ) * bmask.  cs
+0003aca0: 6673 6567 203d 2061 6e74 732e 7468 7265  fseg = ants.thre
+0003acb0: 7368 6f6c 645f 696d 6167 6528 2074 3173  shold_image( t1s
+0003acc0: 6567 6d65 6e74 6174 696f 6e2c 2031 2c20  egmentation, 1, 
+0003acd0: 3120 290a 2020 776d 7365 6720 3d20 616e  1 ).  wmseg = an
+0003ace0: 7473 2e74 6872 6573 686f 6c64 5f69 6d61  ts.threshold_ima
+0003acf0: 6765 2820 7431 7365 676d 656e 7461 7469  ge( t1segmentati
+0003ad00: 6f6e 2c20 332c 2033 2029 0a20 2063 7366  on, 3, 3 ).  csf
+0003ad10: 416e 6457 4d20 3d20 2820 6373 6673 6567  AndWM = ( csfseg
+0003ad20: 202b 2077 6d73 6567 2029 2e6d 6f72 7068   + wmseg ).morph
+0003ad30: 6f6c 6f67 7928 2265 726f 6465 222c 3129  ology("erode",1)
+0003ad40: 0a20 2063 7366 416e 6457 4d20 3d20 616e  .  csfAndWM = an
+0003ad50: 7473 2e61 7070 6c79 5f74 7261 6e73 666f  ts.apply_transfo
+0003ad60: 726d 7328 2075 6e64 2c20 6373 6641 6e64  rms( und, csfAnd
+0003ad70: 574d 2c0a 2020 2020 7431 7265 675b 2766  WM,.    t1reg['f
+0003ad80: 7764 7472 616e 7366 6f72 6d73 275d 2c20  wdtransforms'], 
+0003ad90: 696e 7465 7270 6f6c 6174 6f72 203d 2027  interpolator = '
+0003ada0: 6e65 6172 6573 744e 6569 6768 626f 7227  nearestNeighbor'
+0003adb0: 2029 2020 2a20 626d 6173 6b0a 2020 6373   )  * bmask.  cs
+0003adc0: 6673 6567 203d 2061 6e74 732e 6170 706c  fseg = ants.appl
+0003add0: 795f 7472 616e 7366 6f72 6d73 2820 756e  y_transforms( un
+0003ade0: 642c 2063 7366 7365 672c 0a20 2020 2074  d, csfseg,.    t
+0003adf0: 3172 6567 5b27 6677 6474 7261 6e73 666f  1reg['fwdtransfo
+0003ae00: 726d 7327 5d2c 2069 6e74 6572 706f 6c61  rms'], interpola
+0003ae10: 746f 7220 3d20 276e 6561 7265 7374 4e65  tor = 'nearestNe
+0003ae20: 6967 6862 6f72 2720 2920 202a 2062 6d61  ighbor' )  * bma
+0003ae30: 736b 0a20 2077 6d73 6567 203d 2061 6e74  sk.  wmseg = ant
+0003ae40: 732e 6170 706c 795f 7472 616e 7366 6f72  s.apply_transfor
+0003ae50: 6d73 2820 756e 642c 2077 6d73 6567 2c0a  ms( und, wmseg,.
+0003ae60: 2020 2020 7431 7265 675b 2766 7764 7472      t1reg['fwdtr
+0003ae70: 616e 7366 6f72 6d73 275d 2c20 696e 7465  ansforms'], inte
+0003ae80: 7270 6f6c 6174 6f72 203d 2027 6e65 6172  rpolator = 'near
+0003ae90: 6573 744e 6569 6768 626f 7227 2029 2020  estNeighbor' )  
+0003aea0: 2a20 626d 6173 6b0a 2020 636f 6d70 636f  * bmask.  compco
+0003aeb0: 7271 7561 6e74 696c 653d 302e 3530 0a20  rquantile=0.50. 
+0003aec0: 206d 7963 6f6d 7063 6f72 203d 2061 6e74   mycompcor = ant
+0003aed0: 732e 636f 6d70 636f 7228 2066 6d72 696d  s.compcor( fmrim
+0003aee0: 6f74 636f 7272 2c0a 2020 2020 6e63 6f6d  otcorr,.    ncom
+0003aef0: 7063 6f72 3d6e 632c 2071 7561 6e74 696c  pcor=nc, quantil
+0003af00: 653d 636f 6d70 636f 7271 7561 6e74 696c  e=compcorquantil
+0003af10: 652c 206d 6173 6b20 3d20 6373 6641 6e64  e, mask = csfAnd
+0003af20: 574d 2c0a 2020 2020 6669 6c74 6572 5f74  WM,.    filter_t
+0003af30: 7970 653d 2770 6f6c 796e 6f6d 6961 6c27  ype='polynomial'
+0003af40: 2c20 6465 6772 6565 3d32 2029 0a20 2074  , degree=2 ).  t
+0003af50: 7220 3d20 616e 7473 2e67 6574 5f73 7061  r = ants.get_spa
+0003af60: 6369 6e67 2820 666d 7269 6d6f 7463 6f72  cing( fmrimotcor
+0003af70: 7220 295b 335d 0a20 2073 696d 6720 3d20  r )[3].  simg = 
+0003af80: 616e 7473 2e73 6d6f 6f74 685f 696d 6167  ants.smooth_imag
+0003af90: 6528 666d 7269 6d6f 7463 6f72 722c 2073  e(fmrimotcorr, s
+0003afa0: 7061 2c20 7369 676d 615f 696e 5f70 6879  pa, sigma_in_phy
+0003afb0: 7369 6361 6c5f 636f 6f72 6469 6e61 7465  sical_coordinate
+0003afc0: 7320 3d20 5472 7565 2029 0a20 206e 7569  s = True ).  nui
+0003afd0: 7361 6e63 6520 3d20 6d79 636f 6d70 636f  sance = mycompco
+0003afe0: 725b 2762 6173 6973 275d 0a20 206e 7569  r['basis'].  nui
+0003aff0: 7361 6e63 6520 3d20 6e70 2e63 5f5b 206e  sance = np.c_[ n
+0003b000: 7569 7361 6e63 652c 206d 7963 6f6d 7063  uisance, mycompc
+0003b010: 6f72 5b27 636f 6d70 6f6e 656e 7473 275d  or['components']
+0003b020: 205d 0a20 2069 6620 6164 645f 4644 5f74   ].  if add_FD_t
+0003b030: 6f5f 6e75 6973 616e 6365 3a0a 2020 2020  o_nuisance:.    
+0003b040: 6e75 6973 616e 6365 203d 206e 702e 635f  nuisance = np.c_
+0003b050: 5b20 6e75 6973 616e 6365 2c20 636f 7272  [ nuisance, corr
+0003b060: 6d6f 5b27 4644 275d 205d 0a20 2069 6620  mo['FD'] ].  if 
+0003b070: 7665 7262 6f73 653a 0a20 2020 2070 7269  verbose:.    pri
+0003b080: 6e74 2822 6d61 6b65 2073 7572 6520 6e75  nt("make sure nu
+0003b090: 6973 616e 6365 2069 7320 696e 6465 7065  isance is indepe
+0003b0a0: 6e64 656e 7420 6f66 2054 4322 290a 2020  ndent of TC").  
+0003b0b0: 6e75 6973 616e 6365 203d 2061 6e74 732e  nuisance = ants.
+0003b0c0: 7265 6772 6573 735f 636f 6d70 6f6e 656e  regress_componen
+0003b0d0: 7473 2820 6e75 6973 616e 6365 2c20 7463  ts( nuisance, tc
+0003b0e0: 6c69 7374 2029 0a20 2072 6567 7265 7373  list ).  regress
+0003b0f0: 696f 6e5f 6d61 736b 203d 2062 6d61 736b  ion_mask = bmask
+0003b100: 2e63 6c6f 6e65 2829 0a20 2067 6d6d 6174  .clone().  gmmat
+0003b110: 203d 2061 6e74 732e 7469 6d65 7365 7269   = ants.timeseri
+0003b120: 6573 5f74 6f5f 6d61 7472 6978 2820 7369  es_to_matrix( si
+0003b130: 6d67 2c20 7265 6772 6573 7369 6f6e 5f6d  mg, regression_m
+0003b140: 6173 6b20 290a 2020 7265 6776 6172 7320  ask ).  regvars 
+0003b150: 3d20 6e70 2e68 7374 6163 6b28 2028 6e75  = np.hstack( (nu
+0003b160: 6973 616e 6365 2c20 7463 6c69 7374 2029  isance, tclist )
+0003b170: 290a 2020 636f 6566 696e 6420 3d20 7265  ).  coefind = re
+0003b180: 6776 6172 732e 7368 6170 655b 315d 2d31  gvars.shape[1]-1
+0003b190: 0a20 2072 6567 7661 7273 203d 2072 6567  .  regvars = reg
+0003b1a0: 7661 7273 5b3a 2c72 616e 6765 2863 6f65  vars[:,range(coe
+0003b1b0: 6669 6e64 295d 0a20 2070 7265 6469 6374  find)].  predict
+0003b1c0: 6f72 5f6f 665f 696e 7465 7265 7374 5f69  or_of_interest_i
+0003b1d0: 6478 203d 2072 6567 7661 7273 2e73 6861  dx = regvars.sha
+0003b1e0: 7065 5b31 5d2d 310a 2020 7661 6c69 645f  pe[1]-1.  valid_
+0003b1f0: 7065 7266 5f6d 6f64 656c 7320 3d20 5b27  perf_models = ['
+0003b200: 6875 6265 7227 2c27 7175 616e 7469 6c65  huber','quantile
+0003b210: 272c 2774 6865 696c 7365 6e27 2c27 7261  ','theilsen','ra
+0003b220: 6e73 6163 272c 2027 7367 6427 2c20 276c  nsac', 'sgd', 'l
+0003b230: 696e 6561 7227 2c27 534d 275d 0a20 2069  inear','SM'].  i
+0003b240: 6620 7665 7262 6f73 653a 0a20 2020 2070  f verbose:.    p
+0003b250: 7269 6e74 2820 2262 6567 696e 2070 6572  rint( "begin per
+0003b260: 6675 7369 6f6e 2065 7374 696d 6174 696f  fusion estimatio
+0003b270: 6e20 7769 7468 2022 202b 2070 6572 6675  n with " + perfu
+0003b280: 7369 6f6e 5f72 6567 7265 7373 696f 6e5f  sion_regression_
+0003b290: 6d6f 6465 6c20 2b20 2220 6d6f 6465 6c20  model + " model 
+0003b2a0: 2220 290a 2020 6966 2070 6572 6675 7369  " ).  if perfusi
+0003b2b0: 6f6e 5f72 6567 7265 7373 696f 6e5f 6d6f  on_regression_mo
+0003b2c0: 6465 6c20 3d3d 2027 6c69 6e65 6172 273a  del == 'linear':
+0003b2d0: 0a20 2020 2072 6567 7265 7373 696f 6e5f  .    regression_
+0003b2e0: 6d6f 6465 6c20 3d20 4c69 6e65 6172 5265  model = LinearRe
+0003b2f0: 6772 6573 7369 6f6e 2829 0a20 2020 2072  gression().    r
+0003b300: 6567 7265 7373 696f 6e5f 6d6f 6465 6c2e  egression_model.
+0003b310: 6669 7428 2072 6567 7661 7273 2c20 676d  fit( regvars, gm
+0003b320: 6d61 7420 290a 2020 2020 636f 6566 696e  mat ).    coefin
+0003b330: 6420 3d20 7265 6772 6573 7369 6f6e 5f6d  d = regression_m
+0003b340: 6f64 656c 2e63 6f65 665f 2e73 6861 7065  odel.coef_.shape
+0003b350: 5b31 5d2d 310a 2020 2020 7065 7266 696d  [1]-1.    perfim
+0003b360: 6720 3d20 616e 7473 2e6d 616b 655f 696d  g = ants.make_im
+0003b370: 6167 6528 2072 6567 7265 7373 696f 6e5f  age( regression_
+0003b380: 6d61 736b 2c20 7265 6772 6573 7369 6f6e  mask, regression
+0003b390: 5f6d 6f64 656c 2e63 6f65 665f 5b3a 2c63  _model.coef_[:,c
+0003b3a0: 6f65 6669 6e64 5d20 290a 2020 656c 6966  oefind] ).  elif
+0003b3b0: 2070 6572 6675 7369 6f6e 5f72 6567 7265   perfusion_regre
+0003b3c0: 7373 696f 6e5f 6d6f 6465 6c20 3d3d 2027  ssion_model == '
+0003b3d0: 534d 273a 2023 0a20 2020 2069 6d70 6f72  SM': #.    impor
+0003b3e0: 7420 7374 6174 736d 6f64 656c 732e 6170  t statsmodels.ap
+0003b3f0: 6920 6173 2073 6d0a 2020 2020 636f 6566  i as sm.    coef
+0003b400: 6673 203d 206e 702e 7a65 726f 7328 2067  fs = np.zeros( g
+0003b410: 6d6d 6174 2e73 6861 7065 5b31 5d20 290a  mmat.shape[1] ).
+0003b420: 2020 2020 2320 4c6f 6f70 206f 7665 7220      # Loop over 
+0003b430: 6561 6368 206f 7574 636f 6d65 2063 6f6c  each outcome col
+0003b440: 756d 6e20 696e 2074 6865 206f 7574 636f  umn in the outco
+0003b450: 6d65 7320 6d61 7472 6978 0a20 2020 2066  mes matrix.    f
+0003b460: 6f72 206f 7574 636f 6d65 5f69 6478 2069  or outcome_idx i
+0003b470: 6e20 7261 6e67 6528 676d 6d61 742e 7368  n range(gmmat.sh
+0003b480: 6170 655b 315d 293a 0a20 2020 2020 2020  ape[1]):.       
+0003b490: 206f 7574 636f 6d65 203d 2067 6d6d 6174   outcome = gmmat
+0003b4a0: 5b3a 2c20 6f75 7463 6f6d 655f 6964 785d  [:, outcome_idx]
+0003b4b0: 2020 2320 5365 6c65 6374 206f 6e65 206f    # Select one o
+0003b4c0: 7574 636f 6d65 2063 6f6c 756d 6e0a 2020  utcome column.  
+0003b4d0: 2020 2020 2020 6d6f 6465 6c20 3d20 736d        model = sm
+0003b4e0: 2e52 4c4d 286f 7574 636f 6d65 2c20 736d  .RLM(outcome, sm
+0003b4f0: 2e61 6464 5f63 6f6e 7374 616e 7428 7265  .add_constant(re
+0003b500: 6776 6172 7329 2c20 4d3d 736d 2e72 6f62  gvars), M=sm.rob
+0003b510: 7573 742e 6e6f 726d 732e 4875 6265 7254  ust.norms.HuberT
+0003b520: 2829 2920 2023 2048 7562 6572 2773 2054  ())  # Huber's T
+0003b530: 206e 6f72 6d20 666f 7220 726f 6275 7374   norm for robust
+0003b540: 2072 6567 7265 7373 696f 6e0a 2020 2020   regression.    
+0003b550: 2020 2020 7265 7375 6c74 7320 3d20 6d6f      results = mo
+0003b560: 6465 6c2e 6669 7428 290a 2020 2020 2020  del.fit().      
+0003b570: 2020 636f 6566 6669 6369 656e 7473 203d    coefficients =
+0003b580: 2072 6573 756c 7473 2e70 6172 616d 7320   results.params 
+0003b590: 2023 2043 6f65 6666 6963 6965 6e74 7320   # Coefficients 
+0003b5a0: 6f66 2061 6c6c 2070 7265 6469 6374 6f72  of all predictor
+0003b5b0: 730a 2020 2020 2020 2020 636f 6566 6673  s.        coeffs
+0003b5c0: 5b6f 7574 636f 6d65 5f69 6478 5d20 3d20  [outcome_idx] = 
+0003b5d0: 636f 6566 6669 6369 656e 7473 5b70 7265  coefficients[pre
+0003b5e0: 6469 6374 6f72 5f6f 665f 696e 7465 7265  dictor_of_intere
+0003b5f0: 7374 5f69 6478 5d0a 2020 2020 7065 7266  st_idx].    perf
+0003b600: 696d 6720 3d20 616e 7473 2e6d 616b 655f  img = ants.make_
+0003b610: 696d 6167 6528 2072 6567 7265 7373 696f  image( regressio
+0003b620: 6e5f 6d61 736b 2c20 636f 6566 6673 2029  n_mask, coeffs )
+0003b630: 0a20 2065 6c69 6620 7065 7266 7573 696f  .  elif perfusio
+0003b640: 6e5f 7265 6772 6573 7369 6f6e 5f6d 6f64  n_regression_mod
+0003b650: 656c 2069 6e20 7661 6c69 645f 7065 7266  el in valid_perf
+0003b660: 5f6d 6f64 656c 7320 3a0a 2020 2020 7363  _models :.    sc
+0003b670: 616c 6572 203d 2053 7461 6e64 6172 6453  aler = StandardS
+0003b680: 6361 6c65 7228 290a 2020 2020 676d 6d61  caler().    gmma
+0003b690: 7420 3d20 7363 616c 6572 2e66 6974 5f74  t = scaler.fit_t
+0003b6a0: 7261 6e73 666f 726d 2867 6d6d 6174 290a  ransform(gmmat).
+0003b6b0: 2020 2020 636f 6566 6673 203d 206e 702e      coeffs = np.
+0003b6c0: 7a65 726f 7328 2067 6d6d 6174 2e73 6861  zeros( gmmat.sha
+0003b6d0: 7065 5b31 5d20 290a 2020 2020 6875 6265  pe[1] ).    hube
+0003b6e0: 725f 7265 6772 6573 736f 7220 3d20 7365  r_regressor = se
+0003b6f0: 6c65 6374 5f72 6567 7265 7373 696f 6e5f  lect_regression_
+0003b700: 6d6f 6465 6c28 2070 6572 6675 7369 6f6e  model( perfusion
+0003b710: 5f72 6567 7265 7373 696f 6e5f 6d6f 6465  _regression_mode
+0003b720: 6c20 290a 2020 2020 6d75 6c74 696f 7574  l ).    multiout
+0003b730: 7075 745f 6d6f 6465 6c20 3d20 4d75 6c74  put_model = Mult
+0003b740: 694f 7574 7075 7452 6567 7265 7373 6f72  iOutputRegressor
+0003b750: 2868 7562 6572 5f72 6567 7265 7373 6f72  (huber_regressor
+0003b760: 290a 2020 2020 6d75 6c74 696f 7574 7075  ).    multioutpu
+0003b770: 745f 6d6f 6465 6c2e 6669 7428 2072 6567  t_model.fit( reg
+0003b780: 7661 7273 2c20 676d 6d61 7420 290a 2020  vars, gmmat ).  
+0003b790: 2020 6374 3d30 0a20 2020 2066 6f72 2069    ct=0.    for i
+0003b7a0: 2c20 6573 7469 6d61 746f 7220 696e 2065  , estimator in e
+0003b7b0: 6e75 6d65 7261 7465 286d 756c 7469 6f75  numerate(multiou
+0003b7c0: 7470 7574 5f6d 6f64 656c 2e65 7374 696d  tput_model.estim
+0003b7d0: 6174 6f72 735f 293a 0a20 2020 2020 2063  ators_):.      c
+0003b7e0: 6f65 6666 6963 6965 6e74 7320 3d20 6573  oefficients = es
+0003b7f0: 7469 6d61 746f 722e 636f 6566 5f0a 2020  timator.coef_.  
+0003b800: 2020 2020 636f 6566 6673 5b63 745d 3d63      coeffs[ct]=c
+0003b810: 6f65 6666 6963 6965 6e74 735b 7072 6564  oefficients[pred
+0003b820: 6963 746f 725f 6f66 5f69 6e74 6572 6573  ictor_of_interes
+0003b830: 745f 6964 785d 0a20 2020 2020 2063 743d  t_idx].      ct=
+0003b840: 6374 2b31 0a20 2020 2070 6572 6669 6d67  ct+1.    perfimg
+0003b850: 203d 2061 6e74 732e 6d61 6b65 5f69 6d61   = ants.make_ima
+0003b860: 6765 2820 7265 6772 6573 7369 6f6e 5f6d  ge( regression_m
+0003b870: 6173 6b2c 2063 6f65 6666 7320 290a 2020  ask, coeffs ).  
+0003b880: 656c 7365 3a0a 2020 2020 7261 6973 6520  else:.    raise 
+0003b890: 5661 6c75 6545 7272 6f72 2820 7065 7266  ValueError( perf
+0003b8a0: 7573 696f 6e5f 7265 6772 6573 7369 6f6e  usion_regression
+0003b8b0: 5f6d 6f64 656c 202b 2022 2072 6567 7265  _model + " regre
+0003b8c0: 7373 696f 6e20 6d6f 6465 6c20 6973 206e  ssion model is n
+0003b8d0: 6f74 2066 6f75 6e64 2e22 290a 2020 6d65  ot found.").  me
+0003b8e0: 616e 676d 7661 6c20 3d20 2820 7065 7266  angmval = ( perf
+0003b8f0: 696d 675b 2067 6d73 6567 203d 3d20 3120  img[ gmseg == 1 
+0003b900: 5d20 292e 6d65 616e 2829 0a20 2069 6620  ] ).mean().  if 
+0003b910: 6d65 616e 676d 7661 6c20 3c20 303a 0a20  meangmval < 0:. 
+0003b920: 2020 2020 2070 6572 6669 6d67 203d 2070       perfimg = p
+0003b930: 6572 6669 6d67 202a 2028 2d31 2e30 290a  erfimg * (-1.0).
+0003b940: 2020 6e65 6761 7469 7665 5f76 6f78 656c    negative_voxel
+0003b950: 7320 3d20 2820 7065 7266 696d 6720 3c20  s = ( perfimg < 
+0003b960: 302e 3020 292e 7375 6d28 2920 2f20 6e70  0.0 ).sum() / np
+0003b970: 2e70 726f 6428 2070 6572 6669 6d67 2e73  .prod( perfimg.s
+0003b980: 6861 7065 2029 202a 2031 3030 2e30 0a20  hape ) * 100.0. 
+0003b990: 2070 6572 6669 6d67 5b20 7065 7266 696d   perfimg[ perfim
+0003b9a0: 6720 3c20 302e 3020 5d20 3d20 302e 3020  g < 0.0 ] = 0.0 
+0003b9b0: 2320 6e6f 6e2d 7068 7973 696f 6c6f 6769  # non-physiologi
+0003b9c0: 6361 6c0a 0a20 2023 204c 6154 6558 2063  cal..  # LaTeX c
+0003b9d0: 6f64 6520 666f 7220 4365 7265 6272 616c  ode for Cerebral
+0003b9e0: 2042 6c6f 6f64 2046 6c6f 7720 2843 4246   Blood Flow (CBF
+0003b9f0: 2920 6361 6c63 756c 6174 696f 6e20 7573  ) calculation us
+0003ba00: 696e 6720 4153 4c20 4d52 490a 2020 2222  ing ASL MRI.  ""
+0003ba10: 220a 4342 4620 3d20 5c5c 6672 6163 7b5c  ".CBF = \\frac{\
+0003ba20: 5c44 656c 7461 204d 205c 5c63 646f 7420  \Delta M \\cdot 
+0003ba30: 5c5c 6c61 6d62 6461 7d7b 3220 5c5c 6364  \\lambda}{2 \\cd
+0003ba40: 6f74 2054 5f31 205c 5c63 646f 7420 5c5c  ot T_1 \\cdot \\
+0003ba50: 616c 7068 6120 5c5c 6364 6f74 204d 5f30  alpha \\cdot M_0
+0003ba60: 205c 5c63 646f 7420 2865 5e7b 2d5c 5c66   \\cdot (e^{-\\f
+0003ba70: 7261 637b 777d 7b54 5f31 7d7d 202d 2065  rac{w}{T_1}} - e
+0003ba80: 5e7b 2d5c 5c66 7261 637b 7720 2b20 5c5c  ^{-\\frac{w + \\
+0003ba90: 7461 757d 7b54 5f31 7d7d 297d 0a0a 5768  tau}{T_1}})}..Wh
+0003baa0: 6572 653a 0a2d 205c 5c44 656c 7461 204d  ere:.- \\Delta M
+0003bab0: 2069 7320 7468 6520 6469 6666 6572 656e   is the differen
+0003bac0: 6365 2069 6e20 6d61 676e 6574 697a 6174  ce in magnetizat
+0003bad0: 696f 6e20 6265 7477 6565 6e20 6c61 6265  ion between labe
+0003bae0: 6c65 6420 616e 6420 636f 6e74 726f 6c20  led and control 
+0003baf0: 696d 6167 6573 2e0a 2d20 5c5c 6c61 6d62  images..- \\lamb
+0003bb00: 6461 2069 7320 7468 6520 6272 6169 6e2d  da is the brain-
+0003bb10: 626c 6f6f 6420 7061 7274 6974 696f 6e20  blood partition 
+0003bb20: 636f 6566 6669 6369 656e 742c 2074 7970  coefficient, typ
+0003bb30: 6963 616c 6c79 2061 726f 756e 6420 302e  ically around 0.
+0003bb40: 3920 6d4c 2f67 2e0a 2d20 545f 3120 6973  9 mL/g..- T_1 is
+0003bb50: 2074 6865 206c 6f6e 6769 7475 6469 6e61   the longitudina
+0003bb60: 6c20 7265 6c61 7861 7469 6f6e 2074 696d  l relaxation tim
+0003bb70: 6520 6f66 2062 6c6f 6f64 2c20 7768 6963  e of blood, whic
+0003bb80: 6820 6973 2061 2074 6973 7375 652d 7370  h is a tissue-sp
+0003bb90: 6563 6966 6963 2063 6f6e 7374 616e 742e  ecific constant.
+0003bba0: 0a2d 205c 5c61 6c70 6861 2069 7320 7468  .- \\alpha is th
+0003bbb0: 6520 6c61 6265 6c69 6e67 2065 6666 6963  e labeling effic
+0003bbc0: 6965 6e63 792e 0a2d 204d 5f30 2069 7320  iency..- M_0 is 
+0003bbd0: 7468 6520 6571 7569 6c69 6272 6975 6d20  the equilibrium 
+0003bbe0: 6d61 676e 6574 697a 6174 696f 6e20 6f66  magnetization of
+0003bbf0: 2062 7261 696e 2074 6973 7375 6520 2866   brain tissue (f
+0003bc00: 726f 6d20 7468 6520 4d30 2069 6d61 6765  rom the M0 image
+0003bc10: 292e 0a2d 2077 2069 7320 7468 6520 706f  )..- w is the po
+0003bc20: 7374 2d6c 6162 656c 696e 6720 6465 6c61  st-labeling dela
+0003bc30: 792c 2074 6865 2074 696d 6520 6265 7477  y, the time betw
+0003bc40: 6565 6e20 7468 6520 656e 6420 6f66 2074  een the end of t
+0003bc50: 6865 206c 6162 656c 696e 6720 616e 6420  he labeling and 
+0003bc60: 7468 6520 6163 7175 6973 6974 696f 6e20  the acquisition 
+0003bc70: 6f66 2074 6865 2069 6d61 6765 2e0a 2d20  of the image..- 
+0003bc80: 5c5c 7461 7520 6973 2074 6865 206c 6162  \\tau is the lab
+0003bc90: 656c 696e 6720 6475 7261 7469 6f6e 2e0a  eling duration..
+0003bca0: 2020 2222 220a 2020 6966 206d 305f 696e    """.  if m0_in
+0003bcb0: 6469 6365 7320 6973 204e 6f6e 6520 616e  dices is None an
+0003bcc0: 6420 6d30 5f69 6d61 6765 2069 7320 4e6f  d m0_image is No
+0003bcd0: 6e65 3a0a 2020 2020 6d30 203d 2061 6e74  ne:.    m0 = ant
+0003bce0: 732e 6765 745f 6176 6572 6167 655f 6f66  s.get_average_of
+0003bcf0: 5f74 696d 6573 6572 6965 7328 2066 6d72  _timeseries( fmr
+0003bd00: 696d 6f74 636f 7272 2029 0a20 2065 6c73  imotcorr ).  els
+0003bd10: 653a 0a20 2020 2023 2072 6567 6973 7465  e:.    # registe
+0003bd20: 7220 6d30 2074 6f20 6375 7272 656e 7420  r m0 to current 
+0003bd30: 7465 6d70 6c61 7465 0a20 2020 206d 3072  template.    m0r
+0003bd40: 6567 203d 2061 6e74 732e 7265 6769 7374  eg = ants.regist
+0003bd50: 7261 7469 6f6e 2820 666d 7269 5f74 656d  ration( fmri_tem
+0003bd60: 706c 6174 652c 206d 302c 2027 5269 6769  plate, m0, 'Rigi
+0003bd70: 6427 2c20 7665 7262 6f73 653d 4661 6c73  d', verbose=Fals
+0003bd80: 6520 290a 2020 2020 6d30 203d 206d 3072  e ).    m0 = m0r
+0003bd90: 6567 5b27 7761 7270 6564 6d6f 766f 7574  eg['warpedmovout
+0003bda0: 275d 0a0a 2020 6966 206e 7470 203d 3d20  ']..  if ntp == 
+0003bdb0: 3220 3a0a 2020 2020 2020 696d 6730 203d  2 :.      img0 =
+0003bdc0: 2061 6e74 732e 736c 6963 655f 696d 6167   ants.slice_imag
+0003bdd0: 6528 2063 6f72 726d 6f5b 276d 6f74 696f  e( corrmo['motio
+0003bde0: 6e5f 636f 7272 6563 7465 6427 5d2c 2061  n_corrected'], a
+0003bdf0: 7869 733d 332c 2069 6478 3d30 2029 0a20  xis=3, idx=0 ). 
+0003be00: 2020 2020 2069 6d67 3120 3d20 616e 7473       img1 = ants
+0003be10: 2e73 6c69 6365 5f69 6d61 6765 2820 636f  .slice_image( co
+0003be20: 7272 6d6f 5b27 6d6f 7469 6f6e 5f63 6f72  rrmo['motion_cor
+0003be30: 7265 6374 6564 275d 2c20 6178 6973 3d33  rected'], axis=3
+0003be40: 2c20 6964 783d 3120 290a 2020 2020 2020  , idx=1 ).      
+0003be50: 6966 206d 305f 696d 6167 6520 6973 204e  if m0_image is N
+0003be60: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
+0003be70: 696d 6730 2e6d 6561 6e28 2920 3c20 696d  img0.mean() < im
+0003be80: 6731 2e6d 6561 6e28 293a 0a20 2020 2020  g1.mean():.     
+0003be90: 2020 2020 2020 2070 6572 6669 6d67 3d69         perfimg=i
+0003bea0: 6d67 300a 2020 2020 2020 2020 2020 2020  mg0.            
+0003beb0: 6d30 3d69 6d67 310a 2020 2020 2020 2020  m0=img1.        
+0003bec0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003bed0: 2020 7065 7266 696d 673d 696d 6731 0a20    perfimg=img1. 
+0003bee0: 2020 2020 2020 2020 2020 206d 303d 696d             m0=im
+0003bef0: 6730 0a20 2020 2020 2065 6c73 653a 0a20  g0.      else:. 
+0003bf00: 2020 2020 2020 2069 6620 696d 6730 2e6d         if img0.m
+0003bf10: 6561 6e28 2920 3c20 696d 6731 2e6d 6561  ean() < img1.mea
+0003bf20: 6e28 293a 0a20 2020 2020 2020 2020 2020  n():.           
+0003bf30: 2070 6572 6669 6d67 3d69 6d67 312d 696d   perfimg=img1-im
+0003bf40: 6730 0a20 2020 2020 2020 2065 6c73 653a  g0.        else:
+0003bf50: 0a20 2020 2020 2020 2020 2020 2070 6572  .            per
+0003bf60: 6669 6d67 3d69 6d67 302d 696d 6731 0a0a  fimg=img0-img1..
+0003bf70: 2020 6362 6620 3d20 6361 6c63 756c 6174    cbf = calculat
+0003bf80: 655f 4342 4628 0a20 2020 2020 2044 656c  e_CBF(.      Del
+0003bf90: 7461 5f4d 3d70 6572 6669 6d67 2c20 4d5f  ta_M=perfimg, M_
+0003bfa0: 303d 6d30 2c20 6d61 736b 3d62 6d61 736b  0=m0, mask=bmask
+0003bfb0: 2029 0a20 2069 6620 7472 696d 5f74 6865   ).  if trim_the
+0003bfc0: 5f6d 6173 6b20 3e20 302e 3020 3a0a 2020  _mask > 0.0 :.  
+0003bfd0: 2020 626d 6173 6b20 3d20 7472 696d 5f64    bmask = trim_d
+0003bfe0: 7469 5f6d 6173 6b28 2063 6266 2c20 626d  ti_mask( cbf, bm
+0003bff0: 6173 6b2c 2074 7269 6d5f 7468 655f 6d61  ask, trim_the_ma
+0003c000: 736b 2029 0a20 2020 2070 6572 6669 6d67  sk ).    perfimg
+0003c010: 203d 2070 6572 6669 6d67 202a 2062 6d61   = perfimg * bma
+0003c020: 736b 0a20 2020 2063 6266 203d 2063 6266  sk.    cbf = cbf
+0003c030: 202a 2062 6d61 736b 0a0a 2020 6d65 616e   * bmask..  mean
+0003c040: 676d 7661 6c20 3d20 2820 7065 7266 696d  gmval = ( perfim
+0003c050: 675b 2067 6d73 6567 203d 3d20 3120 5d20  g[ gmseg == 1 ] 
+0003c060: 292e 6d65 616e 2829 2020 2020 2020 2020  ).mean()        
+0003c070: 0a20 206d 6561 6e67 6d76 616c 6362 6620  .  meangmvalcbf 
+0003c080: 3d20 2820 6362 665b 2067 6d73 6567 203d  = ( cbf[ gmseg =
+0003c090: 3d20 3120 5d20 292e 6d65 616e 2829 0a20  = 1 ] ).mean(). 
+0003c0a0: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+0003c0b0: 2070 7269 6e74 2822 7065 7266 696d 672e   print("perfimg.
+0003c0c0: 6d61 7828 2920 2220 2b20 7374 7228 2020  max() " + str(  
+0003c0d0: 7065 7266 696d 672e 6d61 7828 2920 2920  perfimg.max() ) 
+0003c0e0: 290a 2020 6f75 7464 6963 7420 3d20 7b7d  ).  outdict = {}
+0003c0f0: 0a20 206f 7574 6469 6374 5b27 6d65 616e  .  outdict['mean
+0003c100: 426f 6c64 275d 203d 2075 6e64 0a20 206f  Bold'] = und.  o
+0003c110: 7574 6469 6374 5b27 6272 6169 6e6d 6173  utdict['brainmas
+0003c120: 6b27 5d20 3d20 626d 6173 6b0a 2020 7273  k'] = bmask.  rs
+0003c130: 664e 7569 7361 6e63 6520 3d20 7064 2e44  fNuisance = pd.D
+0003c140: 6174 6146 7261 6d65 2820 6e75 6973 616e  ataFrame( nuisan
+0003c150: 6365 2029 0a20 2072 7366 4e75 6973 616e  ce ).  rsfNuisan
+0003c160: 6365 5b27 4644 275d 3d63 6f72 726d 6f5b  ce['FD']=corrmo[
+0003c170: 2746 4427 5d0a 0a20 2069 6620 7665 7262  'FD']..  if verb
+0003c180: 6f73 653a 0a20 2020 2020 2070 7269 6e74  ose:.      print
+0003c190: 2822 7065 7266 7573 696f 6e20 6461 7461  ("perfusion data
+0003c1a0: 6672 616d 6520 6265 6769 6e22 290a 2020  frame begin").  
+0003c1b0: 646b 7473 6567 203d 2061 6e74 732e 6170  dktseg = ants.ap
+0003c1c0: 706c 795f 7472 616e 7366 6f72 6d73 2820  ply_transforms( 
+0003c1d0: 756e 642c 2074 3164 6b74 6369 742c 0a20  und, t1dktcit,. 
+0003c1e0: 2020 2074 3172 6567 5b27 6677 6474 7261     t1reg['fwdtra
+0003c1f0: 6e73 666f 726d 7327 5d2c 2069 6e74 6572  nsforms'], inter
+0003c200: 706f 6c61 746f 7220 3d20 2767 656e 6572  polator = 'gener
+0003c210: 6963 4c61 6265 6c27 2029 202a 2062 6d61  icLabel' ) * bma
+0003c220: 736b 0a20 2064 665f 7065 7266 203d 2061  sk.  df_perf = a
+0003c230: 6e74 7370 7974 3177 2e6d 6170 5f69 6e74  ntspyt1w.map_int
+0003c240: 656e 7369 7479 5f74 6f5f 6461 7461 6672  ensity_to_datafr
+0003c250: 616d 6528 0a20 2020 2020 2020 2027 646b  ame(.        'dk
+0003c260: 745f 636f 7274 6578 5f63 6974 5f64 6565  t_cortex_cit_dee
+0003c270: 705f 6272 6169 6e27 2c0a 2020 2020 2020  p_brain',.      
+0003c280: 2020 7065 7266 696d 672c 0a20 2020 2020    perfimg,.     
+0003c290: 2020 2064 6b74 7365 6729 0a20 2064 665f     dktseg).  df_
+0003c2a0: 7065 7266 203d 2061 6e74 7370 7974 3177  perf = antspyt1w
+0003c2b0: 2e6d 6572 6765 5f68 6965 7261 7263 6869  .merge_hierarchi
+0003c2c0: 6361 6c5f 6373 7673 5f74 6f5f 7769 6465  cal_csvs_to_wide
+0003c2d0: 5f66 6f72 6d61 7428 0a20 2020 2020 2020  _format(.       
+0003c2e0: 2020 2020 2020 207b 2770 6572 6627 203a         {'perf' :
+0003c2f0: 2064 665f 7065 7266 7d2c 0a20 2020 2020   df_perf},.     
+0003c300: 2020 2020 2020 2020 2063 6f6c 5f6e 616d           col_nam
+0003c310: 6573 203d 205b 274d 6561 6e27 5d20 290a  es = ['Mean'] ).
+0003c320: 2020 6466 5f63 6266 203d 2061 6e74 7370    df_cbf = antsp
+0003c330: 7974 3177 2e6d 6170 5f69 6e74 656e 7369  yt1w.map_intensi
+0003c340: 7479 5f74 6f5f 6461 7461 6672 616d 6528  ty_to_dataframe(
+0003c350: 0a20 2020 2020 2020 2027 646b 745f 636f  .        'dkt_co
+0003c360: 7274 6578 5f63 6974 5f64 6565 705f 6272  rtex_cit_deep_br
+0003c370: 6169 6e27 2c0a 2020 2020 2020 2020 6362  ain',.        cb
+0003c380: 662c 0a20 2020 2020 2020 2064 6b74 7365  f,.        dktse
+0003c390: 6729 0a20 2064 665f 6362 6620 3d20 616e  g).  df_cbf = an
+0003c3a0: 7473 7079 7431 772e 6d65 7267 655f 6869  tspyt1w.merge_hi
+0003c3b0: 6572 6172 6368 6963 616c 5f63 7376 735f  erarchical_csvs_
+0003c3c0: 746f 5f77 6964 655f 666f 726d 6174 280a  to_wide_format(.
+0003c3d0: 2020 2020 2020 2020 2020 2020 2020 7b27                {'
+0003c3e0: 6362 6627 203a 2064 665f 6362 667d 2c0a  cbf' : df_cbf},.
+0003c3f0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0003c400: 6c5f 6e61 6d65 7320 3d20 5b27 4d65 616e  l_names = ['Mean
+0003c410: 275d 2029 0a20 2064 665f 6362 6620 3d20  '] ).  df_cbf = 
+0003c420: 6466 5f63 6266 2e61 6464 5f70 7265 6669  df_cbf.add_prefi
+0003c430: 7828 2763 6266 5f27 290a 2020 6466 5f70  x('cbf_').  df_p
+0003c440: 6572 6620 3d20 7064 2e63 6f6e 6361 7428  erf = pd.concat(
+0003c450: 205b 6466 5f70 6572 662c 6466 5f63 6266   [df_perf,df_cbf
+0003c460: 5d2c 2061 7869 733d 312c 2069 676e 6f72  ], axis=1, ignor
+0003c470: 655f 696e 6465 783d 4661 6c73 6520 290a  e_index=False ).
+0003c480: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+0003c490: 2020 2020 7072 696e 7428 2270 6572 6675      print("perfu
+0003c4a0: 7369 6f6e 2064 6174 6166 7261 6d65 2065  sion dataframe e
+0003c4b0: 6e64 2229 0a0a 2020 6f75 7464 6963 745b  nd")..  outdict[
+0003c4c0: 2770 6572 6675 7369 6f6e 275d 3d70 6572  'perfusion']=per
+0003c4d0: 6669 6d67 0a20 206f 7574 6469 6374 5b27  fimg.  outdict['
+0003c4e0: 6362 6627 5d3d 6362 660a 2020 6f75 7464  cbf']=cbf.  outd
+0003c4f0: 6963 745b 276d 3027 5d3d 6d30 0a20 206f  ict['m0']=m0.  o
+0003c500: 7574 6469 6374 5b27 7065 7266 7573 696f  utdict['perfusio
+0003c510: 6e5f 676d 5f6d 6561 6e27 5d3d 6d65 616e  n_gm_mean']=mean
+0003c520: 676d 7661 6c0a 2020 6f75 7464 6963 745b  gmval.  outdict[
+0003c530: 2763 6266 5f67 6d5f 6d65 616e 275d 3d6d  'cbf_gm_mean']=m
+0003c540: 6561 6e67 6d76 616c 6362 660a 2020 6f75  eangmvalcbf.  ou
+0003c550: 7464 6963 745b 2770 6572 665f 6461 7461  tdict['perf_data
+0003c560: 6672 616d 6527 5d3d 6466 5f70 6572 660a  frame']=df_perf.
+0003c570: 2020 6f75 7464 6963 745b 276d 6f74 696f    outdict['motio
+0003c580: 6e5f 636f 7272 6563 7465 6427 5d20 3d20  n_corrected'] = 
+0003c590: 636f 7272 6d6f 5b27 6d6f 7469 6f6e 5f63  corrmo['motion_c
+0003c5a0: 6f72 7265 6374 6564 275d 0a20 206f 7574  orrected'].  out
+0003c5b0: 6469 6374 5b27 676d 7365 6727 5d20 3d20  dict['gmseg'] = 
+0003c5c0: 676d 7365 670a 2020 6f75 7464 6963 745b  gmseg.  outdict[
+0003c5d0: 2762 7261 696e 5f6d 6173 6b27 5d20 3d20  'brain_mask'] = 
+0003c5e0: 626d 6173 6b0a 2020 6f75 7464 6963 745b  bmask.  outdict[
+0003c5f0: 276e 7569 7361 6e63 6527 5d20 3d20 7273  'nuisance'] = rs
+0003c600: 664e 7569 7361 6e63 650a 2020 6f75 7464  fNuisance.  outd
+0003c610: 6963 745b 2774 736e 7227 5d20 3d20 6d79  ict['tsnr'] = my
+0003c620: 7473 6e72 0a20 206f 7574 6469 6374 5b27  tsnr.  outdict['
+0003c630: 7373 6e72 275d 203d 2073 6c69 6365 5f73  ssnr'] = slice_s
+0003c640: 6e72 2820 636f 7272 6d6f 5b27 6d6f 7469  nr( corrmo['moti
+0003c650: 6f6e 5f63 6f72 7265 6374 6564 275d 2c20  on_corrected'], 
+0003c660: 6373 6641 6e64 574d 2c20 676d 7365 6720  csfAndWM, gmseg 
+0003c670: 290a 2020 6f75 7464 6963 745b 2764 7661  ).  outdict['dva
+0003c680: 7273 275d 203d 2064 7661 7273 2820 636f  rs'] = dvars( co
+0003c690: 7272 6d6f 5b27 6d6f 7469 6f6e 5f63 6f72  rrmo['motion_cor
+0003c6a0: 7265 6374 6564 275d 2c20 676d 7365 6720  rected'], gmseg 
+0003c6b0: 290a 2020 6f75 7464 6963 745b 2768 6967  ).  outdict['hig
+0003c6c0: 685f 6d6f 7469 6f6e 5f63 6f75 6e74 275d  h_motion_count']
+0003c6d0: 203d 2028 7273 664e 7569 7361 6e63 655b   = (rsfNuisance[
+0003c6e0: 2746 4427 5d20 3e20 4644 5f74 6872 6573  'FD'] > FD_thres
+0003c6f0: 686f 6c64 2029 2e73 756d 2829 0a20 206f  hold ).sum().  o
+0003c700: 7574 6469 6374 5b27 6869 6768 5f6d 6f74  utdict['high_mot
+0003c710: 696f 6e5f 7063 7427 5d20 3d20 2872 7366  ion_pct'] = (rsf
+0003c720: 4e75 6973 616e 6365 5b27 4644 275d 203e  Nuisance['FD'] >
+0003c730: 2046 445f 7468 7265 7368 6f6c 6420 292e   FD_threshold ).
+0003c740: 7375 6d28 2920 2f20 7273 664e 7569 7361  sum() / rsfNuisa
+0003c750: 6e63 652e 7368 6170 655b 305d 0a20 206f  nce.shape[0].  o
+0003c760: 7574 6469 6374 5b27 4644 5f6d 6178 275d  utdict['FD_max']
+0003c770: 203d 2072 7366 4e75 6973 616e 6365 5b27   = rsfNuisance['
+0003c780: 4644 275d 2e6d 6178 2829 0a20 206f 7574  FD'].max().  out
+0003c790: 6469 6374 5b27 4644 5f6d 6561 6e27 5d20  dict['FD_mean'] 
+0003c7a0: 3d20 7273 664e 7569 7361 6e63 655b 2746  = rsfNuisance['F
+0003c7b0: 4427 5d2e 6d65 616e 2829 0a20 206f 7574  D'].mean().  out
+0003c7c0: 6469 6374 5b27 4644 5f73 6427 5d20 3d20  dict['FD_sd'] = 
+0003c7d0: 7273 664e 7569 7361 6e63 655b 2746 4427  rsfNuisance['FD'
+0003c7e0: 5d2e 7374 6428 290a 2020 6f75 7464 6963  ].std().  outdic
+0003c7f0: 745b 2762 6f6c 645f 6576 7227 5d20 3d20  t['bold_evr'] = 
+0003c800: 2061 6e74 7370 7974 3177 2e70 6174 6368   antspyt1w.patch
+0003c810: 5f65 6967 656e 7661 6c75 655f 7261 7469  _eigenvalue_rati
+0003c820: 6f28 2075 6e64 2c20 3531 322c 205b 3136  o( und, 512, [16
+0003c830: 2c31 362c 3136 5d2c 2065 7664 6570 7468  ,16,16], evdepth
+0003c840: 203d 2030 2e39 2c20 6d61 736b 203d 2062   = 0.9, mask = b
+0003c850: 6d61 736b 2029 0a20 206f 7574 6469 6374  mask ).  outdict
+0003c860: 5b27 7431 7265 6727 5d20 3d20 7431 7265  ['t1reg'] = t1re
+0003c870: 670a 2020 6f75 7464 6963 745b 276f 7574  g.  outdict['out
+0003c880: 6c69 6572 5f76 6f6c 756d 6573 275d 3d68  lier_volumes']=h
+0003c890: 6c69 6e64 730a 2020 6f75 7464 6963 745b  linds.  outdict[
+0003c8a0: 276e 5f6f 7574 6c69 6572 7327 5d3d 6c65  'n_outliers']=le
+0003c8b0: 6e28 686c 696e 6473 290a 2020 6f75 7464  n(hlinds).  outd
+0003c8c0: 6963 745b 276e 6567 6174 6976 655f 766f  ict['negative_vo
+0003c8d0: 7865 6c73 275d 3d6e 6567 6174 6976 655f  xels']=negative_
+0003c8e0: 766f 7865 6c73 0a20 2072 6574 7572 6e20  voxels.  return 
+0003c8f0: 636f 6e76 6572 745f 6e70 5f69 6e5f 6469  convert_np_in_di
+0003c900: 6374 2820 6f75 7464 6963 7420 290a 0a0a  ct( outdict )...
+0003c910: 6465 6620 7772 6974 655f 6276 616c 735f  def write_bvals_
+0003c920: 6276 6563 7328 6276 616c 732c 2062 7665  bvecs(bvals, bve
+0003c930: 6373 2c20 7072 6566 6978 2029 3a0a 2020  cs, prefix ):.  
+0003c940: 2020 2727 2720 5772 6974 6520 4653 4c20    ''' Write FSL 
+0003c950: 4644 5420 6276 616c 7320 616e 6420 6276  FDT bvals and bv
+0003c960: 6563 7320 6669 6c65 730a 0a20 2020 2061  ecs files..    a
+0003c970: 6461 7074 6564 2066 726f 6d20 6469 7079  dapted from dipy
+0003c980: 2e65 7874 6572 6e61 6c20 636f 6465 0a0a  .external code..
+0003c990: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+0003c9a0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
+0003c9b0: 0a20 2020 2062 7661 6c73 203a 2028 4e2c  .    bvals : (N,
+0003c9c0: 2920 7365 7175 656e 6365 0a20 2020 2020  ) sequence.     
+0003c9d0: 2020 5665 6374 6f72 2077 6974 6820 6469    Vector with di
+0003c9e0: 6666 7573 696f 6e20 6772 6164 6965 6e74  ffusion gradient
+0003c9f0: 2073 7472 656e 6774 6820 286f 6e65 2070   strength (one p
+0003ca00: 6572 2064 6966 6675 7369 6f6e 0a20 2020  er diffusion.   
+0003ca10: 2020 2020 6163 7175 6973 6974 696f 6e2c      acquisition,
+0003ca20: 204e 3d6e 6f20 6f66 2061 6371 7569 7369   N=no of acquisi
+0003ca30: 7469 6f6e 7329 0a20 2020 2062 7665 6373  tions).    bvecs
+0003ca40: 203a 2028 4e2c 2033 2920 6172 7261 792d   : (N, 3) array-
+0003ca50: 6c69 6b65 0a20 2020 2020 2020 6469 6666  like.       diff
+0003ca60: 7573 696f 6e20 6772 6164 6965 6e74 2064  usion gradient d
+0003ca70: 6972 6563 7469 6f6e 730a 2020 2020 7072  irections.    pr
+0003ca80: 6566 6978 203a 2073 7472 696e 670a 2020  efix : string.  
+0003ca90: 2020 2020 2070 6174 6820 746f 2077 7269       path to wri
+0003caa0: 7465 2046 4454 2062 7661 6c73 2c20 6276  te FDT bvals, bv
+0003cab0: 6563 7320 7465 7874 2066 696c 6573 0a20  ecs text files. 
+0003cac0: 2020 2020 2020 4e6f 6e65 2072 6573 756c        None resul
+0003cad0: 7473 2069 6e20 6375 7272 656e 7420 776f  ts in current wo
+0003cae0: 726b 696e 6720 6469 7265 6374 6f72 792e  rking directory.
+0003caf0: 0a20 2020 2027 2727 0a20 2020 205f 5641  .    '''.    _VA
+0003cb00: 4c5f 464d 5420 3d20 2720 2020 2565 270a  L_FMT = '   %e'.
+0003cb10: 2020 2020 6276 616c 7320 3d20 7475 706c      bvals = tupl
+0003cb20: 6528 6276 616c 7329 0a20 2020 2062 7665  e(bvals).    bve
+0003cb30: 6373 203d 206e 702e 6173 6172 7261 7928  cs = np.asarray(
+0003cb40: 6276 6563 7329 0a20 2020 2062 7665 6373  bvecs).    bvecs
+0003cb50: 5b6e 702e 6973 6e61 6e28 6276 6563 7329  [np.isnan(bvecs)
+0003cb60: 5d20 3d20 300a 2020 2020 4e20 3d20 6c65  ] = 0.    N = le
+0003cb70: 6e28 6276 616c 7329 0a20 2020 2066 6e61  n(bvals).    fna
+0003cb80: 6d65 203d 2070 7265 6669 7820 2b20 272e  me = prefix + '.
+0003cb90: 6276 616c 270a 2020 2020 666d 7420 3d20  bval'.    fmt = 
+0003cba0: 5f56 414c 5f46 4d54 202a 204e 202b 2027  _VAL_FMT * N + '
+0003cbb0: 5c6e 270a 2020 2020 6d79 6669 6c65 203d  \n'.    myfile =
+0003cbc0: 206f 7065 6e28 666e 616d 652c 2027 7774   open(fname, 'wt
+0003cbd0: 2729 0a20 2020 206d 7966 696c 652e 7772  ').    myfile.wr
+0003cbe0: 6974 6528 666d 7420 2520 6276 616c 7329  ite(fmt % bvals)
+0003cbf0: 0a20 2020 206d 7966 696c 652e 636c 6f73  .    myfile.clos
+0003cc00: 6528 290a 2020 2020 666e 616d 6520 3d20  e().    fname = 
+0003cc10: 7072 6566 6978 202b 2027 2e62 7665 6327  prefix + '.bvec'
+0003cc20: 0a20 2020 2062 7666 203d 206f 7065 6e28  .    bvf = open(
+0003cc30: 666e 616d 652c 2027 7774 2729 0a20 2020  fname, 'wt').   
+0003cc40: 2066 6f72 2064 696d 5f76 616c 7320 696e   for dim_vals in
+0003cc50: 2062 7665 6373 2e54 3a0a 2020 2020 2020   bvecs.T:.      
+0003cc60: 2020 6276 662e 7772 6974 6528 666d 7420    bvf.write(fmt 
+0003cc70: 2520 7475 706c 6528 6469 6d5f 7661 6c73  % tuple(dim_vals
+0003cc80: 2929 0a20 2020 2062 7666 2e63 6c6f 7365  )).    bvf.close
+0003cc90: 2829 0a20 2020 200a 0a64 6566 2063 726f  ().    ..def cro
+0003cca0: 705f 6d63 696d 6167 6528 2078 2c20 6d61  p_mcimage( x, ma
+0003ccb0: 736b 2c20 7061 6464 6572 3d4e 6f6e 6520  sk, padder=None 
+0003ccc0: 293a 0a20 2020 2022 2222 0a20 2020 2063  ):.    """.    c
+0003ccd0: 726f 7020 6120 7469 6d65 2073 6572 6965  rop a time serie
+0003cce0: 7320 2834 4429 2069 6d61 6765 2062 7920  s (4D) image by 
+0003ccf0: 6120 3344 206d 6173 6b0a 0a20 2020 2050  a 3D mask..    P
+0003cd00: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+0003cd10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 0a20 2020  -----------..   
+0003cd20: 2078 203a 2072 6177 2069 6d61 6765 0a0a   x : raw image..
+0003cd30: 2020 2020 6d61 736b 2020 3a20 6d61 736b      mask  : mask
+0003cd40: 2066 6f72 2063 726f 7070 696e 670a 0a20   for cropping.. 
+0003cd50: 2020 2022 2222 0a20 2020 2063 726f 706d     """.    cropm
+0003cd60: 6173 6b20 3d20 616e 7473 2e63 726f 705f  ask = ants.crop_
+0003cd70: 696d 6167 6528 206d 6173 6b2c 206d 6173  image( mask, mas
+0003cd80: 6b20 290a 2020 2020 6d79 6f72 6967 203d  k ).    myorig =
+0003cd90: 206c 6973 7428 2061 6e74 732e 6765 745f   list( ants.get_
+0003cda0: 6f72 6967 696e 2863 726f 706d 6173 6b29  origin(cropmask)
+0003cdb0: 2029 0a20 2020 206d 796f 7269 672e 6170   ).    myorig.ap
+0003cdc0: 7065 6e64 2820 616e 7473 2e67 6574 5f6f  pend( ants.get_o
+0003cdd0: 7269 6769 6e28 2078 2029 5b33 5d20 290a  rigin( x )[3] ).
+0003cde0: 2020 2020 6372 6f70 6c69 7374 203d 205b      croplist = [
+0003cdf0: 5d0a 2020 2020 6966 206c 656e 2878 2e73  ].    if len(x.s
+0003ce00: 6861 7065 2920 3e20 333a 0a20 2020 2020  hape) > 3:.     
+0003ce10: 2020 2066 6f72 206b 2069 6e20 7261 6e67     for k in rang
+0003ce20: 6528 782e 7368 6170 655b 335d 293a 0a20  e(x.shape[3]):. 
+0003ce30: 2020 2020 2020 2020 2020 2074 656d 7020             temp 
+0003ce40: 3d20 616e 7473 2e73 6c69 6365 5f69 6d61  = ants.slice_ima
+0003ce50: 6765 2820 782c 2061 7869 733d 332c 2069  ge( x, axis=3, i
+0003ce60: 6478 3d6b 2029 0a20 2020 2020 2020 2020  dx=k ).         
+0003ce70: 2020 2074 656d 7020 3d20 616e 7473 2e63     temp = ants.c
+0003ce80: 726f 705f 696d 6167 6528 2074 656d 702c  rop_image( temp,
+0003ce90: 206d 6173 6b20 290a 2020 2020 2020 2020   mask ).        
+0003cea0: 2020 2020 6966 2070 6164 6465 7220 6973      if padder is
+0003ceb0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0003cec0: 2020 2020 2020 2020 2020 2074 656d 7020             temp 
+0003ced0: 3d20 616e 7473 2e70 6164 5f69 6d61 6765  = ants.pad_image
+0003cee0: 2820 7465 6d70 2c20 7061 645f 7769 6474  ( temp, pad_widt
+0003cef0: 683d 7061 6464 6572 2029 0a20 2020 2020  h=padder ).     
+0003cf00: 2020 2020 2020 2063 726f 706c 6973 742e         croplist.
+0003cf10: 6170 7065 6e64 2820 7465 6d70 2029 0a20  append( temp ). 
+0003cf20: 2020 2020 2020 2074 656d 7020 3d20 616e         temp = an
+0003cf30: 7473 2e6c 6973 745f 746f 5f6e 6469 6d61  ts.list_to_ndima
+0003cf40: 6765 2820 782c 2063 726f 706c 6973 7420  ge( x, croplist 
+0003cf50: 290a 2020 2020 2020 2020 7465 6d70 2e73  ).        temp.s
+0003cf60: 6574 5f6f 7269 6769 6e28 206d 796f 7269  et_origin( myori
+0003cf70: 6720 290a 2020 2020 2020 2020 7265 7475  g ).        retu
+0003cf80: 726e 2074 656d 700a 2020 2020 656c 7365  rn temp.    else
+0003cf90: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0003cfa0: 2820 616e 7473 2e63 726f 705f 696d 6167  ( ants.crop_imag
+0003cfb0: 6528 2078 2c20 6d61 736b 2029 2029 0a0a  e( x, mask ) )..
+0003cfc0: 0a64 6566 206d 6d28 0a20 2020 2074 315f  .def mm(.    t1_
+0003cfd0: 696d 6167 652c 0a20 2020 2068 6965 722c  image,.    hier,
+0003cfe0: 0a20 2020 2072 7366 5f69 6d61 6765 3d5b  .    rsf_image=[
+0003cff0: 5d2c 0a20 2020 2066 6c61 6972 5f69 6d61  ],.    flair_ima
+0003d000: 6765 3d4e 6f6e 652c 0a20 2020 206e 6d5f  ge=None,.    nm_
+0003d010: 696d 6167 655f 6c69 7374 3d4e 6f6e 652c  image_list=None,
+0003d020: 0a20 2020 2064 775f 696d 6167 653d 5b5d  .    dw_image=[]
+0003d030: 2c20 6276 616c 733d 5b5d 2c20 6276 6563  , bvals=[], bvec
+0003d040: 733d 5b5d 2c0a 2020 2020 7065 7266 7573  s=[],.    perfus
+0003d050: 696f 6e5f 696d 6167 653d 4e6f 6e65 2c0a  ion_image=None,.
+0003d060: 2020 2020 7372 6d6f 6465 6c3d 4e6f 6e65      srmodel=None
+0003d070: 2c0a 2020 2020 646f 5f74 7261 6374 6f67  ,.    do_tractog
+0003d080: 7261 7068 7920 3d20 4661 6c73 652c 0a20  raphy = False,. 
+0003d090: 2020 2064 6f5f 6b6b 203d 2046 616c 7365     do_kk = False
+0003d0a0: 2c0a 2020 2020 646f 5f6e 6f72 6d61 6c69  ,.    do_normali
+0003d0b0: 7a61 7469 6f6e 203d 204e 6f6e 652c 0a20  zation = None,. 
+0003d0c0: 2020 2067 726f 7570 5f74 656d 706c 6174     group_templat
+0003d0d0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 6772  e = None,.    gr
+0003d0e0: 6f75 705f 7472 616e 7366 6f72 6d20 3d20  oup_transform = 
+0003d0f0: 4e6f 6e65 2c0a 2020 2020 7461 7267 6574  None,.    target
+0003d100: 5f72 616e 6765 203d 205b 302c 315d 2c0a  _range = [0,1],.
+0003d110: 2020 2020 6474 695f 6d6f 7469 6f6e 5f63      dti_motion_c
+0003d120: 6f72 7265 6374 203d 2027 5269 6769 6427  orrect = 'Rigid'
+0003d130: 2c0a 2020 2020 6474 695f 6465 6e6f 6973  ,.    dti_denois
+0003d140: 6520 3d20 4661 6c73 652c 0a20 2020 2070  e = False,.    p
+0003d150: 6572 6675 7369 6f6e 5f74 7269 6d3d 3130  erfusion_trim=10
+0003d160: 2c0a 2020 2020 7065 7266 7573 696f 6e5f  ,.    perfusion_
+0003d170: 6d30 5f69 6d61 6765 3d4e 6f6e 652c 0a20  m0_image=None,. 
+0003d180: 2020 2070 6572 6675 7369 6f6e 5f6d 303d     perfusion_m0=
+0003d190: 4e6f 6e65 2c0a 2020 2020 7273 665f 7570  None,.    rsf_up
+0003d1a0: 7361 6d70 6c69 6e67 3d33 2e30 2c0a 2020  sampling=3.0,.  
+0003d1b0: 2020 7465 7374 5f72 756e 203d 2046 616c    test_run = Fal
+0003d1c0: 7365 2c0a 2020 2020 7665 7262 6f73 6520  se,.    verbose 
+0003d1d0: 3d20 4661 6c73 6520 293a 0a20 2020 2022  = False ):.    "
+0003d1e0: 2222 0a20 2020 204d 756c 7469 706c 6520  "".    Multiple 
+0003d1f0: 6d6f 6461 6c69 7479 2070 726f 6365 7373  modality process
+0003d200: 696e 6720 616e 6420 6e6f 726d 616c 697a  ing and normaliz
+0003d210: 6174 696f 6e0a 0a20 2020 2061 6767 7265  ation..    aggre
+0003d220: 6761 7465 7320 6d6f 6461 6c69 7479 2d73  gates modality-s
+0003d230: 7065 6369 6669 6320 7072 6f63 6573 7369  pecific processi
+0003d240: 6e67 2075 6e64 6572 206f 6e65 2072 6f6f  ng under one roo
+0003d250: 662e 2020 7365 6520 696e 6469 7669 6475  f.  see individu
+0003d260: 616c 0a20 2020 206d 6f64 616c 6974 7920  al.    modality 
+0003d270: 7370 6563 6966 6963 2066 756e 6374 696f  specific functio
+0003d280: 6e73 2066 6f72 2064 6574 6169 6c73 2e0a  ns for details..
+0003d290: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+0003d2a0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
+0003d2b0: 2d0a 0a20 2020 2074 315f 696d 6167 6520  -..    t1_image 
+0003d2c0: 3a20 7261 7720 7431 2069 6d61 6765 0a0a  : raw t1 image..
+0003d2d0: 2020 2020 6869 6572 2020 3a20 6f75 7470      hier  : outp
+0003d2e0: 7574 206f 6620 616e 7473 7079 7431 772e  ut of antspyt1w.
+0003d2f0: 6869 6572 6172 6368 6963 616c 2028 2073  hierarchical ( s
+0003d300: 6565 2072 6561 6420 6869 6572 6172 6368  ee read hierarch
+0003d310: 6963 616c 2029 0a0a 2020 2020 7273 665f  ical )..    rsf_
+0003d320: 696d 6167 6520 3a20 6c69 7374 206f 6620  image : list of 
+0003d330: 7265 7374 696e 6720 7374 6174 6520 666d  resting state fm
+0003d340: 7269 0a0a 2020 2020 666c 6169 725f 696d  ri..    flair_im
+0003d350: 6167 6520 3a20 666c 6169 720a 0a20 2020  age : flair..   
+0003d360: 206e 6d5f 696d 6167 655f 6c69 7374 203a   nm_image_list :
+0003d370: 206c 6973 7420 6f66 206e 6575 726f 6d65   list of neurome
+0003d380: 6c61 6e69 6e20 696d 6167 6573 0a0a 2020  lanin images..  
+0003d390: 2020 6477 5f69 6d61 6765 203a 206c 6973    dw_image : lis
+0003d3a0: 7420 6f66 2064 6966 6675 7369 6f6e 2077  t of diffusion w
+0003d3b0: 6569 6768 7465 6420 696d 6167 6573 0a0a  eighted images..
+0003d3c0: 2020 2020 6276 616c 7320 3a20 6c69 7374      bvals : list
+0003d3d0: 206f 6620 6276 616c 7320 6669 6c65 206e   of bvals file n
+0003d3e0: 616d 6573 0a0a 2020 2020 6276 6563 7320  ames..    bvecs 
+0003d3f0: 3a20 6c69 7374 206f 6620 6276 6563 7320  : list of bvecs 
+0003d400: 6669 6c65 206e 616d 6573 0a0a 2020 2020  file names..    
+0003d410: 7065 7266 7573 696f 6e5f 696d 6167 6520  perfusion_image 
+0003d420: 3a20 7369 6e67 6c65 2070 6572 6675 7369  : single perfusi
+0003d430: 6f6e 2069 6d61 6765 0a0a 2020 2020 7372  on image..    sr
+0003d440: 6d6f 6465 6c20 3a20 6f70 7469 6f6e 616c  model : optional
+0003d450: 2073 726d 6f64 656c 0a0a 2020 2020 646f   srmodel..    do
+0003d460: 5f74 7261 6374 6f67 7261 7068 7920 3a20  _tractography : 
+0003d470: 626f 6f6c 6561 6e0a 0a20 2020 2064 6f5f  boolean..    do_
+0003d480: 6b6b 203a 2062 6f6f 6c65 616e 2074 6f20  kk : boolean to 
+0003d490: 636f 6e74 726f 6c20 7768 6574 6865 7220  control whether 
+0003d4a0: 7765 2063 6f6d 7075 7465 206b 656c 6c79  we compute kelly
+0003d4b0: 206b 6170 6f77 736b 6920 7468 6963 6b6e   kapowski thickn
+0003d4c0: 6573 7320 696d 6167 6520 2873 6c6f 7729  ess image (slow)
+0003d4d0: 0a0a 2020 2020 646f 5f6e 6f72 6d61 6c69  ..    do_normali
+0003d4e0: 7a61 7469 6f6e 203a 2074 656d 706c 6174  zation : templat
+0003d4f0: 6520 7472 616e 7366 6f72 6d61 7469 6f6e  e transformation
+0003d500: 2069 6620 6176 6169 6c61 626c 650a 0a20   if available.. 
+0003d510: 2020 2067 726f 7570 5f74 656d 706c 6174     group_templat
+0003d520: 6520 3a20 6f70 7469 6f6e 616c 2072 6566  e : optional ref
+0003d530: 6572 656e 6365 2074 656d 706c 6174 6520  erence template 
+0003d540: 636f 7272 6573 706f 6e64 696e 6720 746f  corresponding to
+0003d550: 2074 6865 2067 726f 7570 5f74 7261 6e73   the group_trans
+0003d560: 666f 726d 0a0a 2020 2020 6772 6f75 705f  form..    group_
+0003d570: 7472 616e 7366 6f72 6d20 3a20 6f70 7469  transform : opti
+0003d580: 6f6e 616c 2074 7261 6e73 666f 726d 7320  onal transforms 
+0003d590: 636f 7272 6573 706f 6e64 696e 6720 746f  corresponding to
+0003d5a0: 2074 6865 2067 726f 7570 5f74 656d 706c   the group_templ
+0003d5b0: 6174 650a 0a20 2020 2074 6172 6765 745f  ate..    target_
+0003d5c0: 7261 6e67 6520 3a20 322d 656c 656d 656e  range : 2-elemen
+0003d5d0: 7420 7475 706c 650a 2020 2020 2020 2020  t tuple.        
+0003d5e0: 6120 7475 706c 6520 6f72 2061 7272 6179  a tuple or array
+0003d5f0: 2064 6566 696e 696e 6720 7468 6520 286d   defining the (m
+0003d600: 696e 2c20 6d61 7829 206f 6620 7468 6520  in, max) of the 
+0003d610: 696e 7075 7420 696d 6167 650a 2020 2020  input image.    
+0003d620: 2020 2020 2865 2e67 2e2c 205b 2d31 3237      (e.g., [-127
+0003d630: 2e35 2c20 3132 372e 355d 206f 7220 5b30  .5, 127.5] or [0
+0003d640: 2c31 5d29 2e20 204f 7574 7075 7420 696d  ,1]).  Output im
+0003d650: 6167 6573 2077 696c 6c20 6265 2073 6361  ages will be sca
+0003d660: 6c65 6420 6261 636b 2074 6f20 6f72 6967  led back to orig
+0003d670: 696e 616c 0a20 2020 2020 2020 2069 6e74  inal.        int
+0003d680: 656e 7369 7479 2e20 5468 6973 2072 616e  ensity. This ran
+0003d690: 6765 2073 686f 756c 6420 6d61 7463 6820  ge should match 
+0003d6a0: 7468 6520 6d61 7070 696e 6720 7573 6564  the mapping used
+0003d6b0: 2069 6e20 7468 6520 7472 6169 6e69 6e67   in the training
+0003d6c0: 0a20 2020 2020 2020 206f 6620 7468 6520  .        of the 
+0003d6d0: 6e65 7477 6f72 6b2e 0a20 2020 200a 2020  network..    .  
+0003d6e0: 2020 6474 695f 6d6f 7469 6f6e 5f63 6f72    dti_motion_cor
+0003d6f0: 7265 6374 203a 204e 6f6e 6520 5269 6769  rect : None Rigi
+0003d700: 6420 6f72 2053 794e 0a0a 2020 2020 6474  d or SyN..    dt
+0003d710: 695f 6465 6e6f 6973 6520 3a20 626f 6f6c  i_denoise : bool
+0003d720: 6561 6e0a 0a20 2020 2070 6572 6675 7369  ean..    perfusi
+0003d730: 6f6e 5f74 7269 6d20 3a20 6f70 7469 6f6e  on_trim : option
+0003d740: 616c 2069 6e74 6567 6572 206e 756d 6265  al integer numbe
+0003d750: 7220 6f66 2074 696d 6520 766f 6c75 6d65  r of time volume
+0003d760: 7320 746f 2065 7863 6c75 6465 2066 726f  s to exclude fro
+0003d770: 6d20 7468 6520 6672 6f6e 7420 6f66 2074  m the front of t
+0003d780: 6865 2070 6572 6675 7369 6f6e 2074 696d  he perfusion tim
+0003d790: 6520 7365 7269 6573 0a0a 2020 2020 7065  e series..    pe
+0003d7a0: 7266 7573 696f 6e5f 6d30 5f69 6d61 6765  rfusion_m0_image
+0003d7b0: 203a 206f 7074 696f 6e61 6c20 616e 7473   : optional ants
+0003d7c0: 496d 6167 6520 6d30 2061 7373 6f63 6961  Image m0 associa
+0003d7d0: 7465 6420 7769 7468 2074 6865 2070 6572  ted with the per
+0003d7e0: 6675 7369 6f6e 2074 696d 6520 7365 7269  fusion time seri
+0003d7f0: 6573 0a0a 2020 2020 7065 7266 7573 696f  es..    perfusio
+0003d800: 6e5f 6d30 203a 206f 7074 696f 6e61 6c20  n_m0 : optional 
+0003d810: 6c69 7374 2063 6f6e 7461 696e 696e 6720  list containing 
+0003d820: 696e 6469 6365 7320 6f66 2074 6865 206d  indices of the m
+0003d830: 3020 696e 2074 6865 2070 6572 6675 7369  0 in the perfusi
+0003d840: 6f6e 2074 696d 6520 7365 7269 6573 0a0a  on time series..
+0003d850: 2020 2020 7273 665f 7570 7361 6d70 6c69      rsf_upsampli
+0003d860: 6e67 203a 206f 7074 696f 6e61 6c20 7570  ng : optional up
+0003d870: 7361 6d70 6c69 6e67 2070 6172 616d 6574  sampling paramet
+0003d880: 6572 2076 616c 7565 2069 6e20 6d6d 3b20  er value in mm; 
+0003d890: 6966 2073 6574 2074 6f20 7a65 726f 2c20  if set to zero, 
+0003d8a0: 6e6f 2075 7073 616d 706c 696e 6720 6973  no upsampling is
+0003d8b0: 2064 6f6e 650a 0a20 2020 2074 6573 745f   done..    test_
+0003d8c0: 7275 6e20 3a20 626f 6f6c 6561 6e20 0a0a  run : boolean ..
+0003d8d0: 2020 2020 7665 7262 6f73 6520 3a20 626f      verbose : bo
+0003d8e0: 6f6c 6561 6e0a 0a20 2020 2022 2222 0a20  olean..    """. 
+0003d8f0: 2020 2066 726f 6d20 6f73 2e70 6174 6820     from os.path 
+0003d900: 696d 706f 7274 2065 7869 7374 730a 2020  import exists.  
+0003d910: 2020 6578 5f70 6174 6820 3d20 6f73 2e70    ex_path = os.p
+0003d920: 6174 682e 6578 7061 6e64 7573 6572 2820  ath.expanduser( 
+0003d930: 227e 2f2e 616e 7473 7079 7431 772f 2220  "~/.antspyt1w/" 
+0003d940: 290a 2020 2020 6578 5f70 6174 685f 6d6d  ).    ex_path_mm
+0003d950: 203d 206f 732e 7061 7468 2e65 7870 616e   = os.path.expan
+0003d960: 6475 7365 7228 2022 7e2f 2e61 6e74 7370  duser( "~/.antsp
+0003d970: 796d 6d2f 2220 290a 2020 2020 6d79 6373  ymm/" ).    mycs
+0003d980: 7666 6e20 3d20 6578 5f70 6174 6820 2b20  vfn = ex_path + 
+0003d990: 2246 415f 4a48 555f 6c61 6265 6c73 5f65  "FA_JHU_labels_e
+0003d9a0: 6469 7465 642e 6373 7622 0a20 2020 2063  dited.csv".    c
+0003d9b0: 6974 6373 7666 6e20 3d20 6578 5f70 6174  itcsvfn = ex_pat
+0003d9c0: 6820 2b20 2243 4954 3136 385f 5265 696e  h + "CIT168_Rein
+0003d9d0: 665f 4c65 6172 6e5f 7631 5f6c 6162 656c  f_Learn_v1_label
+0003d9e0: 5f64 6573 6372 6970 7469 6f6e 735f 7061  _descriptions_pa
+0003d9f0: 642e 6373 7622 0a20 2020 2064 6b74 6373  d.csv".    dktcs
+0003da00: 7666 6e20 3d20 6578 5f70 6174 6820 2b20  vfn = ex_path + 
+0003da10: 2264 6b74 2e63 7376 220a 2020 2020 636e  "dkt.csv".    cn
+0003da20: 7863 7376 666e 203d 2065 785f 7061 7468  xcsvfn = ex_path
+0003da30: 202b 2022 646b 745f 636f 7274 6578 5f63   + "dkt_cortex_c
+0003da40: 6974 5f64 6565 705f 6272 6169 6e2e 6373  it_deep_brain.cs
+0003da50: 7622 0a20 2020 204a 4855 5f61 746c 6173  v".    JHU_atlas
+0003da60: 666e 203d 2065 785f 7061 7468 202b 2027  fn = ex_path + '
+0003da70: 4a48 552d 4943 424d 2d46 412d 316d 6d2e  JHU-ICBM-FA-1mm.
+0003da80: 6e69 692e 677a 2720 2320 5265 6164 2069  nii.gz' # Read i
+0003da90: 6e20 4a48 5520 6174 6c61 730a 2020 2020  n JHU atlas.    
+0003daa0: 4a48 555f 6c61 6265 6c73 666e 203d 2065  JHU_labelsfn = e
+0003dab0: 785f 7061 7468 202b 2027 4a48 552d 4943  x_path + 'JHU-IC
+0003dac0: 424d 2d6c 6162 656c 732d 316d 6d2e 6e69  BM-labels-1mm.ni
+0003dad0: 692e 677a 2720 2320 5265 6164 2069 6e20  i.gz' # Read in 
+0003dae0: 4a48 5520 6c61 6265 6c73 0a20 2020 2074  JHU labels.    t
+0003daf0: 656d 706c 6174 6566 6e20 3d20 6578 5f70  emplatefn = ex_p
+0003db00: 6174 6820 2b20 2743 4954 3136 385f 5431  ath + 'CIT168_T1
+0003db10: 775f 3730 3075 6d5f 7061 645f 6164 6e69  w_700um_pad_adni
+0003db20: 2e6e 6969 2e67 7a27 0a20 2020 2069 6620  .nii.gz'.    if 
+0003db30: 6e6f 7420 6578 6973 7473 2820 6d79 6373  not exists( mycs
+0003db40: 7666 6e20 2920 6f72 206e 6f74 2065 7869  vfn ) or not exi
+0003db50: 7374 7328 2063 6974 6373 7666 6e20 2920  sts( citcsvfn ) 
+0003db60: 6f72 206e 6f74 2065 7869 7374 7328 2063  or not exists( c
+0003db70: 6e78 6373 7666 6e20 2920 6f72 206e 6f74  nxcsvfn ) or not
+0003db80: 2065 7869 7374 7328 2064 6b74 6373 7666   exists( dktcsvf
+0003db90: 6e20 2920 6f72 206e 6f74 2065 7869 7374  n ) or not exist
+0003dba0: 7328 204a 4855 5f61 746c 6173 666e 2029  s( JHU_atlasfn )
+0003dbb0: 206f 7220 6e6f 7420 6578 6973 7473 2820   or not exists( 
+0003dbc0: 4a48 555f 6c61 6265 6c73 666e 2029 206f  JHU_labelsfn ) o
+0003dbd0: 7220 6e6f 7420 6578 6973 7473 2820 7465  r not exists( te
+0003dbe0: 6d70 6c61 7465 666e 2029 3a0a 2020 2020  mplatefn ):.    
+0003dbf0: 2020 2020 7072 696e 7428 2022 2a2a 6d69      print( "**mi
+0003dc00: 7373 696e 6720 6669 6c65 732a 2a20 3d3e  ssing files** =>
+0003dc10: 2063 616c 6c20 6765 745f 6461 7461 2066   call get_data f
+0003dc20: 726f 6d20 6c61 7465 7374 2061 6e74 7370  rom latest antsp
+0003dc30: 7974 3177 2061 6e64 2061 6e74 7370 796d  yt1w and antspym
+0003dc40: 6d2e 2220 290a 2020 2020 2020 2020 7261  m." ).        ra
+0003dc50: 6973 6520 5661 6c75 6545 7272 6f72 2827  ise ValueError('
+0003dc60: 2a2a 6d69 7373 696e 6720 6669 6c65 732a  **missing files*
+0003dc70: 2a20 3d3e 2063 616c 6c20 6765 745f 6461  * => call get_da
+0003dc80: 7461 2066 726f 6d20 6c61 7465 7374 2061  ta from latest a
+0003dc90: 6e74 7370 7974 3177 2061 6e64 2061 6e74  ntspyt1w and ant
+0003dca0: 7370 796d 6d2e 2729 0a20 2020 206d 7963  spymm.').    myc
+0003dcb0: 7376 203d 2070 642e 7265 6164 5f63 7376  sv = pd.read_csv
+0003dcc0: 2820 206d 7963 7376 666e 2029 0a20 2020  (  mycsvfn ).   
+0003dcd0: 2063 6974 6373 7620 3d20 7064 2e72 6561   citcsv = pd.rea
+0003dce0: 645f 6373 7628 2020 6f73 2e70 6174 682e  d_csv(  os.path.
+0003dcf0: 6578 7061 6e64 7573 6572 2820 6369 7463  expanduser( citc
+0003dd00: 7376 666e 2029 2029 0a20 2020 2064 6b74  svfn ) ).    dkt
+0003dd10: 6373 7620 3d20 7064 2e72 6561 645f 6373  csv = pd.read_cs
+0003dd20: 7628 2020 6f73 2e70 6174 682e 6578 7061  v(  os.path.expa
+0003dd30: 6e64 7573 6572 2820 646b 7463 7376 666e  nduser( dktcsvfn
+0003dd40: 2029 2029 0a20 2020 2063 6e78 6373 7620   ) ).    cnxcsv 
+0003dd50: 3d20 7064 2e72 6561 645f 6373 7628 2020  = pd.read_csv(  
+0003dd60: 6f73 2e70 6174 682e 6578 7061 6e64 7573  os.path.expandus
+0003dd70: 6572 2820 636e 7863 7376 666e 2029 2029  er( cnxcsvfn ) )
+0003dd80: 0a20 2020 204a 4855 5f61 746c 6173 203d  .    JHU_atlas =
+0003dd90: 206d 6d5f 7265 6164 2820 4a48 555f 6174   mm_read( JHU_at
+0003dda0: 6c61 7366 6e20 2920 2320 5265 6164 2069  lasfn ) # Read i
+0003ddb0: 6e20 4a48 5520 6174 6c61 730a 2020 2020  n JHU atlas.    
+0003ddc0: 4a48 555f 6c61 6265 6c73 203d 206d 6d5f  JHU_labels = mm_
+0003ddd0: 7265 6164 2820 4a48 555f 6c61 6265 6c73  read( JHU_labels
+0003dde0: 666e 2029 2023 2052 6561 6420 696e 204a  fn ) # Read in J
+0003ddf0: 4855 206c 6162 656c 730a 2020 2020 7465  HU labels.    te
+0003de00: 6d70 6c61 7465 203d 206d 6d5f 7265 6164  mplate = mm_read
+0003de10: 2820 7465 6d70 6c61 7465 666e 2029 2023  ( templatefn ) #
+0003de20: 2052 6561 6420 696e 2074 656d 706c 6174   Read in templat
+0003de30: 650a 2020 2020 6966 2067 726f 7570 5f74  e.    if group_t
+0003de40: 656d 706c 6174 6520 6973 204e 6f6e 653a  emplate is None:
+0003de50: 0a20 2020 2020 2020 2067 726f 7570 5f74  .        group_t
+0003de60: 656d 706c 6174 6520 3d20 7465 6d70 6c61  emplate = templa
+0003de70: 7465 0a20 2020 2020 2020 2067 726f 7570  te.        group
+0003de80: 5f74 7261 6e73 666f 726d 203d 2064 6f5f  _transform = do_
+0003de90: 6e6f 726d 616c 697a 6174 696f 6e5b 2766  normalization['f
+0003dea0: 7764 7472 616e 7366 6f72 6d73 275d 0a20  wdtransforms']. 
+0003deb0: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
+0003dec0: 2020 2020 2020 2070 7269 6e74 2822 5573         print("Us
+0003ded0: 696e 6720 6772 6f75 7020 7465 6d70 6c61  ing group templa
+0003dee0: 7465 3a22 290a 2020 2020 2020 2020 7072  te:").        pr
+0003def0: 696e 7428 2067 726f 7570 5f74 656d 706c  int( group_templ
+0003df00: 6174 6520 290a 2020 2020 2323 2323 2323  ate ).    ######
+0003df10: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+0003df20: 2020 2020 2320 2054 3120 6869 6572 6172      #  T1 hierar
+0003df30: 6368 6963 616c 2020 230a 2020 2020 2323  chical  #.    ##
+0003df40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0003df50: 2323 230a 2020 2020 7431 696d 6762 726e  ###.    t1imgbrn
+0003df60: 203d 2068 6965 725b 2762 7261 696e 5f6e   = hier['brain_n
+0003df70: 345f 646e 7a27 5d0a 2020 2020 7431 6174  4_dnz'].    t1at
+0003df80: 726f 706f 7320 3d20 6869 6572 5b27 646b  ropos = hier['dk
+0003df90: 745f 7061 7263 275d 5b27 7469 7373 7565  t_parc']['tissue
+0003dfa0: 5f73 6567 6d65 6e74 6174 696f 6e27 5d0a  _segmentation'].
+0003dfb0: 2020 2020 6f75 7470 7574 5f64 6963 7420      output_dict 
+0003dfc0: 3d20 7b0a 2020 2020 2020 2020 276b 6b27  = {.        'kk'
+0003dfd0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+0003dfe0: 2772 7366 273a 204e 6f6e 652c 0a20 2020  'rsf': None,.   
+0003dff0: 2020 2020 2027 666c 6169 7227 203a 204e       'flair' : N
+0003e000: 6f6e 652c 0a20 2020 2020 2020 2027 4e4d  one,.        'NM
+0003e010: 2720 3a20 4e6f 6e65 2c0a 2020 2020 2020  ' : None,.      
+0003e020: 2020 2744 5449 2720 3a20 4e6f 6e65 2c0a    'DTI' : None,.
+0003e030: 2020 2020 2020 2020 2746 415f 7375 6d6d          'FA_summ
+0003e040: 2720 3a20 4e6f 6e65 2c0a 2020 2020 2020  ' : None,.      
+0003e050: 2020 274d 445f 7375 6d6d 2720 3a20 4e6f    'MD_summ' : No
+0003e060: 6e65 2c0a 2020 2020 2020 2020 2774 7261  ne,.        'tra
+0003e070: 6374 6f67 7261 7068 7927 203a 204e 6f6e  ctography' : Non
+0003e080: 652c 0a20 2020 2020 2020 2027 7472 6163  e,.        'trac
+0003e090: 746f 6772 6170 6879 5f63 6f6e 6e65 6374  tography_connect
+0003e0a0: 6976 6974 7927 203a 204e 6f6e 652c 0a20  ivity' : None,. 
+0003e0b0: 2020 2020 2020 2027 7065 7266 2720 3a20         'perf' : 
+0003e0c0: 4e6f 6e65 2c0a 2020 2020 7d0a 2020 2020  None,.    }.    
+0003e0d0: 6e6f 726d 616c 697a 6174 696f 6e5f 6469  normalization_di
+0003e0e0: 6374 203d 207b 0a20 2020 2020 2020 2027  ct = {.        '
+0003e0f0: 6b6b 5f6e 6f72 6d27 3a20 4e6f 6e65 2c0a  kk_norm': None,.
+0003e100: 2020 2020 2020 2020 274e 4d5f 6e6f 726d          'NM_norm
+0003e110: 2720 3a20 4e6f 6e65 2c0a 2020 2020 2020  ' : None,.      
+0003e120: 2020 2744 5449 5f6e 6f72 6d27 3a20 4e6f    'DTI_norm': No
+0003e130: 6e65 2c0a 2020 2020 2020 2020 2746 415f  ne,.        'FA_
+0003e140: 6e6f 726d 2720 3a20 4e6f 6e65 2c0a 2020  norm' : None,.  
+0003e150: 2020 2020 2020 274d 445f 6e6f 726d 2720        'MD_norm' 
+0003e160: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+0003e170: 2770 6572 665f 6e6f 726d 2720 3a20 4e6f  'perf_norm' : No
+0003e180: 6e65 2c0a 2020 2020 2020 2020 2761 6c66  ne,.        'alf
+0003e190: 665f 6e6f 726d 2720 3a20 4e6f 6e65 2c0a  f_norm' : None,.
+0003e1a0: 2020 2020 2020 2020 2766 616c 6666 5f6e          'falff_n
+0003e1b0: 6f72 6d27 203a 204e 6f6e 652c 0a20 2020  orm' : None,.   
+0003e1c0: 2020 2020 2027 4369 6e67 756c 6f6f 7065       'Cinguloope
+0003e1d0: 7263 756c 6172 5461 736b 436f 6e74 726f  rcularTaskContro
+0003e1e0: 6c5f 6e6f 726d 2720 3a20 4e6f 6e65 2c0a  l_norm' : None,.
+0003e1f0: 2020 2020 2020 2020 2744 6566 6175 6c74          'Default
+0003e200: 4d6f 6465 5f6e 6f72 6d27 203a 204e 6f6e  Mode_norm' : Non
+0003e210: 652c 0a20 2020 2020 2020 2027 4d65 6d6f  e,.        'Memo
+0003e220: 7279 5265 7472 6965 7661 6c5f 6e6f 726d  ryRetrieval_norm
+0003e230: 2720 3a20 4e6f 6e65 2c0a 2020 2020 2020  ' : None,.      
+0003e240: 2020 2756 656e 7472 616c 4174 7465 6e74    'VentralAttent
+0003e250: 696f 6e5f 6e6f 726d 2720 3a20 4e6f 6e65  ion_norm' : None
+0003e260: 2c0a 2020 2020 2020 2020 2756 6973 7561  ,.        'Visua
+0003e270: 6c5f 6e6f 726d 2720 3a20 4e6f 6e65 2c0a  l_norm' : None,.
+0003e280: 2020 2020 2020 2020 2746 726f 6e74 6f70          'Frontop
+0003e290: 6172 6965 7461 6c54 6173 6b43 6f6e 7472  arietalTaskContr
+0003e2a0: 6f6c 5f6e 6f72 6d27 203a 204e 6f6e 652c  ol_norm' : None,
+0003e2b0: 0a20 2020 2020 2020 2027 5361 6c69 656e  .        'Salien
+0003e2c0: 6365 5f6e 6f72 6d27 203a 204e 6f6e 652c  ce_norm' : None,
+0003e2d0: 0a20 2020 2020 2020 2027 5375 6263 6f72  .        'Subcor
+0003e2e0: 7469 6361 6c5f 6e6f 726d 2720 3a20 4e6f  tical_norm' : No
+0003e2f0: 6e65 2c0a 2020 2020 2020 2020 2744 6f72  ne,.        'Dor
+0003e300: 7361 6c41 7474 656e 7469 6f6e 5f6e 6f72  salAttention_nor
+0003e310: 6d27 203a 204e 6f6e 650a 2020 2020 7d0a  m' : None.    }.
+0003e320: 2020 2020 6966 2074 6573 745f 7275 6e3a      if test_run:
+0003e330: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0003e340: 6f75 7470 7574 5f64 6963 742c 206e 6f72  output_dict, nor
+0003e350: 6d61 6c69 7a61 7469 6f6e 5f64 6963 740a  malization_dict.
+0003e360: 0a20 2020 2069 6620 646f 5f6b 6b3a 0a20  .    if do_kk:. 
+0003e370: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+0003e380: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+0003e390: 7269 6e74 2827 6b6b 2729 0a20 2020 2020  rint('kk').     
+0003e3a0: 2020 206f 7574 7075 745f 6469 6374 5b27     output_dict['
+0003e3b0: 6b6b 275d 203d 2061 6e74 7370 7974 3177  kk'] = antspyt1w
+0003e3c0: 2e6b 656c 6c79 5f6b 6170 6f77 736b 695f  .kelly_kapowski_
+0003e3d0: 7468 6963 6b6e 6573 7328 2068 6965 725b  thickness( hier[
+0003e3e0: 2762 7261 696e 5f6e 345f 646e 7a27 5d2c  'brain_n4_dnz'],
+0003e3f0: 0a20 2020 2020 2020 2020 2020 206c 6162  .            lab
+0003e400: 656c 733d 6869 6572 5b27 646b 745f 7061  els=hier['dkt_pa
+0003e410: 7263 275d 5b27 646b 745f 636f 7274 6578  rc']['dkt_cortex
+0003e420: 275d 2c20 6974 6572 6174 696f 6e73 3d34  '], iterations=4
+0003e430: 3520 290a 2020 2020 6966 2020 7065 7266  5 ).    if  perf
+0003e440: 7573 696f 6e5f 696d 6167 6520 6973 206e  usion_image is n
+0003e450: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0003e460: 2069 6620 7065 7266 7573 696f 6e5f 696d   if perfusion_im
+0003e470: 6167 652e 7368 6170 655b 335d 203e 2031  age.shape[3] > 1
+0003e480: 3a20 2320 4649 584d 4520 2d20 6265 7474  : # FIXME - bett
+0003e490: 6572 2068 6575 7269 7374 6963 3f0a 2020  er heuristic?.  
+0003e4a0: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+0003e4b0: 5f64 6963 745b 2770 6572 6627 5d20 3d20  _dict['perf'] = 
+0003e4c0: 626f 6c64 5f70 6572 6675 7369 6f6e 280a  bold_perfusion(.
+0003e4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e4e0: 7065 7266 7573 696f 6e5f 696d 6167 652c  perfusion_image,
+0003e4f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003e500: 2074 315f 696d 6167 652c 0a20 2020 2020   t1_image,.     
+0003e510: 2020 2020 2020 2020 2020 2068 6965 725b             hier[
+0003e520: 2762 7261 696e 5f6e 345f 646e 7a27 5d2c  'brain_n4_dnz'],
+0003e530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003e540: 2074 3161 7472 6f70 6f73 2c0a 2020 2020   t1atropos,.    
+0003e550: 2020 2020 2020 2020 2020 2020 6869 6572              hier
+0003e560: 5b27 646b 745f 7061 7263 275d 5b27 646b  ['dkt_parc']['dk
+0003e570: 745f 636f 7274 6578 275d 202b 2068 6965  t_cortex'] + hie
+0003e580: 725b 2763 6974 3136 386c 6162 275d 2c0a  r['cit168lab'],.
+0003e590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e5a0: 6e5f 746f 5f74 7269 6d20 3d20 7065 7266  n_to_trim = perf
+0003e5b0: 7573 696f 6e5f 7472 696d 2c0a 2020 2020  usion_trim,.    
+0003e5c0: 2020 2020 2020 2020 2020 2020 6d30 5f69              m0_i
+0003e5d0: 6d61 6765 203d 2070 6572 6675 7369 6f6e  mage = perfusion
+0003e5e0: 5f6d 305f 696d 6167 652c 0a20 2020 2020  _m0_image,.     
+0003e5f0: 2020 2020 2020 2020 2020 206d 305f 696e             m0_in
+0003e600: 6469 6365 7320 3d20 7065 7266 7573 696f  dices = perfusio
+0003e610: 6e5f 6d30 2c0a 2020 2020 2020 2020 2020  n_m0,.          
+0003e620: 2020 2020 2020 7665 7262 6f73 653d 7665        verbose=ve
+0003e630: 7262 6f73 6520 290a 2020 2020 2323 2323  rbose ).    ####
+0003e640: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0003e650: 2323 2323 2323 2323 2323 2323 2323 2064  ############## d
+0003e660: 6f20 7468 6520 7273 6620 2e2e 2e2e 2e0a  o the rsf ......
+0003e670: 2020 2020 6966 206c 656e 2872 7366 5f69      if len(rsf_i
+0003e680: 6d61 6765 2920 3e20 303a 0a20 2020 2020  mage) > 0:.     
+0003e690: 2020 206d 795f 6d6f 7469 6f6e 5f74 7820     my_motion_tx 
+0003e6a0: 3d20 2752 6967 6964 270a 2020 2020 2020  = 'Rigid'.      
+0003e6b0: 2020 7273 665f 696d 6167 6520 3d20 5b69    rsf_image = [i
+0003e6c0: 2066 6f72 2069 2069 6e20 7273 665f 696d   for i in rsf_im
+0003e6d0: 6167 6520 6966 2069 2069 7320 6e6f 7420  age if i is not 
+0003e6e0: 4e6f 6e65 5d0a 2020 2020 2020 2020 6966  None].        if
+0003e6f0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+0003e700: 2020 2020 2020 7072 696e 7428 2772 7366        print('rsf
+0003e710: 206c 656e 6774 6820 2720 2b20 7374 7228   length ' + str(
+0003e720: 206c 656e 2820 7273 665f 696d 6167 6520   len( rsf_image 
+0003e730: 2920 2920 290a 2020 2020 2020 2020 6966  ) ) ).        if
+0003e740: 206c 656e 2820 7273 665f 696d 6167 6520   len( rsf_image 
+0003e750: 2920 3e3d 2032 3a20 2320 6173 7375 6d65  ) >= 2: # assume
+0003e760: 2032 2069 7320 7468 6520 6c61 7267 6573   2 is the larges
+0003e770: 7420 706f 7373 6962 6c65 2076 616c 7565  t possible value
+0003e780: 0a20 2020 2020 2020 2020 2020 2072 7366  .            rsf
+0003e790: 5f69 6d61 6765 3120 3d20 7273 665f 696d  _image1 = rsf_im
+0003e7a0: 6167 655b 305d 0a20 2020 2020 2020 2020  age[0].         
+0003e7b0: 2020 2072 7366 5f69 6d61 6765 3220 3d20     rsf_image2 = 
+0003e7c0: 7273 665f 696d 6167 655b 315d 0a20 2020  rsf_image[1].   
+0003e7d0: 2020 2020 2020 2020 2023 2062 7569 6c64           # build
+0003e7e0: 2061 2074 656d 706c 6174 6520 7468 656e   a template then
+0003e7f0: 206a 6f69 6e20 7468 6520 696d 6167 6573   join the images
+0003e800: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0003e810: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+0003e820: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
+0003e830: 696e 6974 6961 6c20 6176 6572 6167 6520  initial average 
+0003e840: 666f 7220 7273 6622 290a 2020 2020 2020  for rsf").      
+0003e850: 2020 2020 2020 7273 6661 7667 312c 2068        rsfavg1, h
+0003e860: 6c69 6e64 7320 3d20 6c6f 6f70 5f74 696d  linds = loop_tim
+0003e870: 6573 6572 6965 735f 6365 6e73 6f72 696e  eseries_censorin
+0003e880: 6728 2072 7366 5f69 6d61 6765 312c 2030  g( rsf_image1, 0
+0003e890: 2e31 2029 0a20 2020 2020 2020 2020 2020  .1 ).           
+0003e8a0: 2072 7366 6176 6731 3d67 6574 5f61 7665   rsfavg1=get_ave
+0003e8b0: 7261 6765 5f72 7366 2872 7366 6176 6731  rage_rsf(rsfavg1
+0003e8c0: 290a 2020 2020 2020 2020 2020 2020 7273  ).            rs
+0003e8d0: 6661 7667 322c 2068 6c69 6e64 7320 3d20  favg2, hlinds = 
+0003e8e0: 6c6f 6f70 5f74 696d 6573 6572 6965 735f  loop_timeseries_
+0003e8f0: 6365 6e73 6f72 696e 6728 2072 7366 5f69  censoring( rsf_i
+0003e900: 6d61 6765 322c 2030 2e31 2029 0a20 2020  mage2, 0.1 ).   
+0003e910: 2020 2020 2020 2020 2072 7366 6176 6732           rsfavg2
+0003e920: 3d67 6574 5f61 7665 7261 6765 5f72 7366  =get_average_rsf
+0003e930: 2872 7366 6176 6732 290a 2020 2020 2020  (rsfavg2).      
+0003e940: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
+0003e950: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003e960: 2020 7072 696e 7428 2274 656d 706c 6174    print("templat
+0003e970: 6520 6176 6572 6167 6520 666f 7220 7273  e average for rs
+0003e980: 6622 290a 2020 2020 2020 2020 2020 2020  f").            
+0003e990: 696e 6974 5f74 656d 7020 3d20 616e 7473  init_temp = ants
+0003e9a0: 2e69 6d61 6765 5f63 6c6f 6e65 2820 7273  .image_clone( rs
+0003e9b0: 6661 7667 3120 290a 2020 2020 2020 2020  favg1 ).        
+0003e9c0: 2020 2020 6966 2072 7366 5f69 6d61 6765      if rsf_image
+0003e9d0: 312e 7368 6170 655b 335d 203c 2072 7366  1.shape[3] < rsf
+0003e9e0: 5f69 6d61 6765 322e 7368 6170 655b 335d  _image2.shape[3]
+0003e9f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003ea00: 2020 696e 6974 5f74 656d 7020 3d20 616e    init_temp = an
+0003ea10: 7473 2e69 6d61 6765 5f63 6c6f 6e65 2820  ts.image_clone( 
+0003ea20: 7273 6661 7667 3220 290a 2020 2020 2020  rsfavg2 ).      
+0003ea30: 2020 2020 2020 626f 6c64 5465 6d70 6c61        boldTempla
+0003ea40: 7465 203d 2061 6e74 732e 6275 696c 645f  te = ants.build_
+0003ea50: 7465 6d70 6c61 7465 280a 2020 2020 2020  template(.      
+0003ea60: 2020 2020 2020 2020 2020 696e 6974 6961            initia
+0003ea70: 6c5f 7465 6d70 6c61 7465 203d 2069 6e69  l_template = ini
+0003ea80: 745f 7465 6d70 2c0a 2020 2020 2020 2020  t_temp,.        
+0003ea90: 2020 2020 2020 2020 696d 6167 655f 6c69          image_li
+0003eaa0: 7374 3d5b 7273 6661 7667 312c 7273 6661  st=[rsfavg1,rsfa
+0003eab0: 7667 325d 2c0a 2020 2020 2020 2020 2020  vg2],.          
+0003eac0: 2020 2020 2020 6974 6572 6174 696f 6e73        iterations
+0003ead0: 3d35 2c20 7665 7262 6f73 653d 4661 6c73  =5, verbose=Fals
+0003eae0: 6520 290a 2020 2020 2020 2020 2020 2020  e ).            
+0003eaf0: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+0003eb00: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0003eb10: 7428 226a 6f69 6e20 7468 6520 3220 7273  t("join the 2 rs
+0003eb20: 6622 290a 2020 2020 2020 2020 2020 2020  f").            
+0003eb30: 6966 2072 7366 5f69 6d61 6765 312e 7368  if rsf_image1.sh
+0003eb40: 6170 655b 335d 203e 2031 3020 616e 6420  ape[3] > 10 and 
+0003eb50: 7273 665f 696d 6167 6532 2e73 6861 7065  rsf_image2.shape
+0003eb60: 5b33 5d20 3e20 3130 3a0a 2020 2020 2020  [3] > 10:.      
+0003eb70: 2020 2020 2020 2020 2020 6c65 6164 766f            leadvo
+0003eb80: 6c73 203d 206c 6973 7428 7261 6e67 6528  ls = list(range(
+0003eb90: 3829 290a 2020 2020 2020 2020 2020 2020  8)).            
+0003eba0: 2020 2020 7273 665f 696d 6167 6532 203d      rsf_image2 =
+0003ebb0: 2072 656d 6f76 655f 766f 6c75 6d65 735f   remove_volumes_
+0003ebc0: 6672 6f6d 5f74 696d 6573 6572 6965 7328  from_timeseries(
+0003ebd0: 2072 7366 5f69 6d61 6765 322c 206c 6561   rsf_image2, lea
+0003ebe0: 6476 6f6c 7320 290a 2020 2020 2020 2020  dvols ).        
+0003ebf0: 2020 2020 2020 2020 7273 665f 696d 6167          rsf_imag
+0003ec00: 6520 3d20 6d65 7267 655f 7469 6d65 7365  e = merge_timese
+0003ec10: 7269 6573 5f64 6174 6128 2072 7366 5f69  ries_data( rsf_i
+0003ec20: 6d61 6765 312c 2072 7366 5f69 6d61 6765  mage1, rsf_image
+0003ec30: 3220 290a 2020 2020 2020 2020 2020 2020  2 ).            
+0003ec40: 656c 6966 2072 7366 5f69 6d61 6765 312e  elif rsf_image1.
+0003ec50: 7368 6170 655b 335d 203e 2072 7366 5f69  shape[3] > rsf_i
+0003ec60: 6d61 6765 322e 7368 6170 655b 335d 3a0a  mage2.shape[3]:.
+0003ec70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ec80: 7273 665f 696d 6167 6520 3d20 7273 665f  rsf_image = rsf_
+0003ec90: 696d 6167 6531 0a20 2020 2020 2020 2020  image1.         
+0003eca0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0003ecb0: 2020 2020 2020 2020 2072 7366 5f69 6d61           rsf_ima
+0003ecc0: 6765 203d 2072 7366 5f69 6d61 6765 320a  ge = rsf_image2.
+0003ecd0: 2020 2020 2020 2020 656c 6966 206c 656e          elif len
+0003ece0: 2820 7273 665f 696d 6167 6520 2920 3d3d  ( rsf_image ) ==
+0003ecf0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+0003ed00: 7273 665f 696d 6167 6520 3d20 7273 665f  rsf_image = rsf_
+0003ed10: 696d 6167 655b 305d 0a20 2020 2020 2020  image[0].       
+0003ed20: 2020 2020 2062 6f6c 6454 656d 706c 6174       boldTemplat
+0003ed30: 652c 2068 6c69 6e64 7320 3d20 6c6f 6f70  e, hlinds = loop
+0003ed40: 5f74 696d 6573 6572 6965 735f 6365 6e73  _timeseries_cens
+0003ed50: 6f72 696e 6728 2072 7366 5f69 6d61 6765  oring( rsf_image
+0003ed60: 2c20 302e 3120 290a 2020 2020 2020 2020  , 0.1 ).        
+0003ed70: 2020 2020 626f 6c64 5465 6d70 6c61 7465      boldTemplate
+0003ed80: 203d 2067 6574 5f61 7665 7261 6765 5f72   = get_average_r
+0003ed90: 7366 2862 6f6c 6454 656d 706c 6174 6529  sf(boldTemplate)
+0003eda0: 0a20 2020 2020 2020 2069 6620 7273 665f  .        if rsf_
+0003edb0: 696d 6167 652e 7368 6170 655b 335d 203e  image.shape[3] >
+0003edc0: 2031 303a 2023 2046 4958 4d45 202d 2062   10: # FIXME - b
+0003edd0: 6574 7465 7220 6865 7572 6973 7469 633f  etter heuristic?
+0003ede0: 0a20 2020 2020 2020 2020 2020 2072 7366  .            rsf
+0003edf0: 7072 6f6c 6973 7420 3d20 5b5d 2023 2046  prolist = [] # F
+0003ee00: 4958 4d45 5253 460a 2020 2020 2020 2020  IXMERSF.        
+0003ee10: 2020 2020 2320 4372 6561 7465 2074 6865      # Create the
+0003ee20: 2070 6172 616d 6574 6572 2044 6174 6146   parameter DataF
+0003ee30: 7261 6d65 0a20 2020 2020 2020 2020 2020  rame.           
+0003ee40: 2064 6620 3d20 7064 2e44 6174 6146 7261   df = pd.DataFra
+0003ee50: 6d65 287b 0a20 2020 2020 2020 2020 2020  me({.           
+0003ee60: 2020 2020 2022 6e75 6d22 3a20 5b31 3334       "num": [134
+0003ee70: 2c20 3132 322c 2031 3239 5d2c 0a20 2020  , 122, 129],.   
+0003ee80: 2020 2020 2020 2020 2020 2020 2022 6c6f               "lo
+0003ee90: 6f70 223a 205b 302e 3530 2c20 302e 3235  op": [0.50, 0.25
+0003eea0: 2c20 302e 3530 5d2c 0a20 2020 2020 2020  , 0.50],.       
+0003eeb0: 2020 2020 2020 2020 2022 6365 6e73 223a           "cens":
+0003eec0: 205b 5472 7565 2c20 5472 7565 2c20 5472   [True, True, Tr
+0003eed0: 7565 5d2c 0a20 2020 2020 2020 2020 2020  ue],.           
+0003eee0: 2020 2020 2022 484d 223a 205b 312e 302c       "HM": [1.0,
+0003eef0: 2035 2e30 2c20 302e 355d 2c0a 2020 2020   5.0, 0.5],.    
+0003ef00: 2020 2020 2020 2020 2020 2020 2266 6622              "ff"
+0003ef10: 3a20 5b22 7469 6768 7422 2c20 2274 6967  : ["tight", "tig
+0003ef20: 6874 222c 2022 7469 6768 7422 5d2c 0a20  ht", "tight"],. 
+0003ef30: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0003ef40: 4343 223a 205b 352c 2035 2c20 302e 385d  CC": [5, 5, 0.8]
+0003ef50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003ef60: 2020 2269 6d70 223a 205b 5472 7565 2c20    "imp": [True, 
+0003ef70: 5472 7565 2c20 5472 7565 5d2c 0a20 2020  True, True],.   
+0003ef80: 2020 2020 2020 2020 2020 2020 2022 7570               "up
+0003ef90: 223a 205b 7273 665f 7570 7361 6d70 6c69  ": [rsf_upsampli
+0003efa0: 6e67 2c20 7273 665f 7570 7361 6d70 6c69  ng, rsf_upsampli
+0003efb0: 6e67 2c20 7273 665f 7570 7361 6d70 6c69  ng, rsf_upsampli
+0003efc0: 6e67 5d2c 0a20 2020 2020 2020 2020 2020  ng],.           
+0003efd0: 2020 2020 2022 636f 6f72 6473 223a 205b       "coords": [
+0003efe0: 4661 6c73 652c 4661 6c73 652c 4661 6c73  False,False,Fals
+0003eff0: 655d 0a20 2020 2020 2020 2020 2020 207d  e].            }
+0003f000: 2c20 696e 6465 783d 5b30 2c20 312c 2032  , index=[0, 1, 2
+0003f010: 5d29 0a20 2020 2020 2020 2020 2020 2066  ]).            f
+0003f020: 6f72 2070 2069 6e20 7261 6e67 6528 6466  or p in range(df
+0003f030: 2e73 6861 7065 5b30 5d29 3a0a 2020 2020  .shape[0]):.    
+0003f040: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+0003f050: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+0003f060: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0003f070: 7428 2272 7366 2070 6172 616d 6574 6572  t("rsf parameter
+0003f080: 7322 290a 2020 2020 2020 2020 2020 2020  s").            
+0003f090: 2020 2020 2020 2020 7072 696e 7428 2064          print( d
+0003f0a0: 662e 696c 6f63 5b70 5d20 290a 2020 2020  f.iloc[p] ).    
+0003f0b0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+0003f0c0: 665b 2766 6627 5d2e 696c 6f63 5b70 5d20  f['ff'].iloc[p] 
+0003f0d0: 3d3d 2027 6272 6f61 6427 3a0a 2020 2020  == 'broad':.    
+0003f0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f0f0: 663d 5b20 302e 3030 382c 2030 2e31 3520  f=[ 0.008, 0.15 
+0003f100: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0003f110: 2020 656c 6966 2064 665b 2766 6627 5d2e    elif df['ff'].
+0003f120: 696c 6f63 5b70 5d20 3d3d 2027 7469 6768  iloc[p] == 'tigh
+0003f130: 7427 3a0a 2020 2020 2020 2020 2020 2020  t':.            
+0003f140: 2020 2020 2020 2020 663d 5b20 302e 3033          f=[ 0.03
+0003f150: 2c20 302e 3038 205d 0a20 2020 2020 2020  , 0.08 ].       
+0003f160: 2020 2020 2020 2020 2065 6c69 6620 6466           elif df
+0003f170: 5b27 6666 275d 2e69 6c6f 635b 705d 203d  ['ff'].iloc[p] =
+0003f180: 3d20 276d 6964 273a 0a20 2020 2020 2020  = 'mid':.       
+0003f190: 2020 2020 2020 2020 2020 2020 2066 3d5b               f=[
+0003f1a0: 2030 2e30 312c 2030 2e31 205d 0a20 2020   0.01, 0.1 ].   
+0003f1b0: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+0003f1c0: 6620 6466 5b27 6666 275d 2e69 6c6f 635b  f df['ff'].iloc[
+0003f1d0: 705d 203d 3d20 276d 6964 3227 3a0a 2020  p] == 'mid2':.  
 0003f1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f1f0: 2020 2020 2020 6e63 203d 2043 432c 0a20        nc = CC,. 
-0003f200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f220: 2020 2020 2020 2020 2020 206f 7574 6c69             outli
-0003f230: 6572 5f74 6872 6573 686f 6c64 3d6c 6f6f  er_threshold=loo
-0003f240: 702c 0a20 2020 2020 2020 2020 2020 2020  p,.             
-0003f250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f260: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0003f270: 6361 5f63 6f6d 706f 6e65 6e74 7320 3d20  ca_components = 
-0003f280: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
-0003f290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f2a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0003f2b0: 6d70 7574 6520 3d20 696d 702c 0a20 2020  mpute = imp,.   
-0003f2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f2e0: 2020 2020 2020 2020 2063 656e 736f 7220           censor 
-0003f2f0: 3d20 6365 6e73 2c0a 2020 2020 2020 2020  = cens,.        
-0003f300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f320: 2020 2020 6465 7370 696b 6520 3d20 322e      despike = 2.
-0003f330: 352c 0a20 2020 2020 2020 2020 2020 2020  5,.             
-0003f340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f350: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0003f360: 6f74 696f 6e5f 6173 5f6e 7569 7361 6e63  otion_as_nuisanc
-0003f370: 6520 3d20 5472 7565 2c0a 2020 2020 2020  e = True,.      
-0003f380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f3a0: 2020 2020 2020 7570 7361 6d70 6c65 3d64        upsample=d
-0003f3b0: 665b 2775 7027 5d2e 696c 6f63 5b70 5d2c  f['up'].iloc[p],
-0003f3c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f1f0: 2020 663d 5b20 302e 3031 2c20 302e 3038    f=[ 0.01, 0.08
+0003f200: 205d 0a20 2020 2020 2020 2020 2020 2020   ].             
+0003f210: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0003f220: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0003f230: 7365 2056 616c 7565 4572 726f 7228 2277  se ValueError("w
+0003f240: 6520 646f 206e 6f74 2072 6563 6f67 6e69  e do not recogni
+0003f250: 7a65 2074 6869 7320 7061 7261 6d65 7465  ze this paramete
+0003f260: 7220 6368 6f69 6365 2066 6f72 2066 7265  r choice for fre
+0003f270: 7175 656e 6379 2066 696c 7465 7269 6e67  quency filtering
+0003f280: 3a20 2220 2b20 6466 5b27 6666 275d 2e69  : " + df['ff'].i
+0003f290: 6c6f 635b 705d 2029 0a20 2020 2020 2020  loc[p] ).       
+0003f2a0: 2020 2020 2020 2020 2048 4d20 3d20 6466           HM = df
+0003f2b0: 5b27 484d 275d 2e69 6c6f 635b 705d 0a20  ['HM'].iloc[p]. 
+0003f2c0: 2020 2020 2020 2020 2020 2020 2020 2043                 C
+0003f2d0: 4320 3d20 6466 5b27 4343 275d 2e69 6c6f  C = df['CC'].ilo
+0003f2e0: 635b 705d 0a20 2020 2020 2020 2020 2020  c[p].           
+0003f2f0: 2020 2020 206c 6f6f 703d 2064 665b 276c       loop= df['l
+0003f300: 6f6f 7027 5d2e 696c 6f63 5b70 5d0a 2020  oop'].iloc[p].  
+0003f310: 2020 2020 2020 2020 2020 2020 2020 6365                ce
+0003f320: 6e73 203d 6466 5b27 6365 6e73 275d 2e69  ns =df['cens'].i
+0003f330: 6c6f 635b 705d 0a20 2020 2020 2020 2020  loc[p].         
+0003f340: 2020 2020 2020 2069 6d70 203d 2064 665b         imp = df[
+0003f350: 2769 6d70 275d 2e69 6c6f 635b 705d 0a20  'imp'].iloc[p]. 
+0003f360: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0003f370: 7366 3020 3d20 7265 7374 696e 675f 7374  sf0 = resting_st
+0003f380: 6174 655f 666d 7269 5f6e 6574 776f 726b  ate_fmri_network
+0003f390: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
+0003f3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f3b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0003f3c0: 7366 5f69 6d61 6765 2c0a 2020 2020 2020  sf_image,.      
 0003f3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f3e0: 2020 2020 2020 2020 2020 2020 2063 6c65               cle
-0003f3f0: 616e 5f74 6d70 3d30 2e36 362c 0a20 2020  an_tmp=0.66,.   
-0003f400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f3f0: 2020 2020 2020 626f 6c64 5465 6d70 6c61        boldTempla
+0003f400: 7465 2c0a 2020 2020 2020 2020 2020 2020  te,.            
 0003f410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f420: 2020 2020 2020 2020 2070 6172 616d 7365           paramse
-0003f430: 743d 6466 5b27 6e75 6d27 5d2e 696c 6f63  t=df['num'].iloc
-0003f440: 5b70 5d2c 0a20 2020 2020 2020 2020 2020  [p],.           
+0003f420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f430: 6869 6572 5b27 6272 6169 6e5f 6e34 5f64  hier['brain_n4_d
+0003f440: 6e7a 275d 2c0a 2020 2020 2020 2020 2020  nz'],.          
 0003f450: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0003f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f470: 2070 6f77 6572 733d 6466 5b27 636f 6f72   powers=df['coor
-0003f480: 6473 275d 2e69 6c6f 635b 705d 2c0a 2020  ds'].iloc[p],.  
+0003f470: 2020 7431 6174 726f 706f 732c 0a20 2020    t1atropos,.   
+0003f480: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0003f490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f4b0: 2020 2020 2020 2020 2020 7665 7262 6f73            verbos
-0003f4c0: 653d 7665 7262 6f73 6520 2920 2320 6465  e=verbose ) # de
-0003f4d0: 6661 756c 740a 2020 2020 2020 2020 2020  fault.          
-0003f4e0: 2020 2020 2020 7273 6670 726f 6c69 7374        rsfprolist
-0003f4f0: 2e61 7070 656e 6428 2072 7366 3020 290a  .append( rsf0 ).
-0003f500: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
-0003f510: 7574 5f64 6963 745b 2772 7366 275d 203d  ut_dict['rsf'] =
-0003f520: 2072 7366 7072 6f6c 6973 740a 2020 2020   rsfprolist.    
-0003f530: 2020 2020 2020 2020 6966 2046 616c 7365          if False
-0003f540: 3a20 2023 2074 6869 7320 6973 2074 6865  :  # this is the
-0003f550: 206f 6c64 2070 6172 616d 6574 6572 2073   old parameter s
-0003f560: 6561 7263 6820 7374 7566 660a 2020 2020  earch stuff.    
-0003f570: 2020 2020 2020 2020 2020 2020 2320 496e              # In
-0003f580: 6974 6961 6c69 7a65 2074 6865 2070 6172  itialize the par
-0003f590: 616d 6574 6572 7320 4461 7461 4672 616d  ameters DataFram
-0003f5a0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0003f5b0: 2020 2320 6669 7273 7420 2d20 6e6f 2063    # first - no c
-0003f5c0: 656e 736f 7269 6e67 202d 206a 7573 7420  ensoring - just 
-0003f5d0: 6578 706c 6f72 6520 636f 6d70 636f 720a  explore compcor.
+0003f4a0: 2020 2020 2020 2020 2066 3d66 2c0a 2020           f=f,.  
+0003f4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f4d0: 2020 2020 2020 2020 2020 4644 5f74 6872            FD_thr
+0003f4e0: 6573 686f 6c64 3d48 4d2c 200a 2020 2020  eshold=HM, .    
+0003f4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f510: 2020 2020 2020 2020 7370 6120 3d20 4e6f          spa = No
+0003f520: 6e65 2c20 0a20 2020 2020 2020 2020 2020  ne, .           
+0003f530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f550: 2073 7074 203d 204e 6f6e 652c 200a 2020   spt = None, .  
+0003f560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f580: 2020 2020 2020 2020 2020 6e63 203d 2043            nc = C
+0003f590: 432c 0a20 2020 2020 2020 2020 2020 2020  C,.             
+0003f5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f5b0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0003f5c0: 7574 6c69 6572 5f74 6872 6573 686f 6c64  utlier_threshold
+0003f5d0: 3d6c 6f6f 702c 0a20 2020 2020 2020 2020  =loop,.         
 0003f5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f5f0: 6466 203d 2070 642e 4461 7461 4672 616d  df = pd.DataFram
-0003f600: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-0003f610: 2020 2020 6365 6e73 3d46 616c 7365 0a20      cens=False. 
-0003f620: 2020 2020 2020 2020 2020 2020 2020 2048                 H
-0003f630: 4d3d 312e 3020 2320 6265 7374 2062 7920  M=1.0 # best by 
-0003f640: 5054 4250 0a20 2020 2020 2020 2020 2020  PTBP.           
-0003f650: 2020 2020 2068 6d73 6561 7263 6820 3d20       hmsearch = 
-0003f660: 5b30 2e35 2c20 312e 302c 2035 2e30 205d  [0.5, 1.0, 5.0 ]
-0003f670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003f680: 206c 6f6f 7073 6561 7263 6820 3d20 5b20   loopsearch = [ 
-0003f690: 302e 3235 2c20 302e 352c 2030 2e37 352c  0.25, 0.5, 0.75,
-0003f6a0: 2031 2e30 205d 0a20 2020 2020 2020 2020   1.0 ].         
-0003f6b0: 2020 2020 2020 206c 6f6f 7020 3d20 312e         loop = 1.
-0003f6c0: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-0003f6d0: 2020 4343 7365 6172 6368 203d 205b 2035    CCsearch = [ 5
-0003f6e0: 2c20 302e 3830 205d 0a20 2020 2020 2020  , 0.80 ].       
-0003f6f0: 2020 2020 2020 2020 2064 6566 6175 6c74           default
-0003f700: 6620 3d20 5b20 302e 3030 382c 2030 2e31  f = [ 0.008, 0.1
-0003f710: 3520 5d0a 2020 2020 2020 2020 2020 2020  5 ].            
-0003f720: 2020 2020 6672 6571 7365 6172 6368 203d      freqsearch =
-0003f730: 205b 2762 726f 6164 272c 276d 6964 272c   ['broad','mid',
-0003f740: 2774 6967 6874 275d 2023 200a 2020 2020  'tight'] # .    
-0003f750: 2020 2020 2020 2020 2020 2020 2320 666f              # fo
-0003f760: 7220 6465 6275 6767 696e 0a20 2020 2020  r debuggin.     
-0003f770: 2020 2020 2020 2020 2020 2023 2072 7366             # rsf
-0003f780: 5f69 6d61 6765 203d 2072 656d 6f76 655f  _image = remove_
-0003f790: 766f 6c75 6d65 735f 6672 6f6d 5f74 696d  volumes_from_tim
-0003f7a0: 6573 6572 6965 7328 2072 7366 5f69 6d61  eseries( rsf_ima
-0003f7b0: 6765 2c20 6c69 7374 2872 616e 6765 2838  ge, list(range(8
-0003f7c0: 302c 3230 3030 2929 2920 0a20 2020 2020  0,2000))) .     
-0003f7d0: 2020 2020 2020 2020 2020 2064 6f63 656e             docen
-0003f7e0: 733d 5472 7565 2020 2020 2020 2020 2020  s=True          
-0003f7f0: 2020 2020 2020 2020 2020 2023 2065 7870             # exp
-0003f800: 6c6f 7265 2063 656e 736f 7269 6e67 0a20  lore censoring. 
-0003f810: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0003f820: 6f72 2066 6620 696e 2066 7265 7173 6561  or ff in freqsea
-0003f830: 7263 683a 0a20 2020 2020 2020 2020 2020  rch:.           
-0003f840: 2020 2020 2020 2020 2066 6f72 2043 4320           for CC 
-0003f850: 696e 2043 4373 6561 7263 683a 0a20 2020  in CCsearch:.   
-0003f860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f870: 2020 2020 206c 6f63 616c 5f64 6620 3d20       local_df = 
-0003f880: 7064 2e44 6174 6146 7261 6d65 287b 226c  pd.DataFrame({"l
-0003f890: 6f6f 7022 3a20 5b6c 6f6f 705d 2c20 2263  oop": [loop], "c
-0003f8a0: 656e 7322 3a20 5b63 656e 735d 2c20 2248  ens": [cens], "H
-0003f8b0: 4d22 3a20 5b48 4d5d 2c20 2266 6622 3a20  M": [HM], "ff": 
-0003f8c0: 5b66 665d 2c20 2243 4322 3a20 5b43 435d  [ff], "CC": [CC]
-0003f8d0: 7d29 0a20 2020 2020 2020 2020 2020 2020  }).             
-0003f8e0: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
-0003f8f0: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
+0003f5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f600: 2020 2069 6361 5f63 6f6d 706f 6e65 6e74     ica_component
+0003f610: 7320 3d20 302c 0a20 2020 2020 2020 2020  s = 0,.         
+0003f620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f640: 2020 2069 6d70 7574 6520 3d20 696d 702c     impute = imp,
+0003f650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f670: 2020 2020 2020 2020 2020 2020 2063 656e               cen
+0003f680: 736f 7220 3d20 6365 6e73 2c0a 2020 2020  sor = cens,.    
+0003f690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f6b0: 2020 2020 2020 2020 6465 7370 696b 6520          despike 
+0003f6c0: 3d20 322e 352c 0a20 2020 2020 2020 2020  = 2.5,.         
+0003f6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f6f0: 2020 206d 6f74 696f 6e5f 6173 5f6e 7569     motion_as_nui
+0003f700: 7361 6e63 6520 3d20 5472 7565 2c0a 2020  sance = True,.  
+0003f710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f730: 2020 2020 2020 2020 2020 7570 7361 6d70            upsamp
+0003f740: 6c65 3d64 665b 2775 7027 5d2e 696c 6f63  le=df['up'].iloc
+0003f750: 5b70 5d2c 0a20 2020 2020 2020 2020 2020  [p],.           
+0003f760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f780: 2063 6c65 616e 5f74 6d70 3d30 2e36 362c   clean_tmp=0.66,
+0003f790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f7b0: 2020 2020 2020 2020 2020 2020 2070 6172               par
+0003f7c0: 616d 7365 743d 6466 5b27 6e75 6d27 5d2e  amset=df['num'].
+0003f7d0: 696c 6f63 5b70 5d2c 0a20 2020 2020 2020  iloc[p],.       
+0003f7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f800: 2020 2020 2070 6f77 6572 733d 6466 5b27       powers=df['
+0003f810: 636f 6f72 6473 275d 2e69 6c6f 635b 705d  coords'].iloc[p]
+0003f820: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003f830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f840: 2020 2020 2020 2020 2020 2020 2020 7665                ve
+0003f850: 7262 6f73 653d 7665 7262 6f73 6520 2920  rbose=verbose ) 
+0003f860: 2320 6465 6661 756c 740a 2020 2020 2020  # default.      
+0003f870: 2020 2020 2020 2020 2020 7273 6670 726f            rsfpro
+0003f880: 6c69 7374 2e61 7070 656e 6428 2072 7366  list.append( rsf
+0003f890: 3020 290a 2020 2020 2020 2020 2020 2020  0 ).            
+0003f8a0: 6f75 7470 7574 5f64 6963 745b 2772 7366  output_dict['rsf
+0003f8b0: 275d 203d 2072 7366 7072 6f6c 6973 740a  '] = rsfprolist.
+0003f8c0: 2020 2020 2020 2020 2020 2020 6966 2046              if F
+0003f8d0: 616c 7365 3a20 2023 2074 6869 7320 6973  alse:  # this is
+0003f8e0: 2074 6865 206f 6c64 2070 6172 616d 6574   the old paramet
+0003f8f0: 6572 2073 6561 7263 6820 7374 7566 660a  er search stuff.
 0003f900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f910: 2020 2070 7269 6e74 2820 6c6f 6361 6c5f     print( local_
-0003f920: 6466 2029 0a20 2020 2020 2020 2020 2020  df ).           
-0003f930: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0003f940: 6466 2e73 6861 7065 5b30 5d20 3d3d 2030  df.shape[0] == 0
-0003f950: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003f960: 2020 2020 2020 2020 2020 2020 2020 6466                df
-0003f970: 203d 206c 6f63 616c 5f64 660a 2020 2020   = local_df.    
-0003f980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f990: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0003f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f9b0: 2020 2020 2020 6466 203d 2070 642e 636f        df = pd.co
-0003f9c0: 6e63 6174 285b 6466 2c20 6c6f 6361 6c5f  ncat([df, local_
-0003f9d0: 6466 5d2c 2069 676e 6f72 655f 696e 6465  df], ignore_inde
-0003f9e0: 783d 5472 7565 290a 2020 2020 2020 2020  x=True).        
-0003f9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fa00: 6620 3d20 6465 6661 756c 7466 0a20 2020  f = defaultf.   
-0003fa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fa20: 2020 2020 2069 6620 6666 203d 3d20 276d       if ff == 'm
-0003fa30: 6964 273a 0a20 2020 2020 2020 2020 2020  id':.           
-0003fa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fa50: 2066 203d 205b 302e 3031 2c30 2e31 5d0a   f = [0.01,0.1].
-0003fa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fa70: 2020 2020 2020 2020 656c 6966 2066 6620          elif ff 
-0003fa80: 3d3d 2027 7469 6768 7427 3a0a 2020 2020  == 'tight':.    
-0003fa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003faa0: 2020 2020 2020 2020 6620 3d20 5b30 2e30          f = [0.0
-0003fab0: 332c 302e 3038 5d0a 2020 2020 2020 2020  3,0.08].        
-0003fac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fad0: 7273 6630 203d 2072 6573 7469 6e67 5f73  rsf0 = resting_s
-0003fae0: 7461 7465 5f66 6d72 695f 6e65 7477 6f72  tate_fmri_networ
-0003faf0: 6b73 280a 2020 2020 2020 2020 2020 2020  ks(.            
-0003fb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fb10: 7273 665f 696d 6167 652c 2062 6f6c 6454  rsf_image, boldT
-0003fb20: 656d 706c 6174 652c 2068 6965 725b 2762  emplate, hier['b
-0003fb30: 7261 696e 5f6e 345f 646e 7a27 5d2c 2074  rain_n4_dnz'], t
-0003fb40: 3161 7472 6f70 6f73 2c0a 2020 2020 2020  1atropos,.      
-0003fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fb60: 2020 2020 2020 663d 662c 0a20 2020 2020        f=f,.     
-0003fb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fb80: 2020 2020 2020 2046 445f 7468 7265 7368         FD_thresh
-0003fb90: 6f6c 643d 484d 2c0a 2020 2020 2020 2020  old=HM,.        
-0003fba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fbb0: 2020 2020 7370 6120 3d20 4e6f 6e65 2c20      spa = None, 
-0003fbc0: 7370 7420 3d20 4e6f 6e65 2c20 0a20 2020  spt = None, .   
-0003fbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fbe0: 2020 2020 2020 2020 206e 6320 3d20 4343           nc = CC
-0003fbf0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-0003fc00: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0003fc10: 7574 6c69 6572 5f74 6872 6573 686f 6c64  utlier_threshold
-0003fc20: 3d6c 6f6f 702c 0a20 2020 2020 2020 2020  =loop,.         
-0003fc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fc40: 2020 2069 6361 5f63 6f6d 706f 6e65 6e74     ica_component
-0003fc50: 7320 3d20 302c 0a20 2020 2020 2020 2020  s = 0,.         
-0003fc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fc70: 2020 2069 6d70 7574 6520 3d20 4661 6c73     impute = Fals
-0003fc80: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0003fc90: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0003fca0: 656e 736f 7220 3d20 6365 6e73 2c0a 2020  ensor = cens,.  
-0003fcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fcc0: 2020 2020 2020 2020 2020 6465 7370 696b            despik
-0003fcd0: 6520 3d20 322e 352c 0a20 2020 2020 2020  e = 2.5,.       
-0003fce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fcf0: 2020 2020 206d 6f74 696f 6e5f 6173 5f6e       motion_as_n
-0003fd00: 7569 7361 6e63 6520 3d20 5472 7565 2c0a  uisance = True,.
+0003f910: 2320 496e 6974 6961 6c69 7a65 2074 6865  # Initialize the
+0003f920: 2070 6172 616d 6574 6572 7320 4461 7461   parameters Data
+0003f930: 4672 616d 650a 2020 2020 2020 2020 2020  Frame.          
+0003f940: 2020 2020 2020 2320 6669 7273 7420 2d20        # first - 
+0003f950: 6e6f 2063 656e 736f 7269 6e67 202d 206a  no censoring - j
+0003f960: 7573 7420 6578 706c 6f72 6520 636f 6d70  ust explore comp
+0003f970: 636f 720a 2020 2020 2020 2020 2020 2020  cor.            
+0003f980: 2020 2020 6466 203d 2070 642e 4461 7461      df = pd.Data
+0003f990: 4672 616d 6528 290a 2020 2020 2020 2020  Frame().        
+0003f9a0: 2020 2020 2020 2020 6365 6e73 3d46 616c          cens=Fal
+0003f9b0: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+0003f9c0: 2020 2048 4d3d 312e 3020 2320 6265 7374     HM=1.0 # best
+0003f9d0: 2062 7920 5054 4250 0a20 2020 2020 2020   by PTBP.       
+0003f9e0: 2020 2020 2020 2020 2068 6d73 6561 7263           hmsearc
+0003f9f0: 6820 3d20 5b30 2e35 2c20 312e 302c 2035  h = [0.5, 1.0, 5
+0003fa00: 2e30 205d 0a20 2020 2020 2020 2020 2020  .0 ].           
+0003fa10: 2020 2020 206c 6f6f 7073 6561 7263 6820       loopsearch 
+0003fa20: 3d20 5b20 302e 3235 2c20 302e 352c 2030  = [ 0.25, 0.5, 0
+0003fa30: 2e37 352c 2031 2e30 205d 0a20 2020 2020  .75, 1.0 ].     
+0003fa40: 2020 2020 2020 2020 2020 206c 6f6f 7020             loop 
+0003fa50: 3d20 312e 300a 2020 2020 2020 2020 2020  = 1.0.          
+0003fa60: 2020 2020 2020 4343 7365 6172 6368 203d        CCsearch =
+0003fa70: 205b 2035 2c20 302e 3830 205d 0a20 2020   [ 5, 0.80 ].   
+0003fa80: 2020 2020 2020 2020 2020 2020 2064 6566               def
+0003fa90: 6175 6c74 6620 3d20 5b20 302e 3030 382c  aultf = [ 0.008,
+0003faa0: 2030 2e31 3520 5d0a 2020 2020 2020 2020   0.15 ].        
+0003fab0: 2020 2020 2020 2020 6672 6571 7365 6172          freqsear
+0003fac0: 6368 203d 205b 2762 726f 6164 272c 276d  ch = ['broad','m
+0003fad0: 6964 272c 2774 6967 6874 275d 2023 200a  id','tight'] # .
+0003fae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003faf0: 2320 666f 7220 6465 6275 6767 696e 0a20  # for debuggin. 
+0003fb00: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0003fb10: 2072 7366 5f69 6d61 6765 203d 2072 656d   rsf_image = rem
+0003fb20: 6f76 655f 766f 6c75 6d65 735f 6672 6f6d  ove_volumes_from
+0003fb30: 5f74 696d 6573 6572 6965 7328 2072 7366  _timeseries( rsf
+0003fb40: 5f69 6d61 6765 2c20 6c69 7374 2872 616e  _image, list(ran
+0003fb50: 6765 2838 302c 3230 3030 2929 2920 0a20  ge(80,2000))) . 
+0003fb60: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0003fb70: 6f63 656e 733d 5472 7565 2020 2020 2020  ocens=True      
+0003fb80: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0003fb90: 2065 7870 6c6f 7265 2063 656e 736f 7269   explore censori
+0003fba0: 6e67 0a20 2020 2020 2020 2020 2020 2020  ng.             
+0003fbb0: 2020 2066 6f72 2066 6620 696e 2066 7265     for ff in fre
+0003fbc0: 7173 6561 7263 683a 0a20 2020 2020 2020  qsearch:.       
+0003fbd0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0003fbe0: 2043 4320 696e 2043 4373 6561 7263 683a   CC in CCsearch:
+0003fbf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003fc00: 2020 2020 2020 2020 206c 6f63 616c 5f64           local_d
+0003fc10: 6620 3d20 7064 2e44 6174 6146 7261 6d65  f = pd.DataFrame
+0003fc20: 287b 226c 6f6f 7022 3a20 5b6c 6f6f 705d  ({"loop": [loop]
+0003fc30: 2c20 2263 656e 7322 3a20 5b63 656e 735d  , "cens": [cens]
+0003fc40: 2c20 2248 4d22 3a20 5b48 4d5d 2c20 2266  , "HM": [HM], "f
+0003fc50: 6622 3a20 5b66 665d 2c20 2243 4322 3a20  f": [ff], "CC": 
+0003fc60: 5b43 435d 7d29 0a20 2020 2020 2020 2020  [CC]}).         
+0003fc70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0003fc80: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+0003fc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fca0: 2020 2020 2020 2070 7269 6e74 2820 6c6f         print( lo
+0003fcb0: 6361 6c5f 6466 2029 0a20 2020 2020 2020  cal_df ).       
+0003fcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fcd0: 2069 6620 6466 2e73 6861 7065 5b30 5d20   if df.shape[0] 
+0003fce0: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+0003fcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fd00: 2020 6466 203d 206c 6f63 616c 5f64 660a    df = local_df.
 0003fd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fd20: 2020 2020 2020 2020 2020 2020 7570 7361              upsa
-0003fd30: 6d70 6c65 3d46 616c 7365 2c0a 2020 2020  mple=False,.    
-0003fd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fd50: 2020 2020 2020 2020 636c 6561 6e5f 746d          clean_tm
-0003fd60: 703d 302e 3636 2c0a 2020 2020 2020 2020  p=0.66,.        
-0003fd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fd80: 2020 2020 7665 7262 6f73 653d 7665 7262      verbose=verb
-0003fd90: 6f73 6520 2920 2320 6465 6661 756c 740a  ose ) # default.
-0003fda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fdb0: 2020 2020 2020 2020 7273 6670 726f 6c69          rsfproli
-0003fdc0: 7374 2e61 7070 656e 6428 2072 7366 3020  st.append( rsf0 
-0003fdd0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0003fde0: 2020 2023 2074 6573 7420 696d 7061 6374     # test impact
-0003fdf0: 206f 6620 6365 6e73 6f72 696e 670a 2020   of censoring.  
-0003fe00: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0003fe10: 2064 6f63 656e 733a 0a20 2020 2020 2020   docens:.       
-0003fe20: 2020 2020 2020 2020 2020 2020 2063 656e               cen
-0003fe30: 7320 3d20 5472 7565 0a20 2020 2020 2020  s = True.       
-0003fe40: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0003fe50: 206c 6f6f 7020 696e 206c 6f6f 7073 6561   loop in loopsea
-0003fe60: 7263 683a 0a20 2020 2020 2020 2020 2020  rch:.           
-0003fe70: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0003fe80: 2048 4d20 696e 2068 6d73 6561 7263 683a   HM in hmsearch:
-0003fe90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003fea0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0003feb0: 2066 6620 696e 2066 7265 7173 6561 7263   ff in freqsearc
-0003fec0: 683a 0a20 2020 2020 2020 2020 2020 2020  h:.             
-0003fed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fee0: 2020 2066 6f72 2043 4320 696e 2043 4373     for CC in CCs
-0003fef0: 6561 7263 683a 0a20 2020 2020 2020 2020  earch:.         
+0003fd20: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0003fd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fd40: 2020 2020 2020 2020 2020 6466 203d 2070            df = p
+0003fd50: 642e 636f 6e63 6174 285b 6466 2c20 6c6f  d.concat([df, lo
+0003fd60: 6361 6c5f 6466 5d2c 2069 676e 6f72 655f  cal_df], ignore_
+0003fd70: 696e 6465 783d 5472 7565 290a 2020 2020  index=True).    
+0003fd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fd90: 2020 2020 6620 3d20 6465 6661 756c 7466      f = defaultf
+0003fda0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003fdb0: 2020 2020 2020 2020 2069 6620 6666 203d           if ff =
+0003fdc0: 3d20 276d 6964 273a 0a20 2020 2020 2020  = 'mid':.       
+0003fdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fde0: 2020 2020 2066 203d 205b 302e 3031 2c30       f = [0.01,0
+0003fdf0: 2e31 5d0a 2020 2020 2020 2020 2020 2020  .1].            
+0003fe00: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+0003fe10: 2066 6620 3d3d 2027 7469 6768 7427 3a0a   ff == 'tight':.
+0003fe20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fe30: 2020 2020 2020 2020 2020 2020 6620 3d20              f = 
+0003fe40: 5b30 2e30 332c 302e 3038 5d0a 2020 2020  [0.03,0.08].    
+0003fe50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fe60: 2020 2020 7273 6630 203d 2072 6573 7469      rsf0 = resti
+0003fe70: 6e67 5f73 7461 7465 5f66 6d72 695f 6e65  ng_state_fmri_ne
+0003fe80: 7477 6f72 6b73 280a 2020 2020 2020 2020  tworks(.        
+0003fe90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fea0: 2020 2020 7273 665f 696d 6167 652c 2062      rsf_image, b
+0003feb0: 6f6c 6454 656d 706c 6174 652c 2068 6965  oldTemplate, hie
+0003fec0: 725b 2762 7261 696e 5f6e 345f 646e 7a27  r['brain_n4_dnz'
+0003fed0: 5d2c 2074 3161 7472 6f70 6f73 2c0a 2020  ], t1atropos,.  
+0003fee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fef0: 2020 2020 2020 2020 2020 663d 662c 0a20            f=f,. 
 0003ff00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ff10: 2020 2020 2020 2020 2020 206c 6f63 616c             local
-0003ff20: 5f64 6620 3d20 7064 2e44 6174 6146 7261  _df = pd.DataFra
-0003ff30: 6d65 287b 226c 6f6f 7022 3a20 5b6c 6f6f  me({"loop": [loo
-0003ff40: 705d 2c20 2263 656e 7322 3a20 5b63 656e  p], "cens": [cen
-0003ff50: 735d 2c20 2248 4d22 3a20 5b48 4d5d 2c20  s], "HM": [HM], 
-0003ff60: 2266 6622 3a20 5b66 665d 2c20 2243 4322  "ff": [ff], "CC"
-0003ff70: 3a20 5b43 435d 7d29 0a20 2020 2020 2020  : [CC]}).       
-0003ff80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ff90: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0003ffa0: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-0003ffb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ff10: 2020 2020 2020 2020 2020 2046 445f 7468             FD_th
+0003ff20: 7265 7368 6f6c 643d 484d 2c0a 2020 2020  reshold=HM,.    
+0003ff30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ff40: 2020 2020 2020 2020 7370 6120 3d20 4e6f          spa = No
+0003ff50: 6e65 2c20 7370 7420 3d20 4e6f 6e65 2c20  ne, spt = None, 
+0003ff60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003ff70: 2020 2020 2020 2020 2020 2020 206e 6320               nc 
+0003ff80: 3d20 4343 2c20 0a20 2020 2020 2020 2020  = CC, .         
+0003ff90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ffa0: 2020 206f 7574 6c69 6572 5f74 6872 6573     outlier_thres
+0003ffb0: 686f 6c64 3d6c 6f6f 702c 0a20 2020 2020  hold=loop,.     
 0003ffc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ffd0: 2070 7269 6e74 2820 6c6f 6361 6c5f 6466   print( local_df
-0003ffe0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0003ffd0: 2020 2020 2020 2069 6361 5f63 6f6d 706f         ica_compo
+0003ffe0: 6e65 6e74 7320 3d20 302c 0a20 2020 2020  nents = 0,.     
 0003fff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040000: 2020 2020 2020 2064 6620 3d20 7064 2e63         df = pd.c
-00040010: 6f6e 6361 7428 5b64 662c 206c 6f63 616c  oncat([df, local
-00040020: 5f64 665d 2c20 6967 6e6f 7265 5f69 6e64  _df], ignore_ind
-00040030: 6578 3d54 7275 6529 0a20 2020 2020 2020  ex=True).       
-00040040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040050: 2020 2020 2020 2020 2020 2020 2066 203d               f =
-00040060: 2064 6566 6175 6c74 660a 2020 2020 2020   defaultf.      
+00040000: 2020 2020 2020 2069 6d70 7574 6520 3d20         impute = 
+00040010: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
+00040020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040030: 2020 2063 656e 736f 7220 3d20 6365 6e73     censor = cens
+00040040: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00040050: 2020 2020 2020 2020 2020 2020 2020 6465                de
+00040060: 7370 696b 6520 3d20 322e 352c 0a20 2020  spike = 2.5,.   
 00040070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040080: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00040090: 2066 6620 3d3d 2027 6d69 6427 3a0a 2020   ff == 'mid':.  
-000400a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040080: 2020 2020 2020 2020 206d 6f74 696f 6e5f           motion_
+00040090: 6173 5f6e 7569 7361 6e63 6520 3d20 5472  as_nuisance = Tr
+000400a0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
 000400b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000400c0: 2020 2020 2020 6620 3d20 5b30 2e30 312c        f = [0.01,
-000400d0: 302e 315d 0a20 2020 2020 2020 2020 2020  0.1].           
-000400e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000400f0: 2020 2020 2020 2020 2065 6c69 6620 6666           elif ff
-00040100: 203d 3d20 2774 6967 6874 273a 0a20 2020   == 'tight':.   
-00040110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040130: 2020 2020 2066 203d 205b 302e 3033 2c30       f = [0.03,0
-00040140: 2e30 385d 0a20 2020 2020 2020 2020 2020  .08].           
-00040150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040160: 2020 2020 2020 2020 2072 7366 3020 3d20           rsf0 = 
-00040170: 7265 7374 696e 675f 7374 6174 655f 666d  resting_state_fm
-00040180: 7269 5f6e 6574 776f 726b 7328 0a20 2020  ri_networks(.   
-00040190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000401a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000401b0: 2020 2020 2020 2020 2072 7366 5f69 6d61           rsf_ima
-000401c0: 6765 2c0a 2020 2020 2020 2020 2020 2020  ge,.            
+000400c0: 7570 7361 6d70 6c65 3d46 616c 7365 2c0a  upsample=False,.
+000400d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000400e0: 2020 2020 2020 2020 2020 2020 636c 6561              clea
+000400f0: 6e5f 746d 703d 302e 3636 2c0a 2020 2020  n_tmp=0.66,.    
+00040100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040110: 2020 2020 2020 2020 7665 7262 6f73 653d          verbose=
+00040120: 7665 7262 6f73 6520 2920 2320 6465 6661  verbose ) # defa
+00040130: 756c 740a 2020 2020 2020 2020 2020 2020  ult.            
+00040140: 2020 2020 2020 2020 2020 2020 7273 6670              rsfp
+00040150: 726f 6c69 7374 2e61 7070 656e 6428 2072  rolist.append( r
+00040160: 7366 3020 290a 0a20 2020 2020 2020 2020  sf0 )..         
+00040170: 2020 2020 2020 2023 2074 6573 7420 696d         # test im
+00040180: 7061 6374 206f 6620 6365 6e73 6f72 696e  pact of censorin
+00040190: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
+000401a0: 2020 6966 2064 6f63 656e 733a 0a20 2020    if docens:.   
+000401b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000401c0: 2063 656e 7320 3d20 5472 7565 0a20 2020   cens = True.   
 000401d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000401e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000401f0: 626f 6c64 5465 6d70 6c61 7465 2c0a 2020  boldTemplate,.  
+000401e0: 2066 6f72 206c 6f6f 7020 696e 206c 6f6f   for loop in loo
+000401f0: 7073 6561 7263 683a 0a20 2020 2020 2020  psearch:.       
 00040200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040220: 2020 2020 2020 2020 2020 6869 6572 5b27            hier['
-00040230: 6272 6169 6e5f 6e34 5f64 6e7a 275d 2c0a  brain_n4_dnz'],.
-00040240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040260: 2020 2020 2020 2020 2020 2020 7431 6174              t1at
-00040270: 726f 706f 732c 0a20 2020 2020 2020 2020  ropos,.         
-00040280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040210: 2066 6f72 2048 4d20 696e 2068 6d73 6561   for HM in hmsea
+00040220: 7263 683a 0a20 2020 2020 2020 2020 2020  rch:.           
+00040230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040240: 2066 6f72 2066 6620 696e 2066 7265 7173   for ff in freqs
+00040250: 6561 7263 683a 0a20 2020 2020 2020 2020  earch:.         
+00040260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040270: 2020 2020 2020 2066 6f72 2043 4320 696e         for CC in
+00040280: 2043 4373 6561 7263 683a 0a20 2020 2020   CCsearch:.     
 00040290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000402a0: 2020 2066 3d66 2c0a 2020 2020 2020 2020     f=f,.        
-000402b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000402c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000402d0: 2020 2020 4644 5f74 6872 6573 686f 6c64      FD_threshold
-000402e0: 3d48 4d2c 200a 2020 2020 2020 2020 2020  =HM, .          
-000402f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040310: 2020 7370 6120 3d20 4e6f 6e65 2c20 0a20    spa = None, . 
+000402a0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+000402b0: 6f63 616c 5f64 6620 3d20 7064 2e44 6174  ocal_df = pd.Dat
+000402c0: 6146 7261 6d65 287b 226c 6f6f 7022 3a20  aFrame({"loop": 
+000402d0: 5b6c 6f6f 705d 2c20 2263 656e 7322 3a20  [loop], "cens": 
+000402e0: 5b63 656e 735d 2c20 2248 4d22 3a20 5b48  [cens], "HM": [H
+000402f0: 4d5d 2c20 2266 6622 3a20 5b66 665d 2c20  M], "ff": [ff], 
+00040300: 2243 4322 3a20 5b43 435d 7d29 0a20 2020  "CC": [CC]}).   
+00040310: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00040320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040340: 2020 2020 2020 2020 2020 2073 7074 203d             spt =
-00040350: 204e 6f6e 652c 200a 2020 2020 2020 2020   None, .        
-00040360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040380: 2020 2020 6e63 203d 2043 432c 0a20 2020      nc = CC,.   
-00040390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000403a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000403b0: 2020 2020 2020 2020 206f 7574 6c69 6572           outlier
-000403c0: 5f74 6872 6573 686f 6c64 3d6c 6f6f 702c  _threshold=loop,
-000403d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00040330: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+00040340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040360: 2020 2020 2070 7269 6e74 2820 6c6f 6361       print( loca
+00040370: 6c5f 6466 2029 0a20 2020 2020 2020 2020  l_df ).         
+00040380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040390: 2020 2020 2020 2020 2020 2064 6620 3d20             df = 
+000403a0: 7064 2e63 6f6e 6361 7428 5b64 662c 206c  pd.concat([df, l
+000403b0: 6f63 616c 5f64 665d 2c20 6967 6e6f 7265  ocal_df], ignore
+000403c0: 5f69 6e64 6578 3d54 7275 6529 0a20 2020  _index=True).   
+000403d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000403e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000403f0: 2020 2020 2020 2020 2020 2020 2069 6361               ica
-00040400: 5f63 6f6d 706f 6e65 6e74 7320 3d20 302c  _components = 0,
-00040410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00040420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040430: 2020 2020 2020 2020 2020 2020 2069 6d70               imp
-00040440: 7574 6520 3d20 4661 6c73 652c 0a20 2020  ute = False,.   
-00040450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040470: 2020 2020 2020 2020 2063 656e 736f 7220           censor 
-00040480: 3d20 6365 6e73 2c0a 2020 2020 2020 2020  = cens,.        
-00040490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000404a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000404b0: 2020 2020 6465 7370 696b 6520 3d20 322e      despike = 2.
-000404c0: 352c 0a20 2020 2020 2020 2020 2020 2020  5,.             
-000404d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000404e0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-000404f0: 6f74 696f 6e5f 6173 5f6e 7569 7361 6e63  otion_as_nuisanc
-00040500: 6520 3d20 5472 7565 2c0a 2020 2020 2020  e = True,.      
-00040510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040530: 2020 2020 2020 7570 7361 6d70 6c65 3d46        upsample=F
-00040540: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
-00040550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000403f0: 2066 203d 2064 6566 6175 6c74 660a 2020   f = defaultf.  
+00040400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040420: 2020 6966 2066 6620 3d3d 2027 6d69 6427    if ff == 'mid'
+00040430: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00040440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040450: 2020 2020 2020 2020 2020 6620 3d20 5b30            f = [0
+00040460: 2e30 312c 302e 315d 0a20 2020 2020 2020  .01,0.1].       
+00040470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040480: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00040490: 6620 6666 203d 3d20 2774 6967 6874 273a  f ff == 'tight':
+000404a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000404b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000404c0: 2020 2020 2020 2020 2066 203d 205b 302e           f = [0.
+000404d0: 3033 2c30 2e30 385d 0a20 2020 2020 2020  03,0.08].       
+000404e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000404f0: 2020 2020 2020 2020 2020 2020 2072 7366               rsf
+00040500: 3020 3d20 7265 7374 696e 675f 7374 6174  0 = resting_stat
+00040510: 655f 666d 7269 5f6e 6574 776f 726b 7328  e_fmri_networks(
+00040520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00040530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040540: 2020 2020 2020 2020 2020 2020 2072 7366               rsf
+00040550: 5f69 6d61 6765 2c0a 2020 2020 2020 2020  _image,.        
 00040560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040570: 2020 636c 6561 6e5f 746d 703d 302e 3636    clean_tmp=0.66
-00040580: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00040590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000405a0: 2020 2020 2020 2020 2020 2020 2020 7665                ve
-000405b0: 7262 6f73 653d 7665 7262 6f73 6520 2920  rbose=verbose ) 
-000405c0: 2320 6465 6661 756c 740a 2020 2020 2020  # default.      
-000405d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000405e0: 2020 2020 2020 2020 2020 2020 2020 7273                rs
-000405f0: 6670 726f 6c69 7374 2e61 7070 656e 6428  fprolist.append(
-00040600: 2072 7366 3020 290a 2020 2020 2020 2020   rsf0 ).        
-00040610: 2020 2020 2020 2020 6f75 7470 7574 5f64          output_d
-00040620: 6963 745b 2772 7366 275d 203d 2072 7366  ict['rsf'] = rsf
-00040630: 7072 6f6c 6973 740a 2020 2020 6966 206e  prolist.    if n
-00040640: 6d5f 696d 6167 655f 6c69 7374 2069 7320  m_image_list is 
-00040650: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00040660: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-00040670: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00040680: 276e 6d27 290a 2020 2020 2020 2020 6966  'nm').        if
-00040690: 2073 726d 6f64 656c 2069 7320 4e6f 6e65   srmodel is None
-000406a0: 3a0a 2020 2020 2020 2020 2020 2020 6f75  :.            ou
-000406b0: 7470 7574 5f64 6963 745b 274e 4d27 5d20  tput_dict['NM'] 
-000406c0: 3d20 6e65 7572 6f6d 656c 616e 696e 2820  = neuromelanin( 
-000406d0: 6e6d 5f69 6d61 6765 5f6c 6973 742c 2074  nm_image_list, t
-000406e0: 3169 6d67 6272 6e2c 2074 315f 696d 6167  1imgbrn, t1_imag
-000406f0: 652c 2068 6965 725b 2764 6565 705f 6369  e, hier['deep_ci
-00040700: 7431 3638 6c61 6227 5d2c 2076 6572 626f  t168lab'], verbo
-00040710: 7365 3d76 6572 626f 7365 2029 0a20 2020  se=verbose ).   
-00040720: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00040730: 2020 2020 2020 206f 7574 7075 745f 6469         output_di
-00040740: 6374 5b27 4e4d 275d 203d 206e 6575 726f  ct['NM'] = neuro
-00040750: 6d65 6c61 6e69 6e28 206e 6d5f 696d 6167  melanin( nm_imag
-00040760: 655f 6c69 7374 2c20 7431 696d 6762 726e  e_list, t1imgbrn
-00040770: 2c20 7431 5f69 6d61 6765 2c20 6869 6572  , t1_image, hier
-00040780: 5b27 6465 6570 5f63 6974 3136 386c 6162  ['deep_cit168lab
-00040790: 275d 2c20 7372 6d6f 6465 6c3d 7372 6d6f  '], srmodel=srmo
-000407a0: 6465 6c2c 2074 6172 6765 745f 7261 6e67  del, target_rang
-000407b0: 653d 7461 7267 6574 5f72 616e 6765 2c20  e=target_range, 
-000407c0: 7665 7262 6f73 653d 7665 7262 6f73 6520  verbose=verbose 
-000407d0: 2029 0a23 2323 2323 2323 2323 2323 2323   ).#############
-000407e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000407f0: 2323 2323 2320 646f 2074 6865 2064 7469  ##### do the dti
-00040800: 202e 2e2e 2e2e 0a20 2020 2069 6620 6c65   ......    if le
-00040810: 6e28 6477 5f69 6d61 6765 2920 3e20 3020  n(dw_image) > 0 
-00040820: 3a0a 2020 2020 2020 2020 6966 2076 6572  :.        if ver
-00040830: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-00040840: 2020 7072 696e 7428 2764 7469 2d78 2729    print('dti-x')
-00040850: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-00040860: 2064 775f 696d 6167 6520 2920 3d3d 2031   dw_image ) == 1
-00040870: 3a20 2320 7573 6520 5431 2066 6f72 2064  : # use T1 for d
-00040880: 6973 746f 7274 696f 6e20 636f 7272 6563  istortion correc
-00040890: 7469 6f6e 2061 6e64 2062 7261 696e 2065  tion and brain e
-000408a0: 7874 7261 6374 696f 6e0a 2020 2020 2020  xtraction.      
-000408b0: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-000408c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000408d0: 2020 7072 696e 7428 2257 6520 6861 7665    print("We have
-000408e0: 206f 6e6c 7920 6f6e 6520 4454 493a 2022   only one DTI: "
-000408f0: 202b 2073 7472 286c 656e 2864 775f 696d   + str(len(dw_im
-00040900: 6167 6529 2929 0a20 2020 2020 2020 2020  age))).         
-00040910: 2020 2064 775f 696d 6167 6520 3d20 6477     dw_image = dw
-00040920: 5f69 6d61 6765 5b30 5d0a 2020 2020 2020  _image[0].      
-00040930: 2020 2020 2020 6274 7042 302c 6274 7044        btpB0,btpD
-00040940: 573d 6765 745f 6176 6572 6167 655f 6477  W=get_average_dw
-00040950: 695f 6230 2864 775f 696d 6167 6529 0a20  i_b0(dw_image). 
-00040960: 2020 2020 2020 2020 2020 2069 6e69 7472             initr
-00040970: 6967 203d 2061 6e74 732e 7265 6769 7374  ig = ants.regist
-00040980: 7261 7469 6f6e 2820 6274 7044 572c 2068  ration( btpDW, h
-00040990: 6965 725b 2762 7261 696e 5f6e 345f 646e  ier['brain_n4_dn
-000409a0: 7a27 5d2c 2027 424f 4c44 5269 6769 6427  z'], 'BOLDRigid'
-000409b0: 2029 5b27 6677 6474 7261 6e73 666f 726d   )['fwdtransform
-000409c0: 7327 5d5b 305d 0a20 2020 2020 2020 2020  s'][0].         
-000409d0: 2020 2074 656d 7072 6567 203d 2061 6e74     tempreg = ant
-000409e0: 732e 7265 6769 7374 7261 7469 6f6e 2820  s.registration( 
-000409f0: 6274 7044 572c 2068 6965 725b 2762 7261  btpDW, hier['bra
-00040a00: 696e 5f6e 345f 646e 7a27 5d2c 2027 5379  in_n4_dnz'], 'Sy
-00040a10: 4e4f 6e6c 7927 2c0a 2020 2020 2020 2020  NOnly',.        
-00040a20: 2020 2020 2020 2020 7379 6e5f 6d65 7472          syn_metr
-00040a30: 6963 3d27 6d61 7474 6573 272c 2073 796e  ic='mattes', syn
-00040a40: 5f73 616d 706c 696e 673d 3332 2c0a 2020  _sampling=32,.  
-00040a50: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00040a60: 675f 6974 6572 6174 696f 6e73 3d5b 3530  g_iterations=[50
-00040a70: 2c35 302c 3230 5d2c 0a20 2020 2020 2020  ,50,20],.       
-00040a80: 2020 2020 2020 2020 206d 756c 7469 7661           multiva
-00040a90: 7269 6174 655f 6578 7472 6173 3d5b 205b  riate_extras=[ [
-00040aa0: 2022 6d61 7474 6573 222c 2062 7470 4230   "mattes", btpB0
-00040ab0: 2c20 6869 6572 5b27 6272 6169 6e5f 6e34  , hier['brain_n4
-00040ac0: 5f64 6e7a 275d 2c20 312c 2033 3220 5d5d  _dnz'], 1, 32 ]]
-00040ad0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00040ae0: 2020 696e 6974 6961 6c5f 7472 616e 7366    initial_transf
-00040af0: 6f72 6d3d 696e 6974 7269 670a 2020 2020  orm=initrig.    
-00040b00: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00040b10: 2020 2020 2020 2020 2020 6d79 6278 7420            mybxt 
-00040b20: 3d20 616e 7473 2e74 6872 6573 686f 6c64  = ants.threshold
-00040b30: 5f69 6d61 6765 2820 616e 7473 2e69 4d61  _image( ants.iMa
-00040b40: 7468 2868 6965 725b 2762 7261 696e 5f6e  th(hier['brain_n
-00040b50: 345f 646e 7a27 5d2c 2022 4e6f 726d 616c  4_dnz'], "Normal
-00040b60: 697a 6522 2029 2c20 302e 3030 312c 2031  ize" ), 0.001, 1
-00040b70: 2029 0a20 2020 2020 2020 2020 2020 2062   ).            b
-00040b80: 7470 4457 203d 2061 6e74 732e 6170 706c  tpDW = ants.appl
-00040b90: 795f 7472 616e 7366 6f72 6d73 2820 6274  y_transforms( bt
-00040ba0: 7044 572c 2062 7470 4457 2c0a 2020 2020  pDW, btpDW,.    
-00040bb0: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
-00040bc0: 7265 675b 2769 6e76 7472 616e 7366 6f72  reg['invtransfor
-00040bd0: 6d73 275d 5b31 5d2c 2069 6e74 6572 706f  ms'][1], interpo
-00040be0: 6c61 746f 723d 276c 696e 6561 7227 290a  lator='linear').
-00040bf0: 2020 2020 2020 2020 2020 2020 6274 7042              btpB
-00040c00: 3020 3d20 616e 7473 2e61 7070 6c79 5f74  0 = ants.apply_t
-00040c10: 7261 6e73 666f 726d 7328 2062 7470 4230  ransforms( btpB0
-00040c20: 2c20 6274 7042 302c 0a20 2020 2020 2020  , btpB0,.       
-00040c30: 2020 2020 2020 2020 2074 656d 7072 6567           tempreg
-00040c40: 5b27 696e 7674 7261 6e73 666f 726d 7327  ['invtransforms'
-00040c50: 5d5b 315d 2c20 696e 7465 7270 6f6c 6174  ][1], interpolat
-00040c60: 6f72 3d27 6c69 6e65 6172 2729 0a20 2020  or='linear').   
-00040c70: 2020 2020 2020 2020 2064 7769 6d61 736b           dwimask
-00040c80: 203d 2061 6e74 732e 6170 706c 795f 7472   = ants.apply_tr
-00040c90: 616e 7366 6f72 6d73 2820 6274 7044 572c  ansforms( btpDW,
-00040ca0: 206d 7962 7874 2c20 7465 6d70 7265 675b   mybxt, tempreg[
-00040cb0: 2766 7764 7472 616e 7366 6f72 6d73 275d  'fwdtransforms']
-00040cc0: 5b31 5d2c 2069 6e74 6572 706f 6c61 746f  [1], interpolato
-00040cd0: 723d 276e 6561 7265 7374 4e65 6967 6862  r='nearestNeighb
-00040ce0: 6f72 2729 0a20 2020 2020 2020 2020 2020  or').           
-00040cf0: 2023 2064 7769 6d61 736b 203d 2061 6e74   # dwimask = ant
-00040d00: 732e 694d 6174 6828 6477 696d 6173 6b2c  s.iMath(dwimask,
-00040d10: 274d 4427 2c31 290a 2020 2020 2020 2020  'MD',1).        
-00040d20: 2020 2020 7431 3264 7769 203d 2061 6e74      t12dwi = ant
-00040d30: 732e 6170 706c 795f 7472 616e 7366 6f72  s.apply_transfor
-00040d40: 6d73 2820 6274 7044 572c 2068 6965 725b  ms( btpDW, hier[
-00040d50: 2762 7261 696e 5f6e 345f 646e 7a27 5d2c  'brain_n4_dnz'],
-00040d60: 2074 656d 7072 6567 5b27 6677 6474 7261   tempreg['fwdtra
-00040d70: 6e73 666f 726d 7327 5d5b 315d 2c20 696e  nsforms'][1], in
-00040d80: 7465 7270 6f6c 6174 6f72 3d27 6c69 6e65  terpolator='line
-00040d90: 6172 2729 0a20 2020 2020 2020 2020 2020  ar').           
-00040da0: 206f 7574 7075 745f 6469 6374 5b27 4454   output_dict['DT
-00040db0: 4927 5d20 3d20 6a6f 696e 745f 6474 695f  I'] = joint_dti_
-00040dc0: 7265 636f 6e28 0a20 2020 2020 2020 2020  recon(.         
-00040dd0: 2020 2020 2020 2064 775f 696d 6167 652c         dw_image,
-00040de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00040df0: 2062 7661 6c73 5b30 5d2c 0a20 2020 2020   bvals[0],.     
-00040e00: 2020 2020 2020 2020 2020 2062 7665 6373             bvecs
-00040e10: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
-00040e20: 2020 2020 206a 6875 5f61 746c 6173 3d4a       jhu_atlas=J
-00040e30: 4855 5f61 746c 6173 2c0a 2020 2020 2020  HU_atlas,.      
-00040e40: 2020 2020 2020 2020 2020 6a68 755f 6c61            jhu_la
-00040e50: 6265 6c73 3d4a 4855 5f6c 6162 656c 732c  bels=JHU_labels,
-00040e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00040e70: 2062 7261 696e 5f6d 6173 6b20 3d20 6477   brain_mask = dw
-00040e80: 696d 6173 6b2c 0a20 2020 2020 2020 2020  imask,.         
-00040e90: 2020 2020 2020 2072 6566 6572 656e 6365         reference
-00040ea0: 5f42 3020 3d20 6274 7042 302c 0a20 2020  _B0 = btpB0,.   
-00040eb0: 2020 2020 2020 2020 2020 2020 2072 6566               ref
-00040ec0: 6572 656e 6365 5f44 5749 203d 2062 7470  erence_DWI = btp
-00040ed0: 4457 2c0a 2020 2020 2020 2020 2020 2020  DW,.            
-00040ee0: 2020 2020 7372 6d6f 6465 6c3d 7372 6d6f      srmodel=srmo
-00040ef0: 6465 6c2c 0a20 2020 2020 2020 2020 2020  del,.           
-00040f00: 2020 2020 206d 6f74 696f 6e5f 636f 7272       motion_corr
-00040f10: 6563 743d 6474 695f 6d6f 7469 6f6e 5f63  ect=dti_motion_c
-00040f20: 6f72 7265 6374 2c20 2320 7365 7420 746f  orrect, # set to
-00040f30: 2046 616c 7365 2069 6620 7573 696e 6720   False if using 
-00040f40: 696e 7075 7420 6672 6f6d 2071 7369 7072  input from qsipr
-00040f50: 6570 0a20 2020 2020 2020 2020 2020 2020  ep.             
-00040f60: 2020 2064 656e 6f69 7365 3d64 7469 5f64     denoise=dti_d
-00040f70: 656e 6f69 7365 2c0a 2020 2020 2020 2020  enoise,.        
-00040f80: 2020 2020 2020 2020 7665 7262 6f73 6520          verbose 
-00040f90: 3d20 7665 7262 6f73 6529 0a20 2020 2020  = verbose).     
-00040fa0: 2020 2065 6c73 6520 3a20 2023 2075 7365     else :  # use
-00040fb0: 2070 6861 7365 2065 6e63 6f64 696e 6720   phase encoding 
-00040fc0: 6163 7175 6973 6974 696f 6e73 2066 6f72  acquisitions for
-00040fd0: 2064 6973 746f 7274 696f 6e20 636f 7272   distortion corr
-00040fe0: 6563 7469 6f6e 2061 6e64 2054 3120 666f  ection and T1 fo
-00040ff0: 7220 6272 6169 6e20 6578 7472 6163 7469  r brain extracti
-00041000: 6f6e 0a20 2020 2020 2020 2020 2020 2069  on.            i
-00041010: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-00041020: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00041030: 2822 5765 2068 6176 6520 626f 7468 2044  ("We have both D
-00041040: 5449 5f4c 5220 616e 6420 4454 495f 524c  TI_LR and DTI_RL
-00041050: 3a20 2220 2b20 7374 7228 6c65 6e28 6477  : " + str(len(dw
-00041060: 5f69 6d61 6765 2929 290a 2020 2020 2020  _image))).      
-00041070: 2020 2020 2020 6131 622c 6131 773d 6765        a1b,a1w=ge
-00041080: 745f 6176 6572 6167 655f 6477 695f 6230  t_average_dwi_b0
-00041090: 2864 775f 696d 6167 655b 305d 290a 2020  (dw_image[0]).  
-000410a0: 2020 2020 2020 2020 2020 6132 622c 6132            a2b,a2
-000410b0: 773d 6765 745f 6176 6572 6167 655f 6477  w=get_average_dw
-000410c0: 695f 6230 2864 775f 696d 6167 655b 315d  i_b0(dw_image[1]
-000410d0: 2c66 6978 6564 5f62 303d 6131 622c 6669  ,fixed_b0=a1b,fi
-000410e0: 7865 645f 6477 693d 6131 7729 0a20 2020  xed_dwi=a1w).   
-000410f0: 2020 2020 2020 2020 2062 7470 4230 2c20           btpB0, 
-00041100: 6274 7044 5720 3d20 6474 695f 7465 6d70  btpDW = dti_temp
-00041110: 6c61 7465 280a 2020 2020 2020 2020 2020  late(.          
-00041120: 2020 2020 2020 625f 696d 6167 655f 6c69        b_image_li
-00041130: 7374 3d5b 6131 622c 6132 625d 2c0a 2020  st=[a1b,a2b],.  
-00041140: 2020 2020 2020 2020 2020 2020 2020 775f                w_
-00041150: 696d 6167 655f 6c69 7374 3d5b 6131 772c  image_list=[a1w,
-00041160: 6132 775d 2c0a 2020 2020 2020 2020 2020  a2w],.          
-00041170: 2020 2020 2020 6974 6572 6174 696f 6e73        iterations
-00041180: 3d37 2c20 7665 7262 6f73 653d 7665 7262  =7, verbose=verb
-00041190: 6f73 6520 290a 2020 2020 2020 2020 2020  ose ).          
-000411a0: 2020 696e 6974 7269 6720 3d20 616e 7473    initrig = ants
-000411b0: 2e72 6567 6973 7472 6174 696f 6e28 2062  .registration( b
-000411c0: 7470 4457 2c20 6869 6572 5b27 6272 6169  tpDW, hier['brai
-000411d0: 6e5f 6e34 5f64 6e7a 275d 2c20 2742 4f4c  n_n4_dnz'], 'BOL
-000411e0: 4452 6967 6964 2720 295b 2766 7764 7472  DRigid' )['fwdtr
-000411f0: 616e 7366 6f72 6d73 275d 5b30 5d0a 2020  ansforms'][0].  
-00041200: 2020 2020 2020 2020 2020 7465 6d70 7265            tempre
-00041210: 6720 3d20 616e 7473 2e72 6567 6973 7472  g = ants.registr
-00041220: 6174 696f 6e28 2062 7470 4457 2c20 6869  ation( btpDW, hi
-00041230: 6572 5b27 6272 6169 6e5f 6e34 5f64 6e7a  er['brain_n4_dnz
-00041240: 275d 2c20 2753 794e 4f6e 6c79 272c 0a20  '], 'SyNOnly',. 
-00041250: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00041260: 796e 5f6d 6574 7269 633d 276d 6174 7465  yn_metric='matte
-00041270: 7327 2c20 7379 6e5f 7361 6d70 6c69 6e67  s', syn_sampling
-00041280: 3d33 322c 0a20 2020 2020 2020 2020 2020  =32,.           
-00041290: 2020 2020 2072 6567 5f69 7465 7261 7469       reg_iterati
-000412a0: 6f6e 733d 5b35 302c 3530 2c32 305d 2c0a  ons=[50,50,20],.
-000412b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000412c0: 6d75 6c74 6976 6172 6961 7465 5f65 7874  multivariate_ext
-000412d0: 7261 733d 5b20 5b20 226d 6174 7465 7322  ras=[ [ "mattes"
-000412e0: 2c20 6274 7042 302c 2068 6965 725b 2762  , btpB0, hier['b
-000412f0: 7261 696e 5f6e 345f 646e 7a27 5d2c 2031  rain_n4_dnz'], 1
-00041300: 2c20 3332 205d 5d2c 0a20 2020 2020 2020  , 32 ]],.       
-00041310: 2020 2020 2020 2020 2069 6e69 7469 616c           initial
-00041320: 5f74 7261 6e73 666f 726d 3d69 6e69 7472  _transform=initr
-00041330: 6967 0a20 2020 2020 2020 2020 2020 2020  ig.             
-00041340: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00041350: 206d 7962 7874 203d 2061 6e74 732e 7468   mybxt = ants.th
-00041360: 7265 7368 6f6c 645f 696d 6167 6528 2061  reshold_image( a
-00041370: 6e74 732e 694d 6174 6828 6869 6572 5b27  nts.iMath(hier['
-00041380: 6272 6169 6e5f 6e34 5f64 6e7a 275d 2c20  brain_n4_dnz'], 
-00041390: 224e 6f72 6d61 6c69 7a65 2220 292c 2030  "Normalize" ), 0
-000413a0: 2e30 3031 2c20 3120 290a 2020 2020 2020  .001, 1 ).      
-000413b0: 2020 2020 2020 6477 696d 6173 6b20 3d20        dwimask = 
-000413c0: 616e 7473 2e61 7070 6c79 5f74 7261 6e73  ants.apply_trans
-000413d0: 666f 726d 7328 2062 7470 4457 2c20 6d79  forms( btpDW, my
-000413e0: 6278 742c 2074 656d 7072 6567 5b27 6677  bxt, tempreg['fw
-000413f0: 6474 7261 6e73 666f 726d 7327 5d2c 2069  dtransforms'], i
-00041400: 6e74 6572 706f 6c61 746f 723d 276e 6561  nterpolator='nea
-00041410: 7265 7374 4e65 6967 6862 6f72 2729 0a20  restNeighbor'). 
-00041420: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-00041430: 745f 6469 6374 5b27 4454 4927 5d20 3d20  t_dict['DTI'] = 
-00041440: 6a6f 696e 745f 6474 695f 7265 636f 6e28  joint_dti_recon(
-00041450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00041460: 2064 775f 696d 6167 655b 305d 2c0a 2020   dw_image[0],.  
-00041470: 2020 2020 2020 2020 2020 2020 2020 6276                bv
-00041480: 616c 735b 305d 2c0a 2020 2020 2020 2020  als[0],.        
-00041490: 2020 2020 2020 2020 6276 6563 735b 305d          bvecs[0]
-000414a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000414b0: 2020 6a68 755f 6174 6c61 733d 4a48 555f    jhu_atlas=JHU_
-000414c0: 6174 6c61 732c 0a20 2020 2020 2020 2020  atlas,.         
-000414d0: 2020 2020 2020 206a 6875 5f6c 6162 656c         jhu_label
-000414e0: 733d 4a48 555f 6c61 6265 6c73 2c0a 2020  s=JHU_labels,.  
-000414f0: 2020 2020 2020 2020 2020 2020 2020 6272                br
-00041500: 6169 6e5f 6d61 736b 203d 2064 7769 6d61  ain_mask = dwima
-00041510: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
-00041520: 2020 2020 7265 6665 7265 6e63 655f 4230      reference_B0
-00041530: 203d 2062 7470 4230 2c0a 2020 2020 2020   = btpB0,.      
-00041540: 2020 2020 2020 2020 2020 7265 6665 7265            refere
-00041550: 6e63 655f 4457 4920 3d20 6274 7044 572c  nce_DWI = btpDW,
-00041560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00041570: 2073 726d 6f64 656c 3d73 726d 6f64 656c   srmodel=srmodel
-00041580: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00041590: 2020 696d 675f 524c 3d64 775f 696d 6167    img_RL=dw_imag
-000415a0: 655b 315d 2c0a 2020 2020 2020 2020 2020  e[1],.          
-000415b0: 2020 2020 2020 6276 616c 5f52 4c3d 6276        bval_RL=bv
-000415c0: 616c 735b 315d 2c0a 2020 2020 2020 2020  als[1],.        
-000415d0: 2020 2020 2020 2020 6276 6563 5f52 4c3d          bvec_RL=
-000415e0: 6276 6563 735b 315d 2c0a 2020 2020 2020  bvecs[1],.      
-000415f0: 2020 2020 2020 2020 2020 6d6f 7469 6f6e            motion
-00041600: 5f63 6f72 7265 6374 3d27 5379 4e27 2c20  _correct='SyN', 
-00041610: 2320 7365 7420 746f 2046 616c 7365 2069  # set to False i
-00041620: 6620 7573 696e 6720 696e 7075 7420 6672  f using input fr
-00041630: 6f6d 2071 7369 7072 6570 0a20 2020 2020  om qsiprep.     
-00041640: 2020 2020 2020 2020 2020 2064 656e 6f69             denoi
-00041650: 7365 3d54 7275 652c 0a20 2020 2020 2020  se=True,.       
-00041660: 2020 2020 2020 2020 2076 6572 626f 7365           verbose
-00041670: 203d 2076 6572 626f 7365 290a 2020 2020   = verbose).    
-00041680: 2020 2020 6d79 6474 6920 3d20 6f75 7470      mydti = outp
-00041690: 7574 5f64 6963 745b 2744 5449 275d 0a20  ut_dict['DTI']. 
-000416a0: 2020 2020 2020 2023 2073 756d 6d61 7269         # summari
-000416b0: 7a65 2064 7769 2077 6974 6820 5431 206f  ze dwi with T1 o
-000416c0: 7574 7075 7473 0a20 2020 2020 2020 2023  utputs.        #
-000416d0: 2066 6972 7374 202d 2072 6567 6973 7465   first - registe
-000416e0: 7220 2e2e 2e2e 0a20 2020 2020 2020 2072  r .....        r
-000416f0: 6567 203d 2061 6e74 732e 7265 6769 7374  eg = ants.regist
-00041700: 7261 7469 6f6e 2820 6d79 6474 695b 2772  ration( mydti['r
-00041710: 6563 6f6e 5f66 6127 5d2c 2068 6965 725b  econ_fa'], hier[
-00041720: 2762 7261 696e 5f6e 345f 646e 7a27 5d2c  'brain_n4_dnz'],
-00041730: 2027 5379 4e42 6f6c 6427 2c20 746f 7461   'SyNBold', tota
-00041740: 6c5f 7369 676d 613d 312e 3020 290a 2020  l_sigma=1.0 ).  
-00041750: 2020 2020 2020 2323 2323 2323 2323 2323        ##########
-00041760: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00041770: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00041780: 2323 2323 2323 2323 0a20 2020 2020 2020  ########.       
-00041790: 206f 7574 7075 745f 6469 6374 5b27 4641   output_dict['FA
-000417a0: 5f73 756d 6d27 5d20 3d20 6869 6572 6172  _summ'] = hierar
-000417b0: 6368 6963 616c 5f6d 6f64 616c 6974 795f  chical_modality_
-000417c0: 7375 6d6d 6172 7928 0a20 2020 2020 2020  summary(.       
-000417d0: 2020 2020 206d 7964 7469 5b27 7265 636f       mydti['reco
-000417e0: 6e5f 6661 275d 2c0a 2020 2020 2020 2020  n_fa'],.        
-000417f0: 2020 2020 6869 6572 3d68 6965 722c 0a20      hier=hier,. 
-00041800: 2020 2020 2020 2020 2020 206d 6f64 616c             modal
-00041810: 6974 795f 6e61 6d65 3d27 6661 272c 0a20  ity_name='fa',. 
-00041820: 2020 2020 2020 2020 2020 2074 7261 6e73             trans
-00041830: 666f 726d 6c69 7374 3d72 6567 5b27 6677  formlist=reg['fw
-00041840: 6474 7261 6e73 666f 726d 7327 5d2c 0a20  dtransforms'],. 
-00041850: 2020 2020 2020 2020 2020 2076 6572 626f             verbo
-00041860: 7365 203d 2046 616c 7365 2029 0a20 2020  se = False ).   
-00041870: 2020 2020 2023 2323 2323 2323 2323 2323       ###########
-00041880: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00041890: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000418a0: 2323 2323 2323 230a 2020 2020 2020 2020  #######.        
-000418b0: 6f75 7470 7574 5f64 6963 745b 274d 445f  output_dict['MD_
-000418c0: 7375 6d6d 275d 203d 2068 6965 7261 7263  summ'] = hierarc
-000418d0: 6869 6361 6c5f 6d6f 6461 6c69 7479 5f73  hical_modality_s
-000418e0: 756d 6d61 7279 280a 2020 2020 2020 2020  ummary(.        
-000418f0: 2020 2020 6d79 6474 695b 2772 6563 6f6e      mydti['recon
-00041900: 5f6d 6427 5d2c 0a20 2020 2020 2020 2020  _md'],.         
-00041910: 2020 2068 6965 723d 6869 6572 2c0a 2020     hier=hier,.  
-00041920: 2020 2020 2020 2020 2020 6d6f 6461 6c69            modali
-00041930: 7479 5f6e 616d 653d 276d 6427 2c0a 2020  ty_name='md',.  
-00041940: 2020 2020 2020 2020 2020 7472 616e 7366            transf
-00041950: 6f72 6d6c 6973 743d 7265 675b 2766 7764  ormlist=reg['fwd
-00041960: 7472 616e 7366 6f72 6d73 275d 2c0a 2020  transforms'],.  
-00041970: 2020 2020 2020 2020 2020 7665 7262 6f73            verbos
-00041980: 6520 3d20 4661 6c73 6520 290a 2020 2020  e = False ).    
-00041990: 2020 2020 2320 7468 6573 6520 696e 7075      # these inpu
-000419a0: 7473 2073 686f 756c 6420 636f 6d65 2066  ts should come f
-000419b0: 726f 6d20 6e69 6365 6c79 2070 726f 6365  rom nicely proce
-000419c0: 7373 6564 2064 6174 610a 2020 2020 2020  ssed data.      
-000419d0: 2020 646b 746d 6170 7065 6420 3d20 616e    dktmapped = an
-000419e0: 7473 2e61 7070 6c79 5f74 7261 6e73 666f  ts.apply_transfo
-000419f0: 726d 7328 0a20 2020 2020 2020 2020 2020  rms(.           
-00041a00: 206d 7964 7469 5b27 7265 636f 6e5f 6661   mydti['recon_fa
-00041a10: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
-00041a20: 6869 6572 5b27 646b 745f 7061 7263 275d  hier['dkt_parc']
-00041a30: 5b27 646b 745f 636f 7274 6578 275d 2c0a  ['dkt_cortex'],.
-00041a40: 2020 2020 2020 2020 2020 2020 7265 675b              reg[
-00041a50: 2766 7764 7472 616e 7366 6f72 6d73 275d  'fwdtransforms']
-00041a60: 2c20 696e 7465 7270 6f6c 6174 6f72 3d27  , interpolator='
-00041a70: 6e65 6172 6573 744e 6569 6768 626f 7227  nearestNeighbor'
-00041a80: 2029 0a20 2020 2020 2020 2063 6974 6d61   ).        citma
-00041a90: 7070 6564 203d 2061 6e74 732e 6170 706c  pped = ants.appl
-00041aa0: 795f 7472 616e 7366 6f72 6d73 280a 2020  y_transforms(.  
-00041ab0: 2020 2020 2020 2020 2020 6d79 6474 695b            mydti[
-00041ac0: 2772 6563 6f6e 5f66 6127 5d2c 0a20 2020  'recon_fa'],.   
-00041ad0: 2020 2020 2020 2020 2068 6965 725b 2763           hier['c
-00041ae0: 6974 3136 386c 6162 275d 2c0a 2020 2020  it168lab'],.    
-00041af0: 2020 2020 2020 2020 7265 675b 2766 7764          reg['fwd
-00041b00: 7472 616e 7366 6f72 6d73 275d 2c20 696e  transforms'], in
-00041b10: 7465 7270 6f6c 6174 6f72 3d27 6e65 6172  terpolator='near
-00041b20: 6573 744e 6569 6768 626f 7227 2029 0a20  estNeighbor' ). 
-00041b30: 2020 2020 2020 2064 6b74 6d61 7070 6564         dktmapped
-00041b40: 5b20 6369 746d 6170 7065 6420 3e20 305d  [ citmapped > 0]
-00041b50: 3d30 0a20 2020 2020 2020 206d 6173 6b20  =0.        mask 
-00041b60: 3d20 616e 7473 2e74 6872 6573 686f 6c64  = ants.threshold
-00041b70: 5f69 6d61 6765 2820 6d79 6474 695b 2772  _image( mydti['r
-00041b80: 6563 6f6e 5f66 6127 5d2c 2030 2e30 312c  econ_fa'], 0.01,
-00041b90: 2032 2e30 2029 2e69 4d61 7468 2822 4765   2.0 ).iMath("Ge
-00041ba0: 744c 6172 6765 7374 436f 6d70 6f6e 656e  tLargestComponen
-00041bb0: 7422 290a 2020 2020 2020 2020 6966 2064  t").        if d
-00041bc0: 6f5f 7472 6163 746f 6772 6170 6879 3a20  o_tractography: 
-00041bd0: 2320 6477 695f 6465 7465 726d 696e 6973  # dwi_determinis
-00041be0: 7469 635f 7472 6163 6b69 6e67 2064 7769  tic_tracking dwi
-00041bf0: 5f63 6c6f 7365 7374 5f70 6561 6b5f 7472  _closest_peak_tr
-00041c00: 6163 6b69 6e67 0a20 2020 2020 2020 2020  acking.         
-00041c10: 2020 206f 7574 7075 745f 6469 6374 5b27     output_dict['
-00041c20: 7472 6163 746f 6772 6170 6879 275d 203d  tractography'] =
-00041c30: 2064 7769 5f64 6574 6572 6d69 6e69 7374   dwi_determinist
-00041c40: 6963 5f74 7261 636b 696e 6728 0a20 2020  ic_tracking(.   
-00041c50: 2020 2020 2020 2020 2020 2020 206d 7964               myd
-00041c60: 7469 5b27 6477 695f 4c52 5f64 6577 6172  ti['dwi_LR_dewar
-00041c70: 7065 6427 5d2c 0a20 2020 2020 2020 2020  ped'],.         
-00041c80: 2020 2020 2020 206d 7964 7469 5b27 7265         mydti['re
-00041c90: 636f 6e5f 6661 275d 2c0a 2020 2020 2020  con_fa'],.      
-00041ca0: 2020 2020 2020 2020 2020 6d79 6474 695b            mydti[
-00041cb0: 2762 7661 6c5f 4c52 275d 2c0a 2020 2020  'bval_LR'],.    
-00041cc0: 2020 2020 2020 2020 2020 2020 6d79 6474              mydt
-00041cd0: 695b 2762 7665 635f 4c52 275d 2c0a 2020  i['bvec_LR'],.  
-00041ce0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00041cf0: 6564 5f64 656e 7369 7479 203d 2031 2c0a  ed_density = 1,.
-00041d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041d10: 6d61 736b 3d6d 6173 6b2c 0a20 2020 2020  mask=mask,.     
-00041d20: 2020 2020 2020 2020 2020 2076 6572 626f             verbo
-00041d30: 7365 203d 2076 6572 626f 7365 2029 0a20  se = verbose ). 
-00041d40: 2020 2020 2020 2020 2020 206d 7973 7472             mystr
-00041d50: 203d 206f 7574 7075 745f 6469 6374 5b27   = output_dict['
-00041d60: 7472 6163 746f 6772 6170 6879 275d 0a20  tractography']. 
-00041d70: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
-00041d80: 745f 6469 6374 5b27 7472 6163 746f 6772  t_dict['tractogr
-00041d90: 6170 6879 5f63 6f6e 6e65 6374 6976 6974  aphy_connectivit
-00041da0: 7927 5d20 3d20 6477 695f 7374 7265 616d  y'] = dwi_stream
-00041db0: 6c69 6e65 5f63 6f6e 6e65 6374 6976 6974  line_connectivit
-00041dc0: 7928 206d 7973 7472 5b27 7374 7265 616d  y( mystr['stream
-00041dd0: 6c69 6e65 7327 5d2c 2064 6b74 6d61 7070  lines'], dktmapp
-00041de0: 6564 2b63 6974 6d61 7070 6564 2c20 636e  ed+citmapped, cn
-00041df0: 7863 7376 2c20 7665 7262 6f73 653d 7665  xcsv, verbose=ve
-00041e00: 7262 6f73 6520 290a 2020 2020 2323 2323  rbose ).    ####
-00041e10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00041e20: 2323 2323 2323 2323 2323 2323 2323 2064  ############## d
-00041e30: 6f20 7468 6520 666c 6169 7220 2e2e 2e2e  o the flair ....
-00041e40: 2e0a 2020 2020 6966 2066 6c61 6972 5f69  ..    if flair_i
-00041e50: 6d61 6765 2069 7320 6e6f 7420 4e6f 6e65  mage is not None
-00041e60: 3a0a 2020 2020 2020 2020 6966 2076 6572  :.        if ver
-00041e70: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-00041e80: 2020 7072 696e 7428 2766 6c61 6972 2729    print('flair')
-00041e90: 0a20 2020 2020 2020 2077 6d68 7072 696f  .        wmhprio
-00041ea0: 7220 3d20 4e6f 6e65 0a20 2020 2020 2020  r = None.       
-00041eb0: 2070 7269 6f72 666e 203d 2065 785f 7061   priorfn = ex_pa
-00041ec0: 7468 5f6d 6d20 2b20 2743 4954 3136 385f  th_mm + 'CIT168_
-00041ed0: 776d 6870 7269 6f72 5f37 3030 756d 5f70  wmhprior_700um_p
-00041ee0: 6164 5f61 646e 692e 6e69 692e 677a 270a  ad_adni.nii.gz'.
-00041ef0: 2020 2020 2020 2020 6966 2028 2065 7869          if ( exi
-00041f00: 7374 7328 2070 7269 6f72 666e 2029 2029  sts( priorfn ) )
-00041f10: 3a0a 2020 2020 2020 2020 2020 2020 776d  :.            wm
-00041f20: 6870 7269 6f72 203d 2061 6e74 732e 696d  hprior = ants.im
-00041f30: 6167 655f 7265 6164 2820 7072 696f 7266  age_read( priorf
-00041f40: 6e20 290a 2020 2020 2020 2020 2020 2020  n ).            
-00041f50: 776d 6870 7269 6f72 203d 2061 6e74 732e  wmhprior = ants.
-00041f60: 6170 706c 795f 7472 616e 7366 6f72 6d73  apply_transforms
-00041f70: 2820 7431 5f69 6d61 6765 2c20 776d 6870  ( t1_image, wmhp
-00041f80: 7269 6f72 2c20 646f 5f6e 6f72 6d61 6c69  rior, do_normali
-00041f90: 7a61 7469 6f6e 5b27 696e 7674 7261 6e73  zation['invtrans
-00041fa0: 666f 726d 7327 5d20 290a 2020 2020 2020  forms'] ).      
-00041fb0: 2020 6f75 7470 7574 5f64 6963 745b 2766    output_dict['f
-00041fc0: 6c61 6972 275d 203d 2062 6f6f 745f 776d  lair'] = boot_wm
-00041fd0: 6828 2066 6c61 6972 5f69 6d61 6765 2c20  h( flair_image, 
-00041fe0: 7431 5f69 6d61 6765 2c20 7431 6174 726f  t1_image, t1atro
-00041ff0: 706f 732c 0a20 2020 2020 2020 2020 2020  pos,.           
-00042000: 2070 7269 6f72 5f70 726f 6261 6269 6c69   prior_probabili
-00042010: 7479 3d77 6d68 7072 696f 722c 2076 6572  ty=wmhprior, ver
-00042020: 626f 7365 3d76 6572 626f 7365 2029 0a20  bose=verbose ). 
-00042030: 2020 2023 2323 2323 2323 2323 2323 2323     #############
-00042040: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00042050: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00042060: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00042070: 2323 2323 0a20 2020 2023 2323 204e 4f54  ####.    ### NOT
-00042080: 4553 3a20 6465 666f 726d 696e 6720 746f  ES: deforming to
-00042090: 2061 2063 6f6d 6d6f 6e20 7370 6163 6520   a common space 
-000420a0: 616e 6420 7772 6974 696e 6720 6f75 7420  and writing out 
-000420b0: 696d 6167 6573 2023 2323 0a20 2020 2023  images ###.    #
-000420c0: 2323 2069 6d61 6765 7320 7765 2077 616e  ## images we wan
-000420d0: 7420 636f 6d65 2066 726f 6d3a 2044 5449  t come from: DTI
-000420e0: 2c20 4e4d 2c20 7273 662c 2074 6869 636b  , NM, rsf, thick
-000420f0: 6e65 7373 2023 2323 2323 2323 2323 2323  ness ###########
-00042100: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
-00042110: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00042120: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00042130: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00042140: 2323 2323 2323 0a20 2020 2069 6620 646f  ######.    if do
-00042150: 5f6e 6f72 6d61 6c69 7a61 7469 6f6e 2069  _normalization i
-00042160: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00042170: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
-00042180: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00042190: 7428 276e 6f72 6d61 6c69 7a61 7469 6f6e  t('normalization
-000421a0: 2729 0a20 2020 2020 2020 2023 206d 6967  ').        # mig
-000421b0: 6874 2072 6563 6f6e 7369 6465 7220 7468  ht reconsider th
-000421c0: 6973 2074 656d 706c 6174 6520 7370 6163  is template spac
-000421d0: 6520 2d20 6372 6f70 7065 6420 616e 642f  e - cropped and/
-000421e0: 6f72 2068 6967 6865 7220 7265 733f 0a20  or higher res?. 
-000421f0: 2020 2020 2020 2023 2074 656d 706c 6174         # templat
-00042200: 6520 3d20 616e 7473 2e72 6573 616d 706c  e = ants.resampl
-00042210: 655f 696d 6167 6528 2074 656d 706c 6174  e_image( templat
-00042220: 652c 205b 312c 312c 315d 2c20 7573 655f  e, [1,1,1], use_
-00042230: 766f 7865 6c73 3d46 616c 7365 2029 0a20  voxels=False ). 
-00042240: 2020 2020 2020 2023 2074 3172 6567 203d         # t1reg =
-00042250: 2061 6e74 732e 7265 6769 7374 7261 7469   ants.registrati
-00042260: 6f6e 2820 7465 6d70 6c61 7465 2c20 6869  on( template, hi
-00042270: 6572 5b27 6272 6169 6e5f 6e34 5f64 6e7a  er['brain_n4_dnz
-00042280: 275d 2c20 2261 6e74 7352 6567 6973 7472  '], "antsRegistr
-00042290: 6174 696f 6e53 794e 5175 6963 6b52 6570  ationSyNQuickRep
-000422a0: 726f 5b73 5d22 290a 2020 2020 2020 2020  ro[s]").        
-000422b0: 7431 7265 6720 3d20 646f 5f6e 6f72 6d61  t1reg = do_norma
-000422c0: 6c69 7a61 7469 6f6e 0a20 2020 2020 2020  lization.       
-000422d0: 2069 6620 646f 5f6b 6b3a 0a20 2020 2020   if do_kk:.     
-000422e0: 2020 2020 2020 206e 6f72 6d61 6c69 7a61         normaliza
-000422f0: 7469 6f6e 5f64 6963 745b 276b 6b5f 6e6f  tion_dict['kk_no
-00042300: 726d 275d 203d 2061 6e74 732e 6170 706c  rm'] = ants.appl
-00042310: 795f 7472 616e 7366 6f72 6d73 2820 6772  y_transforms( gr
-00042320: 6f75 705f 7465 6d70 6c61 7465 2c20 6f75  oup_template, ou
-00042330: 7470 7574 5f64 6963 745b 276b 6b27 5d5b  tput_dict['kk'][
-00042340: 2774 6869 636b 6e65 7373 5f69 6d61 6765  'thickness_image
-00042350: 275d 2c20 6772 6f75 705f 7472 616e 7366  '], group_transf
-00042360: 6f72 6d20 290a 2020 2020 2020 2020 6966  orm ).        if
-00042370: 206f 7574 7075 745f 6469 6374 5b27 4454   output_dict['DT
-00042380: 4927 5d20 6973 206e 6f74 204e 6f6e 653a  I'] is not None:
-00042390: 0a20 2020 2020 2020 2020 2020 206d 7964  .            myd
-000423a0: 7469 203d 206f 7574 7075 745f 6469 6374  ti = output_dict
-000423b0: 5b27 4454 4927 5d0a 2020 2020 2020 2020  ['DTI'].        
-000423c0: 2020 2020 6474 6972 6967 203d 2061 6e74      dtirig = ant
-000423d0: 732e 7265 6769 7374 7261 7469 6f6e 2820  s.registration( 
-000423e0: 6869 6572 5b27 6272 6169 6e5f 6e34 5f64  hier['brain_n4_d
-000423f0: 6e7a 275d 2c20 6d79 6474 695b 2772 6563  nz'], mydti['rec
-00042400: 6f6e 5f66 6127 5d2c 2027 5269 6769 6427  on_fa'], 'Rigid'
-00042410: 2029 0a20 2020 2020 2020 2020 2020 206e   ).            n
-00042420: 6f72 6d61 6c69 7a61 7469 6f6e 5f64 6963  ormalization_dic
-00042430: 745b 274d 445f 6e6f 726d 275d 203d 2061  t['MD_norm'] = a
-00042440: 6e74 732e 6170 706c 795f 7472 616e 7366  nts.apply_transf
-00042450: 6f72 6d73 2820 6772 6f75 705f 7465 6d70  orms( group_temp
-00042460: 6c61 7465 2c20 6d79 6474 695b 2772 6563  late, mydti['rec
-00042470: 6f6e 5f6d 6427 5d2c 6772 6f75 705f 7472  on_md'],group_tr
-00042480: 616e 7366 6f72 6d2b 6474 6972 6967 5b27  ansform+dtirig['
-00042490: 6677 6474 7261 6e73 666f 726d 7327 5d20  fwdtransforms'] 
-000424a0: 290a 2020 2020 2020 2020 2020 2020 6e6f  ).            no
-000424b0: 726d 616c 697a 6174 696f 6e5f 6469 6374  rmalization_dict
-000424c0: 5b27 4641 5f6e 6f72 6d27 5d20 3d20 616e  ['FA_norm'] = an
-000424d0: 7473 2e61 7070 6c79 5f74 7261 6e73 666f  ts.apply_transfo
-000424e0: 726d 7328 2067 726f 7570 5f74 656d 706c  rms( group_templ
-000424f0: 6174 652c 206d 7964 7469 5b27 7265 636f  ate, mydti['reco
-00042500: 6e5f 6661 275d 2c67 726f 7570 5f74 7261  n_fa'],group_tra
-00042510: 6e73 666f 726d 2b64 7469 7269 675b 2766  nsform+dtirig['f
-00042520: 7764 7472 616e 7366 6f72 6d73 275d 2029  wdtransforms'] )
-00042530: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-00042540: 7075 745f 6469 7265 6374 6f72 7920 3d20  put_directory = 
-00042550: 7465 6d70 6669 6c65 2e6d 6b64 7465 6d70  tempfile.mkdtemp
-00042560: 2829 0a20 2020 2020 2020 2020 2020 2064  ().            d
-00042570: 6f5f 6474 695f 6e6f 726d 3d46 616c 7365  o_dti_norm=False
-00042580: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00042590: 646f 5f64 7469 5f6e 6f72 6d3a 0a20 2020  do_dti_norm:.   
-000425a0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-000425b0: 7074 7820 3d20 616e 7473 2e61 7070 6c79  ptx = ants.apply
-000425c0: 5f74 7261 6e73 666f 726d 7328 2067 726f  _transforms( gro
-000425d0: 7570 5f74 656d 706c 6174 652c 2067 726f  up_template, gro
-000425e0: 7570 5f74 656d 706c 6174 652c 2067 726f  up_template, gro
-000425f0: 7570 5f74 7261 6e73 666f 726d 2b64 7469  up_transform+dti
-00042600: 7269 675b 2766 7764 7472 616e 7366 6f72  rig['fwdtransfor
-00042610: 6d73 275d 2c20 636f 6d70 6f73 6520 3d20  ms'], compose = 
-00042620: 6f75 7470 7574 5f64 6972 6563 746f 7279  output_directory
-00042630: 202b 2027 2f78 7878 2720 290a 2020 2020   + '/xxx' ).    
-00042640: 2020 2020 2020 2020 2020 2020 7473 7063              tspc
-00042650: 3d5b 322e 2c32 2e2c 322e 5d0a 2020 2020  =[2.,2.,2.].    
-00042660: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00042670: 726d 6f64 656c 2069 7320 6e6f 7420 4e6f  rmodel is not No
-00042680: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00042690: 2020 2020 2020 2020 7473 7063 3d5b 312e          tspc=[1.
-000426a0: 2c31 2e2c 312e 5d0a 2020 2020 2020 2020  ,1.,1.].        
-000426b0: 2020 2020 2020 2020 6772 6f75 705f 7465          group_te
-000426c0: 6d70 6c61 7465 326d 6d20 3d20 616e 7473  mplate2mm = ants
-000426d0: 2e72 6573 616d 706c 655f 696d 6167 6528  .resample_image(
-000426e0: 2067 726f 7570 5f74 656d 706c 6174 652c   group_template,
-000426f0: 2074 7370 6320 2029 0a20 2020 2020 2020   tspc  ).       
-00042700: 2020 2020 2020 2020 206e 6f72 6d61 6c69           normali
-00042710: 7a61 7469 6f6e 5f64 6963 745b 2744 5449  zation_dict['DTI
-00042720: 5f6e 6f72 6d27 5d20 3d20 7472 616e 7366  _norm'] = transf
-00042730: 6f72 6d5f 616e 645f 7265 6f72 6965 6e74  orm_and_reorient
-00042740: 5f64 7469 2820 6772 6f75 705f 7465 6d70  _dti( group_temp
-00042750: 6c61 7465 326d 6d2c 206d 7964 7469 5b27  late2mm, mydti['
-00042760: 6474 6927 5d2c 2063 6f6d 7074 782c 2070  dti'], comptx, p
-00042770: 795f 6261 7365 643d 5472 7565 2c20 7665  y_based=True, ve
-00042780: 7262 6f73 653d 5472 7565 2029 0a20 2020  rbose=True ).   
-00042790: 2020 2020 2020 2020 2069 6d70 6f72 7420           import 
-000427a0: 7368 7574 696c 0a20 2020 2020 2020 2020  shutil.         
-000427b0: 2020 2073 6875 7469 6c2e 726d 7472 6565     shutil.rmtree
-000427c0: 286f 7574 7075 745f 6469 7265 6374 6f72  (output_director
-000427d0: 792c 2069 676e 6f72 655f 6572 726f 7273  y, ignore_errors
-000427e0: 3d54 7275 6520 290a 2020 2020 2020 2020  =True ).        
-000427f0: 6966 206f 7574 7075 745f 6469 6374 5b27  if output_dict['
-00042800: 7273 6627 5d20 6973 206e 6f74 204e 6f6e  rsf'] is not Non
-00042810: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-00042820: 6620 4661 6c73 653a 0a20 2020 2020 2020  f False:.       
-00042830: 2020 2020 2020 2020 2072 7366 7072 6f20           rsfpro 
-00042840: 3d20 6f75 7470 7574 5f64 6963 745b 2772  = output_dict['r
-00042850: 7366 275d 2023 2046 4958 4d45 0a20 2020  sf'] # FIXME.   
-00042860: 2020 2020 2020 2020 2020 2020 2072 7366               rsf
-00042870: 7269 6720 3d20 616e 7473 2e72 6567 6973  rig = ants.regis
-00042880: 7472 6174 696f 6e28 2068 6965 725b 2762  tration( hier['b
-00042890: 7261 696e 5f6e 345f 646e 7a27 5d2c 2072  rain_n4_dnz'], r
-000428a0: 7366 7072 6f5b 276d 6561 6e42 6f6c 6427  sfpro['meanBold'
-000428b0: 5d2c 2027 5269 6769 6427 2029 0a20 2020  ], 'Rigid' ).   
-000428c0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000428d0: 206e 6574 6964 2069 6e20 6765 745f 616e   netid in get_an
-000428e0: 7473 696d 6167 655f 6b65 7973 2820 7273  tsimage_keys( rs
-000428f0: 6670 726f 2029 3a0a 2020 2020 2020 2020  fpro ):.        
-00042900: 2020 2020 2020 2020 2020 2020 7273 666b              rsfk
-00042910: 6579 203d 206e 6574 6964 202b 2022 5f6e  ey = netid + "_n
-00042920: 6f72 6d22 0a20 2020 2020 2020 2020 2020  orm".           
-00042930: 2020 2020 2020 2020 206e 6f72 6d61 6c69           normali
-00042940: 7a61 7469 6f6e 5f64 6963 745b 7273 666b  zation_dict[rsfk
-00042950: 6579 5d20 3d20 616e 7473 2e61 7070 6c79  ey] = ants.apply
-00042960: 5f74 7261 6e73 666f 726d 7328 0a20 2020  _transforms(.   
-00042970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042980: 2020 2020 2067 726f 7570 5f74 656d 706c       group_templ
-00042990: 6174 652c 2072 7366 7072 6f5b 6e65 7469  ate, rsfpro[neti
-000429a0: 645d 2c0a 2020 2020 2020 2020 2020 2020  d],.            
-000429b0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
-000429c0: 705f 7472 616e 7366 6f72 6d2b 7273 6672  p_transform+rsfr
-000429d0: 6967 5b27 6677 6474 7261 6e73 666f 726d  ig['fwdtransform
-000429e0: 7327 5d20 290a 2020 2020 2020 2020 6966  s'] ).        if
-000429f0: 206f 7574 7075 745f 6469 6374 5b27 7065   output_dict['pe
-00042a00: 7266 275d 2069 7320 6e6f 7420 4e6f 6e65  rf'] is not None
-00042a10: 3a20 2320 7a69 7a7a 6572 0a20 2020 2020  : # zizzer.     
-00042a20: 2020 2020 2020 2063 6f6d 7074 7820 3d20         comptx = 
-00042a30: 6772 6f75 705f 7472 616e 7366 6f72 6d20  group_transform 
-00042a40: 2b20 6f75 7470 7574 5f64 6963 745b 2770  + output_dict['p
-00042a50: 6572 6627 5d5b 2774 3172 6567 275d 5b27  erf']['t1reg']['
-00042a60: 696e 7674 7261 6e73 666f 726d 7327 5d0a  invtransforms'].
-00042a70: 2020 2020 2020 2020 2020 2020 6e6f 726d              norm
-00042a80: 616c 697a 6174 696f 6e5f 6469 6374 5b27  alization_dict['
-00042a90: 7065 7266 5f6e 6f72 6d27 5d20 3d20 616e  perf_norm'] = an
-00042aa0: 7473 2e61 7070 6c79 5f74 7261 6e73 666f  ts.apply_transfo
-00042ab0: 726d 7328 2067 726f 7570 5f74 656d 706c  rms( group_templ
-00042ac0: 6174 652c 0a20 2020 2020 2020 2020 2020  ate,.           
-00042ad0: 2020 2020 206f 7574 7075 745f 6469 6374       output_dict
-00042ae0: 5b27 7065 7266 275d 5b27 7065 7266 7573  ['perf']['perfus
-00042af0: 696f 6e27 5d2c 2063 6f6d 7074 782c 0a20  ion'], comptx,. 
-00042b00: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00042b10: 6869 6368 746f 696e 7665 7274 3d5b 4661  hichtoinvert=[Fa
-00042b20: 6c73 652c 4661 6c73 652c 5472 7565 2c46  lse,False,True,F
-00042b30: 616c 7365 5d20 290a 2020 2020 2020 2020  alse] ).        
-00042b40: 2020 2020 6e6f 726d 616c 697a 6174 696f      normalizatio
-00042b50: 6e5f 6469 6374 5b27 6362 665f 6e6f 726d  n_dict['cbf_norm
-00042b60: 275d 203d 2061 6e74 732e 6170 706c 795f  '] = ants.apply_
-00042b70: 7472 616e 7366 6f72 6d73 2820 6772 6f75  transforms( grou
-00042b80: 705f 7465 6d70 6c61 7465 2c0a 2020 2020  p_template,.    
-00042b90: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
-00042ba0: 7574 5f64 6963 745b 2770 6572 6627 5d5b  ut_dict['perf'][
-00042bb0: 2763 6266 275d 2c20 636f 6d70 7478 2c0a  'cbf'], comptx,.
-00042bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042bd0: 7768 6963 6874 6f69 6e76 6572 743d 5b46  whichtoinvert=[F
-00042be0: 616c 7365 2c46 616c 7365 2c54 7275 652c  alse,False,True,
-00042bf0: 4661 6c73 655d 2029 0a20 2020 2020 2020  False] ).       
-00042c00: 2069 6620 6e6d 5f69 6d61 6765 5f6c 6973   if nm_image_lis
-00042c10: 7420 6973 206e 6f74 204e 6f6e 653a 0a20  t is not None:. 
-00042c20: 2020 2020 2020 2020 2020 206e 6d70 726f             nmpro
-00042c30: 203d 206f 7574 7075 745f 6469 6374 5b27   = output_dict['
-00042c40: 4e4d 275d 0a20 2020 2020 2020 2020 2020  NM'].           
-00042c50: 206e 6d72 6967 203d 206e 6d70 726f 5b27   nmrig = nmpro['
-00042c60: 7431 5f74 6f5f 4e4d 5f74 7261 6e73 666f  t1_to_NM_transfo
-00042c70: 726d 275d 2023 2074 6869 7320 6973 2061  rm'] # this is a
-00042c80: 6e20 696e 7665 7273 6520 7478 0a20 2020  n inverse tx.   
-00042c90: 2020 2020 2020 2020 206e 6f72 6d61 6c69           normali
-00042ca0: 7a61 7469 6f6e 5f64 6963 745b 274e 4d5f  zation_dict['NM_
-00042cb0: 6e6f 726d 275d 203d 2061 6e74 732e 6170  norm'] = ants.ap
-00042cc0: 706c 795f 7472 616e 7366 6f72 6d73 2820  ply_transforms( 
-00042cd0: 6772 6f75 705f 7465 6d70 6c61 7465 2c20  group_template, 
-00042ce0: 6e6d 7072 6f5b 274e 4d5f 6176 6727 5d2c  nmpro['NM_avg'],
-00042cf0: 2067 726f 7570 5f74 7261 6e73 666f 726d   group_transform
-00042d00: 2b6e 6d72 6967 2c0a 2020 2020 2020 2020  +nmrig,.        
-00042d10: 2020 2020 2020 2020 7768 6963 6874 6f69          whichtoi
-00042d20: 6e76 6572 743d 5b46 616c 7365 2c46 616c  nvert=[False,Fal
-00042d30: 7365 2c54 7275 655d 290a 0a20 2020 2069  se,True])..    i
-00042d40: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-00042d50: 2020 2070 7269 6e74 2827 6d6d 2064 6f6e     print('mm don
-00042d60: 6527 290a 2020 2020 7265 7475 726e 206f  e').    return o
-00042d70: 7574 7075 745f 6469 6374 2c20 6e6f 726d  utput_dict, norm
-00042d80: 616c 697a 6174 696f 6e5f 6469 6374 0a0a  alization_dict..
-00042d90: 0a64 6566 2077 7269 7465 5f6d 6d28 206f  .def write_mm( o
-00042da0: 7574 7075 745f 7072 6566 6978 2c20 6d6d  utput_prefix, mm
-00042db0: 2c20 6d6d 5f6e 6f72 6d3d 4e6f 6e65 2c20  , mm_norm=None, 
-00042dc0: 7431 7769 6465 3d4e 6f6e 652c 2073 6570  t1wide=None, sep
-00042dd0: 6172 6174 6f72 3d27 5f27 2c20 7665 7262  arator='_', verb
-00042de0: 6f73 653d 4661 6c73 6520 293a 0a20 2020  ose=False ):.   
-00042df0: 2022 2222 0a20 2020 2077 7269 7465 2074   """.    write t
-00042e00: 6865 2074 6162 756c 6172 2061 6e64 206e  he tabular and n
-00042e10: 6f72 6d61 6c69 7a61 7469 6f6e 206f 7574  ormalization out
-00042e20: 7075 7420 6f66 2074 6865 206d 6d20 6675  put of the mm fu
-00042e30: 6e63 7469 6f6e 0a0a 2020 2020 5061 7261  nction..    Para
-00042e40: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-00042e50: 2d2d 2d2d 2d2d 2d2d 0a0a 2020 2020 6f75  --------..    ou
-00042e60: 7470 7574 5f70 7265 6669 7820 3a20 7072  tput_prefix : pr
-00042e70: 6566 6978 2066 6f72 2066 696c 6520 6f75  efix for file ou
-00042e80: 7470 7574 7320 2d20 6d6f 6461 6c69 7479  tputs - modality
-00042e90: 2073 7065 6369 6669 6320 706f 7374 6669   specific postfi
-00042ea0: 7820 7769 6c6c 2062 6520 6164 6465 640a  x will be added.
-00042eb0: 0a20 2020 206d 6d20 203a 206f 7574 7075  .    mm  : outpu
-00042ec0: 7420 6f66 206d 6d20 6675 6e63 7469 6f6e  t of mm function
-00042ed0: 2066 6f72 206d 6f64 616c 6974 792d 7370   for modality-sp
-00042ee0: 6163 6520 7072 6f63 6573 7369 6e67 2073  ace processing s
-00042ef0: 686f 756c 6420 6265 2061 2064 6963 7469  hould be a dicti
-00042f00: 6f6e 6172 7920 7769 7468 200a 2020 2020  onary with .    
-00042f10: 2020 2020 6469 6374 696f 6e61 7279 2065      dictionary e
-00042f20: 6e74 7269 6573 2066 6f72 2065 6163 6820  ntries for each 
-00042f30: 6d6f 6461 6c69 7479 2e0a 0a20 2020 206d  modality...    m
-00042f40: 6d5f 6e6f 726d 203a 206f 7574 7075 7420  m_norm : output 
-00042f50: 6f66 206d 6d20 6675 6e63 7469 6f6e 2066  of mm function f
-00042f60: 6f72 206e 6f72 6d61 6c69 7a65 6420 7072  or normalized pr
-00042f70: 6f63 6573 7369 6e67 0a0a 2020 2020 7431  ocessing..    t1
-00042f80: 7769 6465 203a 2077 6964 6520 6f75 7470  wide : wide outp
-00042f90: 7574 2064 6174 6120 6672 616d 6520 6672  ut data frame fr
-00042fa0: 6f6d 2074 3120 6869 6572 6172 6368 6963  om t1 hierarchic
-00042fb0: 616c 0a0a 2020 2020 7365 7061 7261 746f  al..    separato
-00042fc0: 7220 3a20 7374 7269 6e67 206f 7220 6368  r : string or ch
-00042fd0: 6172 6163 7465 7220 7365 7061 7261 746f  aracter separato
-00042fe0: 7220 666f 7220 6669 6c65 6e61 6d65 730a  r for filenames.
-00042ff0: 0a20 2020 2076 6572 626f 7365 203a 2062  .    verbose : b
-00043000: 6f6f 6c65 616e 0a0a 2020 2020 5265 7475  oolean..    Retu
-00043010: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  rns.    --------
-00043020: 2d0a 0a20 2020 2062 6f74 6820 6373 7620  -..    both csv 
-00043030: 616e 6420 696d 6167 6520 6669 6c65 7320  and image files 
-00043040: 7772 6974 7465 6e20 746f 2064 6973 6b2e  written to disk.
-00043050: 2020 7468 6520 7072 696d 6172 7920 6f75    the primary ou
-00043060: 7470 7574 7320 7769 6c6c 2062 650a 2020  tputs will be.  
-00043070: 2020 6f75 7470 7574 5f70 7265 6669 7820    output_prefix 
-00043080: 2b20 7365 7061 7261 746f 7220 2b20 276d  + separator + 'm
-00043090: 6d77 6964 652e 6373 7627 2061 6e64 202a  mwide.csv' and *
-000430a0: 6e6f 726d 2e6e 6969 2e67 7a20 696d 6167  norm.nii.gz imag
-000430b0: 6573 0a0a 2020 2020 2222 220a 2020 2020  es..    """.    
-000430c0: 6672 6f6d 2064 6970 792e 696f 2e73 7472  from dipy.io.str
-000430d0: 6561 6d6c 696e 6520 696d 706f 7274 2073  eamline import s
-000430e0: 6176 655f 7472 6163 746f 6772 616d 0a20  ave_tractogram. 
-000430f0: 2020 2069 6620 6d6d 5f6e 6f72 6d20 6973     if mm_norm is
-00043100: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00043110: 2020 2066 6f72 206d 796b 6579 2069 6e20     for mykey in 
-00043120: 6d6d 5f6e 6f72 6d3a 0a20 2020 2020 2020  mm_norm:.       
-00043130: 2020 2020 2074 656d 7066 6e20 3d20 6f75       tempfn = ou
-00043140: 7470 7574 5f70 7265 6669 7820 2b20 7365  tput_prefix + se
-00043150: 7061 7261 746f 7220 2b20 6d79 6b65 7920  parator + mykey 
-00043160: 2b20 272e 6e69 692e 677a 270a 2020 2020  + '.nii.gz'.    
-00043170: 2020 2020 2020 2020 6966 206d 6d5f 6e6f          if mm_no
-00043180: 726d 5b6d 796b 6579 5d20 6973 206e 6f74  rm[mykey] is not
-00043190: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000431a0: 2020 2020 2020 2069 6d61 6765 5f77 7269         image_wri
-000431b0: 7465 5f77 6974 685f 7468 756d 626e 6169  te_with_thumbnai
-000431c0: 6c28 206d 6d5f 6e6f 726d 5b6d 796b 6579  l( mm_norm[mykey
-000431d0: 5d2c 2074 656d 7066 6e20 290a 2020 2020  ], tempfn ).    
-000431e0: 7468 6b64 6572 6b20 3d20 4e6f 6e65 0a20  thkderk = None. 
-000431f0: 2020 2069 6620 7431 7769 6465 2069 7320     if t1wide is 
-00043200: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00043210: 2020 7468 6b64 6572 6b20 3d20 7431 7769    thkderk = t1wi
-00043220: 6465 2e69 6c6f 635b 3a20 2c20 313a 5d0a  de.iloc[: , 1:].
-00043230: 2020 2020 6b6b 6465 726b 203d 204e 6f6e      kkderk = Non
-00043240: 650a 2020 2020 6966 2027 6b6b 2720 696e  e.    if 'kk' in
-00043250: 206d 6d3a 0a20 2020 2020 2020 2069 6620   mm:.        if 
-00043260: 6d6d 5b27 6b6b 275d 2069 7320 6e6f 7420  mm['kk'] is not 
-00043270: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00043280: 2020 6b6b 6465 726b 203d 206d 6d5b 276b    kkderk = mm['k
-00043290: 6b27 5d5b 2774 6869 636b 6e65 7373 5f64  k']['thickness_d
-000432a0: 6174 6166 7261 6d65 275d 2e69 6c6f 635b  ataframe'].iloc[
-000432b0: 3a20 2c20 313a 5d0a 2020 2020 2020 2020  : , 1:].        
-000432c0: 2020 2020 6d79 6b65 793d 2774 6869 636b      mykey='thick
-000432d0: 6e65 7373 5f69 6d61 6765 270a 2020 2020  ness_image'.    
-000432e0: 2020 2020 2020 2020 7465 6d70 666e 203d          tempfn =
-000432f0: 206f 7574 7075 745f 7072 6566 6978 202b   output_prefix +
-00043300: 2073 6570 6172 6174 6f72 202b 206d 796b   separator + myk
-00043310: 6579 202b 2027 2e6e 6969 2e67 7a27 0a20  ey + '.nii.gz'. 
-00043320: 2020 2020 2020 2020 2020 2069 6d61 6765             image
-00043330: 5f77 7269 7465 5f77 6974 685f 7468 756d  _write_with_thum
-00043340: 626e 6169 6c28 206d 6d5b 276b 6b27 5d5b  bnail( mm['kk'][
-00043350: 6d79 6b65 795d 2c20 7465 6d70 666e 2029  mykey], tempfn )
-00043360: 0a20 2020 206e 6d64 6572 6b20 3d20 4e6f  .    nmderk = No
-00043370: 6e65 0a20 2020 2069 6620 274e 4d27 2069  ne.    if 'NM' i
-00043380: 6e20 6d6d 3a0a 2020 2020 2020 2020 6966  n mm:.        if
-00043390: 206d 6d5b 274e 4d27 5d20 6973 206e 6f74   mm['NM'] is not
-000433a0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000433b0: 2020 206e 6d64 6572 6b20 3d20 6d6d 5b27     nmderk = mm['
-000433c0: 4e4d 275d 5b27 4e4d 5f64 6174 6166 7261  NM']['NM_datafra
-000433d0: 6d65 5f77 6964 6527 5d2e 696c 6f63 5b3a  me_wide'].iloc[:
-000433e0: 202c 2031 3a5d 0a20 2020 2020 2020 2020   , 1:].         
-000433f0: 2020 2066 6f72 206d 796b 6579 2069 6e20     for mykey in 
-00043400: 6765 745f 616e 7473 696d 6167 655f 6b65  get_antsimage_ke
-00043410: 7973 2820 6d6d 5b27 4e4d 275d 2029 3a0a  ys( mm['NM'] ):.
-00043420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043430: 7465 6d70 666e 203d 206f 7574 7075 745f  tempfn = output_
-00043440: 7072 6566 6978 202b 2073 6570 6172 6174  prefix + separat
-00043450: 6f72 202b 206d 796b 6579 202b 2027 2e6e  or + mykey + '.n
-00043460: 6969 2e67 7a27 0a20 2020 2020 2020 2020  ii.gz'.         
-00043470: 2020 2020 2020 2069 6d61 6765 5f77 7269         image_wri
-00043480: 7465 5f77 6974 685f 7468 756d 626e 6169  te_with_thumbnai
-00043490: 6c28 206d 6d5b 274e 4d27 5d5b 6d79 6b65  l( mm['NM'][myke
-000434a0: 795d 2c20 7465 6d70 666e 2c20 7468 756d  y], tempfn, thum
-000434b0: 623d 4661 6c73 6520 290a 0a20 2020 2066  b=False )..    f
-000434c0: 6164 6572 6b20 3d20 6d64 6465 726b 203d  aderk = mdderk =
-000434d0: 2066 6174 3164 6572 6b20 3d20 6d64 7431   fat1derk = mdt1
-000434e0: 6465 726b 203d 204e 6f6e 650a 0a20 2020  derk = None..   
-000434f0: 2069 6620 2744 5449 2720 696e 206d 6d3a   if 'DTI' in mm:
-00043500: 0a20 2020 2020 2020 2069 6620 6d6d 5b27  .        if mm['
-00043510: 4454 4927 5d20 6973 206e 6f74 204e 6f6e  DTI'] is not Non
-00043520: 653a 0a20 2020 2020 2020 2020 2020 206d  e:.            m
-00043530: 7964 7469 203d 206d 6d5b 2744 5449 275d  ydti = mm['DTI']
-00043540: 0a20 2020 2020 2020 2020 2020 206d 796f  .            myo
-00043550: 7020 3d20 6f75 7470 7574 5f70 7265 6669  p = output_prefi
-00043560: 7820 2b20 7365 7061 7261 746f 720a 2020  x + separator.  
-00043570: 2020 2020 2020 2020 2020 616e 7473 2e69            ants.i
-00043580: 6d61 6765 5f77 7269 7465 2820 6d79 6474  mage_write( mydt
-00043590: 695b 2764 7469 275d 2c20 206d 796f 7020  i['dti'],  myop 
-000435a0: 2b20 2764 7469 2e6e 6969 2e67 7a27 2029  + 'dti.nii.gz' )
-000435b0: 0a20 2020 2020 2020 2020 2020 2077 7269  .            wri
-000435c0: 7465 5f62 7661 6c73 5f62 7665 6373 2820  te_bvals_bvecs( 
-000435d0: 6d79 6474 695b 2762 7661 6c5f 4c52 275d  mydti['bval_LR']
-000435e0: 2c20 6d79 6474 695b 2762 7665 635f 4c52  , mydti['bvec_LR
-000435f0: 275d 2c20 6d79 6f70 202b 2027 7265 6f72  '], myop + 'reor
-00043600: 6965 6e74 6564 2720 290a 2020 2020 2020  iented' ).      
-00043610: 2020 2020 2020 696d 6167 655f 7772 6974        image_writ
-00043620: 655f 7769 7468 5f74 6875 6d62 6e61 696c  e_with_thumbnail
-00043630: 2820 6d79 6474 695b 2764 7769 5f4c 525f  ( mydti['dwi_LR_
-00043640: 6465 7761 7270 6564 275d 2c20 206d 796f  dewarped'],  myo
-00043650: 7020 2b20 2764 7769 2e6e 6969 2e67 7a27  p + 'dwi.nii.gz'
-00043660: 2029 0a20 2020 2020 2020 2020 2020 2069   ).            i
-00043670: 6d61 6765 5f77 7269 7465 5f77 6974 685f  mage_write_with_
-00043680: 7468 756d 626e 6169 6c28 206d 7964 7469  thumbnail( mydti
-00043690: 5b27 6474 7265 636f 6e5f 4c52 5f64 6577  ['dtrecon_LR_dew
-000436a0: 6172 7027 5d5b 2752 4742 275d 202c 2020  arp']['RGB'] ,  
-000436b0: 6d79 6f70 202b 2027 4454 4952 4742 2e6e  myop + 'DTIRGB.n
-000436c0: 6969 2e67 7a27 2029 0a20 2020 2020 2020  ii.gz' ).       
-000436d0: 2020 2020 2069 6d61 6765 5f77 7269 7465       image_write
-000436e0: 5f77 6974 685f 7468 756d 626e 6169 6c28  _with_thumbnail(
-000436f0: 206d 7964 7469 5b27 6a68 755f 6c61 6265   mydti['jhu_labe
-00043700: 6c73 275d 2c20 206d 796f 702b 2764 7469  ls'],  myop+'dti
-00043710: 6a68 756c 6162 656c 732e 6e69 692e 677a  jhulabels.nii.gz
-00043720: 272c 206d 7964 7469 5b27 7265 636f 6e5f  ', mydti['recon_
-00043730: 6661 275d 2029 0a20 2020 2020 2020 2020  fa'] ).         
-00043740: 2020 2069 6d61 6765 5f77 7269 7465 5f77     image_write_w
-00043750: 6974 685f 7468 756d 626e 6169 6c28 206d  ith_thumbnail( m
-00043760: 7964 7469 5b27 7265 636f 6e5f 6661 275d  ydti['recon_fa']
-00043770: 2c20 206d 796f 702b 2764 7469 6661 2e6e  ,  myop+'dtifa.n
-00043780: 6969 2e67 7a27 2029 0a20 2020 2020 2020  ii.gz' ).       
-00043790: 2020 2020 2069 6d61 6765 5f77 7269 7465       image_write
-000437a0: 5f77 6974 685f 7468 756d 626e 6169 6c28  _with_thumbnail(
-000437b0: 206d 7964 7469 5b27 7265 636f 6e5f 6d64   mydti['recon_md
-000437c0: 275d 2c20 206d 796f 702b 2764 7469 6d64  '],  myop+'dtimd
-000437d0: 2e6e 6969 2e67 7a27 2029 0a20 2020 2020  .nii.gz' ).     
-000437e0: 2020 2020 2020 2069 6d61 6765 5f77 7269         image_wri
-000437f0: 7465 5f77 6974 685f 7468 756d 626e 6169  te_with_thumbnai
-00043800: 6c28 206d 7964 7469 5b27 6230 6176 6727  l( mydti['b0avg'
-00043810: 5d2c 2020 6d79 6f70 2b27 6230 6176 672e  ],  myop+'b0avg.
-00043820: 6e69 692e 677a 2720 290a 2020 2020 2020  nii.gz' ).      
-00043830: 2020 2020 2020 696d 6167 655f 7772 6974        image_writ
-00043840: 655f 7769 7468 5f74 6875 6d62 6e61 696c  e_with_thumbnail
-00043850: 2820 6d79 6474 695b 2764 7769 6176 6727  ( mydti['dwiavg'
-00043860: 5d2c 2020 6d79 6f70 2b27 6477 6961 7667  ],  myop+'dwiavg
-00043870: 2e6e 6969 2e67 7a27 2029 0a20 2020 2020  .nii.gz' ).     
-00043880: 2020 2020 2020 2066 6164 6572 6b20 3d20         faderk = 
-00043890: 6d6d 5b27 4454 4927 5d5b 2772 6563 6f6e  mm['DTI']['recon
-000438a0: 5f66 615f 7375 6d6d 6172 7927 5d2e 696c  _fa_summary'].il
-000438b0: 6f63 5b3a 202c 2031 3a5d 0a20 2020 2020  oc[: , 1:].     
-000438c0: 2020 2020 2020 206d 6464 6572 6b20 3d20         mdderk = 
-000438d0: 6d6d 5b27 4454 4927 5d5b 2772 6563 6f6e  mm['DTI']['recon
-000438e0: 5f6d 645f 7375 6d6d 6172 7927 5d2e 696c  _md_summary'].il
-000438f0: 6f63 5b3a 202c 2031 3a5d 0a20 2020 2020  oc[: , 1:].     
-00043900: 2020 2020 2020 2066 6174 3164 6572 6b20         fat1derk 
-00043910: 3d20 6d6d 5b27 4641 5f73 756d 6d27 5d2e  = mm['FA_summ'].
-00043920: 696c 6f63 5b3a 202c 2031 3a5d 0a20 2020  iloc[: , 1:].   
-00043930: 2020 2020 2020 2020 206d 6474 3164 6572           mdt1der
-00043940: 6b20 3d20 6d6d 5b27 4d44 5f73 756d 6d27  k = mm['MD_summ'
-00043950: 5d2e 696c 6f63 5b3a 202c 2031 3a5d 0a20  ].iloc[: , 1:]. 
-00043960: 2020 2069 6620 2774 7261 6374 6f67 7261     if 'tractogra
-00043970: 7068 7927 2069 6e20 6d6d 3a0a 2020 2020  phy' in mm:.    
-00043980: 2020 2020 6966 206d 6d5b 2774 7261 6374      if mm['tract
-00043990: 6f67 7261 7068 7927 5d20 6973 206e 6f74  ography'] is not
-000439a0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000439b0: 2020 206f 666e 203d 206f 7574 7075 745f     ofn = output_
-000439c0: 7072 6566 6978 202b 2073 6570 6172 6174  prefix + separat
-000439d0: 6f72 202b 2027 7472 6163 746f 6772 616d  or + 'tractogram
-000439e0: 2e74 726b 270a 2020 2020 2020 2020 2020  .trk'.          
-000439f0: 2020 7361 7665 5f74 7261 6374 6f67 7261    save_tractogra
-00043a00: 6d28 206d 6d5b 2774 7261 6374 6f67 7261  m( mm['tractogra
-00043a10: 7068 7927 5d5b 2774 7261 6374 6f67 7261  phy']['tractogra
-00043a20: 6d27 5d2c 206f 666e 2029 0a20 2020 2063  m'], ofn ).    c
-00043a30: 6e78 6465 726b 203d 204e 6f6e 650a 2020  nxderk = None.  
-00043a40: 2020 6966 2027 7472 6163 746f 6772 6170    if 'tractograp
-00043a50: 6879 5f63 6f6e 6e65 6374 6976 6974 7927  hy_connectivity'
-00043a60: 2069 6e20 6d6d 3a0a 2020 2020 2020 2020   in mm:.        
-00043a70: 6966 206d 6d5b 2774 7261 6374 6f67 7261  if mm['tractogra
-00043a80: 7068 795f 636f 6e6e 6563 7469 7669 7479  phy_connectivity
-00043a90: 275d 2069 7320 6e6f 7420 4e6f 6e65 3a0a  '] is not None:.
-00043aa0: 2020 2020 2020 2020 2020 2020 636e 7864              cnxd
-00043ab0: 6572 6b20 3d20 6d6d 5b27 7472 6163 746f  erk = mm['tracto
-00043ac0: 6772 6170 6879 5f63 6f6e 6e65 6374 6976  graphy_connectiv
-00043ad0: 6974 7927 5d5b 2763 6f6e 6e65 6374 6976  ity']['connectiv
-00043ae0: 6974 795f 7769 6465 275d 2e69 6c6f 635b  ity_wide'].iloc[
-00043af0: 3a20 2c20 313a 5d20 2320 4e4f 5445 3a20  : , 1:] # NOTE: 
-00043b00: 636f 6e6e 6563 7469 7669 7479 5f77 6964  connectivity_wid
-00043b10: 6520 6973 206e 6f74 206d 7563 6820 7465  e is not much te
-00043b20: 7374 6564 0a20 2020 2020 2020 2020 2020  sted.           
-00043b30: 206f 666e 203d 206f 7574 7075 745f 7072   ofn = output_pr
-00043b40: 6566 6978 202b 2073 6570 6172 6174 6f72  efix + separator
-00043b50: 202b 2027 6474 6973 7472 6561 6d6c 696e   + 'dtistreamlin
-00043b60: 6563 6f6e 6e2e 6373 7627 0a20 2020 2020  econn.csv'.     
-00043b70: 2020 2020 2020 2070 642e 4461 7461 4672         pd.DataFr
-00043b80: 616d 6528 6d6d 5b27 7472 6163 746f 6772  ame(mm['tractogr
-00043b90: 6170 6879 5f63 6f6e 6e65 6374 6976 6974  aphy_connectivit
-00043ba0: 7927 5d5b 2763 6f6e 6e65 6374 6976 6974  y']['connectivit
-00043bb0: 795f 6d61 7472 6978 275d 292e 746f 5f63  y_matrix']).to_c
-00043bc0: 7376 2820 6f66 6e20 290a 0a20 2020 2064  sv( ofn )..    d
-00043bd0: 6c69 7374 203d 205b 0a20 2020 2020 2020  list = [.       
-00043be0: 2074 686b 6465 726b 2c0a 2020 2020 2020   thkderk,.      
-00043bf0: 2020 6b6b 6465 726b 2c0a 2020 2020 2020    kkderk,.      
-00043c00: 2020 6e6d 6465 726b 2c0a 2020 2020 2020    nmderk,.      
-00043c10: 2020 6661 6465 726b 2c0a 2020 2020 2020    faderk,.      
-00043c20: 2020 6d64 6465 726b 2c0a 2020 2020 2020    mdderk,.      
-00043c30: 2020 6661 7431 6465 726b 2c0a 2020 2020    fat1derk,.    
-00043c40: 2020 2020 6d64 7431 6465 726b 2c0a 2020      mdt1derk,.  
-00043c50: 2020 2020 2020 636e 7864 6572 6b0a 2020        cnxderk.  
-00043c60: 2020 2020 2020 5d0a 2020 2020 6973 5f61        ].    is_a
-00043c70: 6c6c 5f6e 6f6e 6520 3d20 616c 6c28 656c  ll_none = all(el
-00043c80: 656d 656e 7420 6973 204e 6f6e 6520 666f  ement is None fo
-00043c90: 7220 656c 656d 656e 7420 696e 2064 6c69  r element in dli
-00043ca0: 7374 290a 2020 2020 6966 2069 735f 616c  st).    if is_al
-00043cb0: 6c5f 6e6f 6e65 3a0a 2020 2020 2020 2020  l_none:.        
-00043cc0: 6d6d 5f77 6964 6520 3d20 7064 2e44 6174  mm_wide = pd.Dat
-00043cd0: 6146 7261 6d65 287b 2775 5f68 6965 725f  aFrame({'u_hier_
-00043ce0: 6964 273a 205b 6f75 7470 7574 5f70 7265  id': [output_pre
-00043cf0: 6669 785d 207d 290a 2020 2020 656c 7365  fix] }).    else
-00043d00: 3a0a 2020 2020 2020 2020 6d6d 5f77 6964  :.        mm_wid
-00043d10: 6520 3d20 7064 2e63 6f6e 6361 7428 2064  e = pd.concat( d
-00043d20: 6c69 7374 2c20 6178 6973 3d31 2c20 6967  list, axis=1, ig
-00043d30: 6e6f 7265 5f69 6e64 6578 3d46 616c 7365  nore_index=False
-00043d40: 2029 0a0a 2020 2020 6d6d 5f77 6964 6520   )..    mm_wide 
-00043d50: 3d20 6d6d 5f77 6964 652e 636f 7079 2829  = mm_wide.copy()
-00043d60: 0a20 2020 2069 6620 274e 4d27 2069 6e20  .    if 'NM' in 
-00043d70: 6d6d 3a0a 2020 2020 2020 2020 6966 206d  mm:.        if m
-00043d80: 6d5b 274e 4d27 5d20 6973 206e 6f74 204e  m['NM'] is not N
-00043d90: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00043da0: 206e 6d77 6964 6520 3d20 6469 6374 5f74   nmwide = dict_t
-00043db0: 6f5f 6461 7461 6672 616d 6528 206d 6d5b  o_dataframe( mm[
-00043dc0: 274e 4d27 5d20 290a 2020 2020 2020 2020  'NM'] ).        
-00043dd0: 2020 2020 6966 206d 6d5f 7769 6465 2e73      if mm_wide.s
-00043de0: 6861 7065 5b30 5d20 3e20 3020 616e 6420  hape[0] > 0 and 
-00043df0: 6e6d 7769 6465 2e73 6861 7065 5b30 5d20  nmwide.shape[0] 
-00043e00: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-00043e10: 2020 2020 206e 6d77 6964 652e 7365 745f       nmwide.set_
-00043e20: 696e 6465 7828 206d 6d5f 7769 6465 2e69  index( mm_wide.i
-00043e30: 6e64 6578 2c20 696e 706c 6163 653d 5472  ndex, inplace=Tr
-00043e40: 7565 2029 0a20 2020 2020 2020 2020 2020  ue ).           
-00043e50: 206d 6d5f 7769 6465 203d 2070 642e 636f   mm_wide = pd.co
-00043e60: 6e63 6174 2820 5b6d 6d5f 7769 6465 2c20  ncat( [mm_wide, 
-00043e70: 6e6d 7769 6465 205d 2c20 6178 6973 3d31  nmwide ], axis=1
-00043e80: 2c20 6967 6e6f 7265 5f69 6e64 6578 3d46  , ignore_index=F
-00043e90: 616c 7365 2029 0a20 2020 2069 6620 2766  alse ).    if 'f
-00043ea0: 6c61 6972 2720 696e 206d 6d3a 0a20 2020  lair' in mm:.   
-00043eb0: 2020 2020 2069 6620 6d6d 5b27 666c 6169       if mm['flai
-00043ec0: 7227 5d20 6973 206e 6f74 204e 6f6e 653a  r'] is not None:
-00043ed0: 0a20 2020 2020 2020 2020 2020 206d 796f  .            myo
-00043ee0: 7020 3d20 6f75 7470 7574 5f70 7265 6669  p = output_prefi
-00043ef0: 7820 2b20 7365 7061 7261 746f 7220 2b20  x + separator + 
-00043f00: 2777 6d68 2e6e 6969 2e67 7a27 0a20 2020  'wmh.nii.gz'.   
-00043f10: 2020 2020 2020 2020 2070 6e67 666e 6220           pngfnb 
-00043f20: 3d20 6f75 7470 7574 5f70 7265 6669 7820  = output_prefix 
-00043f30: 2b20 7365 7061 7261 746f 7220 2b20 2777  + separator + 'w
-00043f40: 6d68 5f73 6567 2e70 6e67 270a 2020 2020  mh_seg.png'.    
-00043f50: 2020 2020 2020 2020 616e 7473 2e70 6c6f          ants.plo
-00043f60: 7428 206d 6d5b 2766 6c61 6972 275d 5b27  t( mm['flair']['
-00043f70: 666c 6169 7227 5d2c 206d 6d5b 2766 6c61  flair'], mm['fla
-00043f80: 6972 275d 5b27 574d 485f 706f 7374 6572  ir']['WMH_poster
-00043f90: 696f 725f 7072 6f62 6162 696c 6974 795f  ior_probability_
-00043fa0: 6d61 7027 5d2c 2061 7869 733d 322c 206e  map'], axis=2, n
-00043fb0: 736c 6963 6573 3d32 312c 206e 636f 6c3d  slices=21, ncol=
-00043fc0: 372c 2066 696c 656e 616d 653d 706e 6766  7, filename=pngf
-00043fd0: 6e62 2c20 6372 6f70 3d54 7275 6520 290a  nb, crop=True ).
-00043fe0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-00043ff0: 6d5b 2766 6c61 6972 275d 5b27 574d 485f  m['flair']['WMH_
-00044000: 7072 6f62 6162 696c 6974 795f 6d61 7027  probability_map'
-00044010: 5d20 6973 206e 6f74 204e 6f6e 653a 0a20  ] is not None:. 
-00044020: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00044030: 6d61 6765 5f77 7269 7465 5f77 6974 685f  mage_write_with_
-00044040: 7468 756d 626e 6169 6c28 206d 6d5b 2766  thumbnail( mm['f
-00044050: 6c61 6972 275d 5b27 574d 485f 7072 6f62  lair']['WMH_prob
-00044060: 6162 696c 6974 795f 6d61 7027 5d2c 206d  ability_map'], m
-00044070: 796f 702c 2074 6875 6d62 3d46 616c 7365  yop, thumb=False
-00044080: 2029 0a20 2020 2020 2020 2020 2020 2066   ).            f
-00044090: 6c77 6964 6520 3d20 6469 6374 5f74 6f5f  lwide = dict_to_
-000440a0: 6461 7461 6672 616d 6528 206d 6d5b 2766  dataframe( mm['f
-000440b0: 6c61 6972 275d 2029 0a20 2020 2020 2020  lair'] ).       
-000440c0: 2020 2020 2069 6620 6d6d 5f77 6964 652e       if mm_wide.
-000440d0: 7368 6170 655b 305d 203e 2030 2061 6e64  shape[0] > 0 and
-000440e0: 2066 6c77 6964 652e 7368 6170 655b 305d   flwide.shape[0]
-000440f0: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
-00044100: 2020 2020 2020 666c 7769 6465 2e73 6574        flwide.set
-00044110: 5f69 6e64 6578 2820 6d6d 5f77 6964 652e  _index( mm_wide.
-00044120: 696e 6465 782c 2069 6e70 6c61 6365 3d54  index, inplace=T
-00044130: 7275 6520 290a 2020 2020 2020 2020 2020  rue ).          
-00044140: 2020 6d6d 5f77 6964 6520 3d20 7064 2e63    mm_wide = pd.c
-00044150: 6f6e 6361 7428 205b 6d6d 5f77 6964 652c  oncat( [mm_wide,
-00044160: 2066 6c77 6964 6520 5d2c 2061 7869 733d   flwide ], axis=
-00044170: 312c 2069 676e 6f72 655f 696e 6465 783d  1, ignore_index=
-00044180: 4661 6c73 6520 290a 2020 2020 6966 2027  False ).    if '
-00044190: 7273 6627 2069 6e20 6d6d 3a0a 2020 2020  rsf' in mm:.    
-000441a0: 2020 2020 6966 206d 6d5b 2772 7366 275d      if mm['rsf']
-000441b0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-000441c0: 2020 2020 2020 2020 2020 6663 6e78 7072            fcnxpr
-000441d0: 6f3d 3939 0a20 2020 2020 2020 2020 2020  o=99.           
-000441e0: 2072 7366 6461 7461 203d 206d 6d5b 2772   rsfdata = mm['r
-000441f0: 7366 275d 0a20 2020 2020 2020 2020 2020  sf'].           
-00044200: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
-00044210: 6365 2820 7273 6664 6174 612c 206c 6973  ce( rsfdata, lis
-00044220: 7420 293a 0a20 2020 2020 2020 2020 2020  t ):.           
-00044230: 2020 2020 2072 7366 6461 7461 203d 205b       rsfdata = [
-00044240: 2072 7366 6461 7461 205d 0a20 2020 2020   rsfdata ].     
-00044250: 2020 2020 2020 2066 6f72 2072 7366 7072         for rsfpr
-00044260: 6f20 696e 2072 7366 6461 7461 3a0a 2020  o in rsfdata:.  
-00044270: 2020 2020 2020 2020 2020 2020 2020 6663                fc
-00044280: 6e78 7072 6f3d 7374 7228 2072 7366 7072  nxpro=str( rsfpr
-00044290: 6f5b 2770 6172 616d 7365 7427 5d20 2029  o['paramset']  )
-000442a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000442b0: 2070 726f 6e75 6d20 3d20 2766 636e 7870   pronum = 'fcnxp
-000442c0: 726f 272b 7374 7228 6663 6e78 7072 6f29  ro'+str(fcnxpro)
-000442d0: 2b22 5f22 0a20 2020 2020 2020 2020 2020  +"_".           
-000442e0: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-000442f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00044300: 2020 2020 2070 7269 6e74 2822 436f 6c6c       print("Coll
-00044310: 6563 7420 7273 6620 6461 7461 2022 202b  ect rsf data " +
-00044320: 2070 726f 6e75 6d29 0a20 2020 2020 2020   pronum).       
-00044330: 2020 2020 2020 2020 206e 6577 5f72 7366           new_rsf
-00044340: 5f77 6964 6520 3d20 6469 6374 5f74 6f5f  _wide = dict_to_
-00044350: 6461 7461 6672 616d 6528 2072 7366 7072  dataframe( rsfpr
-00044360: 6f20 290a 2020 2020 2020 2020 2020 2020  o ).            
-00044370: 2020 2020 6e65 775f 7273 665f 7769 6465      new_rsf_wide
-00044380: 203d 2070 642e 636f 6e63 6174 2820 5b6e   = pd.concat( [n
-00044390: 6577 5f72 7366 5f77 6964 652c 2072 7366  ew_rsf_wide, rsf
-000443a0: 7072 6f5b 2763 6f72 725f 7769 6465 275d  pro['corr_wide']
-000443b0: 205d 2c20 6178 6973 3d31 2c20 6967 6e6f   ], axis=1, igno
-000443c0: 7265 5f69 6e64 6578 3d46 616c 7365 2029  re_index=False )
-000443d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000443e0: 206e 6577 5f72 7366 5f77 6964 6520 3d20   new_rsf_wide = 
-000443f0: 6e65 775f 7273 665f 7769 6465 2e61 6464  new_rsf_wide.add
-00044400: 5f70 7265 6669 7828 2070 726f 6e75 6d20  _prefix( pronum 
-00044410: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00044420: 2020 6e65 775f 7273 665f 7769 6465 2e73    new_rsf_wide.s
-00044430: 6574 5f69 6e64 6578 2820 6d6d 5f77 6964  et_index( mm_wid
-00044440: 652e 696e 6465 782c 2069 6e70 6c61 6365  e.index, inplace
-00044450: 3d54 7275 6520 290a 2020 2020 2020 2020  =True ).        
-00044460: 2020 2020 2020 2020 6f66 6e20 3d20 6f75          ofn = ou
-00044470: 7470 7574 5f70 7265 6669 7820 2b20 7365  tput_prefix + se
-00044480: 7061 7261 746f 7220 2b20 7072 6f6e 756d  parator + pronum
-00044490: 202b 2027 2e63 7376 270a 2020 2020 2020   + '.csv'.      
-000444a0: 2020 2020 2020 2020 2020 6e65 775f 7273            new_rs
-000444b0: 665f 7769 6465 2e74 6f5f 6373 7628 206f  f_wide.to_csv( o
-000444c0: 666e 2029 0a20 2020 2020 2020 2020 2020  fn ).           
-000444d0: 2020 2020 206d 6d5f 7769 6465 203d 2070       mm_wide = p
-000444e0: 642e 636f 6e63 6174 2820 5b6d 6d5f 7769  d.concat( [mm_wi
-000444f0: 6465 2c20 6e65 775f 7273 665f 7769 6465  de, new_rsf_wide
-00044500: 205d 2c20 6178 6973 3d31 2c20 6967 6e6f   ], axis=1, igno
-00044510: 7265 5f69 6e64 6578 3d46 616c 7365 2029  re_index=False )
-00044520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00044530: 2066 6f72 206d 796b 6579 2069 6e20 6765   for mykey in ge
-00044540: 745f 616e 7473 696d 6167 655f 6b65 7973  t_antsimage_keys
-00044550: 2820 7273 6670 726f 2029 3a0a 2020 2020  ( rsfpro ):.    
-00044560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044570: 6d79 6f70 203d 206f 7574 7075 745f 7072  myop = output_pr
-00044580: 6566 6978 202b 2073 6570 6172 6174 6f72  efix + separator
-00044590: 202b 2070 726f 6e75 6d20 2b20 6d79 6b65   + pronum + myke
-000445a0: 7920 2b20 272e 6e69 692e 677a 270a 2020  y + '.nii.gz'.  
-000445b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000445c0: 2020 696d 6167 655f 7772 6974 655f 7769    image_write_wi
-000445d0: 7468 5f74 6875 6d62 6e61 696c 2820 7273  th_thumbnail( rs
-000445e0: 6670 726f 5b6d 796b 6579 5d2c 206d 796f  fpro[mykey], myo
-000445f0: 702c 2074 6875 6d62 3d54 7275 6520 290a  p, thumb=True ).
-00044600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044610: 6f66 6e20 3d20 6f75 7470 7574 5f70 7265  ofn = output_pre
-00044620: 6669 7820 2b20 7365 7061 7261 746f 7220  fix + separator 
-00044630: 2b20 7072 6f6e 756d 202b 2027 7273 6663  + pronum + 'rsfc
-00044640: 6f72 722e 6373 7627 0a20 2020 2020 2020  orr.csv'.       
-00044650: 2020 2020 2020 2020 2072 7366 7072 6f5b           rsfpro[
-00044660: 2763 6f72 7227 5d2e 746f 5f63 7376 2820  'corr'].to_csv( 
-00044670: 6f66 6e20 290a 2020 2020 2020 2020 2020  ofn ).          
-00044680: 2020 2020 2020 2320 6170 706c 7920 7361        # apply sa
-00044690: 6d65 2070 7269 6e63 6970 6c65 2074 6f20  me principle to 
-000446a0: 6e65 7720 636f 7272 656c 6174 696f 6e20  new correlation 
-000446b0: 6d61 7472 6978 2c20 646f 6573 6e27 7420  matrix, doesn't 
-000446c0: 6e65 6564 2074 6f20 6265 2069 6e63 6f72  need to be incor
-000446d0: 706f 7261 7465 6420 7769 7468 206d 6d5f  porated with mm_
-000446e0: 7769 6465 0a20 2020 2020 2020 2020 2020  wide.           
-000446f0: 2020 2020 206f 666e 3220 3d20 6f75 7470       ofn2 = outp
-00044700: 7574 5f70 7265 6669 7820 2b20 7365 7061  ut_prefix + sepa
-00044710: 7261 746f 7220 2b20 7072 6f6e 756d 202b  rator + pronum +
-00044720: 2027 6e6f 6465 7363 6f72 722e 6373 7627   'nodescorr.csv'
-00044730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00044740: 2072 7366 7072 6f5b 2766 756c 6c43 6f72   rsfpro['fullCor
-00044750: 724d 6174 275d 2e74 6f5f 6373 7628 206f  rMat'].to_csv( o
-00044760: 666e 3220 290a 2020 2020 6966 2027 4454  fn2 ).    if 'DT
-00044770: 4927 2069 6e20 6d6d 3a0a 2020 2020 2020  I' in mm:.      
-00044780: 2020 6966 206d 6d5b 2744 5449 275d 2069    if mm['DTI'] i
-00044790: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-000447a0: 2020 2020 2020 2020 6d79 6474 6920 3d20          mydti = 
-000447b0: 6d6d 5b27 4454 4927 5d0a 2020 2020 2020  mm['DTI'].      
-000447c0: 2020 2020 2020 6d6d 5f77 6964 655b 2764        mm_wide['d
-000447d0: 7469 5f74 736e 725f 6230 5f6d 6561 6e27  ti_tsnr_b0_mean'
-000447e0: 5d20 3d20 206d 7964 7469 5b27 7473 6e72  ] =  mydti['tsnr
-000447f0: 5f62 3027 5d2e 6d65 616e 2829 0a20 2020  _b0'].mean().   
-00044800: 2020 2020 2020 2020 206d 6d5f 7769 6465           mm_wide
-00044810: 5b27 6474 695f 7473 6e72 5f64 7769 5f6d  ['dti_tsnr_dwi_m
-00044820: 6561 6e27 5d20 3d20 206d 7964 7469 5b27  ean'] =  mydti['
-00044830: 7473 6e72 5f64 7769 275d 2e6d 6561 6e28  tsnr_dwi'].mean(
-00044840: 290a 2020 2020 2020 2020 2020 2020 6d6d  ).            mm
-00044850: 5f77 6964 655b 2764 7469 5f64 7661 7273  _wide['dti_dvars
-00044860: 5f62 305f 6d65 616e 275d 203d 2020 6d79  _b0_mean'] =  my
-00044870: 6474 695b 2764 7661 7273 5f62 3027 5d2e  dti['dvars_b0'].
-00044880: 6d65 616e 2829 0a20 2020 2020 2020 2020  mean().         
-00044890: 2020 206d 6d5f 7769 6465 5b27 6474 695f     mm_wide['dti_
-000448a0: 6476 6172 735f 6477 695f 6d65 616e 275d  dvars_dwi_mean']
-000448b0: 203d 2020 6d79 6474 695b 2764 7661 7273   =  mydti['dvars
-000448c0: 5f64 7769 275d 2e6d 6561 6e28 290a 2020  _dwi'].mean().  
-000448d0: 2020 2020 2020 2020 2020 6d6d 5f77 6964            mm_wid
-000448e0: 655b 2764 7469 5f73 736e 725f 6230 5f6d  e['dti_ssnr_b0_m
-000448f0: 6561 6e27 5d20 3d20 206d 7964 7469 5b27  ean'] =  mydti['
-00044900: 7373 6e72 5f62 3027 5d2e 6d65 616e 2829  ssnr_b0'].mean()
-00044910: 0a20 2020 2020 2020 2020 2020 206d 6d5f  .            mm_
-00044920: 7769 6465 5b27 6474 695f 7373 6e72 5f64  wide['dti_ssnr_d
-00044930: 7769 5f6d 6561 6e27 5d20 3d20 206d 7964  wi_mean'] =  myd
-00044940: 7469 5b27 7373 6e72 5f64 7769 275d 2e6d  ti['ssnr_dwi'].m
-00044950: 6561 6e28 290a 2020 2020 2020 2020 2020  ean().          
-00044960: 2020 6d6d 5f77 6964 655b 2764 7469 5f66    mm_wide['dti_f
-00044970: 615f 6576 7227 5d20 3d20 206d 7964 7469  a_evr'] =  mydti
-00044980: 5b27 6661 5f65 7672 275d 0a20 2020 2020  ['fa_evr'].     
-00044990: 2020 2020 2020 206d 6d5f 7769 6465 5b27         mm_wide['
-000449a0: 6474 695f 6661 5f53 4e52 275d 203d 2020  dti_fa_SNR'] =  
-000449b0: 6d79 6474 695b 2766 615f 534e 5227 5d0a  mydti['fa_SNR'].
-000449c0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-000449d0: 7964 7469 5b27 6672 616d 6577 6973 655f  ydti['framewise_
-000449e0: 6469 7370 6c61 6365 6d65 6e74 275d 2069  displacement'] i
-000449f0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00044a00: 2020 2020 2020 2020 2020 2020 6d6d 5f77              mm_w
-00044a10: 6964 655b 2764 7469 5f68 6967 685f 6d6f  ide['dti_high_mo
-00044a20: 7469 6f6e 5f63 6f75 6e74 275d 203d 2020  tion_count'] =  
-00044a30: 6d79 6474 695b 2768 6967 685f 6d6f 7469  mydti['high_moti
-00044a40: 6f6e 5f63 6f75 6e74 275d 0a20 2020 2020  on_count'].     
-00044a50: 2020 2020 2020 2020 2020 206d 6d5f 7769             mm_wi
-00044a60: 6465 5b27 6474 695f 4644 5f6d 6561 6e27  de['dti_FD_mean'
-00044a70: 5d20 3d20 6d79 6474 695b 2766 7261 6d65  ] = mydti['frame
-00044a80: 7769 7365 5f64 6973 706c 6163 656d 656e  wise_displacemen
-00044a90: 7427 5d2e 6d65 616e 2829 0a20 2020 2020  t'].mean().     
-00044aa0: 2020 2020 2020 2020 2020 206d 6d5f 7769             mm_wi
-00044ab0: 6465 5b27 6474 695f 4644 5f6d 6178 275d  de['dti_FD_max']
-00044ac0: 203d 206d 7964 7469 5b27 6672 616d 6577   = mydti['framew
-00044ad0: 6973 655f 6469 7370 6c61 6365 6d65 6e74  ise_displacement
-00044ae0: 275d 2e6d 6178 2829 0a20 2020 2020 2020  '].max().       
-00044af0: 2020 2020 2020 2020 206d 6d5f 7769 6465           mm_wide
-00044b00: 5b27 6474 695f 4644 5f73 6427 5d20 3d20  ['dti_FD_sd'] = 
-00044b10: 6d79 6474 695b 2766 7261 6d65 7769 7365  mydti['framewise
-00044b20: 5f64 6973 706c 6163 656d 656e 7427 5d2e  _displacement'].
-00044b30: 7374 6428 290a 2020 2020 2020 2020 2020  std().          
-00044b40: 2020 2020 2020 6664 666e 203d 206f 7574        fdfn = out
-00044b50: 7075 745f 7072 6566 6978 202b 2073 6570  put_prefix + sep
-00044b60: 6172 6174 6f72 202b 2027 5f66 642e 6373  arator + '_fd.cs
-00044b70: 7627 0a20 2020 2020 2020 2020 2020 2065  v'.            e
-00044b80: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00044b90: 2020 2020 206d 6d5f 7769 6465 5b27 6474       mm_wide['dt
-00044ba0: 695f 4644 5f6d 6561 6e27 5d20 3d20 6d6d  i_FD_mean'] = mm
-00044bb0: 5f77 6964 655b 2764 7469 5f46 445f 6d61  _wide['dti_FD_ma
-00044bc0: 7827 5d20 3d20 6d6d 5f77 6964 655b 2764  x'] = mm_wide['d
-00044bd0: 7469 5f46 445f 7364 275d 203d 2027 4e41  ti_FD_sd'] = 'NA
-00044be0: 270a 0a20 2020 2069 6620 2770 6572 6627  '..    if 'perf'
-00044bf0: 2069 6e20 6d6d 3a0a 2020 2020 2020 2020   in mm:.        
-00044c00: 6966 206d 6d5b 2770 6572 6627 5d20 6973  if mm['perf'] is
-00044c10: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00044c20: 2020 2020 2020 2070 6572 6670 726f 203d         perfpro =
-00044c30: 206d 6d5b 2770 6572 6627 5d0a 2020 2020   mm['perf'].    
-00044c40: 2020 2020 2020 2020 7072 7769 6465 203d          prwide =
-00044c50: 2064 6963 745f 746f 5f64 6174 6166 7261   dict_to_datafra
-00044c60: 6d65 2820 7065 7266 7072 6f20 290a 2020  me( perfpro ).  
-00044c70: 2020 2020 2020 2020 2020 6966 206d 6d5f            if mm_
-00044c80: 7769 6465 2e73 6861 7065 5b30 5d20 3e20  wide.shape[0] > 
-00044c90: 3020 616e 6420 7072 7769 6465 2e73 6861  0 and prwide.sha
-00044ca0: 7065 5b30 5d20 3e20 303a 0a20 2020 2020  pe[0] > 0:.     
-00044cb0: 2020 2020 2020 2020 2020 2070 7277 6964             prwid
-00044cc0: 652e 7365 745f 696e 6465 7828 206d 6d5f  e.set_index( mm_
-00044cd0: 7769 6465 2e69 6e64 6578 2c20 696e 706c  wide.index, inpl
-00044ce0: 6163 653d 5472 7565 2029 0a20 2020 2020  ace=True ).     
-00044cf0: 2020 2020 2020 206d 6d5f 7769 6465 203d         mm_wide =
-00044d00: 2070 642e 636f 6e63 6174 2820 5b6d 6d5f   pd.concat( [mm_
-00044d10: 7769 6465 2c20 7072 7769 6465 205d 2c20  wide, prwide ], 
-00044d20: 6178 6973 3d31 2c20 6967 6e6f 7265 5f69  axis=1, ignore_i
-00044d30: 6e64 6578 3d46 616c 7365 2029 0a20 2020  ndex=False ).   
-00044d40: 2020 2020 2020 2020 2069 6620 2770 6572           if 'per
-00044d50: 665f 6461 7461 6672 616d 6527 2069 6e20  f_dataframe' in 
-00044d60: 7065 7266 7072 6f2e 6b65 7973 2829 3a0a  perfpro.keys():.
-00044d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044d80: 7064 6572 6b20 3d20 7065 7266 7072 6f5b  pderk = perfpro[
-00044d90: 2770 6572 665f 6461 7461 6672 616d 6527  'perf_dataframe'
-00044da0: 5d2e 696c 6f63 5b3a 202c 2031 3a5d 0a20  ].iloc[: , 1:]. 
-00044db0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00044dc0: 6465 726b 2e73 6574 5f69 6e64 6578 2820  derk.set_index( 
-00044dd0: 6d6d 5f77 6964 652e 696e 6465 782c 2069  mm_wide.index, i
-00044de0: 6e70 6c61 6365 3d54 7275 6520 290a 2020  nplace=True ).  
-00044df0: 2020 2020 2020 2020 2020 2020 2020 6d6d                mm
-00044e00: 5f77 6964 6520 3d20 7064 2e63 6f6e 6361  _wide = pd.conca
-00044e10: 7428 205b 206d 6d5f 7769 6465 2c20 7064  t( [ mm_wide, pd
-00044e20: 6572 6b20 5d2c 2061 7869 733d 312c 2069  erk ], axis=1, i
-00044e30: 676e 6f72 655f 696e 6465 783d 4661 6c73  gnore_index=Fals
-00044e40: 6520 290a 2020 2020 2020 2020 2020 2020  e ).            
-00044e50: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00044e60: 2020 2020 2020 7072 696e 7428 2246 4958        print("FIX
-00044e70: 4d45 202d 2070 6572 6675 7369 6f6e 2064  ME - perfusion d
-00044e80: 6174 6166 7261 6d65 2229 0a20 2020 2020  ataframe").     
-00044e90: 2020 2020 2020 2066 6f72 206d 796b 6579         for mykey
-00044ea0: 2069 6e20 6765 745f 616e 7473 696d 6167   in get_antsimag
-00044eb0: 655f 6b65 7973 2820 6d6d 5b27 7065 7266  e_keys( mm['perf
-00044ec0: 275d 2029 3a0a 2020 2020 2020 2020 2020  '] ):.          
-00044ed0: 2020 2020 2020 7465 6d70 666e 203d 206f        tempfn = o
-00044ee0: 7574 7075 745f 7072 6566 6978 202b 2073  utput_prefix + s
-00044ef0: 6570 6172 6174 6f72 202b 206d 796b 6579  eparator + mykey
-00044f00: 202b 2027 2e6e 6969 2e67 7a27 0a20 2020   + '.nii.gz'.   
-00044f10: 2020 2020 2020 2020 2020 2020 2069 6d61               ima
-00044f20: 6765 5f77 7269 7465 5f77 6974 685f 7468  ge_write_with_th
-00044f30: 756d 626e 6169 6c28 206d 6d5b 2770 6572  umbnail( mm['per
-00044f40: 6627 5d5b 6d79 6b65 795d 2c20 7465 6d70  f'][mykey], temp
-00044f50: 666e 2c20 7468 756d 623d 4661 6c73 6520  fn, thumb=False 
-00044f60: 290a 0a20 2020 206d 6d77 6964 6566 6e20  )..    mmwidefn 
-00044f70: 3d20 6f75 7470 7574 5f70 7265 6669 7820  = output_prefix 
-00044f80: 2b20 7365 7061 7261 746f 7220 2b20 276d  + separator + 'm
-00044f90: 6d77 6964 652e 6373 7627 0a20 2020 206d  mwide.csv'.    m
-00044fa0: 6d5f 7769 6465 2e74 6f5f 6373 7628 206d  m_wide.to_csv( m
-00044fb0: 6d77 6964 6566 6e20 290a 2020 2020 6966  mwidefn ).    if
-00044fc0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-00044fd0: 2020 7072 696e 7428 206f 7574 7075 745f    print( output_
-00044fe0: 7072 6566 6978 202b 2022 2077 7269 7465  prefix + " write
-00044ff0: 5f6d 6d20 646f 6e65 2e22 2029 0a20 2020  _mm done." ).   
-00045000: 2072 6574 7572 6e0a 0a0a 6465 6620 6d6d   return...def mm
-00045010: 5f6e 7267 280a 2020 2020 7374 7564 7969  _nrg(.    studyi
-00045020: 642c 2020 2023 2070 616e 6461 7320 6461  d,   # pandas da
-00045030: 7461 2066 7261 6d65 0a20 2020 2073 6f75  ta frame.    sou
-00045040: 7263 6564 6972 203d 206f 732e 7061 7468  rcedir = os.path
-00045050: 2e65 7870 616e 6475 7365 7228 2022 7e2f  .expanduser( "~/
-00045060: 6461 7461 2f50 504d 492f 4d56 2f65 7861  data/PPMI/MV/exa
-00045070: 6d70 6c65 5f73 335f 622f 696d 6167 6573  mple_s3_b/images
-00045080: 2f50 504d 492f 2220 292c 0a20 2020 2073  /PPMI/" ),.    s
-00045090: 6f75 7263 6564 6174 6166 6f6c 6465 726e  ourcedatafoldern
-000450a0: 616d 6520 3d20 2769 6d61 6765 7327 2c20  ame = 'images', 
-000450b0: 2320 726f 6f74 2066 6f72 2073 6f75 7263  # root for sourc
-000450c0: 6520 6461 7461 0a20 2020 2070 726f 6365  e data.    proce
-000450d0: 7373 4469 7220 3d20 2270 726f 6365 7373  ssDir = "process
-000450e0: 6564 222c 2023 2077 6865 7265 206f 7574  ed", # where out
-000450f0: 7075 7420 7769 6c6c 2067 6f20 2d20 7061  put will go - pa
-00045100: 7261 6c6c 656c 2074 6f20 736f 7572 6365  rallel to source
-00045110: 6461 7461 666f 6c64 6572 6e61 6d65 0a20  datafoldername. 
-00045120: 2020 206d 7973 6570 203d 2027 2d27 2c20     mysep = '-', 
-00045130: 2320 6465 6669 6e65 2061 2073 6570 6172  # define a separ
-00045140: 6174 6f72 2066 6f72 2066 696c 656e 616d  ator for filenam
-00045150: 6520 636f 6d70 6f6e 656e 7473 0a20 2020  e components.   
-00045160: 2073 726d 6f64 656c 5f54 3120 3d20 4661   srmodel_T1 = Fa
-00045170: 6c73 652c 2023 206f 7074 696f 6e61 6c20  lse, # optional 
-00045180: 2d20 7769 6c6c 2061 6464 2061 2067 7265  - will add a gre
-00045190: 6174 2064 6561 6c20 6f66 2074 696d 650a  at deal of time.
-000451a0: 2020 2020 7372 6d6f 6465 6c5f 4e4d 203d      srmodel_NM =
-000451b0: 2046 616c 7365 2c20 2320 6f70 7469 6f6e   False, # option
-000451c0: 616c 202d 2077 696c 6c20 6164 6420 6120  al - will add a 
-000451d0: 6772 6561 7420 6465 616c 206f 6620 7469  great deal of ti
-000451e0: 6d65 0a20 2020 2073 726d 6f64 656c 5f44  me.    srmodel_D
-000451f0: 5449 203d 2046 616c 7365 2c20 2320 6f70  TI = False, # op
-00045200: 7469 6f6e 616c 202d 2077 696c 6c20 6164  tional - will ad
-00045210: 6420 6120 6772 6561 7420 6465 616c 206f  d a great deal o
-00045220: 6620 7469 6d65 0a20 2020 2076 6973 7561  f time.    visua
-00045230: 6c69 7a65 203d 2054 7275 652c 0a20 2020  lize = True,.   
-00045240: 206e 7267 5f6d 6f64 616c 6974 795f 6c69   nrg_modality_li
-00045250: 7374 203d 205b 2254 3177 222c 2022 4e4d  st = ["T1w", "NM
-00045260: 3244 4d54 222c 2022 4454 4922 2c22 5432  2DMT", "DTI","T2
-00045270: 466c 6169 7222 2c20 2272 7366 4d52 4922  Flair", "rsfMRI"
-00045280: 205d 2c0a 2020 2020 7665 7262 6f73 6520   ],.    verbose 
-00045290: 3d20 5472 7565 0a29 3a0a 2020 2020 2222  = True.):.    ""
-000452a0: 220a 2020 2020 746f 6f20 6461 6e67 6572  ".    too danger
-000452b0: 6f75 7320 746f 2064 6f63 756d 656e 7420  ous to document 
-000452c0: 2e2e 2e20 7573 6520 7769 7468 2063 6172  ... use with car
-000452d0: 652e 0a0a 2020 2020 7072 6f63 6573 7365  e...    processe
-000452e0: 7320 6d75 6c74 6970 6c65 206d 6f64 616c  s multiple modal
-000452f0: 6974 7920 4d52 4920 7370 6563 6966 6963  ity MRI specific
-00045300: 616c 6c79 3a0a 0a20 2020 202a 2054 3177  ally:..    * T1w
-00045310: 0a20 2020 202a 2054 3246 6c61 6972 0a20  .    * T2Flair. 
-00045320: 2020 202a 2044 5449 2c20 4454 495f 4c52     * DTI, DTI_LR
-00045330: 2c20 4454 495f 524c 0a20 2020 202a 2072  , DTI_RL.    * r
-00045340: 7366 4d52 492c 2072 7366 4d52 495f 4c52  sfMRI, rsfMRI_LR
-00045350: 2c20 7273 664d 5249 5f52 4c0a 2020 2020  , rsfMRI_RL.    
-00045360: 2a20 4e4d 3244 4d54 2028 6e65 7572 6f6d  * NM2DMT (neurom
-00045370: 656c 616e 696e 290a 0a20 2020 206f 7468  elanin)..    oth
-00045380: 6572 206d 6f64 616c 6974 6965 7320 6d61  er modalities ma
-00045390: 7920 6265 2061 6464 6564 206c 6174 6572  y be added later
-000453a0: 202e 2e2e 0a0a 2020 2020 2274 7275 7374   .....    "trust
-000453b0: 206d 652c 2069 206b 6e6f 7720 7768 6174   me, i know what
-000453c0: 2069 276d 2064 6f69 6e67 2220 2d20 736c   i'm doing" - sl
-000453d0: 6564 6765 6861 6d6d 6572 0a0a 2020 2020  edgehammer..    
-000453e0: 636f 6e76 6572 7420 746f 2070 796e 6220  convert to pynb 
-000453f0: 7669 613a 0a20 2020 2020 2020 2070 326a  via:.        p2j
-00045400: 206d 6d2e 7079 202d 6f0a 0a20 2020 2063   mm.py -o..    c
-00045410: 6f6e 7665 7274 2074 6865 2069 7079 6e62  onvert the ipynb
-00045420: 2074 6f20 6874 6d6c 2076 6961 3a0a 2020   to html via:.  
-00045430: 2020 2020 2020 6a75 7079 7465 7220 6e62        jupyter nb
-00045440: 636f 6e76 6572 7420 414e 5473 5079 4d4d  convert ANTsPyMM
-00045450: 2f74 6573 7473 2f6d 6d2e 6970 796e 6220  /tests/mm.ipynb 
-00045460: 2d2d 6578 6563 7574 6520 2d2d 746f 2068  --execute --to h
-00045470: 746d 6c0a 0a20 2020 2074 6869 7320 6675  tml..    this fu
-00045480: 6e63 7469 6f6e 2061 7373 756d 6573 204e  nction assumes N
-00045490: 5247 2066 6f72 6d61 7420 666f 7220 7468  RG format for th
-000454a0: 6520 696e 7075 7420 6461 7461 202e 2e2e  e input data ...
-000454b0: 2e0a 2020 2020 7765 2061 6c73 6f20 6173  ..    we also as
-000454c0: 7375 6d65 2074 6861 7420 7431 7720 6869  sume that t1w hi
-000454d0: 6572 6172 6368 6963 616c 2028 6966 2061  erarchical (if a
-000454e0: 6c72 6561 6479 2064 6f6e 6529 2077 6173  lready done) was
-000454f0: 2077 7269 7474 656e 0a20 2020 2076 6961   written.    via
-00045500: 2069 7473 2073 7461 6e64 6172 6469 7a65   its standardize
-00045510: 6420 7772 6974 6520 6675 6e63 7469 6f6e  d write function
-00045520: 2e0a 2020 2020 4e52 4720 3d20 6874 7470  ..    NRG = http
-00045530: 733a 2f2f 6769 7468 7562 2e63 6f6d 2f73  s://github.com/s
-00045540: 746e 6176 612f 6269 6f6d 6564 6963 616c  tnava/biomedical
-00045550: 4461 7461 4f72 6761 6e69 7a61 7469 6f6e  DataOrganization
-00045560: 0a0a 2020 2020 7468 6973 2066 756e 6374  ..    this funct
-00045570: 696f 6e20 6973 2076 6572 626f 7365 0a0a  ion is verbose..
-00045580: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-00045590: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
-000455a0: 0a0a 2020 2020 7374 7564 7969 6420 3a20  ..    studyid : 
-000455b0: 6d75 7374 2068 6176 6520 636f 6c75 6d6e  must have column
-000455c0: 7320 312e 2073 7562 6a65 6374 4944 2032  s 1. subjectID 2
-000455d0: 2e20 6461 7465 2028 696e 2066 6f72 6d20  . date (in form 
-000455e0: 3230 3232 3032 3238 2920 616e 6420 332e  20220228) and 3.
-000455f0: 2069 6d61 6765 4944 0a20 2020 2020 2020   imageID.       
-00045600: 206f 7468 6572 2072 656c 6576 616e 7420   other relevant 
-00045610: 636f 6c75 6d6e 7320 696e 636c 7564 6520  columns include 
-00045620: 6e6d 6964 312d 3130 2c20 7273 6669 6431  nmid1-10, rsfid1
-00045630: 2c20 7273 6669 6432 2c20 6474 6964 312c  , rsfid2, dtid1,
-00045640: 2064 7469 6432 2c20 666c 6169 7269 643b   dtid2, flairid;
-00045650: 0a20 2020 2020 2020 2074 6865 7365 2070  .        these p
-00045660: 726f 7669 6465 2075 6e69 7175 6520 696d  rovide unique im
-00045670: 6167 6520 4944 7320 666f 7220 7468 6573  age IDs for thes
-00045680: 6520 6d6f 6461 6c69 7469 6573 3a20 6e6d  e modalities: nm
-00045690: 3d6e 6575 726f 6d65 6c61 6e69 6e2c 2064  =neuromelanin, d
-000456a0: 7469 3d64 6966 6675 7369 6f6e 2074 656e  ti=diffusion ten
-000456b0: 736f 722c 0a20 2020 2020 2020 2072 7366  sor,.        rsf
-000456c0: 3d72 6573 7469 6e67 2073 7461 7465 2066  =resting state f
-000456d0: 6d72 692c 2066 6c61 6972 3d54 3246 6c61  mri, flair=T2Fla
-000456e0: 6972 2e20 206e 6f6e 6520 6f66 2074 6865  ir.  none of the
-000456f0: 7365 2061 7265 2072 6571 7569 7265 642e  se are required.
-00045700: 206f 6e6c 790a 2020 2020 2020 2020 7431   only.        t1
-00045710: 2069 7320 7265 7175 6972 6564 2e20 2072   is required.  r
-00045720: 7366 6964 312f 7273 6669 6432 2077 696c  sfid1/rsfid2 wil
-00045730: 6c20 6265 2070 726f 6365 7373 6564 206a  l be processed j
-00045740: 6f69 6e74 6c79 2e20 7361 6d65 2066 6f72  ointly. same for
-00045750: 2064 7469 6431 2f64 7469 6432 2061 6e64   dtid1/dtid2 and
-00045760: 206e 6d69 642a 2e20 2073 6565 2061 6e74   nmid*.  see ant
-00045770: 7370 796d 6d2e 6765 6e65 7261 7465 5f6d  spymm.generate_m
-00045780: 6d5f 6461 7461 6672 616d 650a 0a20 2020  m_dataframe..   
-00045790: 2073 6f75 7263 6564 6972 203a 2061 2073   sourcedir : a s
-000457a0: 7475 6479 2073 7065 6369 6669 6320 666f  tudy specific fo
-000457b0: 6c64 6572 2063 6f6e 7461 696e 696e 6720  lder containing 
-000457c0: 696e 6469 7669 6475 616c 2073 7562 6a65  individual subje
-000457d0: 6374 2066 6f6c 6465 7273 0a0a 2020 2020  ct folders..    
-000457e0: 736f 7572 6365 6461 7461 666f 6c64 6572  sourcedatafolder
-000457f0: 6e61 6d65 203a 2072 6f6f 7420 666f 7220  name : root for 
-00045800: 736f 7572 6365 2064 6174 6120 652e 672e  source data e.g.
-00045810: 2022 696d 6167 6573 220a 0a20 2020 2070   "images"..    p
-00045820: 726f 6365 7373 4469 7220 3a20 7768 6572  rocessDir : wher
-00045830: 6520 6f75 7470 7574 2077 696c 6c20 676f  e output will go
-00045840: 202d 2070 6172 616c 6c65 6c20 746f 2073   - parallel to s
-00045850: 6f75 7263 6564 6174 6166 6f6c 6465 726e  ourcedatafoldern
-00045860: 616d 6520 652e 672e 0a20 2020 2020 2020  ame e.g..       
-00045870: 2022 7072 6f63 6573 7365 6422 0a0a 2020   "processed"..  
-00045880: 2020 6d79 7365 7020 3a20 6465 6669 6e65    mysep : define
-00045890: 2061 2063 6861 7261 6374 6572 2073 6570   a character sep
-000458a0: 6172 6174 6f72 2066 6f72 2066 696c 656e  arator for filen
-000458b0: 616d 6520 636f 6d70 6f6e 656e 7473 0a0a  ame components..
-000458c0: 2020 2020 7372 6d6f 6465 6c5f 5431 203a      srmodel_T1 :
-000458d0: 2046 616c 7365 2028 6465 6661 756c 7429   False (default)
-000458e0: 202d 2077 696c 6c20 6164 6420 6120 6772   - will add a gr
-000458f0: 6561 7420 6465 616c 206f 6620 7469 6d65  eat deal of time
-00045900: 202d 206f 7220 6835 2066 696c 656e 616d   - or h5 filenam
-00045910: 652c 2032 2063 6861 6e0a 0a20 2020 2073  e, 2 chan..    s
-00045920: 726d 6f64 656c 5f4e 4d20 3a20 4661 6c73  rmodel_NM : Fals
-00045930: 6520 2864 6566 6175 6c74 2920 2d20 7769  e (default) - wi
-00045940: 6c6c 2061 6464 2061 2067 7265 6174 2064  ll add a great d
-00045950: 6561 6c20 6f66 2074 696d 6520 2d20 6f72  eal of time - or
-00045960: 2068 3520 6669 6c65 6e61 6d65 2c20 3120   h5 filename, 1 
-00045970: 6368 616e 0a0a 2020 2020 7372 6d6f 6465  chan..    srmode
-00045980: 6c5f 4454 4920 3a20 4661 6c73 6520 2864  l_DTI : False (d
-00045990: 6566 6175 6c74 2920 2d20 7769 6c6c 2061  efault) - will a
-000459a0: 6464 2061 2067 7265 6174 2064 6561 6c20  dd a great deal 
-000459b0: 6f66 2074 696d 6520 2d20 6f72 2068 3520  of time - or h5 
-000459c0: 6669 6c65 6e61 6d65 2c20 3120 6368 616e  filename, 1 chan
-000459d0: 0a0a 2020 2020 7669 7375 616c 697a 6520  ..    visualize 
-000459e0: 3a20 5472 7565 202d 2077 696c 6c20 706c  : True - will pl
-000459f0: 6f74 2073 6f6d 6520 7265 7375 6c74 7320  ot some results 
-00045a00: 746f 2070 6e67 0a0a 2020 2020 6e72 675f  to png..    nrg_
-00045a10: 6d6f 6461 6c69 7479 5f6c 6973 7420 3a20  modality_list : 
-00045a20: 6c69 7374 206f 6620 7065 726d 6973 7369  list of permissi
-00045a30: 626c 6520 6d6f 6461 6c69 7469 6573 202d  ble modalities -
-00045a40: 2061 6c77 6179 7320 696e 636c 7564 6520   always include 
-00045a50: 5b54 3177 5d20 6173 2062 6173 650a 0a20  [T1w] as base.. 
-00045a60: 2020 2076 6572 626f 7365 203a 2062 6f6f     verbose : boo
-00045a70: 6c65 616e 0a0a 2020 2020 5265 7475 726e  lean..    Return
-00045a80: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d0a  s.    ---------.
-00045a90: 0a20 2020 2077 7269 7465 7320 6f75 7470  .    writes outp
-00045aa0: 7574 2074 6f20 6469 736b 2061 6e64 2070  ut to disk and p
-00045ab0: 6f74 656e 7469 616c 6c79 2070 726f 6475  otentially produ
-00045ac0: 6365 7320 6669 6775 7265 7320 7468 6174  ces figures that
-00045ad0: 206d 6179 2062 650a 2020 2020 6361 7074   may be.    capt
-00045ae0: 7572 6564 2069 6e20 6120 6970 796e 6220  ured in a ipynb 
-00045af0: 2f20 6874 6d6c 2066 696c 652e 0a0a 2020  / html file...  
-00045b00: 2020 2222 220a 2020 2020 7374 7564 7969    """.    studyi
-00045b10: 6420 3d20 7374 7564 7969 642e 6472 6f70  d = studyid.drop
-00045b20: 6e61 2861 7869 733d 3129 0a20 2020 2069  na(axis=1).    i
-00045b30: 6620 7374 7564 7969 642e 7368 6170 655b  f studyid.shape[
-00045b40: 305d 203c 2031 3a0a 2020 2020 2020 2020  0] < 1:.        
-00045b50: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00045b60: 2827 7374 7564 7969 6420 6861 7320 6e6f  ('studyid has no
-00045b70: 2072 6f77 7327 290a 2020 2020 6d75 7374   rows').    must
-00045b80: 6861 7665 636f 6c73 203d 205b 2773 7562  havecols = ['sub
-00045b90: 6a65 6374 4944 272c 2764 6174 6527 2c27  jectID','date','
-00045ba0: 696d 6167 6549 4427 5d0a 2020 2020 666f  imageID'].    fo
-00045bb0: 7220 6b20 696e 2072 616e 6765 286c 656e  r k in range(len
-00045bc0: 286d 7573 7468 6176 6563 6f6c 7329 293a  (musthavecols)):
-00045bd0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00045be0: 6d75 7374 6861 7665 636f 6c73 5b6b 5d20  musthavecols[k] 
-00045bf0: 696e 2073 7475 6479 6964 2e6b 6579 7328  in studyid.keys(
-00045c00: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00045c10: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00045c20: 2773 7475 6479 6964 2069 7320 6d69 7373  'studyid is miss
-00045c30: 696e 6720 636f 6c75 6d6e 2027 202b 6d75  ing column ' +mu
-00045c40: 7374 6861 7665 636f 6c73 5b6b 5d20 290a  sthavecols[k] ).
-00045c50: 2020 2020 6465 6620 6d61 6b65 7769 6465      def makewide
-00045c60: 6f75 7428 2078 2c20 7365 7061 7261 746f  out( x, separato
-00045c70: 7220 3d20 272d 2720 293a 0a20 2020 2020  r = '-' ):.     
-00045c80: 2020 2072 6574 7572 6e20 7820 2b20 7365     return x + se
-00045c90: 7061 7261 746f 7220 2b20 276d 6d77 6964  parator + 'mmwid
-00045ca0: 652e 6373 7627 0a20 2020 2069 6620 6e72  e.csv'.    if nr
-00045cb0: 675f 6d6f 6461 6c69 7479 5f6c 6973 745b  g_modality_list[
-00045cc0: 305d 2021 3d20 2754 3177 273a 0a20 2020  0] != 'T1w':.   
-00045cd0: 2020 2020 206e 7267 5f6d 6f64 616c 6974       nrg_modalit
-00045ce0: 795f 6c69 7374 2e69 6e73 6572 7428 302c  y_list.insert(0,
-00045cf0: 2022 5431 7722 2029 0a20 2020 2074 6573   "T1w" ).    tes
-00045d00: 746c 6f6f 7020 3d20 4661 6c73 650a 2020  tloop = False.  
-00045d10: 2020 636f 756e 7465 723d 300a 2020 2020    counter=0.    
-00045d20: 696d 706f 7274 2067 6c6f 6220 6173 2067  import glob as g
-00045d30: 6c6f 620a 2020 2020 6672 6f6d 206f 732e  lob.    from os.
-00045d40: 7061 7468 2069 6d70 6f72 7420 6578 6973  path import exis
-00045d50: 7473 0a20 2020 2065 785f 7061 7468 203d  ts.    ex_path =
-00045d60: 206f 732e 7061 7468 2e65 7870 616e 6475   os.path.expandu
-00045d70: 7365 7228 2022 7e2f 2e61 6e74 7370 7974  ser( "~/.antspyt
-00045d80: 3177 2f22 2029 0a20 2020 2065 785f 7061  1w/" ).    ex_pa
-00045d90: 7468 6d6d 203d 206f 732e 7061 7468 2e65  thmm = os.path.e
-00045da0: 7870 616e 6475 7365 7228 2022 7e2f 2e61  xpanduser( "~/.a
-00045db0: 6e74 7370 796d 6d2f 2220 290a 2020 2020  ntspymm/" ).    
-00045dc0: 7465 6d70 6c61 7465 666e 203d 2065 785f  templatefn = ex_
-00045dd0: 7061 7468 202b 2027 4349 5431 3638 5f54  path + 'CIT168_T
-00045de0: 3177 5f37 3030 756d 5f70 6164 5f61 646e  1w_700um_pad_adn
-00045df0: 692e 6e69 692e 677a 270a 2020 2020 6966  i.nii.gz'.    if
-00045e00: 206e 6f74 2065 7869 7374 7328 2074 656d   not exists( tem
-00045e10: 706c 6174 6566 6e20 293a 0a20 2020 2020  platefn ):.     
-00045e20: 2020 2070 7269 6e74 2820 222a 2a6d 6973     print( "**mis
-00045e30: 7369 6e67 2066 696c 6573 2a2a 203d 3e20  sing files** => 
-00045e40: 6361 6c6c 2067 6574 5f64 6174 6120 6672  call get_data fr
-00045e50: 6f6d 206c 6174 6573 7420 616e 7473 7079  om latest antspy
-00045e60: 7431 7720 616e 6420 616e 7473 7079 6d6d  t1w and antspymm
-00045e70: 2e22 2029 0a20 2020 2020 2020 2061 6e74  ." ).        ant
-00045e80: 7370 7974 3177 2e67 6574 5f64 6174 6128  spyt1w.get_data(
-00045e90: 2066 6f72 6365 5f64 6f77 6e6c 6f61 643d   force_download=
-00045ea0: 5472 7565 2029 0a20 2020 2020 2020 2067  True ).        g
-00045eb0: 6574 5f64 6174 6128 2066 6f72 6365 5f64  et_data( force_d
-00045ec0: 6f77 6e6c 6f61 643d 5472 7565 2029 0a20  ownload=True ). 
-00045ed0: 2020 2074 656d 7020 3d20 736f 7572 6365     temp = source
-00045ee0: 6469 722e 7370 6c69 7428 2022 2f22 2029  dir.split( "/" )
-00045ef0: 0a20 2020 2073 706c 6974 436f 756e 7420  .    splitCount 
-00045f00: 3d20 6c65 6e28 2074 656d 7020 290a 2020  = len( temp ).  
-00045f10: 2020 7465 6d70 6c61 7465 203d 206d 6d5f    template = mm_
-00045f20: 7265 6164 2820 7465 6d70 6c61 7465 666e  read( templatefn
-00045f30: 2029 2023 2052 6561 6420 696e 2074 656d   ) # Read in tem
-00045f40: 706c 6174 650a 2020 2020 7465 7374 5f72  plate.    test_r
-00045f50: 756e 203d 2046 616c 7365 0a20 2020 2069  un = False.    i
-00045f60: 6620 7465 7374 5f72 756e 3a0a 2020 2020  f test_run:.    
-00045f70: 2020 2020 7669 7375 616c 697a 653d 4661      visualize=Fa
-00045f80: 6c73 650a 2020 2020 2320 6765 7420 7369  lse.    # get si
-00045f90: 6420 616e 6420 6474 6964 2066 726f 6d20  d and dtid from 
-00045fa0: 7374 7564 7969 640a 2020 2020 7369 6420  studyid.    sid 
-00045fb0: 3d20 7374 7228 7374 7564 7969 645b 2773  = str(studyid['s
-00045fc0: 7562 6a65 6374 4944 275d 2e69 6c6f 635b  ubjectID'].iloc[
-00045fd0: 305d 290a 2020 2020 6474 6964 203d 2073  0]).    dtid = s
-00045fe0: 7472 2873 7475 6479 6964 5b27 6461 7465  tr(studyid['date
-00045ff0: 275d 2e69 6c6f 635b 305d 290a 2020 2020  '].iloc[0]).    
-00046000: 6969 6420 3d20 7374 7228 7374 7564 7969  iid = str(studyi
-00046010: 645b 2769 6d61 6765 4944 275d 2e69 6c6f  d['imageID'].ilo
-00046020: 635b 305d 290a 2020 2020 7375 626a 6563  c[0]).    subjec
-00046030: 7472 6f6f 7470 6174 6820 3d20 6f73 2e70  trootpath = os.p
-00046040: 6174 682e 6a6f 696e 2873 6f75 7263 6564  ath.join(sourced
-00046050: 6972 2c73 6964 2c20 6474 6964 290a 2020  ir,sid, dtid).  
-00046060: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-00046070: 2020 2020 2020 7072 696e 7428 2273 7562        print("sub
-00046080: 6a65 6374 726f 6f74 7061 7468 3a20 222b  jectrootpath: "+
-00046090: 2073 7562 6a65 6374 726f 6f74 7061 7468   subjectrootpath
-000460a0: 2029 0a20 2020 206d 7969 6d67 7349 6e70   ).    myimgsInp
-000460b0: 7574 203d 2067 6c6f 622e 676c 6f62 2820  ut = glob.glob( 
-000460c0: 7375 626a 6563 7472 6f6f 7470 6174 682b  subjectrootpath+
-000460d0: 222f 2a22 2029 0a20 2020 206d 7969 6d67  "/*" ).    myimg
-000460e0: 7349 6e70 7574 2e73 6f72 7428 2029 0a20  sInput.sort( ). 
-000460f0: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
-00046100: 2020 2020 2020 2070 7269 6e74 2820 6d79         print( my
-00046110: 696d 6773 496e 7075 7420 290a 2020 2020  imgsInput ).    
-00046120: 2320 6869 6572 6172 6368 6963 616c 0a20  # hierarchical. 
-00046130: 2020 2023 204e 4f54 453a 2069 6620 7468     # NOTE: if th
-00046140: 6572 6520 6172 6520 6d75 6c74 6970 6c65  ere are multiple
-00046150: 2054 3173 2066 6f72 2074 6869 7320 7469   T1s for this ti
-00046160: 6d65 2070 6f69 6e74 2c20 7368 6f75 6c64  me point, should
-00046170: 2074 616b 650a 2020 2020 2320 7468 6520   take.    # the 
-00046180: 6f6e 6520 7769 7468 2074 6865 2068 6967  one with the hig
-00046190: 6865 7374 2072 6573 6e65 7447 7261 6465  hest resnetGrade
-000461a0: 0a20 2020 2074 315f 7365 6172 6368 5f70  .    t1_search_p
-000461b0: 6174 6820 3d20 6f73 2e70 6174 682e 6a6f  ath = os.path.jo
-000461c0: 696e 2873 7562 6a65 6374 726f 6f74 7061  in(subjectrootpa
-000461d0: 7468 2c20 2254 3177 222c 2069 6964 2c20  th, "T1w", iid, 
-000461e0: 222a 6e69 692e 677a 2229 0a20 2020 2069  "*nii.gz").    i
-000461f0: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-00046200: 2020 2070 7269 6e74 2866 2274 3120 7365     print(f"t1 se
-00046210: 6172 6368 2070 6174 683a 207b 7431 5f73  arch path: {t1_s
-00046220: 6561 7263 685f 7061 7468 7d22 290a 2020  earch_path}").  
-00046230: 2020 7431 666e 203d 2067 6c6f 622e 676c    t1fn = glob.gl
-00046240: 6f62 2874 315f 7365 6172 6368 5f70 6174  ob(t1_search_pat
-00046250: 6829 0a20 2020 2074 3166 6e2e 736f 7274  h).    t1fn.sort
-00046260: 2829 0a20 2020 2069 6620 6c65 6e28 2074  ().    if len( t
-00046270: 3166 6e20 2920 3c20 313a 0a20 2020 2020  1fn ) < 1:.     
-00046280: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00046290: 726f 7228 276d 6d5f 6e72 6720 6361 6e6e  ror('mm_nrg cann
-000462a0: 6f74 2066 696e 6420 7468 6520 5431 7720  ot find the T1w 
-000462b0: 7769 7468 2075 6964 2027 202b 2069 6964  with uid ' + iid
-000462c0: 202b 2027 2040 2027 202b 2073 7562 6a65   + ' @ ' + subje
-000462d0: 6374 726f 6f74 7061 7468 2029 0a20 2020  ctrootpath ).   
-000462e0: 2074 3166 6e20 3d20 7431 666e 5b30 5d0a   t1fn = t1fn[0].
-000462f0: 2020 2020 7431 203d 206d 6d5f 7265 6164      t1 = mm_read
-00046300: 2820 7431 666e 2029 0a20 2020 2068 6965  ( t1fn ).    hie
-00046310: 7266 6e30 203d 2072 652e 7375 6228 2073  rfn0 = re.sub( s
-00046320: 6f75 7263 6564 6174 6166 6f6c 6465 726e  ourcedatafoldern
-00046330: 616d 652c 2070 726f 6365 7373 4469 722c  ame, processDir,
-00046340: 2074 3166 6e29 0a20 2020 2068 6965 7266   t1fn).    hierf
-00046350: 6e30 203d 2072 652e 7375 6228 2022 2e6e  n0 = re.sub( ".n
-00046360: 6969 2e67 7a22 2c20 2222 2c20 6869 6572  ii.gz", "", hier
-00046370: 666e 3029 0a20 2020 2068 6965 7266 6e20  fn0).    hierfn 
-00046380: 3d20 7265 2e73 7562 2820 2254 3177 222c  = re.sub( "T1w",
-00046390: 2022 5431 7748 6965 7261 7263 6869 6361   "T1wHierarchica
-000463a0: 6c22 2c20 6869 6572 666e 3029 0a20 2020  l", hierfn0).   
-000463b0: 2068 6965 7266 6e20 3d20 6869 6572 666e   hierfn = hierfn
-000463c0: 202b 206d 7973 6570 0a20 2020 2068 6965   + mysep.    hie
-000463d0: 7266 6e74 6573 7420 3d20 6869 6572 666e  rfntest = hierfn
-000463e0: 202b 2027 736e 7365 672e 6373 7627 0a20   + 'snseg.csv'. 
-000463f0: 2020 2072 6567 6f75 7420 3d20 6869 6572     regout = hier
-00046400: 666e 3020 2b20 6d79 7365 7020 2b20 2273  fn0 + mysep + "s
-00046410: 796e 220a 2020 2020 7465 6d70 6c61 7465  yn".    template
-00046420: 5478 203d 207b 0a20 2020 2020 2020 2027  Tx = {.        '
-00046430: 6677 6474 7261 6e73 666f 726d 7327 3a20  fwdtransforms': 
-00046440: 5b20 7265 676f 7574 2b27 3157 6172 702e  [ regout+'1Warp.
-00046450: 6e69 692e 677a 272c 2072 6567 6f75 742b  nii.gz', regout+
-00046460: 2730 4765 6e65 7269 6341 6666 696e 652e  '0GenericAffine.
-00046470: 6d61 7427 5d2c 0a20 2020 2020 2020 2027  mat'],.        '
-00046480: 696e 7674 7261 6e73 666f 726d 7327 3a20  invtransforms': 
-00046490: 5b20 7265 676f 7574 2b27 3047 656e 6572  [ regout+'0Gener
-000464a0: 6963 4166 6669 6e65 2e6d 6174 272c 2072  icAffine.mat', r
-000464b0: 6567 6f75 742b 2731 496e 7665 7273 6557  egout+'1InverseW
-000464c0: 6172 702e 6e69 692e 677a 275d 2020 7d0a  arp.nii.gz']  }.
-000464d0: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
-000464e0: 2020 2020 2020 2020 7072 696e 7428 2022          print( "
-000464f0: 2d3c 5245 4749 5354 5241 5449 4f4e 2045  -<REGISTRATION E
-00046500: 5849 5354 454e 4345 3e2d 3a20 5c6e 2220  XISTENCE>-: \n" 
-00046510: 2b20 0a20 2020 2020 2020 2020 2020 2020  + .             
-00046520: 2022 4e41 4d49 4e47 3a20 2220 2b20 7265   "NAMING: " + re
-00046530: 676f 7574 2b27 3047 656e 6572 6963 4166  gout+'0GenericAf
-00046540: 6669 6e65 2e6d 6174 2720 2b20 2220 5c6e  fine.mat' + " \n
-00046550: 2022 202b 0a20 2020 2020 2020 2020 2020   " +.           
-00046560: 2073 7472 2865 7869 7374 7328 2074 656d   str(exists( tem
-00046570: 706c 6174 6554 785b 2766 7764 7472 616e  plateTx['fwdtran
-00046580: 7366 6f72 6d73 275d 5b30 5d29 2920 2b20  sforms'][0])) + 
-00046590: 2220 2220 2b0a 2020 2020 2020 2020 2020  " " +.          
-000465a0: 2020 7374 7228 6578 6973 7473 2820 7465    str(exists( te
-000465b0: 6d70 6c61 7465 5478 5b27 6677 6474 7261  mplateTx['fwdtra
-000465c0: 6e73 666f 726d 7327 5d5b 315d 2929 202b  nsforms'][1])) +
-000465d0: 2022 2022 202b 0a20 2020 2020 2020 2020   " " +.         
-000465e0: 2020 2073 7472 2865 7869 7374 7328 2074     str(exists( t
-000465f0: 656d 706c 6174 6554 785b 2769 6e76 7472  emplateTx['invtr
-00046600: 616e 7366 6f72 6d73 275d 5b30 5d29 2920  ansforms'][0])) 
-00046610: 2b20 2220 2220 2b0a 2020 2020 2020 2020  + " " +.        
-00046620: 2020 2020 7374 7228 6578 6973 7473 2820      str(exists( 
-00046630: 7465 6d70 6c61 7465 5478 5b27 696e 7674  templateTx['invt
-00046640: 7261 6e73 666f 726d 7327 5d5b 315d 2929  ransforms'][1]))
-00046650: 2029 0a20 2020 2069 6620 7665 7262 6f73   ).    if verbos
-00046660: 653a 0a20 2020 2020 2020 2070 7269 6e74  e:.        print
-00046670: 2820 6869 6572 666e 7465 7374 2029 0a20  ( hierfntest ). 
-00046680: 2020 2068 6965 7265 7869 7374 7320 3d20     hierexists = 
-00046690: 6578 6973 7473 2820 6869 6572 666e 7465  exists( hierfnte
-000466a0: 7374 2029 2023 2046 4958 4d45 2073 686f  st ) # FIXME sho
-000466b0: 756c 6420 7465 7374 2074 6869 7320 6578  uld test this ex
-000466c0: 706c 6963 6974 6c79 2062 7574 2077 6520  plicitly but we 
-000466d0: 6173 7375 6d65 2069 7420 6865 7265 0a20  assume it here. 
-000466e0: 2020 2068 6965 7220 3d20 4e6f 6e65 0a20     hier = None. 
-000466f0: 2020 2069 6620 6e6f 7420 6869 6572 6578     if not hierex
-00046700: 6973 7473 2061 6e64 206e 6f74 2074 6573  ists and not tes
-00046710: 746c 6f6f 703a 0a20 2020 2020 2020 2073  tloop:.        s
-00046720: 7562 6a65 6374 7072 6f70 6174 6820 3d20  ubjectpropath = 
-00046730: 6f73 2e70 6174 682e 6469 726e 616d 6528  os.path.dirname(
-00046740: 2068 6965 7266 6e20 290a 2020 2020 2020   hierfn ).      
-00046750: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-00046760: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00046770: 2073 7562 6a65 6374 7072 6f70 6174 6820   subjectpropath 
-00046780: 290a 2020 2020 2020 2020 6f73 2e6d 616b  ).        os.mak
-00046790: 6564 6972 7328 2073 7562 6a65 6374 7072  edirs( subjectpr
-000467a0: 6f70 6174 682c 2065 7869 7374 5f6f 6b3d  opath, exist_ok=
-000467b0: 5472 7565 2020 290a 2020 2020 2020 2020  True  ).        
-000467c0: 6869 6572 203d 2061 6e74 7370 7974 3177  hier = antspyt1w
-000467d0: 2e68 6965 7261 7263 6869 6361 6c28 2074  .hierarchical( t
-000467e0: 312c 2068 6965 7266 6e2c 206c 6162 656c  1, hierfn, label
-000467f0: 735f 746f 5f72 6567 6973 7465 723d 4e6f  s_to_register=No
-00046800: 6e65 2029 0a20 2020 2020 2020 2061 6e74  ne ).        ant
-00046810: 7370 7974 3177 2e77 7269 7465 5f68 6965  spyt1w.write_hie
-00046820: 7261 7263 6869 6361 6c28 2068 6965 722c  rarchical( hier,
-00046830: 2068 6965 7266 6e20 290a 2020 2020 2020   hierfn ).      
-00046840: 2020 7431 7769 6465 203d 2061 6e74 7370    t1wide = antsp
-00046850: 7974 3177 2e6d 6572 6765 5f68 6965 7261  yt1w.merge_hiera
-00046860: 7263 6869 6361 6c5f 6373 7673 5f74 6f5f  rchical_csvs_to_
-00046870: 7769 6465 5f66 6f72 6d61 7428 0a20 2020  wide_format(.   
-00046880: 2020 2020 2020 2020 2020 2020 2068 6965               hie
-00046890: 725b 2764 6174 6166 7261 6d65 7327 5d2c  r['dataframes'],
-000468a0: 2069 6465 6e74 6966 6965 723d 4e6f 6e65   identifier=None
-000468b0: 2029 0a20 2020 2020 2020 2074 3177 6964   ).        t1wid
-000468c0: 652e 746f 5f63 7376 2820 6869 6572 666e  e.to_csv( hierfn
-000468d0: 202b 2027 6d6d 7769 6465 2e63 7376 2720   + 'mmwide.csv' 
-000468e0: 290a 2020 2020 2323 2323 2323 2323 2323  ).    ##########
-000468f0: 2323 2323 2323 2320 7265 6164 2074 6865  ####### read the
-00046900: 2068 6965 7261 7263 6869 6361 6c20 6461   hierarchical da
-00046910: 7461 2023 2323 2323 2323 2323 2323 2323  ta #############
-00046920: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00046930: 2323 0a20 2020 2068 6965 7220 3d20 616e  ##.    hier = an
-00046940: 7473 7079 7431 772e 7265 6164 5f68 6965  tspyt1w.read_hie
-00046950: 7261 7263 6869 6361 6c28 2068 6965 7266  rarchical( hierf
-00046960: 6e20 290a 2020 2020 6966 2065 7869 7374  n ).    if exist
-00046970: 7328 2068 6965 7266 6e20 2b20 276d 6d77  s( hierfn + 'mmw
-00046980: 6964 652e 6373 7627 2029 203a 0a20 2020  ide.csv' ) :.   
-00046990: 2020 2020 2074 3177 6964 6520 3d20 7064       t1wide = pd
-000469a0: 2e72 6561 645f 6373 7628 2068 6965 7266  .read_csv( hierf
-000469b0: 6e20 2b20 276d 6d77 6964 652e 6373 7627  n + 'mmwide.csv'
-000469c0: 2029 0a20 2020 2065 6c69 6620 6e6f 7420   ).    elif not 
-000469d0: 7465 7374 6c6f 6f70 3a0a 2020 2020 2020  testloop:.      
-000469e0: 2020 7431 7769 6465 203d 2061 6e74 7370    t1wide = antsp
-000469f0: 7974 3177 2e6d 6572 6765 5f68 6965 7261  yt1w.merge_hiera
-00046a00: 7263 6869 6361 6c5f 6373 7673 5f74 6f5f  rchical_csvs_to_
-00046a10: 7769 6465 5f66 6f72 6d61 7428 0a20 2020  wide_format(.   
-00046a20: 2020 2020 2020 2020 2020 2020 2068 6965               hie
-00046a30: 725b 2764 6174 6166 7261 6d65 7327 5d2c  r['dataframes'],
-00046a40: 2069 6465 6e74 6966 6965 723d 4e6f 6e65   identifier=None
-00046a50: 2029 0a20 2020 2069 6620 7372 6d6f 6465   ).    if srmode
-00046a60: 6c5f 5431 2069 7320 6e6f 7420 4661 6c73  l_T1 is not Fals
-00046a70: 6520 3a0a 2020 2020 2020 2020 6869 6572  e :.        hier
-00046a80: 666e 5352 203d 2072 652e 7375 6228 2073  fnSR = re.sub( s
-00046a90: 6f75 7263 6564 6174 6166 6f6c 6465 726e  ourcedatafoldern
-00046aa0: 616d 652c 2070 726f 6365 7373 4469 722c  ame, processDir,
-00046ab0: 2074 3166 6e29 0a20 2020 2020 2020 2068   t1fn).        h
-00046ac0: 6965 7266 6e53 5220 3d20 7265 2e73 7562  ierfnSR = re.sub
-00046ad0: 2820 2254 3177 222c 2022 5431 7748 6965  ( "T1w", "T1wHie
-00046ae0: 7261 7263 6869 6361 6c53 5222 2c20 6869  rarchicalSR", hi
-00046af0: 6572 666e 5352 290a 2020 2020 2020 2020  erfnSR).        
-00046b00: 6869 6572 666e 5352 203d 2072 652e 7375  hierfnSR = re.su
-00046b10: 6228 2022 2e6e 6969 2e67 7a22 2c20 2222  b( ".nii.gz", ""
-00046b20: 2c20 6869 6572 666e 5352 290a 2020 2020  , hierfnSR).    
-00046b30: 2020 2020 6869 6572 666e 5352 203d 2068      hierfnSR = h
-00046b40: 6965 7266 6e53 5220 2b20 6d79 7365 700a  ierfnSR + mysep.
-00046b50: 2020 2020 2020 2020 6869 6572 666e 7465          hierfnte
-00046b60: 7374 203d 2068 6965 7266 6e53 5220 2b20  st = hierfnSR + 
-00046b70: 276d 746c 2e63 7376 270a 2020 2020 2020  'mtl.csv'.      
-00046b80: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-00046b90: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00046ba0: 2068 6965 7266 6e74 6573 7420 290a 2020   hierfntest ).  
-00046bb0: 2020 2020 2020 6869 6572 6578 6973 7473        hierexists
-00046bc0: 203d 2065 7869 7374 7328 2068 6965 7266   = exists( hierf
-00046bd0: 6e74 6573 7420 2920 2320 4649 584d 4520  ntest ) # FIXME 
-00046be0: 7368 6f75 6c64 2074 6573 7420 7468 6973  should test this
-00046bf0: 2065 7870 6c69 6369 746c 7920 6275 7420   explicitly but 
-00046c00: 7765 2061 7373 756d 6520 6974 2068 6572  we assume it her
-00046c10: 650a 2020 2020 2020 2020 6966 206e 6f74  e.        if not
-00046c20: 2068 6965 7265 7869 7374 733a 0a20 2020   hierexists:.   
-00046c30: 2020 2020 2020 2020 2073 7562 6a65 6374           subject
-00046c40: 7072 6f70 6174 6820 3d20 6f73 2e70 6174  propath = os.pat
-00046c50: 682e 6469 726e 616d 6528 2068 6965 7266  h.dirname( hierf
-00046c60: 6e53 5220 290a 2020 2020 2020 2020 2020  nSR ).          
-00046c70: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-00046c80: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00046c90: 696e 7428 2073 7562 6a65 6374 7072 6f70  int( subjectprop
-00046ca0: 6174 6820 290a 2020 2020 2020 2020 2020  ath ).          
-00046cb0: 2020 6f73 2e6d 616b 6564 6972 7328 2073    os.makedirs( s
-00046cc0: 7562 6a65 6374 7072 6f70 6174 682c 2065  ubjectpropath, e
-00046cd0: 7869 7374 5f6f 6b3d 5472 7565 2020 290a  xist_ok=True  ).
-00046ce0: 2020 2020 2020 2020 2020 2020 2320 6869              # hi
-00046cf0: 6572 6172 6368 6963 616c 5f74 6f5f 7372  erarchical_to_sr
-00046d00: 2874 3168 6965 722c 2073 725f 6d6f 6465  (t1hier, sr_mode
-00046d10: 6c2c 2074 6973 7375 655f 7372 3d46 616c  l, tissue_sr=Fal
-00046d20: 7365 2c20 626c 656e 6469 6e67 3d30 2e35  se, blending=0.5
-00046d30: 2c20 7665 7262 6f73 653d 4661 6c73 6529  , verbose=False)
-00046d40: 0a20 2020 2020 2020 2020 2020 2062 6573  .            bes
-00046d50: 7475 7020 3d20 7369 712e 6f70 7469 6d69  tup = siq.optimi
-00046d60: 7a65 5f75 7073 616d 706c 696e 675f 7368  ze_upsampling_sh
-00046d70: 6170 6528 2061 6e74 732e 6765 745f 7370  ape( ants.get_sp
-00046d80: 6163 696e 6728 7431 292c 206d 6f64 616c  acing(t1), modal
-00046d90: 6974 793d 2754 3127 2029 0a20 2020 2020  ity='T1' ).     
-00046da0: 2020 2020 2020 206d 646c 666e 203d 2065         mdlfn = e
-00046db0: 785f 7061 7468 6d6d 202b 2022 7369 715f  x_pathmm + "siq_
-00046dc0: 6465 6661 756c 745f 7369 7372 5f22 202b  default_sisr_" +
-00046dd0: 2062 6573 7475 7020 2b20 225f 3263 6861   bestup + "_2cha
-00046de0: 6e5f 6665 6174 7667 674c 365f 706f 7374  n_featvggL6_post
-00046df0: 7365 675f 6265 7374 5f6d 646c 2e68 3522  seg_best_mdl.h5"
-00046e00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00046e10: 6973 696e 7374 616e 6365 2820 7372 6d6f  isinstance( srmo
-00046e20: 6465 6c5f 5431 2c20 7374 7220 293a 0a20  del_T1, str ):. 
-00046e30: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00046e40: 646c 666e 203d 206f 732e 7061 7468 2e6a  dlfn = os.path.j
-00046e50: 6f69 6e28 2065 785f 7061 7468 6d6d 2c20  oin( ex_pathmm, 
-00046e60: 7372 6d6f 6465 6c5f 5431 2029 0a20 2020  srmodel_T1 ).   
-00046e70: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
-00046e80: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-00046e90: 2020 2020 2070 7269 6e74 2820 6d64 6c66       print( mdlf
-00046ea0: 6e20 290a 2020 2020 2020 2020 2020 2020  n ).            
-00046eb0: 6966 2065 7869 7374 7328 206d 646c 666e  if exists( mdlfn
-00046ec0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-00046ed0: 2020 2020 7372 6d6f 6465 6c5f 5431 5f6d      srmodel_T1_m
-00046ee0: 646c 203d 2074 662e 6b65 7261 732e 6d6f  dl = tf.keras.mo
-00046ef0: 6465 6c73 2e6c 6f61 645f 6d6f 6465 6c28  dels.load_model(
-00046f00: 206d 646c 666e 2c20 636f 6d70 696c 653d   mdlfn, compile=
-00046f10: 4661 6c73 6520 290a 2020 2020 2020 2020  False ).        
-00046f20: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00046f30: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00046f40: 206d 646c 666e 202b 2022 2064 6f65 7320   mdlfn + " does 
-00046f50: 6e6f 7420 6578 6973 7420 2d20 7769 6c6c  not exist - will
-00046f60: 206e 6f74 2072 756e 2e22 290a 2020 2020   not run.").    
-00046f70: 2020 2020 2020 2020 6869 6572 5352 203d          hierSR =
-00046f80: 2061 6e74 7370 7974 3177 2e68 6965 7261   antspyt1w.hiera
-00046f90: 7263 6869 6361 6c5f 746f 5f73 7228 2068  rchical_to_sr( h
-00046fa0: 6965 722c 2073 726d 6f64 656c 5f54 315f  ier, srmodel_T1_
-00046fb0: 6d64 6c2c 2062 6c65 6e64 696e 673d 4e6f  mdl, blending=No
-00046fc0: 6e65 2c20 7469 7373 7565 5f73 723d 4661  ne, tissue_sr=Fa
-00046fd0: 6c73 6520 290a 2020 2020 2020 2020 2020  lse ).          
-00046fe0: 2020 616e 7473 7079 7431 772e 7772 6974    antspyt1w.writ
-00046ff0: 655f 6869 6572 6172 6368 6963 616c 2820  e_hierarchical( 
-00047000: 6869 6572 5352 2c20 6869 6572 666e 5352  hierSR, hierfnSR
-00047010: 2029 0a20 2020 2020 2020 2020 2020 2074   ).            t
-00047020: 3177 6964 6553 5220 3d20 616e 7473 7079  1wideSR = antspy
-00047030: 7431 772e 6d65 7267 655f 6869 6572 6172  t1w.merge_hierar
-00047040: 6368 6963 616c 5f63 7376 735f 746f 5f77  chical_csvs_to_w
-00047050: 6964 655f 666f 726d 6174 280a 2020 2020  ide_format(.    
-00047060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047070: 6869 6572 5352 5b27 6461 7461 6672 616d  hierSR['datafram
-00047080: 6573 275d 2c20 6964 656e 7469 6669 6572  es'], identifier
-00047090: 3d4e 6f6e 6520 290a 2020 2020 2020 2020  =None ).        
-000470a0: 2020 2020 7431 7769 6465 5352 2e74 6f5f      t1wideSR.to_
-000470b0: 6373 7628 2068 6965 7266 6e53 5220 2b20  csv( hierfnSR + 
-000470c0: 276d 6d77 6964 652e 6373 7627 2029 0a20  'mmwide.csv' ). 
-000470d0: 2020 2068 6965 7220 3d20 616e 7473 7079     hier = antspy
-000470e0: 7431 772e 7265 6164 5f68 6965 7261 7263  t1w.read_hierarc
-000470f0: 6869 6361 6c28 2068 6965 7266 6e20 290a  hical( hierfn ).
-00047100: 2020 2020 6966 2065 7869 7374 7328 2068      if exists( h
-00047110: 6965 7266 6e20 2b20 276d 6d77 6964 652e  ierfn + 'mmwide.
-00047120: 6373 7627 2029 203a 0a20 2020 2020 2020  csv' ) :.       
-00047130: 2074 3177 6964 6520 3d20 7064 2e72 6561   t1wide = pd.rea
-00047140: 645f 6373 7628 2068 6965 7266 6e20 2b20  d_csv( hierfn + 
-00047150: 276d 6d77 6964 652e 6373 7627 2029 0a20  'mmwide.csv' ). 
-00047160: 2020 2065 6c69 6620 6e6f 7420 7465 7374     elif not test
-00047170: 6c6f 6f70 3a0a 2020 2020 2020 2020 7431  loop:.        t1
-00047180: 7769 6465 203d 2061 6e74 7370 7974 3177  wide = antspyt1w
-00047190: 2e6d 6572 6765 5f68 6965 7261 7263 6869  .merge_hierarchi
-000471a0: 6361 6c5f 6373 7673 5f74 6f5f 7769 6465  cal_csvs_to_wide
-000471b0: 5f66 6f72 6d61 7428 0a20 2020 2020 2020  _format(.       
-000471c0: 2020 2020 2020 2020 2068 6965 725b 2764           hier['d
-000471d0: 6174 6166 7261 6d65 7327 5d2c 2069 6465  ataframes'], ide
-000471e0: 6e74 6966 6965 723d 4e6f 6e65 2029 0a20  ntifier=None ). 
-000471f0: 2020 2069 6620 6e6f 7420 7465 7374 6c6f     if not testlo
-00047200: 6f70 3a0a 2020 2020 2020 2020 7431 696d  op:.        t1im
-00047210: 6762 726e 203d 2068 6965 725b 2762 7261  gbrn = hier['bra
-00047220: 696e 5f6e 345f 646e 7a27 5d0a 2020 2020  in_n4_dnz'].    
-00047230: 2020 2020 7431 6174 726f 706f 7320 3d20      t1atropos = 
-00047240: 6869 6572 5b27 646b 745f 7061 7263 275d  hier['dkt_parc']
-00047250: 5b27 7469 7373 7565 5f73 6567 6d65 6e74  ['tissue_segment
-00047260: 6174 696f 6e27 5d0a 2020 2020 2320 6c6f  ation'].    # lo
-00047270: 6f70 206f 7665 7220 6d6f 6461 6c69 7469  op over modaliti
-00047280: 6573 2061 6e64 2074 6865 6e20 756e 6971  es and then uniq
-00047290: 7565 2069 6d61 6765 2049 4473 0a20 2020  ue image IDs.   
-000472a0: 2023 2077 6520 7472 6561 7420 4e4d 2069   # we treat NM i
-000472b0: 6e20 6120 2273 7065 6369 616c 2220 7761  n a "special" wa
-000472c0: 7920 2d2d 2061 6767 7265 6761 7469 6e67  y -- aggregating
-000472d0: 2072 6570 6561 7473 0a20 2020 2023 206f   repeats.    # o
-000472e0: 7468 6572 206d 6f64 616c 6974 6965 7320  ther modalities 
-000472f0: 2862 6579 6f6e 6420 5431 2920 6172 6520  (beyond T1) are 
-00047300: 7472 6561 7465 6420 696e 6469 7669 6475  treated individu
-00047310: 616c 6c79 0a20 2020 206e 696d 6167 6573  ally.    nimages
-00047320: 203d 206c 656e 286d 7969 6d67 7349 6e70   = len(myimgsInp
-00047330: 7574 290a 2020 2020 6966 2076 6572 626f  ut).    if verbo
-00047340: 7365 3a0a 2020 2020 2020 2020 7072 696e  se:.        prin
-00047350: 7428 2020 2220 7765 2068 6176 6520 3a20  t(  " we have : 
-00047360: 2220 2b20 7374 7228 6e69 6d61 6765 7329  " + str(nimages)
-00047370: 202b 2022 206d 6f64 616c 6974 6965 732e   + " modalities.
-00047380: 2229 0a20 2020 2066 6f72 206f 7665 726d  ").    for overm
-00047390: 6f64 5820 696e 206e 7267 5f6d 6f64 616c  odX in nrg_modal
-000473a0: 6974 795f 6c69 7374 3a0a 2020 2020 2020  ity_list:.      
-000473b0: 2020 636f 756e 7465 723d 636f 756e 7465    counter=counte
-000473c0: 722b 310a 2020 2020 2020 2020 6966 2063  r+1.        if c
-000473d0: 6f75 6e74 6572 203e 2028 6c65 6e28 6e72  ounter > (len(nr
-000473e0: 675f 6d6f 6461 6c69 7479 5f6c 6973 7429  g_modality_list)
-000473f0: 2b31 293a 0a20 2020 2020 2020 2020 2020  +1):.           
-00047400: 2070 7269 6e74 2822 5468 6973 2069 7320   print("This is 
-00047410: 7765 6972 642e 2022 202b 2073 7472 2863  weird. " + str(c
-00047420: 6f75 6e74 6572 2929 0a20 2020 2020 2020  ounter)).       
-00047430: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-00047440: 2020 2020 6966 206f 7665 726d 6f64 5820      if overmodX 
-00047450: 3d3d 2027 5431 7727 3a0a 2020 2020 2020  == 'T1w':.      
-00047460: 2020 2020 2020 6969 644f 7468 6572 4d6f        iidOtherMo
-00047470: 6420 3d20 6969 640a 2020 2020 2020 2020  d = iid.        
-00047480: 2020 2020 6d6f 645f 7365 6172 6368 5f70      mod_search_p
-00047490: 6174 6820 3d20 6f73 2e70 6174 682e 6a6f  ath = os.path.jo
-000474a0: 696e 2873 7562 6a65 6374 726f 6f74 7061  in(subjectrootpa
-000474b0: 7468 2c20 6f76 6572 6d6f 6458 2c20 6969  th, overmodX, ii
-000474c0: 644f 7468 6572 4d6f 642c 2022 2a6e 6969  dOtherMod, "*nii
-000474d0: 2e67 7a22 290a 2020 2020 2020 2020 2020  .gz").          
-000474e0: 2020 6d79 696d 6773 7220 3d20 676c 6f62    myimgsr = glob
-000474f0: 2e67 6c6f 6228 6d6f 645f 7365 6172 6368  .glob(mod_search
-00047500: 5f70 6174 6829 0a20 2020 2020 2020 2065  _path).        e
-00047510: 6c69 6620 6f76 6572 6d6f 6458 203d 3d20  lif overmodX == 
-00047520: 274e 4d32 444d 5427 2061 6e64 2028 276e  'NM2DMT' and ('n
-00047530: 6d69 6431 2720 696e 2073 7475 6479 6964  mid1' in studyid
-00047540: 2e6b 6579 7328 2920 293a 0a20 2020 2020  .keys() ):.     
-00047550: 2020 2020 2020 2069 6964 4f74 6865 724d         iidOtherM
-00047560: 6f64 203d 2073 7472 2820 696e 7428 7374  od = str( int(st
-00047570: 7564 7969 645b 276e 6d69 6431 275d 2e69  udyid['nmid1'].i
-00047580: 6c6f 635b 305d 2920 290a 2020 2020 2020  loc[0]) ).      
-00047590: 2020 2020 2020 6d6f 645f 7365 6172 6368        mod_search
-000475a0: 5f70 6174 6820 3d20 6f73 2e70 6174 682e  _path = os.path.
-000475b0: 6a6f 696e 2873 7562 6a65 6374 726f 6f74  join(subjectroot
-000475c0: 7061 7468 2c20 6f76 6572 6d6f 6458 2c20  path, overmodX, 
-000475d0: 6969 644f 7468 6572 4d6f 642c 2022 2a6e  iidOtherMod, "*n
-000475e0: 6969 2e67 7a22 290a 2020 2020 2020 2020  ii.gz").        
-000475f0: 2020 2020 6d79 696d 6773 7220 3d20 676c      myimgsr = gl
-00047600: 6f62 2e67 6c6f 6228 6d6f 645f 7365 6172  ob.glob(mod_sear
-00047610: 6368 5f70 6174 6829 0a20 2020 2020 2020  ch_path).       
-00047620: 2020 2020 2066 6f72 206e 6d6e 756d 2069       for nmnum i
-00047630: 6e20 7261 6e67 6528 322c 3131 293a 0a20  n range(2,11):. 
-00047640: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00047650: 6f63 6e6d 6e75 6d20 3d20 276e 6d69 6427  ocnmnum = 'nmid'
-00047660: 2b73 7472 286e 6d6e 756d 290a 2020 2020  +str(nmnum).    
-00047670: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-00047680: 6f63 6e6d 6e75 6d20 696e 2073 7475 6479  ocnmnum in study
-00047690: 6964 2e6b 6579 7328 2920 3a0a 2020 2020  id.keys() :.    
-000476a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000476b0: 6969 644f 7468 6572 4d6f 6420 3d20 7374  iidOtherMod = st
-000476c0: 7228 2069 6e74 2873 7475 6479 6964 5b6c  r( int(studyid[l
-000476d0: 6f63 6e6d 6e75 6d5d 2e69 6c6f 635b 305d  ocnmnum].iloc[0]
-000476e0: 2920 290a 2020 2020 2020 2020 2020 2020  ) ).            
-000476f0: 2020 2020 2020 2020 6d6f 645f 7365 6172          mod_sear
-00047700: 6368 5f70 6174 6820 3d20 6f73 2e70 6174  ch_path = os.pat
-00047710: 682e 6a6f 696e 2873 7562 6a65 6374 726f  h.join(subjectro
-00047720: 6f74 7061 7468 2c20 6f76 6572 6d6f 6458  otpath, overmodX
-00047730: 2c20 6969 644f 7468 6572 4d6f 642c 2022  , iidOtherMod, "
-00047740: 2a6e 6969 2e67 7a22 290a 2020 2020 2020  *nii.gz").      
-00047750: 2020 2020 2020 2020 2020 2020 2020 6d79                my
-00047760: 696d 6773 722e 6170 7065 6e64 2820 676c  imgsr.append( gl
-00047770: 6f62 2e67 6c6f 6228 6d6f 645f 7365 6172  ob.glob(mod_sear
-00047780: 6368 5f70 6174 6829 5b30 5d20 290a 2020  ch_path)[0] ).  
-00047790: 2020 2020 2020 656c 6966 2027 7273 664d        elif 'rsfM
-000477a0: 5249 2720 696e 206f 7665 726d 6f64 5820  RI' in overmodX 
-000477b0: 616e 6420 2820 2820 2772 7366 6964 3127  and ( ( 'rsfid1'
-000477c0: 2069 6e20 7374 7564 7969 642e 6b65 7973   in studyid.keys
-000477d0: 2829 2029 206f 7220 2827 7273 6669 6432  () ) or ('rsfid2
-000477e0: 2720 696e 2073 7475 6479 6964 2e6b 6579  ' in studyid.key
-000477f0: 7328 2920 2920 293a 0a20 2020 2020 2020  s() ) ):.       
-00047800: 2020 2020 206d 7969 6d67 7372 203d 205b       myimgsr = [
-00047810: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
-00047820: 2020 2772 7366 6964 3127 2069 6e20 7374    'rsfid1' in st
-00047830: 7564 7969 642e 6b65 7973 2829 3a0a 2020  udyid.keys():.  
-00047840: 2020 2020 2020 2020 2020 2020 2020 6969                ii
-00047850: 644f 7468 6572 4d6f 6420 3d20 7374 7228  dOtherMod = str(
-00047860: 2069 6e74 2873 7475 6479 6964 5b27 7273   int(studyid['rs
-00047870: 6669 6431 275d 2e69 6c6f 635b 305d 2920  fid1'].iloc[0]) 
-00047880: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00047890: 2020 6d6f 645f 7365 6172 6368 5f70 6174    mod_search_pat
-000478a0: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
-000478b0: 2873 7562 6a65 6374 726f 6f74 7061 7468  (subjectrootpath
-000478c0: 2c20 6f76 6572 6d6f 6458 2b22 2a22 2c20  , overmodX+"*", 
-000478d0: 6969 644f 7468 6572 4d6f 642c 2022 2a6e  iidOtherMod, "*n
-000478e0: 6969 2e67 7a22 290a 2020 2020 2020 2020  ii.gz").        
-000478f0: 2020 2020 2020 2020 6d79 696d 6773 722e          myimgsr.
-00047900: 6170 7065 6e64 2820 676c 6f62 2e67 6c6f  append( glob.glo
-00047910: 6228 6d6f 645f 7365 6172 6368 5f70 6174  b(mod_search_pat
-00047920: 6829 5b30 5d20 290a 2020 2020 2020 2020  h)[0] ).        
-00047930: 2020 2020 6966 2020 2772 7366 6964 3227      if  'rsfid2'
-00047940: 2069 6e20 7374 7564 7969 642e 6b65 7973   in studyid.keys
-00047950: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00047960: 2020 2020 6969 644f 7468 6572 4d6f 6420      iidOtherMod 
-00047970: 3d20 7374 7228 2069 6e74 2873 7475 6479  = str( int(study
-00047980: 6964 5b27 7273 6669 6432 275d 2e69 6c6f  id['rsfid2'].ilo
-00047990: 635b 305d 2920 290a 2020 2020 2020 2020  c[0]) ).        
-000479a0: 2020 2020 2020 2020 6d6f 645f 7365 6172          mod_sear
-000479b0: 6368 5f70 6174 6820 3d20 6f73 2e70 6174  ch_path = os.pat
-000479c0: 682e 6a6f 696e 2873 7562 6a65 6374 726f  h.join(subjectro
-000479d0: 6f74 7061 7468 2c20 6f76 6572 6d6f 6458  otpath, overmodX
-000479e0: 2b22 2a22 2c20 6969 644f 7468 6572 4d6f  +"*", iidOtherMo
-000479f0: 642c 2022 2a6e 6969 2e67 7a22 290a 2020  d, "*nii.gz").  
-00047a00: 2020 2020 2020 2020 2020 2020 2020 6d79                my
-00047a10: 696d 6773 722e 6170 7065 6e64 2820 676c  imgsr.append( gl
-00047a20: 6f62 2e67 6c6f 6228 6d6f 645f 7365 6172  ob.glob(mod_sear
-00047a30: 6368 5f70 6174 6829 5b30 5d20 290a 2020  ch_path)[0] ).  
-00047a40: 2020 2020 2020 656c 6966 2027 4454 4927        elif 'DTI'
-00047a50: 2069 6e20 6f76 6572 6d6f 6458 2061 6e64   in overmodX and
-00047a60: 2028 2020 2764 7469 6431 2720 696e 2073   (  'dtid1' in s
-00047a70: 7475 6479 6964 2e6b 6579 7328 2920 6f72  tudyid.keys() or
-00047a80: 2020 2764 7469 6432 2720 696e 2073 7475    'dtid2' in stu
-00047a90: 6479 6964 2e6b 6579 7328 2920 293a 0a20  dyid.keys() ):. 
-00047aa0: 2020 2020 2020 2020 2020 206d 7969 6d67             myimg
-00047ab0: 7372 203d 205b 5d0a 2020 2020 2020 2020  sr = [].        
-00047ac0: 2020 2020 6966 2020 2764 7469 6431 2720      if  'dtid1' 
-00047ad0: 696e 2073 7475 6479 6964 2e6b 6579 7328  in studyid.keys(
-00047ae0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00047af0: 2020 2069 6964 4f74 6865 724d 6f64 203d     iidOtherMod =
-00047b00: 2073 7472 2820 696e 7428 7374 7564 7969   str( int(studyi
-00047b10: 645b 2764 7469 6431 275d 2e69 6c6f 635b  d['dtid1'].iloc[
-00047b20: 305d 2920 290a 2020 2020 2020 2020 2020  0]) ).          
-00047b30: 2020 2020 2020 6d6f 645f 7365 6172 6368        mod_search
-00047b40: 5f70 6174 6820 3d20 6f73 2e70 6174 682e  _path = os.path.
-00047b50: 6a6f 696e 2873 7562 6a65 6374 726f 6f74  join(subjectroot
-00047b60: 7061 7468 2c20 6f76 6572 6d6f 6458 2b22  path, overmodX+"
-00047b70: 2a22 2c20 6969 644f 7468 6572 4d6f 642c  *", iidOtherMod,
-00047b80: 2022 2a6e 6969 2e67 7a22 290a 2020 2020   "*nii.gz").    
-00047b90: 2020 2020 2020 2020 2020 2020 6d79 696d              myim
-00047ba0: 6773 722e 6170 7065 6e64 2820 676c 6f62  gsr.append( glob
-00047bb0: 2e67 6c6f 6228 6d6f 645f 7365 6172 6368  .glob(mod_search
-00047bc0: 5f70 6174 6829 5b30 5d20 290a 2020 2020  _path)[0] ).    
-00047bd0: 2020 2020 2020 2020 6966 2020 2764 7469          if  'dti
-00047be0: 6432 2720 696e 2073 7475 6479 6964 2e6b  d2' in studyid.k
-00047bf0: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
-00047c00: 2020 2020 2020 2069 6964 4f74 6865 724d         iidOtherM
-00047c10: 6f64 203d 2073 7472 2820 696e 7428 7374  od = str( int(st
-00047c20: 7564 7969 645b 2764 7469 6432 275d 2e69  udyid['dtid2'].i
-00047c30: 6c6f 635b 305d 2920 290a 2020 2020 2020  loc[0]) ).      
-00047c40: 2020 2020 2020 2020 2020 6d6f 645f 7365            mod_se
-00047c50: 6172 6368 5f70 6174 6820 3d20 6f73 2e70  arch_path = os.p
-00047c60: 6174 682e 6a6f 696e 2873 7562 6a65 6374  ath.join(subject
-00047c70: 726f 6f74 7061 7468 2c20 6f76 6572 6d6f  rootpath, overmo
-00047c80: 6458 2b22 2a22 2c20 6969 644f 7468 6572  dX+"*", iidOther
-00047c90: 4d6f 642c 2022 2a6e 6969 2e67 7a22 290a  Mod, "*nii.gz").
-00047ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047cb0: 6d79 696d 6773 722e 6170 7065 6e64 2820  myimgsr.append( 
-00047cc0: 676c 6f62 2e67 6c6f 6228 6d6f 645f 7365  glob.glob(mod_se
-00047cd0: 6172 6368 5f70 6174 6829 5b30 5d20 290a  arch_path)[0] ).
-00047ce0: 2020 2020 2020 2020 656c 6966 2027 5432          elif 'T2
-00047cf0: 466c 6169 7227 2069 6e20 6f76 6572 6d6f  Flair' in overmo
-00047d00: 6458 2061 6e64 2028 2766 6c61 6972 6964  dX and ('flairid
-00047d10: 2720 696e 2073 7475 6479 6964 2e6b 6579  ' in studyid.key
-00047d20: 7328 2920 293a 0a20 2020 2020 2020 2020  s() ):.         
-00047d30: 2020 2069 6964 4f74 6865 724d 6f64 203d     iidOtherMod =
-00047d40: 2073 7472 2820 696e 7428 7374 7564 7969   str( int(studyi
-00047d50: 645b 2766 6c61 6972 6964 275d 2e69 6c6f  d['flairid'].ilo
-00047d60: 635b 305d 2920 290a 2020 2020 2020 2020  c[0]) ).        
-00047d70: 2020 2020 6d6f 645f 7365 6172 6368 5f70      mod_search_p
-00047d80: 6174 6820 3d20 6f73 2e70 6174 682e 6a6f  ath = os.path.jo
-00047d90: 696e 2873 7562 6a65 6374 726f 6f74 7061  in(subjectrootpa
-00047da0: 7468 2c20 6f76 6572 6d6f 6458 2c20 6969  th, overmodX, ii
-00047db0: 644f 7468 6572 4d6f 642c 2022 2a6e 6969  dOtherMod, "*nii
-00047dc0: 2e67 7a22 290a 2020 2020 2020 2020 2020  .gz").          
-00047dd0: 2020 6d79 696d 6773 7220 3d20 676c 6f62    myimgsr = glob
-00047de0: 2e67 6c6f 6228 6d6f 645f 7365 6172 6368  .glob(mod_search
-00047df0: 5f70 6174 6829 0a20 2020 2020 2020 2069  _path).        i
-00047e00: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-00047e10: 2020 2020 2020 2070 7269 6e74 2820 226f         print( "o
-00047e20: 7665 726d 6f64 2022 202b 206f 7665 726d  vermod " + overm
-00047e30: 6f64 5820 2b20 2220 2220 2b20 6969 644f  odX + " " + iidO
-00047e40: 7468 6572 4d6f 6420 290a 2020 2020 2020  therMod ).      
-00047e50: 2020 2020 2020 7072 696e 7428 6622 6d6f        print(f"mo
-00047e60: 6461 6c69 7479 2073 6561 7263 6820 7061  dality search pa
-00047e70: 7468 3a20 7b6d 6f64 5f73 6561 7263 685f  th: {mod_search_
-00047e80: 7061 7468 7d22 290a 2020 2020 2020 2020  path}").        
-00047e90: 6d79 696d 6773 722e 736f 7274 2829 0a20  myimgsr.sort(). 
-00047ea0: 2020 2020 2020 2069 6620 6c65 6e28 6d79         if len(my
-00047eb0: 696d 6773 7229 203e 2030 3a0a 2020 2020  imgsr) > 0:.    
-00047ec0: 2020 2020 2020 2020 6f76 6572 6d6f 6458          overmodX
-00047ed0: 7820 3d20 7374 7228 6f76 6572 6d6f 6458  x = str(overmodX
-00047ee0: 290a 2020 2020 2020 2020 2020 2020 646f  ).            do
-00047ef0: 7772 6974 653d 4661 6c73 650a 2020 2020  write=False.    
-00047f00: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-00047f10: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00047f20: 2020 2020 7072 696e 7428 2027 6f76 6572      print( 'over
-00047f30: 6d6f 6458 2069 7320 3a20 2720 2b20 6f76  modX is : ' + ov
-00047f40: 6572 6d6f 6458 7820 290a 2020 2020 2020  ermodXx ).      
-00047f50: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00047f60: 2027 6578 616d 706c 6520 696d 6167 6520   'example image 
-00047f70: 6e61 6d65 2069 7320 3a20 2720 2029 0a20  name is : '  ). 
-00047f80: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00047f90: 7269 6e74 2820 6d79 696d 6773 7220 290a  rint( myimgsr ).
-00047fa0: 2020 2020 2020 2020 2020 2020 6966 206f              if o
-00047fb0: 7665 726d 6f64 5878 203d 3d20 274e 4d32  vermodXx == 'NM2
-00047fc0: 444d 5427 3a0a 2020 2020 2020 2020 2020  DMT':.          
-00047fd0: 2020 2020 2020 6d79 696d 6773 7232 203d        myimgsr2 =
-00047fe0: 206d 7969 6d67 7372 0a20 2020 2020 2020   myimgsr.       
-00047ff0: 2020 2020 2020 2020 206d 7969 6d67 7372           myimgsr
-00048000: 322e 736f 7274 2829 0a20 2020 2020 2020  2.sort().       
-00048010: 2020 2020 2020 2020 2069 7334 6420 3d20           is4d = 
-00048020: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
-00048030: 2020 2020 2020 7465 6d70 203d 2061 6e74        temp = ant
-00048040: 732e 696d 6167 655f 7265 6164 2820 6d79  s.image_read( my
-00048050: 696d 6773 7232 5b30 5d20 290a 2020 2020  imgsr2[0] ).    
-00048060: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-00048070: 656d 702e 6469 6d65 6e73 696f 6e20 3d3d  emp.dimension ==
-00048080: 2034 3a0a 2020 2020 2020 2020 2020 2020   4:.            
-00048090: 2020 2020 2020 2020 6973 3464 203d 2054          is4d = T
-000480a0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-000480b0: 2020 2020 6966 206c 656e 2820 6d79 696d      if len( myim
-000480c0: 6773 7232 2029 203d 3d20 3120 616e 6420  gsr2 ) == 1 and 
-000480d0: 6e6f 7420 6973 3464 3a20 2320 6368 6563  not is4d: # chec
-000480e0: 6b20 6469 6d65 6e73 696f 6e0a 2020 2020  k dimension.    
-000480f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048100: 6d79 696d 6773 7232 203d 206d 7969 6d67  myimgsr2 = myimg
-00048110: 7372 3220 2b20 6d79 696d 6773 7232 0a20  sr2 + myimgsr2. 
-00048120: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00048130: 7562 6a65 6374 7072 6f70 6174 6820 3d20  ubjectpropath = 
-00048140: 6f73 2e70 6174 682e 6469 726e 616d 6528  os.path.dirname(
-00048150: 206d 7969 6d67 7372 325b 305d 2029 0a20   myimgsr2[0] ). 
-00048160: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00048170: 7562 6a65 6374 7072 6f70 6174 6820 3d20  ubjectpropath = 
-00048180: 7265 2e73 7562 2820 736f 7572 6365 6461  re.sub( sourceda
-00048190: 7461 666f 6c64 6572 6e61 6d65 2c20 7072  tafoldername, pr
-000481a0: 6f63 6573 7344 6972 2c73 7562 6a65 6374  ocessDir,subject
-000481b0: 7072 6f70 6174 6820 290a 2020 2020 2020  propath ).      
-000481c0: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
-000481d0: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+00040570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040580: 2020 2020 626f 6c64 5465 6d70 6c61 7465      boldTemplate
+00040590: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000405a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000405b0: 2020 2020 2020 2020 2020 2020 2020 6869                hi
+000405c0: 6572 5b27 6272 6169 6e5f 6e34 5f64 6e7a  er['brain_n4_dnz
+000405d0: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+000405e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000405f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040600: 7431 6174 726f 706f 732c 0a20 2020 2020  t1atropos,.     
+00040610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040630: 2020 2020 2020 2066 3d66 2c0a 2020 2020         f=f,.    
+00040640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040660: 2020 2020 2020 2020 4644 5f74 6872 6573          FD_thres
+00040670: 686f 6c64 3d48 4d2c 200a 2020 2020 2020  hold=HM, .      
+00040680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000406a0: 2020 2020 2020 7370 6120 3d20 4e6f 6e65        spa = None
+000406b0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+000406c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000406d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000406e0: 7074 203d 204e 6f6e 652c 200a 2020 2020  pt = None, .    
+000406f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040710: 2020 2020 2020 2020 6e63 203d 2043 432c          nc = CC,
+00040720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00040730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040740: 2020 2020 2020 2020 2020 2020 206f 7574               out
+00040750: 6c69 6572 5f74 6872 6573 686f 6c64 3d6c  lier_threshold=l
+00040760: 6f6f 702c 0a20 2020 2020 2020 2020 2020  oop,.           
+00040770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040790: 2069 6361 5f63 6f6d 706f 6e65 6e74 7320   ica_components 
+000407a0: 3d20 302c 0a20 2020 2020 2020 2020 2020  = 0,.           
+000407b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000407c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000407d0: 2069 6d70 7574 6520 3d20 4661 6c73 652c   impute = False,
+000407e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000407f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040800: 2020 2020 2020 2020 2020 2020 2063 656e               cen
+00040810: 736f 7220 3d20 6365 6e73 2c0a 2020 2020  sor = cens,.    
+00040820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040840: 2020 2020 2020 2020 6465 7370 696b 6520          despike 
+00040850: 3d20 322e 352c 0a20 2020 2020 2020 2020  = 2.5,.         
+00040860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040880: 2020 206d 6f74 696f 6e5f 6173 5f6e 7569     motion_as_nui
+00040890: 7361 6e63 6520 3d20 5472 7565 2c0a 2020  sance = True,.  
+000408a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000408b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000408c0: 2020 2020 2020 2020 2020 7570 7361 6d70            upsamp
+000408d0: 6c65 3d46 616c 7365 2c0a 2020 2020 2020  le=False,.      
+000408e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000408f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040900: 2020 2020 2020 636c 6561 6e5f 746d 703d        clean_tmp=
+00040910: 302e 3636 2c0a 2020 2020 2020 2020 2020  0.66,.          
+00040920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040940: 2020 7665 7262 6f73 653d 7665 7262 6f73    verbose=verbos
+00040950: 6520 2920 2320 6465 6661 756c 740a 2020  e ) # default.  
+00040960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040980: 2020 7273 6670 726f 6c69 7374 2e61 7070    rsfprolist.app
+00040990: 656e 6428 2072 7366 3020 290a 2020 2020  end( rsf0 ).    
+000409a0: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+000409b0: 7574 5f64 6963 745b 2772 7366 275d 203d  ut_dict['rsf'] =
+000409c0: 2072 7366 7072 6f6c 6973 740a 2020 2020   rsfprolist.    
+000409d0: 6966 206e 6d5f 696d 6167 655f 6c69 7374  if nm_image_list
+000409e0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+000409f0: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
+00040a00: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
+00040a10: 696e 7428 276e 6d27 290a 2020 2020 2020  int('nm').      
+00040a20: 2020 6966 2073 726d 6f64 656c 2069 7320    if srmodel is 
+00040a30: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00040a40: 2020 6f75 7470 7574 5f64 6963 745b 274e    output_dict['N
+00040a50: 4d27 5d20 3d20 6e65 7572 6f6d 656c 616e  M'] = neuromelan
+00040a60: 696e 2820 6e6d 5f69 6d61 6765 5f6c 6973  in( nm_image_lis
+00040a70: 742c 2074 3169 6d67 6272 6e2c 2074 315f  t, t1imgbrn, t1_
+00040a80: 696d 6167 652c 2068 6965 725b 2764 6565  image, hier['dee
+00040a90: 705f 6369 7431 3638 6c61 6227 5d2c 2076  p_cit168lab'], v
+00040aa0: 6572 626f 7365 3d76 6572 626f 7365 2029  erbose=verbose )
+00040ab0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00040ac0: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+00040ad0: 745f 6469 6374 5b27 4e4d 275d 203d 206e  t_dict['NM'] = n
+00040ae0: 6575 726f 6d65 6c61 6e69 6e28 206e 6d5f  euromelanin( nm_
+00040af0: 696d 6167 655f 6c69 7374 2c20 7431 696d  image_list, t1im
+00040b00: 6762 726e 2c20 7431 5f69 6d61 6765 2c20  gbrn, t1_image, 
+00040b10: 6869 6572 5b27 6465 6570 5f63 6974 3136  hier['deep_cit16
+00040b20: 386c 6162 275d 2c20 7372 6d6f 6465 6c3d  8lab'], srmodel=
+00040b30: 7372 6d6f 6465 6c2c 2074 6172 6765 745f  srmodel, target_
+00040b40: 7261 6e67 653d 7461 7267 6574 5f72 616e  range=target_ran
+00040b50: 6765 2c20 7665 7262 6f73 653d 7665 7262  ge, verbose=verb
+00040b60: 6f73 6520 2029 0a23 2323 2323 2323 2323  ose  ).#########
+00040b70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00040b80: 2323 2323 2323 2323 2320 646f 2074 6865  ######### do the
+00040b90: 2064 7469 202e 2e2e 2e2e 0a20 2020 2069   dti ......    i
+00040ba0: 6620 6c65 6e28 6477 5f69 6d61 6765 2920  f len(dw_image) 
+00040bb0: 3e20 3020 3a0a 2020 2020 2020 2020 6966  > 0 :.        if
+00040bc0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+00040bd0: 2020 2020 2020 7072 696e 7428 2764 7469        print('dti
+00040be0: 2d78 2729 0a20 2020 2020 2020 2069 6620  -x').        if 
+00040bf0: 6c65 6e28 2064 775f 696d 6167 6520 2920  len( dw_image ) 
+00040c00: 3d3d 2031 3a20 2320 7573 6520 5431 2066  == 1: # use T1 f
+00040c10: 6f72 2064 6973 746f 7274 696f 6e20 636f  or distortion co
+00040c20: 7272 6563 7469 6f6e 2061 6e64 2062 7261  rrection and bra
+00040c30: 696e 2065 7874 7261 6374 696f 6e0a 2020  in extraction.  
+00040c40: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+00040c50: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+00040c60: 2020 2020 2020 7072 696e 7428 2257 6520        print("We 
+00040c70: 6861 7665 206f 6e6c 7920 6f6e 6520 4454  have only one DT
+00040c80: 493a 2022 202b 2073 7472 286c 656e 2864  I: " + str(len(d
+00040c90: 775f 696d 6167 6529 2929 0a20 2020 2020  w_image))).     
+00040ca0: 2020 2020 2020 2064 775f 696d 6167 6520         dw_image 
+00040cb0: 3d20 6477 5f69 6d61 6765 5b30 5d0a 2020  = dw_image[0].  
+00040cc0: 2020 2020 2020 2020 2020 6274 7042 302c            btpB0,
+00040cd0: 6274 7044 573d 6765 745f 6176 6572 6167  btpDW=get_averag
+00040ce0: 655f 6477 695f 6230 2864 775f 696d 6167  e_dwi_b0(dw_imag
+00040cf0: 6529 0a20 2020 2020 2020 2020 2020 2069  e).            i
+00040d00: 6e69 7472 6967 203d 2061 6e74 732e 7265  nitrig = ants.re
+00040d10: 6769 7374 7261 7469 6f6e 2820 6274 7044  gistration( btpD
+00040d20: 572c 2068 6965 725b 2762 7261 696e 5f6e  W, hier['brain_n
+00040d30: 345f 646e 7a27 5d2c 2027 424f 4c44 5269  4_dnz'], 'BOLDRi
+00040d40: 6769 6427 2029 5b27 6677 6474 7261 6e73  gid' )['fwdtrans
+00040d50: 666f 726d 7327 5d5b 305d 0a20 2020 2020  forms'][0].     
+00040d60: 2020 2020 2020 2074 656d 7072 6567 203d         tempreg =
+00040d70: 2061 6e74 732e 7265 6769 7374 7261 7469   ants.registrati
+00040d80: 6f6e 2820 6274 7044 572c 2068 6965 725b  on( btpDW, hier[
+00040d90: 2762 7261 696e 5f6e 345f 646e 7a27 5d2c  'brain_n4_dnz'],
+00040da0: 2027 5379 4e4f 6e6c 7927 2c0a 2020 2020   'SyNOnly',.    
+00040db0: 2020 2020 2020 2020 2020 2020 7379 6e5f              syn_
+00040dc0: 6d65 7472 6963 3d27 6d61 7474 6573 272c  metric='mattes',
+00040dd0: 2073 796e 5f73 616d 706c 696e 673d 3332   syn_sampling=32
+00040de0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00040df0: 2020 7265 675f 6974 6572 6174 696f 6e73    reg_iterations
+00040e00: 3d5b 3530 2c35 302c 3230 5d2c 0a20 2020  =[50,50,20],.   
+00040e10: 2020 2020 2020 2020 2020 2020 206d 756c               mul
+00040e20: 7469 7661 7269 6174 655f 6578 7472 6173  tivariate_extras
+00040e30: 3d5b 205b 2022 6d61 7474 6573 222c 2062  =[ [ "mattes", b
+00040e40: 7470 4230 2c20 6869 6572 5b27 6272 6169  tpB0, hier['brai
+00040e50: 6e5f 6e34 5f64 6e7a 275d 2c20 312c 2033  n_n4_dnz'], 1, 3
+00040e60: 3220 5d5d 2c0a 2020 2020 2020 2020 2020  2 ]],.          
+00040e70: 2020 2020 2020 696e 6974 6961 6c5f 7472        initial_tr
+00040e80: 616e 7366 6f72 6d3d 696e 6974 7269 670a  ansform=initrig.
+00040e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040ea0: 290a 2020 2020 2020 2020 2020 2020 6d79  ).            my
+00040eb0: 6278 7420 3d20 616e 7473 2e74 6872 6573  bxt = ants.thres
+00040ec0: 686f 6c64 5f69 6d61 6765 2820 616e 7473  hold_image( ants
+00040ed0: 2e69 4d61 7468 2868 6965 725b 2762 7261  .iMath(hier['bra
+00040ee0: 696e 5f6e 345f 646e 7a27 5d2c 2022 4e6f  in_n4_dnz'], "No
+00040ef0: 726d 616c 697a 6522 2029 2c20 302e 3030  rmalize" ), 0.00
+00040f00: 312c 2031 2029 0a20 2020 2020 2020 2020  1, 1 ).         
+00040f10: 2020 2062 7470 4457 203d 2061 6e74 732e     btpDW = ants.
+00040f20: 6170 706c 795f 7472 616e 7366 6f72 6d73  apply_transforms
+00040f30: 2820 6274 7044 572c 2062 7470 4457 2c0a  ( btpDW, btpDW,.
+00040f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040f50: 7465 6d70 7265 675b 2769 6e76 7472 616e  tempreg['invtran
+00040f60: 7366 6f72 6d73 275d 5b31 5d2c 2069 6e74  sforms'][1], int
+00040f70: 6572 706f 6c61 746f 723d 276c 696e 6561  erpolator='linea
+00040f80: 7227 290a 2020 2020 2020 2020 2020 2020  r').            
+00040f90: 6274 7042 3020 3d20 616e 7473 2e61 7070  btpB0 = ants.app
+00040fa0: 6c79 5f74 7261 6e73 666f 726d 7328 2062  ly_transforms( b
+00040fb0: 7470 4230 2c20 6274 7042 302c 0a20 2020  tpB0, btpB0,.   
+00040fc0: 2020 2020 2020 2020 2020 2020 2074 656d               tem
+00040fd0: 7072 6567 5b27 696e 7674 7261 6e73 666f  preg['invtransfo
+00040fe0: 726d 7327 5d5b 315d 2c20 696e 7465 7270  rms'][1], interp
+00040ff0: 6f6c 6174 6f72 3d27 6c69 6e65 6172 2729  olator='linear')
+00041000: 0a20 2020 2020 2020 2020 2020 2064 7769  .            dwi
+00041010: 6d61 736b 203d 2061 6e74 732e 6170 706c  mask = ants.appl
+00041020: 795f 7472 616e 7366 6f72 6d73 2820 6274  y_transforms( bt
+00041030: 7044 572c 206d 7962 7874 2c20 7465 6d70  pDW, mybxt, temp
+00041040: 7265 675b 2766 7764 7472 616e 7366 6f72  reg['fwdtransfor
+00041050: 6d73 275d 5b31 5d2c 2069 6e74 6572 706f  ms'][1], interpo
+00041060: 6c61 746f 723d 276e 6561 7265 7374 4e65  lator='nearestNe
+00041070: 6967 6862 6f72 2729 0a20 2020 2020 2020  ighbor').       
+00041080: 2020 2020 2023 2064 7769 6d61 736b 203d       # dwimask =
+00041090: 2061 6e74 732e 694d 6174 6828 6477 696d   ants.iMath(dwim
+000410a0: 6173 6b2c 274d 4427 2c31 290a 2020 2020  ask,'MD',1).    
+000410b0: 2020 2020 2020 2020 7431 3264 7769 203d          t12dwi =
+000410c0: 2061 6e74 732e 6170 706c 795f 7472 616e   ants.apply_tran
+000410d0: 7366 6f72 6d73 2820 6274 7044 572c 2068  sforms( btpDW, h
+000410e0: 6965 725b 2762 7261 696e 5f6e 345f 646e  ier['brain_n4_dn
+000410f0: 7a27 5d2c 2074 656d 7072 6567 5b27 6677  z'], tempreg['fw
+00041100: 6474 7261 6e73 666f 726d 7327 5d5b 315d  dtransforms'][1]
+00041110: 2c20 696e 7465 7270 6f6c 6174 6f72 3d27  , interpolator='
+00041120: 6c69 6e65 6172 2729 0a20 2020 2020 2020  linear').       
+00041130: 2020 2020 206f 7574 7075 745f 6469 6374       output_dict
+00041140: 5b27 4454 4927 5d20 3d20 6a6f 696e 745f  ['DTI'] = joint_
+00041150: 6474 695f 7265 636f 6e28 0a20 2020 2020  dti_recon(.     
+00041160: 2020 2020 2020 2020 2020 2064 775f 696d             dw_im
+00041170: 6167 652c 0a20 2020 2020 2020 2020 2020  age,.           
+00041180: 2020 2020 2062 7661 6c73 5b30 5d2c 0a20       bvals[0],. 
+00041190: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+000411a0: 7665 6373 5b30 5d2c 0a20 2020 2020 2020  vecs[0],.       
+000411b0: 2020 2020 2020 2020 206a 6875 5f61 746c           jhu_atl
+000411c0: 6173 3d4a 4855 5f61 746c 6173 2c0a 2020  as=JHU_atlas,.  
+000411d0: 2020 2020 2020 2020 2020 2020 2020 6a68                jh
+000411e0: 755f 6c61 6265 6c73 3d4a 4855 5f6c 6162  u_labels=JHU_lab
+000411f0: 656c 732c 0a20 2020 2020 2020 2020 2020  els,.           
+00041200: 2020 2020 2062 7261 696e 5f6d 6173 6b20       brain_mask 
+00041210: 3d20 6477 696d 6173 6b2c 0a20 2020 2020  = dwimask,.     
+00041220: 2020 2020 2020 2020 2020 2072 6566 6572             refer
+00041230: 656e 6365 5f42 3020 3d20 6274 7042 302c  ence_B0 = btpB0,
+00041240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00041250: 2072 6566 6572 656e 6365 5f44 5749 203d   reference_DWI =
+00041260: 2062 7470 4457 2c0a 2020 2020 2020 2020   btpDW,.        
+00041270: 2020 2020 2020 2020 7372 6d6f 6465 6c3d          srmodel=
+00041280: 7372 6d6f 6465 6c2c 0a20 2020 2020 2020  srmodel,.       
+00041290: 2020 2020 2020 2020 206d 6f74 696f 6e5f           motion_
+000412a0: 636f 7272 6563 743d 6474 695f 6d6f 7469  correct=dti_moti
+000412b0: 6f6e 5f63 6f72 7265 6374 2c20 2320 7365  on_correct, # se
+000412c0: 7420 746f 2046 616c 7365 2069 6620 7573  t to False if us
+000412d0: 696e 6720 696e 7075 7420 6672 6f6d 2071  ing input from q
+000412e0: 7369 7072 6570 0a20 2020 2020 2020 2020  siprep.         
+000412f0: 2020 2020 2020 2064 656e 6f69 7365 3d64         denoise=d
+00041300: 7469 5f64 656e 6f69 7365 2c0a 2020 2020  ti_denoise,.    
+00041310: 2020 2020 2020 2020 2020 2020 7665 7262              verb
+00041320: 6f73 6520 3d20 7665 7262 6f73 6529 0a20  ose = verbose). 
+00041330: 2020 2020 2020 2065 6c73 6520 3a20 2023         else :  #
+00041340: 2075 7365 2070 6861 7365 2065 6e63 6f64   use phase encod
+00041350: 696e 6720 6163 7175 6973 6974 696f 6e73  ing acquisitions
+00041360: 2066 6f72 2064 6973 746f 7274 696f 6e20   for distortion 
+00041370: 636f 7272 6563 7469 6f6e 2061 6e64 2054  correction and T
+00041380: 3120 666f 7220 6272 6169 6e20 6578 7472  1 for brain extr
+00041390: 6163 7469 6f6e 0a20 2020 2020 2020 2020  action.         
+000413a0: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
+000413b0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000413c0: 7269 6e74 2822 5765 2068 6176 6520 626f  rint("We have bo
+000413d0: 7468 2044 5449 5f4c 5220 616e 6420 4454  th DTI_LR and DT
+000413e0: 495f 524c 3a20 2220 2b20 7374 7228 6c65  I_RL: " + str(le
+000413f0: 6e28 6477 5f69 6d61 6765 2929 290a 2020  n(dw_image))).  
+00041400: 2020 2020 2020 2020 2020 6131 622c 6131            a1b,a1
+00041410: 773d 6765 745f 6176 6572 6167 655f 6477  w=get_average_dw
+00041420: 695f 6230 2864 775f 696d 6167 655b 305d  i_b0(dw_image[0]
+00041430: 290a 2020 2020 2020 2020 2020 2020 6132  ).            a2
+00041440: 622c 6132 773d 6765 745f 6176 6572 6167  b,a2w=get_averag
+00041450: 655f 6477 695f 6230 2864 775f 696d 6167  e_dwi_b0(dw_imag
+00041460: 655b 315d 2c66 6978 6564 5f62 303d 6131  e[1],fixed_b0=a1
+00041470: 622c 6669 7865 645f 6477 693d 6131 7729  b,fixed_dwi=a1w)
+00041480: 0a20 2020 2020 2020 2020 2020 2062 7470  .            btp
+00041490: 4230 2c20 6274 7044 5720 3d20 6474 695f  B0, btpDW = dti_
+000414a0: 7465 6d70 6c61 7465 280a 2020 2020 2020  template(.      
+000414b0: 2020 2020 2020 2020 2020 625f 696d 6167            b_imag
+000414c0: 655f 6c69 7374 3d5b 6131 622c 6132 625d  e_list=[a1b,a2b]
+000414d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000414e0: 2020 775f 696d 6167 655f 6c69 7374 3d5b    w_image_list=[
+000414f0: 6131 772c 6132 775d 2c0a 2020 2020 2020  a1w,a2w],.      
+00041500: 2020 2020 2020 2020 2020 6974 6572 6174            iterat
+00041510: 696f 6e73 3d37 2c20 7665 7262 6f73 653d  ions=7, verbose=
+00041520: 7665 7262 6f73 6520 290a 2020 2020 2020  verbose ).      
+00041530: 2020 2020 2020 696e 6974 7269 6720 3d20        initrig = 
+00041540: 616e 7473 2e72 6567 6973 7472 6174 696f  ants.registratio
+00041550: 6e28 2062 7470 4457 2c20 6869 6572 5b27  n( btpDW, hier['
+00041560: 6272 6169 6e5f 6e34 5f64 6e7a 275d 2c20  brain_n4_dnz'], 
+00041570: 2742 4f4c 4452 6967 6964 2720 295b 2766  'BOLDRigid' )['f
+00041580: 7764 7472 616e 7366 6f72 6d73 275d 5b30  wdtransforms'][0
+00041590: 5d0a 2020 2020 2020 2020 2020 2020 7465  ].            te
+000415a0: 6d70 7265 6720 3d20 616e 7473 2e72 6567  mpreg = ants.reg
+000415b0: 6973 7472 6174 696f 6e28 2062 7470 4457  istration( btpDW
+000415c0: 2c20 6869 6572 5b27 6272 6169 6e5f 6e34  , hier['brain_n4
+000415d0: 5f64 6e7a 275d 2c20 2753 794e 4f6e 6c79  _dnz'], 'SyNOnly
+000415e0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000415f0: 2020 2073 796e 5f6d 6574 7269 633d 276d     syn_metric='m
+00041600: 6174 7465 7327 2c20 7379 6e5f 7361 6d70  attes', syn_samp
+00041610: 6c69 6e67 3d33 322c 0a20 2020 2020 2020  ling=32,.       
+00041620: 2020 2020 2020 2020 2072 6567 5f69 7465           reg_ite
+00041630: 7261 7469 6f6e 733d 5b35 302c 3530 2c32  rations=[50,50,2
+00041640: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+00041650: 2020 2020 6d75 6c74 6976 6172 6961 7465      multivariate
+00041660: 5f65 7874 7261 733d 5b20 5b20 226d 6174  _extras=[ [ "mat
+00041670: 7465 7322 2c20 6274 7042 302c 2068 6965  tes", btpB0, hie
+00041680: 725b 2762 7261 696e 5f6e 345f 646e 7a27  r['brain_n4_dnz'
+00041690: 5d2c 2031 2c20 3332 205d 5d2c 0a20 2020  ], 1, 32 ]],.   
+000416a0: 2020 2020 2020 2020 2020 2020 2069 6e69               ini
+000416b0: 7469 616c 5f74 7261 6e73 666f 726d 3d69  tial_transform=i
+000416c0: 6e69 7472 6967 0a20 2020 2020 2020 2020  nitrig.         
+000416d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000416e0: 2020 2020 206d 7962 7874 203d 2061 6e74       mybxt = ant
+000416f0: 732e 7468 7265 7368 6f6c 645f 696d 6167  s.threshold_imag
+00041700: 6528 2061 6e74 732e 694d 6174 6828 6869  e( ants.iMath(hi
+00041710: 6572 5b27 6272 6169 6e5f 6e34 5f64 6e7a  er['brain_n4_dnz
+00041720: 275d 2c20 224e 6f72 6d61 6c69 7a65 2220  '], "Normalize" 
+00041730: 292c 2030 2e30 3031 2c20 3120 290a 2020  ), 0.001, 1 ).  
+00041740: 2020 2020 2020 2020 2020 6477 696d 6173            dwimas
+00041750: 6b20 3d20 616e 7473 2e61 7070 6c79 5f74  k = ants.apply_t
+00041760: 7261 6e73 666f 726d 7328 2062 7470 4457  ransforms( btpDW
+00041770: 2c20 6d79 6278 742c 2074 656d 7072 6567  , mybxt, tempreg
+00041780: 5b27 6677 6474 7261 6e73 666f 726d 7327  ['fwdtransforms'
+00041790: 5d2c 2069 6e74 6572 706f 6c61 746f 723d  ], interpolator=
+000417a0: 276e 6561 7265 7374 4e65 6967 6862 6f72  'nearestNeighbor
+000417b0: 2729 0a20 2020 2020 2020 2020 2020 206f  ').            o
+000417c0: 7574 7075 745f 6469 6374 5b27 4454 4927  utput_dict['DTI'
+000417d0: 5d20 3d20 6a6f 696e 745f 6474 695f 7265  ] = joint_dti_re
+000417e0: 636f 6e28 0a20 2020 2020 2020 2020 2020  con(.           
+000417f0: 2020 2020 2064 775f 696d 6167 655b 305d       dw_image[0]
+00041800: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00041810: 2020 6276 616c 735b 305d 2c0a 2020 2020    bvals[0],.    
+00041820: 2020 2020 2020 2020 2020 2020 6276 6563              bvec
+00041830: 735b 305d 2c0a 2020 2020 2020 2020 2020  s[0],.          
+00041840: 2020 2020 2020 6a68 755f 6174 6c61 733d        jhu_atlas=
+00041850: 4a48 555f 6174 6c61 732c 0a20 2020 2020  JHU_atlas,.     
+00041860: 2020 2020 2020 2020 2020 206a 6875 5f6c             jhu_l
+00041870: 6162 656c 733d 4a48 555f 6c61 6265 6c73  abels=JHU_labels
+00041880: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00041890: 2020 6272 6169 6e5f 6d61 736b 203d 2064    brain_mask = d
+000418a0: 7769 6d61 736b 2c0a 2020 2020 2020 2020  wimask,.        
+000418b0: 2020 2020 2020 2020 7265 6665 7265 6e63          referenc
+000418c0: 655f 4230 203d 2062 7470 4230 2c0a 2020  e_B0 = btpB0,.  
+000418d0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000418e0: 6665 7265 6e63 655f 4457 4920 3d20 6274  ference_DWI = bt
+000418f0: 7044 572c 0a20 2020 2020 2020 2020 2020  pDW,.           
+00041900: 2020 2020 2073 726d 6f64 656c 3d73 726d       srmodel=srm
+00041910: 6f64 656c 2c0a 2020 2020 2020 2020 2020  odel,.          
+00041920: 2020 2020 2020 696d 675f 524c 3d64 775f        img_RL=dw_
+00041930: 696d 6167 655b 315d 2c0a 2020 2020 2020  image[1],.      
+00041940: 2020 2020 2020 2020 2020 6276 616c 5f52            bval_R
+00041950: 4c3d 6276 616c 735b 315d 2c0a 2020 2020  L=bvals[1],.    
+00041960: 2020 2020 2020 2020 2020 2020 6276 6563              bvec
+00041970: 5f52 4c3d 6276 6563 735b 315d 2c0a 2020  _RL=bvecs[1],.  
+00041980: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+00041990: 7469 6f6e 5f63 6f72 7265 6374 3d27 5379  tion_correct='Sy
+000419a0: 4e27 2c20 2320 7365 7420 746f 2046 616c  N', # set to Fal
+000419b0: 7365 2069 6620 7573 696e 6720 696e 7075  se if using inpu
+000419c0: 7420 6672 6f6d 2071 7369 7072 6570 0a20  t from qsiprep. 
+000419d0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000419e0: 656e 6f69 7365 3d54 7275 652c 0a20 2020  enoise=True,.   
+000419f0: 2020 2020 2020 2020 2020 2020 2076 6572               ver
+00041a00: 626f 7365 203d 2076 6572 626f 7365 290a  bose = verbose).
+00041a10: 2020 2020 2020 2020 6d79 6474 6920 3d20          mydti = 
+00041a20: 6f75 7470 7574 5f64 6963 745b 2744 5449  output_dict['DTI
+00041a30: 275d 0a20 2020 2020 2020 2023 2073 756d  '].        # sum
+00041a40: 6d61 7269 7a65 2064 7769 2077 6974 6820  marize dwi with 
+00041a50: 5431 206f 7574 7075 7473 0a20 2020 2020  T1 outputs.     
+00041a60: 2020 2023 2066 6972 7374 202d 2072 6567     # first - reg
+00041a70: 6973 7465 7220 2e2e 2e2e 0a20 2020 2020  ister .....     
+00041a80: 2020 2072 6567 203d 2061 6e74 732e 7265     reg = ants.re
+00041a90: 6769 7374 7261 7469 6f6e 2820 6d79 6474  gistration( mydt
+00041aa0: 695b 2772 6563 6f6e 5f66 6127 5d2c 2068  i['recon_fa'], h
+00041ab0: 6965 725b 2762 7261 696e 5f6e 345f 646e  ier['brain_n4_dn
+00041ac0: 7a27 5d2c 2027 5379 4e42 6f6c 6427 2c20  z'], 'SyNBold', 
+00041ad0: 746f 7461 6c5f 7369 676d 613d 312e 3020  total_sigma=1.0 
+00041ae0: 290a 2020 2020 2020 2020 2323 2323 2323  ).        ######
+00041af0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00041b00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00041b10: 2323 2323 2323 2323 2323 2323 0a20 2020  ############.   
+00041b20: 2020 2020 206f 7574 7075 745f 6469 6374       output_dict
+00041b30: 5b27 4641 5f73 756d 6d27 5d20 3d20 6869  ['FA_summ'] = hi
+00041b40: 6572 6172 6368 6963 616c 5f6d 6f64 616c  erarchical_modal
+00041b50: 6974 795f 7375 6d6d 6172 7928 0a20 2020  ity_summary(.   
+00041b60: 2020 2020 2020 2020 206d 7964 7469 5b27           mydti['
+00041b70: 7265 636f 6e5f 6661 275d 2c0a 2020 2020  recon_fa'],.    
+00041b80: 2020 2020 2020 2020 6869 6572 3d68 6965          hier=hie
+00041b90: 722c 0a20 2020 2020 2020 2020 2020 206d  r,.            m
+00041ba0: 6f64 616c 6974 795f 6e61 6d65 3d27 6661  odality_name='fa
+00041bb0: 272c 0a20 2020 2020 2020 2020 2020 2074  ',.            t
+00041bc0: 7261 6e73 666f 726d 6c69 7374 3d72 6567  ransformlist=reg
+00041bd0: 5b27 6677 6474 7261 6e73 666f 726d 7327  ['fwdtransforms'
+00041be0: 5d2c 0a20 2020 2020 2020 2020 2020 2076  ],.            v
+00041bf0: 6572 626f 7365 203d 2046 616c 7365 2029  erbose = False )
+00041c00: 0a20 2020 2020 2020 2023 2323 2323 2323  .        #######
+00041c10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00041c20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00041c30: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
+00041c40: 2020 2020 6f75 7470 7574 5f64 6963 745b      output_dict[
+00041c50: 274d 445f 7375 6d6d 275d 203d 2068 6965  'MD_summ'] = hie
+00041c60: 7261 7263 6869 6361 6c5f 6d6f 6461 6c69  rarchical_modali
+00041c70: 7479 5f73 756d 6d61 7279 280a 2020 2020  ty_summary(.    
+00041c80: 2020 2020 2020 2020 6d79 6474 695b 2772          mydti['r
+00041c90: 6563 6f6e 5f6d 6427 5d2c 0a20 2020 2020  econ_md'],.     
+00041ca0: 2020 2020 2020 2068 6965 723d 6869 6572         hier=hier
+00041cb0: 2c0a 2020 2020 2020 2020 2020 2020 6d6f  ,.            mo
+00041cc0: 6461 6c69 7479 5f6e 616d 653d 276d 6427  dality_name='md'
+00041cd0: 2c0a 2020 2020 2020 2020 2020 2020 7472  ,.            tr
+00041ce0: 616e 7366 6f72 6d6c 6973 743d 7265 675b  ansformlist=reg[
+00041cf0: 2766 7764 7472 616e 7366 6f72 6d73 275d  'fwdtransforms']
+00041d00: 2c0a 2020 2020 2020 2020 2020 2020 7665  ,.            ve
+00041d10: 7262 6f73 6520 3d20 4661 6c73 6520 290a  rbose = False ).
+00041d20: 2020 2020 2020 2020 2320 7468 6573 6520          # these 
+00041d30: 696e 7075 7473 2073 686f 756c 6420 636f  inputs should co
+00041d40: 6d65 2066 726f 6d20 6e69 6365 6c79 2070  me from nicely p
+00041d50: 726f 6365 7373 6564 2064 6174 610a 2020  rocessed data.  
+00041d60: 2020 2020 2020 646b 746d 6170 7065 6420        dktmapped 
+00041d70: 3d20 616e 7473 2e61 7070 6c79 5f74 7261  = ants.apply_tra
+00041d80: 6e73 666f 726d 7328 0a20 2020 2020 2020  nsforms(.       
+00041d90: 2020 2020 206d 7964 7469 5b27 7265 636f       mydti['reco
+00041da0: 6e5f 6661 275d 2c0a 2020 2020 2020 2020  n_fa'],.        
+00041db0: 2020 2020 6869 6572 5b27 646b 745f 7061      hier['dkt_pa
+00041dc0: 7263 275d 5b27 646b 745f 636f 7274 6578  rc']['dkt_cortex
+00041dd0: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+00041de0: 7265 675b 2766 7764 7472 616e 7366 6f72  reg['fwdtransfor
+00041df0: 6d73 275d 2c20 696e 7465 7270 6f6c 6174  ms'], interpolat
+00041e00: 6f72 3d27 6e65 6172 6573 744e 6569 6768  or='nearestNeigh
+00041e10: 626f 7227 2029 0a20 2020 2020 2020 2063  bor' ).        c
+00041e20: 6974 6d61 7070 6564 203d 2061 6e74 732e  itmapped = ants.
+00041e30: 6170 706c 795f 7472 616e 7366 6f72 6d73  apply_transforms
+00041e40: 280a 2020 2020 2020 2020 2020 2020 6d79  (.            my
+00041e50: 6474 695b 2772 6563 6f6e 5f66 6127 5d2c  dti['recon_fa'],
+00041e60: 0a20 2020 2020 2020 2020 2020 2068 6965  .            hie
+00041e70: 725b 2763 6974 3136 386c 6162 275d 2c0a  r['cit168lab'],.
+00041e80: 2020 2020 2020 2020 2020 2020 7265 675b              reg[
+00041e90: 2766 7764 7472 616e 7366 6f72 6d73 275d  'fwdtransforms']
+00041ea0: 2c20 696e 7465 7270 6f6c 6174 6f72 3d27  , interpolator='
+00041eb0: 6e65 6172 6573 744e 6569 6768 626f 7227  nearestNeighbor'
+00041ec0: 2029 0a20 2020 2020 2020 2064 6b74 6d61   ).        dktma
+00041ed0: 7070 6564 5b20 6369 746d 6170 7065 6420  pped[ citmapped 
+00041ee0: 3e20 305d 3d30 0a20 2020 2020 2020 206d  > 0]=0.        m
+00041ef0: 6173 6b20 3d20 616e 7473 2e74 6872 6573  ask = ants.thres
+00041f00: 686f 6c64 5f69 6d61 6765 2820 6d79 6474  hold_image( mydt
+00041f10: 695b 2772 6563 6f6e 5f66 6127 5d2c 2030  i['recon_fa'], 0
+00041f20: 2e30 312c 2032 2e30 2029 2e69 4d61 7468  .01, 2.0 ).iMath
+00041f30: 2822 4765 744c 6172 6765 7374 436f 6d70  ("GetLargestComp
+00041f40: 6f6e 656e 7422 290a 2020 2020 2020 2020  onent").        
+00041f50: 6966 2064 6f5f 7472 6163 746f 6772 6170  if do_tractograp
+00041f60: 6879 3a20 2320 6477 695f 6465 7465 726d  hy: # dwi_determ
+00041f70: 696e 6973 7469 635f 7472 6163 6b69 6e67  inistic_tracking
+00041f80: 2064 7769 5f63 6c6f 7365 7374 5f70 6561   dwi_closest_pea
+00041f90: 6b5f 7472 6163 6b69 6e67 0a20 2020 2020  k_tracking.     
+00041fa0: 2020 2020 2020 206f 7574 7075 745f 6469         output_di
+00041fb0: 6374 5b27 7472 6163 746f 6772 6170 6879  ct['tractography
+00041fc0: 275d 203d 2064 7769 5f64 6574 6572 6d69  '] = dwi_determi
+00041fd0: 6e69 7374 6963 5f74 7261 636b 696e 6728  nistic_tracking(
+00041fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00041ff0: 206d 7964 7469 5b27 6477 695f 4c52 5f64   mydti['dwi_LR_d
+00042000: 6577 6172 7065 6427 5d2c 0a20 2020 2020  ewarped'],.     
+00042010: 2020 2020 2020 2020 2020 206d 7964 7469             mydti
+00042020: 5b27 7265 636f 6e5f 6661 275d 2c0a 2020  ['recon_fa'],.  
+00042030: 2020 2020 2020 2020 2020 2020 2020 6d79                my
+00042040: 6474 695b 2762 7661 6c5f 4c52 275d 2c0a  dti['bval_LR'],.
+00042050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042060: 6d79 6474 695b 2762 7665 635f 4c52 275d  mydti['bvec_LR']
+00042070: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00042080: 2020 7365 6564 5f64 656e 7369 7479 203d    seed_density =
+00042090: 2031 2c0a 2020 2020 2020 2020 2020 2020   1,.            
+000420a0: 2020 2020 6d61 736b 3d6d 6173 6b2c 0a20      mask=mask,. 
+000420b0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+000420c0: 6572 626f 7365 203d 2076 6572 626f 7365  erbose = verbose
+000420d0: 2029 0a20 2020 2020 2020 2020 2020 206d   ).            m
+000420e0: 7973 7472 203d 206f 7574 7075 745f 6469  ystr = output_di
+000420f0: 6374 5b27 7472 6163 746f 6772 6170 6879  ct['tractography
+00042100: 275d 0a20 2020 2020 2020 2020 2020 206f  '].            o
+00042110: 7574 7075 745f 6469 6374 5b27 7472 6163  utput_dict['trac
+00042120: 746f 6772 6170 6879 5f63 6f6e 6e65 6374  tography_connect
+00042130: 6976 6974 7927 5d20 3d20 6477 695f 7374  ivity'] = dwi_st
+00042140: 7265 616d 6c69 6e65 5f63 6f6e 6e65 6374  reamline_connect
+00042150: 6976 6974 7928 206d 7973 7472 5b27 7374  ivity( mystr['st
+00042160: 7265 616d 6c69 6e65 7327 5d2c 2064 6b74  reamlines'], dkt
+00042170: 6d61 7070 6564 2b63 6974 6d61 7070 6564  mapped+citmapped
+00042180: 2c20 636e 7863 7376 2c20 7665 7262 6f73  , cnxcsv, verbos
+00042190: 653d 7665 7262 6f73 6520 290a 2020 2020  e=verbose ).    
+000421a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000421b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000421c0: 2323 2064 6f20 7468 6520 666c 6169 7220  ## do the flair 
+000421d0: 2e2e 2e2e 2e0a 2020 2020 6966 2066 6c61  ......    if fla
+000421e0: 6972 5f69 6d61 6765 2069 7320 6e6f 7420  ir_image is not 
+000421f0: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
+00042200: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+00042210: 2020 2020 2020 7072 696e 7428 2766 6c61        print('fla
+00042220: 6972 2729 0a20 2020 2020 2020 2077 6d68  ir').        wmh
+00042230: 7072 696f 7220 3d20 4e6f 6e65 0a20 2020  prior = None.   
+00042240: 2020 2020 2070 7269 6f72 666e 203d 2065       priorfn = e
+00042250: 785f 7061 7468 5f6d 6d20 2b20 2743 4954  x_path_mm + 'CIT
+00042260: 3136 385f 776d 6870 7269 6f72 5f37 3030  168_wmhprior_700
+00042270: 756d 5f70 6164 5f61 646e 692e 6e69 692e  um_pad_adni.nii.
+00042280: 677a 270a 2020 2020 2020 2020 6966 2028  gz'.        if (
+00042290: 2065 7869 7374 7328 2070 7269 6f72 666e   exists( priorfn
+000422a0: 2029 2029 3a0a 2020 2020 2020 2020 2020   ) ):.          
+000422b0: 2020 776d 6870 7269 6f72 203d 2061 6e74    wmhprior = ant
+000422c0: 732e 696d 6167 655f 7265 6164 2820 7072  s.image_read( pr
+000422d0: 696f 7266 6e20 290a 2020 2020 2020 2020  iorfn ).        
+000422e0: 2020 2020 776d 6870 7269 6f72 203d 2061      wmhprior = a
+000422f0: 6e74 732e 6170 706c 795f 7472 616e 7366  nts.apply_transf
+00042300: 6f72 6d73 2820 7431 5f69 6d61 6765 2c20  orms( t1_image, 
+00042310: 776d 6870 7269 6f72 2c20 646f 5f6e 6f72  wmhprior, do_nor
+00042320: 6d61 6c69 7a61 7469 6f6e 5b27 696e 7674  malization['invt
+00042330: 7261 6e73 666f 726d 7327 5d20 290a 2020  ransforms'] ).  
+00042340: 2020 2020 2020 6f75 7470 7574 5f64 6963        output_dic
+00042350: 745b 2766 6c61 6972 275d 203d 2062 6f6f  t['flair'] = boo
+00042360: 745f 776d 6828 2066 6c61 6972 5f69 6d61  t_wmh( flair_ima
+00042370: 6765 2c20 7431 5f69 6d61 6765 2c20 7431  ge, t1_image, t1
+00042380: 6174 726f 706f 732c 0a20 2020 2020 2020  atropos,.       
+00042390: 2020 2020 2070 7269 6f72 5f70 726f 6261       prior_proba
+000423a0: 6269 6c69 7479 3d77 6d68 7072 696f 722c  bility=wmhprior,
+000423b0: 2076 6572 626f 7365 3d76 6572 626f 7365   verbose=verbose
+000423c0: 2029 0a20 2020 2023 2323 2323 2323 2323   ).    #########
+000423d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000423e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000423f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00042400: 2323 2323 2323 2323 0a20 2020 2023 2323  ########.    ###
+00042410: 204e 4f54 4553 3a20 6465 666f 726d 696e   NOTES: deformin
+00042420: 6720 746f 2061 2063 6f6d 6d6f 6e20 7370  g to a common sp
+00042430: 6163 6520 616e 6420 7772 6974 696e 6720  ace and writing 
+00042440: 6f75 7420 696d 6167 6573 2023 2323 0a20  out images ###. 
+00042450: 2020 2023 2323 2069 6d61 6765 7320 7765     ### images we
+00042460: 2077 616e 7420 636f 6d65 2066 726f 6d3a   want come from:
+00042470: 2044 5449 2c20 4e4d 2c20 7273 662c 2074   DTI, NM, rsf, t
+00042480: 6869 636b 6e65 7373 2023 2323 2323 2323  hickness #######
+00042490: 2323 2323 0a20 2020 2023 2323 2323 2323  ####.    #######
+000424a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000424b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000424c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000424d0: 2323 2323 2323 2323 2323 0a20 2020 2069  ##########.    i
+000424e0: 6620 646f 5f6e 6f72 6d61 6c69 7a61 7469  f do_normalizati
+000424f0: 6f6e 2069 7320 6e6f 7420 4e6f 6e65 3a0a  on is not None:.
+00042500: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+00042510: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00042520: 7072 696e 7428 276e 6f72 6d61 6c69 7a61  print('normaliza
+00042530: 7469 6f6e 2729 0a20 2020 2020 2020 2023  tion').        #
+00042540: 206d 6967 6874 2072 6563 6f6e 7369 6465   might reconside
+00042550: 7220 7468 6973 2074 656d 706c 6174 6520  r this template 
+00042560: 7370 6163 6520 2d20 6372 6f70 7065 6420  space - cropped 
+00042570: 616e 642f 6f72 2068 6967 6865 7220 7265  and/or higher re
+00042580: 733f 0a20 2020 2020 2020 2023 2074 656d  s?.        # tem
+00042590: 706c 6174 6520 3d20 616e 7473 2e72 6573  plate = ants.res
+000425a0: 616d 706c 655f 696d 6167 6528 2074 656d  ample_image( tem
+000425b0: 706c 6174 652c 205b 312c 312c 315d 2c20  plate, [1,1,1], 
+000425c0: 7573 655f 766f 7865 6c73 3d46 616c 7365  use_voxels=False
+000425d0: 2029 0a20 2020 2020 2020 2023 2074 3172   ).        # t1r
+000425e0: 6567 203d 2061 6e74 732e 7265 6769 7374  eg = ants.regist
+000425f0: 7261 7469 6f6e 2820 7465 6d70 6c61 7465  ration( template
+00042600: 2c20 6869 6572 5b27 6272 6169 6e5f 6e34  , hier['brain_n4
+00042610: 5f64 6e7a 275d 2c20 2261 6e74 7352 6567  _dnz'], "antsReg
+00042620: 6973 7472 6174 696f 6e53 794e 5175 6963  istrationSyNQuic
+00042630: 6b52 6570 726f 5b73 5d22 290a 2020 2020  kRepro[s]").    
+00042640: 2020 2020 7431 7265 6720 3d20 646f 5f6e      t1reg = do_n
+00042650: 6f72 6d61 6c69 7a61 7469 6f6e 0a20 2020  ormalization.   
+00042660: 2020 2020 2069 6620 646f 5f6b 6b3a 0a20       if do_kk:. 
+00042670: 2020 2020 2020 2020 2020 206e 6f72 6d61             norma
+00042680: 6c69 7a61 7469 6f6e 5f64 6963 745b 276b  lization_dict['k
+00042690: 6b5f 6e6f 726d 275d 203d 2061 6e74 732e  k_norm'] = ants.
+000426a0: 6170 706c 795f 7472 616e 7366 6f72 6d73  apply_transforms
+000426b0: 2820 6772 6f75 705f 7465 6d70 6c61 7465  ( group_template
+000426c0: 2c20 6f75 7470 7574 5f64 6963 745b 276b  , output_dict['k
+000426d0: 6b27 5d5b 2774 6869 636b 6e65 7373 5f69  k']['thickness_i
+000426e0: 6d61 6765 275d 2c20 6772 6f75 705f 7472  mage'], group_tr
+000426f0: 616e 7366 6f72 6d20 290a 2020 2020 2020  ansform ).      
+00042700: 2020 6966 206f 7574 7075 745f 6469 6374    if output_dict
+00042710: 5b27 4454 4927 5d20 6973 206e 6f74 204e  ['DTI'] is not N
+00042720: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00042730: 206d 7964 7469 203d 206f 7574 7075 745f   mydti = output_
+00042740: 6469 6374 5b27 4454 4927 5d0a 2020 2020  dict['DTI'].    
+00042750: 2020 2020 2020 2020 6474 6972 6967 203d          dtirig =
+00042760: 2061 6e74 732e 7265 6769 7374 7261 7469   ants.registrati
+00042770: 6f6e 2820 6869 6572 5b27 6272 6169 6e5f  on( hier['brain_
+00042780: 6e34 5f64 6e7a 275d 2c20 6d79 6474 695b  n4_dnz'], mydti[
+00042790: 2772 6563 6f6e 5f66 6127 5d2c 2027 5269  'recon_fa'], 'Ri
+000427a0: 6769 6427 2029 0a20 2020 2020 2020 2020  gid' ).         
+000427b0: 2020 206e 6f72 6d61 6c69 7a61 7469 6f6e     normalization
+000427c0: 5f64 6963 745b 274d 445f 6e6f 726d 275d  _dict['MD_norm']
+000427d0: 203d 2061 6e74 732e 6170 706c 795f 7472   = ants.apply_tr
+000427e0: 616e 7366 6f72 6d73 2820 6772 6f75 705f  ansforms( group_
+000427f0: 7465 6d70 6c61 7465 2c20 6d79 6474 695b  template, mydti[
+00042800: 2772 6563 6f6e 5f6d 6427 5d2c 6772 6f75  'recon_md'],grou
+00042810: 705f 7472 616e 7366 6f72 6d2b 6474 6972  p_transform+dtir
+00042820: 6967 5b27 6677 6474 7261 6e73 666f 726d  ig['fwdtransform
+00042830: 7327 5d20 290a 2020 2020 2020 2020 2020  s'] ).          
+00042840: 2020 6e6f 726d 616c 697a 6174 696f 6e5f    normalization_
+00042850: 6469 6374 5b27 4641 5f6e 6f72 6d27 5d20  dict['FA_norm'] 
+00042860: 3d20 616e 7473 2e61 7070 6c79 5f74 7261  = ants.apply_tra
+00042870: 6e73 666f 726d 7328 2067 726f 7570 5f74  nsforms( group_t
+00042880: 656d 706c 6174 652c 206d 7964 7469 5b27  emplate, mydti['
+00042890: 7265 636f 6e5f 6661 275d 2c67 726f 7570  recon_fa'],group
+000428a0: 5f74 7261 6e73 666f 726d 2b64 7469 7269  _transform+dtiri
+000428b0: 675b 2766 7764 7472 616e 7366 6f72 6d73  g['fwdtransforms
+000428c0: 275d 2029 0a20 2020 2020 2020 2020 2020  '] ).           
+000428d0: 206f 7574 7075 745f 6469 7265 6374 6f72   output_director
+000428e0: 7920 3d20 7465 6d70 6669 6c65 2e6d 6b64  y = tempfile.mkd
+000428f0: 7465 6d70 2829 0a20 2020 2020 2020 2020  temp().         
+00042900: 2020 2064 6f5f 6474 695f 6e6f 726d 3d46     do_dti_norm=F
+00042910: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
+00042920: 2069 6620 646f 5f64 7469 5f6e 6f72 6d3a   if do_dti_norm:
+00042930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00042940: 2063 6f6d 7074 7820 3d20 616e 7473 2e61   comptx = ants.a
+00042950: 7070 6c79 5f74 7261 6e73 666f 726d 7328  pply_transforms(
+00042960: 2067 726f 7570 5f74 656d 706c 6174 652c   group_template,
+00042970: 2067 726f 7570 5f74 656d 706c 6174 652c   group_template,
+00042980: 2067 726f 7570 5f74 7261 6e73 666f 726d   group_transform
+00042990: 2b64 7469 7269 675b 2766 7764 7472 616e  +dtirig['fwdtran
+000429a0: 7366 6f72 6d73 275d 2c20 636f 6d70 6f73  sforms'], compos
+000429b0: 6520 3d20 6f75 7470 7574 5f64 6972 6563  e = output_direc
+000429c0: 746f 7279 202b 2027 2f78 7878 2720 290a  tory + '/xxx' ).
+000429d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000429e0: 7473 7063 3d5b 322e 2c32 2e2c 322e 5d0a  tspc=[2.,2.,2.].
+000429f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042a00: 6966 2073 726d 6f64 656c 2069 7320 6e6f  if srmodel is no
+00042a10: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00042a20: 2020 2020 2020 2020 2020 2020 7473 7063              tspc
+00042a30: 3d5b 312e 2c31 2e2c 312e 5d0a 2020 2020  =[1.,1.,1.].    
+00042a40: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+00042a50: 705f 7465 6d70 6c61 7465 326d 6d20 3d20  p_template2mm = 
+00042a60: 616e 7473 2e72 6573 616d 706c 655f 696d  ants.resample_im
+00042a70: 6167 6528 2067 726f 7570 5f74 656d 706c  age( group_templ
+00042a80: 6174 652c 2074 7370 6320 2029 0a20 2020  ate, tspc  ).   
+00042a90: 2020 2020 2020 2020 2020 2020 206e 6f72               nor
+00042aa0: 6d61 6c69 7a61 7469 6f6e 5f64 6963 745b  malization_dict[
+00042ab0: 2744 5449 5f6e 6f72 6d27 5d20 3d20 7472  'DTI_norm'] = tr
+00042ac0: 616e 7366 6f72 6d5f 616e 645f 7265 6f72  ansform_and_reor
+00042ad0: 6965 6e74 5f64 7469 2820 6772 6f75 705f  ient_dti( group_
+00042ae0: 7465 6d70 6c61 7465 326d 6d2c 206d 7964  template2mm, myd
+00042af0: 7469 5b27 6474 6927 5d2c 2063 6f6d 7074  ti['dti'], compt
+00042b00: 782c 2070 795f 6261 7365 643d 5472 7565  x, py_based=True
+00042b10: 2c20 7665 7262 6f73 653d 5472 7565 2029  , verbose=True )
+00042b20: 0a20 2020 2020 2020 2020 2020 2069 6d70  .            imp
+00042b30: 6f72 7420 7368 7574 696c 0a20 2020 2020  ort shutil.     
+00042b40: 2020 2020 2020 2073 6875 7469 6c2e 726d         shutil.rm
+00042b50: 7472 6565 286f 7574 7075 745f 6469 7265  tree(output_dire
+00042b60: 6374 6f72 792c 2069 676e 6f72 655f 6572  ctory, ignore_er
+00042b70: 726f 7273 3d54 7275 6520 290a 2020 2020  rors=True ).    
+00042b80: 2020 2020 6966 206f 7574 7075 745f 6469      if output_di
+00042b90: 6374 5b27 7273 6627 5d20 6973 206e 6f74  ct['rsf'] is not
+00042ba0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00042bb0: 2020 2069 6620 4661 6c73 653a 0a20 2020     if False:.   
+00042bc0: 2020 2020 2020 2020 2020 2020 2072 7366               rsf
+00042bd0: 7072 6f20 3d20 6f75 7470 7574 5f64 6963  pro = output_dic
+00042be0: 745b 2772 7366 275d 2023 2046 4958 4d45  t['rsf'] # FIXME
+00042bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00042c00: 2072 7366 7269 6720 3d20 616e 7473 2e72   rsfrig = ants.r
+00042c10: 6567 6973 7472 6174 696f 6e28 2068 6965  egistration( hie
+00042c20: 725b 2762 7261 696e 5f6e 345f 646e 7a27  r['brain_n4_dnz'
+00042c30: 5d2c 2072 7366 7072 6f5b 276d 6561 6e42  ], rsfpro['meanB
+00042c40: 6f6c 6427 5d2c 2027 5269 6769 6427 2029  old'], 'Rigid' )
+00042c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00042c60: 2066 6f72 206e 6574 6964 2069 6e20 6765   for netid in ge
+00042c70: 745f 616e 7473 696d 6167 655f 6b65 7973  t_antsimage_keys
+00042c80: 2820 7273 6670 726f 2029 3a0a 2020 2020  ( rsfpro ):.    
+00042c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042ca0: 7273 666b 6579 203d 206e 6574 6964 202b  rsfkey = netid +
+00042cb0: 2022 5f6e 6f72 6d22 0a20 2020 2020 2020   "_norm".       
+00042cc0: 2020 2020 2020 2020 2020 2020 206e 6f72               nor
+00042cd0: 6d61 6c69 7a61 7469 6f6e 5f64 6963 745b  malization_dict[
+00042ce0: 7273 666b 6579 5d20 3d20 616e 7473 2e61  rsfkey] = ants.a
+00042cf0: 7070 6c79 5f74 7261 6e73 666f 726d 7328  pply_transforms(
+00042d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00042d10: 2020 2020 2020 2020 2067 726f 7570 5f74           group_t
+00042d20: 656d 706c 6174 652c 2072 7366 7072 6f5b  emplate, rsfpro[
+00042d30: 6e65 7469 645d 2c0a 2020 2020 2020 2020  netid],.        
+00042d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042d50: 6772 6f75 705f 7472 616e 7366 6f72 6d2b  group_transform+
+00042d60: 7273 6672 6967 5b27 6677 6474 7261 6e73  rsfrig['fwdtrans
+00042d70: 666f 726d 7327 5d20 290a 2020 2020 2020  forms'] ).      
+00042d80: 2020 6966 206f 7574 7075 745f 6469 6374    if output_dict
+00042d90: 5b27 7065 7266 275d 2069 7320 6e6f 7420  ['perf'] is not 
+00042da0: 4e6f 6e65 3a20 2320 7a69 7a7a 6572 0a20  None: # zizzer. 
+00042db0: 2020 2020 2020 2020 2020 2063 6f6d 7074             compt
+00042dc0: 7820 3d20 6772 6f75 705f 7472 616e 7366  x = group_transf
+00042dd0: 6f72 6d20 2b20 6f75 7470 7574 5f64 6963  orm + output_dic
+00042de0: 745b 2770 6572 6627 5d5b 2774 3172 6567  t['perf']['t1reg
+00042df0: 275d 5b27 696e 7674 7261 6e73 666f 726d  ']['invtransform
+00042e00: 7327 5d0a 2020 2020 2020 2020 2020 2020  s'].            
+00042e10: 6e6f 726d 616c 697a 6174 696f 6e5f 6469  normalization_di
+00042e20: 6374 5b27 7065 7266 5f6e 6f72 6d27 5d20  ct['perf_norm'] 
+00042e30: 3d20 616e 7473 2e61 7070 6c79 5f74 7261  = ants.apply_tra
+00042e40: 6e73 666f 726d 7328 2067 726f 7570 5f74  nsforms( group_t
+00042e50: 656d 706c 6174 652c 0a20 2020 2020 2020  emplate,.       
+00042e60: 2020 2020 2020 2020 206f 7574 7075 745f           output_
+00042e70: 6469 6374 5b27 7065 7266 275d 5b27 7065  dict['perf']['pe
+00042e80: 7266 7573 696f 6e27 5d2c 2063 6f6d 7074  rfusion'], compt
+00042e90: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+00042ea0: 2020 2077 6869 6368 746f 696e 7665 7274     whichtoinvert
+00042eb0: 3d5b 4661 6c73 652c 4661 6c73 652c 5472  =[False,False,Tr
+00042ec0: 7565 2c46 616c 7365 5d20 290a 2020 2020  ue,False] ).    
+00042ed0: 2020 2020 2020 2020 6e6f 726d 616c 697a          normaliz
+00042ee0: 6174 696f 6e5f 6469 6374 5b27 6362 665f  ation_dict['cbf_
+00042ef0: 6e6f 726d 275d 203d 2061 6e74 732e 6170  norm'] = ants.ap
+00042f00: 706c 795f 7472 616e 7366 6f72 6d73 2820  ply_transforms( 
+00042f10: 6772 6f75 705f 7465 6d70 6c61 7465 2c0a  group_template,.
+00042f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042f30: 6f75 7470 7574 5f64 6963 745b 2770 6572  output_dict['per
+00042f40: 6627 5d5b 2763 6266 275d 2c20 636f 6d70  f']['cbf'], comp
+00042f50: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+00042f60: 2020 2020 7768 6963 6874 6f69 6e76 6572      whichtoinver
+00042f70: 743d 5b46 616c 7365 2c46 616c 7365 2c54  t=[False,False,T
+00042f80: 7275 652c 4661 6c73 655d 2029 0a20 2020  rue,False] ).   
+00042f90: 2020 2020 2069 6620 6e6d 5f69 6d61 6765       if nm_image
+00042fa0: 5f6c 6973 7420 6973 206e 6f74 204e 6f6e  _list is not Non
+00042fb0: 653a 0a20 2020 2020 2020 2020 2020 206e  e:.            n
+00042fc0: 6d70 726f 203d 206f 7574 7075 745f 6469  mpro = output_di
+00042fd0: 6374 5b27 4e4d 275d 0a20 2020 2020 2020  ct['NM'].       
+00042fe0: 2020 2020 206e 6d72 6967 203d 206e 6d70       nmrig = nmp
+00042ff0: 726f 5b27 7431 5f74 6f5f 4e4d 5f74 7261  ro['t1_to_NM_tra
+00043000: 6e73 666f 726d 275d 2023 2074 6869 7320  nsform'] # this 
+00043010: 6973 2061 6e20 696e 7665 7273 6520 7478  is an inverse tx
+00043020: 0a20 2020 2020 2020 2020 2020 206e 6f72  .            nor
+00043030: 6d61 6c69 7a61 7469 6f6e 5f64 6963 745b  malization_dict[
+00043040: 274e 4d5f 6e6f 726d 275d 203d 2061 6e74  'NM_norm'] = ant
+00043050: 732e 6170 706c 795f 7472 616e 7366 6f72  s.apply_transfor
+00043060: 6d73 2820 6772 6f75 705f 7465 6d70 6c61  ms( group_templa
+00043070: 7465 2c20 6e6d 7072 6f5b 274e 4d5f 6176  te, nmpro['NM_av
+00043080: 6727 5d2c 2067 726f 7570 5f74 7261 6e73  g'], group_trans
+00043090: 666f 726d 2b6e 6d72 6967 2c0a 2020 2020  form+nmrig,.    
+000430a0: 2020 2020 2020 2020 2020 2020 7768 6963              whic
+000430b0: 6874 6f69 6e76 6572 743d 5b46 616c 7365  htoinvert=[False
+000430c0: 2c46 616c 7365 2c54 7275 655d 290a 0a20  ,False,True]).. 
+000430d0: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
+000430e0: 2020 2020 2020 2070 7269 6e74 2827 6d6d         print('mm
+000430f0: 2064 6f6e 6527 290a 2020 2020 7265 7475   done').    retu
+00043100: 726e 206f 7574 7075 745f 6469 6374 2c20  rn output_dict, 
+00043110: 6e6f 726d 616c 697a 6174 696f 6e5f 6469  normalization_di
+00043120: 6374 0a0a 0a64 6566 2077 7269 7465 5f6d  ct...def write_m
+00043130: 6d28 206f 7574 7075 745f 7072 6566 6978  m( output_prefix
+00043140: 2c20 6d6d 2c20 6d6d 5f6e 6f72 6d3d 4e6f  , mm, mm_norm=No
+00043150: 6e65 2c20 7431 7769 6465 3d4e 6f6e 652c  ne, t1wide=None,
+00043160: 2073 6570 6172 6174 6f72 3d27 5f27 2c20   separator='_', 
+00043170: 7665 7262 6f73 653d 4661 6c73 6520 293a  verbose=False ):
+00043180: 0a20 2020 2022 2222 0a20 2020 2077 7269  .    """.    wri
+00043190: 7465 2074 6865 2074 6162 756c 6172 2061  te the tabular a
+000431a0: 6e64 206e 6f72 6d61 6c69 7a61 7469 6f6e  nd normalization
+000431b0: 206f 7574 7075 7420 6f66 2074 6865 206d   output of the m
+000431c0: 6d20 6675 6e63 7469 6f6e 0a0a 2020 2020  m function..    
+000431d0: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
+000431e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a0a 2020  ------------..  
+000431f0: 2020 6f75 7470 7574 5f70 7265 6669 7820    output_prefix 
+00043200: 3a20 7072 6566 6978 2066 6f72 2066 696c  : prefix for fil
+00043210: 6520 6f75 7470 7574 7320 2d20 6d6f 6461  e outputs - moda
+00043220: 6c69 7479 2073 7065 6369 6669 6320 706f  lity specific po
+00043230: 7374 6669 7820 7769 6c6c 2062 6520 6164  stfix will be ad
+00043240: 6465 640a 0a20 2020 206d 6d20 203a 206f  ded..    mm  : o
+00043250: 7574 7075 7420 6f66 206d 6d20 6675 6e63  utput of mm func
+00043260: 7469 6f6e 2066 6f72 206d 6f64 616c 6974  tion for modalit
+00043270: 792d 7370 6163 6520 7072 6f63 6573 7369  y-space processi
+00043280: 6e67 2073 686f 756c 6420 6265 2061 2064  ng should be a d
+00043290: 6963 7469 6f6e 6172 7920 7769 7468 200a  ictionary with .
+000432a0: 2020 2020 2020 2020 6469 6374 696f 6e61          dictiona
+000432b0: 7279 2065 6e74 7269 6573 2066 6f72 2065  ry entries for e
+000432c0: 6163 6820 6d6f 6461 6c69 7479 2e0a 0a20  ach modality... 
+000432d0: 2020 206d 6d5f 6e6f 726d 203a 206f 7574     mm_norm : out
+000432e0: 7075 7420 6f66 206d 6d20 6675 6e63 7469  put of mm functi
+000432f0: 6f6e 2066 6f72 206e 6f72 6d61 6c69 7a65  on for normalize
+00043300: 6420 7072 6f63 6573 7369 6e67 0a0a 2020  d processing..  
+00043310: 2020 7431 7769 6465 203a 2077 6964 6520    t1wide : wide 
+00043320: 6f75 7470 7574 2064 6174 6120 6672 616d  output data fram
+00043330: 6520 6672 6f6d 2074 3120 6869 6572 6172  e from t1 hierar
+00043340: 6368 6963 616c 0a0a 2020 2020 7365 7061  chical..    sepa
+00043350: 7261 746f 7220 3a20 7374 7269 6e67 206f  rator : string o
+00043360: 7220 6368 6172 6163 7465 7220 7365 7061  r character sepa
+00043370: 7261 746f 7220 666f 7220 6669 6c65 6e61  rator for filena
+00043380: 6d65 730a 0a20 2020 2076 6572 626f 7365  mes..    verbose
+00043390: 203a 2062 6f6f 6c65 616e 0a0a 2020 2020   : boolean..    
+000433a0: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+000433b0: 2d2d 2d2d 2d0a 0a20 2020 2062 6f74 6820  -----..    both 
+000433c0: 6373 7620 616e 6420 696d 6167 6520 6669  csv and image fi
+000433d0: 6c65 7320 7772 6974 7465 6e20 746f 2064  les written to d
+000433e0: 6973 6b2e 2020 7468 6520 7072 696d 6172  isk.  the primar
+000433f0: 7920 6f75 7470 7574 7320 7769 6c6c 2062  y outputs will b
+00043400: 650a 2020 2020 6f75 7470 7574 5f70 7265  e.    output_pre
+00043410: 6669 7820 2b20 7365 7061 7261 746f 7220  fix + separator 
+00043420: 2b20 276d 6d77 6964 652e 6373 7627 2061  + 'mmwide.csv' a
+00043430: 6e64 202a 6e6f 726d 2e6e 6969 2e67 7a20  nd *norm.nii.gz 
+00043440: 696d 6167 6573 0a0a 2020 2020 2222 220a  images..    """.
+00043450: 2020 2020 6672 6f6d 2064 6970 792e 696f      from dipy.io
+00043460: 2e73 7472 6561 6d6c 696e 6520 696d 706f  .streamline impo
+00043470: 7274 2073 6176 655f 7472 6163 746f 6772  rt save_tractogr
+00043480: 616d 0a20 2020 2069 6620 6d6d 5f6e 6f72  am.    if mm_nor
+00043490: 6d20 6973 206e 6f74 204e 6f6e 653a 0a20  m is not None:. 
+000434a0: 2020 2020 2020 2066 6f72 206d 796b 6579         for mykey
+000434b0: 2069 6e20 6d6d 5f6e 6f72 6d3a 0a20 2020   in mm_norm:.   
+000434c0: 2020 2020 2020 2020 2074 656d 7066 6e20           tempfn 
+000434d0: 3d20 6f75 7470 7574 5f70 7265 6669 7820  = output_prefix 
+000434e0: 2b20 7365 7061 7261 746f 7220 2b20 6d79  + separator + my
+000434f0: 6b65 7920 2b20 272e 6e69 692e 677a 270a  key + '.nii.gz'.
+00043500: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00043510: 6d5f 6e6f 726d 5b6d 796b 6579 5d20 6973  m_norm[mykey] is
+00043520: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00043530: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+00043540: 5f77 7269 7465 5f77 6974 685f 7468 756d  _write_with_thum
+00043550: 626e 6169 6c28 206d 6d5f 6e6f 726d 5b6d  bnail( mm_norm[m
+00043560: 796b 6579 5d2c 2074 656d 7066 6e20 290a  ykey], tempfn ).
+00043570: 2020 2020 7468 6b64 6572 6b20 3d20 4e6f      thkderk = No
+00043580: 6e65 0a20 2020 2069 6620 7431 7769 6465  ne.    if t1wide
+00043590: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+000435a0: 2020 2020 2020 7468 6b64 6572 6b20 3d20        thkderk = 
+000435b0: 7431 7769 6465 2e69 6c6f 635b 3a20 2c20  t1wide.iloc[: , 
+000435c0: 313a 5d0a 2020 2020 6b6b 6465 726b 203d  1:].    kkderk =
+000435d0: 204e 6f6e 650a 2020 2020 6966 2027 6b6b   None.    if 'kk
+000435e0: 2720 696e 206d 6d3a 0a20 2020 2020 2020  ' in mm:.       
+000435f0: 2069 6620 6d6d 5b27 6b6b 275d 2069 7320   if mm['kk'] is 
+00043600: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00043610: 2020 2020 2020 6b6b 6465 726b 203d 206d        kkderk = m
+00043620: 6d5b 276b 6b27 5d5b 2774 6869 636b 6e65  m['kk']['thickne
+00043630: 7373 5f64 6174 6166 7261 6d65 275d 2e69  ss_dataframe'].i
+00043640: 6c6f 635b 3a20 2c20 313a 5d0a 2020 2020  loc[: , 1:].    
+00043650: 2020 2020 2020 2020 6d79 6b65 793d 2774          mykey='t
+00043660: 6869 636b 6e65 7373 5f69 6d61 6765 270a  hickness_image'.
+00043670: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
+00043680: 666e 203d 206f 7574 7075 745f 7072 6566  fn = output_pref
+00043690: 6978 202b 2073 6570 6172 6174 6f72 202b  ix + separator +
+000436a0: 206d 796b 6579 202b 2027 2e6e 6969 2e67   mykey + '.nii.g
+000436b0: 7a27 0a20 2020 2020 2020 2020 2020 2069  z'.            i
+000436c0: 6d61 6765 5f77 7269 7465 5f77 6974 685f  mage_write_with_
+000436d0: 7468 756d 626e 6169 6c28 206d 6d5b 276b  thumbnail( mm['k
+000436e0: 6b27 5d5b 6d79 6b65 795d 2c20 7465 6d70  k'][mykey], temp
+000436f0: 666e 2029 0a20 2020 206e 6d64 6572 6b20  fn ).    nmderk 
+00043700: 3d20 4e6f 6e65 0a20 2020 2069 6620 274e  = None.    if 'N
+00043710: 4d27 2069 6e20 6d6d 3a0a 2020 2020 2020  M' in mm:.      
+00043720: 2020 6966 206d 6d5b 274e 4d27 5d20 6973    if mm['NM'] is
+00043730: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00043740: 2020 2020 2020 206e 6d64 6572 6b20 3d20         nmderk = 
+00043750: 6d6d 5b27 4e4d 275d 5b27 4e4d 5f64 6174  mm['NM']['NM_dat
+00043760: 6166 7261 6d65 5f77 6964 6527 5d2e 696c  aframe_wide'].il
+00043770: 6f63 5b3a 202c 2031 3a5d 0a20 2020 2020  oc[: , 1:].     
+00043780: 2020 2020 2020 2066 6f72 206d 796b 6579         for mykey
+00043790: 2069 6e20 6765 745f 616e 7473 696d 6167   in get_antsimag
+000437a0: 655f 6b65 7973 2820 6d6d 5b27 4e4d 275d  e_keys( mm['NM']
+000437b0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+000437c0: 2020 2020 7465 6d70 666e 203d 206f 7574      tempfn = out
+000437d0: 7075 745f 7072 6566 6978 202b 2073 6570  put_prefix + sep
+000437e0: 6172 6174 6f72 202b 206d 796b 6579 202b  arator + mykey +
+000437f0: 2027 2e6e 6969 2e67 7a27 0a20 2020 2020   '.nii.gz'.     
+00043800: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+00043810: 5f77 7269 7465 5f77 6974 685f 7468 756d  _write_with_thum
+00043820: 626e 6169 6c28 206d 6d5b 274e 4d27 5d5b  bnail( mm['NM'][
+00043830: 6d79 6b65 795d 2c20 7465 6d70 666e 2c20  mykey], tempfn, 
+00043840: 7468 756d 623d 4661 6c73 6520 290a 0a20  thumb=False ).. 
+00043850: 2020 2066 6164 6572 6b20 3d20 6d64 6465     faderk = mdde
+00043860: 726b 203d 2066 6174 3164 6572 6b20 3d20  rk = fat1derk = 
+00043870: 6d64 7431 6465 726b 203d 204e 6f6e 650a  mdt1derk = None.
+00043880: 0a20 2020 2069 6620 2744 5449 2720 696e  .    if 'DTI' in
+00043890: 206d 6d3a 0a20 2020 2020 2020 2069 6620   mm:.        if 
+000438a0: 6d6d 5b27 4454 4927 5d20 6973 206e 6f74  mm['DTI'] is not
+000438b0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000438c0: 2020 206d 7964 7469 203d 206d 6d5b 2744     mydti = mm['D
+000438d0: 5449 275d 0a20 2020 2020 2020 2020 2020  TI'].           
+000438e0: 206d 796f 7020 3d20 6f75 7470 7574 5f70   myop = output_p
+000438f0: 7265 6669 7820 2b20 7365 7061 7261 746f  refix + separato
+00043900: 720a 2020 2020 2020 2020 2020 2020 616e  r.            an
+00043910: 7473 2e69 6d61 6765 5f77 7269 7465 2820  ts.image_write( 
+00043920: 6d79 6474 695b 2764 7469 275d 2c20 206d  mydti['dti'],  m
+00043930: 796f 7020 2b20 2764 7469 2e6e 6969 2e67  yop + 'dti.nii.g
+00043940: 7a27 2029 0a20 2020 2020 2020 2020 2020  z' ).           
+00043950: 2077 7269 7465 5f62 7661 6c73 5f62 7665   write_bvals_bve
+00043960: 6373 2820 6d79 6474 695b 2762 7661 6c5f  cs( mydti['bval_
+00043970: 4c52 275d 2c20 6d79 6474 695b 2762 7665  LR'], mydti['bve
+00043980: 635f 4c52 275d 2c20 6d79 6f70 202b 2027  c_LR'], myop + '
+00043990: 7265 6f72 6965 6e74 6564 2720 290a 2020  reoriented' ).  
+000439a0: 2020 2020 2020 2020 2020 696d 6167 655f            image_
+000439b0: 7772 6974 655f 7769 7468 5f74 6875 6d62  write_with_thumb
+000439c0: 6e61 696c 2820 6d79 6474 695b 2764 7769  nail( mydti['dwi
+000439d0: 5f4c 525f 6465 7761 7270 6564 275d 2c20  _LR_dewarped'], 
+000439e0: 206d 796f 7020 2b20 2764 7769 2e6e 6969   myop + 'dwi.nii
+000439f0: 2e67 7a27 2029 0a20 2020 2020 2020 2020  .gz' ).         
+00043a00: 2020 2069 6d61 6765 5f77 7269 7465 5f77     image_write_w
+00043a10: 6974 685f 7468 756d 626e 6169 6c28 206d  ith_thumbnail( m
+00043a20: 7964 7469 5b27 6474 7265 636f 6e5f 4c52  ydti['dtrecon_LR
+00043a30: 5f64 6577 6172 7027 5d5b 2752 4742 275d  _dewarp']['RGB']
+00043a40: 202c 2020 6d79 6f70 202b 2027 4454 4952   ,  myop + 'DTIR
+00043a50: 4742 2e6e 6969 2e67 7a27 2029 0a20 2020  GB.nii.gz' ).   
+00043a60: 2020 2020 2020 2020 2069 6d61 6765 5f77           image_w
+00043a70: 7269 7465 5f77 6974 685f 7468 756d 626e  rite_with_thumbn
+00043a80: 6169 6c28 206d 7964 7469 5b27 6a68 755f  ail( mydti['jhu_
+00043a90: 6c61 6265 6c73 275d 2c20 206d 796f 702b  labels'],  myop+
+00043aa0: 2764 7469 6a68 756c 6162 656c 732e 6e69  'dtijhulabels.ni
+00043ab0: 692e 677a 272c 206d 7964 7469 5b27 7265  i.gz', mydti['re
+00043ac0: 636f 6e5f 6661 275d 2029 0a20 2020 2020  con_fa'] ).     
+00043ad0: 2020 2020 2020 2069 6d61 6765 5f77 7269         image_wri
+00043ae0: 7465 5f77 6974 685f 7468 756d 626e 6169  te_with_thumbnai
+00043af0: 6c28 206d 7964 7469 5b27 7265 636f 6e5f  l( mydti['recon_
+00043b00: 6661 275d 2c20 206d 796f 702b 2764 7469  fa'],  myop+'dti
+00043b10: 6661 2e6e 6969 2e67 7a27 2029 0a20 2020  fa.nii.gz' ).   
+00043b20: 2020 2020 2020 2020 2069 6d61 6765 5f77           image_w
+00043b30: 7269 7465 5f77 6974 685f 7468 756d 626e  rite_with_thumbn
+00043b40: 6169 6c28 206d 7964 7469 5b27 7265 636f  ail( mydti['reco
+00043b50: 6e5f 6d64 275d 2c20 206d 796f 702b 2764  n_md'],  myop+'d
+00043b60: 7469 6d64 2e6e 6969 2e67 7a27 2029 0a20  timd.nii.gz' ). 
+00043b70: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+00043b80: 5f77 7269 7465 5f77 6974 685f 7468 756d  _write_with_thum
+00043b90: 626e 6169 6c28 206d 7964 7469 5b27 6230  bnail( mydti['b0
+00043ba0: 6176 6727 5d2c 2020 6d79 6f70 2b27 6230  avg'],  myop+'b0
+00043bb0: 6176 672e 6e69 692e 677a 2720 290a 2020  avg.nii.gz' ).  
+00043bc0: 2020 2020 2020 2020 2020 696d 6167 655f            image_
+00043bd0: 7772 6974 655f 7769 7468 5f74 6875 6d62  write_with_thumb
+00043be0: 6e61 696c 2820 6d79 6474 695b 2764 7769  nail( mydti['dwi
+00043bf0: 6176 6727 5d2c 2020 6d79 6f70 2b27 6477  avg'],  myop+'dw
+00043c00: 6961 7667 2e6e 6969 2e67 7a27 2029 0a20  iavg.nii.gz' ). 
+00043c10: 2020 2020 2020 2020 2020 2066 6164 6572             fader
+00043c20: 6b20 3d20 6d6d 5b27 4454 4927 5d5b 2772  k = mm['DTI']['r
+00043c30: 6563 6f6e 5f66 615f 7375 6d6d 6172 7927  econ_fa_summary'
+00043c40: 5d2e 696c 6f63 5b3a 202c 2031 3a5d 0a20  ].iloc[: , 1:]. 
+00043c50: 2020 2020 2020 2020 2020 206d 6464 6572             mdder
+00043c60: 6b20 3d20 6d6d 5b27 4454 4927 5d5b 2772  k = mm['DTI']['r
+00043c70: 6563 6f6e 5f6d 645f 7375 6d6d 6172 7927  econ_md_summary'
+00043c80: 5d2e 696c 6f63 5b3a 202c 2031 3a5d 0a20  ].iloc[: , 1:]. 
+00043c90: 2020 2020 2020 2020 2020 2066 6174 3164             fat1d
+00043ca0: 6572 6b20 3d20 6d6d 5b27 4641 5f73 756d  erk = mm['FA_sum
+00043cb0: 6d27 5d2e 696c 6f63 5b3a 202c 2031 3a5d  m'].iloc[: , 1:]
+00043cc0: 0a20 2020 2020 2020 2020 2020 206d 6474  .            mdt
+00043cd0: 3164 6572 6b20 3d20 6d6d 5b27 4d44 5f73  1derk = mm['MD_s
+00043ce0: 756d 6d27 5d2e 696c 6f63 5b3a 202c 2031  umm'].iloc[: , 1
+00043cf0: 3a5d 0a20 2020 2069 6620 2774 7261 6374  :].    if 'tract
+00043d00: 6f67 7261 7068 7927 2069 6e20 6d6d 3a0a  ography' in mm:.
+00043d10: 2020 2020 2020 2020 6966 206d 6d5b 2774          if mm['t
+00043d20: 7261 6374 6f67 7261 7068 7927 5d20 6973  ractography'] is
+00043d30: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00043d40: 2020 2020 2020 206f 666e 203d 206f 7574         ofn = out
+00043d50: 7075 745f 7072 6566 6978 202b 2073 6570  put_prefix + sep
+00043d60: 6172 6174 6f72 202b 2027 7472 6163 746f  arator + 'tracto
+00043d70: 6772 616d 2e74 726b 270a 2020 2020 2020  gram.trk'.      
+00043d80: 2020 2020 2020 7361 7665 5f74 7261 6374        save_tract
+00043d90: 6f67 7261 6d28 206d 6d5b 2774 7261 6374  ogram( mm['tract
+00043da0: 6f67 7261 7068 7927 5d5b 2774 7261 6374  ography']['tract
+00043db0: 6f67 7261 6d27 5d2c 206f 666e 2029 0a20  ogram'], ofn ). 
+00043dc0: 2020 2063 6e78 6465 726b 203d 204e 6f6e     cnxderk = Non
+00043dd0: 650a 2020 2020 6966 2027 7472 6163 746f  e.    if 'tracto
+00043de0: 6772 6170 6879 5f63 6f6e 6e65 6374 6976  graphy_connectiv
+00043df0: 6974 7927 2069 6e20 6d6d 3a0a 2020 2020  ity' in mm:.    
+00043e00: 2020 2020 6966 206d 6d5b 2774 7261 6374      if mm['tract
+00043e10: 6f67 7261 7068 795f 636f 6e6e 6563 7469  ography_connecti
+00043e20: 7669 7479 275d 2069 7320 6e6f 7420 4e6f  vity'] is not No
+00043e30: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00043e40: 636e 7864 6572 6b20 3d20 6d6d 5b27 7472  cnxderk = mm['tr
+00043e50: 6163 746f 6772 6170 6879 5f63 6f6e 6e65  actography_conne
+00043e60: 6374 6976 6974 7927 5d5b 2763 6f6e 6e65  ctivity']['conne
+00043e70: 6374 6976 6974 795f 7769 6465 275d 2e69  ctivity_wide'].i
+00043e80: 6c6f 635b 3a20 2c20 313a 5d20 2320 4e4f  loc[: , 1:] # NO
+00043e90: 5445 3a20 636f 6e6e 6563 7469 7669 7479  TE: connectivity
+00043ea0: 5f77 6964 6520 6973 206e 6f74 206d 7563  _wide is not muc
+00043eb0: 6820 7465 7374 6564 0a20 2020 2020 2020  h tested.       
+00043ec0: 2020 2020 206f 666e 203d 206f 7574 7075       ofn = outpu
+00043ed0: 745f 7072 6566 6978 202b 2073 6570 6172  t_prefix + separ
+00043ee0: 6174 6f72 202b 2027 6474 6973 7472 6561  ator + 'dtistrea
+00043ef0: 6d6c 696e 6563 6f6e 6e2e 6373 7627 0a20  mlineconn.csv'. 
+00043f00: 2020 2020 2020 2020 2020 2070 642e 4461             pd.Da
+00043f10: 7461 4672 616d 6528 6d6d 5b27 7472 6163  taFrame(mm['trac
+00043f20: 746f 6772 6170 6879 5f63 6f6e 6e65 6374  tography_connect
+00043f30: 6976 6974 7927 5d5b 2763 6f6e 6e65 6374  ivity']['connect
+00043f40: 6976 6974 795f 6d61 7472 6978 275d 292e  ivity_matrix']).
+00043f50: 746f 5f63 7376 2820 6f66 6e20 290a 0a20  to_csv( ofn ).. 
+00043f60: 2020 2064 6c69 7374 203d 205b 0a20 2020     dlist = [.   
+00043f70: 2020 2020 2074 686b 6465 726b 2c0a 2020       thkderk,.  
+00043f80: 2020 2020 2020 6b6b 6465 726b 2c0a 2020        kkderk,.  
+00043f90: 2020 2020 2020 6e6d 6465 726b 2c0a 2020        nmderk,.  
+00043fa0: 2020 2020 2020 6661 6465 726b 2c0a 2020        faderk,.  
+00043fb0: 2020 2020 2020 6d64 6465 726b 2c0a 2020        mdderk,.  
+00043fc0: 2020 2020 2020 6661 7431 6465 726b 2c0a        fat1derk,.
+00043fd0: 2020 2020 2020 2020 6d64 7431 6465 726b          mdt1derk
+00043fe0: 2c0a 2020 2020 2020 2020 636e 7864 6572  ,.        cnxder
+00043ff0: 6b0a 2020 2020 2020 2020 5d0a 2020 2020  k.        ].    
+00044000: 6973 5f61 6c6c 5f6e 6f6e 6520 3d20 616c  is_all_none = al
+00044010: 6c28 656c 656d 656e 7420 6973 204e 6f6e  l(element is Non
+00044020: 6520 666f 7220 656c 656d 656e 7420 696e  e for element in
+00044030: 2064 6c69 7374 290a 2020 2020 6966 2069   dlist).    if i
+00044040: 735f 616c 6c5f 6e6f 6e65 3a0a 2020 2020  s_all_none:.    
+00044050: 2020 2020 6d6d 5f77 6964 6520 3d20 7064      mm_wide = pd
+00044060: 2e44 6174 6146 7261 6d65 287b 2775 5f68  .DataFrame({'u_h
+00044070: 6965 725f 6964 273a 205b 6f75 7470 7574  ier_id': [output
+00044080: 5f70 7265 6669 785d 207d 290a 2020 2020  _prefix] }).    
+00044090: 656c 7365 3a0a 2020 2020 2020 2020 6d6d  else:.        mm
+000440a0: 5f77 6964 6520 3d20 7064 2e63 6f6e 6361  _wide = pd.conca
+000440b0: 7428 2064 6c69 7374 2c20 6178 6973 3d31  t( dlist, axis=1
+000440c0: 2c20 6967 6e6f 7265 5f69 6e64 6578 3d46  , ignore_index=F
+000440d0: 616c 7365 2029 0a0a 2020 2020 6d6d 5f77  alse )..    mm_w
+000440e0: 6964 6520 3d20 6d6d 5f77 6964 652e 636f  ide = mm_wide.co
+000440f0: 7079 2829 0a20 2020 2069 6620 274e 4d27  py().    if 'NM'
+00044100: 2069 6e20 6d6d 3a0a 2020 2020 2020 2020   in mm:.        
+00044110: 6966 206d 6d5b 274e 4d27 5d20 6973 206e  if mm['NM'] is n
+00044120: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00044130: 2020 2020 206e 6d77 6964 6520 3d20 6469       nmwide = di
+00044140: 6374 5f74 6f5f 6461 7461 6672 616d 6528  ct_to_dataframe(
+00044150: 206d 6d5b 274e 4d27 5d20 290a 2020 2020   mm['NM'] ).    
+00044160: 2020 2020 2020 2020 6966 206d 6d5f 7769          if mm_wi
+00044170: 6465 2e73 6861 7065 5b30 5d20 3e20 3020  de.shape[0] > 0 
+00044180: 616e 6420 6e6d 7769 6465 2e73 6861 7065  and nmwide.shape
+00044190: 5b30 5d20 3e20 303a 0a20 2020 2020 2020  [0] > 0:.       
+000441a0: 2020 2020 2020 2020 206e 6d77 6964 652e           nmwide.
+000441b0: 7365 745f 696e 6465 7828 206d 6d5f 7769  set_index( mm_wi
+000441c0: 6465 2e69 6e64 6578 2c20 696e 706c 6163  de.index, inplac
+000441d0: 653d 5472 7565 2029 0a20 2020 2020 2020  e=True ).       
+000441e0: 2020 2020 206d 6d5f 7769 6465 203d 2070       mm_wide = p
+000441f0: 642e 636f 6e63 6174 2820 5b6d 6d5f 7769  d.concat( [mm_wi
+00044200: 6465 2c20 6e6d 7769 6465 205d 2c20 6178  de, nmwide ], ax
+00044210: 6973 3d31 2c20 6967 6e6f 7265 5f69 6e64  is=1, ignore_ind
+00044220: 6578 3d46 616c 7365 2029 0a20 2020 2069  ex=False ).    i
+00044230: 6620 2766 6c61 6972 2720 696e 206d 6d3a  f 'flair' in mm:
+00044240: 0a20 2020 2020 2020 2069 6620 6d6d 5b27  .        if mm['
+00044250: 666c 6169 7227 5d20 6973 206e 6f74 204e  flair'] is not N
+00044260: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00044270: 206d 796f 7020 3d20 6f75 7470 7574 5f70   myop = output_p
+00044280: 7265 6669 7820 2b20 7365 7061 7261 746f  refix + separato
+00044290: 7220 2b20 2777 6d68 2e6e 6969 2e67 7a27  r + 'wmh.nii.gz'
+000442a0: 0a20 2020 2020 2020 2020 2020 2070 6e67  .            png
+000442b0: 666e 6220 3d20 6f75 7470 7574 5f70 7265  fnb = output_pre
+000442c0: 6669 7820 2b20 7365 7061 7261 746f 7220  fix + separator 
+000442d0: 2b20 2777 6d68 5f73 6567 2e70 6e67 270a  + 'wmh_seg.png'.
+000442e0: 2020 2020 2020 2020 2020 2020 616e 7473              ants
+000442f0: 2e70 6c6f 7428 206d 6d5b 2766 6c61 6972  .plot( mm['flair
+00044300: 275d 5b27 666c 6169 7227 5d2c 206d 6d5b  ']['flair'], mm[
+00044310: 2766 6c61 6972 275d 5b27 574d 485f 706f  'flair']['WMH_po
+00044320: 7374 6572 696f 725f 7072 6f62 6162 696c  sterior_probabil
+00044330: 6974 795f 6d61 7027 5d2c 2061 7869 733d  ity_map'], axis=
+00044340: 322c 206e 736c 6963 6573 3d32 312c 206e  2, nslices=21, n
+00044350: 636f 6c3d 372c 2066 696c 656e 616d 653d  col=7, filename=
+00044360: 706e 6766 6e62 2c20 6372 6f70 3d54 7275  pngfnb, crop=Tru
+00044370: 6520 290a 2020 2020 2020 2020 2020 2020  e ).            
+00044380: 6966 206d 6d5b 2766 6c61 6972 275d 5b27  if mm['flair']['
+00044390: 574d 485f 7072 6f62 6162 696c 6974 795f  WMH_probability_
+000443a0: 6d61 7027 5d20 6973 206e 6f74 204e 6f6e  map'] is not Non
+000443b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000443c0: 2020 2069 6d61 6765 5f77 7269 7465 5f77     image_write_w
+000443d0: 6974 685f 7468 756d 626e 6169 6c28 206d  ith_thumbnail( m
+000443e0: 6d5b 2766 6c61 6972 275d 5b27 574d 485f  m['flair']['WMH_
+000443f0: 7072 6f62 6162 696c 6974 795f 6d61 7027  probability_map'
+00044400: 5d2c 206d 796f 702c 2074 6875 6d62 3d46  ], myop, thumb=F
+00044410: 616c 7365 2029 0a20 2020 2020 2020 2020  alse ).         
+00044420: 2020 2066 6c77 6964 6520 3d20 6469 6374     flwide = dict
+00044430: 5f74 6f5f 6461 7461 6672 616d 6528 206d  _to_dataframe( m
+00044440: 6d5b 2766 6c61 6972 275d 2029 0a20 2020  m['flair'] ).   
+00044450: 2020 2020 2020 2020 2069 6620 6d6d 5f77           if mm_w
+00044460: 6964 652e 7368 6170 655b 305d 203e 2030  ide.shape[0] > 0
+00044470: 2061 6e64 2066 6c77 6964 652e 7368 6170   and flwide.shap
+00044480: 655b 305d 203e 2030 3a0a 2020 2020 2020  e[0] > 0:.      
+00044490: 2020 2020 2020 2020 2020 666c 7769 6465            flwide
+000444a0: 2e73 6574 5f69 6e64 6578 2820 6d6d 5f77  .set_index( mm_w
+000444b0: 6964 652e 696e 6465 782c 2069 6e70 6c61  ide.index, inpla
+000444c0: 6365 3d54 7275 6520 290a 2020 2020 2020  ce=True ).      
+000444d0: 2020 2020 2020 6d6d 5f77 6964 6520 3d20        mm_wide = 
+000444e0: 7064 2e63 6f6e 6361 7428 205b 6d6d 5f77  pd.concat( [mm_w
+000444f0: 6964 652c 2066 6c77 6964 6520 5d2c 2061  ide, flwide ], a
+00044500: 7869 733d 312c 2069 676e 6f72 655f 696e  xis=1, ignore_in
+00044510: 6465 783d 4661 6c73 6520 290a 2020 2020  dex=False ).    
+00044520: 6966 2027 7273 6627 2069 6e20 6d6d 3a0a  if 'rsf' in mm:.
+00044530: 2020 2020 2020 2020 6966 206d 6d5b 2772          if mm['r
+00044540: 7366 275d 2069 7320 6e6f 7420 4e6f 6e65  sf'] is not None
+00044550: 3a0a 2020 2020 2020 2020 2020 2020 6663  :.            fc
+00044560: 6e78 7072 6f3d 3939 0a20 2020 2020 2020  nxpro=99.       
+00044570: 2020 2020 2072 7366 6461 7461 203d 206d       rsfdata = m
+00044580: 6d5b 2772 7366 275d 0a20 2020 2020 2020  m['rsf'].       
+00044590: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
+000445a0: 7374 616e 6365 2820 7273 6664 6174 612c  stance( rsfdata,
+000445b0: 206c 6973 7420 293a 0a20 2020 2020 2020   list ):.       
+000445c0: 2020 2020 2020 2020 2072 7366 6461 7461           rsfdata
+000445d0: 203d 205b 2072 7366 6461 7461 205d 0a20   = [ rsfdata ]. 
+000445e0: 2020 2020 2020 2020 2020 2066 6f72 2072             for r
+000445f0: 7366 7072 6f20 696e 2072 7366 6461 7461  sfpro in rsfdata
+00044600: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00044610: 2020 6663 6e78 7072 6f3d 7374 7228 2072    fcnxpro=str( r
+00044620: 7366 7072 6f5b 2770 6172 616d 7365 7427  sfpro['paramset'
+00044630: 5d20 2029 0a20 2020 2020 2020 2020 2020  ]  ).           
+00044640: 2020 2020 2070 726f 6e75 6d20 3d20 2766       pronum = 'f
+00044650: 636e 7870 726f 272b 7374 7228 6663 6e78  cnxpro'+str(fcnx
+00044660: 7072 6f29 2b22 5f22 0a20 2020 2020 2020  pro)+"_".       
+00044670: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
+00044680: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+00044690: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
+000446a0: 436f 6c6c 6563 7420 7273 6620 6461 7461  Collect rsf data
+000446b0: 2022 202b 2070 726f 6e75 6d29 0a20 2020   " + pronum).   
+000446c0: 2020 2020 2020 2020 2020 2020 206e 6577               new
+000446d0: 5f72 7366 5f77 6964 6520 3d20 6469 6374  _rsf_wide = dict
+000446e0: 5f74 6f5f 6461 7461 6672 616d 6528 2072  _to_dataframe( r
+000446f0: 7366 7072 6f20 290a 2020 2020 2020 2020  sfpro ).        
+00044700: 2020 2020 2020 2020 6e65 775f 7273 665f          new_rsf_
+00044710: 7769 6465 203d 2070 642e 636f 6e63 6174  wide = pd.concat
+00044720: 2820 5b6e 6577 5f72 7366 5f77 6964 652c  ( [new_rsf_wide,
+00044730: 2072 7366 7072 6f5b 2763 6f72 725f 7769   rsfpro['corr_wi
+00044740: 6465 275d 205d 2c20 6178 6973 3d31 2c20  de'] ], axis=1, 
+00044750: 6967 6e6f 7265 5f69 6e64 6578 3d46 616c  ignore_index=Fal
+00044760: 7365 2029 0a20 2020 2020 2020 2020 2020  se ).           
+00044770: 2020 2020 206e 6577 5f72 7366 5f77 6964       new_rsf_wid
+00044780: 6520 3d20 6e65 775f 7273 665f 7769 6465  e = new_rsf_wide
+00044790: 2e61 6464 5f70 7265 6669 7828 2070 726f  .add_prefix( pro
+000447a0: 6e75 6d20 290a 2020 2020 2020 2020 2020  num ).          
+000447b0: 2020 2020 2020 6e65 775f 7273 665f 7769        new_rsf_wi
+000447c0: 6465 2e73 6574 5f69 6e64 6578 2820 6d6d  de.set_index( mm
+000447d0: 5f77 6964 652e 696e 6465 782c 2069 6e70  _wide.index, inp
+000447e0: 6c61 6365 3d54 7275 6520 290a 2020 2020  lace=True ).    
+000447f0: 2020 2020 2020 2020 2020 2020 6f66 6e20              ofn 
+00044800: 3d20 6f75 7470 7574 5f70 7265 6669 7820  = output_prefix 
+00044810: 2b20 7365 7061 7261 746f 7220 2b20 7072  + separator + pr
+00044820: 6f6e 756d 202b 2027 2e63 7376 270a 2020  onum + '.csv'.  
+00044830: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+00044840: 775f 7273 665f 7769 6465 2e74 6f5f 6373  w_rsf_wide.to_cs
+00044850: 7628 206f 666e 2029 0a20 2020 2020 2020  v( ofn ).       
+00044860: 2020 2020 2020 2020 206d 6d5f 7769 6465           mm_wide
+00044870: 203d 2070 642e 636f 6e63 6174 2820 5b6d   = pd.concat( [m
+00044880: 6d5f 7769 6465 2c20 6e65 775f 7273 665f  m_wide, new_rsf_
+00044890: 7769 6465 205d 2c20 6178 6973 3d31 2c20  wide ], axis=1, 
+000448a0: 6967 6e6f 7265 5f69 6e64 6578 3d46 616c  ignore_index=Fal
+000448b0: 7365 2029 0a20 2020 2020 2020 2020 2020  se ).           
+000448c0: 2020 2020 2066 6f72 206d 796b 6579 2069       for mykey i
+000448d0: 6e20 6765 745f 616e 7473 696d 6167 655f  n get_antsimage_
+000448e0: 6b65 7973 2820 7273 6670 726f 2029 3a0a  keys( rsfpro ):.
+000448f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044900: 2020 2020 6d79 6f70 203d 206f 7574 7075      myop = outpu
+00044910: 745f 7072 6566 6978 202b 2073 6570 6172  t_prefix + separ
+00044920: 6174 6f72 202b 2070 726f 6e75 6d20 2b20  ator + pronum + 
+00044930: 6d79 6b65 7920 2b20 272e 6e69 692e 677a  mykey + '.nii.gz
+00044940: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00044950: 2020 2020 2020 696d 6167 655f 7772 6974        image_writ
+00044960: 655f 7769 7468 5f74 6875 6d62 6e61 696c  e_with_thumbnail
+00044970: 2820 7273 6670 726f 5b6d 796b 6579 5d2c  ( rsfpro[mykey],
+00044980: 206d 796f 702c 2074 6875 6d62 3d54 7275   myop, thumb=Tru
+00044990: 6520 290a 2020 2020 2020 2020 2020 2020  e ).            
+000449a0: 2020 2020 6f66 6e20 3d20 6f75 7470 7574      ofn = output
+000449b0: 5f70 7265 6669 7820 2b20 7365 7061 7261  _prefix + separa
+000449c0: 746f 7220 2b20 7072 6f6e 756d 202b 2027  tor + pronum + '
+000449d0: 7273 6663 6f72 722e 6373 7627 0a20 2020  rsfcorr.csv'.   
+000449e0: 2020 2020 2020 2020 2020 2020 2072 7366               rsf
+000449f0: 7072 6f5b 2763 6f72 7227 5d2e 746f 5f63  pro['corr'].to_c
+00044a00: 7376 2820 6f66 6e20 290a 2020 2020 2020  sv( ofn ).      
+00044a10: 2020 2020 2020 2020 2020 2320 6170 706c            # appl
+00044a20: 7920 7361 6d65 2070 7269 6e63 6970 6c65  y same principle
+00044a30: 2074 6f20 6e65 7720 636f 7272 656c 6174   to new correlat
+00044a40: 696f 6e20 6d61 7472 6978 2c20 646f 6573  ion matrix, does
+00044a50: 6e27 7420 6e65 6564 2074 6f20 6265 2069  n't need to be i
+00044a60: 6e63 6f72 706f 7261 7465 6420 7769 7468  ncorporated with
+00044a70: 206d 6d5f 7769 6465 0a20 2020 2020 2020   mm_wide.       
+00044a80: 2020 2020 2020 2020 206f 666e 3220 3d20           ofn2 = 
+00044a90: 6f75 7470 7574 5f70 7265 6669 7820 2b20  output_prefix + 
+00044aa0: 7365 7061 7261 746f 7220 2b20 7072 6f6e  separator + pron
+00044ab0: 756d 202b 2027 6e6f 6465 7363 6f72 722e  um + 'nodescorr.
+00044ac0: 6373 7627 0a20 2020 2020 2020 2020 2020  csv'.           
+00044ad0: 2020 2020 2072 7366 7072 6f5b 2766 756c       rsfpro['ful
+00044ae0: 6c43 6f72 724d 6174 275d 2e74 6f5f 6373  lCorrMat'].to_cs
+00044af0: 7628 206f 666e 3220 290a 2020 2020 6966  v( ofn2 ).    if
+00044b00: 2027 4454 4927 2069 6e20 6d6d 3a0a 2020   'DTI' in mm:.  
+00044b10: 2020 2020 2020 6966 206d 6d5b 2744 5449        if mm['DTI
+00044b20: 275d 2069 7320 6e6f 7420 4e6f 6e65 3a0a  '] is not None:.
+00044b30: 2020 2020 2020 2020 2020 2020 6d79 6474              mydt
+00044b40: 6920 3d20 6d6d 5b27 4454 4927 5d0a 2020  i = mm['DTI'].  
+00044b50: 2020 2020 2020 2020 2020 6d6d 5f77 6964            mm_wid
+00044b60: 655b 2764 7469 5f74 736e 725f 6230 5f6d  e['dti_tsnr_b0_m
+00044b70: 6561 6e27 5d20 3d20 206d 7964 7469 5b27  ean'] =  mydti['
+00044b80: 7473 6e72 5f62 3027 5d2e 6d65 616e 2829  tsnr_b0'].mean()
+00044b90: 0a20 2020 2020 2020 2020 2020 206d 6d5f  .            mm_
+00044ba0: 7769 6465 5b27 6474 695f 7473 6e72 5f64  wide['dti_tsnr_d
+00044bb0: 7769 5f6d 6561 6e27 5d20 3d20 206d 7964  wi_mean'] =  myd
+00044bc0: 7469 5b27 7473 6e72 5f64 7769 275d 2e6d  ti['tsnr_dwi'].m
+00044bd0: 6561 6e28 290a 2020 2020 2020 2020 2020  ean().          
+00044be0: 2020 6d6d 5f77 6964 655b 2764 7469 5f64    mm_wide['dti_d
+00044bf0: 7661 7273 5f62 305f 6d65 616e 275d 203d  vars_b0_mean'] =
+00044c00: 2020 6d79 6474 695b 2764 7661 7273 5f62    mydti['dvars_b
+00044c10: 3027 5d2e 6d65 616e 2829 0a20 2020 2020  0'].mean().     
+00044c20: 2020 2020 2020 206d 6d5f 7769 6465 5b27         mm_wide['
+00044c30: 6474 695f 6476 6172 735f 6477 695f 6d65  dti_dvars_dwi_me
+00044c40: 616e 275d 203d 2020 6d79 6474 695b 2764  an'] =  mydti['d
+00044c50: 7661 7273 5f64 7769 275d 2e6d 6561 6e28  vars_dwi'].mean(
+00044c60: 290a 2020 2020 2020 2020 2020 2020 6d6d  ).            mm
+00044c70: 5f77 6964 655b 2764 7469 5f73 736e 725f  _wide['dti_ssnr_
+00044c80: 6230 5f6d 6561 6e27 5d20 3d20 206d 7964  b0_mean'] =  myd
+00044c90: 7469 5b27 7373 6e72 5f62 3027 5d2e 6d65  ti['ssnr_b0'].me
+00044ca0: 616e 2829 0a20 2020 2020 2020 2020 2020  an().           
+00044cb0: 206d 6d5f 7769 6465 5b27 6474 695f 7373   mm_wide['dti_ss
+00044cc0: 6e72 5f64 7769 5f6d 6561 6e27 5d20 3d20  nr_dwi_mean'] = 
+00044cd0: 206d 7964 7469 5b27 7373 6e72 5f64 7769   mydti['ssnr_dwi
+00044ce0: 275d 2e6d 6561 6e28 290a 2020 2020 2020  '].mean().      
+00044cf0: 2020 2020 2020 6d6d 5f77 6964 655b 2764        mm_wide['d
+00044d00: 7469 5f66 615f 6576 7227 5d20 3d20 206d  ti_fa_evr'] =  m
+00044d10: 7964 7469 5b27 6661 5f65 7672 275d 0a20  ydti['fa_evr']. 
+00044d20: 2020 2020 2020 2020 2020 206d 6d5f 7769             mm_wi
+00044d30: 6465 5b27 6474 695f 6661 5f53 4e52 275d  de['dti_fa_SNR']
+00044d40: 203d 2020 6d79 6474 695b 2766 615f 534e   =  mydti['fa_SN
+00044d50: 5227 5d0a 2020 2020 2020 2020 2020 2020  R'].            
+00044d60: 6966 206d 7964 7469 5b27 6672 616d 6577  if mydti['framew
+00044d70: 6973 655f 6469 7370 6c61 6365 6d65 6e74  ise_displacement
+00044d80: 275d 2069 7320 6e6f 7420 4e6f 6e65 3a0a  '] is not None:.
+00044d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044da0: 6d6d 5f77 6964 655b 2764 7469 5f68 6967  mm_wide['dti_hig
+00044db0: 685f 6d6f 7469 6f6e 5f63 6f75 6e74 275d  h_motion_count']
+00044dc0: 203d 2020 6d79 6474 695b 2768 6967 685f   =  mydti['high_
+00044dd0: 6d6f 7469 6f6e 5f63 6f75 6e74 275d 0a20  motion_count']. 
+00044de0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00044df0: 6d5f 7769 6465 5b27 6474 695f 4644 5f6d  m_wide['dti_FD_m
+00044e00: 6561 6e27 5d20 3d20 6d79 6474 695b 2766  ean'] = mydti['f
+00044e10: 7261 6d65 7769 7365 5f64 6973 706c 6163  ramewise_displac
+00044e20: 656d 656e 7427 5d2e 6d65 616e 2829 0a20  ement'].mean(). 
+00044e30: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00044e40: 6d5f 7769 6465 5b27 6474 695f 4644 5f6d  m_wide['dti_FD_m
+00044e50: 6178 275d 203d 206d 7964 7469 5b27 6672  ax'] = mydti['fr
+00044e60: 616d 6577 6973 655f 6469 7370 6c61 6365  amewise_displace
+00044e70: 6d65 6e74 275d 2e6d 6178 2829 0a20 2020  ment'].max().   
+00044e80: 2020 2020 2020 2020 2020 2020 206d 6d5f               mm_
+00044e90: 7769 6465 5b27 6474 695f 4644 5f73 6427  wide['dti_FD_sd'
+00044ea0: 5d20 3d20 6d79 6474 695b 2766 7261 6d65  ] = mydti['frame
+00044eb0: 7769 7365 5f64 6973 706c 6163 656d 656e  wise_displacemen
+00044ec0: 7427 5d2e 7374 6428 290a 2020 2020 2020  t'].std().      
+00044ed0: 2020 2020 2020 2020 2020 6664 666e 203d            fdfn =
+00044ee0: 206f 7574 7075 745f 7072 6566 6978 202b   output_prefix +
+00044ef0: 2073 6570 6172 6174 6f72 202b 2027 5f66   separator + '_f
+00044f00: 642e 6373 7627 0a20 2020 2020 2020 2020  d.csv'.         
+00044f10: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00044f20: 2020 2020 2020 2020 206d 6d5f 7769 6465           mm_wide
+00044f30: 5b27 6474 695f 4644 5f6d 6561 6e27 5d20  ['dti_FD_mean'] 
+00044f40: 3d20 6d6d 5f77 6964 655b 2764 7469 5f46  = mm_wide['dti_F
+00044f50: 445f 6d61 7827 5d20 3d20 6d6d 5f77 6964  D_max'] = mm_wid
+00044f60: 655b 2764 7469 5f46 445f 7364 275d 203d  e['dti_FD_sd'] =
+00044f70: 2027 4e41 270a 0a20 2020 2069 6620 2770   'NA'..    if 'p
+00044f80: 6572 6627 2069 6e20 6d6d 3a0a 2020 2020  erf' in mm:.    
+00044f90: 2020 2020 6966 206d 6d5b 2770 6572 6627      if mm['perf'
+00044fa0: 5d20 6973 206e 6f74 204e 6f6e 653a 0a20  ] is not None:. 
+00044fb0: 2020 2020 2020 2020 2020 2070 6572 6670             perfp
+00044fc0: 726f 203d 206d 6d5b 2770 6572 6627 5d0a  ro = mm['perf'].
+00044fd0: 2020 2020 2020 2020 2020 2020 7072 7769              prwi
+00044fe0: 6465 203d 2064 6963 745f 746f 5f64 6174  de = dict_to_dat
+00044ff0: 6166 7261 6d65 2820 7065 7266 7072 6f20  aframe( perfpro 
+00045000: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00045010: 206d 6d5f 7769 6465 2e73 6861 7065 5b30   mm_wide.shape[0
+00045020: 5d20 3e20 3020 616e 6420 7072 7769 6465  ] > 0 and prwide
+00045030: 2e73 6861 7065 5b30 5d20 3e20 303a 0a20  .shape[0] > 0:. 
+00045040: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00045050: 7277 6964 652e 7365 745f 696e 6465 7828  rwide.set_index(
+00045060: 206d 6d5f 7769 6465 2e69 6e64 6578 2c20   mm_wide.index, 
+00045070: 696e 706c 6163 653d 5472 7565 2029 0a20  inplace=True ). 
+00045080: 2020 2020 2020 2020 2020 206d 6d5f 7769             mm_wi
+00045090: 6465 203d 2070 642e 636f 6e63 6174 2820  de = pd.concat( 
+000450a0: 5b6d 6d5f 7769 6465 2c20 7072 7769 6465  [mm_wide, prwide
+000450b0: 205d 2c20 6178 6973 3d31 2c20 6967 6e6f   ], axis=1, igno
+000450c0: 7265 5f69 6e64 6578 3d46 616c 7365 2029  re_index=False )
+000450d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000450e0: 2770 6572 665f 6461 7461 6672 616d 6527  'perf_dataframe'
+000450f0: 2069 6e20 7065 7266 7072 6f2e 6b65 7973   in perfpro.keys
+00045100: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00045110: 2020 2020 7064 6572 6b20 3d20 7065 7266      pderk = perf
+00045120: 7072 6f5b 2770 6572 665f 6461 7461 6672  pro['perf_datafr
+00045130: 616d 6527 5d2e 696c 6f63 5b3a 202c 2031  ame'].iloc[: , 1
+00045140: 3a5d 0a20 2020 2020 2020 2020 2020 2020  :].             
+00045150: 2020 2070 6465 726b 2e73 6574 5f69 6e64     pderk.set_ind
+00045160: 6578 2820 6d6d 5f77 6964 652e 696e 6465  ex( mm_wide.inde
+00045170: 782c 2069 6e70 6c61 6365 3d54 7275 6520  x, inplace=True 
+00045180: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00045190: 2020 6d6d 5f77 6964 6520 3d20 7064 2e63    mm_wide = pd.c
+000451a0: 6f6e 6361 7428 205b 206d 6d5f 7769 6465  oncat( [ mm_wide
+000451b0: 2c20 7064 6572 6b20 5d2c 2061 7869 733d  , pderk ], axis=
+000451c0: 312c 2069 676e 6f72 655f 696e 6465 783d  1, ignore_index=
+000451d0: 4661 6c73 6520 290a 2020 2020 2020 2020  False ).        
+000451e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000451f0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00045200: 2246 4958 4d45 202d 2070 6572 6675 7369  "FIXME - perfusi
+00045210: 6f6e 2064 6174 6166 7261 6d65 2229 0a20  on dataframe"). 
+00045220: 2020 2020 2020 2020 2020 2066 6f72 206d             for m
+00045230: 796b 6579 2069 6e20 6765 745f 616e 7473  ykey in get_ants
+00045240: 696d 6167 655f 6b65 7973 2820 6d6d 5b27  image_keys( mm['
+00045250: 7065 7266 275d 2029 3a0a 2020 2020 2020  perf'] ):.      
+00045260: 2020 2020 2020 2020 2020 7465 6d70 666e            tempfn
+00045270: 203d 206f 7574 7075 745f 7072 6566 6978   = output_prefix
+00045280: 202b 2073 6570 6172 6174 6f72 202b 206d   + separator + m
+00045290: 796b 6579 202b 2027 2e6e 6969 2e67 7a27  ykey + '.nii.gz'
+000452a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000452b0: 2069 6d61 6765 5f77 7269 7465 5f77 6974   image_write_wit
+000452c0: 685f 7468 756d 626e 6169 6c28 206d 6d5b  h_thumbnail( mm[
+000452d0: 2770 6572 6627 5d5b 6d79 6b65 795d 2c20  'perf'][mykey], 
+000452e0: 7465 6d70 666e 2c20 7468 756d 623d 4661  tempfn, thumb=Fa
+000452f0: 6c73 6520 290a 0a20 2020 206d 6d77 6964  lse )..    mmwid
+00045300: 6566 6e20 3d20 6f75 7470 7574 5f70 7265  efn = output_pre
+00045310: 6669 7820 2b20 7365 7061 7261 746f 7220  fix + separator 
+00045320: 2b20 276d 6d77 6964 652e 6373 7627 0a20  + 'mmwide.csv'. 
+00045330: 2020 206d 6d5f 7769 6465 2e74 6f5f 6373     mm_wide.to_cs
+00045340: 7628 206d 6d77 6964 6566 6e20 290a 2020  v( mmwidefn ).  
+00045350: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+00045360: 2020 2020 2020 7072 696e 7428 206f 7574        print( out
+00045370: 7075 745f 7072 6566 6978 202b 2022 2077  put_prefix + " w
+00045380: 7269 7465 5f6d 6d20 646f 6e65 2e22 2029  rite_mm done." )
+00045390: 0a20 2020 2072 6574 7572 6e0a 0a0a 6465  .    return...de
+000453a0: 6620 6d6d 5f6e 7267 280a 2020 2020 7374  f mm_nrg(.    st
+000453b0: 7564 7969 642c 2020 2023 2070 616e 6461  udyid,   # panda
+000453c0: 7320 6461 7461 2066 7261 6d65 0a20 2020  s data frame.   
+000453d0: 2073 6f75 7263 6564 6972 203d 206f 732e   sourcedir = os.
+000453e0: 7061 7468 2e65 7870 616e 6475 7365 7228  path.expanduser(
+000453f0: 2022 7e2f 6461 7461 2f50 504d 492f 4d56   "~/data/PPMI/MV
+00045400: 2f65 7861 6d70 6c65 5f73 335f 622f 696d  /example_s3_b/im
+00045410: 6167 6573 2f50 504d 492f 2220 292c 0a20  ages/PPMI/" ),. 
+00045420: 2020 2073 6f75 7263 6564 6174 6166 6f6c     sourcedatafol
+00045430: 6465 726e 616d 6520 3d20 2769 6d61 6765  dername = 'image
+00045440: 7327 2c20 2320 726f 6f74 2066 6f72 2073  s', # root for s
+00045450: 6f75 7263 6520 6461 7461 0a20 2020 2070  ource data.    p
+00045460: 726f 6365 7373 4469 7220 3d20 2270 726f  rocessDir = "pro
+00045470: 6365 7373 6564 222c 2023 2077 6865 7265  cessed", # where
+00045480: 206f 7574 7075 7420 7769 6c6c 2067 6f20   output will go 
+00045490: 2d20 7061 7261 6c6c 656c 2074 6f20 736f  - parallel to so
+000454a0: 7572 6365 6461 7461 666f 6c64 6572 6e61  urcedatafolderna
+000454b0: 6d65 0a20 2020 206d 7973 6570 203d 2027  me.    mysep = '
+000454c0: 2d27 2c20 2320 6465 6669 6e65 2061 2073  -', # define a s
+000454d0: 6570 6172 6174 6f72 2066 6f72 2066 696c  eparator for fil
+000454e0: 656e 616d 6520 636f 6d70 6f6e 656e 7473  ename components
+000454f0: 0a20 2020 2073 726d 6f64 656c 5f54 3120  .    srmodel_T1 
+00045500: 3d20 4661 6c73 652c 2023 206f 7074 696f  = False, # optio
+00045510: 6e61 6c20 2d20 7769 6c6c 2061 6464 2061  nal - will add a
+00045520: 2067 7265 6174 2064 6561 6c20 6f66 2074   great deal of t
+00045530: 696d 650a 2020 2020 7372 6d6f 6465 6c5f  ime.    srmodel_
+00045540: 4e4d 203d 2046 616c 7365 2c20 2320 6f70  NM = False, # op
+00045550: 7469 6f6e 616c 202d 2077 696c 6c20 6164  tional - will ad
+00045560: 6420 6120 6772 6561 7420 6465 616c 206f  d a great deal o
+00045570: 6620 7469 6d65 0a20 2020 2073 726d 6f64  f time.    srmod
+00045580: 656c 5f44 5449 203d 2046 616c 7365 2c20  el_DTI = False, 
+00045590: 2320 6f70 7469 6f6e 616c 202d 2077 696c  # optional - wil
+000455a0: 6c20 6164 6420 6120 6772 6561 7420 6465  l add a great de
+000455b0: 616c 206f 6620 7469 6d65 0a20 2020 2076  al of time.    v
+000455c0: 6973 7561 6c69 7a65 203d 2054 7275 652c  isualize = True,
+000455d0: 0a20 2020 206e 7267 5f6d 6f64 616c 6974  .    nrg_modalit
+000455e0: 795f 6c69 7374 203d 205b 2254 3177 222c  y_list = ["T1w",
+000455f0: 2022 4e4d 3244 4d54 222c 2022 4454 4922   "NM2DMT", "DTI"
+00045600: 2c22 5432 466c 6169 7222 2c20 2272 7366  ,"T2Flair", "rsf
+00045610: 4d52 4922 205d 2c0a 2020 2020 7665 7262  MRI" ],.    verb
+00045620: 6f73 6520 3d20 5472 7565 0a29 3a0a 2020  ose = True.):.  
+00045630: 2020 2222 220a 2020 2020 746f 6f20 6461    """.    too da
+00045640: 6e67 6572 6f75 7320 746f 2064 6f63 756d  ngerous to docum
+00045650: 656e 7420 2e2e 2e20 7573 6520 7769 7468  ent ... use with
+00045660: 2063 6172 652e 0a0a 2020 2020 7072 6f63   care...    proc
+00045670: 6573 7365 7320 6d75 6c74 6970 6c65 206d  esses multiple m
+00045680: 6f64 616c 6974 7920 4d52 4920 7370 6563  odality MRI spec
+00045690: 6966 6963 616c 6c79 3a0a 0a20 2020 202a  ifically:..    *
+000456a0: 2054 3177 0a20 2020 202a 2054 3246 6c61   T1w.    * T2Fla
+000456b0: 6972 0a20 2020 202a 2044 5449 2c20 4454  ir.    * DTI, DT
+000456c0: 495f 4c52 2c20 4454 495f 524c 0a20 2020  I_LR, DTI_RL.   
+000456d0: 202a 2072 7366 4d52 492c 2072 7366 4d52   * rsfMRI, rsfMR
+000456e0: 495f 4c52 2c20 7273 664d 5249 5f52 4c0a  I_LR, rsfMRI_RL.
+000456f0: 2020 2020 2a20 4e4d 3244 4d54 2028 6e65      * NM2DMT (ne
+00045700: 7572 6f6d 656c 616e 696e 290a 0a20 2020  uromelanin)..   
+00045710: 206f 7468 6572 206d 6f64 616c 6974 6965   other modalitie
+00045720: 7320 6d61 7920 6265 2061 6464 6564 206c  s may be added l
+00045730: 6174 6572 202e 2e2e 0a0a 2020 2020 2274  ater .....    "t
+00045740: 7275 7374 206d 652c 2069 206b 6e6f 7720  rust me, i know 
+00045750: 7768 6174 2069 276d 2064 6f69 6e67 2220  what i'm doing" 
+00045760: 2d20 736c 6564 6765 6861 6d6d 6572 0a0a  - sledgehammer..
+00045770: 2020 2020 636f 6e76 6572 7420 746f 2070      convert to p
+00045780: 796e 6220 7669 613a 0a20 2020 2020 2020  ynb via:.       
+00045790: 2070 326a 206d 6d2e 7079 202d 6f0a 0a20   p2j mm.py -o.. 
+000457a0: 2020 2063 6f6e 7665 7274 2074 6865 2069     convert the i
+000457b0: 7079 6e62 2074 6f20 6874 6d6c 2076 6961  pynb to html via
+000457c0: 3a0a 2020 2020 2020 2020 6a75 7079 7465  :.        jupyte
+000457d0: 7220 6e62 636f 6e76 6572 7420 414e 5473  r nbconvert ANTs
+000457e0: 5079 4d4d 2f74 6573 7473 2f6d 6d2e 6970  PyMM/tests/mm.ip
+000457f0: 796e 6220 2d2d 6578 6563 7574 6520 2d2d  ynb --execute --
+00045800: 746f 2068 746d 6c0a 0a20 2020 2074 6869  to html..    thi
+00045810: 7320 6675 6e63 7469 6f6e 2061 7373 756d  s function assum
+00045820: 6573 204e 5247 2066 6f72 6d61 7420 666f  es NRG format fo
+00045830: 7220 7468 6520 696e 7075 7420 6461 7461  r the input data
+00045840: 202e 2e2e 2e0a 2020 2020 7765 2061 6c73   .....    we als
+00045850: 6f20 6173 7375 6d65 2074 6861 7420 7431  o assume that t1
+00045860: 7720 6869 6572 6172 6368 6963 616c 2028  w hierarchical (
+00045870: 6966 2061 6c72 6561 6479 2064 6f6e 6529  if already done)
+00045880: 2077 6173 2077 7269 7474 656e 0a20 2020   was written.   
+00045890: 2076 6961 2069 7473 2073 7461 6e64 6172   via its standar
+000458a0: 6469 7a65 6420 7772 6974 6520 6675 6e63  dized write func
+000458b0: 7469 6f6e 2e0a 2020 2020 4e52 4720 3d20  tion..    NRG = 
+000458c0: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
+000458d0: 6f6d 2f73 746e 6176 612f 6269 6f6d 6564  om/stnava/biomed
+000458e0: 6963 616c 4461 7461 4f72 6761 6e69 7a61  icalDataOrganiza
+000458f0: 7469 6f6e 0a0a 2020 2020 7468 6973 2066  tion..    this f
+00045900: 756e 6374 696f 6e20 6973 2076 6572 626f  unction is verbo
+00045910: 7365 0a0a 2020 2020 5061 7261 6d65 7465  se..    Paramete
+00045920: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+00045930: 2d2d 2d2d 0a0a 2020 2020 7374 7564 7969  ----..    studyi
+00045940: 6420 3a20 6d75 7374 2068 6176 6520 636f  d : must have co
+00045950: 6c75 6d6e 7320 312e 2073 7562 6a65 6374  lumns 1. subject
+00045960: 4944 2032 2e20 6461 7465 2028 696e 2066  ID 2. date (in f
+00045970: 6f72 6d20 3230 3232 3032 3238 2920 616e  orm 20220228) an
+00045980: 6420 332e 2069 6d61 6765 4944 0a20 2020  d 3. imageID.   
+00045990: 2020 2020 206f 7468 6572 2072 656c 6576       other relev
+000459a0: 616e 7420 636f 6c75 6d6e 7320 696e 636c  ant columns incl
+000459b0: 7564 6520 6e6d 6964 312d 3130 2c20 7273  ude nmid1-10, rs
+000459c0: 6669 6431 2c20 7273 6669 6432 2c20 6474  fid1, rsfid2, dt
+000459d0: 6964 312c 2064 7469 6432 2c20 666c 6169  id1, dtid2, flai
+000459e0: 7269 643b 0a20 2020 2020 2020 2074 6865  rid;.        the
+000459f0: 7365 2070 726f 7669 6465 2075 6e69 7175  se provide uniqu
+00045a00: 6520 696d 6167 6520 4944 7320 666f 7220  e image IDs for 
+00045a10: 7468 6573 6520 6d6f 6461 6c69 7469 6573  these modalities
+00045a20: 3a20 6e6d 3d6e 6575 726f 6d65 6c61 6e69  : nm=neuromelani
+00045a30: 6e2c 2064 7469 3d64 6966 6675 7369 6f6e  n, dti=diffusion
+00045a40: 2074 656e 736f 722c 0a20 2020 2020 2020   tensor,.       
+00045a50: 2072 7366 3d72 6573 7469 6e67 2073 7461   rsf=resting sta
+00045a60: 7465 2066 6d72 692c 2066 6c61 6972 3d54  te fmri, flair=T
+00045a70: 3246 6c61 6972 2e20 206e 6f6e 6520 6f66  2Flair.  none of
+00045a80: 2074 6865 7365 2061 7265 2072 6571 7569   these are requi
+00045a90: 7265 642e 206f 6e6c 790a 2020 2020 2020  red. only.      
+00045aa0: 2020 7431 2069 7320 7265 7175 6972 6564    t1 is required
+00045ab0: 2e20 2072 7366 6964 312f 7273 6669 6432  .  rsfid1/rsfid2
+00045ac0: 2077 696c 6c20 6265 2070 726f 6365 7373   will be process
+00045ad0: 6564 206a 6f69 6e74 6c79 2e20 7361 6d65  ed jointly. same
+00045ae0: 2066 6f72 2064 7469 6431 2f64 7469 6432   for dtid1/dtid2
+00045af0: 2061 6e64 206e 6d69 642a 2e20 2073 6565   and nmid*.  see
+00045b00: 2061 6e74 7370 796d 6d2e 6765 6e65 7261   antspymm.genera
+00045b10: 7465 5f6d 6d5f 6461 7461 6672 616d 650a  te_mm_dataframe.
+00045b20: 0a20 2020 2073 6f75 7263 6564 6972 203a  .    sourcedir :
+00045b30: 2061 2073 7475 6479 2073 7065 6369 6669   a study specifi
+00045b40: 6320 666f 6c64 6572 2063 6f6e 7461 696e  c folder contain
+00045b50: 696e 6720 696e 6469 7669 6475 616c 2073  ing individual s
+00045b60: 7562 6a65 6374 2066 6f6c 6465 7273 0a0a  ubject folders..
+00045b70: 2020 2020 736f 7572 6365 6461 7461 666f      sourcedatafo
+00045b80: 6c64 6572 6e61 6d65 203a 2072 6f6f 7420  ldername : root 
+00045b90: 666f 7220 736f 7572 6365 2064 6174 6120  for source data 
+00045ba0: 652e 672e 2022 696d 6167 6573 220a 0a20  e.g. "images".. 
+00045bb0: 2020 2070 726f 6365 7373 4469 7220 3a20     processDir : 
+00045bc0: 7768 6572 6520 6f75 7470 7574 2077 696c  where output wil
+00045bd0: 6c20 676f 202d 2070 6172 616c 6c65 6c20  l go - parallel 
+00045be0: 746f 2073 6f75 7263 6564 6174 6166 6f6c  to sourcedatafol
+00045bf0: 6465 726e 616d 6520 652e 672e 0a20 2020  dername e.g..   
+00045c00: 2020 2020 2022 7072 6f63 6573 7365 6422       "processed"
+00045c10: 0a0a 2020 2020 6d79 7365 7020 3a20 6465  ..    mysep : de
+00045c20: 6669 6e65 2061 2063 6861 7261 6374 6572  fine a character
+00045c30: 2073 6570 6172 6174 6f72 2066 6f72 2066   separator for f
+00045c40: 696c 656e 616d 6520 636f 6d70 6f6e 656e  ilename componen
+00045c50: 7473 0a0a 2020 2020 7372 6d6f 6465 6c5f  ts..    srmodel_
+00045c60: 5431 203a 2046 616c 7365 2028 6465 6661  T1 : False (defa
+00045c70: 756c 7429 202d 2077 696c 6c20 6164 6420  ult) - will add 
+00045c80: 6120 6772 6561 7420 6465 616c 206f 6620  a great deal of 
+00045c90: 7469 6d65 202d 206f 7220 6835 2066 696c  time - or h5 fil
+00045ca0: 656e 616d 652c 2032 2063 6861 6e0a 0a20  ename, 2 chan.. 
+00045cb0: 2020 2073 726d 6f64 656c 5f4e 4d20 3a20     srmodel_NM : 
+00045cc0: 4661 6c73 6520 2864 6566 6175 6c74 2920  False (default) 
+00045cd0: 2d20 7769 6c6c 2061 6464 2061 2067 7265  - will add a gre
+00045ce0: 6174 2064 6561 6c20 6f66 2074 696d 6520  at deal of time 
+00045cf0: 2d20 6f72 2068 3520 6669 6c65 6e61 6d65  - or h5 filename
+00045d00: 2c20 3120 6368 616e 0a0a 2020 2020 7372  , 1 chan..    sr
+00045d10: 6d6f 6465 6c5f 4454 4920 3a20 4661 6c73  model_DTI : Fals
+00045d20: 6520 2864 6566 6175 6c74 2920 2d20 7769  e (default) - wi
+00045d30: 6c6c 2061 6464 2061 2067 7265 6174 2064  ll add a great d
+00045d40: 6561 6c20 6f66 2074 696d 6520 2d20 6f72  eal of time - or
+00045d50: 2068 3520 6669 6c65 6e61 6d65 2c20 3120   h5 filename, 1 
+00045d60: 6368 616e 0a0a 2020 2020 7669 7375 616c  chan..    visual
+00045d70: 697a 6520 3a20 5472 7565 202d 2077 696c  ize : True - wil
+00045d80: 6c20 706c 6f74 2073 6f6d 6520 7265 7375  l plot some resu
+00045d90: 6c74 7320 746f 2070 6e67 0a0a 2020 2020  lts to png..    
+00045da0: 6e72 675f 6d6f 6461 6c69 7479 5f6c 6973  nrg_modality_lis
+00045db0: 7420 3a20 6c69 7374 206f 6620 7065 726d  t : list of perm
+00045dc0: 6973 7369 626c 6520 6d6f 6461 6c69 7469  issible modaliti
+00045dd0: 6573 202d 2061 6c77 6179 7320 696e 636c  es - always incl
+00045de0: 7564 6520 5b54 3177 5d20 6173 2062 6173  ude [T1w] as bas
+00045df0: 650a 0a20 2020 2076 6572 626f 7365 203a  e..    verbose :
+00045e00: 2062 6f6f 6c65 616e 0a0a 2020 2020 5265   boolean..    Re
+00045e10: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+00045e20: 2d2d 2d0a 0a20 2020 2077 7269 7465 7320  ---..    writes 
+00045e30: 6f75 7470 7574 2074 6f20 6469 736b 2061  output to disk a
+00045e40: 6e64 2070 6f74 656e 7469 616c 6c79 2070  nd potentially p
+00045e50: 726f 6475 6365 7320 6669 6775 7265 7320  roduces figures 
+00045e60: 7468 6174 206d 6179 2062 650a 2020 2020  that may be.    
+00045e70: 6361 7074 7572 6564 2069 6e20 6120 6970  captured in a ip
+00045e80: 796e 6220 2f20 6874 6d6c 2066 696c 652e  ynb / html file.
+00045e90: 0a0a 2020 2020 2222 220a 2020 2020 7374  ..    """.    st
+00045ea0: 7564 7969 6420 3d20 7374 7564 7969 642e  udyid = studyid.
+00045eb0: 6472 6f70 6e61 2861 7869 733d 3129 0a20  dropna(axis=1). 
+00045ec0: 2020 2069 6620 7374 7564 7969 642e 7368     if studyid.sh
+00045ed0: 6170 655b 305d 203c 2031 3a0a 2020 2020  ape[0] < 1:.    
+00045ee0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00045ef0: 7272 6f72 2827 7374 7564 7969 6420 6861  rror('studyid ha
+00045f00: 7320 6e6f 2072 6f77 7327 290a 2020 2020  s no rows').    
+00045f10: 6d75 7374 6861 7665 636f 6c73 203d 205b  musthavecols = [
+00045f20: 2773 7562 6a65 6374 4944 272c 2764 6174  'subjectID','dat
+00045f30: 6527 2c27 696d 6167 6549 4427 5d0a 2020  e','imageID'].  
+00045f40: 2020 666f 7220 6b20 696e 2072 616e 6765    for k in range
+00045f50: 286c 656e 286d 7573 7468 6176 6563 6f6c  (len(musthavecol
+00045f60: 7329 293a 0a20 2020 2020 2020 2069 6620  s)):.        if 
+00045f70: 6e6f 7420 6d75 7374 6861 7665 636f 6c73  not musthavecols
+00045f80: 5b6b 5d20 696e 2073 7475 6479 6964 2e6b  [k] in studyid.k
+00045f90: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
+00045fa0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00045fb0: 726f 7228 2773 7475 6479 6964 2069 7320  ror('studyid is 
+00045fc0: 6d69 7373 696e 6720 636f 6c75 6d6e 2027  missing column '
+00045fd0: 202b 6d75 7374 6861 7665 636f 6c73 5b6b   +musthavecols[k
+00045fe0: 5d20 290a 2020 2020 6465 6620 6d61 6b65  ] ).    def make
+00045ff0: 7769 6465 6f75 7428 2078 2c20 7365 7061  wideout( x, sepa
+00046000: 7261 746f 7220 3d20 272d 2720 293a 0a20  rator = '-' ):. 
+00046010: 2020 2020 2020 2072 6574 7572 6e20 7820         return x 
+00046020: 2b20 7365 7061 7261 746f 7220 2b20 276d  + separator + 'm
+00046030: 6d77 6964 652e 6373 7627 0a20 2020 2069  mwide.csv'.    i
+00046040: 6620 6e72 675f 6d6f 6461 6c69 7479 5f6c  f nrg_modality_l
+00046050: 6973 745b 305d 2021 3d20 2754 3177 273a  ist[0] != 'T1w':
+00046060: 0a20 2020 2020 2020 206e 7267 5f6d 6f64  .        nrg_mod
+00046070: 616c 6974 795f 6c69 7374 2e69 6e73 6572  ality_list.inser
+00046080: 7428 302c 2022 5431 7722 2029 0a20 2020  t(0, "T1w" ).   
+00046090: 2074 6573 746c 6f6f 7020 3d20 4661 6c73   testloop = Fals
+000460a0: 650a 2020 2020 636f 756e 7465 723d 300a  e.    counter=0.
+000460b0: 2020 2020 696d 706f 7274 2067 6c6f 6220      import glob 
+000460c0: 6173 2067 6c6f 620a 2020 2020 6672 6f6d  as glob.    from
+000460d0: 206f 732e 7061 7468 2069 6d70 6f72 7420   os.path import 
+000460e0: 6578 6973 7473 0a20 2020 2065 785f 7061  exists.    ex_pa
+000460f0: 7468 203d 206f 732e 7061 7468 2e65 7870  th = os.path.exp
+00046100: 616e 6475 7365 7228 2022 7e2f 2e61 6e74  anduser( "~/.ant
+00046110: 7370 7974 3177 2f22 2029 0a20 2020 2065  spyt1w/" ).    e
+00046120: 785f 7061 7468 6d6d 203d 206f 732e 7061  x_pathmm = os.pa
+00046130: 7468 2e65 7870 616e 6475 7365 7228 2022  th.expanduser( "
+00046140: 7e2f 2e61 6e74 7370 796d 6d2f 2220 290a  ~/.antspymm/" ).
+00046150: 2020 2020 7465 6d70 6c61 7465 666e 203d      templatefn =
+00046160: 2065 785f 7061 7468 202b 2027 4349 5431   ex_path + 'CIT1
+00046170: 3638 5f54 3177 5f37 3030 756d 5f70 6164  68_T1w_700um_pad
+00046180: 5f61 646e 692e 6e69 692e 677a 270a 2020  _adni.nii.gz'.  
+00046190: 2020 6966 206e 6f74 2065 7869 7374 7328    if not exists(
+000461a0: 2074 656d 706c 6174 6566 6e20 293a 0a20   templatefn ):. 
+000461b0: 2020 2020 2020 2070 7269 6e74 2820 222a         print( "*
+000461c0: 2a6d 6973 7369 6e67 2066 696c 6573 2a2a  *missing files**
+000461d0: 203d 3e20 6361 6c6c 2067 6574 5f64 6174   => call get_dat
+000461e0: 6120 6672 6f6d 206c 6174 6573 7420 616e  a from latest an
+000461f0: 7473 7079 7431 7720 616e 6420 616e 7473  tspyt1w and ants
+00046200: 7079 6d6d 2e22 2029 0a20 2020 2020 2020  pymm." ).       
+00046210: 2061 6e74 7370 7974 3177 2e67 6574 5f64   antspyt1w.get_d
+00046220: 6174 6128 2066 6f72 6365 5f64 6f77 6e6c  ata( force_downl
+00046230: 6f61 643d 5472 7565 2029 0a20 2020 2020  oad=True ).     
+00046240: 2020 2067 6574 5f64 6174 6128 2066 6f72     get_data( for
+00046250: 6365 5f64 6f77 6e6c 6f61 643d 5472 7565  ce_download=True
+00046260: 2029 0a20 2020 2074 656d 7020 3d20 736f   ).    temp = so
+00046270: 7572 6365 6469 722e 7370 6c69 7428 2022  urcedir.split( "
+00046280: 2f22 2029 0a20 2020 2073 706c 6974 436f  /" ).    splitCo
+00046290: 756e 7420 3d20 6c65 6e28 2074 656d 7020  unt = len( temp 
+000462a0: 290a 2020 2020 7465 6d70 6c61 7465 203d  ).    template =
+000462b0: 206d 6d5f 7265 6164 2820 7465 6d70 6c61   mm_read( templa
+000462c0: 7465 666e 2029 2023 2052 6561 6420 696e  tefn ) # Read in
+000462d0: 2074 656d 706c 6174 650a 2020 2020 7465   template.    te
+000462e0: 7374 5f72 756e 203d 2046 616c 7365 0a20  st_run = False. 
+000462f0: 2020 2069 6620 7465 7374 5f72 756e 3a0a     if test_run:.
+00046300: 2020 2020 2020 2020 7669 7375 616c 697a          visualiz
+00046310: 653d 4661 6c73 650a 2020 2020 2320 6765  e=False.    # ge
+00046320: 7420 7369 6420 616e 6420 6474 6964 2066  t sid and dtid f
+00046330: 726f 6d20 7374 7564 7969 640a 2020 2020  rom studyid.    
+00046340: 7369 6420 3d20 7374 7228 7374 7564 7969  sid = str(studyi
+00046350: 645b 2773 7562 6a65 6374 4944 275d 2e69  d['subjectID'].i
+00046360: 6c6f 635b 305d 290a 2020 2020 6474 6964  loc[0]).    dtid
+00046370: 203d 2073 7472 2873 7475 6479 6964 5b27   = str(studyid['
+00046380: 6461 7465 275d 2e69 6c6f 635b 305d 290a  date'].iloc[0]).
+00046390: 2020 2020 6969 6420 3d20 7374 7228 7374      iid = str(st
+000463a0: 7564 7969 645b 2769 6d61 6765 4944 275d  udyid['imageID']
+000463b0: 2e69 6c6f 635b 305d 290a 2020 2020 7375  .iloc[0]).    su
+000463c0: 626a 6563 7472 6f6f 7470 6174 6820 3d20  bjectrootpath = 
+000463d0: 6f73 2e70 6174 682e 6a6f 696e 2873 6f75  os.path.join(sou
+000463e0: 7263 6564 6972 2c73 6964 2c20 6474 6964  rcedir,sid, dtid
+000463f0: 290a 2020 2020 6966 2076 6572 626f 7365  ).    if verbose
+00046400: 3a0a 2020 2020 2020 2020 7072 696e 7428  :.        print(
+00046410: 2273 7562 6a65 6374 726f 6f74 7061 7468  "subjectrootpath
+00046420: 3a20 222b 2073 7562 6a65 6374 726f 6f74  : "+ subjectroot
+00046430: 7061 7468 2029 0a20 2020 206d 7969 6d67  path ).    myimg
+00046440: 7349 6e70 7574 203d 2067 6c6f 622e 676c  sInput = glob.gl
+00046450: 6f62 2820 7375 626a 6563 7472 6f6f 7470  ob( subjectrootp
+00046460: 6174 682b 222f 2a22 2029 0a20 2020 206d  ath+"/*" ).    m
+00046470: 7969 6d67 7349 6e70 7574 2e73 6f72 7428  yimgsInput.sort(
+00046480: 2029 0a20 2020 2069 6620 7665 7262 6f73   ).    if verbos
+00046490: 653a 0a20 2020 2020 2020 2070 7269 6e74  e:.        print
+000464a0: 2820 6d79 696d 6773 496e 7075 7420 290a  ( myimgsInput ).
+000464b0: 2020 2020 2320 6869 6572 6172 6368 6963      # hierarchic
+000464c0: 616c 0a20 2020 2023 204e 4f54 453a 2069  al.    # NOTE: i
+000464d0: 6620 7468 6572 6520 6172 6520 6d75 6c74  f there are mult
+000464e0: 6970 6c65 2054 3173 2066 6f72 2074 6869  iple T1s for thi
+000464f0: 7320 7469 6d65 2070 6f69 6e74 2c20 7368  s time point, sh
+00046500: 6f75 6c64 2074 616b 650a 2020 2020 2320  ould take.    # 
+00046510: 7468 6520 6f6e 6520 7769 7468 2074 6865  the one with the
+00046520: 2068 6967 6865 7374 2072 6573 6e65 7447   highest resnetG
+00046530: 7261 6465 0a20 2020 2074 315f 7365 6172  rade.    t1_sear
+00046540: 6368 5f70 6174 6820 3d20 6f73 2e70 6174  ch_path = os.pat
+00046550: 682e 6a6f 696e 2873 7562 6a65 6374 726f  h.join(subjectro
+00046560: 6f74 7061 7468 2c20 2254 3177 222c 2069  otpath, "T1w", i
+00046570: 6964 2c20 222a 6e69 692e 677a 2229 0a20  id, "*nii.gz"). 
+00046580: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
+00046590: 2020 2020 2020 2070 7269 6e74 2866 2274         print(f"t
+000465a0: 3120 7365 6172 6368 2070 6174 683a 207b  1 search path: {
+000465b0: 7431 5f73 6561 7263 685f 7061 7468 7d22  t1_search_path}"
+000465c0: 290a 2020 2020 7431 666e 203d 2067 6c6f  ).    t1fn = glo
+000465d0: 622e 676c 6f62 2874 315f 7365 6172 6368  b.glob(t1_search
+000465e0: 5f70 6174 6829 0a20 2020 2074 3166 6e2e  _path).    t1fn.
+000465f0: 736f 7274 2829 0a20 2020 2069 6620 6c65  sort().    if le
+00046600: 6e28 2074 3166 6e20 2920 3c20 313a 0a20  n( t1fn ) < 1:. 
+00046610: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00046620: 7565 4572 726f 7228 276d 6d5f 6e72 6720  ueError('mm_nrg 
+00046630: 6361 6e6e 6f74 2066 696e 6420 7468 6520  cannot find the 
+00046640: 5431 7720 7769 7468 2075 6964 2027 202b  T1w with uid ' +
+00046650: 2069 6964 202b 2027 2040 2027 202b 2073   iid + ' @ ' + s
+00046660: 7562 6a65 6374 726f 6f74 7061 7468 2029  ubjectrootpath )
+00046670: 0a20 2020 2074 3166 6e20 3d20 7431 666e  .    t1fn = t1fn
+00046680: 5b30 5d0a 2020 2020 7431 203d 206d 6d5f  [0].    t1 = mm_
+00046690: 7265 6164 2820 7431 666e 2029 0a20 2020  read( t1fn ).   
+000466a0: 2068 6965 7266 6e30 203d 2072 652e 7375   hierfn0 = re.su
+000466b0: 6228 2073 6f75 7263 6564 6174 6166 6f6c  b( sourcedatafol
+000466c0: 6465 726e 616d 652c 2070 726f 6365 7373  dername, process
+000466d0: 4469 722c 2074 3166 6e29 0a20 2020 2068  Dir, t1fn).    h
+000466e0: 6965 7266 6e30 203d 2072 652e 7375 6228  ierfn0 = re.sub(
+000466f0: 2022 2e6e 6969 2e67 7a22 2c20 2222 2c20   ".nii.gz", "", 
+00046700: 6869 6572 666e 3029 0a20 2020 2068 6965  hierfn0).    hie
+00046710: 7266 6e20 3d20 7265 2e73 7562 2820 2254  rfn = re.sub( "T
+00046720: 3177 222c 2022 5431 7748 6965 7261 7263  1w", "T1wHierarc
+00046730: 6869 6361 6c22 2c20 6869 6572 666e 3029  hical", hierfn0)
+00046740: 0a20 2020 2068 6965 7266 6e20 3d20 6869  .    hierfn = hi
+00046750: 6572 666e 202b 206d 7973 6570 0a20 2020  erfn + mysep.   
+00046760: 2068 6965 7266 6e74 6573 7420 3d20 6869   hierfntest = hi
+00046770: 6572 666e 202b 2027 736e 7365 672e 6373  erfn + 'snseg.cs
+00046780: 7627 0a20 2020 2072 6567 6f75 7420 3d20  v'.    regout = 
+00046790: 6869 6572 666e 3020 2b20 6d79 7365 7020  hierfn0 + mysep 
+000467a0: 2b20 2273 796e 220a 2020 2020 7465 6d70  + "syn".    temp
+000467b0: 6c61 7465 5478 203d 207b 0a20 2020 2020  lateTx = {.     
+000467c0: 2020 2027 6677 6474 7261 6e73 666f 726d     'fwdtransform
+000467d0: 7327 3a20 5b20 7265 676f 7574 2b27 3157  s': [ regout+'1W
+000467e0: 6172 702e 6e69 692e 677a 272c 2072 6567  arp.nii.gz', reg
+000467f0: 6f75 742b 2730 4765 6e65 7269 6341 6666  out+'0GenericAff
+00046800: 696e 652e 6d61 7427 5d2c 0a20 2020 2020  ine.mat'],.     
+00046810: 2020 2027 696e 7674 7261 6e73 666f 726d     'invtransform
+00046820: 7327 3a20 5b20 7265 676f 7574 2b27 3047  s': [ regout+'0G
+00046830: 656e 6572 6963 4166 6669 6e65 2e6d 6174  enericAffine.mat
+00046840: 272c 2072 6567 6f75 742b 2731 496e 7665  ', regout+'1Inve
+00046850: 7273 6557 6172 702e 6e69 692e 677a 275d  rseWarp.nii.gz']
+00046860: 2020 7d0a 2020 2020 6966 2076 6572 626f    }.    if verbo
+00046870: 7365 3a0a 2020 2020 2020 2020 7072 696e  se:.        prin
+00046880: 7428 2022 2d3c 5245 4749 5354 5241 5449  t( "-<REGISTRATI
+00046890: 4f4e 2045 5849 5354 454e 4345 3e2d 3a20  ON EXISTENCE>-: 
+000468a0: 5c6e 2220 2b20 0a20 2020 2020 2020 2020  \n" + .         
+000468b0: 2020 2020 2022 4e41 4d49 4e47 3a20 2220       "NAMING: " 
+000468c0: 2b20 7265 676f 7574 2b27 3047 656e 6572  + regout+'0Gener
+000468d0: 6963 4166 6669 6e65 2e6d 6174 2720 2b20  icAffine.mat' + 
+000468e0: 2220 5c6e 2022 202b 0a20 2020 2020 2020  " \n " +.       
+000468f0: 2020 2020 2073 7472 2865 7869 7374 7328       str(exists(
+00046900: 2074 656d 706c 6174 6554 785b 2766 7764   templateTx['fwd
+00046910: 7472 616e 7366 6f72 6d73 275d 5b30 5d29  transforms'][0])
+00046920: 2920 2b20 2220 2220 2b0a 2020 2020 2020  ) + " " +.      
+00046930: 2020 2020 2020 7374 7228 6578 6973 7473        str(exists
+00046940: 2820 7465 6d70 6c61 7465 5478 5b27 6677  ( templateTx['fw
+00046950: 6474 7261 6e73 666f 726d 7327 5d5b 315d  dtransforms'][1]
+00046960: 2929 202b 2022 2022 202b 0a20 2020 2020  )) + " " +.     
+00046970: 2020 2020 2020 2073 7472 2865 7869 7374         str(exist
+00046980: 7328 2074 656d 706c 6174 6554 785b 2769  s( templateTx['i
+00046990: 6e76 7472 616e 7366 6f72 6d73 275d 5b30  nvtransforms'][0
+000469a0: 5d29 2920 2b20 2220 2220 2b0a 2020 2020  ])) + " " +.    
+000469b0: 2020 2020 2020 2020 7374 7228 6578 6973          str(exis
+000469c0: 7473 2820 7465 6d70 6c61 7465 5478 5b27  ts( templateTx['
+000469d0: 696e 7674 7261 6e73 666f 726d 7327 5d5b  invtransforms'][
+000469e0: 315d 2929 2029 0a20 2020 2069 6620 7665  1])) ).    if ve
+000469f0: 7262 6f73 653a 0a20 2020 2020 2020 2070  rbose:.        p
+00046a00: 7269 6e74 2820 6869 6572 666e 7465 7374  rint( hierfntest
+00046a10: 2029 0a20 2020 2068 6965 7265 7869 7374   ).    hierexist
+00046a20: 7320 3d20 6578 6973 7473 2820 6869 6572  s = exists( hier
+00046a30: 666e 7465 7374 2029 2023 2046 4958 4d45  fntest ) # FIXME
+00046a40: 2073 686f 756c 6420 7465 7374 2074 6869   should test thi
+00046a50: 7320 6578 706c 6963 6974 6c79 2062 7574  s explicitly but
+00046a60: 2077 6520 6173 7375 6d65 2069 7420 6865   we assume it he
+00046a70: 7265 0a20 2020 2068 6965 7220 3d20 4e6f  re.    hier = No
+00046a80: 6e65 0a20 2020 2069 6620 6e6f 7420 6869  ne.    if not hi
+00046a90: 6572 6578 6973 7473 2061 6e64 206e 6f74  erexists and not
+00046aa0: 2074 6573 746c 6f6f 703a 0a20 2020 2020   testloop:.     
+00046ab0: 2020 2073 7562 6a65 6374 7072 6f70 6174     subjectpropat
+00046ac0: 6820 3d20 6f73 2e70 6174 682e 6469 726e  h = os.path.dirn
+00046ad0: 616d 6528 2068 6965 7266 6e20 290a 2020  ame( hierfn ).  
+00046ae0: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
+00046af0: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
+00046b00: 696e 7428 2073 7562 6a65 6374 7072 6f70  int( subjectprop
+00046b10: 6174 6820 290a 2020 2020 2020 2020 6f73  ath ).        os
+00046b20: 2e6d 616b 6564 6972 7328 2073 7562 6a65  .makedirs( subje
+00046b30: 6374 7072 6f70 6174 682c 2065 7869 7374  ctpropath, exist
+00046b40: 5f6f 6b3d 5472 7565 2020 290a 2020 2020  _ok=True  ).    
+00046b50: 2020 2020 6869 6572 203d 2061 6e74 7370      hier = antsp
+00046b60: 7974 3177 2e68 6965 7261 7263 6869 6361  yt1w.hierarchica
+00046b70: 6c28 2074 312c 2068 6965 7266 6e2c 206c  l( t1, hierfn, l
+00046b80: 6162 656c 735f 746f 5f72 6567 6973 7465  abels_to_registe
+00046b90: 723d 4e6f 6e65 2029 0a20 2020 2020 2020  r=None ).       
+00046ba0: 2061 6e74 7370 7974 3177 2e77 7269 7465   antspyt1w.write
+00046bb0: 5f68 6965 7261 7263 6869 6361 6c28 2068  _hierarchical( h
+00046bc0: 6965 722c 2068 6965 7266 6e20 290a 2020  ier, hierfn ).  
+00046bd0: 2020 2020 2020 7431 7769 6465 203d 2061        t1wide = a
+00046be0: 6e74 7370 7974 3177 2e6d 6572 6765 5f68  ntspyt1w.merge_h
+00046bf0: 6965 7261 7263 6869 6361 6c5f 6373 7673  ierarchical_csvs
+00046c00: 5f74 6f5f 7769 6465 5f66 6f72 6d61 7428  _to_wide_format(
+00046c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00046c20: 2068 6965 725b 2764 6174 6166 7261 6d65   hier['dataframe
+00046c30: 7327 5d2c 2069 6465 6e74 6966 6965 723d  s'], identifier=
+00046c40: 4e6f 6e65 2029 0a20 2020 2020 2020 2074  None ).        t
+00046c50: 3177 6964 652e 746f 5f63 7376 2820 6869  1wide.to_csv( hi
+00046c60: 6572 666e 202b 2027 6d6d 7769 6465 2e63  erfn + 'mmwide.c
+00046c70: 7376 2720 290a 2020 2020 2323 2323 2323  sv' ).    ######
+00046c80: 2323 2323 2323 2323 2323 2320 7265 6164  ########### read
+00046c90: 2074 6865 2068 6965 7261 7263 6869 6361   the hierarchica
+00046ca0: 6c20 6461 7461 2023 2323 2323 2323 2323  l data #########
+00046cb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00046cc0: 2323 2323 2323 0a20 2020 2068 6965 7220  ######.    hier 
+00046cd0: 3d20 616e 7473 7079 7431 772e 7265 6164  = antspyt1w.read
+00046ce0: 5f68 6965 7261 7263 6869 6361 6c28 2068  _hierarchical( h
+00046cf0: 6965 7266 6e20 290a 2020 2020 6966 2065  ierfn ).    if e
+00046d00: 7869 7374 7328 2068 6965 7266 6e20 2b20  xists( hierfn + 
+00046d10: 276d 6d77 6964 652e 6373 7627 2029 203a  'mmwide.csv' ) :
+00046d20: 0a20 2020 2020 2020 2074 3177 6964 6520  .        t1wide 
+00046d30: 3d20 7064 2e72 6561 645f 6373 7628 2068  = pd.read_csv( h
+00046d40: 6965 7266 6e20 2b20 276d 6d77 6964 652e  ierfn + 'mmwide.
+00046d50: 6373 7627 2029 0a20 2020 2065 6c69 6620  csv' ).    elif 
+00046d60: 6e6f 7420 7465 7374 6c6f 6f70 3a0a 2020  not testloop:.  
+00046d70: 2020 2020 2020 7431 7769 6465 203d 2061        t1wide = a
+00046d80: 6e74 7370 7974 3177 2e6d 6572 6765 5f68  ntspyt1w.merge_h
+00046d90: 6965 7261 7263 6869 6361 6c5f 6373 7673  ierarchical_csvs
+00046da0: 5f74 6f5f 7769 6465 5f66 6f72 6d61 7428  _to_wide_format(
+00046db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00046dc0: 2068 6965 725b 2764 6174 6166 7261 6d65   hier['dataframe
+00046dd0: 7327 5d2c 2069 6465 6e74 6966 6965 723d  s'], identifier=
+00046de0: 4e6f 6e65 2029 0a20 2020 2069 6620 7372  None ).    if sr
+00046df0: 6d6f 6465 6c5f 5431 2069 7320 6e6f 7420  model_T1 is not 
+00046e00: 4661 6c73 6520 3a0a 2020 2020 2020 2020  False :.        
+00046e10: 6869 6572 666e 5352 203d 2072 652e 7375  hierfnSR = re.su
+00046e20: 6228 2073 6f75 7263 6564 6174 6166 6f6c  b( sourcedatafol
+00046e30: 6465 726e 616d 652c 2070 726f 6365 7373  dername, process
+00046e40: 4469 722c 2074 3166 6e29 0a20 2020 2020  Dir, t1fn).     
+00046e50: 2020 2068 6965 7266 6e53 5220 3d20 7265     hierfnSR = re
+00046e60: 2e73 7562 2820 2254 3177 222c 2022 5431  .sub( "T1w", "T1
+00046e70: 7748 6965 7261 7263 6869 6361 6c53 5222  wHierarchicalSR"
+00046e80: 2c20 6869 6572 666e 5352 290a 2020 2020  , hierfnSR).    
+00046e90: 2020 2020 6869 6572 666e 5352 203d 2072      hierfnSR = r
+00046ea0: 652e 7375 6228 2022 2e6e 6969 2e67 7a22  e.sub( ".nii.gz"
+00046eb0: 2c20 2222 2c20 6869 6572 666e 5352 290a  , "", hierfnSR).
+00046ec0: 2020 2020 2020 2020 6869 6572 666e 5352          hierfnSR
+00046ed0: 203d 2068 6965 7266 6e53 5220 2b20 6d79   = hierfnSR + my
+00046ee0: 7365 700a 2020 2020 2020 2020 6869 6572  sep.        hier
+00046ef0: 666e 7465 7374 203d 2068 6965 7266 6e53  fntest = hierfnS
+00046f00: 5220 2b20 276d 746c 2e63 7376 270a 2020  R + 'mtl.csv'.  
+00046f10: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
+00046f20: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
+00046f30: 696e 7428 2068 6965 7266 6e74 6573 7420  int( hierfntest 
+00046f40: 290a 2020 2020 2020 2020 6869 6572 6578  ).        hierex
+00046f50: 6973 7473 203d 2065 7869 7374 7328 2068  ists = exists( h
+00046f60: 6965 7266 6e74 6573 7420 2920 2320 4649  ierfntest ) # FI
+00046f70: 584d 4520 7368 6f75 6c64 2074 6573 7420  XME should test 
+00046f80: 7468 6973 2065 7870 6c69 6369 746c 7920  this explicitly 
+00046f90: 6275 7420 7765 2061 7373 756d 6520 6974  but we assume it
+00046fa0: 2068 6572 650a 2020 2020 2020 2020 6966   here.        if
+00046fb0: 206e 6f74 2068 6965 7265 7869 7374 733a   not hierexists:
+00046fc0: 0a20 2020 2020 2020 2020 2020 2073 7562  .            sub
+00046fd0: 6a65 6374 7072 6f70 6174 6820 3d20 6f73  jectpropath = os
+00046fe0: 2e70 6174 682e 6469 726e 616d 6528 2068  .path.dirname( h
+00046ff0: 6965 7266 6e53 5220 290a 2020 2020 2020  ierfnSR ).      
+00047000: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
+00047010: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00047020: 2020 7072 696e 7428 2073 7562 6a65 6374    print( subject
+00047030: 7072 6f70 6174 6820 290a 2020 2020 2020  propath ).      
+00047040: 2020 2020 2020 6f73 2e6d 616b 6564 6972        os.makedir
+00047050: 7328 2073 7562 6a65 6374 7072 6f70 6174  s( subjectpropat
+00047060: 682c 2065 7869 7374 5f6f 6b3d 5472 7565  h, exist_ok=True
+00047070: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00047080: 2320 6869 6572 6172 6368 6963 616c 5f74  # hierarchical_t
+00047090: 6f5f 7372 2874 3168 6965 722c 2073 725f  o_sr(t1hier, sr_
+000470a0: 6d6f 6465 6c2c 2074 6973 7375 655f 7372  model, tissue_sr
+000470b0: 3d46 616c 7365 2c20 626c 656e 6469 6e67  =False, blending
+000470c0: 3d30 2e35 2c20 7665 7262 6f73 653d 4661  =0.5, verbose=Fa
+000470d0: 6c73 6529 0a20 2020 2020 2020 2020 2020  lse).           
+000470e0: 2062 6573 7475 7020 3d20 7369 712e 6f70   bestup = siq.op
+000470f0: 7469 6d69 7a65 5f75 7073 616d 706c 696e  timize_upsamplin
+00047100: 675f 7368 6170 6528 2061 6e74 732e 6765  g_shape( ants.ge
+00047110: 745f 7370 6163 696e 6728 7431 292c 206d  t_spacing(t1), m
+00047120: 6f64 616c 6974 793d 2754 3127 2029 0a20  odality='T1' ). 
+00047130: 2020 2020 2020 2020 2020 206d 646c 666e             mdlfn
+00047140: 203d 2065 785f 7061 7468 6d6d 202b 2022   = ex_pathmm + "
+00047150: 7369 715f 6465 6661 756c 745f 7369 7372  siq_default_sisr
+00047160: 5f22 202b 2062 6573 7475 7020 2b20 225f  _" + bestup + "_
+00047170: 3263 6861 6e5f 6665 6174 7667 674c 365f  2chan_featvggL6_
+00047180: 706f 7374 7365 675f 6265 7374 5f6d 646c  postseg_best_mdl
+00047190: 2e68 3522 0a20 2020 2020 2020 2020 2020  .h5".           
+000471a0: 2069 6620 6973 696e 7374 616e 6365 2820   if isinstance( 
+000471b0: 7372 6d6f 6465 6c5f 5431 2c20 7374 7220  srmodel_T1, str 
+000471c0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000471d0: 2020 206d 646c 666e 203d 206f 732e 7061     mdlfn = os.pa
+000471e0: 7468 2e6a 6f69 6e28 2065 785f 7061 7468  th.join( ex_path
+000471f0: 6d6d 2c20 7372 6d6f 6465 6c5f 5431 2029  mm, srmodel_T1 )
+00047200: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00047210: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+00047220: 2020 2020 2020 2020 2070 7269 6e74 2820           print( 
+00047230: 6d64 6c66 6e20 290a 2020 2020 2020 2020  mdlfn ).        
+00047240: 2020 2020 6966 2065 7869 7374 7328 206d      if exists( m
+00047250: 646c 666e 2029 3a0a 2020 2020 2020 2020  dlfn ):.        
+00047260: 2020 2020 2020 2020 7372 6d6f 6465 6c5f          srmodel_
+00047270: 5431 5f6d 646c 203d 2074 662e 6b65 7261  T1_mdl = tf.kera
+00047280: 732e 6d6f 6465 6c73 2e6c 6f61 645f 6d6f  s.models.load_mo
+00047290: 6465 6c28 206d 646c 666e 2c20 636f 6d70  del( mdlfn, comp
+000472a0: 696c 653d 4661 6c73 6520 290a 2020 2020  ile=False ).    
+000472b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000472c0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000472d0: 696e 7428 206d 646c 666e 202b 2022 2064  int( mdlfn + " d
+000472e0: 6f65 7320 6e6f 7420 6578 6973 7420 2d20  oes not exist - 
+000472f0: 7769 6c6c 206e 6f74 2072 756e 2e22 290a  will not run.").
+00047300: 2020 2020 2020 2020 2020 2020 6869 6572              hier
+00047310: 5352 203d 2061 6e74 7370 7974 3177 2e68  SR = antspyt1w.h
+00047320: 6965 7261 7263 6869 6361 6c5f 746f 5f73  ierarchical_to_s
+00047330: 7228 2068 6965 722c 2073 726d 6f64 656c  r( hier, srmodel
+00047340: 5f54 315f 6d64 6c2c 2062 6c65 6e64 696e  _T1_mdl, blendin
+00047350: 673d 4e6f 6e65 2c20 7469 7373 7565 5f73  g=None, tissue_s
+00047360: 723d 4661 6c73 6520 290a 2020 2020 2020  r=False ).      
+00047370: 2020 2020 2020 616e 7473 7079 7431 772e        antspyt1w.
+00047380: 7772 6974 655f 6869 6572 6172 6368 6963  write_hierarchic
+00047390: 616c 2820 6869 6572 5352 2c20 6869 6572  al( hierSR, hier
+000473a0: 666e 5352 2029 0a20 2020 2020 2020 2020  fnSR ).         
+000473b0: 2020 2074 3177 6964 6553 5220 3d20 616e     t1wideSR = an
+000473c0: 7473 7079 7431 772e 6d65 7267 655f 6869  tspyt1w.merge_hi
+000473d0: 6572 6172 6368 6963 616c 5f63 7376 735f  erarchical_csvs_
+000473e0: 746f 5f77 6964 655f 666f 726d 6174 280a  to_wide_format(.
+000473f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047400: 2020 2020 6869 6572 5352 5b27 6461 7461      hierSR['data
+00047410: 6672 616d 6573 275d 2c20 6964 656e 7469  frames'], identi
+00047420: 6669 6572 3d4e 6f6e 6520 290a 2020 2020  fier=None ).    
+00047430: 2020 2020 2020 2020 7431 7769 6465 5352          t1wideSR
+00047440: 2e74 6f5f 6373 7628 2068 6965 7266 6e53  .to_csv( hierfnS
+00047450: 5220 2b20 276d 6d77 6964 652e 6373 7627  R + 'mmwide.csv'
+00047460: 2029 0a20 2020 2068 6965 7220 3d20 616e   ).    hier = an
+00047470: 7473 7079 7431 772e 7265 6164 5f68 6965  tspyt1w.read_hie
+00047480: 7261 7263 6869 6361 6c28 2068 6965 7266  rarchical( hierf
+00047490: 6e20 290a 2020 2020 6966 2065 7869 7374  n ).    if exist
+000474a0: 7328 2068 6965 7266 6e20 2b20 276d 6d77  s( hierfn + 'mmw
+000474b0: 6964 652e 6373 7627 2029 203a 0a20 2020  ide.csv' ) :.   
+000474c0: 2020 2020 2074 3177 6964 6520 3d20 7064       t1wide = pd
+000474d0: 2e72 6561 645f 6373 7628 2068 6965 7266  .read_csv( hierf
+000474e0: 6e20 2b20 276d 6d77 6964 652e 6373 7627  n + 'mmwide.csv'
+000474f0: 2029 0a20 2020 2065 6c69 6620 6e6f 7420   ).    elif not 
+00047500: 7465 7374 6c6f 6f70 3a0a 2020 2020 2020  testloop:.      
+00047510: 2020 7431 7769 6465 203d 2061 6e74 7370    t1wide = antsp
+00047520: 7974 3177 2e6d 6572 6765 5f68 6965 7261  yt1w.merge_hiera
+00047530: 7263 6869 6361 6c5f 6373 7673 5f74 6f5f  rchical_csvs_to_
+00047540: 7769 6465 5f66 6f72 6d61 7428 0a20 2020  wide_format(.   
+00047550: 2020 2020 2020 2020 2020 2020 2068 6965               hie
+00047560: 725b 2764 6174 6166 7261 6d65 7327 5d2c  r['dataframes'],
+00047570: 2069 6465 6e74 6966 6965 723d 4e6f 6e65   identifier=None
+00047580: 2029 0a20 2020 2069 6620 6e6f 7420 7465   ).    if not te
+00047590: 7374 6c6f 6f70 3a0a 2020 2020 2020 2020  stloop:.        
+000475a0: 7431 696d 6762 726e 203d 2068 6965 725b  t1imgbrn = hier[
+000475b0: 2762 7261 696e 5f6e 345f 646e 7a27 5d0a  'brain_n4_dnz'].
+000475c0: 2020 2020 2020 2020 7431 6174 726f 706f          t1atropo
+000475d0: 7320 3d20 6869 6572 5b27 646b 745f 7061  s = hier['dkt_pa
+000475e0: 7263 275d 5b27 7469 7373 7565 5f73 6567  rc']['tissue_seg
+000475f0: 6d65 6e74 6174 696f 6e27 5d0a 2020 2020  mentation'].    
+00047600: 2320 6c6f 6f70 206f 7665 7220 6d6f 6461  # loop over moda
+00047610: 6c69 7469 6573 2061 6e64 2074 6865 6e20  lities and then 
+00047620: 756e 6971 7565 2069 6d61 6765 2049 4473  unique image IDs
+00047630: 0a20 2020 2023 2077 6520 7472 6561 7420  .    # we treat 
+00047640: 4e4d 2069 6e20 6120 2273 7065 6369 616c  NM in a "special
+00047650: 2220 7761 7920 2d2d 2061 6767 7265 6761  " way -- aggrega
+00047660: 7469 6e67 2072 6570 6561 7473 0a20 2020  ting repeats.   
+00047670: 2023 206f 7468 6572 206d 6f64 616c 6974   # other modalit
+00047680: 6965 7320 2862 6579 6f6e 6420 5431 2920  ies (beyond T1) 
+00047690: 6172 6520 7472 6561 7465 6420 696e 6469  are treated indi
+000476a0: 7669 6475 616c 6c79 0a20 2020 206e 696d  vidually.    nim
+000476b0: 6167 6573 203d 206c 656e 286d 7969 6d67  ages = len(myimg
+000476c0: 7349 6e70 7574 290a 2020 2020 6966 2076  sInput).    if v
+000476d0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+000476e0: 7072 696e 7428 2020 2220 7765 2068 6176  print(  " we hav
+000476f0: 6520 3a20 2220 2b20 7374 7228 6e69 6d61  e : " + str(nima
+00047700: 6765 7329 202b 2022 206d 6f64 616c 6974  ges) + " modalit
+00047710: 6965 732e 2229 0a20 2020 2066 6f72 206f  ies.").    for o
+00047720: 7665 726d 6f64 5820 696e 206e 7267 5f6d  vermodX in nrg_m
+00047730: 6f64 616c 6974 795f 6c69 7374 3a0a 2020  odality_list:.  
+00047740: 2020 2020 2020 636f 756e 7465 723d 636f        counter=co
+00047750: 756e 7465 722b 310a 2020 2020 2020 2020  unter+1.        
+00047760: 6966 2063 6f75 6e74 6572 203e 2028 6c65  if counter > (le
+00047770: 6e28 6e72 675f 6d6f 6461 6c69 7479 5f6c  n(nrg_modality_l
+00047780: 6973 7429 2b31 293a 0a20 2020 2020 2020  ist)+1):.       
+00047790: 2020 2020 2070 7269 6e74 2822 5468 6973       print("This
+000477a0: 2069 7320 7765 6972 642e 2022 202b 2073   is weird. " + s
+000477b0: 7472 2863 6f75 6e74 6572 2929 0a20 2020  tr(counter)).   
+000477c0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+000477d0: 2020 2020 2020 2020 6966 206f 7665 726d          if overm
+000477e0: 6f64 5820 3d3d 2027 5431 7727 3a0a 2020  odX == 'T1w':.  
+000477f0: 2020 2020 2020 2020 2020 6969 644f 7468            iidOth
+00047800: 6572 4d6f 6420 3d20 6969 640a 2020 2020  erMod = iid.    
+00047810: 2020 2020 2020 2020 6d6f 645f 7365 6172          mod_sear
+00047820: 6368 5f70 6174 6820 3d20 6f73 2e70 6174  ch_path = os.pat
+00047830: 682e 6a6f 696e 2873 7562 6a65 6374 726f  h.join(subjectro
+00047840: 6f74 7061 7468 2c20 6f76 6572 6d6f 6458  otpath, overmodX
+00047850: 2c20 6969 644f 7468 6572 4d6f 642c 2022  , iidOtherMod, "
+00047860: 2a6e 6969 2e67 7a22 290a 2020 2020 2020  *nii.gz").      
+00047870: 2020 2020 2020 6d79 696d 6773 7220 3d20        myimgsr = 
+00047880: 676c 6f62 2e67 6c6f 6228 6d6f 645f 7365  glob.glob(mod_se
+00047890: 6172 6368 5f70 6174 6829 0a20 2020 2020  arch_path).     
+000478a0: 2020 2065 6c69 6620 6f76 6572 6d6f 6458     elif overmodX
+000478b0: 203d 3d20 274e 4d32 444d 5427 2061 6e64   == 'NM2DMT' and
+000478c0: 2028 276e 6d69 6431 2720 696e 2073 7475   ('nmid1' in stu
+000478d0: 6479 6964 2e6b 6579 7328 2920 293a 0a20  dyid.keys() ):. 
+000478e0: 2020 2020 2020 2020 2020 2069 6964 4f74             iidOt
+000478f0: 6865 724d 6f64 203d 2073 7472 2820 696e  herMod = str( in
+00047900: 7428 7374 7564 7969 645b 276e 6d69 6431  t(studyid['nmid1
+00047910: 275d 2e69 6c6f 635b 305d 2920 290a 2020  '].iloc[0]) ).  
+00047920: 2020 2020 2020 2020 2020 6d6f 645f 7365            mod_se
+00047930: 6172 6368 5f70 6174 6820 3d20 6f73 2e70  arch_path = os.p
+00047940: 6174 682e 6a6f 696e 2873 7562 6a65 6374  ath.join(subject
+00047950: 726f 6f74 7061 7468 2c20 6f76 6572 6d6f  rootpath, overmo
+00047960: 6458 2c20 6969 644f 7468 6572 4d6f 642c  dX, iidOtherMod,
+00047970: 2022 2a6e 6969 2e67 7a22 290a 2020 2020   "*nii.gz").    
+00047980: 2020 2020 2020 2020 6d79 696d 6773 7220          myimgsr 
+00047990: 3d20 676c 6f62 2e67 6c6f 6228 6d6f 645f  = glob.glob(mod_
+000479a0: 7365 6172 6368 5f70 6174 6829 0a20 2020  search_path).   
+000479b0: 2020 2020 2020 2020 2066 6f72 206e 6d6e           for nmn
+000479c0: 756d 2069 6e20 7261 6e67 6528 322c 3131  um in range(2,11
+000479d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000479e0: 2020 206c 6f63 6e6d 6e75 6d20 3d20 276e     locnmnum = 'n
+000479f0: 6d69 6427 2b73 7472 286e 6d6e 756d 290a  mid'+str(nmnum).
+00047a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047a10: 6966 206c 6f63 6e6d 6e75 6d20 696e 2073  if locnmnum in s
+00047a20: 7475 6479 6964 2e6b 6579 7328 2920 3a0a  tudyid.keys() :.
+00047a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047a40: 2020 2020 6969 644f 7468 6572 4d6f 6420      iidOtherMod 
+00047a50: 3d20 7374 7228 2069 6e74 2873 7475 6479  = str( int(study
+00047a60: 6964 5b6c 6f63 6e6d 6e75 6d5d 2e69 6c6f  id[locnmnum].ilo
+00047a70: 635b 305d 2920 290a 2020 2020 2020 2020  c[0]) ).        
+00047a80: 2020 2020 2020 2020 2020 2020 6d6f 645f              mod_
+00047a90: 7365 6172 6368 5f70 6174 6820 3d20 6f73  search_path = os
+00047aa0: 2e70 6174 682e 6a6f 696e 2873 7562 6a65  .path.join(subje
+00047ab0: 6374 726f 6f74 7061 7468 2c20 6f76 6572  ctrootpath, over
+00047ac0: 6d6f 6458 2c20 6969 644f 7468 6572 4d6f  modX, iidOtherMo
+00047ad0: 642c 2022 2a6e 6969 2e67 7a22 290a 2020  d, "*nii.gz").  
+00047ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047af0: 2020 6d79 696d 6773 722e 6170 7065 6e64    myimgsr.append
+00047b00: 2820 676c 6f62 2e67 6c6f 6228 6d6f 645f  ( glob.glob(mod_
+00047b10: 7365 6172 6368 5f70 6174 6829 5b30 5d20  search_path)[0] 
+00047b20: 290a 2020 2020 2020 2020 656c 6966 2027  ).        elif '
+00047b30: 7273 664d 5249 2720 696e 206f 7665 726d  rsfMRI' in overm
+00047b40: 6f64 5820 616e 6420 2820 2820 2772 7366  odX and ( ( 'rsf
+00047b50: 6964 3127 2069 6e20 7374 7564 7969 642e  id1' in studyid.
+00047b60: 6b65 7973 2829 2029 206f 7220 2827 7273  keys() ) or ('rs
+00047b70: 6669 6432 2720 696e 2073 7475 6479 6964  fid2' in studyid
+00047b80: 2e6b 6579 7328 2920 2920 293a 0a20 2020  .keys() ) ):.   
+00047b90: 2020 2020 2020 2020 206d 7969 6d67 7372           myimgsr
+00047ba0: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+00047bb0: 2020 6966 2020 2772 7366 6964 3127 2069    if  'rsfid1' i
+00047bc0: 6e20 7374 7564 7969 642e 6b65 7973 2829  n studyid.keys()
+00047bd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00047be0: 2020 6969 644f 7468 6572 4d6f 6420 3d20    iidOtherMod = 
+00047bf0: 7374 7228 2069 6e74 2873 7475 6479 6964  str( int(studyid
+00047c00: 5b27 7273 6669 6431 275d 2e69 6c6f 635b  ['rsfid1'].iloc[
+00047c10: 305d 2920 290a 2020 2020 2020 2020 2020  0]) ).          
+00047c20: 2020 2020 2020 6d6f 645f 7365 6172 6368        mod_search
+00047c30: 5f70 6174 6820 3d20 6f73 2e70 6174 682e  _path = os.path.
+00047c40: 6a6f 696e 2873 7562 6a65 6374 726f 6f74  join(subjectroot
+00047c50: 7061 7468 2c20 6f76 6572 6d6f 6458 2b22  path, overmodX+"
+00047c60: 2a22 2c20 6969 644f 7468 6572 4d6f 642c  *", iidOtherMod,
+00047c70: 2022 2a6e 6969 2e67 7a22 290a 2020 2020   "*nii.gz").    
+00047c80: 2020 2020 2020 2020 2020 2020 6d79 696d              myim
+00047c90: 6773 722e 6170 7065 6e64 2820 676c 6f62  gsr.append( glob
+00047ca0: 2e67 6c6f 6228 6d6f 645f 7365 6172 6368  .glob(mod_search
+00047cb0: 5f70 6174 6829 5b30 5d20 290a 2020 2020  _path)[0] ).    
+00047cc0: 2020 2020 2020 2020 6966 2020 2772 7366          if  'rsf
+00047cd0: 6964 3227 2069 6e20 7374 7564 7969 642e  id2' in studyid.
+00047ce0: 6b65 7973 2829 3a0a 2020 2020 2020 2020  keys():.        
+00047cf0: 2020 2020 2020 2020 6969 644f 7468 6572          iidOther
+00047d00: 4d6f 6420 3d20 7374 7228 2069 6e74 2873  Mod = str( int(s
+00047d10: 7475 6479 6964 5b27 7273 6669 6432 275d  tudyid['rsfid2']
+00047d20: 2e69 6c6f 635b 305d 2920 290a 2020 2020  .iloc[0]) ).    
+00047d30: 2020 2020 2020 2020 2020 2020 6d6f 645f              mod_
+00047d40: 7365 6172 6368 5f70 6174 6820 3d20 6f73  search_path = os
+00047d50: 2e70 6174 682e 6a6f 696e 2873 7562 6a65  .path.join(subje
+00047d60: 6374 726f 6f74 7061 7468 2c20 6f76 6572  ctrootpath, over
+00047d70: 6d6f 6458 2b22 2a22 2c20 6969 644f 7468  modX+"*", iidOth
+00047d80: 6572 4d6f 642c 2022 2a6e 6969 2e67 7a22  erMod, "*nii.gz"
+00047d90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00047da0: 2020 6d79 696d 6773 722e 6170 7065 6e64    myimgsr.append
+00047db0: 2820 676c 6f62 2e67 6c6f 6228 6d6f 645f  ( glob.glob(mod_
+00047dc0: 7365 6172 6368 5f70 6174 6829 5b30 5d20  search_path)[0] 
+00047dd0: 290a 2020 2020 2020 2020 656c 6966 2027  ).        elif '
+00047de0: 4454 4927 2069 6e20 6f76 6572 6d6f 6458  DTI' in overmodX
+00047df0: 2061 6e64 2028 2020 2764 7469 6431 2720   and (  'dtid1' 
+00047e00: 696e 2073 7475 6479 6964 2e6b 6579 7328  in studyid.keys(
+00047e10: 2920 6f72 2020 2764 7469 6432 2720 696e  ) or  'dtid2' in
+00047e20: 2073 7475 6479 6964 2e6b 6579 7328 2920   studyid.keys() 
+00047e30: 293a 0a20 2020 2020 2020 2020 2020 206d  ):.            m
+00047e40: 7969 6d67 7372 203d 205b 5d0a 2020 2020  yimgsr = [].    
+00047e50: 2020 2020 2020 2020 6966 2020 2764 7469          if  'dti
+00047e60: 6431 2720 696e 2073 7475 6479 6964 2e6b  d1' in studyid.k
+00047e70: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
+00047e80: 2020 2020 2020 2069 6964 4f74 6865 724d         iidOtherM
+00047e90: 6f64 203d 2073 7472 2820 696e 7428 7374  od = str( int(st
+00047ea0: 7564 7969 645b 2764 7469 6431 275d 2e69  udyid['dtid1'].i
+00047eb0: 6c6f 635b 305d 2920 290a 2020 2020 2020  loc[0]) ).      
+00047ec0: 2020 2020 2020 2020 2020 6d6f 645f 7365            mod_se
+00047ed0: 6172 6368 5f70 6174 6820 3d20 6f73 2e70  arch_path = os.p
+00047ee0: 6174 682e 6a6f 696e 2873 7562 6a65 6374  ath.join(subject
+00047ef0: 726f 6f74 7061 7468 2c20 6f76 6572 6d6f  rootpath, overmo
+00047f00: 6458 2b22 2a22 2c20 6969 644f 7468 6572  dX+"*", iidOther
+00047f10: 4d6f 642c 2022 2a6e 6969 2e67 7a22 290a  Mod, "*nii.gz").
+00047f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047f30: 6d79 696d 6773 722e 6170 7065 6e64 2820  myimgsr.append( 
+00047f40: 676c 6f62 2e67 6c6f 6228 6d6f 645f 7365  glob.glob(mod_se
+00047f50: 6172 6368 5f70 6174 6829 5b30 5d20 290a  arch_path)[0] ).
+00047f60: 2020 2020 2020 2020 2020 2020 6966 2020              if  
+00047f70: 2764 7469 6432 2720 696e 2073 7475 6479  'dtid2' in study
+00047f80: 6964 2e6b 6579 7328 293a 0a20 2020 2020  id.keys():.     
+00047f90: 2020 2020 2020 2020 2020 2069 6964 4f74             iidOt
+00047fa0: 6865 724d 6f64 203d 2073 7472 2820 696e  herMod = str( in
+00047fb0: 7428 7374 7564 7969 645b 2764 7469 6432  t(studyid['dtid2
+00047fc0: 275d 2e69 6c6f 635b 305d 2920 290a 2020  '].iloc[0]) ).  
+00047fd0: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+00047fe0: 645f 7365 6172 6368 5f70 6174 6820 3d20  d_search_path = 
+00047ff0: 6f73 2e70 6174 682e 6a6f 696e 2873 7562  os.path.join(sub
+00048000: 6a65 6374 726f 6f74 7061 7468 2c20 6f76  jectrootpath, ov
+00048010: 6572 6d6f 6458 2b22 2a22 2c20 6969 644f  ermodX+"*", iidO
+00048020: 7468 6572 4d6f 642c 2022 2a6e 6969 2e67  therMod, "*nii.g
+00048030: 7a22 290a 2020 2020 2020 2020 2020 2020  z").            
+00048040: 2020 2020 6d79 696d 6773 722e 6170 7065      myimgsr.appe
+00048050: 6e64 2820 676c 6f62 2e67 6c6f 6228 6d6f  nd( glob.glob(mo
+00048060: 645f 7365 6172 6368 5f70 6174 6829 5b30  d_search_path)[0
+00048070: 5d20 290a 2020 2020 2020 2020 656c 6966  ] ).        elif
+00048080: 2027 5432 466c 6169 7227 2069 6e20 6f76   'T2Flair' in ov
+00048090: 6572 6d6f 6458 2061 6e64 2028 2766 6c61  ermodX and ('fla
+000480a0: 6972 6964 2720 696e 2073 7475 6479 6964  irid' in studyid
+000480b0: 2e6b 6579 7328 2920 293a 0a20 2020 2020  .keys() ):.     
+000480c0: 2020 2020 2020 2069 6964 4f74 6865 724d         iidOtherM
+000480d0: 6f64 203d 2073 7472 2820 696e 7428 7374  od = str( int(st
+000480e0: 7564 7969 645b 2766 6c61 6972 6964 275d  udyid['flairid']
+000480f0: 2e69 6c6f 635b 305d 2920 290a 2020 2020  .iloc[0]) ).    
+00048100: 2020 2020 2020 2020 6d6f 645f 7365 6172          mod_sear
+00048110: 6368 5f70 6174 6820 3d20 6f73 2e70 6174  ch_path = os.pat
+00048120: 682e 6a6f 696e 2873 7562 6a65 6374 726f  h.join(subjectro
+00048130: 6f74 7061 7468 2c20 6f76 6572 6d6f 6458  otpath, overmodX
+00048140: 2c20 6969 644f 7468 6572 4d6f 642c 2022  , iidOtherMod, "
+00048150: 2a6e 6969 2e67 7a22 290a 2020 2020 2020  *nii.gz").      
+00048160: 2020 2020 2020 6d79 696d 6773 7220 3d20        myimgsr = 
+00048170: 676c 6f62 2e67 6c6f 6228 6d6f 645f 7365  glob.glob(mod_se
+00048180: 6172 6368 5f70 6174 6829 0a20 2020 2020  arch_path).     
+00048190: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
+000481a0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+000481b0: 2820 226f 7665 726d 6f64 2022 202b 206f  ( "overmod " + o
+000481c0: 7665 726d 6f64 5820 2b20 2220 2220 2b20  vermodX + " " + 
+000481d0: 6969 644f 7468 6572 4d6f 6420 290a 2020  iidOtherMod ).  
 000481e0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-000481f0: 2022 7375 626a 6563 7470 726f 7061 7468   "subjectpropath
-00048200: 2022 202b 2073 7562 6a65 6374 7072 6f70   " + subjectprop
-00048210: 6174 6820 290a 2020 2020 2020 2020 2020  ath ).          
-00048220: 2020 2020 2020 6d79 7370 6c69 7420 3d20        mysplit = 
-00048230: 7375 626a 6563 7470 726f 7061 7468 2e73  subjectpropath.s
-00048240: 706c 6974 2820 222f 2220 290a 2020 2020  plit( "/" ).    
-00048250: 2020 2020 2020 2020 2020 2020 6f73 2e6d              os.m
-00048260: 616b 6564 6972 7328 2073 7562 6a65 6374  akedirs( subject
-00048270: 7072 6f70 6174 682c 2065 7869 7374 5f6f  propath, exist_o
-00048280: 6b3d 5472 7565 2020 290a 2020 2020 2020  k=True  ).      
-00048290: 2020 2020 2020 2020 2020 6d79 7370 6c69            myspli
-000482a0: 7443 6f75 6e74 203d 206c 656e 2820 6d79  tCount = len( my
-000482b0: 7370 6c69 7420 290a 2020 2020 2020 2020  split ).        
-000482c0: 2020 2020 2020 2020 7072 6f6a 6563 7420          project 
-000482d0: 3d20 6d79 7370 6c69 745b 6d79 7370 6c69  = mysplit[myspli
-000482e0: 7443 6f75 6e74 2d35 5d0a 2020 2020 2020  tCount-5].      
-000482f0: 2020 2020 2020 2020 2020 7375 626a 6563            subjec
-00048300: 7420 3d20 6d79 7370 6c69 745b 6d79 7370  t = mysplit[mysp
-00048310: 6c69 7443 6f75 6e74 2d34 5d0a 2020 2020  litCount-4].    
-00048320: 2020 2020 2020 2020 2020 2020 6461 7465              date
-00048330: 203d 206d 7973 706c 6974 5b6d 7973 706c   = mysplit[myspl
-00048340: 6974 436f 756e 742d 335d 0a20 2020 2020  itCount-3].     
-00048350: 2020 2020 2020 2020 2020 206d 6f64 616c             modal
-00048360: 6974 7920 3d20 6d79 7370 6c69 745b 6d79  ity = mysplit[my
-00048370: 7370 6c69 7443 6f75 6e74 2d32 5d0a 2020  splitCount-2].  
-00048380: 2020 2020 2020 2020 2020 2020 2020 7569                ui
-00048390: 6465 7220 3d20 6d79 7370 6c69 745b 6d79  der = mysplit[my
-000483a0: 7370 6c69 7443 6f75 6e74 2d31 5d0a 2020  splitCount-1].  
-000483b0: 2020 2020 2020 2020 2020 2020 2020 6964                id
-000483c0: 656e 7469 6669 6572 203d 206d 7973 6570  entifier = mysep
-000483d0: 2e6a 6f69 6e28 5b70 726f 6a65 6374 2c20  .join([project, 
-000483e0: 7375 626a 6563 742c 2064 6174 652c 206d  subject, date, m
-000483f0: 6f64 616c 6974 7920 5d29 0a20 2020 2020  odality ]).     
-00048400: 2020 2020 2020 2020 2020 2069 6465 6e74             ident
-00048410: 6966 6965 7220 3d20 6964 656e 7469 6669  ifier = identifi
-00048420: 6572 202b 2022 5f22 202b 2069 6964 0a20  er + "_" + iid. 
-00048430: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00048440: 796d 6d20 3d20 7375 626a 6563 7470 726f  ymm = subjectpro
-00048450: 7061 7468 202b 2022 2f22 202b 2069 6465  path + "/" + ide
-00048460: 6e74 6966 6965 720a 2020 2020 2020 2020  ntifier.        
-00048470: 2020 2020 2020 2020 6d79 6d6d 6f75 7420          mymmout 
-00048480: 3d20 6d61 6b65 7769 6465 6f75 7428 206d  = makewideout( m
-00048490: 796d 6d20 290a 2020 2020 2020 2020 2020  ymm ).          
-000484a0: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-000484b0: 2061 6e64 206e 6f74 2065 7869 7374 7328   and not exists(
-000484c0: 206d 796d 6d6f 7574 2029 3a0a 2020 2020   mymmout ):.    
-000484d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000484e0: 7072 696e 7428 2022 4e4d 2022 202b 206d  print( "NM " + m
-000484f0: 796d 6d20 202b 2027 2065 7865 6375 7469  ymm  + ' executi
-00048500: 6f6e 2027 290a 2020 2020 2020 2020 2020  on ').          
-00048510: 2020 2020 2020 656c 6966 2076 6572 626f        elif verbo
-00048520: 7365 2061 6e64 2065 7869 7374 7328 206d  se and exists( m
-00048530: 796d 6d6f 7574 2029 203a 0a20 2020 2020  ymmout ) :.     
-00048540: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00048550: 7269 6e74 2820 224e 4d20 2220 2b20 6d79  rint( "NM " + my
-00048560: 6d6d 202b 2027 2063 6f6d 706c 6574 6520  mm + ' complete 
-00048570: 2720 290a 2020 2020 2020 2020 2020 2020  ' ).            
-00048580: 2020 2020 6966 2065 7869 7374 7328 206d      if exists( m
-00048590: 796d 6d6f 7574 2029 3a0a 2020 2020 2020  ymmout ):.      
-000485a0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-000485b0: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
-000485c0: 2020 2020 2020 2069 6620 6973 3464 3a0a         if is4d:.
-000485d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000485e0: 2020 2020 6e6d 6c69 7374 203d 2061 6e74      nmlist = ant
-000485f0: 732e 6e64 696d 6167 655f 746f 5f6c 6973  s.ndimage_to_lis
-00048600: 7428 206d 6d5f 7265 6164 2820 6d79 696d  t( mm_read( myim
-00048610: 6773 7232 5b30 5d20 2920 290a 2020 2020  gsr2[0] ) ).    
-00048620: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00048630: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00048640: 2020 2020 2020 6e6d 6c69 7374 203d 205b        nmlist = [
-00048650: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00048660: 2020 2020 2020 666f 7220 7a7a 2069 6e20        for zz in 
-00048670: 6d79 696d 6773 7232 3a0a 2020 2020 2020  myimgsr2:.      
-00048680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048690: 2020 6e6d 6c69 7374 2e61 7070 656e 6428    nmlist.append(
-000486a0: 206d 6d5f 7265 6164 2820 7a7a 2029 2029   mm_read( zz ) )
-000486b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000486c0: 2073 726d 6f64 656c 5f4e 4d5f 6d64 6c20   srmodel_NM_mdl 
-000486d0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-000486e0: 2020 2020 2020 2069 6620 7372 6d6f 6465         if srmode
-000486f0: 6c5f 4e4d 2069 7320 6e6f 7420 4661 6c73  l_NM is not Fals
-00048700: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00048710: 2020 2020 2020 2062 6573 7475 7020 3d20         bestup = 
-00048720: 7369 712e 6f70 7469 6d69 7a65 5f75 7073  siq.optimize_ups
-00048730: 616d 706c 696e 675f 7368 6170 6528 2061  ampling_shape( a
-00048740: 6e74 732e 6765 745f 7370 6163 696e 6728  nts.get_spacing(
-00048750: 6e6d 6c69 7374 5b30 5d29 2c20 6d6f 6461  nmlist[0]), moda
-00048760: 6c69 7479 3d27 4e4d 272c 2072 6f75 6e64  lity='NM', round
-00048770: 6974 3d54 7275 6520 290a 2020 2020 2020  it=True ).      
-00048780: 2020 2020 2020 2020 2020 2020 2020 6d64                md
-00048790: 6c66 6e20 3d20 6578 5f70 6174 686d 6d20  lfn = ex_pathmm 
-000487a0: 2b20 2273 6971 5f64 6566 6175 6c74 5f73  + "siq_default_s
-000487b0: 6973 725f 2220 2b20 6265 7374 7570 202b  isr_" + bestup +
-000487c0: 2022 5f31 6368 616e 5f66 6561 7476 6767   "_1chan_featvgg
-000487d0: 4c36 5f62 6573 745f 6d64 6c2e 6835 220a  L6_best_mdl.h5".
-000487e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000487f0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00048800: 6528 2073 726d 6f64 656c 5f4e 4d2c 2073  e( srmodel_NM, s
-00048810: 7472 2029 3a0a 2020 2020 2020 2020 2020  tr ):.          
-00048820: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00048830: 6d6f 6465 6c5f 4e4d 203d 2072 652e 7375  model_NM = re.su
-00048840: 6228 2022 6265 7374 7570 222c 2062 6573  b( "bestup", bes
-00048850: 7475 702c 2073 726d 6f64 656c 5f4e 4d20  tup, srmodel_NM 
-00048860: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00048870: 2020 2020 2020 2020 2020 6d64 6c66 6e20            mdlfn 
-00048880: 3d20 6f73 2e70 6174 682e 6a6f 696e 2820  = os.path.join( 
-00048890: 6578 5f70 6174 686d 6d2c 2073 726d 6f64  ex_pathmm, srmod
-000488a0: 656c 5f4e 4d20 290a 2020 2020 2020 2020  el_NM ).        
-000488b0: 2020 2020 2020 2020 2020 2020 6966 2065              if e
-000488c0: 7869 7374 7328 206d 646c 666e 2029 3a0a  xists( mdlfn ):.
+000481f0: 6622 6d6f 6461 6c69 7479 2073 6561 7263  f"modality searc
+00048200: 6820 7061 7468 3a20 7b6d 6f64 5f73 6561  h path: {mod_sea
+00048210: 7263 685f 7061 7468 7d22 290a 2020 2020  rch_path}").    
+00048220: 2020 2020 6d79 696d 6773 722e 736f 7274      myimgsr.sort
+00048230: 2829 0a20 2020 2020 2020 2069 6620 6c65  ().        if le
+00048240: 6e28 6d79 696d 6773 7229 203e 2030 3a0a  n(myimgsr) > 0:.
+00048250: 2020 2020 2020 2020 2020 2020 6f76 6572              over
+00048260: 6d6f 6458 7820 3d20 7374 7228 6f76 6572  modXx = str(over
+00048270: 6d6f 6458 290a 2020 2020 2020 2020 2020  modX).          
+00048280: 2020 646f 7772 6974 653d 4661 6c73 650a    dowrite=False.
+00048290: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+000482a0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+000482b0: 2020 2020 2020 2020 7072 696e 7428 2027          print( '
+000482c0: 6f76 6572 6d6f 6458 2069 7320 3a20 2720  overmodX is : ' 
+000482d0: 2b20 6f76 6572 6d6f 6458 7820 290a 2020  + overmodXx ).  
+000482e0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000482f0: 696e 7428 2027 6578 616d 706c 6520 696d  int( 'example im
+00048300: 6167 6520 6e61 6d65 2069 7320 3a20 2720  age name is : ' 
+00048310: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00048320: 2020 2070 7269 6e74 2820 6d79 696d 6773     print( myimgs
+00048330: 7220 290a 2020 2020 2020 2020 2020 2020  r ).            
+00048340: 6966 206f 7665 726d 6f64 5878 203d 3d20  if overmodXx == 
+00048350: 274e 4d32 444d 5427 3a0a 2020 2020 2020  'NM2DMT':.      
+00048360: 2020 2020 2020 2020 2020 6d79 696d 6773            myimgs
+00048370: 7232 203d 206d 7969 6d67 7372 0a20 2020  r2 = myimgsr.   
+00048380: 2020 2020 2020 2020 2020 2020 206d 7969               myi
+00048390: 6d67 7372 322e 736f 7274 2829 0a20 2020  mgsr2.sort().   
+000483a0: 2020 2020 2020 2020 2020 2020 2069 7334               is4
+000483b0: 6420 3d20 4661 6c73 650a 2020 2020 2020  d = False.      
+000483c0: 2020 2020 2020 2020 2020 7465 6d70 203d            temp =
+000483d0: 2061 6e74 732e 696d 6167 655f 7265 6164   ants.image_read
+000483e0: 2820 6d79 696d 6773 7232 5b30 5d20 290a  ( myimgsr2[0] ).
+000483f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048400: 6966 2074 656d 702e 6469 6d65 6e73 696f  if temp.dimensio
+00048410: 6e20 3d3d 2034 3a0a 2020 2020 2020 2020  n == 4:.        
+00048420: 2020 2020 2020 2020 2020 2020 6973 3464              is4d
+00048430: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+00048440: 2020 2020 2020 2020 6966 206c 656e 2820          if len( 
+00048450: 6d79 696d 6773 7232 2029 203d 3d20 3120  myimgsr2 ) == 1 
+00048460: 616e 6420 6e6f 7420 6973 3464 3a20 2320  and not is4d: # 
+00048470: 6368 6563 6b20 6469 6d65 6e73 696f 6e0a  check dimension.
+00048480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048490: 2020 2020 6d79 696d 6773 7232 203d 206d      myimgsr2 = m
+000484a0: 7969 6d67 7372 3220 2b20 6d79 696d 6773  yimgsr2 + myimgs
+000484b0: 7232 0a20 2020 2020 2020 2020 2020 2020  r2.             
+000484c0: 2020 2073 7562 6a65 6374 7072 6f70 6174     subjectpropat
+000484d0: 6820 3d20 6f73 2e70 6174 682e 6469 726e  h = os.path.dirn
+000484e0: 616d 6528 206d 7969 6d67 7372 325b 305d  ame( myimgsr2[0]
+000484f0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00048500: 2020 2073 7562 6a65 6374 7072 6f70 6174     subjectpropat
+00048510: 6820 3d20 7265 2e73 7562 2820 736f 7572  h = re.sub( sour
+00048520: 6365 6461 7461 666f 6c64 6572 6e61 6d65  cedatafoldername
+00048530: 2c20 7072 6f63 6573 7344 6972 2c73 7562  , processDir,sub
+00048540: 6a65 6374 7072 6f70 6174 6820 290a 2020  jectpropath ).  
+00048550: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00048560: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+00048570: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00048580: 696e 7428 2022 7375 626a 6563 7470 726f  int( "subjectpro
+00048590: 7061 7468 2022 202b 2073 7562 6a65 6374  path " + subject
+000485a0: 7072 6f70 6174 6820 290a 2020 2020 2020  propath ).      
+000485b0: 2020 2020 2020 2020 2020 6d79 7370 6c69            myspli
+000485c0: 7420 3d20 7375 626a 6563 7470 726f 7061  t = subjectpropa
+000485d0: 7468 2e73 706c 6974 2820 222f 2220 290a  th.split( "/" ).
+000485e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000485f0: 6f73 2e6d 616b 6564 6972 7328 2073 7562  os.makedirs( sub
+00048600: 6a65 6374 7072 6f70 6174 682c 2065 7869  jectpropath, exi
+00048610: 7374 5f6f 6b3d 5472 7565 2020 290a 2020  st_ok=True  ).  
+00048620: 2020 2020 2020 2020 2020 2020 2020 6d79                my
+00048630: 7370 6c69 7443 6f75 6e74 203d 206c 656e  splitCount = len
+00048640: 2820 6d79 7370 6c69 7420 290a 2020 2020  ( mysplit ).    
+00048650: 2020 2020 2020 2020 2020 2020 7072 6f6a              proj
+00048660: 6563 7420 3d20 6d79 7370 6c69 745b 6d79  ect = mysplit[my
+00048670: 7370 6c69 7443 6f75 6e74 2d35 5d0a 2020  splitCount-5].  
+00048680: 2020 2020 2020 2020 2020 2020 2020 7375                su
+00048690: 626a 6563 7420 3d20 6d79 7370 6c69 745b  bject = mysplit[
+000486a0: 6d79 7370 6c69 7443 6f75 6e74 2d34 5d0a  mysplitCount-4].
+000486b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000486c0: 6461 7465 203d 206d 7973 706c 6974 5b6d  date = mysplit[m
+000486d0: 7973 706c 6974 436f 756e 742d 335d 0a20  ysplitCount-3]. 
+000486e0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000486f0: 6f64 616c 6974 7920 3d20 6d79 7370 6c69  odality = myspli
+00048700: 745b 6d79 7370 6c69 7443 6f75 6e74 2d32  t[mysplitCount-2
+00048710: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00048720: 2020 7569 6465 7220 3d20 6d79 7370 6c69    uider = myspli
+00048730: 745b 6d79 7370 6c69 7443 6f75 6e74 2d31  t[mysplitCount-1
+00048740: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00048750: 2020 6964 656e 7469 6669 6572 203d 206d    identifier = m
+00048760: 7973 6570 2e6a 6f69 6e28 5b70 726f 6a65  ysep.join([proje
+00048770: 6374 2c20 7375 626a 6563 742c 2064 6174  ct, subject, dat
+00048780: 652c 206d 6f64 616c 6974 7920 5d29 0a20  e, modality ]). 
+00048790: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000487a0: 6465 6e74 6966 6965 7220 3d20 6964 656e  dentifier = iden
+000487b0: 7469 6669 6572 202b 2022 5f22 202b 2069  tifier + "_" + i
+000487c0: 6964 0a20 2020 2020 2020 2020 2020 2020  id.             
+000487d0: 2020 206d 796d 6d20 3d20 7375 626a 6563     mymm = subjec
+000487e0: 7470 726f 7061 7468 202b 2022 2f22 202b  tpropath + "/" +
+000487f0: 2069 6465 6e74 6966 6965 720a 2020 2020   identifier.    
+00048800: 2020 2020 2020 2020 2020 2020 6d79 6d6d              mymm
+00048810: 6f75 7420 3d20 6d61 6b65 7769 6465 6f75  out = makewideou
+00048820: 7428 206d 796d 6d20 290a 2020 2020 2020  t( mymm ).      
+00048830: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+00048840: 626f 7365 2061 6e64 206e 6f74 2065 7869  bose and not exi
+00048850: 7374 7328 206d 796d 6d6f 7574 2029 3a0a  sts( mymmout ):.
+00048860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048870: 2020 2020 7072 696e 7428 2022 4e4d 2022      print( "NM "
+00048880: 202b 206d 796d 6d20 202b 2027 2065 7865   + mymm  + ' exe
+00048890: 6375 7469 6f6e 2027 290a 2020 2020 2020  cution ').      
+000488a0: 2020 2020 2020 2020 2020 656c 6966 2076            elif v
+000488b0: 6572 626f 7365 2061 6e64 2065 7869 7374  erbose and exist
+000488c0: 7328 206d 796d 6d6f 7574 2029 203a 0a20  s( mymmout ) :. 
 000488d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000488e0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-000488f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00048900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048910: 7072 696e 7428 6d64 6c66 6e29 0a20 2020  print(mdlfn).   
-00048920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048930: 2020 2020 2073 726d 6f64 656c 5f4e 4d5f       srmodel_NM_
-00048940: 6d64 6c20 3d20 7466 2e6b 6572 6173 2e6d  mdl = tf.keras.m
-00048950: 6f64 656c 732e 6c6f 6164 5f6d 6f64 656c  odels.load_model
-00048960: 2820 6d64 6c66 6e2c 2063 6f6d 7069 6c65  ( mdlfn, compile
-00048970: 3d46 616c 7365 2020 290a 2020 2020 2020  =False  ).      
-00048980: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00048990: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000489a0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-000489b0: 7428 206d 646c 666e 202b 2022 2064 6f65  t( mdlfn + " doe
-000489c0: 7320 6e6f 7420 6578 6973 7420 2d20 776f  s not exist - wo
-000489d0: 6e74 2075 7365 2053 5222 290a 2020 2020  nt use SR").    
-000489e0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-000489f0: 6f74 2074 6573 746c 6f6f 703a 0a20 2020  ot testloop:.   
-00048a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048a10: 2074 6162 5072 6f2c 206e 6f72 6d50 726f   tabPro, normPro
-00048a20: 203d 206d 6d28 2074 312c 2068 6965 722c   = mm( t1, hier,
-00048a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00048a40: 2020 2020 2020 2020 2020 2020 206e 6d5f               nm_
-00048a50: 696d 6167 655f 6c69 7374 203d 206e 6d6c  image_list = nml
-00048a60: 6973 742c 0a20 2020 2020 2020 2020 2020  ist,.           
-00048a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048a80: 2073 726d 6f64 656c 3d73 726d 6f64 656c   srmodel=srmodel
-00048a90: 5f4e 4d5f 6d64 6c2c 0a20 2020 2020 2020  _NM_mdl,.       
-00048aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048ab0: 2020 2020 2064 6f5f 7472 6163 746f 6772       do_tractogr
-00048ac0: 6170 6879 3d46 616c 7365 2c0a 2020 2020  aphy=False,.    
-00048ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048ae0: 2020 2020 2020 2020 646f 5f6b 6b3d 4661          do_kk=Fa
-00048af0: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
-00048b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048b10: 2064 6f5f 6e6f 726d 616c 697a 6174 696f   do_normalizatio
-00048b20: 6e3d 7465 6d70 6c61 7465 5478 2c0a 2020  n=templateTx,.  
-00048b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048b40: 2020 2020 2020 2020 2020 7465 7374 5f72            test_r
-00048b50: 756e 3d74 6573 745f 7275 6e2c 0a20 2020  un=test_run,.   
-00048b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048b70: 2020 2020 2020 2020 2076 6572 626f 7365           verbose
-00048b80: 3d54 7275 6520 290a 2020 2020 2020 2020  =True ).        
-00048b90: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00048ba0: 6f74 2074 6573 745f 7275 6e3a 0a20 2020  ot test_run:.   
+000488e0: 2020 2070 7269 6e74 2820 224e 4d20 2220     print( "NM " 
+000488f0: 2b20 6d79 6d6d 202b 2027 2063 6f6d 706c  + mymm + ' compl
+00048900: 6574 6520 2720 290a 2020 2020 2020 2020  ete ' ).        
+00048910: 2020 2020 2020 2020 6966 2065 7869 7374          if exist
+00048920: 7328 206d 796d 6d6f 7574 2029 3a0a 2020  s( mymmout ):.  
+00048930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048940: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+00048950: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00048960: 3464 3a0a 2020 2020 2020 2020 2020 2020  4d:.            
+00048970: 2020 2020 2020 2020 6e6d 6c69 7374 203d          nmlist =
+00048980: 2061 6e74 732e 6e64 696d 6167 655f 746f   ants.ndimage_to
+00048990: 5f6c 6973 7428 206d 6d5f 7265 6164 2820  _list( mm_read( 
+000489a0: 6d79 696d 6773 7232 5b30 5d20 2920 290a  myimgsr2[0] ) ).
+000489b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000489c0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000489d0: 2020 2020 2020 2020 2020 6e6d 6c69 7374            nmlist
+000489e0: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+000489f0: 2020 2020 2020 2020 2020 666f 7220 7a7a            for zz
+00048a00: 2069 6e20 6d79 696d 6773 7232 3a0a 2020   in myimgsr2:.  
+00048a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048a20: 2020 2020 2020 6e6d 6c69 7374 2e61 7070        nmlist.app
+00048a30: 656e 6428 206d 6d5f 7265 6164 2820 7a7a  end( mm_read( zz
+00048a40: 2029 2029 0a20 2020 2020 2020 2020 2020   ) ).           
+00048a50: 2020 2020 2073 726d 6f64 656c 5f4e 4d5f       srmodel_NM_
+00048a60: 6d64 6c20 3d20 4e6f 6e65 0a20 2020 2020  mdl = None.     
+00048a70: 2020 2020 2020 2020 2020 2069 6620 7372             if sr
+00048a80: 6d6f 6465 6c5f 4e4d 2069 7320 6e6f 7420  model_NM is not 
+00048a90: 4661 6c73 653a 0a20 2020 2020 2020 2020  False:.         
+00048aa0: 2020 2020 2020 2020 2020 2062 6573 7475             bestu
+00048ab0: 7020 3d20 7369 712e 6f70 7469 6d69 7a65  p = siq.optimize
+00048ac0: 5f75 7073 616d 706c 696e 675f 7368 6170  _upsampling_shap
+00048ad0: 6528 2061 6e74 732e 6765 745f 7370 6163  e( ants.get_spac
+00048ae0: 696e 6728 6e6d 6c69 7374 5b30 5d29 2c20  ing(nmlist[0]), 
+00048af0: 6d6f 6461 6c69 7479 3d27 4e4d 272c 2072  modality='NM', r
+00048b00: 6f75 6e64 6974 3d54 7275 6520 290a 2020  oundit=True ).  
+00048b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048b20: 2020 6d64 6c66 6e20 3d20 6578 5f70 6174    mdlfn = ex_pat
+00048b30: 686d 6d20 2b20 2273 6971 5f64 6566 6175  hmm + "siq_defau
+00048b40: 6c74 5f73 6973 725f 2220 2b20 6265 7374  lt_sisr_" + best
+00048b50: 7570 202b 2022 5f31 6368 616e 5f66 6561  up + "_1chan_fea
+00048b60: 7476 6767 4c36 5f62 6573 745f 6d64 6c2e  tvggL6_best_mdl.
+00048b70: 6835 220a 2020 2020 2020 2020 2020 2020  h5".            
+00048b80: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00048b90: 7461 6e63 6528 2073 726d 6f64 656c 5f4e  tance( srmodel_N
+00048ba0: 4d2c 2073 7472 2029 3a0a 2020 2020 2020  M, str ):.      
 00048bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048bc0: 2020 2020 2077 7269 7465 5f6d 6d28 206f       write_mm( o
-00048bd0: 7574 7075 745f 7072 6566 6978 3d6d 796d  utput_prefix=mym
-00048be0: 6d2c 206d 6d3d 7461 6250 726f 2c20 6d6d  m, mm=tabPro, mm
-00048bf0: 5f6e 6f72 6d3d 6e6f 726d 5072 6f2c 2074  _norm=normPro, t
-00048c00: 3177 6964 653d 4e6f 6e65 2c20 7365 7061  1wide=None, sepa
-00048c10: 7261 746f 723d 6d79 7365 7020 290a 2020  rator=mysep ).  
-00048c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048c30: 2020 2020 2020 6e6d 7072 6f20 3d20 7461        nmpro = ta
-00048c40: 6250 726f 5b27 4e4d 275d 0a20 2020 2020  bPro['NM'].     
-00048c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048c60: 2020 206d 7973 6c20 3d20 7261 6e67 6528     mysl = range(
-00048c70: 206e 6d70 726f 5b27 4e4d 5f61 7667 275d   nmpro['NM_avg']
-00048c80: 2e73 6861 7065 5b32 5d20 290a 2020 2020  .shape[2] ).    
+00048bc0: 2020 7372 6d6f 6465 6c5f 4e4d 203d 2072    srmodel_NM = r
+00048bd0: 652e 7375 6228 2022 6265 7374 7570 222c  e.sub( "bestup",
+00048be0: 2062 6573 7475 702c 2073 726d 6f64 656c   bestup, srmodel
+00048bf0: 5f4e 4d20 290a 2020 2020 2020 2020 2020  _NM ).          
+00048c00: 2020 2020 2020 2020 2020 2020 2020 6d64                md
+00048c10: 6c66 6e20 3d20 6f73 2e70 6174 682e 6a6f  lfn = os.path.jo
+00048c20: 696e 2820 6578 5f70 6174 686d 6d2c 2073  in( ex_pathmm, s
+00048c30: 726d 6f64 656c 5f4e 4d20 290a 2020 2020  rmodel_NM ).    
+00048c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048c50: 6966 2065 7869 7374 7328 206d 646c 666e  if exists( mdlfn
+00048c60: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+00048c70: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+00048c80: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
 00048c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048ca0: 6966 2076 6973 7561 6c69 7a65 3a0a 2020  if visualize:.  
-00048cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048cc0: 2020 2020 2020 6d79 736c 203d 2072 616e        mysl = ran
-00048cd0: 6765 2820 6e6d 7072 6f5b 274e 4d5f 6176  ge( nmpro['NM_av
-00048ce0: 6727 5d2e 7368 6170 655b 325d 2029 0a20  g'].shape[2] ). 
-00048cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048d00: 2020 2020 2020 2061 6e74 732e 706c 6f74         ants.plot
-00048d10: 2820 6e6d 7072 6f5b 274e 4d5f 6176 6727  ( nmpro['NM_avg'
-00048d20: 5d2c 2020 6e6d 7072 6f5b 2774 315f 746f  ],  nmpro['t1_to
-00048d30: 5f4e 4d27 5d2c 2073 6c69 6365 733d 6d79  _NM'], slices=my
-00048d40: 736c 2c20 6178 6973 3d32 2c20 7469 746c  sl, axis=2, titl
-00048d50: 653d 276e 6d20 2b20 7431 272c 2066 696c  e='nm + t1', fil
-00048d60: 656e 616d 653d 6d79 6d6d 2b6d 7973 6570  ename=mymm+mysep
-00048d70: 2b22 4e4d 6176 672e 706e 6722 2029 0a20  +"NMavg.png" ). 
-00048d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048d90: 2020 2020 2020 206d 7973 6c20 3d20 7261         mysl = ra
-00048da0: 6e67 6528 206e 6d70 726f 5b27 4e4d 5f61  nge( nmpro['NM_a
-00048db0: 7667 5f63 726f 7070 6564 275d 2e73 6861  vg_cropped'].sha
-00048dc0: 7065 5b32 5d20 290a 2020 2020 2020 2020  pe[2] ).        
+00048ca0: 2020 2020 7072 696e 7428 6d64 6c66 6e29      print(mdlfn)
+00048cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00048cc0: 2020 2020 2020 2020 2073 726d 6f64 656c           srmodel
+00048cd0: 5f4e 4d5f 6d64 6c20 3d20 7466 2e6b 6572  _NM_mdl = tf.ker
+00048ce0: 6173 2e6d 6f64 656c 732e 6c6f 6164 5f6d  as.models.load_m
+00048cf0: 6f64 656c 2820 6d64 6c66 6e2c 2063 6f6d  odel( mdlfn, com
+00048d00: 7069 6c65 3d46 616c 7365 2020 290a 2020  pile=False  ).  
+00048d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048d20: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00048d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048d40: 7072 696e 7428 206d 646c 666e 202b 2022  print( mdlfn + "
+00048d50: 2064 6f65 7320 6e6f 7420 6578 6973 7420   does not exist 
+00048d60: 2d20 776f 6e74 2075 7365 2053 5222 290a  - wont use SR").
+00048d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048d80: 6966 206e 6f74 2074 6573 746c 6f6f 703a  if not testloop:
+00048d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00048da0: 2020 2020 2074 6162 5072 6f2c 206e 6f72       tabPro, nor
+00048db0: 6d50 726f 203d 206d 6d28 2074 312c 2068  mPro = mm( t1, h
+00048dc0: 6965 722c 0a20 2020 2020 2020 2020 2020  ier,.           
 00048dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048de0: 616e 7473 2e70 6c6f 7428 206e 6d70 726f  ants.plot( nmpro
-00048df0: 5b27 4e4d 5f61 7667 5f63 726f 7070 6564  ['NM_avg_cropped
-00048e00: 275d 2c20 6178 6973 3d32 2c20 736c 6963  '], axis=2, slic
-00048e10: 6573 3d6d 7973 6c2c 206f 7665 726c 6179  es=mysl, overlay
-00048e20: 5f61 6c70 6861 3d30 2e33 2c20 7469 746c  _alpha=0.3, titl
-00048e30: 653d 276e 6d20 6372 6f70 272c 2066 696c  e='nm crop', fil
-00048e40: 656e 616d 653d 6d79 6d6d 2b6d 7973 6570  ename=mymm+mysep
-00048e50: 2b22 4e4d 6176 6763 726f 702e 706e 6722  +"NMavgcrop.png"
-00048e60: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00048e70: 2020 2020 2020 2020 2020 2061 6e74 732e             ants.
-00048e80: 706c 6f74 2820 6e6d 7072 6f5b 274e 4d5f  plot( nmpro['NM_
-00048e90: 6176 675f 6372 6f70 7065 6427 5d2c 206e  avg_cropped'], n
-00048ea0: 6d70 726f 5b27 7431 5f74 6f5f 4e4d 275d  mpro['t1_to_NM']
-00048eb0: 2c20 6178 6973 3d32 2c20 736c 6963 6573  , axis=2, slices
-00048ec0: 3d6d 7973 6c2c 206f 7665 726c 6179 5f61  =mysl, overlay_a
-00048ed0: 6c70 6861 3d30 2e33 2c20 7469 746c 653d  lpha=0.3, title=
-00048ee0: 276e 6d20 6372 6f70 202b 2074 3127 2c20  'nm crop + t1', 
-00048ef0: 6669 6c65 6e61 6d65 3d6d 796d 6d2b 6d79  filename=mymm+my
-00048f00: 7365 702b 224e 4d61 7667 6372 6f70 7431  sep+"NMavgcropt1
-00048f10: 2e70 6e67 2220 290a 2020 2020 2020 2020  .png" ).        
+00048de0: 206e 6d5f 696d 6167 655f 6c69 7374 203d   nm_image_list =
+00048df0: 206e 6d6c 6973 742c 0a20 2020 2020 2020   nmlist,.       
+00048e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048e10: 2020 2020 2073 726d 6f64 656c 3d73 726d       srmodel=srm
+00048e20: 6f64 656c 5f4e 4d5f 6d64 6c2c 0a20 2020  odel_NM_mdl,.   
+00048e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048e40: 2020 2020 2020 2020 2064 6f5f 7472 6163           do_trac
+00048e50: 746f 6772 6170 6879 3d46 616c 7365 2c0a  tography=False,.
+00048e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048e70: 2020 2020 2020 2020 2020 2020 646f 5f6b              do_k
+00048e80: 6b3d 4661 6c73 652c 0a20 2020 2020 2020  k=False,.       
+00048e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048ea0: 2020 2020 2064 6f5f 6e6f 726d 616c 697a       do_normaliz
+00048eb0: 6174 696f 6e3d 7465 6d70 6c61 7465 5478  ation=templateTx
+00048ec0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00048ed0: 2020 2020 2020 2020 2020 2020 2020 7465                te
+00048ee0: 7374 5f72 756e 3d74 6573 745f 7275 6e2c  st_run=test_run,
+00048ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00048f00: 2020 2020 2020 2020 2020 2020 2076 6572               ver
+00048f10: 626f 7365 3d54 7275 6520 290a 2020 2020  bose=True ).    
 00048f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048f30: 616e 7473 2e70 6c6f 7428 206e 6d70 726f  ants.plot( nmpro
-00048f40: 5b27 4e4d 5f61 7667 5f63 726f 7070 6564  ['NM_avg_cropped
-00048f50: 275d 2c20 6e6d 7072 6f5b 274e 4d5f 6c61  '], nmpro['NM_la
-00048f60: 6265 6c73 275d 2c20 6178 6973 3d32 2c20  bels'], axis=2, 
-00048f70: 736c 6963 6573 3d6d 7973 6c2c 2074 6974  slices=mysl, tit
-00048f80: 6c65 3d27 6e6d 2063 726f 7020 2b20 6c61  le='nm crop + la
-00048f90: 6265 6c73 272c 2066 696c 656e 616d 653d  bels', filename=
-00048fa0: 6d79 6d6d 2b6d 7973 6570 2b22 4e4d 6176  mymm+mysep+"NMav
-00048fb0: 6763 726f 706c 6162 656c 732e 706e 6722  gcroplabels.png"
-00048fc0: 2029 0a20 2020 2020 2020 2020 2020 2065   ).            e
-00048fd0: 6c73 6520 3a0a 2020 2020 2020 2020 2020  lse :.          
-00048fe0: 2020 2020 2020 6966 206c 656e 2820 6d79        if len( my
-00048ff0: 696d 6773 7220 2920 3e20 303a 0a20 2020  imgsr ) > 0:.   
-00049000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049010: 2064 6f77 7269 7465 3d46 616c 7365 0a20   dowrite=False. 
+00048f30: 6966 206e 6f74 2074 6573 745f 7275 6e3a  if not test_run:
+00048f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00048f50: 2020 2020 2020 2020 2077 7269 7465 5f6d           write_m
+00048f60: 6d28 206f 7574 7075 745f 7072 6566 6978  m( output_prefix
+00048f70: 3d6d 796d 6d2c 206d 6d3d 7461 6250 726f  =mymm, mm=tabPro
+00048f80: 2c20 6d6d 5f6e 6f72 6d3d 6e6f 726d 5072  , mm_norm=normPr
+00048f90: 6f2c 2074 3177 6964 653d 4e6f 6e65 2c20  o, t1wide=None, 
+00048fa0: 7365 7061 7261 746f 723d 6d79 7365 7020  separator=mysep 
+00048fb0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00048fc0: 2020 2020 2020 2020 2020 6e6d 7072 6f20            nmpro 
+00048fd0: 3d20 7461 6250 726f 5b27 4e4d 275d 0a20  = tabPro['NM']. 
+00048fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048ff0: 2020 2020 2020 206d 7973 6c20 3d20 7261         mysl = ra
+00049000: 6e67 6528 206e 6d70 726f 5b27 4e4d 5f61  nge( nmpro['NM_a
+00049010: 7667 275d 2e73 6861 7065 5b32 5d20 290a  vg'].shape[2] ).
 00049020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049030: 2020 206d 7969 6d67 636f 756e 7420 3d20     myimgcount = 
-00049040: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-00049050: 2020 2020 2020 6966 206c 656e 2820 6d79        if len( my
-00049060: 696d 6773 7220 2920 3e20 3020 3a0a 2020  imgsr ) > 0 :.  
-00049070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049080: 2020 2020 2020 6d79 696d 6720 3d20 6d79        myimg = my
-00049090: 696d 6773 725b 6d79 696d 6763 6f75 6e74  imgsr[myimgcount
-000490a0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000490b0: 2020 2020 2020 2020 2020 7375 626a 6563            subjec
-000490c0: 7470 726f 7061 7468 203d 206f 732e 7061  tpropath = os.pa
-000490d0: 7468 2e64 6972 6e61 6d65 2820 6d79 696d  th.dirname( myim
-000490e0: 6720 290a 2020 2020 2020 2020 2020 2020  g ).            
-000490f0: 2020 2020 2020 2020 2020 2020 7375 626a              subj
-00049100: 6563 7470 726f 7061 7468 203d 2072 652e  ectpropath = re.
-00049110: 7375 6228 2073 6f75 7263 6564 6174 6166  sub( sourcedataf
-00049120: 6f6c 6465 726e 616d 652c 2070 726f 6365  oldername, proce
-00049130: 7373 4469 722c 2073 7562 6a65 6374 7072  ssDir, subjectpr
-00049140: 6f70 6174 6820 290a 2020 2020 2020 2020  opath ).        
-00049150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049160: 6d79 7370 6c69 7420 3d20 7375 626a 6563  mysplit = subjec
-00049170: 7470 726f 7061 7468 2e73 706c 6974 2822  tpropath.split("
-00049180: 2f22 290a 2020 2020 2020 2020 2020 2020  /").            
-00049190: 2020 2020 2020 2020 2020 2020 6d79 7370              mysp
-000491a0: 6c69 7443 6f75 6e74 203d 206c 656e 2820  litCount = len( 
-000491b0: 6d79 7370 6c69 7420 290a 2020 2020 2020  mysplit ).      
-000491c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000491d0: 2020 7072 6f6a 6563 7420 3d20 6d79 7370    project = mysp
-000491e0: 6c69 745b 6d79 7370 6c69 7443 6f75 6e74  lit[mysplitCount
-000491f0: 2d35 5d0a 2020 2020 2020 2020 2020 2020  -5].            
-00049200: 2020 2020 2020 2020 2020 2020 6461 7465              date
-00049210: 203d 206d 7973 706c 6974 5b6d 7973 706c   = mysplit[myspl
-00049220: 6974 436f 756e 742d 345d 0a20 2020 2020  itCount-4].     
-00049230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049240: 2020 2073 7562 6a65 6374 203d 206d 7973     subject = mys
-00049250: 706c 6974 5b6d 7973 706c 6974 436f 756e  plit[mysplitCoun
-00049260: 742d 335d 0a20 2020 2020 2020 2020 2020  t-3].           
-00049270: 2020 2020 2020 2020 2020 2020 206d 796d               mym
-00049280: 6f64 203d 206d 7973 706c 6974 5b6d 7973  od = mysplit[mys
-00049290: 706c 6974 436f 756e 742d 325d 2023 2046  plitCount-2] # F
-000492a0: 4958 4d45 2073 7973 7465 6d20 6465 7065  IXME system depe
-000492b0: 6e64 656e 740a 2020 2020 2020 2020 2020  ndent.          
-000492c0: 2020 2020 2020 2020 2020 2020 2020 7569                ui
-000492d0: 6420 3d20 6d79 7370 6c69 745b 6d79 7370  d = mysplit[mysp
-000492e0: 6c69 7443 6f75 6e74 2d31 5d20 2320 756e  litCount-1] # un
-000492f0: 6971 7565 2069 6d61 6765 2069 640a 2020  ique image id.  
-00049300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049310: 2020 2020 2020 6f73 2e6d 616b 6564 6972        os.makedir
-00049320: 7328 2073 7562 6a65 6374 7072 6f70 6174  s( subjectpropat
-00049330: 682c 2065 7869 7374 5f6f 6b3d 5472 7565  h, exist_ok=True
-00049340: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00049350: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-00049360: 796d 6f64 203d 3d20 2754 3177 273a 0a20  ymod == 'T1w':. 
-00049370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049380: 2020 2020 2020 2020 2020 2069 6465 6e74             ident
-00049390: 6966 6965 7220 3d20 6d79 7365 702e 6a6f  ifier = mysep.jo
-000493a0: 696e 285b 7072 6f6a 6563 742c 2064 6174  in([project, dat
-000493b0: 652c 2073 7562 6a65 6374 2c20 6d79 6d6f  e, subject, mymo
-000493c0: 642c 2075 6964 5d29 0a20 2020 2020 2020  d, uid]).       
-000493d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000493e0: 2065 6c73 653a 2020 2320 6164 6420 7468   else:  # add th
-000493f0: 6520 5431 2075 6e69 7175 6520 6964 2073  e T1 unique id s
-00049400: 696e 6365 2074 6861 7420 6472 6976 6573  ince that drives
-00049410: 2061 206c 6f74 206f 6620 7468 6520 616e   a lot of the an
-00049420: 616c 7973 6973 0a20 2020 2020 2020 2020  alysis.         
-00049430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049440: 2020 2069 6465 6e74 6966 6965 7220 3d20     identifier = 
-00049450: 6d79 7365 702e 6a6f 696e 285b 7072 6f6a  mysep.join([proj
-00049460: 6563 742c 2064 6174 652c 2073 7562 6a65  ect, date, subje
-00049470: 6374 2c20 6d79 6d6f 642c 2075 6964 205d  ct, mymod, uid ]
-00049480: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00049490: 2020 2020 2020 2020 2020 2020 2020 6964                id
-000494a0: 656e 7469 6669 6572 203d 2069 6465 6e74  entifier = ident
-000494b0: 6966 6965 7220 2b20 225f 2220 2b20 6969  ifier + "_" + ii
-000494c0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-000494d0: 2020 2020 2020 2020 2020 6d79 6d6d 203d            mymm =
-000494e0: 2073 7562 6a65 6374 7072 6f70 6174 6820   subjectpropath 
-000494f0: 2b20 222f 2220 2b20 6964 656e 7469 6669  + "/" + identifi
-00049500: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
-00049510: 2020 2020 2020 2020 2020 206d 796d 6d6f             mymmo
-00049520: 7574 203d 206d 616b 6577 6964 656f 7574  ut = makewideout
-00049530: 2820 6d79 6d6d 2029 0a20 2020 2020 2020  ( mymm ).       
-00049540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049550: 2069 6620 7665 7262 6f73 6520 616e 6420   if verbose and 
-00049560: 6e6f 7420 6578 6973 7473 2820 6d79 6d6d  not exists( mymm
-00049570: 6f75 7420 293a 0a20 2020 2020 2020 2020  out ):.         
-00049580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049590: 2020 2070 7269 6e74 2822 4d6f 6461 6c69     print("Modali
-000495a0: 7479 2073 7065 6369 6669 6320 7072 6f63  ty specific proc
-000495b0: 6573 7369 6e67 3a20 2220 2b20 6d79 6d6f  essing: " + mymo
-000495c0: 6420 2b20 2220 6578 6563 7574 696f 6e20  d + " execution 
-000495d0: 2220 290a 2020 2020 2020 2020 2020 2020  " ).            
-000495e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000495f0: 7072 696e 7428 206d 796d 6d20 290a 2020  print( mymm ).  
+00049030: 2020 2020 6966 2076 6973 7561 6c69 7a65      if visualize
+00049040: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00049050: 2020 2020 2020 2020 2020 6d79 736c 203d            mysl =
+00049060: 2072 616e 6765 2820 6e6d 7072 6f5b 274e   range( nmpro['N
+00049070: 4d5f 6176 6727 5d2e 7368 6170 655b 325d  M_avg'].shape[2]
+00049080: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00049090: 2020 2020 2020 2020 2020 2061 6e74 732e             ants.
+000490a0: 706c 6f74 2820 6e6d 7072 6f5b 274e 4d5f  plot( nmpro['NM_
+000490b0: 6176 6727 5d2c 2020 6e6d 7072 6f5b 2774  avg'],  nmpro['t
+000490c0: 315f 746f 5f4e 4d27 5d2c 2073 6c69 6365  1_to_NM'], slice
+000490d0: 733d 6d79 736c 2c20 6178 6973 3d32 2c20  s=mysl, axis=2, 
+000490e0: 7469 746c 653d 276e 6d20 2b20 7431 272c  title='nm + t1',
+000490f0: 2066 696c 656e 616d 653d 6d79 6d6d 2b6d   filename=mymm+m
+00049100: 7973 6570 2b22 4e4d 6176 672e 706e 6722  ysep+"NMavg.png"
+00049110: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00049120: 2020 2020 2020 2020 2020 206d 7973 6c20             mysl 
+00049130: 3d20 7261 6e67 6528 206e 6d70 726f 5b27  = range( nmpro['
+00049140: 4e4d 5f61 7667 5f63 726f 7070 6564 275d  NM_avg_cropped']
+00049150: 2e73 6861 7065 5b32 5d20 290a 2020 2020  .shape[2] ).    
+00049160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049170: 2020 2020 616e 7473 2e70 6c6f 7428 206e      ants.plot( n
+00049180: 6d70 726f 5b27 4e4d 5f61 7667 5f63 726f  mpro['NM_avg_cro
+00049190: 7070 6564 275d 2c20 6178 6973 3d32 2c20  pped'], axis=2, 
+000491a0: 736c 6963 6573 3d6d 7973 6c2c 206f 7665  slices=mysl, ove
+000491b0: 726c 6179 5f61 6c70 6861 3d30 2e33 2c20  rlay_alpha=0.3, 
+000491c0: 7469 746c 653d 276e 6d20 6372 6f70 272c  title='nm crop',
+000491d0: 2066 696c 656e 616d 653d 6d79 6d6d 2b6d   filename=mymm+m
+000491e0: 7973 6570 2b22 4e4d 6176 6763 726f 702e  ysep+"NMavgcrop.
+000491f0: 706e 6722 2029 0a20 2020 2020 2020 2020  png" ).         
+00049200: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00049210: 6e74 732e 706c 6f74 2820 6e6d 7072 6f5b  nts.plot( nmpro[
+00049220: 274e 4d5f 6176 675f 6372 6f70 7065 6427  'NM_avg_cropped'
+00049230: 5d2c 206e 6d70 726f 5b27 7431 5f74 6f5f  ], nmpro['t1_to_
+00049240: 4e4d 275d 2c20 6178 6973 3d32 2c20 736c  NM'], axis=2, sl
+00049250: 6963 6573 3d6d 7973 6c2c 206f 7665 726c  ices=mysl, overl
+00049260: 6179 5f61 6c70 6861 3d30 2e33 2c20 7469  ay_alpha=0.3, ti
+00049270: 746c 653d 276e 6d20 6372 6f70 202b 2074  tle='nm crop + t
+00049280: 3127 2c20 6669 6c65 6e61 6d65 3d6d 796d  1', filename=mym
+00049290: 6d2b 6d79 7365 702b 224e 4d61 7667 6372  m+mysep+"NMavgcr
+000492a0: 6f70 7431 2e70 6e67 2220 290a 2020 2020  opt1.png" ).    
+000492b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000492c0: 2020 2020 616e 7473 2e70 6c6f 7428 206e      ants.plot( n
+000492d0: 6d70 726f 5b27 4e4d 5f61 7667 5f63 726f  mpro['NM_avg_cro
+000492e0: 7070 6564 275d 2c20 6e6d 7072 6f5b 274e  pped'], nmpro['N
+000492f0: 4d5f 6c61 6265 6c73 275d 2c20 6178 6973  M_labels'], axis
+00049300: 3d32 2c20 736c 6963 6573 3d6d 7973 6c2c  =2, slices=mysl,
+00049310: 2074 6974 6c65 3d27 6e6d 2063 726f 7020   title='nm crop 
+00049320: 2b20 6c61 6265 6c73 272c 2066 696c 656e  + labels', filen
+00049330: 616d 653d 6d79 6d6d 2b6d 7973 6570 2b22  ame=mymm+mysep+"
+00049340: 4e4d 6176 6763 726f 706c 6162 656c 732e  NMavgcroplabels.
+00049350: 706e 6722 2029 0a20 2020 2020 2020 2020  png" ).         
+00049360: 2020 2065 6c73 6520 3a0a 2020 2020 2020     else :.      
+00049370: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+00049380: 2820 6d79 696d 6773 7220 2920 3e20 303a  ( myimgsr ) > 0:
+00049390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000493a0: 2020 2020 2064 6f77 7269 7465 3d46 616c       dowrite=Fal
+000493b0: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+000493c0: 2020 2020 2020 206d 7969 6d67 636f 756e         myimgcoun
+000493d0: 7420 3d20 300a 2020 2020 2020 2020 2020  t = 0.          
+000493e0: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+000493f0: 2820 6d79 696d 6773 7220 2920 3e20 3020  ( myimgsr ) > 0 
+00049400: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00049410: 2020 2020 2020 2020 2020 6d79 696d 6720            myimg 
+00049420: 3d20 6d79 696d 6773 725b 6d79 696d 6763  = myimgsr[myimgc
+00049430: 6f75 6e74 5d0a 2020 2020 2020 2020 2020  ount].          
+00049440: 2020 2020 2020 2020 2020 2020 2020 7375                su
+00049450: 626a 6563 7470 726f 7061 7468 203d 206f  bjectpropath = o
+00049460: 732e 7061 7468 2e64 6972 6e61 6d65 2820  s.path.dirname( 
+00049470: 6d79 696d 6720 290a 2020 2020 2020 2020  myimg ).        
+00049480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049490: 7375 626a 6563 7470 726f 7061 7468 203d  subjectpropath =
+000494a0: 2072 652e 7375 6228 2073 6f75 7263 6564   re.sub( sourced
+000494b0: 6174 6166 6f6c 6465 726e 616d 652c 2070  atafoldername, p
+000494c0: 726f 6365 7373 4469 722c 2073 7562 6a65  rocessDir, subje
+000494d0: 6374 7072 6f70 6174 6820 290a 2020 2020  ctpropath ).    
+000494e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000494f0: 2020 2020 6d79 7370 6c69 7420 3d20 7375      mysplit = su
+00049500: 626a 6563 7470 726f 7061 7468 2e73 706c  bjectpropath.spl
+00049510: 6974 2822 2f22 290a 2020 2020 2020 2020  it("/").        
+00049520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049530: 6d79 7370 6c69 7443 6f75 6e74 203d 206c  mysplitCount = l
+00049540: 656e 2820 6d79 7370 6c69 7420 290a 2020  en( mysplit ).  
+00049550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049560: 2020 2020 2020 7072 6f6a 6563 7420 3d20        project = 
+00049570: 6d79 7370 6c69 745b 6d79 7370 6c69 7443  mysplit[mysplitC
+00049580: 6f75 6e74 2d35 5d0a 2020 2020 2020 2020  ount-5].        
+00049590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000495a0: 6461 7465 203d 206d 7973 706c 6974 5b6d  date = mysplit[m
+000495b0: 7973 706c 6974 436f 756e 742d 345d 0a20  ysplitCount-4]. 
+000495c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000495d0: 2020 2020 2020 2073 7562 6a65 6374 203d         subject =
+000495e0: 206d 7973 706c 6974 5b6d 7973 706c 6974   mysplit[mysplit
+000495f0: 436f 756e 742d 335d 0a20 2020 2020 2020  Count-3].       
 00049600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049610: 2020 2020 2020 656c 6966 2076 6572 626f        elif verbo
-00049620: 7365 2061 6e64 2065 7869 7374 7328 206d  se and exists( m
-00049630: 796d 6d6f 7574 2029 203a 0a20 2020 2020  ymmout ) :.     
-00049640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049650: 2020 2020 2020 2070 7269 6e74 2822 4d6f         print("Mo
-00049660: 6461 6c69 7479 2073 7065 6369 6669 6320  dality specific 
-00049670: 7072 6f63 6573 7369 6e67 3a20 2220 2b20  processing: " + 
-00049680: 6d79 6d6f 6420 2b20 2220 636f 6d70 6c65  mymod + " comple
-00049690: 7465 2022 2029 0a20 2020 2020 2020 2020  te " ).         
-000496a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000496b0: 6620 6578 6973 7473 2820 6d79 6d6d 6f75  f exists( mymmou
-000496c0: 7420 2920 3a0a 2020 2020 2020 2020 2020  t ) :.          
-000496d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000496e0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-000496f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049700: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
-00049710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049720: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00049730: 2873 7562 6a65 6374 7072 6f70 6174 6829  (subjectpropath)
-00049740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00049750: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00049760: 6e74 2869 6465 6e74 6966 6965 7229 0a20  nt(identifier). 
-00049770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049780: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00049790: 2820 6d79 696d 6720 290a 2020 2020 2020  ( myimg ).      
-000497a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000497b0: 2020 6966 206e 6f74 2074 6573 746c 6f6f    if not testloo
-000497c0: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
-000497d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000497e0: 6d67 203d 206d 6d5f 7265 6164 2820 6d79  mg = mm_read( my
-000497f0: 696d 6720 290a 2020 2020 2020 2020 2020  img ).          
-00049800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049810: 2020 6973 6861 7065 6c65 6e20 3d20 6c65    ishapelen = le
-00049820: 6e28 2069 6d67 2e73 6861 7065 2029 0a20  n( img.shape ). 
-00049830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049840: 2020 2020 2020 2020 2020 2069 6620 6d79             if my
-00049850: 6d6f 6420 3d3d 2027 5431 7727 2061 6e64  mod == 'T1w' and
-00049860: 2069 7368 6170 656c 656e 203d 3d20 333a   ishapelen == 3:
-00049870: 2023 2066 6f72 2061 2072 6561 6c20 7275   # for a real ru
-00049880: 6e2c 2073 6574 2074 6f20 5472 7565 0a20  n, set to True. 
-00049890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000498a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000498b0: 6620 6e6f 7420 6578 6973 7473 2820 7265  f not exists( re
-000498c0: 676f 7574 202b 2022 6c6f 676a 6163 6f62  gout + "logjacob
-000498d0: 6961 6e2e 6e69 692e 677a 2220 2920 6f72  ian.nii.gz" ) or
-000498e0: 206e 6f74 2065 7869 7374 7328 2072 6567   not exists( reg
-000498f0: 6f75 742b 2731 5761 7270 2e6e 6969 2e67  out+'1Warp.nii.g
-00049900: 7a27 2029 3a0a 2020 2020 2020 2020 2020  z' ):.          
+00049610: 206d 796d 6f64 203d 206d 7973 706c 6974   mymod = mysplit
+00049620: 5b6d 7973 706c 6974 436f 756e 742d 325d  [mysplitCount-2]
+00049630: 2023 2046 4958 4d45 2073 7973 7465 6d20   # FIXME system 
+00049640: 6465 7065 6e64 656e 740a 2020 2020 2020  dependent.      
+00049650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049660: 2020 7569 6420 3d20 6d79 7370 6c69 745b    uid = mysplit[
+00049670: 6d79 7370 6c69 7443 6f75 6e74 2d31 5d20  mysplitCount-1] 
+00049680: 2320 756e 6971 7565 2069 6d61 6765 2069  # unique image i
+00049690: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+000496a0: 2020 2020 2020 2020 2020 6f73 2e6d 616b            os.mak
+000496b0: 6564 6972 7328 2073 7562 6a65 6374 7072  edirs( subjectpr
+000496c0: 6f70 6174 682c 2065 7869 7374 5f6f 6b3d  opath, exist_ok=
+000496d0: 5472 7565 2020 290a 2020 2020 2020 2020  True  ).        
+000496e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000496f0: 6966 206d 796d 6f64 203d 3d20 2754 3177  if mymod == 'T1w
+00049700: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+00049710: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00049720: 6465 6e74 6966 6965 7220 3d20 6d79 7365  dentifier = myse
+00049730: 702e 6a6f 696e 285b 7072 6f6a 6563 742c  p.join([project,
+00049740: 2064 6174 652c 2073 7562 6a65 6374 2c20   date, subject, 
+00049750: 6d79 6d6f 642c 2075 6964 5d29 0a20 2020  mymod, uid]).   
+00049760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049770: 2020 2020 2065 6c73 653a 2020 2320 6164       else:  # ad
+00049780: 6420 7468 6520 5431 2075 6e69 7175 6520  d the T1 unique 
+00049790: 6964 2073 696e 6365 2074 6861 7420 6472  id since that dr
+000497a0: 6976 6573 2061 206c 6f74 206f 6620 7468  ives a lot of th
+000497b0: 6520 616e 616c 7973 6973 0a20 2020 2020  e analysis.     
+000497c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000497d0: 2020 2020 2020 2069 6465 6e74 6966 6965         identifie
+000497e0: 7220 3d20 6d79 7365 702e 6a6f 696e 285b  r = mysep.join([
+000497f0: 7072 6f6a 6563 742c 2064 6174 652c 2073  project, date, s
+00049800: 7562 6a65 6374 2c20 6d79 6d6f 642c 2075  ubject, mymod, u
+00049810: 6964 205d 290a 2020 2020 2020 2020 2020  id ]).          
+00049820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049830: 2020 6964 656e 7469 6669 6572 203d 2069    identifier = i
+00049840: 6465 6e74 6966 6965 7220 2b20 225f 2220  dentifier + "_" 
+00049850: 2b20 6969 640a 2020 2020 2020 2020 2020  + iid.          
+00049860: 2020 2020 2020 2020 2020 2020 2020 6d79                my
+00049870: 6d6d 203d 2073 7562 6a65 6374 7072 6f70  mm = subjectprop
+00049880: 6174 6820 2b20 222f 2220 2b20 6964 656e  ath + "/" + iden
+00049890: 7469 6669 6572 0a20 2020 2020 2020 2020  tifier.         
+000498a0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000498b0: 796d 6d6f 7574 203d 206d 616b 6577 6964  ymmout = makewid
+000498c0: 656f 7574 2820 6d79 6d6d 2029 0a20 2020  eout( mymm ).   
+000498d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000498e0: 2020 2020 2069 6620 7665 7262 6f73 6520       if verbose 
+000498f0: 616e 6420 6e6f 7420 6578 6973 7473 2820  and not exists( 
+00049900: 6d79 6d6d 6f75 7420 293a 0a20 2020 2020  mymmout ):.     
 00049910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049920: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
-00049930: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-00049940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049950: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00049960: 696e 7428 2773 7461 7274 2074 3120 7265  int('start t1 re
-00049970: 6769 7374 7261 7469 6f6e 2729 0a20 2020  gistration').   
-00049980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000499a0: 2065 785f 7061 7468 203d 206f 732e 7061   ex_path = os.pa
-000499b0: 7468 2e65 7870 616e 6475 7365 7228 2022  th.expanduser( "
-000499c0: 7e2f 2e61 6e74 7370 7974 3177 2f22 2029  ~/.antspyt1w/" )
-000499d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000499e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000499f0: 2020 2020 2074 656d 706c 6174 6566 6e20       templatefn 
-00049a00: 3d20 6578 5f70 6174 6820 2b20 2743 4954  = ex_path + 'CIT
-00049a10: 3136 385f 5431 775f 3730 3075 6d5f 7061  168_T1w_700um_pa
-00049a20: 645f 6164 6e69 2e6e 6969 2e67 7a27 0a20  d_adni.nii.gz'. 
+00049920: 2020 2020 2020 2070 7269 6e74 2822 4d6f         print("Mo
+00049930: 6461 6c69 7479 2073 7065 6369 6669 6320  dality specific 
+00049940: 7072 6f63 6573 7369 6e67 3a20 2220 2b20  processing: " + 
+00049950: 6d79 6d6f 6420 2b20 2220 6578 6563 7574  mymod + " execut
+00049960: 696f 6e20 2220 290a 2020 2020 2020 2020  ion " ).        
+00049970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049980: 2020 2020 7072 696e 7428 206d 796d 6d20      print( mymm 
+00049990: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000499a0: 2020 2020 2020 2020 2020 656c 6966 2076            elif v
+000499b0: 6572 626f 7365 2061 6e64 2065 7869 7374  erbose and exist
+000499c0: 7328 206d 796d 6d6f 7574 2029 203a 0a20  s( mymmout ) :. 
+000499d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000499e0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+000499f0: 2822 4d6f 6461 6c69 7479 2073 7065 6369  ("Modality speci
+00049a00: 6669 6320 7072 6f63 6573 7369 6e67 3a20  fic processing: 
+00049a10: 2220 2b20 6d79 6d6f 6420 2b20 2220 636f  " + mymod + " co
+00049a20: 6d70 6c65 7465 2022 2029 0a20 2020 2020  mplete " ).     
 00049a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049a50: 2020 2074 656d 706c 6174 6520 3d20 6d6d     template = mm
-00049a60: 5f72 6561 6428 2074 656d 706c 6174 6566  _read( templatef
-00049a70: 6e20 290a 2020 2020 2020 2020 2020 2020  n ).            
+00049a40: 2020 2069 6620 6578 6973 7473 2820 6d79     if exists( my
+00049a50: 6d6d 6f75 7420 2920 3a0a 2020 2020 2020  mmout ) :.      
+00049a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049a70: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
 00049a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049a90: 2020 2020 2020 2020 7465 6d70 6c61 7465          template
-00049aa0: 203d 2061 6e74 732e 7265 7361 6d70 6c65   = ants.resample
-00049ab0: 5f69 6d61 6765 2820 7465 6d70 6c61 7465  _image( template
-00049ac0: 2c20 5b31 2c31 2c31 5d2c 2075 7365 5f76  , [1,1,1], use_v
-00049ad0: 6f78 656c 733d 4661 6c73 6520 290a 2020  oxels=False ).  
+00049a90: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+00049aa0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00049ab0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00049ac0: 7269 6e74 2873 7562 6a65 6374 7072 6f70  rint(subjectprop
+00049ad0: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
 00049ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049b00: 2020 7431 7265 6720 3d20 616e 7473 2e72    t1reg = ants.r
-00049b10: 6567 6973 7472 6174 696f 6e28 2074 656d  egistration( tem
-00049b20: 706c 6174 652c 2068 6965 725b 2762 7261  plate, hier['bra
-00049b30: 696e 5f6e 345f 646e 7a27 5d2c 0a20 2020  in_n4_dnz'],.   
-00049b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049b60: 2020 2020 2022 616e 7473 5265 6769 7374       "antsRegist
-00049b70: 7261 7469 6f6e 5379 4e51 7569 636b 5265  rationSyNQuickRe
-00049b80: 7072 6f5b 735d 222c 206f 7574 7072 6566  pro[s]", outpref
-00049b90: 6978 203d 2072 6567 6f75 742c 2076 6572  ix = regout, ver
-00049ba0: 626f 7365 3d46 616c 7365 2029 0a20 2020  bose=False ).   
-00049bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049bd0: 206d 796a 6163 203d 2061 6e74 732e 6372   myjac = ants.cr
-00049be0: 6561 7465 5f6a 6163 6f62 6961 6e5f 6465  eate_jacobian_de
-00049bf0: 7465 726d 696e 616e 745f 696d 6167 6528  terminant_image(
-00049c00: 2074 656d 706c 6174 652c 0a20 2020 2020   template,.     
-00049c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049c30: 2020 2074 3172 6567 5b27 6677 6474 7261     t1reg['fwdtra
-00049c40: 6e73 666f 726d 7327 5d5b 305d 2c20 646f  nsforms'][0], do
-00049c50: 5f6c 6f67 3d54 7275 652c 2067 656f 6d3d  _log=True, geom=
-00049c60: 5472 7565 2029 0a20 2020 2020 2020 2020  True ).         
-00049c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049c80: 2020 2020 2020 2020 2020 2069 6d61 6765             image
-00049c90: 5f77 7269 7465 5f77 6974 685f 7468 756d  _write_with_thum
-00049ca0: 626e 6169 6c28 206d 796a 6163 2c20 7265  bnail( myjac, re
-00049cb0: 676f 7574 202b 2022 6c6f 676a 6163 6f62  gout + "logjacob
-00049cc0: 6961 6e2e 6e69 692e 677a 222c 2074 6875  ian.nii.gz", thu
-00049cd0: 6d62 3d46 616c 7365 2029 0a20 2020 2020  mb=False ).     
+00049af0: 2070 7269 6e74 2869 6465 6e74 6966 6965   print(identifie
+00049b00: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
+00049b10: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00049b20: 7269 6e74 2820 6d79 696d 6720 290a 2020  rint( myimg ).  
+00049b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049b40: 2020 2020 2020 6966 206e 6f74 2074 6573        if not tes
+00049b50: 746c 6f6f 703a 0a20 2020 2020 2020 2020  tloop:.         
+00049b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049b70: 2020 2069 6d67 203d 206d 6d5f 7265 6164     img = mm_read
+00049b80: 2820 6d79 696d 6720 290a 2020 2020 2020  ( myimg ).      
+00049b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049ba0: 2020 2020 2020 6973 6861 7065 6c65 6e20        ishapelen 
+00049bb0: 3d20 6c65 6e28 2069 6d67 2e73 6861 7065  = len( img.shape
+00049bc0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00049bd0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00049be0: 6620 6d79 6d6f 6420 3d3d 2027 5431 7727  f mymod == 'T1w'
+00049bf0: 2061 6e64 2069 7368 6170 656c 656e 203d   and ishapelen =
+00049c00: 3d20 333a 2023 2066 6f72 2061 2072 6561  = 3: # for a rea
+00049c10: 6c20 7275 6e2c 2073 6574 2074 6f20 5472  l run, set to Tr
+00049c20: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00049c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049c40: 2020 2069 6620 6e6f 7420 6578 6973 7473     if not exists
+00049c50: 2820 7265 676f 7574 202b 2022 6c6f 676a  ( regout + "logj
+00049c60: 6163 6f62 6961 6e2e 6e69 692e 677a 2220  acobian.nii.gz" 
+00049c70: 2920 6f72 206e 6f74 2065 7869 7374 7328  ) or not exists(
+00049c80: 2072 6567 6f75 742b 2731 5761 7270 2e6e   regout+'1Warp.n
+00049c90: 6969 2e67 7a27 2029 3a0a 2020 2020 2020  ii.gz' ):.      
+00049ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049cb0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00049cc0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+00049cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00049ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049cf0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00049d00: 6620 7669 7375 616c 697a 653a 0a20 2020  f visualize:.   
-00049d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049cf0: 2020 7072 696e 7428 2773 7461 7274 2074    print('start t
+00049d00: 3120 7265 6769 7374 7261 7469 6f6e 2729  1 registration')
+00049d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00049d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049d30: 2020 2020 2061 6e74 732e 706c 6f74 2820       ants.plot( 
-00049d40: 616e 7473 2e69 4d61 7468 2874 3172 6567  ants.iMath(t1reg
-00049d50: 5b27 7761 7270 6564 6d6f 766f 7574 275d  ['warpedmovout']
-00049d60: 2c22 4e6f 726d 616c 697a 6522 292c 2020  ,"Normalize"),  
-00049d70: 6178 6973 3d32 2c20 6e73 6c69 6365 733d  axis=2, nslices=
-00049d80: 3231 2c20 6e63 6f6c 3d37 2c20 6372 6f70  21, ncol=7, crop
-00049d90: 3d54 7275 652c 2074 6974 6c65 3d27 7761  =True, title='wa
-00049da0: 7270 6564 2074 6f20 7465 6d70 6c61 7465  rped to template
-00049db0: 272c 2066 696c 656e 616d 653d 7265 676f  ', filename=rego
-00049dc0: 7574 2b22 746f 7465 6d70 6c61 7465 2e70  ut+"totemplate.p
-00049dd0: 6e67 2220 290a 2020 2020 2020 2020 2020  ng" ).          
-00049de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049df0: 2020 2020 2020 2020 2020 2020 2020 616e                an
-00049e00: 7473 2e70 6c6f 7428 2061 6e74 732e 694d  ts.plot( ants.iM
-00049e10: 6174 6828 6d79 6a61 632c 224e 6f72 6d61  ath(myjac,"Norma
-00049e20: 6c69 7a65 2229 2c20 2061 7869 733d 322c  lize"),  axis=2,
-00049e30: 206e 736c 6963 6573 3d32 312c 206e 636f   nslices=21, nco
-00049e40: 6c3d 372c 2063 726f 703d 5472 7565 2c20  l=7, crop=True, 
-00049e50: 7469 746c 653d 276a 6163 6f62 6961 6e27  title='jacobian'
-00049e60: 2c20 6669 6c65 6e61 6d65 3d72 6567 6f75  , filename=regou
-00049e70: 742b 226a 6163 6f62 6961 6e2e 706e 6722  t+"jacobian.png"
-00049e80: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00049e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049ea0: 2020 2069 6620 6e6f 7420 6578 6973 7473     if not exists
-00049eb0: 2820 6d79 6d6d 202b 206d 7973 6570 202b  ( mymm + mysep +
-00049ec0: 2022 6b6b 5f6e 6f72 6d2e 6e69 692e 677a   "kk_norm.nii.gz
-00049ed0: 2220 293a 0a20 2020 2020 2020 2020 2020  " ):.           
+00049d30: 2020 2020 2065 785f 7061 7468 203d 206f       ex_path = o
+00049d40: 732e 7061 7468 2e65 7870 616e 6475 7365  s.path.expanduse
+00049d50: 7228 2022 7e2f 2e61 6e74 7370 7974 3177  r( "~/.antspyt1w
+00049d60: 2f22 2029 0a20 2020 2020 2020 2020 2020  /" ).           
+00049d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049d80: 2020 2020 2020 2020 2074 656d 706c 6174           templat
+00049d90: 6566 6e20 3d20 6578 5f70 6174 6820 2b20  efn = ex_path + 
+00049da0: 2743 4954 3136 385f 5431 775f 3730 3075  'CIT168_T1w_700u
+00049db0: 6d5f 7061 645f 6164 6e69 2e6e 6969 2e67  m_pad_adni.nii.g
+00049dc0: 7a27 0a20 2020 2020 2020 2020 2020 2020  z'.             
+00049dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049de0: 2020 2020 2020 2074 656d 706c 6174 6520         template 
+00049df0: 3d20 6d6d 5f72 6561 6428 2074 656d 706c  = mm_read( templ
+00049e00: 6174 6566 6e20 290a 2020 2020 2020 2020  atefn ).        
+00049e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049e20: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
+00049e30: 6c61 7465 203d 2061 6e74 732e 7265 7361  late = ants.resa
+00049e40: 6d70 6c65 5f69 6d61 6765 2820 7465 6d70  mple_image( temp
+00049e50: 6c61 7465 2c20 5b31 2c31 2c31 5d2c 2075  late, [1,1,1], u
+00049e60: 7365 5f76 6f78 656c 733d 4661 6c73 6520  se_voxels=False 
+00049e70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00049e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049e90: 2020 2020 2020 7431 7265 6720 3d20 616e        t1reg = an
+00049ea0: 7473 2e72 6567 6973 7472 6174 696f 6e28  ts.registration(
+00049eb0: 2074 656d 706c 6174 652c 2068 6965 725b   template, hier[
+00049ec0: 2762 7261 696e 5f6e 345f 646e 7a27 5d2c  'brain_n4_dnz'],
+00049ed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00049ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049ef0: 2020 2020 2020 2020 2064 6f77 7269 7465           dowrite
-00049f00: 3d54 7275 650a 2020 2020 2020 2020 2020  =True.          
-00049f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049f20: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
-00049f30: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-00049f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049f50: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00049f60: 696e 7428 2773 7461 7274 206b 6b27 290a  int('start kk').
-00049f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049f90: 2020 2020 7461 6250 726f 2c20 6e6f 726d      tabPro, norm
-00049fa0: 5072 6f20 3d20 6d6d 2820 7431 2c20 6869  Pro = mm( t1, hi
-00049fb0: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
-00049fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049fd0: 2020 2020 2020 2020 2020 2020 7372 6d6f              srmo
-00049fe0: 6465 6c3d 4e6f 6e65 2c0a 2020 2020 2020  del=None,.      
-00049ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049ef0: 2020 2020 2020 2020 2022 616e 7473 5265           "antsRe
+00049f00: 6769 7374 7261 7469 6f6e 5379 4e51 7569  gistrationSyNQui
+00049f10: 636b 5265 7072 6f5b 735d 222c 206f 7574  ckRepro[s]", out
+00049f20: 7072 6566 6978 203d 2072 6567 6f75 742c  prefix = regout,
+00049f30: 2076 6572 626f 7365 3d46 616c 7365 2029   verbose=False )
+00049f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00049f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049f60: 2020 2020 206d 796a 6163 203d 2061 6e74       myjac = ant
+00049f70: 732e 6372 6561 7465 5f6a 6163 6f62 6961  s.create_jacobia
+00049f80: 6e5f 6465 7465 726d 696e 616e 745f 696d  n_determinant_im
+00049f90: 6167 6528 2074 656d 706c 6174 652c 0a20  age( template,. 
+00049fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049fc0: 2020 2020 2020 2074 3172 6567 5b27 6677         t1reg['fw
+00049fd0: 6474 7261 6e73 666f 726d 7327 5d5b 305d  dtransforms'][0]
+00049fe0: 2c20 646f 5f6c 6f67 3d54 7275 652c 2067  , do_log=True, g
+00049ff0: 656f 6d3d 5472 7565 2029 0a20 2020 2020  eom=True ).     
 0004a000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a010: 2020 646f 5f74 7261 6374 6f67 7261 7068    do_tractograph
-0004a020: 793d 4661 6c73 652c 0a20 2020 2020 2020  y=False,.       
-0004a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a050: 2064 6f5f 6b6b 3d54 7275 652c 0a20 2020   do_kk=True,.   
-0004a060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a010: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0004a020: 6d61 6765 5f77 7269 7465 5f77 6974 685f  mage_write_with_
+0004a030: 7468 756d 626e 6169 6c28 206d 796a 6163  thumbnail( myjac
+0004a040: 2c20 7265 676f 7574 202b 2022 6c6f 676a  , regout + "logj
+0004a050: 6163 6f62 6961 6e2e 6e69 692e 677a 222c  acobian.nii.gz",
+0004a060: 2074 6875 6d62 3d46 616c 7365 2029 0a20   thumb=False ). 
 0004a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a080: 2020 2020 2064 6f5f 6e6f 726d 616c 697a       do_normaliz
-0004a090: 6174 696f 6e3d 7465 6d70 6c61 7465 5478  ation=templateTx
-0004a0a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0004a080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a090: 2020 2069 6620 7669 7375 616c 697a 653a     if visualize:
+0004a0a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0004a0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a0c0: 2020 2020 2020 2020 2020 7465 7374 5f72            test_r
-0004a0d0: 756e 3d74 6573 745f 7275 6e2c 0a20 2020  un=test_run,.   
-0004a0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a100: 2020 2020 2076 6572 626f 7365 3d54 7275       verbose=Tru
-0004a110: 6520 290a 2020 2020 2020 2020 2020 2020  e ).            
-0004a120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a130: 2020 2020 2020 2020 6966 2076 6973 7561          if visua
-0004a140: 6c69 7a65 3a0a 2020 2020 2020 2020 2020  lize:.          
-0004a150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a160: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-0004a170: 7873 6c69 6365 203d 206e 702e 6d69 6e28  xslice = np.min(
-0004a180: 205b 3231 2c20 6869 6572 5b27 6272 6169   [21, hier['brai
-0004a190: 6e5f 6e34 5f64 6e7a 275d 2e73 6861 7065  n_n4_dnz'].shape
-0004a1a0: 5b32 5d20 5d20 290a 2020 2020 2020 2020  [2] ] ).        
-0004a1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a1d0: 616e 7473 2e70 6c6f 7428 2068 6965 725b  ants.plot( hier[
-0004a1e0: 2762 7261 696e 5f6e 345f 646e 7a27 5d2c  'brain_n4_dnz'],
-0004a1f0: 2020 6178 6973 3d32 2c20 6e73 6c69 6365    axis=2, nslice
-0004a200: 733d 6d61 7873 6c69 6365 2c20 6e63 6f6c  s=maxslice, ncol
-0004a210: 3d37 2c20 6372 6f70 3d54 7275 652c 2074  =7, crop=True, t
-0004a220: 6974 6c65 3d27 6272 6169 6e20 6578 7472  itle='brain extr
-0004a230: 6163 7469 6f6e 272c 2066 696c 656e 616d  action', filenam
-0004a240: 653d 6d79 6d6d 2b6d 7973 6570 2b22 6272  e=mymm+mysep+"br
-0004a250: 6169 6e65 7874 7261 6374 696f 6e2e 706e  ainextraction.pn
-0004a260: 6722 2029 0a20 2020 2020 2020 2020 2020  g" ).           
+0004a0c0: 2020 2020 2020 2020 2061 6e74 732e 706c           ants.pl
+0004a0d0: 6f74 2820 616e 7473 2e69 4d61 7468 2874  ot( ants.iMath(t
+0004a0e0: 3172 6567 5b27 7761 7270 6564 6d6f 766f  1reg['warpedmovo
+0004a0f0: 7574 275d 2c22 4e6f 726d 616c 697a 6522  ut'],"Normalize"
+0004a100: 292c 2020 6178 6973 3d32 2c20 6e73 6c69  ),  axis=2, nsli
+0004a110: 6365 733d 3231 2c20 6e63 6f6c 3d37 2c20  ces=21, ncol=7, 
+0004a120: 6372 6f70 3d54 7275 652c 2074 6974 6c65  crop=True, title
+0004a130: 3d27 7761 7270 6564 2074 6f20 7465 6d70  ='warped to temp
+0004a140: 6c61 7465 272c 2066 696c 656e 616d 653d  late', filename=
+0004a150: 7265 676f 7574 2b22 746f 7465 6d70 6c61  regout+"totempla
+0004a160: 7465 2e70 6e67 2220 290a 2020 2020 2020  te.png" ).      
+0004a170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a190: 2020 616e 7473 2e70 6c6f 7428 2061 6e74    ants.plot( ant
+0004a1a0: 732e 694d 6174 6828 6d79 6a61 632c 224e  s.iMath(myjac,"N
+0004a1b0: 6f72 6d61 6c69 7a65 2229 2c20 2061 7869  ormalize"),  axi
+0004a1c0: 733d 322c 206e 736c 6963 6573 3d32 312c  s=2, nslices=21,
+0004a1d0: 206e 636f 6c3d 372c 2063 726f 703d 5472   ncol=7, crop=Tr
+0004a1e0: 7565 2c20 7469 746c 653d 276a 6163 6f62  ue, title='jacob
+0004a1f0: 6961 6e27 2c20 6669 6c65 6e61 6d65 3d72  ian', filename=r
+0004a200: 6567 6f75 742b 226a 6163 6f62 6961 6e2e  egout+"jacobian.
+0004a210: 706e 6722 2029 0a20 2020 2020 2020 2020  png" ).         
+0004a220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a230: 2020 2020 2020 2069 6620 6e6f 7420 6578         if not ex
+0004a240: 6973 7473 2820 6d79 6d6d 202b 206d 7973  ists( mymm + mys
+0004a250: 6570 202b 2022 6b6b 5f6e 6f72 6d2e 6e69  ep + "kk_norm.ni
+0004a260: 692e 677a 2220 293a 0a20 2020 2020 2020  i.gz" ):.       
 0004a270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a280: 2020 2020 2020 2020 2020 2020 2061 6e74               ant
-0004a290: 732e 706c 6f74 2820 7461 6250 726f 5b27  s.plot( tabPro['
-0004a2a0: 6b6b 275d 5b27 7468 6963 6b6e 6573 735f  kk']['thickness_
-0004a2b0: 696d 6167 6527 5d2c 2061 7869 733d 322c  image'], axis=2,
-0004a2c0: 206e 736c 6963 6573 3d6d 6178 736c 6963   nslices=maxslic
-0004a2d0: 652c 206e 636f 6c3d 372c 2063 726f 703d  e, ncol=7, crop=
-0004a2e0: 5472 7565 2c20 7469 746c 653d 276b 6b27  True, title='kk'
-0004a2f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0004a300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a310: 2020 2020 2020 2020 2020 636d 6170 3d27            cmap='
-0004a320: 706c 6173 6d61 272c 2066 696c 656e 616d  plasma', filenam
-0004a330: 653d 6d79 6d6d 2b6d 7973 6570 2b22 6b6b  e=mymm+mysep+"kk
-0004a340: 7468 6963 6b6e 6573 732e 706e 6722 2029  thickness.png" )
-0004a350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004a360: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0004a370: 6d79 6d6f 6420 3d3d 2027 5432 466c 6169  mymod == 'T2Flai
-0004a380: 7227 2061 6e64 2069 7368 6170 656c 656e  r' and ishapelen
-0004a390: 203d 3d20 333a 0a20 2020 2020 2020 2020   == 3:.         
-0004a3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a3b0: 2020 2020 2020 2064 6f77 7269 7465 3d54         dowrite=T
-0004a3c0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+0004a280: 2020 2020 2020 2020 2020 2020 2064 6f77               dow
+0004a290: 7269 7465 3d54 7275 650a 2020 2020 2020  rite=True.      
+0004a2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a2b0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0004a2c0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+0004a2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a2f0: 2020 7072 696e 7428 2773 7461 7274 206b    print('start k
+0004a300: 6b27 290a 2020 2020 2020 2020 2020 2020  k').            
+0004a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a320: 2020 2020 2020 2020 7461 6250 726f 2c20          tabPro, 
+0004a330: 6e6f 726d 5072 6f20 3d20 6d6d 2820 7431  normPro = mm( t1
+0004a340: 2c20 6869 6572 2c0a 2020 2020 2020 2020  , hier,.        
+0004a350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a370: 7372 6d6f 6465 6c3d 4e6f 6e65 2c0a 2020  srmodel=None,.  
+0004a380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a3a0: 2020 2020 2020 646f 5f74 7261 6374 6f67        do_tractog
+0004a3b0: 7261 7068 793d 4661 6c73 652c 0a20 2020  raphy=False,.   
+0004a3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0004a3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a3e0: 2020 2020 7461 6250 726f 2c20 6e6f 726d      tabPro, norm
-0004a3f0: 5072 6f20 3d20 6d6d 2820 7431 2c20 6869  Pro = mm( t1, hi
-0004a400: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
-0004a410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a420: 2020 2020 2020 2020 666c 6169 725f 696d          flair_im
-0004a430: 6167 6520 3d20 696d 672c 0a20 2020 2020  age = img,.     
+0004a3e0: 2020 2020 2064 6f5f 6b6b 3d54 7275 652c       do_kk=True,
+0004a3f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004a400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a410: 2020 2020 2020 2020 2064 6f5f 6e6f 726d           do_norm
+0004a420: 616c 697a 6174 696f 6e3d 7465 6d70 6c61  alization=templa
+0004a430: 7465 5478 2c0a 2020 2020 2020 2020 2020  teTx,.          
 0004a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a450: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0004a460: 726d 6f64 656c 3d4e 6f6e 652c 0a20 2020  rmodel=None,.   
-0004a470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a450: 2020 2020 2020 2020 2020 2020 2020 7465                te
+0004a460: 7374 5f72 756e 3d74 6573 745f 7275 6e2c  st_run=test_run,
+0004a470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0004a480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a490: 2064 6f5f 7472 6163 746f 6772 6170 6879   do_tractography
-0004a4a0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+0004a490: 2020 2020 2020 2020 2076 6572 626f 7365           verbose
+0004a4a0: 3d54 7275 6520 290a 2020 2020 2020 2020  =True ).        
 0004a4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a4c0: 2020 2020 2020 2020 2020 2020 646f 5f6b              do_k
-0004a4d0: 6b3d 4661 6c73 652c 0a20 2020 2020 2020  k=False,.       
+0004a4c0: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+0004a4d0: 6973 7561 6c69 7a65 3a0a 2020 2020 2020  isualize:.      
 0004a4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a4f0: 2020 2020 2020 2020 2020 2020 2064 6f5f               do_
-0004a500: 6e6f 726d 616c 697a 6174 696f 6e3d 7465  normalization=te
-0004a510: 6d70 6c61 7465 5478 2c0a 2020 2020 2020  mplateTx,.      
-0004a520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a530: 2020 2020 2020 2020 2020 2020 2020 7465                te
-0004a540: 7374 5f72 756e 3d74 6573 745f 7275 6e2c  st_run=test_run,
-0004a550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004a560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a570: 2020 2020 2076 6572 626f 7365 3d54 7275       verbose=Tru
-0004a580: 6520 290a 2020 2020 2020 2020 2020 2020  e ).            
-0004a590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a5a0: 2020 2020 6966 2076 6973 7561 6c69 7a65      if visualize
-0004a5b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0004a5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a5d0: 2020 2020 2020 6d61 7873 6c69 6365 203d        maxslice =
-0004a5e0: 206e 702e 6d69 6e28 205b 3231 2c20 696d   np.min( [21, im
-0004a5f0: 672e 7368 6170 655b 325d 205d 2029 0a20  g.shape[2] ] ). 
+0004a4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a500: 2020 6d61 7873 6c69 6365 203d 206e 702e    maxslice = np.
+0004a510: 6d69 6e28 205b 3231 2c20 6869 6572 5b27  min( [21, hier['
+0004a520: 6272 6169 6e5f 6e34 5f64 6e7a 275d 2e73  brain_n4_dnz'].s
+0004a530: 6861 7065 5b32 5d20 5d20 290a 2020 2020  hape[2] ] ).    
+0004a540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a560: 2020 2020 616e 7473 2e70 6c6f 7428 2068      ants.plot( h
+0004a570: 6965 725b 2762 7261 696e 5f6e 345f 646e  ier['brain_n4_dn
+0004a580: 7a27 5d2c 2020 6178 6973 3d32 2c20 6e73  z'],  axis=2, ns
+0004a590: 6c69 6365 733d 6d61 7873 6c69 6365 2c20  lices=maxslice, 
+0004a5a0: 6e63 6f6c 3d37 2c20 6372 6f70 3d54 7275  ncol=7, crop=Tru
+0004a5b0: 652c 2074 6974 6c65 3d27 6272 6169 6e20  e, title='brain 
+0004a5c0: 6578 7472 6163 7469 6f6e 272c 2066 696c  extraction', fil
+0004a5d0: 656e 616d 653d 6d79 6d6d 2b6d 7973 6570  ename=mymm+mysep
+0004a5e0: 2b22 6272 6169 6e65 7874 7261 6374 696f  +"brainextractio
+0004a5f0: 6e2e 706e 6722 2029 0a20 2020 2020 2020  n.png" ).       
 0004a600: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0004a610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a620: 2020 2061 6e74 732e 706c 6f74 5f6f 7274     ants.plot_ort
-0004a630: 686f 2820 696d 672c 2063 726f 703d 5472  ho( img, crop=Tr
-0004a640: 7565 2c20 7469 746c 653d 2746 6c61 6972  ue, title='Flair
-0004a650: 272c 2066 696c 656e 616d 653d 6d79 6d6d  ', filename=mymm
-0004a660: 2b6d 7973 6570 2b22 666c 6169 722e 706e  +mysep+"flair.pn
-0004a670: 6722 2c20 666c 6174 3d54 7275 6520 290a  g", flat=True ).
-0004a680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a620: 2061 6e74 732e 706c 6f74 2820 7461 6250   ants.plot( tabP
+0004a630: 726f 5b27 6b6b 275d 5b27 7468 6963 6b6e  ro['kk']['thickn
+0004a640: 6573 735f 696d 6167 6527 5d2c 2061 7869  ess_image'], axi
+0004a650: 733d 322c 206e 736c 6963 6573 3d6d 6178  s=2, nslices=max
+0004a660: 736c 6963 652c 206e 636f 6c3d 372c 2063  slice, ncol=7, c
+0004a670: 726f 703d 5472 7565 2c20 7469 746c 653d  rop=True, title=
+0004a680: 276b 6b27 2c0a 2020 2020 2020 2020 2020  'kk',.          
 0004a690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a6a0: 2020 2020 616e 7473 2e70 6c6f 745f 6f72      ants.plot_or
-0004a6b0: 7468 6f28 2069 6d67 2c20 7461 6250 726f  tho( img, tabPro
-0004a6c0: 5b27 666c 6169 7227 5d5b 2757 4d48 5f70  ['flair']['WMH_p
-0004a6d0: 726f 6261 6269 6c69 7479 5f6d 6170 275d  robability_map']
-0004a6e0: 2c20 6372 6f70 3d54 7275 652c 2074 6974  , crop=True, tit
-0004a6f0: 6c65 3d27 466c 6169 7220 2b20 574d 4827  le='Flair + WMH'
-0004a700: 2c20 6669 6c65 6e61 6d65 3d6d 796d 6d2b  , filename=mymm+
-0004a710: 6d79 7365 702b 2266 6c61 6972 574d 482e  mysep+"flairWMH.
-0004a720: 706e 6722 2c20 666c 6174 3d54 7275 6520  png", flat=True 
-0004a730: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0004a740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a750: 2020 2020 2020 6966 2074 6162 5072 6f5b        if tabPro[
-0004a760: 2766 6c61 6972 275d 5b27 574d 485f 706f  'flair']['WMH_po
-0004a770: 7374 6572 696f 725f 7072 6f62 6162 696c  sterior_probabil
-0004a780: 6974 795f 6d61 7027 5d20 6973 206e 6f74  ity_map'] is not
-0004a790: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0004a6a0: 2020 2020 2020 2020 2020 2020 2020 636d                cm
+0004a6b0: 6170 3d27 706c 6173 6d61 272c 2066 696c  ap='plasma', fil
+0004a6c0: 656e 616d 653d 6d79 6d6d 2b6d 7973 6570  ename=mymm+mysep
+0004a6d0: 2b22 6b6b 7468 6963 6b6e 6573 732e 706e  +"kkthickness.pn
+0004a6e0: 6722 2029 0a20 2020 2020 2020 2020 2020  g" ).           
+0004a6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a700: 2069 6620 6d79 6d6f 6420 3d3d 2027 5432   if mymod == 'T2
+0004a710: 466c 6169 7227 2061 6e64 2069 7368 6170  Flair' and ishap
+0004a720: 656c 656e 203d 3d20 333a 0a20 2020 2020  elen == 3:.     
+0004a730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a740: 2020 2020 2020 2020 2020 2064 6f77 7269             dowri
+0004a750: 7465 3d54 7275 650a 2020 2020 2020 2020  te=True.        
+0004a760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a770: 2020 2020 2020 2020 7461 6250 726f 2c20          tabPro, 
+0004a780: 6e6f 726d 5072 6f20 3d20 6d6d 2820 7431  normPro = mm( t1
+0004a790: 2c20 6869 6572 2c0a 2020 2020 2020 2020  , hier,.        
 0004a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a7b0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0004a7c0: 6e74 732e 706c 6f74 5f6f 7274 686f 2820  nts.plot_ortho( 
-0004a7d0: 696d 672c 2074 6162 5072 6f5b 2766 6c61  img, tabPro['fla
-0004a7e0: 6972 275d 5b27 574d 485f 706f 7374 6572  ir']['WMH_poster
-0004a7f0: 696f 725f 7072 6f62 6162 696c 6974 795f  ior_probability_
-0004a800: 6d61 7027 5d2c 2020 6372 6f70 3d54 7275  map'],  crop=Tru
-0004a810: 652c 2074 6974 6c65 3d27 466c 6169 7220  e, title='Flair 
-0004a820: 2b20 7072 696f 7220 574d 4827 2c20 6669  + prior WMH', fi
-0004a830: 6c65 6e61 6d65 3d6d 796d 6d2b 6d79 7365  lename=mymm+myse
-0004a840: 702b 2266 6c61 6972 7072 696f 7257 4d48  p+"flairpriorWMH
-0004a850: 2e70 6e67 222c 2066 6c61 743d 5472 7565  .png", flat=True
-0004a860: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0004a870: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0004a880: 6620 2820 6d79 6d6f 6420 3d3d 2027 7273  f ( mymod == 'rs
-0004a890: 664d 5249 5f4c 5227 206f 7220 6d79 6d6f  fMRI_LR' or mymo
-0004a8a0: 6420 3d3d 2027 7273 664d 5249 5f52 4c27  d == 'rsfMRI_RL'
-0004a8b0: 206f 7220 6d79 6d6f 6420 3d3d 2027 7273   or mymod == 'rs
-0004a8c0: 664d 5249 2720 2920 2061 6e64 2069 7368  fMRI' )  and ish
-0004a8d0: 6170 656c 656e 203d 3d20 343a 0a20 2020  apelen == 4:.   
-0004a8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a8f0: 2020 2020 2020 2020 2020 2020 2069 6d67               img
-0004a900: 3220 3d20 4e6f 6e65 0a20 2020 2020 2020  2 = None.       
-0004a910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a920: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-0004a930: 206d 7969 6d67 7372 2029 203e 2031 3a0a   myimgsr ) > 1:.
-0004a940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a7b0: 2020 2020 2020 2020 2020 2020 666c 6169              flai
+0004a7c0: 725f 696d 6167 6520 3d20 696d 672c 0a20  r_image = img,. 
+0004a7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a7f0: 2020 2073 726d 6f64 656c 3d4e 6f6e 652c     srmodel=None,
+0004a800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004a810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a820: 2020 2020 2064 6f5f 7472 6163 746f 6772       do_tractogr
+0004a830: 6170 6879 3d46 616c 7365 2c0a 2020 2020  aphy=False,.    
+0004a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a860: 646f 5f6b 6b3d 4661 6c73 652c 0a20 2020  do_kk=False,.   
+0004a870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a890: 2064 6f5f 6e6f 726d 616c 697a 6174 696f   do_normalizatio
+0004a8a0: 6e3d 7465 6d70 6c61 7465 5478 2c0a 2020  n=templateTx,.  
+0004a8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a8d0: 2020 7465 7374 5f72 756e 3d74 6573 745f    test_run=test_
+0004a8e0: 7275 6e2c 0a20 2020 2020 2020 2020 2020  run,.           
+0004a8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a900: 2020 2020 2020 2020 2076 6572 626f 7365           verbose
+0004a910: 3d54 7275 6520 290a 2020 2020 2020 2020  =True ).        
+0004a920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a930: 2020 2020 2020 2020 6966 2076 6973 7561          if visua
+0004a940: 6c69 7a65 3a0a 2020 2020 2020 2020 2020  lize:.          
 0004a950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a960: 2020 2020 696d 6732 203d 206d 6d5f 7265      img2 = mm_re
-0004a970: 6164 2820 6d79 696d 6773 725b 6d79 696d  ad( myimgsr[myim
-0004a980: 6763 6f75 6e74 2b31 5d20 290a 2020 2020  gcount+1] ).    
-0004a990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a960: 2020 2020 2020 2020 2020 6d61 7873 6c69            maxsli
+0004a970: 6365 203d 206e 702e 6d69 6e28 205b 3231  ce = np.min( [21
+0004a980: 2c20 696d 672e 7368 6170 655b 325d 205d  , img.shape[2] ]
+0004a990: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
 0004a9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a9b0: 6973 6861 7065 6c65 6e32 203d 206c 656e  ishapelen2 = len
-0004a9c0: 2820 696d 6732 2e73 6861 7065 2029 0a20  ( img2.shape ). 
-0004a9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a9f0: 2020 2069 6620 6973 6861 7065 6c65 6e32     if ishapelen2
-0004aa00: 2021 3d20 3420 3a0a 2020 2020 2020 2020   != 4 :.        
-0004aa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a9b0: 2020 2020 2020 2061 6e74 732e 706c 6f74         ants.plot
+0004a9c0: 5f6f 7274 686f 2820 696d 672c 2063 726f  _ortho( img, cro
+0004a9d0: 703d 5472 7565 2c20 7469 746c 653d 2746  p=True, title='F
+0004a9e0: 6c61 6972 272c 2066 696c 656e 616d 653d  lair', filename=
+0004a9f0: 6d79 6d6d 2b6d 7973 6570 2b22 666c 6169  mymm+mysep+"flai
+0004aa00: 722e 706e 6722 2c20 666c 6174 3d54 7275  r.png", flat=Tru
+0004aa10: 6520 290a 2020 2020 2020 2020 2020 2020  e ).            
 0004aa20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004aa30: 696d 6732 203d 204e 6f6e 650a 2020 2020  img2 = None.    
-0004aa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004aa50: 2020 2020 2020 2020 2020 2020 646f 7772              dowr
-0004aa60: 6974 653d 5472 7565 0a20 2020 2020 2020  ite=True.       
-0004aa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004aa80: 2020 2020 2020 2020 2074 6162 5072 6f2c           tabPro,
-0004aa90: 206e 6f72 6d50 726f 203d 206d 6d28 2074   normPro = mm( t
-0004aaa0: 312c 2068 6965 722c 0a20 2020 2020 2020  1, hier,.       
-0004aab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004aac0: 2020 2020 2020 2020 2020 2020 2072 7366               rsf
-0004aad0: 5f69 6d61 6765 3d5b 696d 672c 696d 6732  _image=[img,img2
-0004aae0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0004aaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ab00: 2020 2020 2020 2073 726d 6f64 656c 3d4e         srmodel=N
-0004ab10: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-0004ab20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ab30: 2020 2020 2020 2020 2064 6f5f 7472 6163           do_trac
-0004ab40: 746f 6772 6170 6879 3d46 616c 7365 2c0a  tography=False,.
-0004ab50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ab60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ab70: 2020 2020 646f 5f6b 6b3d 4661 6c73 652c      do_kk=False,
-0004ab80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004ab90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004aba0: 2020 2020 2064 6f5f 6e6f 726d 616c 697a       do_normaliz
-0004abb0: 6174 696f 6e3d 7465 6d70 6c61 7465 5478  ation=templateTx
-0004abc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0004abd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004abe0: 2020 2020 2020 7465 7374 5f72 756e 3d74        test_run=t
-0004abf0: 6573 745f 7275 6e2c 0a20 2020 2020 2020  est_run,.       
+0004aa30: 2020 2020 2020 2020 616e 7473 2e70 6c6f          ants.plo
+0004aa40: 745f 6f72 7468 6f28 2069 6d67 2c20 7461  t_ortho( img, ta
+0004aa50: 6250 726f 5b27 666c 6169 7227 5d5b 2757  bPro['flair']['W
+0004aa60: 4d48 5f70 726f 6261 6269 6c69 7479 5f6d  MH_probability_m
+0004aa70: 6170 275d 2c20 6372 6f70 3d54 7275 652c  ap'], crop=True,
+0004aa80: 2074 6974 6c65 3d27 466c 6169 7220 2b20   title='Flair + 
+0004aa90: 574d 4827 2c20 6669 6c65 6e61 6d65 3d6d  WMH', filename=m
+0004aaa0: 796d 6d2b 6d79 7365 702b 2266 6c61 6972  ymm+mysep+"flair
+0004aab0: 574d 482e 706e 6722 2c20 666c 6174 3d54  WMH.png", flat=T
+0004aac0: 7275 6520 290a 2020 2020 2020 2020 2020  rue ).          
+0004aad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004aae0: 2020 2020 2020 2020 2020 6966 2074 6162            if tab
+0004aaf0: 5072 6f5b 2766 6c61 6972 275d 5b27 574d  Pro['flair']['WM
+0004ab00: 485f 706f 7374 6572 696f 725f 7072 6f62  H_posterior_prob
+0004ab10: 6162 696c 6974 795f 6d61 7027 5d20 6973  ability_map'] is
+0004ab20: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0004ab30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ab40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ab50: 2020 2061 6e74 732e 706c 6f74 5f6f 7274     ants.plot_ort
+0004ab60: 686f 2820 696d 672c 2074 6162 5072 6f5b  ho( img, tabPro[
+0004ab70: 2766 6c61 6972 275d 5b27 574d 485f 706f  'flair']['WMH_po
+0004ab80: 7374 6572 696f 725f 7072 6f62 6162 696c  sterior_probabil
+0004ab90: 6974 795f 6d61 7027 5d2c 2020 6372 6f70  ity_map'],  crop
+0004aba0: 3d54 7275 652c 2074 6974 6c65 3d27 466c  =True, title='Fl
+0004abb0: 6169 7220 2b20 7072 696f 7220 574d 4827  air + prior WMH'
+0004abc0: 2c20 6669 6c65 6e61 6d65 3d6d 796d 6d2b  , filename=mymm+
+0004abd0: 6d79 7365 702b 2266 6c61 6972 7072 696f  mysep+"flairprio
+0004abe0: 7257 4d48 2e70 6e67 222c 2066 6c61 743d  rWMH.png", flat=
+0004abf0: 5472 7565 2029 0a20 2020 2020 2020 2020  True ).         
 0004ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ac10: 2020 2020 2020 2020 2020 2020 2076 6572               ver
-0004ac20: 626f 7365 3d54 7275 6520 290a 2020 2020  bose=True ).    
-0004ac30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ac40: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-0004ac50: 6162 5072 6f5b 2772 7366 275d 2069 7320  abPro['rsf'] is 
-0004ac60: 6e6f 7420 4e6f 6e65 2061 6e64 2076 6973  not None and vis
-0004ac70: 7561 6c69 7a65 3a0a 2020 2020 2020 2020  ualize:.        
+0004ac10: 2020 2069 6620 2820 6d79 6d6f 6420 3d3d     if ( mymod ==
+0004ac20: 2027 7273 664d 5249 5f4c 5227 206f 7220   'rsfMRI_LR' or 
+0004ac30: 6d79 6d6f 6420 3d3d 2027 7273 664d 5249  mymod == 'rsfMRI
+0004ac40: 5f52 4c27 206f 7220 6d79 6d6f 6420 3d3d  _RL' or mymod ==
+0004ac50: 2027 7273 664d 5249 2720 2920 2061 6e64   'rsfMRI' )  and
+0004ac60: 2069 7368 6170 656c 656e 203d 3d20 343a   ishapelen == 4:
+0004ac70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0004ac80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ac90: 2020 2020 2020 2020 2020 2020 6466 6e3d              dfn=
-0004aca0: 7461 6250 726f 5b27 7273 6627 5d5b 2764  tabPro['rsf']['d
-0004acb0: 666e 6e61 6d65 275d 0a20 2020 2020 2020  fnname'].       
-0004acc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004acd0: 2020 2020 2020 2020 2020 2020 206d 6178               max
-0004ace0: 736c 6963 6520 3d20 6e70 2e6d 696e 2820  slice = np.min( 
-0004acf0: 5b32 312c 2074 6162 5072 6f5b 2772 7366  [21, tabPro['rsf
-0004ad00: 275d 5b27 6d65 616e 426f 6c64 275d 2e73  ']['meanBold'].s
-0004ad10: 6861 7065 5b32 5d20 5d20 290a 2020 2020  hape[2] ] ).    
+0004ac90: 2069 6d67 3220 3d20 4e6f 6e65 0a20 2020   img2 = None.   
+0004aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004acb0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0004acc0: 6c65 6e28 206d 7969 6d67 7372 2029 203e  len( myimgsr ) >
+0004acd0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+0004ace0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004acf0: 2020 2020 2020 2020 696d 6732 203d 206d          img2 = m
+0004ad00: 6d5f 7265 6164 2820 6d79 696d 6773 725b  m_read( myimgsr[
+0004ad10: 6d79 696d 6763 6f75 6e74 2b31 5d20 290a  myimgcount+1] ).
 0004ad20: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0004ad30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ad40: 616e 7473 2e70 6c6f 7428 2074 6162 5072  ants.plot( tabPr
-0004ad50: 6f5b 2772 7366 275d 5b27 6d65 616e 426f  o['rsf']['meanBo
-0004ad60: 6c64 275d 2c0a 2020 2020 2020 2020 2020  ld'],.          
+0004ad40: 2020 2020 6973 6861 7065 6c65 6e32 203d      ishapelen2 =
+0004ad50: 206c 656e 2820 696d 6732 2e73 6861 7065   len( img2.shape
+0004ad60: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
 0004ad70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ad80: 2020 2020 2020 2020 2020 2020 2020 6178                ax
-0004ad90: 6973 3d32 2c20 6e73 6c69 6365 733d 6d61  is=2, nslices=ma
-0004ada0: 7873 6c69 6365 2c20 6e63 6f6c 3d37 2c20  xslice, ncol=7, 
-0004adb0: 6372 6f70 3d54 7275 652c 2074 6974 6c65  crop=True, title
-0004adc0: 3d27 6d65 616e 424f 4c44 272c 2066 696c  ='meanBOLD', fil
-0004add0: 656e 616d 653d 6d79 6d6d 2b6d 7973 6570  ename=mymm+mysep
-0004ade0: 2b22 6d65 616e 424f 4c44 2e70 6e67 2220  +"meanBOLD.png" 
-0004adf0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0004ad80: 2020 2020 2020 2069 6620 6973 6861 7065         if ishape
+0004ad90: 6c65 6e32 2021 3d20 3420 3a0a 2020 2020  len2 != 4 :.    
+0004ada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004adc0: 2020 2020 696d 6732 203d 204e 6f6e 650a      img2 = None.
+0004add0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ade0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004adf0: 646f 7772 6974 653d 5472 7565 0a20 2020  dowrite=True.   
 0004ae00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ae10: 2020 2020 2020 616e 7473 2e70 6c6f 7428        ants.plot(
-0004ae20: 2074 6162 5072 6f5b 2772 7366 275d 5b27   tabPro['rsf']['
-0004ae30: 6d65 616e 426f 6c64 275d 2c20 616e 7473  meanBold'], ants
-0004ae40: 2e69 4d61 7468 2874 6162 5072 6f5b 2772  .iMath(tabPro['r
-0004ae50: 7366 275d 5b27 616c 6666 275d 2c22 4e6f  sf']['alff'],"No
-0004ae60: 726d 616c 697a 6522 292c 0a20 2020 2020  rmalize"),.     
-0004ae70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ae10: 2020 2020 2020 2020 2020 2020 2074 6162               tab
+0004ae20: 5072 6f2c 206e 6f72 6d50 726f 203d 206d  Pro, normPro = m
+0004ae30: 6d28 2074 312c 2068 6965 722c 0a20 2020  m( t1, hier,.   
+0004ae40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ae50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ae60: 2072 7366 5f69 6d61 6765 3d5b 696d 672c   rsf_image=[img,
+0004ae70: 696d 6732 5d2c 0a20 2020 2020 2020 2020  img2],.         
 0004ae80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ae90: 2020 2061 7869 733d 322c 206e 736c 6963     axis=2, nslic
-0004aea0: 6573 3d6d 6178 736c 6963 652c 206e 636f  es=maxslice, nco
-0004aeb0: 6c3d 372c 2063 726f 703d 5472 7565 2c20  l=7, crop=True, 
-0004aec0: 7469 746c 653d 2741 4c46 4627 2c20 6669  title='ALFF', fi
-0004aed0: 6c65 6e61 6d65 3d6d 796d 6d2b 6d79 7365  lename=mymm+myse
-0004aee0: 702b 2262 6f6c 6441 4c46 462e 706e 6722  p+"boldALFF.png"
-0004aef0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0004af00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004af10: 2020 2020 2020 2061 6e74 732e 706c 6f74         ants.plot
-0004af20: 2820 7461 6250 726f 5b27 7273 6627 5d5b  ( tabPro['rsf'][
-0004af30: 276d 6561 6e42 6f6c 6427 5d2c 2061 6e74  'meanBold'], ant
-0004af40: 732e 694d 6174 6828 7461 6250 726f 5b27  s.iMath(tabPro['
-0004af50: 7273 6627 5d5b 2766 616c 6666 275d 2c22  rsf']['falff'],"
-0004af60: 4e6f 726d 616c 697a 6522 292c 0a20 2020  Normalize"),.   
-0004af70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004af80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004af90: 2020 2020 2061 7869 733d 322c 206e 736c       axis=2, nsl
-0004afa0: 6963 6573 3d6d 6178 736c 6963 652c 206e  ices=maxslice, n
-0004afb0: 636f 6c3d 372c 2063 726f 703d 5472 7565  col=7, crop=True
-0004afc0: 2c20 7469 746c 653d 2766 414c 4646 272c  , title='fALFF',
-0004afd0: 2066 696c 656e 616d 653d 6d79 6d6d 2b6d   filename=mymm+m
-0004afe0: 7973 6570 2b22 626f 6c64 6641 4c46 462e  ysep+"boldfALFF.
-0004aff0: 706e 6722 2029 0a20 2020 2020 2020 2020  png" ).         
-0004b000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b010: 2020 2020 2020 2020 2020 2061 6e74 732e             ants.
-0004b020: 706c 6f74 2820 7461 6250 726f 5b27 7273  plot( tabPro['rs
-0004b030: 6627 5d5b 276d 6561 6e42 6f6c 6427 5d2c  f']['meanBold'],
-0004b040: 2074 6162 5072 6f5b 2772 7366 275d 5b64   tabPro['rsf'][d
-0004b050: 666e 5d2c 0a20 2020 2020 2020 2020 2020  fn],.           
+0004ae90: 2020 2020 2020 2020 2020 2073 726d 6f64             srmod
+0004aea0: 656c 3d4e 6f6e 652c 0a20 2020 2020 2020  el=None,.       
+0004aeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004aec0: 2020 2020 2020 2020 2020 2020 2064 6f5f               do_
+0004aed0: 7472 6163 746f 6772 6170 6879 3d46 616c  tractography=Fal
+0004aee0: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+0004aef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004af00: 2020 2020 2020 2020 646f 5f6b 6b3d 4661          do_kk=Fa
+0004af10: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
+0004af20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004af30: 2020 2020 2020 2020 2064 6f5f 6e6f 726d           do_norm
+0004af40: 616c 697a 6174 696f 6e3d 7465 6d70 6c61  alization=templa
+0004af50: 7465 5478 2c0a 2020 2020 2020 2020 2020  teTx,.          
+0004af60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004af70: 2020 2020 2020 2020 2020 7465 7374 5f72            test_r
+0004af80: 756e 3d74 6573 745f 7275 6e2c 0a20 2020  un=test_run,.   
+0004af90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004afa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004afb0: 2076 6572 626f 7365 3d54 7275 6520 290a   verbose=True ).
+0004afc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004afd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004afe0: 6966 2074 6162 5072 6f5b 2772 7366 275d  if tabPro['rsf']
+0004aff0: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+0004b000: 2076 6973 7561 6c69 7a65 3a0a 2020 2020   visualize:.    
+0004b010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b030: 6466 6e3d 7461 6250 726f 5b27 7273 6627  dfn=tabPro['rsf'
+0004b040: 5d5b 2764 666e 6e61 6d65 275d 0a20 2020  ]['dfnname'].   
+0004b050: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0004b060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b070: 2020 2020 2020 2020 2020 2020 2061 7869               axi
-0004b080: 733d 322c 206e 736c 6963 6573 3d6d 6178  s=2, nslices=max
-0004b090: 736c 6963 652c 206e 636f 6c3d 372c 2063  slice, ncol=7, c
-0004b0a0: 726f 703d 5472 7565 2c20 7469 746c 653d  rop=True, title=
-0004b0b0: 2744 6566 6175 6c74 4d6f 6465 272c 2066  'DefaultMode', f
-0004b0c0: 696c 656e 616d 653d 6d79 6d6d 2b6d 7973  ilename=mymm+mys
-0004b0d0: 6570 2b22 626f 6c64 4465 6661 756c 744d  ep+"boldDefaultM
-0004b0e0: 6f64 652e 706e 6722 2029 0a20 2020 2020  ode.png" ).     
-0004b0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b100: 2020 2020 2020 2069 6620 2820 6d79 6d6f         if ( mymo
-0004b110: 6420 3d3d 2027 4454 495f 4c52 2720 6f72  d == 'DTI_LR' or
-0004b120: 206d 796d 6f64 203d 3d20 2744 5449 5f52   mymod == 'DTI_R
-0004b130: 4c27 206f 7220 6d79 6d6f 6420 3d3d 2027  L' or mymod == '
-0004b140: 4454 4927 2029 2061 6e64 2069 7368 6170  DTI' ) and ishap
-0004b150: 656c 656e 203d 3d20 343a 0a20 2020 2020  elen == 4:.     
-0004b160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b170: 2020 2020 2020 2020 2020 2064 6f77 7269             dowri
-0004b180: 7465 3d54 7275 650a 2020 2020 2020 2020  te=True.        
+0004b070: 206d 6178 736c 6963 6520 3d20 6e70 2e6d   maxslice = np.m
+0004b080: 696e 2820 5b32 312c 2074 6162 5072 6f5b  in( [21, tabPro[
+0004b090: 2772 7366 275d 5b27 6d65 616e 426f 6c64  'rsf']['meanBold
+0004b0a0: 275d 2e73 6861 7065 5b32 5d20 5d20 290a  '].shape[2] ] ).
+0004b0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b0d0: 2020 2020 616e 7473 2e70 6c6f 7428 2074      ants.plot( t
+0004b0e0: 6162 5072 6f5b 2772 7366 275d 5b27 6d65  abPro['rsf']['me
+0004b0f0: 616e 426f 6c64 275d 2c0a 2020 2020 2020  anBold'],.      
+0004b100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b120: 2020 6178 6973 3d32 2c20 6e73 6c69 6365    axis=2, nslice
+0004b130: 733d 6d61 7873 6c69 6365 2c20 6e63 6f6c  s=maxslice, ncol
+0004b140: 3d37 2c20 6372 6f70 3d54 7275 652c 2074  =7, crop=True, t
+0004b150: 6974 6c65 3d27 6d65 616e 424f 4c44 272c  itle='meanBOLD',
+0004b160: 2066 696c 656e 616d 653d 6d79 6d6d 2b6d   filename=mymm+m
+0004b170: 7973 6570 2b22 6d65 616e 424f 4c44 2e70  ysep+"meanBOLD.p
+0004b180: 6e67 2220 290a 2020 2020 2020 2020 2020  ng" ).          
 0004b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b1a0: 2020 2020 2020 2020 6276 616c 666e 203d          bvalfn =
-0004b1b0: 2072 652e 7375 6228 2027 2e6e 6969 2e67   re.sub( '.nii.g
-0004b1c0: 7a27 2c20 272e 6276 616c 2720 2c20 6d79  z', '.bval' , my
-0004b1d0: 696d 6720 290a 2020 2020 2020 2020 2020  img ).          
-0004b1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b1f0: 2020 2020 2020 6276 6563 666e 203d 2072        bvecfn = r
-0004b200: 652e 7375 6228 2027 2e6e 6969 2e67 7a27  e.sub( '.nii.gz'
-0004b210: 2c20 272e 6276 6563 2720 2c20 6d79 696d  , '.bvec' , myim
-0004b220: 6720 290a 2020 2020 2020 2020 2020 2020  g ).            
-0004b230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b240: 2020 2020 696d 674c 6973 7420 3d20 5b20      imgList = [ 
-0004b250: 696d 6720 5d0a 2020 2020 2020 2020 2020  img ].          
-0004b260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b270: 2020 2020 2020 6276 616c 666e 4c69 7374        bvalfnList
-0004b280: 203d 205b 2062 7661 6c66 6e20 5d0a 2020   = [ bvalfn ].  
+0004b1a0: 2020 2020 2020 2020 2020 616e 7473 2e70            ants.p
+0004b1b0: 6c6f 7428 2074 6162 5072 6f5b 2772 7366  lot( tabPro['rsf
+0004b1c0: 275d 5b27 6d65 616e 426f 6c64 275d 2c20  ']['meanBold'], 
+0004b1d0: 616e 7473 2e69 4d61 7468 2874 6162 5072  ants.iMath(tabPr
+0004b1e0: 6f5b 2772 7366 275d 5b27 616c 6666 275d  o['rsf']['alff']
+0004b1f0: 2c22 4e6f 726d 616c 697a 6522 292c 0a20  ,"Normalize"),. 
+0004b200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b220: 2020 2020 2020 2061 7869 733d 322c 206e         axis=2, n
+0004b230: 736c 6963 6573 3d6d 6178 736c 6963 652c  slices=maxslice,
+0004b240: 206e 636f 6c3d 372c 2063 726f 703d 5472   ncol=7, crop=Tr
+0004b250: 7565 2c20 7469 746c 653d 2741 4c46 4627  ue, title='ALFF'
+0004b260: 2c20 6669 6c65 6e61 6d65 3d6d 796d 6d2b  , filename=mymm+
+0004b270: 6d79 7365 702b 2262 6f6c 6441 4c46 462e  mysep+"boldALFF.
+0004b280: 706e 6722 2029 0a20 2020 2020 2020 2020  png" ).         
 0004b290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b2a0: 2020 2020 2020 2020 2020 2020 2020 6276                bv
-0004b2b0: 6563 666e 4c69 7374 203d 205b 2062 7665  ecfnList = [ bve
-0004b2c0: 6366 6e20 5d0a 2020 2020 2020 2020 2020  cfn ].          
-0004b2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b2e0: 2020 2020 2020 6966 206c 656e 2820 6d79        if len( my
-0004b2f0: 696d 6773 7220 2920 3e20 313a 2020 2320  imgsr ) > 1:  # 
-0004b300: 6669 6e64 2044 5449 5f52 4c0a 2020 2020  find DTI_RL.    
+0004b2a0: 2020 2020 2020 2020 2020 2061 6e74 732e             ants.
+0004b2b0: 706c 6f74 2820 7461 6250 726f 5b27 7273  plot( tabPro['rs
+0004b2c0: 6627 5d5b 276d 6561 6e42 6f6c 6427 5d2c  f']['meanBold'],
+0004b2d0: 2061 6e74 732e 694d 6174 6828 7461 6250   ants.iMath(tabP
+0004b2e0: 726f 5b27 7273 6627 5d5b 2766 616c 6666  ro['rsf']['falff
+0004b2f0: 275d 2c22 4e6f 726d 616c 697a 6522 292c  '],"Normalize"),
+0004b300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0004b310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b330: 6474 696c 7266 6e20 3d20 6d79 696d 6773  dtilrfn = myimgs
-0004b340: 725b 6d79 696d 6763 6f75 6e74 2b31 5d0a  r[myimgcount+1].
-0004b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b370: 2020 2020 6966 206c 656e 2820 6474 696c      if len( dtil
-0004b380: 7266 6e20 2920 3d3d 2031 3a0a 2020 2020  rfn ) == 1:.    
+0004b320: 2020 2020 2020 2020 2061 7869 733d 322c           axis=2,
+0004b330: 206e 736c 6963 6573 3d6d 6178 736c 6963   nslices=maxslic
+0004b340: 652c 206e 636f 6c3d 372c 2063 726f 703d  e, ncol=7, crop=
+0004b350: 5472 7565 2c20 7469 746c 653d 2766 414c  True, title='fAL
+0004b360: 4646 272c 2066 696c 656e 616d 653d 6d79  FF', filename=my
+0004b370: 6d6d 2b6d 7973 6570 2b22 626f 6c64 6641  mm+mysep+"boldfA
+0004b380: 4c46 462e 706e 6722 2029 0a20 2020 2020  LFF.png" ).     
 0004b390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b3b0: 2020 2020 6276 616c 666e 524c 203d 2072      bvalfnRL = r
-0004b3c0: 652e 7375 6228 2027 2e6e 6969 2e67 7a27  e.sub( '.nii.gz'
-0004b3d0: 2c20 272e 6276 616c 2720 2c20 6474 696c  , '.bval' , dtil
-0004b3e0: 7266 6e20 290a 2020 2020 2020 2020 2020  rfn ).          
+0004b3a0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0004b3b0: 6e74 732e 706c 6f74 2820 7461 6250 726f  nts.plot( tabPro
+0004b3c0: 5b27 7273 6627 5d5b 276d 6561 6e42 6f6c  ['rsf']['meanBol
+0004b3d0: 6427 5d2c 2074 6162 5072 6f5b 2772 7366  d'], tabPro['rsf
+0004b3e0: 275d 5b64 666e 5d2c 0a20 2020 2020 2020  '][dfn],.       
 0004b3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b400: 2020 2020 2020 2020 2020 2020 2020 6276                bv
-0004b410: 6563 666e 524c 203d 2072 652e 7375 6228  ecfnRL = re.sub(
-0004b420: 2027 2e6e 6969 2e67 7a27 2c20 272e 6276   '.nii.gz', '.bv
-0004b430: 6563 2720 2c20 6474 696c 7266 6e20 290a  ec' , dtilrfn ).
-0004b440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b460: 2020 2020 2020 2020 696d 6752 4c20 3d20          imgRL = 
-0004b470: 616e 7473 2e69 6d61 6765 5f72 6561 6428  ants.image_read(
-0004b480: 2064 7469 6c72 666e 2029 0a20 2020 2020   dtilrfn ).     
-0004b490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b4b0: 2020 2069 6d67 4c69 7374 2e61 7070 656e     imgList.appen
-0004b4c0: 6428 2069 6d67 524c 2029 0a20 2020 2020  d( imgRL ).     
-0004b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b4f0: 2020 2062 7661 6c66 6e4c 6973 742e 6170     bvalfnList.ap
-0004b500: 7065 6e64 2820 6276 616c 666e 524c 2029  pend( bvalfnRL )
-0004b510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004b400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b410: 2061 7869 733d 322c 206e 736c 6963 6573   axis=2, nslices
+0004b420: 3d6d 6178 736c 6963 652c 206e 636f 6c3d  =maxslice, ncol=
+0004b430: 372c 2063 726f 703d 5472 7565 2c20 7469  7, crop=True, ti
+0004b440: 746c 653d 2744 6566 6175 6c74 4d6f 6465  tle='DefaultMode
+0004b450: 272c 2066 696c 656e 616d 653d 6d79 6d6d  ', filename=mymm
+0004b460: 2b6d 7973 6570 2b22 626f 6c64 4465 6661  +mysep+"boldDefa
+0004b470: 756c 744d 6f64 652e 706e 6722 2029 0a20  ultMode.png" ). 
+0004b480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b490: 2020 2020 2020 2020 2020 2069 6620 2820             if ( 
+0004b4a0: 6d79 6d6f 6420 3d3d 2027 4454 495f 4c52  mymod == 'DTI_LR
+0004b4b0: 2720 6f72 206d 796d 6f64 203d 3d20 2744  ' or mymod == 'D
+0004b4c0: 5449 5f52 4c27 206f 7220 6d79 6d6f 6420  TI_RL' or mymod 
+0004b4d0: 3d3d 2027 4454 4927 2029 2061 6e64 2069  == 'DTI' ) and i
+0004b4e0: 7368 6170 656c 656e 203d 3d20 343a 0a20  shapelen == 4:. 
+0004b4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b500: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0004b510: 6f77 7269 7465 3d54 7275 650a 2020 2020  owrite=True.    
 0004b520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b530: 2020 2020 2020 2020 2062 7665 6366 6e4c           bvecfnL
-0004b540: 6973 742e 6170 7065 6e64 2820 6276 6563  ist.append( bvec
-0004b550: 666e 524c 2029 0a20 2020 2020 2020 2020  fnRL ).         
-0004b560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b570: 2020 2020 2020 2073 726d 6f64 656c 5f44         srmodel_D
-0004b580: 5449 5f6d 646c 3d4e 6f6e 650a 2020 2020  TI_mdl=None.    
-0004b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b5a0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0004b5b0: 726d 6f64 656c 5f44 5449 2069 7320 6e6f  rmodel_DTI is no
-0004b5c0: 7420 4661 6c73 653a 0a20 2020 2020 2020  t False:.       
-0004b5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b5e0: 2020 2020 2020 2020 2020 2020 2074 656d               tem
-0004b5f0: 7020 3d20 616e 7473 2e67 6574 5f73 7061  p = ants.get_spa
-0004b600: 6369 6e67 2869 6d67 290a 2020 2020 2020  cing(img).      
-0004b610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b620: 2020 2020 2020 2020 2020 2020 2020 6474                dt
-0004b630: 7370 633d 5b74 656d 705b 305d 2c74 656d  spc=[temp[0],tem
-0004b640: 705b 315d 2c74 656d 705b 325d 5d0a 2020  p[1],temp[2]].  
-0004b650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b530: 2020 2020 2020 2020 2020 2020 6276 616c              bval
+0004b540: 666e 203d 2072 652e 7375 6228 2027 2e6e  fn = re.sub( '.n
+0004b550: 6969 2e67 7a27 2c20 272e 6276 616c 2720  ii.gz', '.bval' 
+0004b560: 2c20 6d79 696d 6720 290a 2020 2020 2020  , myimg ).      
+0004b570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b580: 2020 2020 2020 2020 2020 6276 6563 666e            bvecfn
+0004b590: 203d 2072 652e 7375 6228 2027 2e6e 6969   = re.sub( '.nii
+0004b5a0: 2e67 7a27 2c20 272e 6276 6563 2720 2c20  .gz', '.bvec' , 
+0004b5b0: 6d79 696d 6720 290a 2020 2020 2020 2020  myimg ).        
+0004b5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b5d0: 2020 2020 2020 2020 696d 674c 6973 7420          imgList 
+0004b5e0: 3d20 5b20 696d 6720 5d0a 2020 2020 2020  = [ img ].      
+0004b5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b600: 2020 2020 2020 2020 2020 6276 616c 666e            bvalfn
+0004b610: 4c69 7374 203d 205b 2062 7661 6c66 6e20  List = [ bvalfn 
+0004b620: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0004b630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b640: 2020 6276 6563 666e 4c69 7374 203d 205b    bvecfnList = [
+0004b650: 2062 7665 6366 6e20 5d0a 2020 2020 2020   bvecfn ].      
 0004b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b670: 2020 6265 7374 7570 203d 2073 6971 2e6f    bestup = siq.o
-0004b680: 7074 696d 697a 655f 7570 7361 6d70 6c69  ptimize_upsampli
-0004b690: 6e67 5f73 6861 7065 2820 6474 7370 632c  ng_shape( dtspc,
-0004b6a0: 206d 6f64 616c 6974 793d 2744 5449 2720   modality='DTI' 
-0004b6b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0004b6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b6d0: 2020 2020 2020 6d64 6c66 6e20 3d20 6578        mdlfn = ex
-0004b6e0: 5f70 6174 686d 6d20 2b20 2273 6971 5f64  _pathmm + "siq_d
-0004b6f0: 6566 6175 6c74 5f73 6973 725f 2220 2b20  efault_sisr_" + 
-0004b700: 6265 7374 7570 202b 2022 5f31 6368 616e  bestup + "_1chan
-0004b710: 5f66 6561 7476 6767 4c36 5f62 6573 745f  _featvggL6_best_
-0004b720: 6d64 6c2e 6835 220a 2020 2020 2020 2020  mdl.h5".        
+0004b670: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+0004b680: 2820 6d79 696d 6773 7220 2920 3e20 313a  ( myimgsr ) > 1:
+0004b690: 2020 2320 6669 6e64 2044 5449 5f52 4c0a    # find DTI_RL.
+0004b6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b6c0: 2020 2020 6474 696c 7266 6e20 3d20 6d79      dtilrfn = my
+0004b6d0: 696d 6773 725b 6d79 696d 6763 6f75 6e74  imgsr[myimgcount
+0004b6e0: 2b31 5d0a 2020 2020 2020 2020 2020 2020  +1].            
+0004b6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b700: 2020 2020 2020 2020 6966 206c 656e 2820          if len( 
+0004b710: 6474 696c 7266 6e20 2920 3d3d 2031 3a0a  dtilrfn ) == 1:.
+0004b720: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0004b730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b740: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0004b750: 7369 6e73 7461 6e63 6528 2073 726d 6f64  sinstance( srmod
-0004b760: 656c 5f44 5449 2c20 7374 7220 293a 0a20  el_DTI, str ):. 
-0004b770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b740: 2020 2020 2020 2020 6276 616c 666e 524c          bvalfnRL
+0004b750: 203d 2072 652e 7375 6228 2027 2e6e 6969   = re.sub( '.nii
+0004b760: 2e67 7a27 2c20 272e 6276 616c 2720 2c20  .gz', '.bval' , 
+0004b770: 6474 696c 7266 6e20 290a 2020 2020 2020  dtilrfn ).      
 0004b780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b790: 2020 2020 2020 2073 726d 6f64 656c 5f44         srmodel_D
-0004b7a0: 5449 203d 2072 652e 7375 6228 2022 6265  TI = re.sub( "be
-0004b7b0: 7374 7570 222c 2062 6573 7475 702c 2073  stup", bestup, s
-0004b7c0: 726d 6f64 656c 5f44 5449 2029 0a20 2020  rmodel_DTI ).   
-0004b7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b7a0: 2020 6276 6563 666e 524c 203d 2072 652e    bvecfnRL = re.
+0004b7b0: 7375 6228 2027 2e6e 6969 2e67 7a27 2c20  sub( '.nii.gz', 
+0004b7c0: 272e 6276 6563 2720 2c20 6474 696c 7266  '.bvec' , dtilrf
+0004b7d0: 6e20 290a 2020 2020 2020 2020 2020 2020  n ).            
 0004b7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b7f0: 2020 2020 206d 646c 666e 203d 206f 732e       mdlfn = os.
-0004b800: 7061 7468 2e6a 6f69 6e28 2065 785f 7061  path.join( ex_pa
-0004b810: 7468 6d6d 2c20 7372 6d6f 6465 6c5f 4454  thmm, srmodel_DT
-0004b820: 4920 290a 2020 2020 2020 2020 2020 2020  I ).            
+0004b7f0: 2020 2020 2020 2020 2020 2020 696d 6752              imgR
+0004b800: 4c20 3d20 616e 7473 2e69 6d61 6765 5f72  L = ants.image_r
+0004b810: 6561 6428 2064 7469 6c72 666e 2029 0a20  ead( dtilrfn ). 
+0004b820: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0004b830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b840: 2020 2020 2020 2020 6966 2065 7869 7374          if exist
-0004b850: 7328 206d 646c 666e 2029 3a0a 2020 2020  s( mdlfn ):.    
+0004b840: 2020 2020 2020 2069 6d67 4c69 7374 2e61         imgList.a
+0004b850: 7070 656e 6428 2069 6d67 524c 2029 0a20  ppend( imgRL ). 
 0004b860: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0004b870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b880: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
-0004b890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b8b0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0004b8c0: 7428 6d64 6c66 6e29 0a20 2020 2020 2020  t(mdlfn).       
-0004b8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b8f0: 2073 726d 6f64 656c 5f44 5449 5f6d 646c   srmodel_DTI_mdl
-0004b900: 203d 2074 662e 6b65 7261 732e 6d6f 6465   = tf.keras.mode
-0004b910: 6c73 2e6c 6f61 645f 6d6f 6465 6c28 206d  ls.load_model( m
-0004b920: 646c 666e 2c20 636f 6d70 696c 653d 4661  dlfn, compile=Fa
-0004b930: 6c73 6520 290a 2020 2020 2020 2020 2020  lse ).          
-0004b940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b950: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0004b880: 2020 2020 2020 2062 7661 6c66 6e4c 6973         bvalfnLis
+0004b890: 742e 6170 7065 6e64 2820 6276 616c 666e  t.append( bvalfn
+0004b8a0: 524c 2029 0a20 2020 2020 2020 2020 2020  RL ).           
+0004b8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b8c0: 2020 2020 2020 2020 2020 2020 2062 7665               bve
+0004b8d0: 6366 6e4c 6973 742e 6170 7065 6e64 2820  cfnList.append( 
+0004b8e0: 6276 6563 666e 524c 2029 0a20 2020 2020  bvecfnRL ).     
+0004b8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b900: 2020 2020 2020 2020 2020 2073 726d 6f64             srmod
+0004b910: 656c 5f44 5449 5f6d 646c 3d4e 6f6e 650a  el_DTI_mdl=None.
+0004b920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b940: 6966 2073 726d 6f64 656c 5f44 5449 2069  if srmodel_DTI i
+0004b950: 7320 6e6f 7420 4661 6c73 653a 0a20 2020  s not False:.   
 0004b960: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0004b970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b980: 2020 2020 2020 2020 7072 696e 7428 6d64          print(md
-0004b990: 6c66 6e20 2b20 2220 646f 6573 206e 6f74  lfn + " does not
-0004b9a0: 2065 7869 7374 202d 2077 6f6e 7420 7573   exist - wont us
-0004b9b0: 6520 5352 2229 0a20 2020 2020 2020 2020  e SR").         
-0004b9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b9d0: 2020 2020 2020 2074 6162 5072 6f2c 206e         tabPro, n
-0004b9e0: 6f72 6d50 726f 203d 206d 6d28 2074 312c  ormPro = mm( t1,
-0004b9f0: 2068 6965 722c 0a20 2020 2020 2020 2020   hier,.         
-0004ba00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ba10: 2020 2020 2020 2020 2020 2064 775f 696d             dw_im
-0004ba20: 6167 653d 696d 674c 6973 742c 0a20 2020  age=imgList,.   
-0004ba30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ba40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ba50: 2062 7661 6c73 203d 2062 7661 6c66 6e4c   bvals = bvalfnL
-0004ba60: 6973 742c 0a20 2020 2020 2020 2020 2020  ist,.           
-0004ba70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ba80: 2020 2020 2020 2020 2062 7665 6373 203d           bvecs =
-0004ba90: 2062 7665 6366 6e4c 6973 742c 0a20 2020   bvecfnList,.   
-0004baa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bac0: 2073 726d 6f64 656c 3d73 726d 6f64 656c   srmodel=srmodel
-0004bad0: 5f44 5449 5f6d 646c 2c0a 2020 2020 2020  _DTI_mdl,.      
-0004bae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004baf0: 2020 2020 2020 2020 2020 2020 2020 646f                do
-0004bb00: 5f74 7261 6374 6f67 7261 7068 793d 6e6f  _tractography=no
-0004bb10: 7420 7465 7374 5f72 756e 2c0a 2020 2020  t test_run,.    
-0004bb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bb40: 646f 5f6b 6b3d 4661 6c73 652c 0a20 2020  do_kk=False,.   
-0004bb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bb70: 2064 6f5f 6e6f 726d 616c 697a 6174 696f   do_normalizatio
-0004bb80: 6e3d 7465 6d70 6c61 7465 5478 2c0a 2020  n=templateTx,.  
-0004bb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bbb0: 2020 7465 7374 5f72 756e 3d74 6573 745f    test_run=test_
-0004bbc0: 7275 6e2c 0a20 2020 2020 2020 2020 2020  run,.           
-0004bbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bbe0: 2020 2020 2020 2020 2076 6572 626f 7365           verbose
-0004bbf0: 3d54 7275 6520 290a 2020 2020 2020 2020  =True ).        
+0004b980: 2074 656d 7020 3d20 616e 7473 2e67 6574   temp = ants.get
+0004b990: 5f73 7061 6369 6e67 2869 6d67 290a 2020  _spacing(img).  
+0004b9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b9c0: 2020 6474 7370 633d 5b74 656d 705b 305d    dtspc=[temp[0]
+0004b9d0: 2c74 656d 705b 315d 2c74 656d 705b 325d  ,temp[1],temp[2]
+0004b9e0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0004b9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ba00: 2020 2020 2020 6265 7374 7570 203d 2073        bestup = s
+0004ba10: 6971 2e6f 7074 696d 697a 655f 7570 7361  iq.optimize_upsa
+0004ba20: 6d70 6c69 6e67 5f73 6861 7065 2820 6474  mpling_shape( dt
+0004ba30: 7370 632c 206d 6f64 616c 6974 793d 2744  spc, modality='D
+0004ba40: 5449 2720 290a 2020 2020 2020 2020 2020  TI' ).          
+0004ba50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ba60: 2020 2020 2020 2020 2020 6d64 6c66 6e20            mdlfn 
+0004ba70: 3d20 6578 5f70 6174 686d 6d20 2b20 2273  = ex_pathmm + "s
+0004ba80: 6971 5f64 6566 6175 6c74 5f73 6973 725f  iq_default_sisr_
+0004ba90: 2220 2b20 6265 7374 7570 202b 2022 5f31  " + bestup + "_1
+0004baa0: 6368 616e 5f66 6561 7476 6767 4c36 5f62  chan_featvggL6_b
+0004bab0: 6573 745f 6d64 6c2e 6835 220a 2020 2020  est_mdl.h5".    
+0004bac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bae0: 6966 2069 7369 6e73 7461 6e63 6528 2073  if isinstance( s
+0004baf0: 726d 6f64 656c 5f44 5449 2c20 7374 7220  rmodel_DTI, str 
+0004bb00: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0004bb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bb20: 2020 2020 2020 2020 2020 2073 726d 6f64             srmod
+0004bb30: 656c 5f44 5449 203d 2072 652e 7375 6228  el_DTI = re.sub(
+0004bb40: 2022 6265 7374 7570 222c 2062 6573 7475   "bestup", bestu
+0004bb50: 702c 2073 726d 6f64 656c 5f44 5449 2029  p, srmodel_DTI )
+0004bb60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004bb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bb80: 2020 2020 2020 2020 206d 646c 666e 203d           mdlfn =
+0004bb90: 206f 732e 7061 7468 2e6a 6f69 6e28 2065   os.path.join( e
+0004bba0: 785f 7061 7468 6d6d 2c20 7372 6d6f 6465  x_pathmm, srmode
+0004bbb0: 6c5f 4454 4920 290a 2020 2020 2020 2020  l_DTI ).        
+0004bbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bbd0: 2020 2020 2020 2020 2020 2020 6966 2065              if e
+0004bbe0: 7869 7374 7328 206d 646c 666e 2029 3a0a  xists( mdlfn ):.
+0004bbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0004bc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bc10: 2020 2020 2020 2020 6d79 6474 6920 3d20          mydti = 
-0004bc20: 7461 6250 726f 5b27 4454 4927 5d0a 2020  tabPro['DTI'].  
+0004bc10: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+0004bc20: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
 0004bc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bc40: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0004bc50: 2076 6973 7561 6c69 7a65 3a0a 2020 2020   visualize:.    
+0004bc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bc50: 7072 696e 7428 6d64 6c66 6e29 0a20 2020  print(mdlfn).   
 0004bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0004bc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bc80: 6d61 7873 6c69 6365 203d 206e 702e 6d69  maxslice = np.mi
-0004bc90: 6e28 205b 3231 2c20 6d79 6474 695b 2772  n( [21, mydti['r
-0004bca0: 6563 6f6e 5f66 6127 5d20 5d20 290a 2020  econ_fa'] ] ).  
-0004bcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bcd0: 2020 616e 7473 2e70 6c6f 7428 206d 7964    ants.plot( myd
-0004bce0: 7469 5b27 7265 636f 6e5f 6661 275d 2c20  ti['recon_fa'], 
-0004bcf0: 2061 7869 733d 322c 206e 736c 6963 6573   axis=2, nslices
-0004bd00: 3d6d 6178 736c 6963 652c 206e 636f 6c3d  =maxslice, ncol=
-0004bd10: 372c 2063 726f 703d 5472 7565 2c20 7469  7, crop=True, ti
-0004bd20: 746c 653d 2746 4127 2c20 6669 6c65 6e61  tle='FA', filena
-0004bd30: 6d65 3d6d 796d 6d2b 6d79 7365 702b 2246  me=mymm+mysep+"F
-0004bd40: 4162 6574 7465 722e 706e 6722 2020 290a  Abetter.png"  ).
+0004bc80: 2020 2020 2073 726d 6f64 656c 5f44 5449       srmodel_DTI
+0004bc90: 5f6d 646c 203d 2074 662e 6b65 7261 732e  _mdl = tf.keras.
+0004bca0: 6d6f 6465 6c73 2e6c 6f61 645f 6d6f 6465  models.load_mode
+0004bcb0: 6c28 206d 646c 666e 2c20 636f 6d70 696c  l( mdlfn, compil
+0004bcc0: 653d 4661 6c73 6520 290a 2020 2020 2020  e=False ).      
+0004bcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bce0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0004bcf0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0004bd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bd10: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0004bd20: 7428 6d64 6c66 6e20 2b20 2220 646f 6573  t(mdlfn + " does
+0004bd30: 206e 6f74 2065 7869 7374 202d 2077 6f6e   not exist - won
+0004bd40: 7420 7573 6520 5352 2229 0a20 2020 2020  t use SR").     
 0004bd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bd70: 2020 2020 616e 7473 2e70 6c6f 7428 206d      ants.plot( m
-0004bd80: 7964 7469 5b27 7265 636f 6e5f 6661 275d  ydti['recon_fa']
-0004bd90: 2c20 6d79 6474 695b 276a 6875 5f6c 6162  , mydti['jhu_lab
-0004bda0: 656c 7327 5d2c 2061 7869 733d 322c 206e  els'], axis=2, n
-0004bdb0: 736c 6963 6573 3d6d 6178 736c 6963 652c  slices=maxslice,
-0004bdc0: 206e 636f 6c3d 372c 2063 726f 703d 5472   ncol=7, crop=Tr
-0004bdd0: 7565 2c20 7469 746c 653d 2746 4120 2b20  ue, title='FA + 
-0004bde0: 4a48 5527 2c20 6669 6c65 6e61 6d65 3d6d  JHU', filename=m
-0004bdf0: 796d 6d2b 6d79 7365 702b 2246 414a 4855  ymm+mysep+"FAJHU
-0004be00: 2e70 6e67 2220 2029 0a20 2020 2020 2020  .png"  ).       
-0004be10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004be20: 2020 2020 2020 2020 2020 2020 2061 6e74               ant
-0004be30: 732e 706c 6f74 2820 6d79 6474 695b 2772  s.plot( mydti['r
-0004be40: 6563 6f6e 5f6d 6427 5d2c 2020 6178 6973  econ_md'],  axis
-0004be50: 3d32 2c20 6e73 6c69 6365 733d 6d61 7873  =2, nslices=maxs
-0004be60: 6c69 6365 2c20 6e63 6f6c 3d37 2c20 6372  lice, ncol=7, cr
-0004be70: 6f70 3d54 7275 652c 2074 6974 6c65 3d27  op=True, title='
-0004be80: 4d44 272c 2066 696c 656e 616d 653d 6d79  MD', filename=my
-0004be90: 6d6d 2b6d 7973 6570 2b22 4d44 2e70 6e67  mm+mysep+"MD.png
-0004bea0: 2220 2029 0a20 2020 2020 2020 2020 2020  "  ).           
+0004bd60: 2020 2020 2020 2020 2020 2074 6162 5072             tabPr
+0004bd70: 6f2c 206e 6f72 6d50 726f 203d 206d 6d28  o, normPro = mm(
+0004bd80: 2074 312c 2068 6965 722c 0a20 2020 2020   t1, hier,.     
+0004bd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bda0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0004bdb0: 775f 696d 6167 653d 696d 674c 6973 742c  w_image=imgList,
+0004bdc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004bdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bde0: 2020 2020 2062 7661 6c73 203d 2062 7661       bvals = bva
+0004bdf0: 6c66 6e4c 6973 742c 0a20 2020 2020 2020  lfnList,.       
+0004be00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004be10: 2020 2020 2020 2020 2020 2020 2062 7665               bve
+0004be20: 6373 203d 2062 7665 6366 6e4c 6973 742c  cs = bvecfnList,
+0004be30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004be40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004be50: 2020 2020 2073 726d 6f64 656c 3d73 726d       srmodel=srm
+0004be60: 6f64 656c 5f44 5449 5f6d 646c 2c0a 2020  odel_DTI_mdl,.  
+0004be70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004be80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004be90: 2020 646f 5f74 7261 6374 6f67 7261 7068    do_tractograph
+0004bea0: 793d 6e6f 7420 7465 7374 5f72 756e 2c0a  y=not test_run,.
 0004beb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bec0: 2069 6620 646f 7772 6974 653a 0a20 2020   if dowrite:.   
-0004bed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bee0: 2020 2020 2020 2020 2020 2020 2077 7269               wri
-0004bef0: 7465 5f6d 6d28 206f 7574 7075 745f 7072  te_mm( output_pr
-0004bf00: 6566 6978 3d6d 796d 6d2c 206d 6d3d 7461  efix=mymm, mm=ta
-0004bf10: 6250 726f 2c20 6d6d 5f6e 6f72 6d3d 6e6f  bPro, mm_norm=no
-0004bf20: 726d 5072 6f2c 2074 3177 6964 653d 7431  rmPro, t1wide=t1
-0004bf30: 7769 6465 2c20 7365 7061 7261 746f 723d  wide, separator=
-0004bf40: 6d79 7365 702c 2076 6572 626f 7365 3d54  mysep, verbose=T
-0004bf50: 7275 6520 290a 2020 2020 2020 2020 2020  rue ).          
+0004bec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bed0: 2020 2020 646f 5f6b 6b3d 4661 6c73 652c      do_kk=False,
+0004bee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004bef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bf00: 2020 2020 2064 6f5f 6e6f 726d 616c 697a       do_normaliz
+0004bf10: 6174 696f 6e3d 7465 6d70 6c61 7465 5478  ation=templateTx
+0004bf20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0004bf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bf40: 2020 2020 2020 7465 7374 5f72 756e 3d74        test_run=t
+0004bf50: 6573 745f 7275 6e2c 0a20 2020 2020 2020  est_run,.       
 0004bf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bf70: 2020 2020 2020 666f 7220 6d79 6b65 7920        for mykey 
-0004bf80: 696e 206e 6f72 6d50 726f 2e6b 6579 7328  in normPro.keys(
-0004bf90: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0004bfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bfb0: 2020 2020 2020 2069 6620 6e6f 726d 5072         if normPr
-0004bfc0: 6f5b 6d79 6b65 795d 2069 7320 6e6f 7420  o[mykey] is not 
-0004bfd0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0004bfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bff0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0004c000: 2076 6973 7561 6c69 7a65 2061 6e64 206e   visualize and n
-0004c010: 6f72 6d50 726f 5b6d 796b 6579 5d2e 636f  ormPro[mykey].co
-0004c020: 6d70 6f6e 656e 7473 203d 3d20 3120 616e  mponents == 1 an
-0004c030: 6420 4661 6c73 653a 0a20 2020 2020 2020  d False:.       
-0004c040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bf70: 2020 2020 2020 2020 2020 2020 2076 6572               ver
+0004bf80: 626f 7365 3d54 7275 6520 290a 2020 2020  bose=True ).    
+0004bf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bfa0: 2020 2020 2020 2020 2020 2020 6d79 6474              mydt
+0004bfb0: 6920 3d20 7461 6250 726f 5b27 4454 4927  i = tabPro['DTI'
+0004bfc0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0004bfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bfe0: 2020 6966 2076 6973 7561 6c69 7a65 3a0a    if visualize:.
+0004bff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c010: 2020 2020 6d61 7873 6c69 6365 203d 206e      maxslice = n
+0004c020: 702e 6d69 6e28 205b 3231 2c20 6d79 6474  p.min( [21, mydt
+0004c030: 695b 2772 6563 6f6e 5f66 6127 5d20 5d20  i['recon_fa'] ] 
+0004c040: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
 0004c050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c060: 2020 2020 2061 6e74 732e 706c 6f74 2820       ants.plot( 
-0004c070: 7465 6d70 6c61 7465 2c20 6e6f 726d 5072  template, normPr
-0004c080: 6f5b 6d79 6b65 795d 2c20 6178 6973 3d32  o[mykey], axis=2
-0004c090: 2c20 6e73 6c69 6365 733d 3231 2c20 6e63  , nslices=21, nc
-0004c0a0: 6f6c 3d37 2c20 6372 6f70 3d54 7275 652c  ol=7, crop=True,
-0004c0b0: 2074 6974 6c65 3d6d 796b 6579 2c20 6669   title=mykey, fi
+0004c060: 2020 2020 2020 616e 7473 2e70 6c6f 7428        ants.plot(
+0004c070: 206d 7964 7469 5b27 7265 636f 6e5f 6661   mydti['recon_fa
+0004c080: 275d 2c20 2061 7869 733d 322c 206e 736c  '],  axis=2, nsl
+0004c090: 6963 6573 3d6d 6178 736c 6963 652c 206e  ices=maxslice, n
+0004c0a0: 636f 6c3d 372c 2063 726f 703d 5472 7565  col=7, crop=True
+0004c0b0: 2c20 7469 746c 653d 2746 4127 2c20 6669  , title='FA', fi
 0004c0c0: 6c65 6e61 6d65 3d6d 796d 6d2b 6d79 7365  lename=mymm+myse
-0004c0d0: 702b 6d79 6b65 792b 222e 706e 6722 2020  p+mykey+".png"  
-0004c0e0: 2029 0a20 2020 2020 2020 2069 6620 6f76   ).        if ov
-0004c0f0: 6572 6d6f 6458 203d 3d20 6e72 675f 6d6f  ermodX == nrg_mo
-0004c100: 6461 6c69 7479 5f6c 6973 745b 206c 656e  dality_list[ len
-0004c110: 2820 6e72 675f 6d6f 6461 6c69 7479 5f6c  ( nrg_modality_l
-0004c120: 6973 7420 2920 2d20 3120 5d3a 0a20 2020  ist ) - 1 ]:.   
-0004c130: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-0004c140: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-0004c150: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0004c160: 7072 696e 7428 2264 6f6e 6520 7769 7468  print("done with
-0004c170: 2022 202b 206f 7665 726d 6f64 5820 290a   " + overmodX ).
-0004c180: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
-0004c190: 2020 2020 2020 2020 7072 696e 7428 226d          print("m
-0004c1a0: 6d5f 6e72 6720 636f 6d70 6c65 7465 2e22  m_nrg complete."
-0004c1b0: 290a 2020 2020 7265 7475 726e 0a0a 0a0a  ).    return....
-0004c1c0: 6465 6620 6d6d 5f63 7376 280a 2020 2020  def mm_csv(.    
-0004c1d0: 7374 7564 7963 7376 2c20 2020 2320 7061  studycsv,   # pa
-0004c1e0: 6e64 6173 2064 6174 6120 6672 616d 650a  ndas data frame.
-0004c1f0: 2020 2020 6d79 7365 7020 3d20 272d 272c      mysep = '-',
-0004c200: 2023 206f 7220 225f 2220 666f 7220 4249   # or "_" for BI
-0004c210: 4453 0a20 2020 2073 726d 6f64 656c 5f54  DS.    srmodel_T
-0004c220: 3120 3d20 4661 6c73 652c 2023 206f 7074  1 = False, # opt
-0004c230: 696f 6e61 6c20 2d20 7769 6c6c 2061 6464  ional - will add
-0004c240: 2061 2067 7265 6174 2064 6561 6c20 6f66   a great deal of
-0004c250: 2074 696d 650a 2020 2020 7372 6d6f 6465   time.    srmode
-0004c260: 6c5f 4e4d 203d 2046 616c 7365 2c20 2320  l_NM = False, # 
-0004c270: 6f70 7469 6f6e 616c 202d 2077 696c 6c20  optional - will 
-0004c280: 6164 6420 6120 6772 6561 7420 6465 616c  add a great deal
-0004c290: 206f 6620 7469 6d65 0a20 2020 2073 726d   of time.    srm
-0004c2a0: 6f64 656c 5f44 5449 203d 2046 616c 7365  odel_DTI = False
-0004c2b0: 2c20 2320 6f70 7469 6f6e 616c 202d 2077  , # optional - w
-0004c2c0: 696c 6c20 6164 6420 6120 6772 6561 7420  ill add a great 
-0004c2d0: 6465 616c 206f 6620 7469 6d65 0a20 2020  deal of time.   
-0004c2e0: 2064 7469 5f6d 6f74 696f 6e5f 636f 7272   dti_motion_corr
-0004c2f0: 6563 7420 3d20 2753 794e 272c 0a20 2020  ect = 'SyN',.   
-0004c300: 2064 7469 5f64 656e 6f69 7365 203d 2054   dti_denoise = T
-0004c310: 7275 652c 0a20 2020 206e 7267 5f6d 6f64  rue,.    nrg_mod
-0004c320: 616c 6974 795f 6c69 7374 203d 204e 6f6e  ality_list = Non
-0004c330: 652c 0a20 2020 206e 6f72 6d61 6c69 7a61  e,.    normaliza
-0004c340: 7469 6f6e 5f74 656d 706c 6174 6520 3d20  tion_template = 
-0004c350: 4e6f 6e65 2c0a 2020 2020 6e6f 726d 616c  None,.    normal
-0004c360: 697a 6174 696f 6e5f 7465 6d70 6c61 7465  ization_template
-0004c370: 5f6f 7574 7075 7420 3d20 4e6f 6e65 2c0a  _output = None,.
-0004c380: 2020 2020 6e6f 726d 616c 697a 6174 696f      normalizatio
-0004c390: 6e5f 7465 6d70 6c61 7465 5f74 7261 6e73  n_template_trans
-0004c3a0: 666f 726d 5f74 7970 6520 3d20 2261 6e74  form_type = "ant
-0004c3b0: 7352 6567 6973 7472 6174 696f 6e53 794e  sRegistrationSyN
-0004c3c0: 5265 7072 6f5b 735d 222c 0a20 2020 206e  Repro[s]",.    n
-0004c3d0: 6f72 6d61 6c69 7a61 7469 6f6e 5f74 656d  ormalization_tem
-0004c3e0: 706c 6174 655f 7370 6163 696e 673d 4e6f  plate_spacing=No
-0004c3f0: 6e65 2c0a 2020 2020 656e 616e 7469 6f6d  ne,.    enantiom
-0004c400: 6f72 7068 6963 3d46 616c 7365 2c0a 2020  orphic=False,.  
-0004c410: 2020 7065 7266 7573 696f 6e5f 7472 696d    perfusion_trim
-0004c420: 203d 2031 302c 0a20 2020 2070 6572 6675   = 10,.    perfu
-0004c430: 7369 6f6e 5f6d 305f 696d 6167 6520 3d20  sion_m0_image = 
-0004c440: 4e6f 6e65 2c0a 2020 2020 7065 7266 7573  None,.    perfus
-0004c450: 696f 6e5f 6d30 203d 204e 6f6e 652c 0a20  ion_m0 = None,. 
-0004c460: 2020 2072 7366 5f75 7073 616d 706c 696e     rsf_upsamplin
-0004c470: 6720 3d20 332e 300a 293a 0a20 2020 2022  g = 3.0.):.    "
-0004c480: 2222 0a20 2020 2074 6f6f 2064 616e 6765  "".    too dange
-0004c490: 726f 7573 2074 6f20 646f 6375 6d65 6e74  rous to document
-0004c4a0: 202e 2e2e 2075 7365 2077 6974 6820 6361   ... use with ca
-0004c4b0: 7265 2e0a 0a20 2020 2070 726f 6365 7373  re...    process
-0004c4c0: 6573 206d 756c 7469 706c 6520 6d6f 6461  es multiple moda
-0004c4d0: 6c69 7479 204d 5249 2073 7065 6369 6669  lity MRI specifi
-0004c4e0: 6361 6c6c 793a 0a0a 2020 2020 2a20 5431  cally:..    * T1
-0004c4f0: 770a 2020 2020 2a20 5432 466c 6169 720a  w.    * T2Flair.
-0004c500: 2020 2020 2a20 4454 492c 2044 5449 5f4c      * DTI, DTI_L
-0004c510: 522c 2044 5449 5f52 4c0a 2020 2020 2a20  R, DTI_RL.    * 
-0004c520: 7273 664d 5249 2c20 7273 664d 5249 5f4c  rsfMRI, rsfMRI_L
-0004c530: 522c 2072 7366 4d52 495f 524c 0a20 2020  R, rsfMRI_RL.   
-0004c540: 202a 204e 4d32 444d 5420 286e 6575 726f   * NM2DMT (neuro
-0004c550: 6d65 6c61 6e69 6e29 0a0a 2020 2020 6f74  melanin)..    ot
-0004c560: 6865 7220 6d6f 6461 6c69 7469 6573 206d  her modalities m
-0004c570: 6179 2062 6520 6164 6465 6420 6c61 7465  ay be added late
-0004c580: 7220 2e2e 2e0a 0a20 2020 2022 7472 7573  r .....    "trus
-0004c590: 7420 6d65 2c20 6920 6b6e 6f77 2077 6861  t me, i know wha
-0004c5a0: 7420 6927 6d20 646f 696e 6722 202d 2073  t i'm doing" - s
-0004c5b0: 6c65 6467 6568 616d 6d65 720a 0a20 2020  ledgehammer..   
-0004c5c0: 2063 6f6e 7665 7274 2074 6f20 7079 6e62   convert to pynb
-0004c5d0: 2076 6961 3a0a 2020 2020 2020 2020 7032   via:.        p2
-0004c5e0: 6a20 6d6d 2e70 7920 2d6f 0a0a 2020 2020  j mm.py -o..    
-0004c5f0: 636f 6e76 6572 7420 7468 6520 6970 796e  convert the ipyn
-0004c600: 6220 746f 2068 746d 6c20 7669 613a 0a20  b to html via:. 
-0004c610: 2020 2020 2020 206a 7570 7974 6572 206e         jupyter n
-0004c620: 6263 6f6e 7665 7274 2041 4e54 7350 794d  bconvert ANTsPyM
-0004c630: 4d2f 7465 7374 732f 6d6d 2e69 7079 6e62  M/tests/mm.ipynb
-0004c640: 202d 2d65 7865 6375 7465 202d 2d74 6f20   --execute --to 
-0004c650: 6874 6d6c 0a0a 2020 2020 7468 6973 2066  html..    this f
-0004c660: 756e 6374 696f 6e20 646f 6573 206e 6f74  unction does not
-0004c670: 2061 7373 756d 6520 4e52 4720 666f 726d   assume NRG form
-0004c680: 6174 2066 6f72 2074 6865 2069 6e70 7574  at for the input
-0004c690: 2064 6174 6120 2e2e 2e2e 0a0a 2020 2020   data ......    
-0004c6a0: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-0004c6b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a0a 2020  ------------..  
-0004c6c0: 2020 7374 7564 7963 7376 203a 206d 7573    studycsv : mus
-0004c6d0: 7420 6861 7665 2063 6f6c 756d 6e73 3a0a  t have columns:.
-0004c6e0: 2020 2020 2020 2020 2d20 7375 626a 6563          - subjec
-0004c6f0: 7449 440a 2020 2020 2020 2020 2d20 6461  tID.        - da
-0004c700: 7465 206f 7220 7365 7373 696f 6e0a 2020  te or session.  
-0004c710: 2020 2020 2020 2d20 696d 6167 6549 440a        - imageID.
-0004c720: 2020 2020 2020 2020 2d20 6d6f 6461 6c69          - modali
-0004c730: 7479 0a20 2020 2020 2020 202d 2073 6f75  ty.        - sou
-0004c740: 7263 6564 6972 0a20 2020 2020 2020 202d  rcedir.        -
-0004c750: 206f 7574 7075 7464 6972 0a20 2020 2020   outputdir.     
-0004c760: 2020 202d 2066 696c 656e 616d 6520 2870     - filename (p
-0004c770: 6174 6820 746f 2074 6865 2074 3120 696d  ath to the t1 im
-0004c780: 6167 6529 0a20 2020 2020 2020 206f 7468  age).        oth
-0004c790: 6572 2072 656c 6576 616e 7420 636f 6c75  er relevant colu
-0004c7a0: 6d6e 7320 696e 636c 7564 6520 6e6d 6964  mns include nmid
-0004c7b0: 312d 3130 2c20 7273 6669 6431 2c20 7273  1-10, rsfid1, rs
-0004c7c0: 6669 6432 2c20 6474 6964 312c 2064 7469  fid2, dtid1, dti
-0004c7d0: 6432 2c20 666c 6169 7269 643b 0a20 2020  d2, flairid;.   
-0004c7e0: 2020 2020 2074 6865 7365 2070 726f 7669       these provi
-0004c7f0: 6465 2066 696c 656e 616d 6573 2066 6f72  de filenames for
-0004c800: 2074 6865 7365 206d 6f64 616c 6974 6965   these modalitie
-0004c810: 733a 206e 6d3d 6e65 7572 6f6d 656c 616e  s: nm=neuromelan
-0004c820: 696e 2c20 6474 693d 6469 6666 7573 696f  in, dti=diffusio
-0004c830: 6e20 7465 6e73 6f72 2c0a 2020 2020 2020  n tensor,.      
-0004c840: 2020 7273 663d 7265 7374 696e 6720 7374    rsf=resting st
-0004c850: 6174 6520 666d 7269 2c20 666c 6169 723d  ate fmri, flair=
-0004c860: 5432 466c 6169 722e 2020 6e6f 6e65 206f  T2Flair.  none o
-0004c870: 6620 7468 6573 6520 6172 6520 7265 7175  f these are requ
-0004c880: 6972 6564 2e20 6f6e 6c79 0a20 2020 2020  ired. only.     
-0004c890: 2020 2074 3120 6973 2072 6571 7569 7265     t1 is require
-0004c8a0: 642e 2072 7366 6964 312f 7273 6669 6432  d. rsfid1/rsfid2
-0004c8b0: 2077 696c 6c20 6265 2070 726f 6365 7373   will be process
-0004c8c0: 6564 206a 6f69 6e74 6c79 2e20 7361 6d65  ed jointly. same
-0004c8d0: 2066 6f72 2064 7469 6431 2f64 7469 6432   for dtid1/dtid2
-0004c8e0: 2061 6e64 206e 6d69 642a 2e0a 2020 2020   and nmid*..    
-0004c8f0: 2020 2020 7365 6520 616e 7473 7079 6d6d      see antspymm
-0004c900: 2e67 656e 6572 6174 655f 6d6d 5f64 6174  .generate_mm_dat
-0004c910: 6166 7261 6d65 0a0a 2020 2020 736f 7572  aframe..    sour
-0004c920: 6365 6469 7220 3a20 6120 7374 7564 7920  cedir : a study 
-0004c930: 7370 6563 6966 6963 2066 6f6c 6465 7220  specific folder 
-0004c940: 636f 6e74 6169 6e69 6e67 2069 6e64 6976  containing indiv
-0004c950: 6964 7561 6c20 7375 626a 6563 7420 666f  idual subject fo
-0004c960: 6c64 6572 730a 0a20 2020 206f 7574 7075  lders..    outpu
-0004c970: 7464 6972 203a 2061 2073 7475 6479 2073  tdir : a study s
-0004c980: 7065 6369 6669 6320 666f 6c64 6572 2077  pecific folder w
-0004c990: 6865 7265 2069 6e64 6976 6964 7561 6c20  here individual 
-0004c9a0: 6f75 7470 7574 2073 7562 6a65 6374 2066  output subject f
-0004c9b0: 6f6c 6465 7273 2077 696c 6c20 676f 0a0a  olders will go..
-0004c9c0: 2020 2020 6669 6c65 6e61 6d65 203a 2074      filename : t
-0004c9d0: 6865 2072 6177 2069 6d61 6765 2066 696c  he raw image fil
-0004c9e0: 656e 616d 6520 2866 756c 6c20 7061 7468  ename (full path
-0004c9f0: 290a 0a20 2020 2073 726d 6f64 656c 5f54  )..    srmodel_T
-0004ca00: 3120 3a20 4661 6c73 6520 2864 6566 6175  1 : False (defau
-0004ca10: 6c74 2920 2d20 7769 6c6c 2061 6464 2061  lt) - will add a
-0004ca20: 2067 7265 6174 2064 6561 6c20 6f66 2074   great deal of t
-0004ca30: 696d 6520 2d20 6f72 2068 3520 6669 6c65  ime - or h5 file
-0004ca40: 6e61 6d65 2c20 3220 6368 616e 0a0a 2020  name, 2 chan..  
-0004ca50: 2020 7372 6d6f 6465 6c5f 4e4d 203a 2046    srmodel_NM : F
-0004ca60: 616c 7365 2028 6465 6661 756c 7429 202d  alse (default) -
-0004ca70: 2077 696c 6c20 6164 6420 6120 6772 6561   will add a grea
-0004ca80: 7420 6465 616c 206f 6620 7469 6d65 202d  t deal of time -
-0004ca90: 206f 7220 6835 2066 696c 656e 616d 652c   or h5 filename,
-0004caa0: 2031 2063 6861 6e0a 0a20 2020 2073 726d   1 chan..    srm
-0004cab0: 6f64 656c 5f44 5449 203a 2046 616c 7365  odel_DTI : False
-0004cac0: 2028 6465 6661 756c 7429 202d 2077 696c   (default) - wil
-0004cad0: 6c20 6164 6420 6120 6772 6561 7420 6465  l add a great de
-0004cae0: 616c 206f 6620 7469 6d65 202d 206f 7220  al of time - or 
-0004caf0: 6835 2066 696c 656e 616d 652c 2031 2063  h5 filename, 1 c
-0004cb00: 6861 6e0a 0a20 2020 2064 7469 5f6d 6f74  han..    dti_mot
-0004cb10: 696f 6e5f 636f 7272 6563 7420 3a20 4e6f  ion_correct : No
-0004cb20: 6e65 2c20 5269 6769 6420 6f72 2053 794e  ne, Rigid or SyN
-0004cb30: 0a0a 2020 2020 6474 695f 6465 6e6f 6973  ..    dti_denois
-0004cb40: 6520 3a20 626f 6f6c 6561 6e0a 0a20 2020  e : boolean..   
-0004cb50: 206e 7267 5f6d 6f64 616c 6974 795f 6c69   nrg_modality_li
-0004cb60: 7374 203a 206f 7074 696f 6e61 6c3b 2064  st : optional; d
-0004cb70: 6566 6175 6c74 7320 746f 204e 6f6e 653b  efaults to None;
-0004cb80: 2075 7365 2074 6f20 666f 6375 7320 6f6e   use to focus on
-0004cb90: 2061 2067 6976 656e 206d 6f64 616c 6974   a given modalit
-0004cba0: 790a 0a20 2020 206e 6f72 6d61 6c69 7a61  y..    normaliza
-0004cbb0: 7469 6f6e 5f74 656d 706c 6174 6520 3a20  tion_template : 
-0004cbc0: 6f70 7469 6f6e 616c 3b20 6465 6661 756c  optional; defaul
-0004cbd0: 7473 2074 6f20 4e6f 6e65 3b20 6966 2070  ts to None; if p
-0004cbe0: 7265 7365 6e74 2c20 616c 6c20 696d 6167  resent, all imag
-0004cbf0: 6573 2077 696c 6c0a 2020 2020 2020 2020  es will.        
-0004cc00: 6265 2064 6566 6f72 6d65 6420 696e 746f  be deformed into
-0004cc10: 2074 6869 7320 7370 6163 6520 616e 6420   this space and 
-0004cc20: 7468 6520 6465 666f 726d 6174 696f 6e20  the deformation 
-0004cc30: 7769 6c6c 2062 6520 7374 6f72 6564 2077  will be stored w
-0004cc40: 6974 6820 616e 2065 7874 656e 7369 6f6e  ith an extension
-0004cc50: 0a20 2020 2020 2020 2072 656c 6174 6564  .        related
-0004cc60: 2074 6f20 7468 6973 2076 6172 6961 626c   to this variabl
-0004cc70: 652e 2020 7468 6973 2073 686f 756c 6420  e.  this should 
-0004cc80: 6265 2061 2062 7261 696e 2065 7874 7261  be a brain extra
-0004cc90: 6374 6564 2054 3177 2069 6d61 6765 2e0a  cted T1w image..
-0004cca0: 0a20 2020 206e 6f72 6d61 6c69 7a61 7469  .    normalizati
-0004ccb0: 6f6e 5f74 656d 706c 6174 655f 6f75 7470  on_template_outp
-0004ccc0: 7574 203a 206f 7074 696f 6e61 6c20 7374  ut : optional st
-0004ccd0: 7269 6e67 3b20 6465 6661 756c 7473 2074  ring; defaults t
-0004cce0: 6f20 4e6f 6e65 3b20 6e61 6d69 6e67 2066  o None; naming f
-0004ccf0: 6f72 2074 6865 200a 2020 2020 2020 2020  or the .        
-0004cd00: 6e6f 726d 616c 697a 6174 696f 6e5f 7465  normalization_te
-0004cd10: 6d70 6c61 7465 206f 7574 7075 7473 2077  mplate outputs w
-0004cd20: 6869 6368 2077 696c 6c20 6265 2069 6e20  hich will be in 
-0004cd30: 7468 6520 5431 7720 6469 7265 6374 6f72  the T1w director
-0004cd40: 792e 0a0a 2020 2020 6e6f 726d 616c 697a  y...    normaliz
-0004cd50: 6174 696f 6e5f 7465 6d70 6c61 7465 5f74  ation_template_t
-0004cd60: 7261 6e73 666f 726d 5f74 7970 6520 3a20  ransform_type : 
-0004cd70: 6f70 7469 6f6e 616c 2073 7472 696e 6720  optional string 
-0004cd80: 7472 616e 7366 6f72 6d20 7479 7065 2070  transform type p
-0004cd90: 6173 7365 6420 746f 2061 6e74 732e 7265  assed to ants.re
-0004cda0: 6769 7374 7261 7469 6f6e 0a0a 2020 2020  gistration..    
-0004cdb0: 6e6f 726d 616c 697a 6174 696f 6e5f 7465  normalization_te
-0004cdc0: 6d70 6c61 7465 5f73 7061 6369 6e67 203a  mplate_spacing :
-0004cdd0: 2033 2d74 7570 6c65 2063 6f6e 7472 6f6c   3-tuple control
-0004cde0: 6c69 6e67 2074 6865 2072 6573 6f6c 7574  ling the resolut
-0004cdf0: 696f 6e20 6174 2077 6869 6368 2072 6567  ion at which reg
-0004ce00: 6973 7472 6174 696f 6e20 6973 2063 6f6d  istration is com
-0004ce10: 7075 7465 6420 0a20 2020 200a 2020 2020  puted .    .    
-0004ce20: 656e 616e 7469 6f6d 6f72 7068 6963 3a20  enantiomorphic: 
-0004ce30: 626f 6f6c 6561 6e20 2857 4950 290a 0a20  boolean (WIP).. 
-0004ce40: 2020 2070 6572 6675 7369 6f6e 5f74 7269     perfusion_tri
-0004ce50: 6d20 3a20 6f70 7469 6f6e 616c 2069 6e74  m : optional int
-0004ce60: 6567 6572 206e 756d 6265 7220 6f66 2074  eger number of t
-0004ce70: 696d 6520 766f 6c75 6d65 7320 746f 2065  ime volumes to e
-0004ce80: 7863 6c75 6465 2066 726f 6d20 7468 6520  xclude from the 
-0004ce90: 6672 6f6e 7420 6f66 2074 6865 2070 6572  front of the per
-0004cea0: 6675 7369 6f6e 2074 696d 6520 7365 7269  fusion time seri
-0004ceb0: 6573 0a0a 2020 2020 7065 7266 7573 696f  es..    perfusio
-0004cec0: 6e5f 6d30 5f69 6d61 6765 203a 206f 7074  n_m0_image : opt
-0004ced0: 696f 6e61 6c20 6d30 2061 6e74 7349 6d61  ional m0 antsIma
-0004cee0: 6765 2061 7373 6f63 6961 7465 6420 7769  ge associated wi
-0004cef0: 7468 2074 6865 2070 6572 6675 7369 6f6e  th the perfusion
-0004cf00: 2074 696d 6520 7365 7269 6573 0a0a 2020   time series..  
-0004cf10: 2020 7065 7266 7573 696f 6e5f 6d30 203a    perfusion_m0 :
-0004cf20: 206f 7074 696f 6e61 6c20 6c69 7374 2063   optional list c
-0004cf30: 6f6e 7461 696e 696e 6720 696e 6469 6365  ontaining indice
-0004cf40: 7320 6f66 2074 6865 206d 3020 696e 2074  s of the m0 in t
-0004cf50: 6865 2070 6572 6675 7369 6f6e 2074 696d  he perfusion tim
-0004cf60: 6520 7365 7269 6573 0a0a 2020 2020 7273  e series..    rs
-0004cf70: 665f 7570 7361 6d70 6c69 6e67 203a 206f  f_upsampling : o
-0004cf80: 7074 696f 6e61 6c20 7570 7361 6d70 6c69  ptional upsampli
-0004cf90: 6e67 2070 6172 616d 6574 6572 2076 616c  ng parameter val
-0004cfa0: 7565 2069 6e20 6d6d 3b20 6966 2073 6574  ue in mm; if set
-0004cfb0: 2074 6f20 7a65 726f 2c20 6e6f 2075 7073   to zero, no ups
-0004cfc0: 616d 706c 696e 6720 6973 2064 6f6e 650a  ampling is done.
-0004cfd0: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
-0004cfe0: 202d 2d2d 2d2d 2d2d 2d2d 0a0a 2020 2020   ---------..    
-0004cff0: 7772 6974 6573 206f 7574 7075 7420 746f  writes output to
-0004d000: 2064 6973 6b20 616e 6420 7072 6f64 7563   disk and produc
-0004d010: 6573 2066 6967 7572 6573 0a0a 2020 2020  es figures..    
-0004d020: 2222 220a 2020 2020 696d 706f 7274 2074  """.    import t
-0004d030: 7261 6365 6261 636b 0a20 2020 2076 6973  raceback.    vis
-0004d040: 7561 6c69 7a65 203d 2054 7275 650a 2020  ualize = True.  
-0004d050: 2020 7665 7262 6f73 6520 3d20 5472 7565    verbose = True
-0004d060: 0a20 2020 2069 6620 7665 7262 6f73 653a  .    if verbose:
-0004d070: 0a20 2020 2020 2020 2070 7269 6e74 2820  .        print( 
-0004d080: 7665 7273 696f 6e28 2920 290a 2020 2020  version() ).    
-0004d090: 6966 206e 7267 5f6d 6f64 616c 6974 795f  if nrg_modality_
-0004d0a0: 6c69 7374 2069 7320 4e6f 6e65 3a0a 2020  list is None:.  
-0004d0b0: 2020 2020 2020 6e72 675f 6d6f 6461 6c69        nrg_modali
-0004d0c0: 7479 5f6c 6973 7420 3d20 6765 745f 7661  ty_list = get_va
-0004d0d0: 6c69 645f 6d6f 6461 6c69 7469 6573 2829  lid_modalities()
-0004d0e0: 0a20 2020 2069 6620 7374 7564 7963 7376  .    if studycsv
-0004d0f0: 2e73 6861 7065 5b30 5d20 3c20 313a 0a20  .shape[0] < 1:. 
-0004d100: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-0004d110: 7565 4572 726f 7228 2773 7475 6479 6373  ueError('studycs
-0004d120: 7620 6861 7320 6e6f 2072 6f77 7327 290a  v has no rows').
-0004d130: 2020 2020 6d75 7374 6861 7665 636f 6c73      musthavecols
-0004d140: 203d 205b 2770 726f 6a65 6374 4944 272c   = ['projectID',
-0004d150: 2027 7375 626a 6563 7449 4427 2c27 6461   'subjectID','da
-0004d160: 7465 272c 2769 6d61 6765 4944 272c 276d  te','imageID','m
-0004d170: 6f64 616c 6974 7927 2c27 736f 7572 6365  odality','source
-0004d180: 6469 7227 2c27 6f75 7470 7574 6469 7227  dir','outputdir'
-0004d190: 2c27 6669 6c65 6e61 6d65 275d 0a20 2020  ,'filename'].   
-0004d1a0: 2066 6f72 206b 2069 6e20 7261 6e67 6528   for k in range(
-0004d1b0: 6c65 6e28 6d75 7374 6861 7665 636f 6c73  len(musthavecols
-0004d1c0: 2929 3a0a 2020 2020 2020 2020 6966 206e  )):.        if n
-0004d1d0: 6f74 206d 7573 7468 6176 6563 6f6c 735b  ot musthavecols[
-0004d1e0: 6b5d 2069 6e20 7374 7564 7963 7376 2e6b  k] in studycsv.k
-0004d1f0: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
-0004d200: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0004d210: 726f 7228 2773 7475 6479 6373 7620 6973  ror('studycsv is
-0004d220: 206d 6973 7369 6e67 2063 6f6c 756d 6e20   missing column 
-0004d230: 2720 2b6d 7573 7468 6176 6563 6f6c 735b  ' +musthavecols[
-0004d240: 6b5d 2029 0a20 2020 2064 6566 206d 616b  k] ).    def mak
-0004d250: 6577 6964 656f 7574 2820 782c 2073 6570  ewideout( x, sep
-0004d260: 6172 6174 6f72 203d 206d 7973 6570 2029  arator = mysep )
-0004d270: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0004d280: 2078 202b 2073 6570 6172 6174 6f72 202b   x + separator +
-0004d290: 2027 6d6d 7769 6465 2e63 7376 270a 2020   'mmwide.csv'.  
-0004d2a0: 2020 7465 7374 6c6f 6f70 203d 2046 616c    testloop = Fal
-0004d2b0: 7365 0a20 2020 2063 6f75 6e74 6572 3d30  se.    counter=0
-0004d2c0: 0a20 2020 2069 6d70 6f72 7420 676c 6f62  .    import glob
-0004d2d0: 2061 7320 676c 6f62 0a20 2020 2066 726f   as glob.    fro
-0004d2e0: 6d20 6f73 2e70 6174 6820 696d 706f 7274  m os.path import
-0004d2f0: 2065 7869 7374 730a 2020 2020 6578 5f70   exists.    ex_p
-0004d300: 6174 6820 3d20 6f73 2e70 6174 682e 6578  ath = os.path.ex
-0004d310: 7061 6e64 7573 6572 2820 227e 2f2e 616e  panduser( "~/.an
-0004d320: 7473 7079 7431 772f 2220 290a 2020 2020  tspyt1w/" ).    
-0004d330: 6578 5f70 6174 686d 6d20 3d20 6f73 2e70  ex_pathmm = os.p
-0004d340: 6174 682e 6578 7061 6e64 7573 6572 2820  ath.expanduser( 
-0004d350: 227e 2f2e 616e 7473 7079 6d6d 2f22 2029  "~/.antspymm/" )
-0004d360: 0a20 2020 2074 656d 706c 6174 6566 6e20  .    templatefn 
-0004d370: 3d20 6578 5f70 6174 6820 2b20 2743 4954  = ex_path + 'CIT
-0004d380: 3136 385f 5431 775f 3730 3075 6d5f 7061  168_T1w_700um_pa
-0004d390: 645f 6164 6e69 2e6e 6969 2e67 7a27 0a20  d_adni.nii.gz'. 
-0004d3a0: 2020 2069 6620 6e6f 7420 6578 6973 7473     if not exists
-0004d3b0: 2820 7465 6d70 6c61 7465 666e 2029 3a0a  ( templatefn ):.
-0004d3c0: 2020 2020 2020 2020 7072 696e 7428 2022          print( "
-0004d3d0: 2a2a 6d69 7373 696e 6720 6669 6c65 732a  **missing files*
-0004d3e0: 2a20 3d3e 2063 616c 6c20 6765 745f 6461  * => call get_da
-0004d3f0: 7461 2066 726f 6d20 6c61 7465 7374 2061  ta from latest a
-0004d400: 6e74 7370 7974 3177 2061 6e64 2061 6e74  ntspyt1w and ant
-0004d410: 7370 796d 6d2e 2220 290a 2020 2020 2020  spymm." ).      
-0004d420: 2020 616e 7473 7079 7431 772e 6765 745f    antspyt1w.get_
-0004d430: 6461 7461 2820 666f 7263 655f 646f 776e  data( force_down
-0004d440: 6c6f 6164 3d54 7275 6520 290a 2020 2020  load=True ).    
-0004d450: 2020 2020 6765 745f 6461 7461 2820 666f      get_data( fo
-0004d460: 7263 655f 646f 776e 6c6f 6164 3d54 7275  rce_download=Tru
-0004d470: 6520 290a 2020 2020 7465 6d70 6c61 7465  e ).    template
-0004d480: 203d 206d 6d5f 7265 6164 2820 7465 6d70   = mm_read( temp
-0004d490: 6c61 7465 666e 2029 2023 2052 6561 6420  latefn ) # Read 
-0004d4a0: 696e 2074 656d 706c 6174 650a 2020 2020  in template.    
-0004d4b0: 7465 7374 5f72 756e 203d 2046 616c 7365  test_run = False
-0004d4c0: 0a20 2020 2069 6620 7465 7374 5f72 756e  .    if test_run
-0004d4d0: 3a0a 2020 2020 2020 2020 7669 7375 616c  :.        visual
-0004d4e0: 697a 653d 4661 6c73 650a 2020 2020 2320  ize=False.    # 
-0004d4f0: 6765 7420 7369 6420 616e 6420 6474 6964  get sid and dtid
-0004d500: 2066 726f 6d20 7374 7564 7963 7376 0a20   from studycsv. 
-0004d510: 2020 2023 206d 7573 7468 6176 6563 6f6c     # musthavecol
-0004d520: 7320 3d20 5b27 7072 6f6a 6563 7449 4427  s = ['projectID'
-0004d530: 2c27 7375 626a 6563 7449 4427 2c27 6461  ,'subjectID','da
-0004d540: 7465 272c 2769 6d61 6765 4944 272c 276d  te','imageID','m
-0004d550: 6f64 616c 6974 7927 2c27 736f 7572 6365  odality','source
-0004d560: 6469 7227 2c27 6f75 7470 7574 6469 7227  dir','outputdir'
-0004d570: 2c27 6669 6c65 6e61 6d65 275d 0a20 2020  ,'filename'].   
-0004d580: 2070 726f 6a69 6420 3d20 7374 7228 7374   projid = str(st
-0004d590: 7564 7963 7376 5b27 7072 6f6a 6563 7449  udycsv['projectI
-0004d5a0: 4427 5d2e 696c 6f63 5b30 5d29 0a20 2020  D'].iloc[0]).   
-0004d5b0: 2073 6964 203d 2073 7472 2873 7475 6479   sid = str(study
-0004d5c0: 6373 765b 2773 7562 6a65 6374 4944 275d  csv['subjectID']
-0004d5d0: 2e69 6c6f 635b 305d 290a 2020 2020 6474  .iloc[0]).    dt
-0004d5e0: 6964 203d 2073 7472 2873 7475 6479 6373  id = str(studycs
-0004d5f0: 765b 2764 6174 6527 5d2e 696c 6f63 5b30  v['date'].iloc[0
-0004d600: 5d29 0a20 2020 2069 6964 203d 2073 7472  ]).    iid = str
-0004d610: 2873 7475 6479 6373 765b 2769 6d61 6765  (studycsv['image
-0004d620: 4944 275d 2e69 6c6f 635b 305d 290a 2020  ID'].iloc[0]).  
-0004d630: 2020 7431 6969 6455 7365 3d69 6964 0a20    t1iidUse=iid. 
-0004d640: 2020 206d 6f64 616c 6974 7920 3d20 7374     modality = st
-0004d650: 7228 7374 7564 7963 7376 5b27 6d6f 6461  r(studycsv['moda
-0004d660: 6c69 7479 275d 2e69 6c6f 635b 305d 290a  lity'].iloc[0]).
-0004d670: 2020 2020 736f 7572 6365 6469 7220 3d20      sourcedir = 
-0004d680: 7374 7228 7374 7564 7963 7376 5b27 736f  str(studycsv['so
-0004d690: 7572 6365 6469 7227 5d2e 696c 6f63 5b30  urcedir'].iloc[0
-0004d6a0: 5d29 0a20 2020 206f 7574 7075 7464 6972  ]).    outputdir
-0004d6b0: 203d 2073 7472 2873 7475 6479 6373 765b   = str(studycsv[
-0004d6c0: 276f 7574 7075 7464 6972 275d 2e69 6c6f  'outputdir'].ilo
-0004d6d0: 635b 305d 290a 2020 2020 6669 6c65 6e61  c[0]).    filena
-0004d6e0: 6d65 203d 2073 7472 2873 7475 6479 6373  me = str(studycs
-0004d6f0: 765b 2766 696c 656e 616d 6527 5d2e 696c  v['filename'].il
-0004d700: 6f63 5b30 5d29 0a20 2020 2069 6620 6e6f  oc[0]).    if no
-0004d710: 7420 6578 6973 7473 2866 696c 656e 616d  t exists(filenam
-0004d720: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0004d730: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-0004d740: 2827 6d6d 5f6e 7267 2063 616e 6e6f 7420  ('mm_nrg cannot 
-0004d750: 6669 6e64 2066 696c 656e 616d 6520 2720  find filename ' 
-0004d760: 2b20 6669 6c65 6e61 6d65 202b 2027 2069  + filename + ' i
-0004d770: 6e20 6d6d 5f63 7376 2720 290a 0a20 2020  n mm_csv' )..   
-0004d780: 2023 2068 6965 7261 7263 6869 6361 6c0a   # hierarchical.
-0004d790: 2020 2020 2320 4e4f 5445 3a20 6966 2074      # NOTE: if t
-0004d7a0: 6865 7265 2061 7265 206d 756c 7469 706c  here are multipl
-0004d7b0: 6520 5431 7320 666f 7220 7468 6973 2074  e T1s for this t
-0004d7c0: 696d 6520 706f 696e 742c 2073 686f 756c  ime point, shoul
-0004d7d0: 6420 7461 6b65 0a20 2020 2023 2074 6865  d take.    # the
-0004d7e0: 206f 6e65 2077 6974 6820 7468 6520 6869   one with the hi
-0004d7f0: 6768 6573 7420 7265 736e 6574 4772 6164  ghest resnetGrad
-0004d800: 650a 2020 2020 7431 666e 203d 2066 696c  e.    t1fn = fil
-0004d810: 656e 616d 650a 2020 2020 6966 206e 6f74  ename.    if not
-0004d820: 2065 7869 7374 7328 2074 3166 6e20 293a   exists( t1fn ):
-0004d830: 0a20 2020 2020 2020 2072 6169 7365 2056  .        raise V
-0004d840: 616c 7565 4572 726f 7228 276d 6d5f 6e72  alueError('mm_nr
-0004d850: 6720 6361 6e6e 6f74 2066 696e 6420 7468  g cannot find th
-0004d860: 6520 5431 7720 7769 7468 2075 6964 2027  e T1w with uid '
-0004d870: 202b 2074 3166 6e20 290a 2020 2020 7431   + t1fn ).    t1
-0004d880: 203d 206d 6d5f 7265 6164 2820 7431 666e   = mm_read( t1fn
-0004d890: 2c20 6d6f 6461 6c69 7479 3d27 5431 7727  , modality='T1w'
-0004d8a0: 2029 0a20 2020 206d 696e 7370 6320 3d20   ).    minspc = 
-0004d8b0: 6e70 2e6d 696e 2861 6e74 732e 6765 745f  np.min(ants.get_
-0004d8c0: 7370 6163 696e 6728 7431 2929 0a20 2020  spacing(t1)).   
-0004d8d0: 206d 696e 7368 6170 6520 3d20 6e70 2e6d   minshape = np.m
-0004d8e0: 696e 2874 312e 7368 6170 6529 0a20 2020  in(t1.shape).   
-0004d8f0: 2069 6620 6d69 6e73 7063 203c 2031 652d   if minspc < 1e-
-0004d900: 3136 3a0a 2020 2020 2020 2020 7761 726e  16:.        warn
-0004d910: 696e 6773 2e77 6172 6e28 276d 696e 696d  ings.warn('minim
-0004d920: 756d 2073 7061 6369 6e67 2069 6e20 5431  um spacing in T1
-0004d930: 7720 6973 2074 6f6f 2073 6d61 6c6c 202d  w is too small -
-0004d940: 2063 616e 6e6f 7420 7072 6f63 6573 732e   cannot process.
-0004d950: 2027 202b 2073 7472 286d 696e 7370 6329   ' + str(minspc)
-0004d960: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
-0004d970: 6e0a 2020 2020 6966 206d 696e 7368 6170  n.    if minshap
-0004d980: 6520 3c20 3332 3a0a 2020 2020 2020 2020  e < 32:.        
-0004d990: 7761 726e 696e 6773 2e77 6172 6e28 276d  warnings.warn('m
-0004d9a0: 696e 696d 756d 2073 6861 7065 2069 6e20  inimum shape in 
-0004d9b0: 5431 7720 6973 2074 6f6f 2073 6d61 6c6c  T1w is too small
-0004d9c0: 202d 2063 616e 6e6f 7420 7072 6f63 6573   - cannot proces
-0004d9d0: 732e 2027 202b 2073 7472 286d 696e 7368  s. ' + str(minsh
-0004d9e0: 6170 6529 2029 0a20 2020 2020 2020 2072  ape) ).        r
-0004d9f0: 6574 7572 6e0a 0a20 2020 2069 6620 656e  eturn..    if en
-0004da00: 616e 7469 6f6d 6f72 7068 6963 3a0a 2020  antiomorphic:.  
-0004da10: 2020 2020 2020 7431 203d 2065 6e61 6e74        t1 = enant
-0004da20: 696f 6d6f 7270 6869 635f 6669 6c6c 696e  iomorphic_fillin
-0004da30: 675f 7769 7468 6f75 745f 6d61 736b 2820  g_without_mask( 
-0004da40: 7431 2c20 6178 6973 3d30 2029 5b30 5d0a  t1, axis=0 )[0].
-0004da50: 2020 2020 6869 6572 666e 203d 206f 7574      hierfn = out
-0004da60: 7075 7464 6972 202b 2022 2f22 2020 2b20  putdir + "/"  + 
-0004da70: 7072 6f6a 6964 202b 2022 2f22 202b 2073  projid + "/" + s
-0004da80: 6964 202b 2022 2f22 202b 2064 7469 6420  id + "/" + dtid 
-0004da90: 2b20 222f 2220 2b20 2254 3177 4869 6572  + "/" + "T1wHier
-0004daa0: 6172 6368 6963 616c 2220 2b20 272f 2720  archical" + '/' 
-0004dab0: 2b20 6969 6420 2b20 222f 2220 2b20 7072  + iid + "/" + pr
-0004dac0: 6f6a 6964 202b 206d 7973 6570 202b 2073  ojid + mysep + s
-0004dad0: 6964 202b 206d 7973 6570 202b 2064 7469  id + mysep + dti
-0004dae0: 6420 2b20 6d79 7365 7020 2b20 2254 3177  d + mysep + "T1w
-0004daf0: 4869 6572 6172 6368 6963 616c 2220 2b20  Hierarchical" + 
-0004db00: 6d79 7365 7020 2b20 6969 6420 2b20 6d79  mysep + iid + my
-0004db10: 7365 700a 2020 2020 6869 6572 666e 5352  sep.    hierfnSR
-0004db20: 203d 206f 7574 7075 7464 6972 202b 2022   = outputdir + "
-0004db30: 2f22 202b 2070 726f 6a69 6420 2b20 222f  /" + projid + "/
-0004db40: 2220 202b 2073 6964 202b 2022 2f22 202b  "  + sid + "/" +
-0004db50: 2064 7469 6420 2b20 222f 2220 2b20 2254   dtid + "/" + "T
-0004db60: 3177 4869 6572 6172 6368 6963 616c 5352  1wHierarchicalSR
-0004db70: 2220 2b20 272f 2720 2b20 6969 6420 2b20  " + '/' + iid + 
-0004db80: 222f 2220 2b20 7072 6f6a 6964 202b 206d  "/" + projid + m
-0004db90: 7973 6570 202b 2073 6964 202b 206d 7973  ysep + sid + mys
-0004dba0: 6570 202b 2064 7469 6420 2b20 6d79 7365  ep + dtid + myse
-0004dbb0: 7020 2b20 2254 3177 4869 6572 6172 6368  p + "T1wHierarch
-0004dbc0: 6963 616c 5352 2220 2b20 6d79 7365 7020  icalSR" + mysep 
-0004dbd0: 2b20 6969 6420 2b20 6d79 7365 700a 2020  + iid + mysep.  
-0004dbe0: 2020 6869 6572 666e 7465 7374 203d 2068    hierfntest = h
-0004dbf0: 6965 7266 6e20 2b20 2763 6572 6562 656c  ierfn + 'cerebel
-0004dc00: 6c75 6d2e 6373 7627 0a20 2020 2069 6620  lum.csv'.    if 
-0004dc10: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-0004dc20: 2070 7269 6e74 2820 6869 6572 666e 7465   print( hierfnte
-0004dc30: 7374 2029 0a20 2020 2072 6567 6f75 7420  st ).    regout 
-0004dc40: 3d20 7265 2e73 7562 2822 5431 7748 6965  = re.sub("T1wHie
-0004dc50: 7261 7263 6869 6361 6c22 2c22 5431 7722  rarchical","T1w"
-0004dc60: 2c68 6965 7266 6e29 202b 2022 7379 6e22  ,hierfn) + "syn"
-0004dc70: 0a20 2020 2074 656d 706c 6174 6554 7820  .    templateTx 
-0004dc80: 3d20 7b0a 2020 2020 2020 2020 2766 7764  = {.        'fwd
-0004dc90: 7472 616e 7366 6f72 6d73 273a 205b 2072  transforms': [ r
-0004dca0: 6567 6f75 742b 2731 5761 7270 2e6e 6969  egout+'1Warp.nii
-0004dcb0: 2e67 7a27 2c20 7265 676f 7574 2b27 3047  .gz', regout+'0G
-0004dcc0: 656e 6572 6963 4166 6669 6e65 2e6d 6174  enericAffine.mat
-0004dcd0: 275d 2c0a 2020 2020 2020 2020 2769 6e76  '],.        'inv
-0004dce0: 7472 616e 7366 6f72 6d73 273a 205b 2072  transforms': [ r
-0004dcf0: 6567 6f75 742b 2730 4765 6e65 7269 6341  egout+'0GenericA
-0004dd00: 6666 696e 652e 6d61 7427 2c20 7265 676f  ffine.mat', rego
-0004dd10: 7574 2b27 3149 6e76 6572 7365 5761 7270  ut+'1InverseWarp
-0004dd20: 2e6e 6969 2e67 7a27 5d20 207d 0a20 2020  .nii.gz']  }.   
-0004dd30: 2067 726f 7570 5478 203d 204e 6f6e 650a   groupTx = None.
-0004dd40: 2020 2020 2320 6d61 6b65 2074 6865 2054      # make the T
-0004dd50: 3177 2064 6972 6563 746f 7279 0a20 2020  1w directory.   
-0004dd60: 206f 732e 6d61 6b65 6469 7273 2820 6f73   os.makedirs( os
-0004dd70: 2e70 6174 682e 6469 726e 616d 6528 7265  .path.dirname(re
-0004dd80: 2e73 7562 2822 5431 7748 6965 7261 7263  .sub("T1wHierarc
-0004dd90: 6869 6361 6c22 2c22 5431 7722 2c68 6965  hical","T1w",hie
-0004dda0: 7266 6e29 292c 2065 7869 7374 5f6f 6b3d  rfn)), exist_ok=
-0004ddb0: 5472 7565 2020 290a 2020 2020 6966 206e  True  ).    if n
-0004ddc0: 6f72 6d61 6c69 7a61 7469 6f6e 5f74 656d  ormalization_tem
-0004ddd0: 706c 6174 655f 6f75 7470 7574 2069 7320  plate_output is 
-0004dde0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0004ddf0: 2020 6e6f 726d 6f75 7420 3d20 7265 2e73    normout = re.s
-0004de00: 7562 2822 5431 7748 6965 7261 7263 6869  ub("T1wHierarchi
-0004de10: 6361 6c22 2c22 5431 7722 2c68 6965 7266  cal","T1w",hierf
-0004de20: 6e29 202b 2020 6e6f 726d 616c 697a 6174  n) +  normalizat
-0004de30: 696f 6e5f 7465 6d70 6c61 7465 5f6f 7574  ion_template_out
-0004de40: 7075 740a 2020 2020 2020 2020 7465 6d70  put.        temp
-0004de50: 6c61 7465 4e6f 726d 5478 203d 207b 0a20  lateNormTx = {. 
-0004de60: 2020 2020 2020 2020 2020 2027 6677 6474             'fwdt
-0004de70: 7261 6e73 666f 726d 7327 3a20 5b20 6e6f  ransforms': [ no
-0004de80: 726d 6f75 742b 2731 5761 7270 2e6e 6969  rmout+'1Warp.nii
-0004de90: 2e67 7a27 2c20 6e6f 726d 6f75 742b 2730  .gz', normout+'0
-0004dea0: 4765 6e65 7269 6341 6666 696e 652e 6d61  GenericAffine.ma
-0004deb0: 7427 5d2c 0a20 2020 2020 2020 2020 2020  t'],.           
-0004dec0: 2027 696e 7674 7261 6e73 666f 726d 7327   'invtransforms'
-0004ded0: 3a20 5b20 6e6f 726d 6f75 742b 2730 4765  : [ normout+'0Ge
-0004dee0: 6e65 7269 6341 6666 696e 652e 6d61 7427  nericAffine.mat'
-0004def0: 2c20 6e6f 726d 6f75 742b 2731 496e 7665  , normout+'1Inve
-0004df00: 7273 6557 6172 702e 6e69 692e 677a 275d  rseWarp.nii.gz']
-0004df10: 2020 7d0a 2020 2020 2020 2020 6772 6f75    }.        grou
-0004df20: 7054 7820 3d20 7465 6d70 6c61 7465 4e6f  pTx = templateNo
-0004df30: 726d 5478 5b27 6677 6474 7261 6e73 666f  rmTx['fwdtransfo
-0004df40: 726d 7327 5d0a 2020 2020 6966 2076 6572  rms'].    if ver
-0004df50: 626f 7365 3a0a 2020 2020 2020 2020 7072  bose:.        pr
-0004df60: 696e 7428 2022 2d3c 5245 4749 5354 5241  int( "-<REGISTRA
-0004df70: 5449 4f4e 2045 5849 5354 454e 4345 3e2d  TION EXISTENCE>-
-0004df80: 3a20 5c6e 2220 2b20 0a20 2020 2020 2020  : \n" + .       
-0004df90: 2020 2020 2020 2022 4e41 4d49 4e47 3a20         "NAMING: 
-0004dfa0: 2220 2b20 7265 676f 7574 2b27 3047 656e  " + regout+'0Gen
-0004dfb0: 6572 6963 4166 6669 6e65 2e6d 6174 2720  ericAffine.mat' 
-0004dfc0: 2b20 2220 5c6e 2022 202b 0a20 2020 2020  + " \n " +.     
-0004dfd0: 2020 2020 2020 2073 7472 2865 7869 7374         str(exist
-0004dfe0: 7328 2074 656d 706c 6174 6554 785b 2766  s( templateTx['f
-0004dff0: 7764 7472 616e 7366 6f72 6d73 275d 5b30  wdtransforms'][0
-0004e000: 5d29 2920 2b20 2220 2220 2b0a 2020 2020  ])) + " " +.    
-0004e010: 2020 2020 2020 2020 7374 7228 6578 6973          str(exis
-0004e020: 7473 2820 7465 6d70 6c61 7465 5478 5b27  ts( templateTx['
-0004e030: 6677 6474 7261 6e73 666f 726d 7327 5d5b  fwdtransforms'][
-0004e040: 315d 2929 202b 2022 2022 202b 0a20 2020  1])) + " " +.   
-0004e050: 2020 2020 2020 2020 2073 7472 2865 7869           str(exi
-0004e060: 7374 7328 2074 656d 706c 6174 6554 785b  sts( templateTx[
-0004e070: 2769 6e76 7472 616e 7366 6f72 6d73 275d  'invtransforms']
-0004e080: 5b30 5d29 2920 2b20 2220 2220 2b0a 2020  [0])) + " " +.  
-0004e090: 2020 2020 2020 2020 2020 7374 7228 6578            str(ex
-0004e0a0: 6973 7473 2820 7465 6d70 6c61 7465 5478  ists( templateTx
-0004e0b0: 5b27 696e 7674 7261 6e73 666f 726d 7327  ['invtransforms'
-0004e0c0: 5d5b 315d 2929 2029 0a20 2020 2069 6620  ][1])) ).    if 
-0004e0d0: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-0004e0e0: 2070 7269 6e74 2820 6869 6572 666e 7465   print( hierfnte
-0004e0f0: 7374 2029 0a20 2020 2068 6965 7265 7869  st ).    hierexi
-0004e100: 7374 7320 3d20 6578 6973 7473 2820 6869  sts = exists( hi
-0004e110: 6572 666e 7465 7374 2029 2061 6e64 2065  erfntest ) and e
-0004e120: 7869 7374 7328 2074 656d 706c 6174 6554  xists( templateT
-0004e130: 785b 2766 7764 7472 616e 7366 6f72 6d73  x['fwdtransforms
-0004e140: 275d 5b30 5d29 2061 6e64 2065 7869 7374  '][0]) and exist
-0004e150: 7328 2074 656d 706c 6174 6554 785b 2766  s( templateTx['f
-0004e160: 7764 7472 616e 7366 6f72 6d73 275d 5b31  wdtransforms'][1
-0004e170: 5d29 2061 6e64 2065 7869 7374 7328 2074  ]) and exists( t
-0004e180: 656d 706c 6174 6554 785b 2769 6e76 7472  emplateTx['invtr
-0004e190: 616e 7366 6f72 6d73 275d 5b30 5d29 2061  ansforms'][0]) a
-0004e1a0: 6e64 2065 7869 7374 7328 2074 656d 706c  nd exists( templ
-0004e1b0: 6174 6554 785b 2769 6e76 7472 616e 7366  ateTx['invtransf
-0004e1c0: 6f72 6d73 275d 5b31 5d29 0a20 2020 2068  orms'][1]).    h
-0004e1d0: 6965 7220 3d20 4e6f 6e65 0a20 2020 2069  ier = None.    i
-0004e1e0: 6620 6e6f 7420 6869 6572 6578 6973 7473  f not hierexists
-0004e1f0: 2061 6e64 206e 6f74 2074 6573 746c 6f6f   and not testloo
-0004e200: 703a 0a20 2020 2020 2020 2073 7562 6a65  p:.        subje
-0004e210: 6374 7072 6f70 6174 6820 3d20 6f73 2e70  ctpropath = os.p
-0004e220: 6174 682e 6469 726e 616d 6528 2068 6965  ath.dirname( hie
-0004e230: 7266 6e20 290a 2020 2020 2020 2020 6966  rfn ).        if
-0004e240: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-0004e250: 2020 2020 2020 7072 696e 7428 2073 7562        print( sub
-0004e260: 6a65 6374 7072 6f70 6174 6820 290a 2020  jectpropath ).  
-0004e270: 2020 2020 2020 6f73 2e6d 616b 6564 6972        os.makedir
-0004e280: 7328 2073 7562 6a65 6374 7072 6f70 6174  s( subjectpropat
-0004e290: 682c 2065 7869 7374 5f6f 6b3d 5472 7565  h, exist_ok=True
-0004e2a0: 2020 290a 2020 2020 2020 2020 6869 6572    ).        hier
-0004e2b0: 203d 2061 6e74 7370 7974 3177 2e68 6965   = antspyt1w.hie
-0004e2c0: 7261 7263 6869 6361 6c28 2074 312c 2068  rarchical( t1, h
-0004e2d0: 6965 7266 6e2c 206c 6162 656c 735f 746f  ierfn, labels_to
-0004e2e0: 5f72 6567 6973 7465 723d 4e6f 6e65 2029  _register=None )
-0004e2f0: 0a20 2020 2020 2020 2061 6e74 7370 7974  .        antspyt
-0004e300: 3177 2e77 7269 7465 5f68 6965 7261 7263  1w.write_hierarc
-0004e310: 6869 6361 6c28 2068 6965 722c 2068 6965  hical( hier, hie
-0004e320: 7266 6e20 290a 2020 2020 2020 2020 7431  rfn ).        t1
-0004e330: 7769 6465 203d 2061 6e74 7370 7974 3177  wide = antspyt1w
-0004e340: 2e6d 6572 6765 5f68 6965 7261 7263 6869  .merge_hierarchi
-0004e350: 6361 6c5f 6373 7673 5f74 6f5f 7769 6465  cal_csvs_to_wide
-0004e360: 5f66 6f72 6d61 7428 0a20 2020 2020 2020  _format(.       
-0004e370: 2020 2020 2020 2020 2068 6965 725b 2764           hier['d
-0004e380: 6174 6166 7261 6d65 7327 5d2c 2069 6465  ataframes'], ide
-0004e390: 6e74 6966 6965 723d 4e6f 6e65 2029 0a20  ntifier=None ). 
-0004e3a0: 2020 2020 2020 2074 3177 6964 652e 746f         t1wide.to
-0004e3b0: 5f63 7376 2820 6869 6572 666e 202b 2027  _csv( hierfn + '
-0004e3c0: 6d6d 7769 6465 2e63 7376 2720 290a 2020  mmwide.csv' ).  
-0004e3d0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-0004e3e0: 2323 2320 7265 6164 2074 6865 2068 6965  ### read the hie
-0004e3f0: 7261 7263 6869 6361 6c20 6461 7461 2023  rarchical data #
-0004e400: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0004e410: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-0004e420: 2020 2023 206f 7665 722d 7772 6974 6520     # over-write 
-0004e430: 7468 6520 7262 7020 6461 7461 2077 6974  the rbp data wit
-0004e440: 6820 6120 636f 6e73 6973 7465 6e74 2061  h a consistent a
-0004e450: 6e64 2072 6563 656e 7420 6170 7072 6f61  nd recent approa
-0004e460: 6368 2023 2323 2323 2323 2323 2323 230a  ch ############.
-0004e470: 2020 2020 6d79 7820 3d20 616e 7473 7079      myx = antspy
-0004e480: 7431 772e 696e 7370 6563 745f 7261 775f  t1w.inspect_raw_
-0004e490: 7431 2820 7431 2c20 6869 6572 666e 202b  t1( t1, hierfn +
-0004e4a0: 2027 7262 7027 202c 206f 7074 696f 6e3d   'rbp' , option=
-0004e4b0: 2762 6f74 6827 2029 0a20 2020 206d 7978  'both' ).    myx
-0004e4c0: 5b27 6272 6169 6e27 5d2e 746f 5f63 7376  ['brain'].to_csv
-0004e4d0: 2820 6869 6572 666e 202b 2027 7262 702e  ( hierfn + 'rbp.
-0004e4e0: 6373 7627 2c20 696e 6465 783d 4661 6c73  csv', index=Fals
-0004e4f0: 6520 290a 2020 2020 6d79 785b 2762 7261  e ).    myx['bra
-0004e500: 696e 275d 2e74 6f5f 6373 7628 2068 6965  in'].to_csv( hie
-0004e510: 7266 6e20 2b20 2772 6270 6272 6169 6e2e  rfn + 'rbpbrain.
-0004e520: 6373 7627 2c20 696e 6465 783d 4661 6c73  csv', index=Fals
-0004e530: 6520 290a 2020 2020 6465 6c20 6d79 780a  e ).    del myx.
-0004e540: 2020 2020 6869 6572 203d 2061 6e74 7370      hier = antsp
-0004e550: 7974 3177 2e72 6561 645f 6869 6572 6172  yt1w.read_hierar
-0004e560: 6368 6963 616c 2820 6869 6572 666e 2029  chical( hierfn )
-0004e570: 0a20 2020 2074 3177 6964 6520 3d20 616e  .    t1wide = an
-0004e580: 7473 7079 7431 772e 6d65 7267 655f 6869  tspyt1w.merge_hi
-0004e590: 6572 6172 6368 6963 616c 5f63 7376 735f  erarchical_csvs_
-0004e5a0: 746f 5f77 6964 655f 666f 726d 6174 280a  to_wide_format(.
-0004e5b0: 2020 2020 2020 2020 6869 6572 5b27 6461          hier['da
-0004e5c0: 7461 6672 616d 6573 275d 2c20 6964 656e  taframes'], iden
-0004e5d0: 7469 6669 6572 3d4e 6f6e 6520 290a 2020  tifier=None ).  
-0004e5e0: 2020 7267 7261 6465 203d 2073 7472 2820    rgrade = str( 
-0004e5f0: 7431 7769 6465 5b27 7265 736e 6574 4772  t1wide['resnetGr
-0004e600: 6164 6527 5d2e 696c 6f63 5b30 5d20 290a  ade'].iloc[0] ).
-0004e610: 2020 2020 6966 2074 3177 6964 655b 2772      if t1wide['r
-0004e620: 6573 6e65 7447 7261 6465 275d 2e69 6c6f  esnetGrade'].ilo
-0004e630: 635b 305d 203c 2030 2e32 303a 0a20 2020  c[0] < 0.20:.   
-0004e640: 2020 2020 2077 6172 6e69 6e67 732e 7761       warnings.wa
-0004e650: 726e 2827 5431 7720 7175 616c 6974 7920  rn('T1w quality 
-0004e660: 6368 6563 6b20 696e 6469 6361 7465 7320  check indicates 
-0004e670: 6661 696c 7572 653a 2027 202b 2072 6772  failure: ' + rgr
-0004e680: 6164 6520 2b20 2220 7769 6c6c 206e 6f74  ade + " will not
-0004e690: 2070 726f 6365 7373 2e22 2029 0a20 2020   process." ).   
-0004e6a0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-0004e6b0: 656c 7365 3a0a 2020 2020 2020 2020 7072  else:.        pr
-0004e6c0: 696e 7428 2754 3177 2071 7561 6c69 7479  int('T1w quality
-0004e6d0: 2063 6865 636b 2069 6e64 6963 6174 6573   check indicates
-0004e6e0: 2073 7563 6365 7373 3a20 2720 2b20 7267   success: ' + rg
-0004e6f0: 7261 6465 202b 2022 2077 696c 6c20 7072  rade + " will pr
-0004e700: 6f63 6573 732e 2220 290a 0a20 2020 2069  ocess." )..    i
-0004e710: 6620 7372 6d6f 6465 6c5f 5431 2069 7320  f srmodel_T1 is 
-0004e720: 6e6f 7420 4661 6c73 6520 3a0a 2020 2020  not False :.    
-0004e730: 2020 2020 6869 6572 666e 7465 7374 203d      hierfntest =
-0004e740: 2068 6965 7266 6e53 5220 2b20 276d 746c   hierfnSR + 'mtl
-0004e750: 2e63 7376 270a 2020 2020 2020 2020 6966  .csv'.        if
-0004e760: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-0004e770: 2020 2020 2020 7072 696e 7428 2068 6965        print( hie
-0004e780: 7266 6e74 6573 7420 290a 2020 2020 2020  rfntest ).      
-0004e790: 2020 6869 6572 6578 6973 7473 203d 2065    hierexists = e
-0004e7a0: 7869 7374 7328 2068 6965 7266 6e74 6573  xists( hierfntes
-0004e7b0: 7420 2920 2320 4649 584d 4520 7368 6f75  t ) # FIXME shou
-0004e7c0: 6c64 2074 6573 7420 7468 6973 2065 7870  ld test this exp
-0004e7d0: 6c69 6369 746c 7920 6275 7420 7765 2061  licitly but we a
-0004e7e0: 7373 756d 6520 6974 2068 6572 650a 2020  ssume it here.  
-0004e7f0: 2020 2020 2020 6966 206e 6f74 2068 6965        if not hie
-0004e800: 7265 7869 7374 733a 0a20 2020 2020 2020  rexists:.       
-0004e810: 2020 2020 2073 7562 6a65 6374 7072 6f70       subjectprop
-0004e820: 6174 6820 3d20 6f73 2e70 6174 682e 6469  ath = os.path.di
-0004e830: 726e 616d 6528 2068 6965 7266 6e53 5220  rname( hierfnSR 
-0004e840: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0004e850: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-0004e860: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0004e870: 2073 7562 6a65 6374 7072 6f70 6174 6820   subjectpropath 
-0004e880: 290a 2020 2020 2020 2020 2020 2020 6f73  ).            os
-0004e890: 2e6d 616b 6564 6972 7328 2073 7562 6a65  .makedirs( subje
-0004e8a0: 6374 7072 6f70 6174 682c 2065 7869 7374  ctpropath, exist
-0004e8b0: 5f6f 6b3d 5472 7565 2020 290a 2020 2020  _ok=True  ).    
-0004e8c0: 2020 2020 2020 2020 2320 6869 6572 6172          # hierar
-0004e8d0: 6368 6963 616c 5f74 6f5f 7372 2874 3168  chical_to_sr(t1h
-0004e8e0: 6965 722c 2073 725f 6d6f 6465 6c2c 2074  ier, sr_model, t
-0004e8f0: 6973 7375 655f 7372 3d46 616c 7365 2c20  issue_sr=False, 
-0004e900: 626c 656e 6469 6e67 3d30 2e35 2c20 7665  blending=0.5, ve
-0004e910: 7262 6f73 653d 4661 6c73 6529 0a20 2020  rbose=False).   
-0004e920: 2020 2020 2020 2020 2062 6573 7475 7020           bestup 
-0004e930: 3d20 7369 712e 6f70 7469 6d69 7a65 5f75  = siq.optimize_u
-0004e940: 7073 616d 706c 696e 675f 7368 6170 6528  psampling_shape(
-0004e950: 2061 6e74 732e 6765 745f 7370 6163 696e   ants.get_spacin
-0004e960: 6728 7431 292c 206d 6f64 616c 6974 793d  g(t1), modality=
-0004e970: 2754 3127 2029 0a20 2020 2020 2020 2020  'T1' ).         
-0004e980: 2020 206d 646c 666e 203d 2065 785f 7061     mdlfn = ex_pa
-0004e990: 7468 6d6d 202b 2022 7369 715f 6465 6661  thmm + "siq_defa
-0004e9a0: 756c 745f 7369 7372 5f22 202b 2062 6573  ult_sisr_" + bes
-0004e9b0: 7475 7020 2b20 225f 3263 6861 6e5f 6665  tup + "_2chan_fe
-0004e9c0: 6174 7667 674c 365f 706f 7374 7365 675f  atvggL6_postseg_
-0004e9d0: 6265 7374 5f6d 646c 2e68 3522 0a20 2020  best_mdl.h5".   
-0004e9e0: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-0004e9f0: 7374 616e 6365 2820 7372 6d6f 6465 6c5f  stance( srmodel_
-0004ea00: 5431 2c20 7374 7220 293a 0a20 2020 2020  T1, str ):.     
-0004ea10: 2020 2020 2020 2020 2020 206d 646c 666e             mdlfn
-0004ea20: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
-0004ea30: 2065 785f 7061 7468 6d6d 2c20 7372 6d6f   ex_pathmm, srmo
-0004ea40: 6465 6c5f 5431 2029 0a20 2020 2020 2020  del_T1 ).       
-0004ea50: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-0004ea60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004ea70: 2070 7269 6e74 2820 6d64 6c66 6e20 290a   print( mdlfn ).
-0004ea80: 2020 2020 2020 2020 2020 2020 6966 2065              if e
-0004ea90: 7869 7374 7328 206d 646c 666e 2029 3a0a  xists( mdlfn ):.
-0004eaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004eab0: 7372 6d6f 6465 6c5f 5431 5f6d 646c 203d  srmodel_T1_mdl =
-0004eac0: 2074 662e 6b65 7261 732e 6d6f 6465 6c73   tf.keras.models
-0004ead0: 2e6c 6f61 645f 6d6f 6465 6c28 206d 646c  .load_model( mdl
-0004eae0: 666e 2c20 636f 6d70 696c 653d 4661 6c73  fn, compile=Fals
-0004eaf0: 6520 290a 2020 2020 2020 2020 2020 2020  e ).            
-0004eb00: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0004eb10: 2020 2020 2020 7072 696e 7428 206d 646c        print( mdl
-0004eb20: 666e 202b 2022 2064 6f65 7320 6e6f 7420  fn + " does not 
-0004eb30: 6578 6973 7420 2d20 7769 6c6c 206e 6f74  exist - will not
-0004eb40: 2072 756e 2e22 290a 2020 2020 2020 2020   run.").        
-0004eb50: 2020 2020 6869 6572 5352 203d 2061 6e74      hierSR = ant
-0004eb60: 7370 7974 3177 2e68 6965 7261 7263 6869  spyt1w.hierarchi
-0004eb70: 6361 6c5f 746f 5f73 7228 2068 6965 722c  cal_to_sr( hier,
-0004eb80: 2073 726d 6f64 656c 5f54 315f 6d64 6c2c   srmodel_T1_mdl,
-0004eb90: 2062 6c65 6e64 696e 673d 4e6f 6e65 2c20   blending=None, 
-0004eba0: 7469 7373 7565 5f73 723d 4661 6c73 6520  tissue_sr=False 
-0004ebb0: 290a 2020 2020 2020 2020 2020 2020 616e  ).            an
-0004ebc0: 7473 7079 7431 772e 7772 6974 655f 6869  tspyt1w.write_hi
-0004ebd0: 6572 6172 6368 6963 616c 2820 6869 6572  erarchical( hier
-0004ebe0: 5352 2c20 6869 6572 666e 5352 2029 0a20  SR, hierfnSR ). 
-0004ebf0: 2020 2020 2020 2020 2020 2074 3177 6964             t1wid
-0004ec00: 6553 5220 3d20 616e 7473 7079 7431 772e  eSR = antspyt1w.
-0004ec10: 6d65 7267 655f 6869 6572 6172 6368 6963  merge_hierarchic
-0004ec20: 616c 5f63 7376 735f 746f 5f77 6964 655f  al_csvs_to_wide_
-0004ec30: 666f 726d 6174 280a 2020 2020 2020 2020  format(.        
-0004ec40: 2020 2020 2020 2020 2020 2020 6869 6572              hier
-0004ec50: 5352 5b27 6461 7461 6672 616d 6573 275d  SR['dataframes']
-0004ec60: 2c20 6964 656e 7469 6669 6572 3d4e 6f6e  , identifier=Non
-0004ec70: 6520 290a 2020 2020 2020 2020 2020 2020  e ).            
-0004ec80: 7431 7769 6465 5352 2e74 6f5f 6373 7628  t1wideSR.to_csv(
-0004ec90: 2068 6965 7266 6e53 5220 2b20 276d 6d77   hierfnSR + 'mmw
-0004eca0: 6964 652e 6373 7627 2029 0a20 2020 2068  ide.csv' ).    h
-0004ecb0: 6965 7220 3d20 616e 7473 7079 7431 772e  ier = antspyt1w.
-0004ecc0: 7265 6164 5f68 6965 7261 7263 6869 6361  read_hierarchica
-0004ecd0: 6c28 2068 6965 7266 6e20 290a 2020 2020  l( hierfn ).    
-0004ece0: 6966 2065 7869 7374 7328 2068 6965 7266  if exists( hierf
-0004ecf0: 6e20 2b20 276d 6d77 6964 652e 6373 7627  n + 'mmwide.csv'
-0004ed00: 2029 203a 0a20 2020 2020 2020 2074 3177   ) :.        t1w
-0004ed10: 6964 6520 3d20 7064 2e72 6561 645f 6373  ide = pd.read_cs
-0004ed20: 7628 2068 6965 7266 6e20 2b20 276d 6d77  v( hierfn + 'mmw
-0004ed30: 6964 652e 6373 7627 2029 0a20 2020 2065  ide.csv' ).    e
-0004ed40: 6c69 6620 6e6f 7420 7465 7374 6c6f 6f70  lif not testloop
-0004ed50: 3a0a 2020 2020 2020 2020 7431 7769 6465  :.        t1wide
-0004ed60: 203d 2061 6e74 7370 7974 3177 2e6d 6572   = antspyt1w.mer
-0004ed70: 6765 5f68 6965 7261 7263 6869 6361 6c5f  ge_hierarchical_
-0004ed80: 6373 7673 5f74 6f5f 7769 6465 5f66 6f72  csvs_to_wide_for
-0004ed90: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
-0004eda0: 2020 2020 2068 6965 725b 2764 6174 6166       hier['dataf
-0004edb0: 7261 6d65 7327 5d2c 2069 6465 6e74 6966  rames'], identif
-0004edc0: 6965 723d 4e6f 6e65 2029 0a20 2020 2069  ier=None ).    i
-0004edd0: 6620 6e6f 7420 7465 7374 6c6f 6f70 3a0a  f not testloop:.
-0004ede0: 2020 2020 2020 2020 7431 696d 6762 726e          t1imgbrn
-0004edf0: 203d 2068 6965 725b 2762 7261 696e 5f6e   = hier['brain_n
-0004ee00: 345f 646e 7a27 5d0a 2020 2020 2020 2020  4_dnz'].        
-0004ee10: 7431 6174 726f 706f 7320 3d20 6869 6572  t1atropos = hier
-0004ee20: 5b27 646b 745f 7061 7263 275d 5b27 7469  ['dkt_parc']['ti
-0004ee30: 7373 7565 5f73 6567 6d65 6e74 6174 696f  ssue_segmentatio
-0004ee40: 6e27 5d0a 0a20 2020 2069 6620 6e6f 7420  n']..    if not 
-0004ee50: 6578 6973 7473 2820 7265 676f 7574 202b  exists( regout +
-0004ee60: 2022 6c6f 676a 6163 6f62 6961 6e2e 6e69   "logjacobian.ni
-0004ee70: 692e 677a 2220 2920 6f72 206e 6f74 2065  i.gz" ) or not e
-0004ee80: 7869 7374 7328 2072 6567 6f75 742b 2731  xists( regout+'1
-0004ee90: 5761 7270 2e6e 6969 2e67 7a27 2029 3a0a  Warp.nii.gz' ):.
-0004eea0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-0004eeb0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0004eec0: 7072 696e 7428 2773 7461 7274 2074 3120  print('start t1 
-0004eed0: 7265 6769 7374 7261 7469 6f6e 2729 0a20  registration'). 
-0004eee0: 2020 2020 2020 2065 785f 7061 7468 203d         ex_path =
-0004eef0: 206f 732e 7061 7468 2e65 7870 616e 6475   os.path.expandu
-0004ef00: 7365 7228 2022 7e2f 2e61 6e74 7370 7974  ser( "~/.antspyt
-0004ef10: 3177 2f22 2029 0a20 2020 2020 2020 2074  1w/" ).        t
-0004ef20: 656d 706c 6174 6566 6e20 3d20 6578 5f70  emplatefn = ex_p
-0004ef30: 6174 6820 2b20 2743 4954 3136 385f 5431  ath + 'CIT168_T1
-0004ef40: 775f 3730 3075 6d5f 7061 645f 6164 6e69  w_700um_pad_adni
-0004ef50: 2e6e 6969 2e67 7a27 0a20 2020 2020 2020  .nii.gz'.       
-0004ef60: 2074 656d 706c 6174 6520 3d20 6d6d 5f72   template = mm_r
-0004ef70: 6561 6428 2074 656d 706c 6174 6566 6e20  ead( templatefn 
-0004ef80: 290a 2020 2020 2020 2020 7465 6d70 6c61  ).        templa
-0004ef90: 7465 203d 2061 6e74 732e 7265 7361 6d70  te = ants.resamp
-0004efa0: 6c65 5f69 6d61 6765 2820 7465 6d70 6c61  le_image( templa
-0004efb0: 7465 2c20 5b31 2c31 2c31 5d2c 2075 7365  te, [1,1,1], use
-0004efc0: 5f76 6f78 656c 733d 4661 6c73 6520 290a  _voxels=False ).
-0004efd0: 2020 2020 2020 2020 7431 7265 6720 3d20          t1reg = 
-0004efe0: 616e 7473 2e72 6567 6973 7472 6174 696f  ants.registratio
-0004eff0: 6e28 2074 656d 706c 6174 652c 200a 2020  n( template, .  
-0004f000: 2020 2020 2020 2020 2020 6869 6572 5b27            hier['
-0004f010: 6272 6169 6e5f 6e34 5f64 6e7a 275d 2c0a  brain_n4_dnz'],.
-0004f020: 2020 2020 2020 2020 2020 2020 2261 6e74              "ant
-0004f030: 7352 6567 6973 7472 6174 696f 6e53 794e  sRegistrationSyN
-0004f040: 5175 6963 6b52 6570 726f 5b73 5d22 2c20  QuickRepro[s]", 
-0004f050: 6f75 7470 7265 6669 7820 3d20 7265 676f  outprefix = rego
-0004f060: 7574 2c20 7665 7262 6f73 653d 4661 6c73  ut, verbose=Fals
-0004f070: 6520 290a 2020 2020 2020 2020 6d79 6a61  e ).        myja
-0004f080: 6320 3d20 616e 7473 2e63 7265 6174 655f  c = ants.create_
-0004f090: 6a61 636f 6269 616e 5f64 6574 6572 6d69  jacobian_determi
-0004f0a0: 6e61 6e74 5f69 6d61 6765 2820 7465 6d70  nant_image( temp
-0004f0b0: 6c61 7465 2c0a 2020 2020 2020 2020 2020  late,.          
-0004f0c0: 2020 7431 7265 675b 2766 7764 7472 616e    t1reg['fwdtran
-0004f0d0: 7366 6f72 6d73 275d 5b30 5d2c 2064 6f5f  sforms'][0], do_
-0004f0e0: 6c6f 673d 5472 7565 2c20 6765 6f6d 3d54  log=True, geom=T
-0004f0f0: 7275 6520 290a 2020 2020 2020 2020 696d  rue ).        im
-0004f100: 6167 655f 7772 6974 655f 7769 7468 5f74  age_write_with_t
-0004f110: 6875 6d62 6e61 696c 2820 6d79 6a61 632c  humbnail( myjac,
-0004f120: 2072 6567 6f75 7420 2b20 226c 6f67 6a61   regout + "logja
-0004f130: 636f 6269 616e 2e6e 6969 2e67 7a22 2c20  cobian.nii.gz", 
-0004f140: 7468 756d 623d 4661 6c73 6520 290a 2020  thumb=False ).  
-0004f150: 2020 2020 2020 6966 2076 6973 7561 6c69        if visuali
-0004f160: 7a65 3a0a 2020 2020 2020 2020 2020 2020  ze:.            
-0004f170: 616e 7473 2e70 6c6f 7428 2061 6e74 732e  ants.plot( ants.
-0004f180: 694d 6174 6828 7431 7265 675b 2777 6172  iMath(t1reg['war
-0004f190: 7065 646d 6f76 6f75 7427 5d2c 224e 6f72  pedmovout'],"Nor
-0004f1a0: 6d61 6c69 7a65 2229 2c20 2061 7869 733d  malize"),  axis=
-0004f1b0: 322c 206e 736c 6963 6573 3d32 312c 206e  2, nslices=21, n
-0004f1c0: 636f 6c3d 372c 2063 726f 703d 5472 7565  col=7, crop=True
-0004f1d0: 2c20 7469 746c 653d 2777 6172 7065 6420  , title='warped 
-0004f1e0: 746f 2074 656d 706c 6174 6527 2c20 6669  to template', fi
-0004f1f0: 6c65 6e61 6d65 3d72 6567 6f75 742b 2274  lename=regout+"t
-0004f200: 6f74 656d 706c 6174 652e 706e 6722 2029  otemplate.png" )
-0004f210: 0a20 2020 2020 2020 2020 2020 2061 6e74  .            ant
-0004f220: 732e 706c 6f74 2820 616e 7473 2e69 4d61  s.plot( ants.iMa
-0004f230: 7468 286d 796a 6163 2c22 4e6f 726d 616c  th(myjac,"Normal
-0004f240: 697a 6522 292c 2020 6178 6973 3d32 2c20  ize"),  axis=2, 
-0004f250: 6e73 6c69 6365 733d 3231 2c20 6e63 6f6c  nslices=21, ncol
-0004f260: 3d37 2c20 6372 6f70 3d54 7275 652c 2074  =7, crop=True, t
-0004f270: 6974 6c65 3d27 6a61 636f 6269 616e 272c  itle='jacobian',
-0004f280: 2066 696c 656e 616d 653d 7265 676f 7574   filename=regout
-0004f290: 2b22 6a61 636f 6269 616e 2e70 6e67 2220  +"jacobian.png" 
-0004f2a0: 290a 0a20 2020 2069 6620 6e6f 726d 616c  )..    if normal
-0004f2b0: 697a 6174 696f 6e5f 7465 6d70 6c61 7465  ization_template
-0004f2c0: 5f6f 7574 7075 7420 6973 206e 6f74 204e  _output is not N
-0004f2d0: 6f6e 6520 616e 6420 6e6f 726d 616c 697a  one and normaliz
-0004f2e0: 6174 696f 6e5f 7465 6d70 6c61 7465 2069  ation_template i
-0004f2f0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-0004f300: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
-0004f310: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0004f320: 7428 2262 6567 696e 2067 726f 7570 2074  t("begin group t
-0004f330: 656d 706c 6174 6520 7265 6769 7374 7261  emplate registra
-0004f340: 7469 6f6e 2229 0a20 2020 2020 2020 2069  tion").        i
-0004f350: 6620 6e6f 7420 6578 6973 7473 2820 6e6f  f not exists( no
-0004f360: 726d 6f75 742b 2730 4765 6e65 7269 6341  rmout+'0GenericA
-0004f370: 6666 696e 652e 6d61 7427 2029 3a0a 2020  ffine.mat' ):.  
-0004f380: 2020 2020 2020 2020 2020 6966 206e 6f72            if nor
-0004f390: 6d61 6c69 7a61 7469 6f6e 5f74 656d 706c  malization_templ
-0004f3a0: 6174 655f 7370 6163 696e 6720 6973 206e  ate_spacing is n
-0004f3b0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0004f3c0: 2020 2020 2020 2020 206e 6f72 6d61 6c69           normali
-0004f3d0: 7a61 7469 6f6e 5f74 656d 706c 6174 655f  zation_template_
-0004f3e0: 7272 3d61 6e74 732e 7265 7361 6d70 6c65  rr=ants.resample
-0004f3f0: 5f69 6d61 6765 286e 6f72 6d61 6c69 7a61  _image(normaliza
-0004f400: 7469 6f6e 5f74 656d 706c 6174 652c 6e6f  tion_template,no
-0004f410: 726d 616c 697a 6174 696f 6e5f 7465 6d70  rmalization_temp
-0004f420: 6c61 7465 5f73 7061 6369 6e67 290a 2020  late_spacing).  
-0004f430: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0004f440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f450: 6e6f 726d 616c 697a 6174 696f 6e5f 7465  normalization_te
-0004f460: 6d70 6c61 7465 5f72 723d 6e6f 726d 616c  mplate_rr=normal
-0004f470: 697a 6174 696f 6e5f 7465 6d70 6c61 7465  ization_template
-0004f480: 0a20 2020 2020 2020 2020 2020 2067 7265  .            gre
-0004f490: 6720 3d20 616e 7473 2e72 6567 6973 7472  g = ants.registr
-0004f4a0: 6174 696f 6e28 200a 2020 2020 2020 2020  ation( .        
-0004f4b0: 2020 2020 2020 2020 6e6f 726d 616c 697a          normaliz
-0004f4c0: 6174 696f 6e5f 7465 6d70 6c61 7465 5f72  ation_template_r
-0004f4d0: 722c 200a 2020 2020 2020 2020 2020 2020  r, .            
-0004f4e0: 2020 2020 6869 6572 5b27 6272 6169 6e5f      hier['brain_
-0004f4f0: 6e34 5f64 6e7a 275d 2c0a 2020 2020 2020  n4_dnz'],.      
-0004f500: 2020 2020 2020 2020 2020 6e6f 726d 616c            normal
-0004f510: 697a 6174 696f 6e5f 7465 6d70 6c61 7465  ization_template
-0004f520: 5f74 7261 6e73 666f 726d 5f74 7970 652c  _transform_type,
-0004f530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004f540: 206f 7574 7072 6566 6978 203d 206e 6f72   outprefix = nor
-0004f550: 6d6f 7574 2c20 7665 7262 6f73 653d 4661  mout, verbose=Fa
-0004f560: 6c73 6520 290a 2020 2020 2020 2020 2020  lse ).          
-0004f570: 2020 6d79 6a61 6320 3d20 616e 7473 2e63    myjac = ants.c
-0004f580: 7265 6174 655f 6a61 636f 6269 616e 5f64  reate_jacobian_d
-0004f590: 6574 6572 6d69 6e61 6e74 5f69 6d61 6765  eterminant_image
-0004f5a0: 2820 7465 6d70 6c61 7465 2c0a 2020 2020  ( template,.    
-0004f5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f5c0: 6772 6567 5b27 6677 6474 7261 6e73 666f  greg['fwdtransfo
-0004f5d0: 726d 7327 5d5b 305d 2c20 646f 5f6c 6f67  rms'][0], do_log
-0004f5e0: 3d54 7275 652c 2067 656f 6d3d 5472 7565  =True, geom=True
-0004f5f0: 2029 0a20 2020 2020 2020 2020 2020 2069   ).            i
-0004f600: 6d61 6765 5f77 7269 7465 5f77 6974 685f  mage_write_with_
-0004f610: 7468 756d 626e 6169 6c28 206d 796a 6163  thumbnail( myjac
-0004f620: 2c20 6e6f 726d 6f75 7420 2b20 226c 6f67  , normout + "log
-0004f630: 6a61 636f 6269 616e 2e6e 6969 2e67 7a22  jacobian.nii.gz"
-0004f640: 2c20 7468 756d 623d 4661 6c73 6520 290a  , thumb=False ).
-0004f650: 2020 2020 2020 2020 2020 2020 6966 2076              if v
-0004f660: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-0004f670: 2020 2020 2020 2020 7072 696e 7428 2265          print("e
-0004f680: 6e64 2067 726f 7570 2074 656d 706c 6174  nd group templat
-0004f690: 6520 7265 6769 7374 7261 7469 6f6e 2229  e registration")
-0004f6a0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0004f6b0: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
-0004f6c0: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
-0004f6d0: 2020 2020 2020 2070 7269 6e74 2822 6772         print("gr
-0004f6e0: 6f75 7020 7465 6d70 6c61 7465 2072 6567  oup template reg
-0004f6f0: 6973 7472 6174 696f 6e20 616c 7265 6164  istration alread
-0004f700: 7920 646f 6e65 2229 0a0a 2020 2020 2320  y done")..    # 
-0004f710: 6c6f 6f70 206f 7665 7220 6d6f 6461 6c69  loop over modali
-0004f720: 7469 6573 2061 6e64 2074 6865 6e20 756e  ties and then un
-0004f730: 6971 7565 2069 6d61 6765 2049 4473 0a20  ique image IDs. 
-0004f740: 2020 2023 2077 6520 7472 6561 7420 4e4d     # we treat NM
-0004f750: 2069 6e20 6120 2273 7065 6369 616c 2220   in a "special" 
-0004f760: 7761 7920 2d2d 2061 6767 7265 6761 7469  way -- aggregati
-0004f770: 6e67 2072 6570 6561 7473 0a20 2020 2023  ng repeats.    #
-0004f780: 206f 7468 6572 206d 6f64 616c 6974 6965   other modalitie
-0004f790: 7320 2862 6579 6f6e 6420 5431 2920 6172  s (beyond T1) ar
-0004f7a0: 6520 7472 6561 7465 6420 696e 6469 7669  e treated indivi
-0004f7b0: 6475 616c 6c79 0a20 2020 2066 6f72 206f  dually.    for o
-0004f7c0: 7665 726d 6f64 5820 696e 206e 7267 5f6d  vermodX in nrg_m
-0004f7d0: 6f64 616c 6974 795f 6c69 7374 3a0a 2020  odality_list:.  
-0004f7e0: 2020 2020 2020 2320 6465 6669 6e65 2031        # define 1
-0004f7f0: 2e20 696e 7075 7420 696d 6167 6573 2032  . input images 2
-0004f800: 2e20 6f75 7470 7574 2070 7265 6669 780a  . output prefix.
-0004f810: 2020 2020 2020 2020 6d79 646f 6320 3d20          mydoc = 
-0004f820: 646f 6373 616d 736f 6e28 206f 7665 726d  docsamson( overm
-0004f830: 6f64 582c 2073 7475 6479 6373 763d 7374  odX, studycsv=st
-0004f840: 7564 7963 7376 2c20 6f75 7470 7574 6469  udycsv, outputdi
-0004f850: 723d 6f75 7470 7574 6469 722c 2070 726f  r=outputdir, pro
-0004f860: 6a69 643d 7072 6f6a 6964 2c20 7369 643d  jid=projid, sid=
-0004f870: 7369 642c 2064 7469 643d 6474 6964 2c20  sid, dtid=dtid, 
-0004f880: 6d79 7365 703d 6d79 7365 702c 7431 6969  mysep=mysep,t1ii
-0004f890: 643d 7431 6969 6455 7365 2029 0a20 2020  d=t1iidUse ).   
-0004f8a0: 2020 2020 206d 7969 6d67 7372 203d 206d       myimgsr = m
-0004f8b0: 7964 6f63 5b27 696d 6167 6573 275d 0a20  ydoc['images']. 
-0004f8c0: 2020 2020 2020 206d 796d 6d20 3d20 6d79         mymm = my
-0004f8d0: 646f 635b 276f 7574 7072 6566 6978 275d  doc['outprefix']
-0004f8e0: 0a20 2020 2020 2020 206d 796d 6f64 203d  .        mymod =
-0004f8f0: 206d 7964 6f63 5b27 6d6f 6461 6c69 7479   mydoc['modality
-0004f900: 275d 0a20 2020 2020 2020 2069 6620 7665  '].        if ve
-0004f910: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
-0004f920: 2020 2070 7269 6e74 2820 6d79 646f 6320     print( mydoc 
-0004f930: 290a 2020 2020 2020 2020 6966 206c 656e  ).        if len
-0004f940: 286d 7969 6d67 7372 2920 3e20 303a 0a20  (myimgsr) > 0:. 
-0004f950: 2020 2020 2020 2020 2020 2064 6f77 7269             dowri
-0004f960: 7465 3d46 616c 7365 0a20 2020 2020 2020  te=False.       
-0004f970: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-0004f980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004f990: 2070 7269 6e74 2820 276f 7665 726d 6f64   print( 'overmod
-0004f9a0: 5820 6973 203a 2027 202b 206f 7665 726d  X is : ' + overm
-0004f9b0: 6f64 5820 290a 2020 2020 2020 2020 2020  odX ).          
-0004f9c0: 2020 2020 2020 7072 696e 7428 2027 6578        print( 'ex
-0004f9d0: 616d 706c 6520 696d 6167 6520 6e61 6d65  ample image name
-0004f9e0: 2069 7320 3a20 2720 2029 0a20 2020 2020   is : '  ).     
-0004f9f0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0004fa00: 2820 6d79 696d 6773 7220 290a 2020 2020  ( myimgsr ).    
-0004fa10: 2020 2020 2020 2020 6966 206f 7665 726d          if overm
-0004fa20: 6f64 5820 3d3d 2027 4e4d 3244 4d54 273a  odX == 'NM2DMT':
-0004fa30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004fa40: 2064 6f77 7269 7465 203d 2054 7275 650a   dowrite = True.
-0004fa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004fa60: 7669 7375 616c 697a 6520 3d20 5472 7565  visualize = True
-0004fa70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004fa80: 2073 7562 6a65 6374 7072 6f70 6174 6820   subjectpropath 
-0004fa90: 3d20 6f73 2e70 6174 682e 6469 726e 616d  = os.path.dirnam
-0004faa0: 6528 206d 7964 6f63 5b27 6f75 7470 7265  e( mydoc['outpre
-0004fab0: 6669 7827 5d20 290a 2020 2020 2020 2020  fix'] ).        
-0004fac0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-0004fad0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0004fae0: 2020 2020 2020 2020 7072 696e 7428 2273          print("s
-0004faf0: 7562 6a65 6374 7072 6f70 6174 6820 6973  ubjectpropath is
-0004fb00: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-0004fb10: 2020 2020 2020 2070 7269 6e74 2873 7562         print(sub
-0004fb20: 6a65 6374 7072 6f70 6174 6829 0a20 2020  jectpropath).   
-0004fb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004fb40: 206f 732e 6d61 6b65 6469 7273 2820 7375   os.makedirs( su
-0004fb50: 626a 6563 7470 726f 7061 7468 2c20 6578  bjectpropath, ex
-0004fb60: 6973 745f 6f6b 3d54 7275 6520 2029 0a20  ist_ok=True  ). 
-0004fb70: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0004fb80: 7969 6d67 7372 3220 3d20 6d79 696d 6773  yimgsr2 = myimgs
-0004fb90: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-0004fba0: 2020 6d79 696d 6773 7232 2e73 6f72 7428    myimgsr2.sort(
-0004fbb0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0004fbc0: 2020 6973 3464 203d 2046 616c 7365 0a20    is4d = False. 
-0004fbd0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0004fbe0: 656d 7020 3d20 616e 7473 2e69 6d61 6765  emp = ants.image
-0004fbf0: 5f72 6561 6428 206d 7969 6d67 7372 325b  _read( myimgsr2[
-0004fc00: 305d 2029 0a20 2020 2020 2020 2020 2020  0] ).           
-0004fc10: 2020 2020 2069 6620 7465 6d70 2e64 696d       if temp.dim
-0004fc20: 656e 7369 6f6e 203d 3d20 343a 0a20 2020  ension == 4:.   
-0004fc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004fc40: 2069 7334 6420 3d20 5472 7565 0a20 2020   is4d = True.   
-0004fc50: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0004fc60: 6c65 6e28 206d 7969 6d67 7372 3220 2920  len( myimgsr2 ) 
-0004fc70: 3d3d 2031 2061 6e64 206e 6f74 2069 7334  == 1 and not is4
-0004fc80: 643a 2023 2063 6865 636b 2064 696d 656e  d: # check dimen
-0004fc90: 7369 6f6e 0a20 2020 2020 2020 2020 2020  sion.           
-0004fca0: 2020 2020 2020 2020 206d 7969 6d67 7372           myimgsr
-0004fcb0: 3220 3d20 6d79 696d 6773 7232 202b 206d  2 = myimgsr2 + m
-0004fcc0: 7969 6d67 7372 320a 2020 2020 2020 2020  yimgsr2.        
-0004fcd0: 2020 2020 2020 2020 6d79 6d6d 6f75 7420          mymmout 
-0004fce0: 3d20 6d61 6b65 7769 6465 6f75 7428 206d  = makewideout( m
-0004fcf0: 796d 6d20 290a 2020 2020 2020 2020 2020  ymm ).          
-0004fd00: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-0004fd10: 2061 6e64 206e 6f74 2065 7869 7374 7328   and not exists(
-0004fd20: 206d 796d 6d6f 7574 2029 3a0a 2020 2020   mymmout ):.    
-0004fd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004fd40: 7072 696e 7428 2022 4e4d 2022 202b 206d  print( "NM " + m
-0004fd50: 796d 6d20 202b 2027 2065 7865 6375 7469  ymm  + ' executi
-0004fd60: 6f6e 2027 290a 2020 2020 2020 2020 2020  on ').          
-0004fd70: 2020 2020 2020 656c 6966 2076 6572 626f        elif verbo
-0004fd80: 7365 2061 6e64 2065 7869 7374 7328 206d  se and exists( m
-0004fd90: 796d 6d6f 7574 2029 203a 0a20 2020 2020  ymmout ) :.     
-0004fda0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0004fdb0: 7269 6e74 2820 224e 4d20 2220 2b20 6d79  rint( "NM " + my
-0004fdc0: 6d6d 202b 2027 2063 6f6d 706c 6574 6520  mm + ' complete 
-0004fdd0: 2720 290a 2020 2020 2020 2020 2020 2020  ' ).            
-0004fde0: 2020 2020 6966 2065 7869 7374 7328 206d      if exists( m
-0004fdf0: 796d 6d6f 7574 2029 3a0a 2020 2020 2020  ymmout ):.      
-0004fe00: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0004fe10: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
-0004fe20: 2020 2020 2020 2069 6620 6973 3464 3a0a         if is4d:.
-0004fe30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004fe40: 2020 2020 6e6d 6c69 7374 203d 2061 6e74      nmlist = ant
-0004fe50: 732e 6e64 696d 6167 655f 746f 5f6c 6973  s.ndimage_to_lis
-0004fe60: 7428 206d 6d5f 7265 6164 2820 6d79 696d  t( mm_read( myim
-0004fe70: 6773 7232 5b30 5d20 2920 290a 2020 2020  gsr2[0] ) ).    
-0004fe80: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0004fe90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0004fea0: 2020 2020 2020 6e6d 6c69 7374 203d 205b        nmlist = [
-0004feb0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0004fec0: 2020 2020 2020 666f 7220 7a7a 2069 6e20        for zz in 
-0004fed0: 6d79 696d 6773 7232 3a0a 2020 2020 2020  myimgsr2:.      
-0004fee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004fef0: 2020 6e6d 6c69 7374 2e61 7070 656e 6428    nmlist.append(
-0004ff00: 206d 6d5f 7265 6164 2820 7a7a 2029 2029   mm_read( zz ) )
-0004ff10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004ff20: 2073 726d 6f64 656c 5f4e 4d5f 6d64 6c20   srmodel_NM_mdl 
-0004ff30: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-0004ff40: 2020 2020 2020 2069 6620 7372 6d6f 6465         if srmode
-0004ff50: 6c5f 4e4d 2069 7320 6e6f 7420 4661 6c73  l_NM is not Fals
-0004ff60: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0004ff70: 2020 2020 2020 2062 6573 7475 7020 3d20         bestup = 
-0004ff80: 7369 712e 6f70 7469 6d69 7a65 5f75 7073  siq.optimize_ups
-0004ff90: 616d 706c 696e 675f 7368 6170 6528 2061  ampling_shape( a
-0004ffa0: 6e74 732e 6765 745f 7370 6163 696e 6728  nts.get_spacing(
-0004ffb0: 6e6d 6c69 7374 5b30 5d29 2c20 6d6f 6461  nmlist[0]), moda
-0004ffc0: 6c69 7479 3d27 4e4d 272c 2072 6f75 6e64  lity='NM', round
-0004ffd0: 6974 3d54 7275 6520 290a 2020 2020 2020  it=True ).      
-0004ffe0: 2020 2020 2020 2020 2020 2020 2020 6d64                md
-0004fff0: 6c66 6e20 3d20 6578 5f70 6174 686d 6d20  lfn = ex_pathmm 
-00050000: 2b20 2273 6971 5f64 6566 6175 6c74 5f73  + "siq_default_s
-00050010: 6973 725f 2220 2b20 6265 7374 7570 202b  isr_" + bestup +
-00050020: 2022 5f31 6368 616e 5f66 6561 7476 6767   "_1chan_featvgg
-00050030: 4c36 5f62 6573 745f 6d64 6c2e 6835 220a  L6_best_mdl.h5".
-00050040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050050: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00050060: 6528 2073 726d 6f64 656c 5f4e 4d2c 2073  e( srmodel_NM, s
-00050070: 7472 2029 3a0a 2020 2020 2020 2020 2020  tr ):.          
-00050080: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00050090: 6d6f 6465 6c5f 4e4d 203d 2072 652e 7375  model_NM = re.su
-000500a0: 6228 2022 6265 7374 7570 222c 2062 6573  b( "bestup", bes
-000500b0: 7475 702c 2073 726d 6f64 656c 5f4e 4d20  tup, srmodel_NM 
-000500c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000500d0: 2020 2020 2020 2020 2020 6d64 6c66 6e20            mdlfn 
-000500e0: 3d20 6f73 2e70 6174 682e 6a6f 696e 2820  = os.path.join( 
-000500f0: 6578 5f70 6174 686d 6d2c 2073 726d 6f64  ex_pathmm, srmod
-00050100: 656c 5f4e 4d20 290a 2020 2020 2020 2020  el_NM ).        
-00050110: 2020 2020 2020 2020 2020 2020 6966 2065              if e
-00050120: 7869 7374 7328 206d 646c 666e 2029 3a0a  xists( mdlfn ):.
+0004c0d0: 702b 2246 4162 6574 7465 722e 706e 6722  p+"FAbetter.png"
+0004c0e0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0004c0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c100: 2020 2020 2020 2020 616e 7473 2e70 6c6f          ants.plo
+0004c110: 7428 206d 7964 7469 5b27 7265 636f 6e5f  t( mydti['recon_
+0004c120: 6661 275d 2c20 6d79 6474 695b 276a 6875  fa'], mydti['jhu
+0004c130: 5f6c 6162 656c 7327 5d2c 2061 7869 733d  _labels'], axis=
+0004c140: 322c 206e 736c 6963 6573 3d6d 6178 736c  2, nslices=maxsl
+0004c150: 6963 652c 206e 636f 6c3d 372c 2063 726f  ice, ncol=7, cro
+0004c160: 703d 5472 7565 2c20 7469 746c 653d 2746  p=True, title='F
+0004c170: 4120 2b20 4a48 5527 2c20 6669 6c65 6e61  A + JHU', filena
+0004c180: 6d65 3d6d 796d 6d2b 6d79 7365 702b 2246  me=mymm+mysep+"F
+0004c190: 414a 4855 2e70 6e67 2220 2029 0a20 2020  AJHU.png"  ).   
+0004c1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c1c0: 2061 6e74 732e 706c 6f74 2820 6d79 6474   ants.plot( mydt
+0004c1d0: 695b 2772 6563 6f6e 5f6d 6427 5d2c 2020  i['recon_md'],  
+0004c1e0: 6178 6973 3d32 2c20 6e73 6c69 6365 733d  axis=2, nslices=
+0004c1f0: 6d61 7873 6c69 6365 2c20 6e63 6f6c 3d37  maxslice, ncol=7
+0004c200: 2c20 6372 6f70 3d54 7275 652c 2074 6974  , crop=True, tit
+0004c210: 6c65 3d27 4d44 272c 2066 696c 656e 616d  le='MD', filenam
+0004c220: 653d 6d79 6d6d 2b6d 7973 6570 2b22 4d44  e=mymm+mysep+"MD
+0004c230: 2e70 6e67 2220 2029 0a20 2020 2020 2020  .png"  ).       
+0004c240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c250: 2020 2020 2069 6620 646f 7772 6974 653a       if dowrite:
+0004c260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004c270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c280: 2077 7269 7465 5f6d 6d28 206f 7574 7075   write_mm( outpu
+0004c290: 745f 7072 6566 6978 3d6d 796d 6d2c 206d  t_prefix=mymm, m
+0004c2a0: 6d3d 7461 6250 726f 2c20 6d6d 5f6e 6f72  m=tabPro, mm_nor
+0004c2b0: 6d3d 6e6f 726d 5072 6f2c 2074 3177 6964  m=normPro, t1wid
+0004c2c0: 653d 7431 7769 6465 2c20 7365 7061 7261  e=t1wide, separa
+0004c2d0: 746f 723d 6d79 7365 702c 2076 6572 626f  tor=mysep, verbo
+0004c2e0: 7365 3d54 7275 6520 290a 2020 2020 2020  se=True ).      
+0004c2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c300: 2020 2020 2020 2020 2020 666f 7220 6d79            for my
+0004c310: 6b65 7920 696e 206e 6f72 6d50 726f 2e6b  key in normPro.k
+0004c320: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
+0004c330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c340: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0004c350: 726d 5072 6f5b 6d79 6b65 795d 2069 7320  rmPro[mykey] is 
+0004c360: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0004c370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c390: 2020 6966 2076 6973 7561 6c69 7a65 2061    if visualize a
+0004c3a0: 6e64 206e 6f72 6d50 726f 5b6d 796b 6579  nd normPro[mykey
+0004c3b0: 5d2e 636f 6d70 6f6e 656e 7473 203d 3d20  ].components == 
+0004c3c0: 3120 616e 6420 4661 6c73 653a 0a20 2020  1 and False:.   
+0004c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c3f0: 2020 2020 2020 2020 2061 6e74 732e 706c           ants.pl
+0004c400: 6f74 2820 7465 6d70 6c61 7465 2c20 6e6f  ot( template, no
+0004c410: 726d 5072 6f5b 6d79 6b65 795d 2c20 6178  rmPro[mykey], ax
+0004c420: 6973 3d32 2c20 6e73 6c69 6365 733d 3231  is=2, nslices=21
+0004c430: 2c20 6e63 6f6c 3d37 2c20 6372 6f70 3d54  , ncol=7, crop=T
+0004c440: 7275 652c 2074 6974 6c65 3d6d 796b 6579  rue, title=mykey
+0004c450: 2c20 6669 6c65 6e61 6d65 3d6d 796d 6d2b  , filename=mymm+
+0004c460: 6d79 7365 702b 6d79 6b65 792b 222e 706e  mysep+mykey+".pn
+0004c470: 6722 2020 2029 0a20 2020 2020 2020 2069  g"   ).        i
+0004c480: 6620 6f76 6572 6d6f 6458 203d 3d20 6e72  f overmodX == nr
+0004c490: 675f 6d6f 6461 6c69 7479 5f6c 6973 745b  g_modality_list[
+0004c4a0: 206c 656e 2820 6e72 675f 6d6f 6461 6c69   len( nrg_modali
+0004c4b0: 7479 5f6c 6973 7420 2920 2d20 3120 5d3a  ty_list ) - 1 ]:
+0004c4c0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0004c4d0: 7572 6e0a 2020 2020 2020 2020 6966 2076  urn.        if v
+0004c4e0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+0004c4f0: 2020 2020 7072 696e 7428 2264 6f6e 6520      print("done 
+0004c500: 7769 7468 2022 202b 206f 7665 726d 6f64  with " + overmod
+0004c510: 5820 290a 2020 2020 6966 2076 6572 626f  X ).    if verbo
+0004c520: 7365 3a0a 2020 2020 2020 2020 7072 696e  se:.        prin
+0004c530: 7428 226d 6d5f 6e72 6720 636f 6d70 6c65  t("mm_nrg comple
+0004c540: 7465 2e22 290a 2020 2020 7265 7475 726e  te.").    return
+0004c550: 0a0a 0a0a 6465 6620 6d6d 5f63 7376 280a  ....def mm_csv(.
+0004c560: 2020 2020 7374 7564 7963 7376 2c20 2020      studycsv,   
+0004c570: 2320 7061 6e64 6173 2064 6174 6120 6672  # pandas data fr
+0004c580: 616d 650a 2020 2020 6d79 7365 7020 3d20  ame.    mysep = 
+0004c590: 272d 272c 2023 206f 7220 225f 2220 666f  '-', # or "_" fo
+0004c5a0: 7220 4249 4453 0a20 2020 2073 726d 6f64  r BIDS.    srmod
+0004c5b0: 656c 5f54 3120 3d20 4661 6c73 652c 2023  el_T1 = False, #
+0004c5c0: 206f 7074 696f 6e61 6c20 2d20 7769 6c6c   optional - will
+0004c5d0: 2061 6464 2061 2067 7265 6174 2064 6561   add a great dea
+0004c5e0: 6c20 6f66 2074 696d 650a 2020 2020 7372  l of time.    sr
+0004c5f0: 6d6f 6465 6c5f 4e4d 203d 2046 616c 7365  model_NM = False
+0004c600: 2c20 2320 6f70 7469 6f6e 616c 202d 2077  , # optional - w
+0004c610: 696c 6c20 6164 6420 6120 6772 6561 7420  ill add a great 
+0004c620: 6465 616c 206f 6620 7469 6d65 0a20 2020  deal of time.   
+0004c630: 2073 726d 6f64 656c 5f44 5449 203d 2046   srmodel_DTI = F
+0004c640: 616c 7365 2c20 2320 6f70 7469 6f6e 616c  alse, # optional
+0004c650: 202d 2077 696c 6c20 6164 6420 6120 6772   - will add a gr
+0004c660: 6561 7420 6465 616c 206f 6620 7469 6d65  eat deal of time
+0004c670: 0a20 2020 2064 7469 5f6d 6f74 696f 6e5f  .    dti_motion_
+0004c680: 636f 7272 6563 7420 3d20 2753 794e 272c  correct = 'SyN',
+0004c690: 0a20 2020 2064 7469 5f64 656e 6f69 7365  .    dti_denoise
+0004c6a0: 203d 2054 7275 652c 0a20 2020 206e 7267   = True,.    nrg
+0004c6b0: 5f6d 6f64 616c 6974 795f 6c69 7374 203d  _modality_list =
+0004c6c0: 204e 6f6e 652c 0a20 2020 206e 6f72 6d61   None,.    norma
+0004c6d0: 6c69 7a61 7469 6f6e 5f74 656d 706c 6174  lization_templat
+0004c6e0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 6e6f  e = None,.    no
+0004c6f0: 726d 616c 697a 6174 696f 6e5f 7465 6d70  rmalization_temp
+0004c700: 6c61 7465 5f6f 7574 7075 7420 3d20 4e6f  late_output = No
+0004c710: 6e65 2c0a 2020 2020 6e6f 726d 616c 697a  ne,.    normaliz
+0004c720: 6174 696f 6e5f 7465 6d70 6c61 7465 5f74  ation_template_t
+0004c730: 7261 6e73 666f 726d 5f74 7970 6520 3d20  ransform_type = 
+0004c740: 2261 6e74 7352 6567 6973 7472 6174 696f  "antsRegistratio
+0004c750: 6e53 794e 5265 7072 6f5b 735d 222c 0a20  nSyNRepro[s]",. 
+0004c760: 2020 206e 6f72 6d61 6c69 7a61 7469 6f6e     normalization
+0004c770: 5f74 656d 706c 6174 655f 7370 6163 696e  _template_spacin
+0004c780: 673d 4e6f 6e65 2c0a 2020 2020 656e 616e  g=None,.    enan
+0004c790: 7469 6f6d 6f72 7068 6963 3d46 616c 7365  tiomorphic=False
+0004c7a0: 2c0a 2020 2020 7065 7266 7573 696f 6e5f  ,.    perfusion_
+0004c7b0: 7472 696d 203d 2031 302c 0a20 2020 2070  trim = 10,.    p
+0004c7c0: 6572 6675 7369 6f6e 5f6d 305f 696d 6167  erfusion_m0_imag
+0004c7d0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 7065  e = None,.    pe
+0004c7e0: 7266 7573 696f 6e5f 6d30 203d 204e 6f6e  rfusion_m0 = Non
+0004c7f0: 652c 0a20 2020 2072 7366 5f75 7073 616d  e,.    rsf_upsam
+0004c800: 706c 696e 6720 3d20 332e 300a 293a 0a20  pling = 3.0.):. 
+0004c810: 2020 2022 2222 0a20 2020 2074 6f6f 2064     """.    too d
+0004c820: 616e 6765 726f 7573 2074 6f20 646f 6375  angerous to docu
+0004c830: 6d65 6e74 202e 2e2e 2075 7365 2077 6974  ment ... use wit
+0004c840: 6820 6361 7265 2e0a 0a20 2020 2070 726f  h care...    pro
+0004c850: 6365 7373 6573 206d 756c 7469 706c 6520  cesses multiple 
+0004c860: 6d6f 6461 6c69 7479 204d 5249 2073 7065  modality MRI spe
+0004c870: 6369 6669 6361 6c6c 793a 0a0a 2020 2020  cifically:..    
+0004c880: 2a20 5431 770a 2020 2020 2a20 5432 466c  * T1w.    * T2Fl
+0004c890: 6169 720a 2020 2020 2a20 4454 492c 2044  air.    * DTI, D
+0004c8a0: 5449 5f4c 522c 2044 5449 5f52 4c0a 2020  TI_LR, DTI_RL.  
+0004c8b0: 2020 2a20 7273 664d 5249 2c20 7273 664d    * rsfMRI, rsfM
+0004c8c0: 5249 5f4c 522c 2072 7366 4d52 495f 524c  RI_LR, rsfMRI_RL
+0004c8d0: 0a20 2020 202a 204e 4d32 444d 5420 286e  .    * NM2DMT (n
+0004c8e0: 6575 726f 6d65 6c61 6e69 6e29 0a0a 2020  euromelanin)..  
+0004c8f0: 2020 6f74 6865 7220 6d6f 6461 6c69 7469    other modaliti
+0004c900: 6573 206d 6179 2062 6520 6164 6465 6420  es may be added 
+0004c910: 6c61 7465 7220 2e2e 2e0a 0a20 2020 2022  later .....    "
+0004c920: 7472 7573 7420 6d65 2c20 6920 6b6e 6f77  trust me, i know
+0004c930: 2077 6861 7420 6927 6d20 646f 696e 6722   what i'm doing"
+0004c940: 202d 2073 6c65 6467 6568 616d 6d65 720a   - sledgehammer.
+0004c950: 0a20 2020 2063 6f6e 7665 7274 2074 6f20  .    convert to 
+0004c960: 7079 6e62 2076 6961 3a0a 2020 2020 2020  pynb via:.      
+0004c970: 2020 7032 6a20 6d6d 2e70 7920 2d6f 0a0a    p2j mm.py -o..
+0004c980: 2020 2020 636f 6e76 6572 7420 7468 6520      convert the 
+0004c990: 6970 796e 6220 746f 2068 746d 6c20 7669  ipynb to html vi
+0004c9a0: 613a 0a20 2020 2020 2020 206a 7570 7974  a:.        jupyt
+0004c9b0: 6572 206e 6263 6f6e 7665 7274 2041 4e54  er nbconvert ANT
+0004c9c0: 7350 794d 4d2f 7465 7374 732f 6d6d 2e69  sPyMM/tests/mm.i
+0004c9d0: 7079 6e62 202d 2d65 7865 6375 7465 202d  pynb --execute -
+0004c9e0: 2d74 6f20 6874 6d6c 0a0a 2020 2020 7468  -to html..    th
+0004c9f0: 6973 2066 756e 6374 696f 6e20 646f 6573  is function does
+0004ca00: 206e 6f74 2061 7373 756d 6520 4e52 4720   not assume NRG 
+0004ca10: 666f 726d 6174 2066 6f72 2074 6865 2069  format for the i
+0004ca20: 6e70 7574 2064 6174 6120 2e2e 2e2e 0a0a  nput data ......
+0004ca30: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+0004ca40: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
+0004ca50: 0a0a 2020 2020 7374 7564 7963 7376 203a  ..    studycsv :
+0004ca60: 206d 7573 7420 6861 7665 2063 6f6c 756d   must have colum
+0004ca70: 6e73 3a0a 2020 2020 2020 2020 2d20 7375  ns:.        - su
+0004ca80: 626a 6563 7449 440a 2020 2020 2020 2020  bjectID.        
+0004ca90: 2d20 6461 7465 206f 7220 7365 7373 696f  - date or sessio
+0004caa0: 6e0a 2020 2020 2020 2020 2d20 696d 6167  n.        - imag
+0004cab0: 6549 440a 2020 2020 2020 2020 2d20 6d6f  eID.        - mo
+0004cac0: 6461 6c69 7479 0a20 2020 2020 2020 202d  dality.        -
+0004cad0: 2073 6f75 7263 6564 6972 0a20 2020 2020   sourcedir.     
+0004cae0: 2020 202d 206f 7574 7075 7464 6972 0a20     - outputdir. 
+0004caf0: 2020 2020 2020 202d 2066 696c 656e 616d         - filenam
+0004cb00: 6520 2870 6174 6820 746f 2074 6865 2074  e (path to the t
+0004cb10: 3120 696d 6167 6529 0a20 2020 2020 2020  1 image).       
+0004cb20: 206f 7468 6572 2072 656c 6576 616e 7420   other relevant 
+0004cb30: 636f 6c75 6d6e 7320 696e 636c 7564 6520  columns include 
+0004cb40: 6e6d 6964 312d 3130 2c20 7273 6669 6431  nmid1-10, rsfid1
+0004cb50: 2c20 7273 6669 6432 2c20 6474 6964 312c  , rsfid2, dtid1,
+0004cb60: 2064 7469 6432 2c20 666c 6169 7269 643b   dtid2, flairid;
+0004cb70: 0a20 2020 2020 2020 2074 6865 7365 2070  .        these p
+0004cb80: 726f 7669 6465 2066 696c 656e 616d 6573  rovide filenames
+0004cb90: 2066 6f72 2074 6865 7365 206d 6f64 616c   for these modal
+0004cba0: 6974 6965 733a 206e 6d3d 6e65 7572 6f6d  ities: nm=neurom
+0004cbb0: 656c 616e 696e 2c20 6474 693d 6469 6666  elanin, dti=diff
+0004cbc0: 7573 696f 6e20 7465 6e73 6f72 2c0a 2020  usion tensor,.  
+0004cbd0: 2020 2020 2020 7273 663d 7265 7374 696e        rsf=restin
+0004cbe0: 6720 7374 6174 6520 666d 7269 2c20 666c  g state fmri, fl
+0004cbf0: 6169 723d 5432 466c 6169 722e 2020 6e6f  air=T2Flair.  no
+0004cc00: 6e65 206f 6620 7468 6573 6520 6172 6520  ne of these are 
+0004cc10: 7265 7175 6972 6564 2e20 6f6e 6c79 0a20  required. only. 
+0004cc20: 2020 2020 2020 2074 3120 6973 2072 6571         t1 is req
+0004cc30: 7569 7265 642e 2072 7366 6964 312f 7273  uired. rsfid1/rs
+0004cc40: 6669 6432 2077 696c 6c20 6265 2070 726f  fid2 will be pro
+0004cc50: 6365 7373 6564 206a 6f69 6e74 6c79 2e20  cessed jointly. 
+0004cc60: 7361 6d65 2066 6f72 2064 7469 6431 2f64  same for dtid1/d
+0004cc70: 7469 6432 2061 6e64 206e 6d69 642a 2e0a  tid2 and nmid*..
+0004cc80: 2020 2020 2020 2020 7365 6520 616e 7473          see ants
+0004cc90: 7079 6d6d 2e67 656e 6572 6174 655f 6d6d  pymm.generate_mm
+0004cca0: 5f64 6174 6166 7261 6d65 0a0a 2020 2020  _dataframe..    
+0004ccb0: 736f 7572 6365 6469 7220 3a20 6120 7374  sourcedir : a st
+0004ccc0: 7564 7920 7370 6563 6966 6963 2066 6f6c  udy specific fol
+0004ccd0: 6465 7220 636f 6e74 6169 6e69 6e67 2069  der containing i
+0004cce0: 6e64 6976 6964 7561 6c20 7375 626a 6563  ndividual subjec
+0004ccf0: 7420 666f 6c64 6572 730a 0a20 2020 206f  t folders..    o
+0004cd00: 7574 7075 7464 6972 203a 2061 2073 7475  utputdir : a stu
+0004cd10: 6479 2073 7065 6369 6669 6320 666f 6c64  dy specific fold
+0004cd20: 6572 2077 6865 7265 2069 6e64 6976 6964  er where individ
+0004cd30: 7561 6c20 6f75 7470 7574 2073 7562 6a65  ual output subje
+0004cd40: 6374 2066 6f6c 6465 7273 2077 696c 6c20  ct folders will 
+0004cd50: 676f 0a0a 2020 2020 6669 6c65 6e61 6d65  go..    filename
+0004cd60: 203a 2074 6865 2072 6177 2069 6d61 6765   : the raw image
+0004cd70: 2066 696c 656e 616d 6520 2866 756c 6c20   filename (full 
+0004cd80: 7061 7468 290a 0a20 2020 2073 726d 6f64  path)..    srmod
+0004cd90: 656c 5f54 3120 3a20 4661 6c73 6520 2864  el_T1 : False (d
+0004cda0: 6566 6175 6c74 2920 2d20 7769 6c6c 2061  efault) - will a
+0004cdb0: 6464 2061 2067 7265 6174 2064 6561 6c20  dd a great deal 
+0004cdc0: 6f66 2074 696d 6520 2d20 6f72 2068 3520  of time - or h5 
+0004cdd0: 6669 6c65 6e61 6d65 2c20 3220 6368 616e  filename, 2 chan
+0004cde0: 0a0a 2020 2020 7372 6d6f 6465 6c5f 4e4d  ..    srmodel_NM
+0004cdf0: 203a 2046 616c 7365 2028 6465 6661 756c   : False (defaul
+0004ce00: 7429 202d 2077 696c 6c20 6164 6420 6120  t) - will add a 
+0004ce10: 6772 6561 7420 6465 616c 206f 6620 7469  great deal of ti
+0004ce20: 6d65 202d 206f 7220 6835 2066 696c 656e  me - or h5 filen
+0004ce30: 616d 652c 2031 2063 6861 6e0a 0a20 2020  ame, 1 chan..   
+0004ce40: 2073 726d 6f64 656c 5f44 5449 203a 2046   srmodel_DTI : F
+0004ce50: 616c 7365 2028 6465 6661 756c 7429 202d  alse (default) -
+0004ce60: 2077 696c 6c20 6164 6420 6120 6772 6561   will add a grea
+0004ce70: 7420 6465 616c 206f 6620 7469 6d65 202d  t deal of time -
+0004ce80: 206f 7220 6835 2066 696c 656e 616d 652c   or h5 filename,
+0004ce90: 2031 2063 6861 6e0a 0a20 2020 2064 7469   1 chan..    dti
+0004cea0: 5f6d 6f74 696f 6e5f 636f 7272 6563 7420  _motion_correct 
+0004ceb0: 3a20 4e6f 6e65 2c20 5269 6769 6420 6f72  : None, Rigid or
+0004cec0: 2053 794e 0a0a 2020 2020 6474 695f 6465   SyN..    dti_de
+0004ced0: 6e6f 6973 6520 3a20 626f 6f6c 6561 6e0a  noise : boolean.
+0004cee0: 0a20 2020 206e 7267 5f6d 6f64 616c 6974  .    nrg_modalit
+0004cef0: 795f 6c69 7374 203a 206f 7074 696f 6e61  y_list : optiona
+0004cf00: 6c3b 2064 6566 6175 6c74 7320 746f 204e  l; defaults to N
+0004cf10: 6f6e 653b 2075 7365 2074 6f20 666f 6375  one; use to focu
+0004cf20: 7320 6f6e 2061 2067 6976 656e 206d 6f64  s on a given mod
+0004cf30: 616c 6974 790a 0a20 2020 206e 6f72 6d61  ality..    norma
+0004cf40: 6c69 7a61 7469 6f6e 5f74 656d 706c 6174  lization_templat
+0004cf50: 6520 3a20 6f70 7469 6f6e 616c 3b20 6465  e : optional; de
+0004cf60: 6661 756c 7473 2074 6f20 4e6f 6e65 3b20  faults to None; 
+0004cf70: 6966 2070 7265 7365 6e74 2c20 616c 6c20  if present, all 
+0004cf80: 696d 6167 6573 2077 696c 6c0a 2020 2020  images will.    
+0004cf90: 2020 2020 6265 2064 6566 6f72 6d65 6420      be deformed 
+0004cfa0: 696e 746f 2074 6869 7320 7370 6163 6520  into this space 
+0004cfb0: 616e 6420 7468 6520 6465 666f 726d 6174  and the deformat
+0004cfc0: 696f 6e20 7769 6c6c 2062 6520 7374 6f72  ion will be stor
+0004cfd0: 6564 2077 6974 6820 616e 2065 7874 656e  ed with an exten
+0004cfe0: 7369 6f6e 0a20 2020 2020 2020 2072 656c  sion.        rel
+0004cff0: 6174 6564 2074 6f20 7468 6973 2076 6172  ated to this var
+0004d000: 6961 626c 652e 2020 7468 6973 2073 686f  iable.  this sho
+0004d010: 756c 6420 6265 2061 2062 7261 696e 2065  uld be a brain e
+0004d020: 7874 7261 6374 6564 2054 3177 2069 6d61  xtracted T1w ima
+0004d030: 6765 2e0a 0a20 2020 206e 6f72 6d61 6c69  ge...    normali
+0004d040: 7a61 7469 6f6e 5f74 656d 706c 6174 655f  zation_template_
+0004d050: 6f75 7470 7574 203a 206f 7074 696f 6e61  output : optiona
+0004d060: 6c20 7374 7269 6e67 3b20 6465 6661 756c  l string; defaul
+0004d070: 7473 2074 6f20 4e6f 6e65 3b20 6e61 6d69  ts to None; nami
+0004d080: 6e67 2066 6f72 2074 6865 200a 2020 2020  ng for the .    
+0004d090: 2020 2020 6e6f 726d 616c 697a 6174 696f      normalizatio
+0004d0a0: 6e5f 7465 6d70 6c61 7465 206f 7574 7075  n_template outpu
+0004d0b0: 7473 2077 6869 6368 2077 696c 6c20 6265  ts which will be
+0004d0c0: 2069 6e20 7468 6520 5431 7720 6469 7265   in the T1w dire
+0004d0d0: 6374 6f72 792e 0a0a 2020 2020 6e6f 726d  ctory...    norm
+0004d0e0: 616c 697a 6174 696f 6e5f 7465 6d70 6c61  alization_templa
+0004d0f0: 7465 5f74 7261 6e73 666f 726d 5f74 7970  te_transform_typ
+0004d100: 6520 3a20 6f70 7469 6f6e 616c 2073 7472  e : optional str
+0004d110: 696e 6720 7472 616e 7366 6f72 6d20 7479  ing transform ty
+0004d120: 7065 2070 6173 7365 6420 746f 2061 6e74  pe passed to ant
+0004d130: 732e 7265 6769 7374 7261 7469 6f6e 0a0a  s.registration..
+0004d140: 2020 2020 6e6f 726d 616c 697a 6174 696f      normalizatio
+0004d150: 6e5f 7465 6d70 6c61 7465 5f73 7061 6369  n_template_spaci
+0004d160: 6e67 203a 2033 2d74 7570 6c65 2063 6f6e  ng : 3-tuple con
+0004d170: 7472 6f6c 6c69 6e67 2074 6865 2072 6573  trolling the res
+0004d180: 6f6c 7574 696f 6e20 6174 2077 6869 6368  olution at which
+0004d190: 2072 6567 6973 7472 6174 696f 6e20 6973   registration is
+0004d1a0: 2063 6f6d 7075 7465 6420 0a20 2020 200a   computed .    .
+0004d1b0: 2020 2020 656e 616e 7469 6f6d 6f72 7068      enantiomorph
+0004d1c0: 6963 3a20 626f 6f6c 6561 6e20 2857 4950  ic: boolean (WIP
+0004d1d0: 290a 0a20 2020 2070 6572 6675 7369 6f6e  )..    perfusion
+0004d1e0: 5f74 7269 6d20 3a20 6f70 7469 6f6e 616c  _trim : optional
+0004d1f0: 2069 6e74 6567 6572 206e 756d 6265 7220   integer number 
+0004d200: 6f66 2074 696d 6520 766f 6c75 6d65 7320  of time volumes 
+0004d210: 746f 2065 7863 6c75 6465 2066 726f 6d20  to exclude from 
+0004d220: 7468 6520 6672 6f6e 7420 6f66 2074 6865  the front of the
+0004d230: 2070 6572 6675 7369 6f6e 2074 696d 6520   perfusion time 
+0004d240: 7365 7269 6573 0a0a 2020 2020 7065 7266  series..    perf
+0004d250: 7573 696f 6e5f 6d30 5f69 6d61 6765 203a  usion_m0_image :
+0004d260: 206f 7074 696f 6e61 6c20 6d30 2061 6e74   optional m0 ant
+0004d270: 7349 6d61 6765 2061 7373 6f63 6961 7465  sImage associate
+0004d280: 6420 7769 7468 2074 6865 2070 6572 6675  d with the perfu
+0004d290: 7369 6f6e 2074 696d 6520 7365 7269 6573  sion time series
+0004d2a0: 0a0a 2020 2020 7065 7266 7573 696f 6e5f  ..    perfusion_
+0004d2b0: 6d30 203a 206f 7074 696f 6e61 6c20 6c69  m0 : optional li
+0004d2c0: 7374 2063 6f6e 7461 696e 696e 6720 696e  st containing in
+0004d2d0: 6469 6365 7320 6f66 2074 6865 206d 3020  dices of the m0 
+0004d2e0: 696e 2074 6865 2070 6572 6675 7369 6f6e  in the perfusion
+0004d2f0: 2074 696d 6520 7365 7269 6573 0a0a 2020   time series..  
+0004d300: 2020 7273 665f 7570 7361 6d70 6c69 6e67    rsf_upsampling
+0004d310: 203a 206f 7074 696f 6e61 6c20 7570 7361   : optional upsa
+0004d320: 6d70 6c69 6e67 2070 6172 616d 6574 6572  mpling parameter
+0004d330: 2076 616c 7565 2069 6e20 6d6d 3b20 6966   value in mm; if
+0004d340: 2073 6574 2074 6f20 7a65 726f 2c20 6e6f   set to zero, no
+0004d350: 2075 7073 616d 706c 696e 6720 6973 2064   upsampling is d
+0004d360: 6f6e 650a 0a20 2020 2052 6574 7572 6e73  one..    Returns
+0004d370: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 0a0a  .    ---------..
+0004d380: 2020 2020 7772 6974 6573 206f 7574 7075      writes outpu
+0004d390: 7420 746f 2064 6973 6b20 616e 6420 7072  t to disk and pr
+0004d3a0: 6f64 7563 6573 2066 6967 7572 6573 0a0a  oduces figures..
+0004d3b0: 2020 2020 2222 220a 2020 2020 696d 706f      """.    impo
+0004d3c0: 7274 2074 7261 6365 6261 636b 0a20 2020  rt traceback.   
+0004d3d0: 2076 6973 7561 6c69 7a65 203d 2054 7275   visualize = Tru
+0004d3e0: 650a 2020 2020 7665 7262 6f73 6520 3d20  e.    verbose = 
+0004d3f0: 5472 7565 0a20 2020 2069 6620 7665 7262  True.    if verb
+0004d400: 6f73 653a 0a20 2020 2020 2020 2070 7269  ose:.        pri
+0004d410: 6e74 2820 7665 7273 696f 6e28 2920 290a  nt( version() ).
+0004d420: 2020 2020 6966 206e 7267 5f6d 6f64 616c      if nrg_modal
+0004d430: 6974 795f 6c69 7374 2069 7320 4e6f 6e65  ity_list is None
+0004d440: 3a0a 2020 2020 2020 2020 6e72 675f 6d6f  :.        nrg_mo
+0004d450: 6461 6c69 7479 5f6c 6973 7420 3d20 6765  dality_list = ge
+0004d460: 745f 7661 6c69 645f 6d6f 6461 6c69 7469  t_valid_modaliti
+0004d470: 6573 2829 0a20 2020 2069 6620 7374 7564  es().    if stud
+0004d480: 7963 7376 2e73 6861 7065 5b30 5d20 3c20  ycsv.shape[0] < 
+0004d490: 313a 0a20 2020 2020 2020 2072 6169 7365  1:.        raise
+0004d4a0: 2056 616c 7565 4572 726f 7228 2773 7475   ValueError('stu
+0004d4b0: 6479 6373 7620 6861 7320 6e6f 2072 6f77  dycsv has no row
+0004d4c0: 7327 290a 2020 2020 6d75 7374 6861 7665  s').    musthave
+0004d4d0: 636f 6c73 203d 205b 2770 726f 6a65 6374  cols = ['project
+0004d4e0: 4944 272c 2027 7375 626a 6563 7449 4427  ID', 'subjectID'
+0004d4f0: 2c27 6461 7465 272c 2769 6d61 6765 4944  ,'date','imageID
+0004d500: 272c 276d 6f64 616c 6974 7927 2c27 736f  ','modality','so
+0004d510: 7572 6365 6469 7227 2c27 6f75 7470 7574  urcedir','output
+0004d520: 6469 7227 2c27 6669 6c65 6e61 6d65 275d  dir','filename']
+0004d530: 0a20 2020 2066 6f72 206b 2069 6e20 7261  .    for k in ra
+0004d540: 6e67 6528 6c65 6e28 6d75 7374 6861 7665  nge(len(musthave
+0004d550: 636f 6c73 2929 3a0a 2020 2020 2020 2020  cols)):.        
+0004d560: 6966 206e 6f74 206d 7573 7468 6176 6563  if not musthavec
+0004d570: 6f6c 735b 6b5d 2069 6e20 7374 7564 7963  ols[k] in studyc
+0004d580: 7376 2e6b 6579 7328 293a 0a20 2020 2020  sv.keys():.     
+0004d590: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+0004d5a0: 7565 4572 726f 7228 2773 7475 6479 6373  ueError('studycs
+0004d5b0: 7620 6973 206d 6973 7369 6e67 2063 6f6c  v is missing col
+0004d5c0: 756d 6e20 2720 2b6d 7573 7468 6176 6563  umn ' +musthavec
+0004d5d0: 6f6c 735b 6b5d 2029 0a20 2020 2064 6566  ols[k] ).    def
+0004d5e0: 206d 616b 6577 6964 656f 7574 2820 782c   makewideout( x,
+0004d5f0: 2073 6570 6172 6174 6f72 203d 206d 7973   separator = mys
+0004d600: 6570 2029 3a0a 2020 2020 2020 2020 7265  ep ):.        re
+0004d610: 7475 726e 2078 202b 2073 6570 6172 6174  turn x + separat
+0004d620: 6f72 202b 2027 6d6d 7769 6465 2e63 7376  or + 'mmwide.csv
+0004d630: 270a 2020 2020 7465 7374 6c6f 6f70 203d  '.    testloop =
+0004d640: 2046 616c 7365 0a20 2020 2063 6f75 6e74   False.    count
+0004d650: 6572 3d30 0a20 2020 2069 6d70 6f72 7420  er=0.    import 
+0004d660: 676c 6f62 2061 7320 676c 6f62 0a20 2020  glob as glob.   
+0004d670: 2066 726f 6d20 6f73 2e70 6174 6820 696d   from os.path im
+0004d680: 706f 7274 2065 7869 7374 730a 2020 2020  port exists.    
+0004d690: 6578 5f70 6174 6820 3d20 6f73 2e70 6174  ex_path = os.pat
+0004d6a0: 682e 6578 7061 6e64 7573 6572 2820 227e  h.expanduser( "~
+0004d6b0: 2f2e 616e 7473 7079 7431 772f 2220 290a  /.antspyt1w/" ).
+0004d6c0: 2020 2020 6578 5f70 6174 686d 6d20 3d20      ex_pathmm = 
+0004d6d0: 6f73 2e70 6174 682e 6578 7061 6e64 7573  os.path.expandus
+0004d6e0: 6572 2820 227e 2f2e 616e 7473 7079 6d6d  er( "~/.antspymm
+0004d6f0: 2f22 2029 0a20 2020 2074 656d 706c 6174  /" ).    templat
+0004d700: 6566 6e20 3d20 6578 5f70 6174 6820 2b20  efn = ex_path + 
+0004d710: 2743 4954 3136 385f 5431 775f 3730 3075  'CIT168_T1w_700u
+0004d720: 6d5f 7061 645f 6164 6e69 2e6e 6969 2e67  m_pad_adni.nii.g
+0004d730: 7a27 0a20 2020 2069 6620 6e6f 7420 6578  z'.    if not ex
+0004d740: 6973 7473 2820 7465 6d70 6c61 7465 666e  ists( templatefn
+0004d750: 2029 3a0a 2020 2020 2020 2020 7072 696e   ):.        prin
+0004d760: 7428 2022 2a2a 6d69 7373 696e 6720 6669  t( "**missing fi
+0004d770: 6c65 732a 2a20 3d3e 2063 616c 6c20 6765  les** => call ge
+0004d780: 745f 6461 7461 2066 726f 6d20 6c61 7465  t_data from late
+0004d790: 7374 2061 6e74 7370 7974 3177 2061 6e64  st antspyt1w and
+0004d7a0: 2061 6e74 7370 796d 6d2e 2220 290a 2020   antspymm." ).  
+0004d7b0: 2020 2020 2020 616e 7473 7079 7431 772e        antspyt1w.
+0004d7c0: 6765 745f 6461 7461 2820 666f 7263 655f  get_data( force_
+0004d7d0: 646f 776e 6c6f 6164 3d54 7275 6520 290a  download=True ).
+0004d7e0: 2020 2020 2020 2020 6765 745f 6461 7461          get_data
+0004d7f0: 2820 666f 7263 655f 646f 776e 6c6f 6164  ( force_download
+0004d800: 3d54 7275 6520 290a 2020 2020 7465 6d70  =True ).    temp
+0004d810: 6c61 7465 203d 206d 6d5f 7265 6164 2820  late = mm_read( 
+0004d820: 7465 6d70 6c61 7465 666e 2029 2023 2052  templatefn ) # R
+0004d830: 6561 6420 696e 2074 656d 706c 6174 650a  ead in template.
+0004d840: 2020 2020 7465 7374 5f72 756e 203d 2046      test_run = F
+0004d850: 616c 7365 0a20 2020 2069 6620 7465 7374  alse.    if test
+0004d860: 5f72 756e 3a0a 2020 2020 2020 2020 7669  _run:.        vi
+0004d870: 7375 616c 697a 653d 4661 6c73 650a 2020  sualize=False.  
+0004d880: 2020 2320 6765 7420 7369 6420 616e 6420    # get sid and 
+0004d890: 6474 6964 2066 726f 6d20 7374 7564 7963  dtid from studyc
+0004d8a0: 7376 0a20 2020 2023 206d 7573 7468 6176  sv.    # musthav
+0004d8b0: 6563 6f6c 7320 3d20 5b27 7072 6f6a 6563  ecols = ['projec
+0004d8c0: 7449 4427 2c27 7375 626a 6563 7449 4427  tID','subjectID'
+0004d8d0: 2c27 6461 7465 272c 2769 6d61 6765 4944  ,'date','imageID
+0004d8e0: 272c 276d 6f64 616c 6974 7927 2c27 736f  ','modality','so
+0004d8f0: 7572 6365 6469 7227 2c27 6f75 7470 7574  urcedir','output
+0004d900: 6469 7227 2c27 6669 6c65 6e61 6d65 275d  dir','filename']
+0004d910: 0a20 2020 2070 726f 6a69 6420 3d20 7374  .    projid = st
+0004d920: 7228 7374 7564 7963 7376 5b27 7072 6f6a  r(studycsv['proj
+0004d930: 6563 7449 4427 5d2e 696c 6f63 5b30 5d29  ectID'].iloc[0])
+0004d940: 0a20 2020 2073 6964 203d 2073 7472 2873  .    sid = str(s
+0004d950: 7475 6479 6373 765b 2773 7562 6a65 6374  tudycsv['subject
+0004d960: 4944 275d 2e69 6c6f 635b 305d 290a 2020  ID'].iloc[0]).  
+0004d970: 2020 6474 6964 203d 2073 7472 2873 7475    dtid = str(stu
+0004d980: 6479 6373 765b 2764 6174 6527 5d2e 696c  dycsv['date'].il
+0004d990: 6f63 5b30 5d29 0a20 2020 2069 6964 203d  oc[0]).    iid =
+0004d9a0: 2073 7472 2873 7475 6479 6373 765b 2769   str(studycsv['i
+0004d9b0: 6d61 6765 4944 275d 2e69 6c6f 635b 305d  mageID'].iloc[0]
+0004d9c0: 290a 2020 2020 7431 6969 6455 7365 3d69  ).    t1iidUse=i
+0004d9d0: 6964 0a20 2020 206d 6f64 616c 6974 7920  id.    modality 
+0004d9e0: 3d20 7374 7228 7374 7564 7963 7376 5b27  = str(studycsv['
+0004d9f0: 6d6f 6461 6c69 7479 275d 2e69 6c6f 635b  modality'].iloc[
+0004da00: 305d 290a 2020 2020 736f 7572 6365 6469  0]).    sourcedi
+0004da10: 7220 3d20 7374 7228 7374 7564 7963 7376  r = str(studycsv
+0004da20: 5b27 736f 7572 6365 6469 7227 5d2e 696c  ['sourcedir'].il
+0004da30: 6f63 5b30 5d29 0a20 2020 206f 7574 7075  oc[0]).    outpu
+0004da40: 7464 6972 203d 2073 7472 2873 7475 6479  tdir = str(study
+0004da50: 6373 765b 276f 7574 7075 7464 6972 275d  csv['outputdir']
+0004da60: 2e69 6c6f 635b 305d 290a 2020 2020 6669  .iloc[0]).    fi
+0004da70: 6c65 6e61 6d65 203d 2073 7472 2873 7475  lename = str(stu
+0004da80: 6479 6373 765b 2766 696c 656e 616d 6527  dycsv['filename'
+0004da90: 5d2e 696c 6f63 5b30 5d29 0a20 2020 2069  ].iloc[0]).    i
+0004daa0: 6620 6e6f 7420 6578 6973 7473 2866 696c  f not exists(fil
+0004dab0: 656e 616d 6529 3a0a 2020 2020 2020 2020  ename):.        
+0004dac0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+0004dad0: 7272 6f72 2827 6d6d 5f6e 7267 2063 616e  rror('mm_nrg can
+0004dae0: 6e6f 7420 6669 6e64 2066 696c 656e 616d  not find filenam
+0004daf0: 6520 2720 2b20 6669 6c65 6e61 6d65 202b  e ' + filename +
+0004db00: 2027 2069 6e20 6d6d 5f63 7376 2720 290a   ' in mm_csv' ).
+0004db10: 0a20 2020 2023 2068 6965 7261 7263 6869  .    # hierarchi
+0004db20: 6361 6c0a 2020 2020 2320 4e4f 5445 3a20  cal.    # NOTE: 
+0004db30: 6966 2074 6865 7265 2061 7265 206d 756c  if there are mul
+0004db40: 7469 706c 6520 5431 7320 666f 7220 7468  tiple T1s for th
+0004db50: 6973 2074 696d 6520 706f 696e 742c 2073  is time point, s
+0004db60: 686f 756c 6420 7461 6b65 0a20 2020 2023  hould take.    #
+0004db70: 2074 6865 206f 6e65 2077 6974 6820 7468   the one with th
+0004db80: 6520 6869 6768 6573 7420 7265 736e 6574  e highest resnet
+0004db90: 4772 6164 650a 2020 2020 7431 666e 203d  Grade.    t1fn =
+0004dba0: 2066 696c 656e 616d 650a 2020 2020 6966   filename.    if
+0004dbb0: 206e 6f74 2065 7869 7374 7328 2074 3166   not exists( t1f
+0004dbc0: 6e20 293a 0a20 2020 2020 2020 2072 6169  n ):.        rai
+0004dbd0: 7365 2056 616c 7565 4572 726f 7228 276d  se ValueError('m
+0004dbe0: 6d5f 6e72 6720 6361 6e6e 6f74 2066 696e  m_nrg cannot fin
+0004dbf0: 6420 7468 6520 5431 7720 7769 7468 2075  d the T1w with u
+0004dc00: 6964 2027 202b 2074 3166 6e20 290a 2020  id ' + t1fn ).  
+0004dc10: 2020 7431 203d 206d 6d5f 7265 6164 2820    t1 = mm_read( 
+0004dc20: 7431 666e 2c20 6d6f 6461 6c69 7479 3d27  t1fn, modality='
+0004dc30: 5431 7727 2029 0a20 2020 206d 696e 7370  T1w' ).    minsp
+0004dc40: 6320 3d20 6e70 2e6d 696e 2861 6e74 732e  c = np.min(ants.
+0004dc50: 6765 745f 7370 6163 696e 6728 7431 2929  get_spacing(t1))
+0004dc60: 0a20 2020 206d 696e 7368 6170 6520 3d20  .    minshape = 
+0004dc70: 6e70 2e6d 696e 2874 312e 7368 6170 6529  np.min(t1.shape)
+0004dc80: 0a20 2020 2069 6620 6d69 6e73 7063 203c  .    if minspc <
+0004dc90: 2031 652d 3136 3a0a 2020 2020 2020 2020   1e-16:.        
+0004dca0: 7761 726e 696e 6773 2e77 6172 6e28 276d  warnings.warn('m
+0004dcb0: 696e 696d 756d 2073 7061 6369 6e67 2069  inimum spacing i
+0004dcc0: 6e20 5431 7720 6973 2074 6f6f 2073 6d61  n T1w is too sma
+0004dcd0: 6c6c 202d 2063 616e 6e6f 7420 7072 6f63  ll - cannot proc
+0004dce0: 6573 732e 2027 202b 2073 7472 286d 696e  ess. ' + str(min
+0004dcf0: 7370 6329 2029 0a20 2020 2020 2020 2072  spc) ).        r
+0004dd00: 6574 7572 6e0a 2020 2020 6966 206d 696e  eturn.    if min
+0004dd10: 7368 6170 6520 3c20 3332 3a0a 2020 2020  shape < 32:.    
+0004dd20: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
+0004dd30: 6e28 276d 696e 696d 756d 2073 6861 7065  n('minimum shape
+0004dd40: 2069 6e20 5431 7720 6973 2074 6f6f 2073   in T1w is too s
+0004dd50: 6d61 6c6c 202d 2063 616e 6e6f 7420 7072  mall - cannot pr
+0004dd60: 6f63 6573 732e 2027 202b 2073 7472 286d  ocess. ' + str(m
+0004dd70: 696e 7368 6170 6529 2029 0a20 2020 2020  inshape) ).     
+0004dd80: 2020 2072 6574 7572 6e0a 0a20 2020 2069     return..    i
+0004dd90: 6620 656e 616e 7469 6f6d 6f72 7068 6963  f enantiomorphic
+0004dda0: 3a0a 2020 2020 2020 2020 7431 203d 2065  :.        t1 = e
+0004ddb0: 6e61 6e74 696f 6d6f 7270 6869 635f 6669  nantiomorphic_fi
+0004ddc0: 6c6c 696e 675f 7769 7468 6f75 745f 6d61  lling_without_ma
+0004ddd0: 736b 2820 7431 2c20 6178 6973 3d30 2029  sk( t1, axis=0 )
+0004dde0: 5b30 5d0a 2020 2020 6869 6572 666e 203d  [0].    hierfn =
+0004ddf0: 206f 7574 7075 7464 6972 202b 2022 2f22   outputdir + "/"
+0004de00: 2020 2b20 7072 6f6a 6964 202b 2022 2f22    + projid + "/"
+0004de10: 202b 2073 6964 202b 2022 2f22 202b 2064   + sid + "/" + d
+0004de20: 7469 6420 2b20 222f 2220 2b20 2254 3177  tid + "/" + "T1w
+0004de30: 4869 6572 6172 6368 6963 616c 2220 2b20  Hierarchical" + 
+0004de40: 272f 2720 2b20 6969 6420 2b20 222f 2220  '/' + iid + "/" 
+0004de50: 2b20 7072 6f6a 6964 202b 206d 7973 6570  + projid + mysep
+0004de60: 202b 2073 6964 202b 206d 7973 6570 202b   + sid + mysep +
+0004de70: 2064 7469 6420 2b20 6d79 7365 7020 2b20   dtid + mysep + 
+0004de80: 2254 3177 4869 6572 6172 6368 6963 616c  "T1wHierarchical
+0004de90: 2220 2b20 6d79 7365 7020 2b20 6969 6420  " + mysep + iid 
+0004dea0: 2b20 6d79 7365 700a 2020 2020 6869 6572  + mysep.    hier
+0004deb0: 666e 5352 203d 206f 7574 7075 7464 6972  fnSR = outputdir
+0004dec0: 202b 2022 2f22 202b 2070 726f 6a69 6420   + "/" + projid 
+0004ded0: 2b20 222f 2220 202b 2073 6964 202b 2022  + "/"  + sid + "
+0004dee0: 2f22 202b 2064 7469 6420 2b20 222f 2220  /" + dtid + "/" 
+0004def0: 2b20 2254 3177 4869 6572 6172 6368 6963  + "T1wHierarchic
+0004df00: 616c 5352 2220 2b20 272f 2720 2b20 6969  alSR" + '/' + ii
+0004df10: 6420 2b20 222f 2220 2b20 7072 6f6a 6964  d + "/" + projid
+0004df20: 202b 206d 7973 6570 202b 2073 6964 202b   + mysep + sid +
+0004df30: 206d 7973 6570 202b 2064 7469 6420 2b20   mysep + dtid + 
+0004df40: 6d79 7365 7020 2b20 2254 3177 4869 6572  mysep + "T1wHier
+0004df50: 6172 6368 6963 616c 5352 2220 2b20 6d79  archicalSR" + my
+0004df60: 7365 7020 2b20 6969 6420 2b20 6d79 7365  sep + iid + myse
+0004df70: 700a 2020 2020 6869 6572 666e 7465 7374  p.    hierfntest
+0004df80: 203d 2068 6965 7266 6e20 2b20 2763 6572   = hierfn + 'cer
+0004df90: 6562 656c 6c75 6d2e 6373 7627 0a20 2020  ebellum.csv'.   
+0004dfa0: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+0004dfb0: 2020 2020 2070 7269 6e74 2820 6869 6572       print( hier
+0004dfc0: 666e 7465 7374 2029 0a20 2020 2072 6567  fntest ).    reg
+0004dfd0: 6f75 7420 3d20 7265 2e73 7562 2822 5431  out = re.sub("T1
+0004dfe0: 7748 6965 7261 7263 6869 6361 6c22 2c22  wHierarchical","
+0004dff0: 5431 7722 2c68 6965 7266 6e29 202b 2022  T1w",hierfn) + "
+0004e000: 7379 6e22 0a20 2020 2074 656d 706c 6174  syn".    templat
+0004e010: 6554 7820 3d20 7b0a 2020 2020 2020 2020  eTx = {.        
+0004e020: 2766 7764 7472 616e 7366 6f72 6d73 273a  'fwdtransforms':
+0004e030: 205b 2072 6567 6f75 742b 2731 5761 7270   [ regout+'1Warp
+0004e040: 2e6e 6969 2e67 7a27 2c20 7265 676f 7574  .nii.gz', regout
+0004e050: 2b27 3047 656e 6572 6963 4166 6669 6e65  +'0GenericAffine
+0004e060: 2e6d 6174 275d 2c0a 2020 2020 2020 2020  .mat'],.        
+0004e070: 2769 6e76 7472 616e 7366 6f72 6d73 273a  'invtransforms':
+0004e080: 205b 2072 6567 6f75 742b 2730 4765 6e65   [ regout+'0Gene
+0004e090: 7269 6341 6666 696e 652e 6d61 7427 2c20  ricAffine.mat', 
+0004e0a0: 7265 676f 7574 2b27 3149 6e76 6572 7365  regout+'1Inverse
+0004e0b0: 5761 7270 2e6e 6969 2e67 7a27 5d20 207d  Warp.nii.gz']  }
+0004e0c0: 0a20 2020 2067 726f 7570 5478 203d 204e  .    groupTx = N
+0004e0d0: 6f6e 650a 2020 2020 2320 6d61 6b65 2074  one.    # make t
+0004e0e0: 6865 2054 3177 2064 6972 6563 746f 7279  he T1w directory
+0004e0f0: 0a20 2020 206f 732e 6d61 6b65 6469 7273  .    os.makedirs
+0004e100: 2820 6f73 2e70 6174 682e 6469 726e 616d  ( os.path.dirnam
+0004e110: 6528 7265 2e73 7562 2822 5431 7748 6965  e(re.sub("T1wHie
+0004e120: 7261 7263 6869 6361 6c22 2c22 5431 7722  rarchical","T1w"
+0004e130: 2c68 6965 7266 6e29 292c 2065 7869 7374  ,hierfn)), exist
+0004e140: 5f6f 6b3d 5472 7565 2020 290a 2020 2020  _ok=True  ).    
+0004e150: 6966 206e 6f72 6d61 6c69 7a61 7469 6f6e  if normalization
+0004e160: 5f74 656d 706c 6174 655f 6f75 7470 7574  _template_output
+0004e170: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0004e180: 2020 2020 2020 6e6f 726d 6f75 7420 3d20        normout = 
+0004e190: 7265 2e73 7562 2822 5431 7748 6965 7261  re.sub("T1wHiera
+0004e1a0: 7263 6869 6361 6c22 2c22 5431 7722 2c68  rchical","T1w",h
+0004e1b0: 6965 7266 6e29 202b 2020 6e6f 726d 616c  ierfn) +  normal
+0004e1c0: 697a 6174 696f 6e5f 7465 6d70 6c61 7465  ization_template
+0004e1d0: 5f6f 7574 7075 740a 2020 2020 2020 2020  _output.        
+0004e1e0: 7465 6d70 6c61 7465 4e6f 726d 5478 203d  templateNormTx =
+0004e1f0: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
+0004e200: 6677 6474 7261 6e73 666f 726d 7327 3a20  fwdtransforms': 
+0004e210: 5b20 6e6f 726d 6f75 742b 2731 5761 7270  [ normout+'1Warp
+0004e220: 2e6e 6969 2e67 7a27 2c20 6e6f 726d 6f75  .nii.gz', normou
+0004e230: 742b 2730 4765 6e65 7269 6341 6666 696e  t+'0GenericAffin
+0004e240: 652e 6d61 7427 5d2c 0a20 2020 2020 2020  e.mat'],.       
+0004e250: 2020 2020 2027 696e 7674 7261 6e73 666f       'invtransfo
+0004e260: 726d 7327 3a20 5b20 6e6f 726d 6f75 742b  rms': [ normout+
+0004e270: 2730 4765 6e65 7269 6341 6666 696e 652e  '0GenericAffine.
+0004e280: 6d61 7427 2c20 6e6f 726d 6f75 742b 2731  mat', normout+'1
+0004e290: 496e 7665 7273 6557 6172 702e 6e69 692e  InverseWarp.nii.
+0004e2a0: 677a 275d 2020 7d0a 2020 2020 2020 2020  gz']  }.        
+0004e2b0: 6772 6f75 7054 7820 3d20 7465 6d70 6c61  groupTx = templa
+0004e2c0: 7465 4e6f 726d 5478 5b27 6677 6474 7261  teNormTx['fwdtra
+0004e2d0: 6e73 666f 726d 7327 5d0a 2020 2020 6966  nsforms'].    if
+0004e2e0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+0004e2f0: 2020 7072 696e 7428 2022 2d3c 5245 4749    print( "-<REGI
+0004e300: 5354 5241 5449 4f4e 2045 5849 5354 454e  STRATION EXISTEN
+0004e310: 4345 3e2d 3a20 5c6e 2220 2b20 0a20 2020  CE>-: \n" + .   
+0004e320: 2020 2020 2020 2020 2020 2022 4e41 4d49             "NAMI
+0004e330: 4e47 3a20 2220 2b20 7265 676f 7574 2b27  NG: " + regout+'
+0004e340: 3047 656e 6572 6963 4166 6669 6e65 2e6d  0GenericAffine.m
+0004e350: 6174 2720 2b20 2220 5c6e 2022 202b 0a20  at' + " \n " +. 
+0004e360: 2020 2020 2020 2020 2020 2073 7472 2865             str(e
+0004e370: 7869 7374 7328 2074 656d 706c 6174 6554  xists( templateT
+0004e380: 785b 2766 7764 7472 616e 7366 6f72 6d73  x['fwdtransforms
+0004e390: 275d 5b30 5d29 2920 2b20 2220 2220 2b0a  '][0])) + " " +.
+0004e3a0: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+0004e3b0: 6578 6973 7473 2820 7465 6d70 6c61 7465  exists( template
+0004e3c0: 5478 5b27 6677 6474 7261 6e73 666f 726d  Tx['fwdtransform
+0004e3d0: 7327 5d5b 315d 2929 202b 2022 2022 202b  s'][1])) + " " +
+0004e3e0: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+0004e3f0: 2865 7869 7374 7328 2074 656d 706c 6174  (exists( templat
+0004e400: 6554 785b 2769 6e76 7472 616e 7366 6f72  eTx['invtransfor
+0004e410: 6d73 275d 5b30 5d29 2920 2b20 2220 2220  ms'][0])) + " " 
+0004e420: 2b0a 2020 2020 2020 2020 2020 2020 7374  +.            st
+0004e430: 7228 6578 6973 7473 2820 7465 6d70 6c61  r(exists( templa
+0004e440: 7465 5478 5b27 696e 7674 7261 6e73 666f  teTx['invtransfo
+0004e450: 726d 7327 5d5b 315d 2929 2029 0a20 2020  rms'][1])) ).   
+0004e460: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+0004e470: 2020 2020 2070 7269 6e74 2820 6869 6572       print( hier
+0004e480: 666e 7465 7374 2029 0a20 2020 2068 6965  fntest ).    hie
+0004e490: 7265 7869 7374 7320 3d20 6578 6973 7473  rexists = exists
+0004e4a0: 2820 6869 6572 666e 7465 7374 2029 2061  ( hierfntest ) a
+0004e4b0: 6e64 2065 7869 7374 7328 2074 656d 706c  nd exists( templ
+0004e4c0: 6174 6554 785b 2766 7764 7472 616e 7366  ateTx['fwdtransf
+0004e4d0: 6f72 6d73 275d 5b30 5d29 2061 6e64 2065  orms'][0]) and e
+0004e4e0: 7869 7374 7328 2074 656d 706c 6174 6554  xists( templateT
+0004e4f0: 785b 2766 7764 7472 616e 7366 6f72 6d73  x['fwdtransforms
+0004e500: 275d 5b31 5d29 2061 6e64 2065 7869 7374  '][1]) and exist
+0004e510: 7328 2074 656d 706c 6174 6554 785b 2769  s( templateTx['i
+0004e520: 6e76 7472 616e 7366 6f72 6d73 275d 5b30  nvtransforms'][0
+0004e530: 5d29 2061 6e64 2065 7869 7374 7328 2074  ]) and exists( t
+0004e540: 656d 706c 6174 6554 785b 2769 6e76 7472  emplateTx['invtr
+0004e550: 616e 7366 6f72 6d73 275d 5b31 5d29 0a20  ansforms'][1]). 
+0004e560: 2020 2068 6965 7220 3d20 4e6f 6e65 0a20     hier = None. 
+0004e570: 2020 2069 6620 6e6f 7420 6869 6572 6578     if not hierex
+0004e580: 6973 7473 2061 6e64 206e 6f74 2074 6573  ists and not tes
+0004e590: 746c 6f6f 703a 0a20 2020 2020 2020 2073  tloop:.        s
+0004e5a0: 7562 6a65 6374 7072 6f70 6174 6820 3d20  ubjectpropath = 
+0004e5b0: 6f73 2e70 6174 682e 6469 726e 616d 6528  os.path.dirname(
+0004e5c0: 2068 6965 7266 6e20 290a 2020 2020 2020   hierfn ).      
+0004e5d0: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+0004e5e0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0004e5f0: 2073 7562 6a65 6374 7072 6f70 6174 6820   subjectpropath 
+0004e600: 290a 2020 2020 2020 2020 6f73 2e6d 616b  ).        os.mak
+0004e610: 6564 6972 7328 2073 7562 6a65 6374 7072  edirs( subjectpr
+0004e620: 6f70 6174 682c 2065 7869 7374 5f6f 6b3d  opath, exist_ok=
+0004e630: 5472 7565 2020 290a 2020 2020 2020 2020  True  ).        
+0004e640: 6869 6572 203d 2061 6e74 7370 7974 3177  hier = antspyt1w
+0004e650: 2e68 6965 7261 7263 6869 6361 6c28 2074  .hierarchical( t
+0004e660: 312c 2068 6965 7266 6e2c 206c 6162 656c  1, hierfn, label
+0004e670: 735f 746f 5f72 6567 6973 7465 723d 4e6f  s_to_register=No
+0004e680: 6e65 2029 0a20 2020 2020 2020 2061 6e74  ne ).        ant
+0004e690: 7370 7974 3177 2e77 7269 7465 5f68 6965  spyt1w.write_hie
+0004e6a0: 7261 7263 6869 6361 6c28 2068 6965 722c  rarchical( hier,
+0004e6b0: 2068 6965 7266 6e20 290a 2020 2020 2020   hierfn ).      
+0004e6c0: 2020 7431 7769 6465 203d 2061 6e74 7370    t1wide = antsp
+0004e6d0: 7974 3177 2e6d 6572 6765 5f68 6965 7261  yt1w.merge_hiera
+0004e6e0: 7263 6869 6361 6c5f 6373 7673 5f74 6f5f  rchical_csvs_to_
+0004e6f0: 7769 6465 5f66 6f72 6d61 7428 0a20 2020  wide_format(.   
+0004e700: 2020 2020 2020 2020 2020 2020 2068 6965               hie
+0004e710: 725b 2764 6174 6166 7261 6d65 7327 5d2c  r['dataframes'],
+0004e720: 2069 6465 6e74 6966 6965 723d 4e6f 6e65   identifier=None
+0004e730: 2029 0a20 2020 2020 2020 2074 3177 6964   ).        t1wid
+0004e740: 652e 746f 5f63 7376 2820 6869 6572 666e  e.to_csv( hierfn
+0004e750: 202b 2027 6d6d 7769 6465 2e63 7376 2720   + 'mmwide.csv' 
+0004e760: 290a 2020 2020 2323 2323 2323 2323 2323  ).    ##########
+0004e770: 2323 2323 2323 2320 7265 6164 2074 6865  ####### read the
+0004e780: 2068 6965 7261 7263 6869 6361 6c20 6461   hierarchical da
+0004e790: 7461 2023 2323 2323 2323 2323 2323 2323  ta #############
+0004e7a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0004e7b0: 2323 0a20 2020 2023 206f 7665 722d 7772  ##.    # over-wr
+0004e7c0: 6974 6520 7468 6520 7262 7020 6461 7461  ite the rbp data
+0004e7d0: 2077 6974 6820 6120 636f 6e73 6973 7465   with a consiste
+0004e7e0: 6e74 2061 6e64 2072 6563 656e 7420 6170  nt and recent ap
+0004e7f0: 7072 6f61 6368 2023 2323 2323 2323 2323  proach #########
+0004e800: 2323 230a 2020 2020 6d79 7820 3d20 616e  ###.    myx = an
+0004e810: 7473 7079 7431 772e 696e 7370 6563 745f  tspyt1w.inspect_
+0004e820: 7261 775f 7431 2820 7431 2c20 6869 6572  raw_t1( t1, hier
+0004e830: 666e 202b 2027 7262 7027 202c 206f 7074  fn + 'rbp' , opt
+0004e840: 696f 6e3d 2762 6f74 6827 2029 0a20 2020  ion='both' ).   
+0004e850: 206d 7978 5b27 6272 6169 6e27 5d2e 746f   myx['brain'].to
+0004e860: 5f63 7376 2820 6869 6572 666e 202b 2027  _csv( hierfn + '
+0004e870: 7262 702e 6373 7627 2c20 696e 6465 783d  rbp.csv', index=
+0004e880: 4661 6c73 6520 290a 2020 2020 6d79 785b  False ).    myx[
+0004e890: 2762 7261 696e 275d 2e74 6f5f 6373 7628  'brain'].to_csv(
+0004e8a0: 2068 6965 7266 6e20 2b20 2772 6270 6272   hierfn + 'rbpbr
+0004e8b0: 6169 6e2e 6373 7627 2c20 696e 6465 783d  ain.csv', index=
+0004e8c0: 4661 6c73 6520 290a 2020 2020 6465 6c20  False ).    del 
+0004e8d0: 6d79 780a 2020 2020 6869 6572 203d 2061  myx.    hier = a
+0004e8e0: 6e74 7370 7974 3177 2e72 6561 645f 6869  ntspyt1w.read_hi
+0004e8f0: 6572 6172 6368 6963 616c 2820 6869 6572  erarchical( hier
+0004e900: 666e 2029 0a20 2020 2074 3177 6964 6520  fn ).    t1wide 
+0004e910: 3d20 616e 7473 7079 7431 772e 6d65 7267  = antspyt1w.merg
+0004e920: 655f 6869 6572 6172 6368 6963 616c 5f63  e_hierarchical_c
+0004e930: 7376 735f 746f 5f77 6964 655f 666f 726d  svs_to_wide_form
+0004e940: 6174 280a 2020 2020 2020 2020 6869 6572  at(.        hier
+0004e950: 5b27 6461 7461 6672 616d 6573 275d 2c20  ['dataframes'], 
+0004e960: 6964 656e 7469 6669 6572 3d4e 6f6e 6520  identifier=None 
+0004e970: 290a 2020 2020 7267 7261 6465 203d 2073  ).    rgrade = s
+0004e980: 7472 2820 7431 7769 6465 5b27 7265 736e  tr( t1wide['resn
+0004e990: 6574 4772 6164 6527 5d2e 696c 6f63 5b30  etGrade'].iloc[0
+0004e9a0: 5d20 290a 2020 2020 6966 2074 3177 6964  ] ).    if t1wid
+0004e9b0: 655b 2772 6573 6e65 7447 7261 6465 275d  e['resnetGrade']
+0004e9c0: 2e69 6c6f 635b 305d 203c 2030 2e32 303a  .iloc[0] < 0.20:
+0004e9d0: 0a20 2020 2020 2020 2077 6172 6e69 6e67  .        warning
+0004e9e0: 732e 7761 726e 2827 5431 7720 7175 616c  s.warn('T1w qual
+0004e9f0: 6974 7920 6368 6563 6b20 696e 6469 6361  ity check indica
+0004ea00: 7465 7320 6661 696c 7572 653a 2027 202b  tes failure: ' +
+0004ea10: 2072 6772 6164 6520 2b20 2220 7769 6c6c   rgrade + " will
+0004ea20: 206e 6f74 2070 726f 6365 7373 2e22 2029   not process." )
+0004ea30: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
+0004ea40: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0004ea50: 2020 7072 696e 7428 2754 3177 2071 7561    print('T1w qua
+0004ea60: 6c69 7479 2063 6865 636b 2069 6e64 6963  lity check indic
+0004ea70: 6174 6573 2073 7563 6365 7373 3a20 2720  ates success: ' 
+0004ea80: 2b20 7267 7261 6465 202b 2022 2077 696c  + rgrade + " wil
+0004ea90: 6c20 7072 6f63 6573 732e 2220 290a 0a20  l process." ).. 
+0004eaa0: 2020 2069 6620 7372 6d6f 6465 6c5f 5431     if srmodel_T1
+0004eab0: 2069 7320 6e6f 7420 4661 6c73 6520 3a0a   is not False :.
+0004eac0: 2020 2020 2020 2020 6869 6572 666e 7465          hierfnte
+0004ead0: 7374 203d 2068 6965 7266 6e53 5220 2b20  st = hierfnSR + 
+0004eae0: 276d 746c 2e63 7376 270a 2020 2020 2020  'mtl.csv'.      
+0004eaf0: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+0004eb00: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0004eb10: 2068 6965 7266 6e74 6573 7420 290a 2020   hierfntest ).  
+0004eb20: 2020 2020 2020 6869 6572 6578 6973 7473        hierexists
+0004eb30: 203d 2065 7869 7374 7328 2068 6965 7266   = exists( hierf
+0004eb40: 6e74 6573 7420 2920 2320 4649 584d 4520  ntest ) # FIXME 
+0004eb50: 7368 6f75 6c64 2074 6573 7420 7468 6973  should test this
+0004eb60: 2065 7870 6c69 6369 746c 7920 6275 7420   explicitly but 
+0004eb70: 7765 2061 7373 756d 6520 6974 2068 6572  we assume it her
+0004eb80: 650a 2020 2020 2020 2020 6966 206e 6f74  e.        if not
+0004eb90: 2068 6965 7265 7869 7374 733a 0a20 2020   hierexists:.   
+0004eba0: 2020 2020 2020 2020 2073 7562 6a65 6374           subject
+0004ebb0: 7072 6f70 6174 6820 3d20 6f73 2e70 6174  propath = os.pat
+0004ebc0: 682e 6469 726e 616d 6528 2068 6965 7266  h.dirname( hierf
+0004ebd0: 6e53 5220 290a 2020 2020 2020 2020 2020  nSR ).          
+0004ebe0: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+0004ebf0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0004ec00: 696e 7428 2073 7562 6a65 6374 7072 6f70  int( subjectprop
+0004ec10: 6174 6820 290a 2020 2020 2020 2020 2020  ath ).          
+0004ec20: 2020 6f73 2e6d 616b 6564 6972 7328 2073    os.makedirs( s
+0004ec30: 7562 6a65 6374 7072 6f70 6174 682c 2065  ubjectpropath, e
+0004ec40: 7869 7374 5f6f 6b3d 5472 7565 2020 290a  xist_ok=True  ).
+0004ec50: 2020 2020 2020 2020 2020 2020 2320 6869              # hi
+0004ec60: 6572 6172 6368 6963 616c 5f74 6f5f 7372  erarchical_to_sr
+0004ec70: 2874 3168 6965 722c 2073 725f 6d6f 6465  (t1hier, sr_mode
+0004ec80: 6c2c 2074 6973 7375 655f 7372 3d46 616c  l, tissue_sr=Fal
+0004ec90: 7365 2c20 626c 656e 6469 6e67 3d30 2e35  se, blending=0.5
+0004eca0: 2c20 7665 7262 6f73 653d 4661 6c73 6529  , verbose=False)
+0004ecb0: 0a20 2020 2020 2020 2020 2020 2062 6573  .            bes
+0004ecc0: 7475 7020 3d20 7369 712e 6f70 7469 6d69  tup = siq.optimi
+0004ecd0: 7a65 5f75 7073 616d 706c 696e 675f 7368  ze_upsampling_sh
+0004ece0: 6170 6528 2061 6e74 732e 6765 745f 7370  ape( ants.get_sp
+0004ecf0: 6163 696e 6728 7431 292c 206d 6f64 616c  acing(t1), modal
+0004ed00: 6974 793d 2754 3127 2029 0a20 2020 2020  ity='T1' ).     
+0004ed10: 2020 2020 2020 206d 646c 666e 203d 2065         mdlfn = e
+0004ed20: 785f 7061 7468 6d6d 202b 2022 7369 715f  x_pathmm + "siq_
+0004ed30: 6465 6661 756c 745f 7369 7372 5f22 202b  default_sisr_" +
+0004ed40: 2062 6573 7475 7020 2b20 225f 3263 6861   bestup + "_2cha
+0004ed50: 6e5f 6665 6174 7667 674c 365f 706f 7374  n_featvggL6_post
+0004ed60: 7365 675f 6265 7374 5f6d 646c 2e68 3522  seg_best_mdl.h5"
+0004ed70: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0004ed80: 6973 696e 7374 616e 6365 2820 7372 6d6f  isinstance( srmo
+0004ed90: 6465 6c5f 5431 2c20 7374 7220 293a 0a20  del_T1, str ):. 
+0004eda0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0004edb0: 646c 666e 203d 206f 732e 7061 7468 2e6a  dlfn = os.path.j
+0004edc0: 6f69 6e28 2065 785f 7061 7468 6d6d 2c20  oin( ex_pathmm, 
+0004edd0: 7372 6d6f 6465 6c5f 5431 2029 0a20 2020  srmodel_T1 ).   
+0004ede0: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
+0004edf0: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+0004ee00: 2020 2020 2070 7269 6e74 2820 6d64 6c66       print( mdlf
+0004ee10: 6e20 290a 2020 2020 2020 2020 2020 2020  n ).            
+0004ee20: 6966 2065 7869 7374 7328 206d 646c 666e  if exists( mdlfn
+0004ee30: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+0004ee40: 2020 2020 7372 6d6f 6465 6c5f 5431 5f6d      srmodel_T1_m
+0004ee50: 646c 203d 2074 662e 6b65 7261 732e 6d6f  dl = tf.keras.mo
+0004ee60: 6465 6c73 2e6c 6f61 645f 6d6f 6465 6c28  dels.load_model(
+0004ee70: 206d 646c 666e 2c20 636f 6d70 696c 653d   mdlfn, compile=
+0004ee80: 4661 6c73 6520 290a 2020 2020 2020 2020  False ).        
+0004ee90: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0004eea0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0004eeb0: 206d 646c 666e 202b 2022 2064 6f65 7320   mdlfn + " does 
+0004eec0: 6e6f 7420 6578 6973 7420 2d20 7769 6c6c  not exist - will
+0004eed0: 206e 6f74 2072 756e 2e22 290a 2020 2020   not run.").    
+0004eee0: 2020 2020 2020 2020 6869 6572 5352 203d          hierSR =
+0004eef0: 2061 6e74 7370 7974 3177 2e68 6965 7261   antspyt1w.hiera
+0004ef00: 7263 6869 6361 6c5f 746f 5f73 7228 2068  rchical_to_sr( h
+0004ef10: 6965 722c 2073 726d 6f64 656c 5f54 315f  ier, srmodel_T1_
+0004ef20: 6d64 6c2c 2062 6c65 6e64 696e 673d 4e6f  mdl, blending=No
+0004ef30: 6e65 2c20 7469 7373 7565 5f73 723d 4661  ne, tissue_sr=Fa
+0004ef40: 6c73 6520 290a 2020 2020 2020 2020 2020  lse ).          
+0004ef50: 2020 616e 7473 7079 7431 772e 7772 6974    antspyt1w.writ
+0004ef60: 655f 6869 6572 6172 6368 6963 616c 2820  e_hierarchical( 
+0004ef70: 6869 6572 5352 2c20 6869 6572 666e 5352  hierSR, hierfnSR
+0004ef80: 2029 0a20 2020 2020 2020 2020 2020 2074   ).            t
+0004ef90: 3177 6964 6553 5220 3d20 616e 7473 7079  1wideSR = antspy
+0004efa0: 7431 772e 6d65 7267 655f 6869 6572 6172  t1w.merge_hierar
+0004efb0: 6368 6963 616c 5f63 7376 735f 746f 5f77  chical_csvs_to_w
+0004efc0: 6964 655f 666f 726d 6174 280a 2020 2020  ide_format(.    
+0004efd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004efe0: 6869 6572 5352 5b27 6461 7461 6672 616d  hierSR['datafram
+0004eff0: 6573 275d 2c20 6964 656e 7469 6669 6572  es'], identifier
+0004f000: 3d4e 6f6e 6520 290a 2020 2020 2020 2020  =None ).        
+0004f010: 2020 2020 7431 7769 6465 5352 2e74 6f5f      t1wideSR.to_
+0004f020: 6373 7628 2068 6965 7266 6e53 5220 2b20  csv( hierfnSR + 
+0004f030: 276d 6d77 6964 652e 6373 7627 2029 0a20  'mmwide.csv' ). 
+0004f040: 2020 2068 6965 7220 3d20 616e 7473 7079     hier = antspy
+0004f050: 7431 772e 7265 6164 5f68 6965 7261 7263  t1w.read_hierarc
+0004f060: 6869 6361 6c28 2068 6965 7266 6e20 290a  hical( hierfn ).
+0004f070: 2020 2020 6966 2065 7869 7374 7328 2068      if exists( h
+0004f080: 6965 7266 6e20 2b20 276d 6d77 6964 652e  ierfn + 'mmwide.
+0004f090: 6373 7627 2029 203a 0a20 2020 2020 2020  csv' ) :.       
+0004f0a0: 2074 3177 6964 6520 3d20 7064 2e72 6561   t1wide = pd.rea
+0004f0b0: 645f 6373 7628 2068 6965 7266 6e20 2b20  d_csv( hierfn + 
+0004f0c0: 276d 6d77 6964 652e 6373 7627 2029 0a20  'mmwide.csv' ). 
+0004f0d0: 2020 2065 6c69 6620 6e6f 7420 7465 7374     elif not test
+0004f0e0: 6c6f 6f70 3a0a 2020 2020 2020 2020 7431  loop:.        t1
+0004f0f0: 7769 6465 203d 2061 6e74 7370 7974 3177  wide = antspyt1w
+0004f100: 2e6d 6572 6765 5f68 6965 7261 7263 6869  .merge_hierarchi
+0004f110: 6361 6c5f 6373 7673 5f74 6f5f 7769 6465  cal_csvs_to_wide
+0004f120: 5f66 6f72 6d61 7428 0a20 2020 2020 2020  _format(.       
+0004f130: 2020 2020 2020 2020 2068 6965 725b 2764           hier['d
+0004f140: 6174 6166 7261 6d65 7327 5d2c 2069 6465  ataframes'], ide
+0004f150: 6e74 6966 6965 723d 4e6f 6e65 2029 0a20  ntifier=None ). 
+0004f160: 2020 2069 6620 6e6f 7420 7465 7374 6c6f     if not testlo
+0004f170: 6f70 3a0a 2020 2020 2020 2020 7431 696d  op:.        t1im
+0004f180: 6762 726e 203d 2068 6965 725b 2762 7261  gbrn = hier['bra
+0004f190: 696e 5f6e 345f 646e 7a27 5d0a 2020 2020  in_n4_dnz'].    
+0004f1a0: 2020 2020 7431 6174 726f 706f 7320 3d20      t1atropos = 
+0004f1b0: 6869 6572 5b27 646b 745f 7061 7263 275d  hier['dkt_parc']
+0004f1c0: 5b27 7469 7373 7565 5f73 6567 6d65 6e74  ['tissue_segment
+0004f1d0: 6174 696f 6e27 5d0a 0a20 2020 2069 6620  ation']..    if 
+0004f1e0: 6e6f 7420 6578 6973 7473 2820 7265 676f  not exists( rego
+0004f1f0: 7574 202b 2022 6c6f 676a 6163 6f62 6961  ut + "logjacobia
+0004f200: 6e2e 6e69 692e 677a 2220 2920 6f72 206e  n.nii.gz" ) or n
+0004f210: 6f74 2065 7869 7374 7328 2072 6567 6f75  ot exists( regou
+0004f220: 742b 2731 5761 7270 2e6e 6969 2e67 7a27  t+'1Warp.nii.gz'
+0004f230: 2029 3a0a 2020 2020 2020 2020 6966 2076   ):.        if v
+0004f240: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+0004f250: 2020 2020 7072 696e 7428 2773 7461 7274      print('start
+0004f260: 2074 3120 7265 6769 7374 7261 7469 6f6e   t1 registration
+0004f270: 2729 0a20 2020 2020 2020 2065 785f 7061  ').        ex_pa
+0004f280: 7468 203d 206f 732e 7061 7468 2e65 7870  th = os.path.exp
+0004f290: 616e 6475 7365 7228 2022 7e2f 2e61 6e74  anduser( "~/.ant
+0004f2a0: 7370 7974 3177 2f22 2029 0a20 2020 2020  spyt1w/" ).     
+0004f2b0: 2020 2074 656d 706c 6174 6566 6e20 3d20     templatefn = 
+0004f2c0: 6578 5f70 6174 6820 2b20 2743 4954 3136  ex_path + 'CIT16
+0004f2d0: 385f 5431 775f 3730 3075 6d5f 7061 645f  8_T1w_700um_pad_
+0004f2e0: 6164 6e69 2e6e 6969 2e67 7a27 0a20 2020  adni.nii.gz'.   
+0004f2f0: 2020 2020 2074 656d 706c 6174 6520 3d20       template = 
+0004f300: 6d6d 5f72 6561 6428 2074 656d 706c 6174  mm_read( templat
+0004f310: 6566 6e20 290a 2020 2020 2020 2020 7465  efn ).        te
+0004f320: 6d70 6c61 7465 203d 2061 6e74 732e 7265  mplate = ants.re
+0004f330: 7361 6d70 6c65 5f69 6d61 6765 2820 7465  sample_image( te
+0004f340: 6d70 6c61 7465 2c20 5b31 2c31 2c31 5d2c  mplate, [1,1,1],
+0004f350: 2075 7365 5f76 6f78 656c 733d 4661 6c73   use_voxels=Fals
+0004f360: 6520 290a 2020 2020 2020 2020 7431 7265  e ).        t1re
+0004f370: 6720 3d20 616e 7473 2e72 6567 6973 7472  g = ants.registr
+0004f380: 6174 696f 6e28 2074 656d 706c 6174 652c  ation( template,
+0004f390: 200a 2020 2020 2020 2020 2020 2020 6869   .            hi
+0004f3a0: 6572 5b27 6272 6169 6e5f 6e34 5f64 6e7a  er['brain_n4_dnz
+0004f3b0: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+0004f3c0: 2261 6e74 7352 6567 6973 7472 6174 696f  "antsRegistratio
+0004f3d0: 6e53 794e 5175 6963 6b52 6570 726f 5b73  nSyNQuickRepro[s
+0004f3e0: 5d22 2c20 6f75 7470 7265 6669 7820 3d20  ]", outprefix = 
+0004f3f0: 7265 676f 7574 2c20 7665 7262 6f73 653d  regout, verbose=
+0004f400: 4661 6c73 6520 290a 2020 2020 2020 2020  False ).        
+0004f410: 6d79 6a61 6320 3d20 616e 7473 2e63 7265  myjac = ants.cre
+0004f420: 6174 655f 6a61 636f 6269 616e 5f64 6574  ate_jacobian_det
+0004f430: 6572 6d69 6e61 6e74 5f69 6d61 6765 2820  erminant_image( 
+0004f440: 7465 6d70 6c61 7465 2c0a 2020 2020 2020  template,.      
+0004f450: 2020 2020 2020 7431 7265 675b 2766 7764        t1reg['fwd
+0004f460: 7472 616e 7366 6f72 6d73 275d 5b30 5d2c  transforms'][0],
+0004f470: 2064 6f5f 6c6f 673d 5472 7565 2c20 6765   do_log=True, ge
+0004f480: 6f6d 3d54 7275 6520 290a 2020 2020 2020  om=True ).      
+0004f490: 2020 696d 6167 655f 7772 6974 655f 7769    image_write_wi
+0004f4a0: 7468 5f74 6875 6d62 6e61 696c 2820 6d79  th_thumbnail( my
+0004f4b0: 6a61 632c 2072 6567 6f75 7420 2b20 226c  jac, regout + "l
+0004f4c0: 6f67 6a61 636f 6269 616e 2e6e 6969 2e67  ogjacobian.nii.g
+0004f4d0: 7a22 2c20 7468 756d 623d 4661 6c73 6520  z", thumb=False 
+0004f4e0: 290a 2020 2020 2020 2020 6966 2076 6973  ).        if vis
+0004f4f0: 7561 6c69 7a65 3a0a 2020 2020 2020 2020  ualize:.        
+0004f500: 2020 2020 616e 7473 2e70 6c6f 7428 2061      ants.plot( a
+0004f510: 6e74 732e 694d 6174 6828 7431 7265 675b  nts.iMath(t1reg[
+0004f520: 2777 6172 7065 646d 6f76 6f75 7427 5d2c  'warpedmovout'],
+0004f530: 224e 6f72 6d61 6c69 7a65 2229 2c20 2061  "Normalize"),  a
+0004f540: 7869 733d 322c 206e 736c 6963 6573 3d32  xis=2, nslices=2
+0004f550: 312c 206e 636f 6c3d 372c 2063 726f 703d  1, ncol=7, crop=
+0004f560: 5472 7565 2c20 7469 746c 653d 2777 6172  True, title='war
+0004f570: 7065 6420 746f 2074 656d 706c 6174 6527  ped to template'
+0004f580: 2c20 6669 6c65 6e61 6d65 3d72 6567 6f75  , filename=regou
+0004f590: 742b 2274 6f74 656d 706c 6174 652e 706e  t+"totemplate.pn
+0004f5a0: 6722 2029 0a20 2020 2020 2020 2020 2020  g" ).           
+0004f5b0: 2061 6e74 732e 706c 6f74 2820 616e 7473   ants.plot( ants
+0004f5c0: 2e69 4d61 7468 286d 796a 6163 2c22 4e6f  .iMath(myjac,"No
+0004f5d0: 726d 616c 697a 6522 292c 2020 6178 6973  rmalize"),  axis
+0004f5e0: 3d32 2c20 6e73 6c69 6365 733d 3231 2c20  =2, nslices=21, 
+0004f5f0: 6e63 6f6c 3d37 2c20 6372 6f70 3d54 7275  ncol=7, crop=Tru
+0004f600: 652c 2074 6974 6c65 3d27 6a61 636f 6269  e, title='jacobi
+0004f610: 616e 272c 2066 696c 656e 616d 653d 7265  an', filename=re
+0004f620: 676f 7574 2b22 6a61 636f 6269 616e 2e70  gout+"jacobian.p
+0004f630: 6e67 2220 290a 0a20 2020 2069 6620 6e6f  ng" )..    if no
+0004f640: 726d 616c 697a 6174 696f 6e5f 7465 6d70  rmalization_temp
+0004f650: 6c61 7465 5f6f 7574 7075 7420 6973 206e  late_output is n
+0004f660: 6f74 204e 6f6e 6520 616e 6420 6e6f 726d  ot None and norm
+0004f670: 616c 697a 6174 696f 6e5f 7465 6d70 6c61  alization_templa
+0004f680: 7465 2069 7320 6e6f 7420 4e6f 6e65 3a0a  te is not None:.
+0004f690: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+0004f6a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0004f6b0: 7072 696e 7428 2262 6567 696e 2067 726f  print("begin gro
+0004f6c0: 7570 2074 656d 706c 6174 6520 7265 6769  up template regi
+0004f6d0: 7374 7261 7469 6f6e 2229 0a20 2020 2020  stration").     
+0004f6e0: 2020 2069 6620 6e6f 7420 6578 6973 7473     if not exists
+0004f6f0: 2820 6e6f 726d 6f75 742b 2730 4765 6e65  ( normout+'0Gene
+0004f700: 7269 6341 6666 696e 652e 6d61 7427 2029  ricAffine.mat' )
+0004f710: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0004f720: 206e 6f72 6d61 6c69 7a61 7469 6f6e 5f74   normalization_t
+0004f730: 656d 706c 6174 655f 7370 6163 696e 6720  emplate_spacing 
+0004f740: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0004f750: 2020 2020 2020 2020 2020 2020 206e 6f72               nor
+0004f760: 6d61 6c69 7a61 7469 6f6e 5f74 656d 706c  malization_templ
+0004f770: 6174 655f 7272 3d61 6e74 732e 7265 7361  ate_rr=ants.resa
+0004f780: 6d70 6c65 5f69 6d61 6765 286e 6f72 6d61  mple_image(norma
+0004f790: 6c69 7a61 7469 6f6e 5f74 656d 706c 6174  lization_templat
+0004f7a0: 652c 6e6f 726d 616c 697a 6174 696f 6e5f  e,normalization_
+0004f7b0: 7465 6d70 6c61 7465 5f73 7061 6369 6e67  template_spacing
+0004f7c0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+0004f7d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0004f7e0: 2020 2020 6e6f 726d 616c 697a 6174 696f      normalizatio
+0004f7f0: 6e5f 7465 6d70 6c61 7465 5f72 723d 6e6f  n_template_rr=no
+0004f800: 726d 616c 697a 6174 696f 6e5f 7465 6d70  rmalization_temp
+0004f810: 6c61 7465 0a20 2020 2020 2020 2020 2020  late.           
+0004f820: 2067 7265 6720 3d20 616e 7473 2e72 6567   greg = ants.reg
+0004f830: 6973 7472 6174 696f 6e28 200a 2020 2020  istration( .    
+0004f840: 2020 2020 2020 2020 2020 2020 6e6f 726d              norm
+0004f850: 616c 697a 6174 696f 6e5f 7465 6d70 6c61  alization_templa
+0004f860: 7465 5f72 722c 200a 2020 2020 2020 2020  te_rr, .        
+0004f870: 2020 2020 2020 2020 6869 6572 5b27 6272          hier['br
+0004f880: 6169 6e5f 6e34 5f64 6e7a 275d 2c0a 2020  ain_n4_dnz'],.  
+0004f890: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+0004f8a0: 726d 616c 697a 6174 696f 6e5f 7465 6d70  rmalization_temp
+0004f8b0: 6c61 7465 5f74 7261 6e73 666f 726d 5f74  late_transform_t
+0004f8c0: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
+0004f8d0: 2020 2020 206f 7574 7072 6566 6978 203d       outprefix =
+0004f8e0: 206e 6f72 6d6f 7574 2c20 7665 7262 6f73   normout, verbos
+0004f8f0: 653d 4661 6c73 6520 290a 2020 2020 2020  e=False ).      
+0004f900: 2020 2020 2020 6d79 6a61 6320 3d20 616e        myjac = an
+0004f910: 7473 2e63 7265 6174 655f 6a61 636f 6269  ts.create_jacobi
+0004f920: 616e 5f64 6574 6572 6d69 6e61 6e74 5f69  an_determinant_i
+0004f930: 6d61 6765 2820 7465 6d70 6c61 7465 2c0a  mage( template,.
+0004f940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f950: 2020 2020 6772 6567 5b27 6677 6474 7261      greg['fwdtra
+0004f960: 6e73 666f 726d 7327 5d5b 305d 2c20 646f  nsforms'][0], do
+0004f970: 5f6c 6f67 3d54 7275 652c 2067 656f 6d3d  _log=True, geom=
+0004f980: 5472 7565 2029 0a20 2020 2020 2020 2020  True ).         
+0004f990: 2020 2069 6d61 6765 5f77 7269 7465 5f77     image_write_w
+0004f9a0: 6974 685f 7468 756d 626e 6169 6c28 206d  ith_thumbnail( m
+0004f9b0: 796a 6163 2c20 6e6f 726d 6f75 7420 2b20  yjac, normout + 
+0004f9c0: 226c 6f67 6a61 636f 6269 616e 2e6e 6969  "logjacobian.nii
+0004f9d0: 2e67 7a22 2c20 7468 756d 623d 4661 6c73  .gz", thumb=Fals
+0004f9e0: 6520 290a 2020 2020 2020 2020 2020 2020  e ).            
+0004f9f0: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+0004fa00: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0004fa10: 7428 2265 6e64 2067 726f 7570 2074 656d  t("end group tem
+0004fa20: 706c 6174 6520 7265 6769 7374 7261 7469  plate registrati
+0004fa30: 6f6e 2229 0a20 2020 2020 2020 2065 6c73  on").        els
+0004fa40: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+0004fa50: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+0004fa60: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0004fa70: 2822 6772 6f75 7020 7465 6d70 6c61 7465  ("group template
+0004fa80: 2072 6567 6973 7472 6174 696f 6e20 616c   registration al
+0004fa90: 7265 6164 7920 646f 6e65 2229 0a0a 2020  ready done")..  
+0004faa0: 2020 2320 6c6f 6f70 206f 7665 7220 6d6f    # loop over mo
+0004fab0: 6461 6c69 7469 6573 2061 6e64 2074 6865  dalities and the
+0004fac0: 6e20 756e 6971 7565 2069 6d61 6765 2049  n unique image I
+0004fad0: 4473 0a20 2020 2023 2077 6520 7472 6561  Ds.    # we trea
+0004fae0: 7420 4e4d 2069 6e20 6120 2273 7065 6369  t NM in a "speci
+0004faf0: 616c 2220 7761 7920 2d2d 2061 6767 7265  al" way -- aggre
+0004fb00: 6761 7469 6e67 2072 6570 6561 7473 0a20  gating repeats. 
+0004fb10: 2020 2023 206f 7468 6572 206d 6f64 616c     # other modal
+0004fb20: 6974 6965 7320 2862 6579 6f6e 6420 5431  ities (beyond T1
+0004fb30: 2920 6172 6520 7472 6561 7465 6420 696e  ) are treated in
+0004fb40: 6469 7669 6475 616c 6c79 0a20 2020 2066  dividually.    f
+0004fb50: 6f72 206f 7665 726d 6f64 5820 696e 206e  or overmodX in n
+0004fb60: 7267 5f6d 6f64 616c 6974 795f 6c69 7374  rg_modality_list
+0004fb70: 3a0a 2020 2020 2020 2020 2320 6465 6669  :.        # defi
+0004fb80: 6e65 2031 2e20 696e 7075 7420 696d 6167  ne 1. input imag
+0004fb90: 6573 2032 2e20 6f75 7470 7574 2070 7265  es 2. output pre
+0004fba0: 6669 780a 2020 2020 2020 2020 6d79 646f  fix.        mydo
+0004fbb0: 6320 3d20 646f 6373 616d 736f 6e28 206f  c = docsamson( o
+0004fbc0: 7665 726d 6f64 582c 2073 7475 6479 6373  vermodX, studycs
+0004fbd0: 763d 7374 7564 7963 7376 2c20 6f75 7470  v=studycsv, outp
+0004fbe0: 7574 6469 723d 6f75 7470 7574 6469 722c  utdir=outputdir,
+0004fbf0: 2070 726f 6a69 643d 7072 6f6a 6964 2c20   projid=projid, 
+0004fc00: 7369 643d 7369 642c 2064 7469 643d 6474  sid=sid, dtid=dt
+0004fc10: 6964 2c20 6d79 7365 703d 6d79 7365 702c  id, mysep=mysep,
+0004fc20: 7431 6969 643d 7431 6969 6455 7365 2029  t1iid=t1iidUse )
+0004fc30: 0a20 2020 2020 2020 206d 7969 6d67 7372  .        myimgsr
+0004fc40: 203d 206d 7964 6f63 5b27 696d 6167 6573   = mydoc['images
+0004fc50: 275d 0a20 2020 2020 2020 206d 796d 6d20  '].        mymm 
+0004fc60: 3d20 6d79 646f 635b 276f 7574 7072 6566  = mydoc['outpref
+0004fc70: 6978 275d 0a20 2020 2020 2020 206d 796d  ix'].        mym
+0004fc80: 6f64 203d 206d 7964 6f63 5b27 6d6f 6461  od = mydoc['moda
+0004fc90: 6c69 7479 275d 0a20 2020 2020 2020 2069  lity'].        i
+0004fca0: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+0004fcb0: 2020 2020 2020 2070 7269 6e74 2820 6d79         print( my
+0004fcc0: 646f 6320 290a 2020 2020 2020 2020 6966  doc ).        if
+0004fcd0: 206c 656e 286d 7969 6d67 7372 2920 3e20   len(myimgsr) > 
+0004fce0: 303a 0a20 2020 2020 2020 2020 2020 2064  0:.            d
+0004fcf0: 6f77 7269 7465 3d46 616c 7365 0a20 2020  owrite=False.   
+0004fd00: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
+0004fd10: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+0004fd20: 2020 2020 2070 7269 6e74 2820 276f 7665       print( 'ove
+0004fd30: 726d 6f64 5820 6973 203a 2027 202b 206f  rmodX is : ' + o
+0004fd40: 7665 726d 6f64 5820 290a 2020 2020 2020  vermodX ).      
+0004fd50: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0004fd60: 2027 6578 616d 706c 6520 696d 6167 6520   'example image 
+0004fd70: 6e61 6d65 2069 7320 3a20 2720 2029 0a20  name is : '  ). 
+0004fd80: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0004fd90: 7269 6e74 2820 6d79 696d 6773 7220 290a  rint( myimgsr ).
+0004fda0: 2020 2020 2020 2020 2020 2020 6966 206f              if o
+0004fdb0: 7665 726d 6f64 5820 3d3d 2027 4e4d 3244  vermodX == 'NM2D
+0004fdc0: 4d54 273a 0a20 2020 2020 2020 2020 2020  MT':.           
+0004fdd0: 2020 2020 2064 6f77 7269 7465 203d 2054       dowrite = T
+0004fde0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+0004fdf0: 2020 2020 7669 7375 616c 697a 6520 3d20      visualize = 
+0004fe00: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+0004fe10: 2020 2020 2073 7562 6a65 6374 7072 6f70       subjectprop
+0004fe20: 6174 6820 3d20 6f73 2e70 6174 682e 6469  ath = os.path.di
+0004fe30: 726e 616d 6528 206d 7964 6f63 5b27 6f75  rname( mydoc['ou
+0004fe40: 7470 7265 6669 7827 5d20 290a 2020 2020  tprefix'] ).    
+0004fe50: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+0004fe60: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+0004fe70: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0004fe80: 7428 2273 7562 6a65 6374 7072 6f70 6174  t("subjectpropat
+0004fe90: 6820 6973 2229 0a20 2020 2020 2020 2020  h is").         
+0004fea0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0004feb0: 2873 7562 6a65 6374 7072 6f70 6174 6829  (subjectpropath)
+0004fec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004fed0: 2020 2020 206f 732e 6d61 6b65 6469 7273       os.makedirs
+0004fee0: 2820 7375 626a 6563 7470 726f 7061 7468  ( subjectpropath
+0004fef0: 2c20 6578 6973 745f 6f6b 3d54 7275 6520  , exist_ok=True 
+0004ff00: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0004ff10: 2020 206d 7969 6d67 7372 3220 3d20 6d79     myimgsr2 = my
+0004ff20: 696d 6773 720a 2020 2020 2020 2020 2020  imgsr.          
+0004ff30: 2020 2020 2020 6d79 696d 6773 7232 2e73        myimgsr2.s
+0004ff40: 6f72 7428 290a 2020 2020 2020 2020 2020  ort().          
+0004ff50: 2020 2020 2020 6973 3464 203d 2046 616c        is4d = Fal
+0004ff60: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+0004ff70: 2020 2074 656d 7020 3d20 616e 7473 2e69     temp = ants.i
+0004ff80: 6d61 6765 5f72 6561 6428 206d 7969 6d67  mage_read( myimg
+0004ff90: 7372 325b 305d 2029 0a20 2020 2020 2020  sr2[0] ).       
+0004ffa0: 2020 2020 2020 2020 2069 6620 7465 6d70           if temp
+0004ffb0: 2e64 696d 656e 7369 6f6e 203d 3d20 343a  .dimension == 4:
+0004ffc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004ffd0: 2020 2020 2069 7334 6420 3d20 5472 7565       is4d = True
+0004ffe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004fff0: 2069 6620 6c65 6e28 206d 7969 6d67 7372   if len( myimgsr
+00050000: 3220 2920 3d3d 2031 2061 6e64 206e 6f74  2 ) == 1 and not
+00050010: 2069 7334 643a 2023 2063 6865 636b 2064   is4d: # check d
+00050020: 696d 656e 7369 6f6e 0a20 2020 2020 2020  imension.       
+00050030: 2020 2020 2020 2020 2020 2020 206d 7969               myi
+00050040: 6d67 7372 3220 3d20 6d79 696d 6773 7232  mgsr2 = myimgsr2
+00050050: 202b 206d 7969 6d67 7372 320a 2020 2020   + myimgsr2.    
+00050060: 2020 2020 2020 2020 2020 2020 6d79 6d6d              mymm
+00050070: 6f75 7420 3d20 6d61 6b65 7769 6465 6f75  out = makewideou
+00050080: 7428 206d 796d 6d20 290a 2020 2020 2020  t( mymm ).      
+00050090: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+000500a0: 626f 7365 2061 6e64 206e 6f74 2065 7869  bose and not exi
+000500b0: 7374 7328 206d 796d 6d6f 7574 2029 3a0a  sts( mymmout ):.
+000500c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000500d0: 2020 2020 7072 696e 7428 2022 4e4d 2022      print( "NM "
+000500e0: 202b 206d 796d 6d20 202b 2027 2065 7865   + mymm  + ' exe
+000500f0: 6375 7469 6f6e 2027 290a 2020 2020 2020  cution ').      
+00050100: 2020 2020 2020 2020 2020 656c 6966 2076            elif v
+00050110: 6572 626f 7365 2061 6e64 2065 7869 7374  erbose and exist
+00050120: 7328 206d 796d 6d6f 7574 2029 203a 0a20  s( mymmout ) :. 
 00050130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050140: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-00050150: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00050160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050170: 7072 696e 7428 6d64 6c66 6e29 0a20 2020  print(mdlfn).   
-00050180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050190: 2020 2020 2073 726d 6f64 656c 5f4e 4d5f       srmodel_NM_
-000501a0: 6d64 6c20 3d20 7466 2e6b 6572 6173 2e6d  mdl = tf.keras.m
-000501b0: 6f64 656c 732e 6c6f 6164 5f6d 6f64 656c  odels.load_model
-000501c0: 2820 6d64 6c66 6e2c 2063 6f6d 7069 6c65  ( mdlfn, compile
-000501d0: 3d46 616c 7365 2020 290a 2020 2020 2020  =False  ).      
-000501e0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-000501f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00050200: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00050210: 7428 206d 646c 666e 202b 2022 2064 6f65  t( mdlfn + " doe
-00050220: 7320 6e6f 7420 6578 6973 7420 2d20 776f  s not exist - wo
-00050230: 6e74 2075 7365 2053 5222 290a 2020 2020  nt use SR").    
-00050240: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00050250: 6f74 2074 6573 746c 6f6f 703a 0a20 2020  ot testloop:.   
-00050260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050270: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00050280: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-00050290: 6250 726f 2c20 6e6f 726d 5072 6f20 3d20  bPro, normPro = 
-000502a0: 6d6d 2820 7431 2c20 6869 6572 2c0a 2020  mm( t1, hier,.  
-000502b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000502c0: 2020 2020 2020 2020 2020 6e6d 5f69 6d61            nm_ima
-000502d0: 6765 5f6c 6973 7420 3d20 6e6d 6c69 7374  ge_list = nmlist
-000502e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000502f0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00050300: 6d6f 6465 6c3d 7372 6d6f 6465 6c5f 4e4d  model=srmodel_NM
-00050310: 5f6d 646c 2c0a 2020 2020 2020 2020 2020  _mdl,.          
-00050320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050330: 2020 646f 5f74 7261 6374 6f67 7261 7068    do_tractograph
-00050340: 793d 4661 6c73 652c 0a20 2020 2020 2020  y=False,.       
-00050350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050360: 2020 2020 2064 6f5f 6b6b 3d46 616c 7365       do_kk=False
-00050370: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00050380: 2020 2020 2020 2020 2020 2020 2020 646f                do
-00050390: 5f6e 6f72 6d61 6c69 7a61 7469 6f6e 3d74  _normalization=t
-000503a0: 656d 706c 6174 6554 782c 0a20 2020 2020  emplateTx,.     
-000503b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000503c0: 2020 2020 2020 2067 726f 7570 5f74 656d         group_tem
-000503d0: 706c 6174 6520 3d20 6e6f 726d 616c 697a  plate = normaliz
-000503e0: 6174 696f 6e5f 7465 6d70 6c61 7465 2c0a  ation_template,.
-000503f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050400: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
-00050410: 705f 7472 616e 7366 6f72 6d20 3d20 6772  p_transform = gr
-00050420: 6f75 7054 782c 0a20 2020 2020 2020 2020  oupTx,.         
-00050430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050440: 2020 2074 6573 745f 7275 6e3d 7465 7374     test_run=test
-00050450: 5f72 756e 2c0a 2020 2020 2020 2020 2020  _run,.          
-00050460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050470: 2020 7665 7262 6f73 653d 5472 7565 2029    verbose=True )
-00050480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00050490: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-000504a0: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
-000504b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000504c0: 2020 2020 6572 726f 725f 696e 666f 203d      error_info =
-000504d0: 2074 7261 6365 6261 636b 2e66 6f72 6d61   traceback.forma
-000504e0: 745f 6578 6328 290a 2020 2020 2020 2020  t_exc().        
+00050140: 2020 2070 7269 6e74 2820 224e 4d20 2220     print( "NM " 
+00050150: 2b20 6d79 6d6d 202b 2027 2063 6f6d 706c  + mymm + ' compl
+00050160: 6574 6520 2720 290a 2020 2020 2020 2020  ete ' ).        
+00050170: 2020 2020 2020 2020 6966 2065 7869 7374          if exist
+00050180: 7328 206d 796d 6d6f 7574 2029 3a0a 2020  s( mymmout ):.  
+00050190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000501a0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+000501b0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+000501c0: 3464 3a0a 2020 2020 2020 2020 2020 2020  4d:.            
+000501d0: 2020 2020 2020 2020 6e6d 6c69 7374 203d          nmlist =
+000501e0: 2061 6e74 732e 6e64 696d 6167 655f 746f   ants.ndimage_to
+000501f0: 5f6c 6973 7428 206d 6d5f 7265 6164 2820  _list( mm_read( 
+00050200: 6d79 696d 6773 7232 5b30 5d20 2920 290a  myimgsr2[0] ) ).
+00050210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050220: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00050230: 2020 2020 2020 2020 2020 6e6d 6c69 7374            nmlist
+00050240: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+00050250: 2020 2020 2020 2020 2020 666f 7220 7a7a            for zz
+00050260: 2069 6e20 6d79 696d 6773 7232 3a0a 2020   in myimgsr2:.  
+00050270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050280: 2020 2020 2020 6e6d 6c69 7374 2e61 7070        nmlist.app
+00050290: 656e 6428 206d 6d5f 7265 6164 2820 7a7a  end( mm_read( zz
+000502a0: 2029 2029 0a20 2020 2020 2020 2020 2020   ) ).           
+000502b0: 2020 2020 2073 726d 6f64 656c 5f4e 4d5f       srmodel_NM_
+000502c0: 6d64 6c20 3d20 4e6f 6e65 0a20 2020 2020  mdl = None.     
+000502d0: 2020 2020 2020 2020 2020 2069 6620 7372             if sr
+000502e0: 6d6f 6465 6c5f 4e4d 2069 7320 6e6f 7420  model_NM is not 
+000502f0: 4661 6c73 653a 0a20 2020 2020 2020 2020  False:.         
+00050300: 2020 2020 2020 2020 2020 2062 6573 7475             bestu
+00050310: 7020 3d20 7369 712e 6f70 7469 6d69 7a65  p = siq.optimize
+00050320: 5f75 7073 616d 706c 696e 675f 7368 6170  _upsampling_shap
+00050330: 6528 2061 6e74 732e 6765 745f 7370 6163  e( ants.get_spac
+00050340: 696e 6728 6e6d 6c69 7374 5b30 5d29 2c20  ing(nmlist[0]), 
+00050350: 6d6f 6461 6c69 7479 3d27 4e4d 272c 2072  modality='NM', r
+00050360: 6f75 6e64 6974 3d54 7275 6520 290a 2020  oundit=True ).  
+00050370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050380: 2020 6d64 6c66 6e20 3d20 6578 5f70 6174    mdlfn = ex_pat
+00050390: 686d 6d20 2b20 2273 6971 5f64 6566 6175  hmm + "siq_defau
+000503a0: 6c74 5f73 6973 725f 2220 2b20 6265 7374  lt_sisr_" + best
+000503b0: 7570 202b 2022 5f31 6368 616e 5f66 6561  up + "_1chan_fea
+000503c0: 7476 6767 4c36 5f62 6573 745f 6d64 6c2e  tvggL6_best_mdl.
+000503d0: 6835 220a 2020 2020 2020 2020 2020 2020  h5".            
+000503e0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+000503f0: 7461 6e63 6528 2073 726d 6f64 656c 5f4e  tance( srmodel_N
+00050400: 4d2c 2073 7472 2029 3a0a 2020 2020 2020  M, str ):.      
+00050410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050420: 2020 7372 6d6f 6465 6c5f 4e4d 203d 2072    srmodel_NM = r
+00050430: 652e 7375 6228 2022 6265 7374 7570 222c  e.sub( "bestup",
+00050440: 2062 6573 7475 702c 2073 726d 6f64 656c   bestup, srmodel
+00050450: 5f4e 4d20 290a 2020 2020 2020 2020 2020  _NM ).          
+00050460: 2020 2020 2020 2020 2020 2020 2020 6d64                md
+00050470: 6c66 6e20 3d20 6f73 2e70 6174 682e 6a6f  lfn = os.path.jo
+00050480: 696e 2820 6578 5f70 6174 686d 6d2c 2073  in( ex_pathmm, s
+00050490: 726d 6f64 656c 5f4e 4d20 290a 2020 2020  rmodel_NM ).    
+000504a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000504b0: 6966 2065 7869 7374 7328 206d 646c 666e  if exists( mdlfn
+000504c0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+000504d0: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+000504e0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
 000504f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050500: 7072 696e 7428 6572 726f 725f 696e 666f  print(error_info
-00050510: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00050520: 2020 2020 2020 2020 2020 7669 7375 616c            visual
-00050530: 697a 653d 4661 6c73 650a 2020 2020 2020  ize=False.      
-00050540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050550: 2020 646f 7772 6974 653d 4661 6c73 650a    dowrite=False.
-00050560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050570: 2020 2020 2020 2020 7072 696e 7428 6622          print(f"
-00050580: 616e 7473 7079 6d6d 6572 726f 7220 6f63  antspymmerror oc
-00050590: 6375 7272 6564 2077 6869 6c65 2070 726f  curred while pro
-000505a0: 6365 7373 696e 6720 7b6f 7665 726d 6f64  cessing {overmod
-000505b0: 587d 3a20 7b65 7d22 290a 2020 2020 2020  X}: {e}").      
-000505c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000505d0: 2020 7061 7373 0a20 2020 2020 2020 2020    pass.         
-000505e0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-000505f0: 7420 7465 7374 5f72 756e 3a0a 2020 2020  t test_run:.    
-00050600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050610: 2020 2020 6966 2064 6f77 7269 7465 3a0a      if dowrite:.
-00050620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050630: 2020 2020 2020 2020 2020 2020 7772 6974              writ
-00050640: 655f 6d6d 2820 6f75 7470 7574 5f70 7265  e_mm( output_pre
-00050650: 6669 783d 6d79 6d6d 2c20 6d6d 3d74 6162  fix=mymm, mm=tab
-00050660: 5072 6f2c 0a20 2020 2020 2020 2020 2020  Pro,.           
-00050670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050680: 2020 2020 206d 6d5f 6e6f 726d 3d6e 6f72       mm_norm=nor
-00050690: 6d50 726f 2c20 7431 7769 6465 3d4e 6f6e  mPro, t1wide=Non
-000506a0: 652c 2073 6570 6172 6174 6f72 3d6d 7973  e, separator=mys
-000506b0: 6570 2029 0a20 2020 2020 2020 2020 2020  ep ).           
-000506c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000506d0: 7669 7375 616c 697a 6520 3a0a 2020 2020  visualize :.    
+00050500: 2020 2020 7072 696e 7428 6d64 6c66 6e29      print(mdlfn)
+00050510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00050520: 2020 2020 2020 2020 2073 726d 6f64 656c           srmodel
+00050530: 5f4e 4d5f 6d64 6c20 3d20 7466 2e6b 6572  _NM_mdl = tf.ker
+00050540: 6173 2e6d 6f64 656c 732e 6c6f 6164 5f6d  as.models.load_m
+00050550: 6f64 656c 2820 6d64 6c66 6e2c 2063 6f6d  odel( mdlfn, com
+00050560: 7069 6c65 3d46 616c 7365 2020 290a 2020  pile=False  ).  
+00050570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050580: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00050590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000505a0: 7072 696e 7428 206d 646c 666e 202b 2022  print( mdlfn + "
+000505b0: 2064 6f65 7320 6e6f 7420 6578 6973 7420   does not exist 
+000505c0: 2d20 776f 6e74 2075 7365 2053 5222 290a  - wont use SR").
+000505d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000505e0: 6966 206e 6f74 2074 6573 746c 6f6f 703a  if not testloop:
+000505f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00050600: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00050610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050620: 2020 7461 6250 726f 2c20 6e6f 726d 5072    tabPro, normPr
+00050630: 6f20 3d20 6d6d 2820 7431 2c20 6869 6572  o = mm( t1, hier
+00050640: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00050650: 2020 2020 2020 2020 2020 2020 2020 6e6d                nm
+00050660: 5f69 6d61 6765 5f6c 6973 7420 3d20 6e6d  _image_list = nm
+00050670: 6c69 7374 2c0a 2020 2020 2020 2020 2020  list,.          
+00050680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050690: 2020 7372 6d6f 6465 6c3d 7372 6d6f 6465    srmodel=srmode
+000506a0: 6c5f 4e4d 5f6d 646c 2c0a 2020 2020 2020  l_NM_mdl,.      
+000506b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000506c0: 2020 2020 2020 646f 5f74 7261 6374 6f67        do_tractog
+000506d0: 7261 7068 793d 4661 6c73 652c 0a20 2020  raphy=False,.   
 000506e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000506f0: 2020 2020 2020 2020 6e6d 7072 6f20 3d20          nmpro = 
-00050700: 7461 6250 726f 5b27 4e4d 275d 0a20 2020  tabPro['NM'].   
+000506f0: 2020 2020 2020 2020 2064 6f5f 6b6b 3d46           do_kk=F
+00050700: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
 00050710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050720: 2020 2020 2020 2020 206d 7973 6c20 3d20           mysl = 
-00050730: 7261 6e67 6528 206e 6d70 726f 5b27 4e4d  range( nmpro['NM
-00050740: 5f61 7667 275d 2e73 6861 7065 5b32 5d20  _avg'].shape[2] 
-00050750: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00050760: 2020 2020 2020 2020 2020 2020 2020 616e                an
-00050770: 7473 2e70 6c6f 7428 206e 6d70 726f 5b27  ts.plot( nmpro['
-00050780: 4e4d 5f61 7667 275d 2c20 206e 6d70 726f  NM_avg'],  nmpro
-00050790: 5b27 7431 5f74 6f5f 4e4d 275d 2c20 736c  ['t1_to_NM'], sl
-000507a0: 6963 6573 3d6d 7973 6c2c 2061 7869 733d  ices=mysl, axis=
-000507b0: 322c 2074 6974 6c65 3d27 6e6d 202b 2074  2, title='nm + t
-000507c0: 3127 2c20 6669 6c65 6e61 6d65 3d6d 796d  1', filename=mym
-000507d0: 6d2b 6d79 7365 702b 224e 4d61 7667 2e70  m+mysep+"NMavg.p
-000507e0: 6e67 2220 290a 2020 2020 2020 2020 2020  ng" ).          
+00050720: 2020 646f 5f6e 6f72 6d61 6c69 7a61 7469    do_normalizati
+00050730: 6f6e 3d74 656d 706c 6174 6554 782c 0a20  on=templateTx,. 
+00050740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050750: 2020 2020 2020 2020 2020 2067 726f 7570             group
+00050760: 5f74 656d 706c 6174 6520 3d20 6e6f 726d  _template = norm
+00050770: 616c 697a 6174 696f 6e5f 7465 6d70 6c61  alization_templa
+00050780: 7465 2c0a 2020 2020 2020 2020 2020 2020  te,.            
+00050790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000507a0: 6772 6f75 705f 7472 616e 7366 6f72 6d20  group_transform 
+000507b0: 3d20 6772 6f75 7054 782c 0a20 2020 2020  = groupTx,.     
+000507c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000507d0: 2020 2020 2020 2074 6573 745f 7275 6e3d         test_run=
+000507e0: 7465 7374 5f72 756e 2c0a 2020 2020 2020  test_run,.      
 000507f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050800: 2020 6d79 736c 203d 2072 616e 6765 2820    mysl = range( 
-00050810: 6e6d 7072 6f5b 274e 4d5f 6176 675f 6372  nmpro['NM_avg_cr
-00050820: 6f70 7065 6427 5d2e 7368 6170 655b 325d  opped'].shape[2]
-00050830: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00050840: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00050850: 6e74 732e 706c 6f74 2820 6e6d 7072 6f5b  nts.plot( nmpro[
-00050860: 274e 4d5f 6176 675f 6372 6f70 7065 6427  'NM_avg_cropped'
-00050870: 5d2c 2061 7869 733d 322c 2073 6c69 6365  ], axis=2, slice
-00050880: 733d 6d79 736c 2c20 6f76 6572 6c61 795f  s=mysl, overlay_
-00050890: 616c 7068 613d 302e 332c 2074 6974 6c65  alpha=0.3, title
-000508a0: 3d27 6e6d 2063 726f 7027 2c20 6669 6c65  ='nm crop', file
-000508b0: 6e61 6d65 3d6d 796d 6d2b 6d79 7365 702b  name=mymm+mysep+
-000508c0: 224e 4d61 7667 6372 6f70 2e70 6e67 2220  "NMavgcrop.png" 
-000508d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000508e0: 2020 2020 2020 2020 2020 2020 2020 616e                an
-000508f0: 7473 2e70 6c6f 7428 206e 6d70 726f 5b27  ts.plot( nmpro['
-00050900: 4e4d 5f61 7667 5f63 726f 7070 6564 275d  NM_avg_cropped']
-00050910: 2c20 6e6d 7072 6f5b 2774 315f 746f 5f4e  , nmpro['t1_to_N
-00050920: 4d27 5d2c 2061 7869 733d 322c 2073 6c69  M'], axis=2, sli
-00050930: 6365 733d 6d79 736c 2c20 6f76 6572 6c61  ces=mysl, overla
-00050940: 795f 616c 7068 613d 302e 332c 2074 6974  y_alpha=0.3, tit
-00050950: 6c65 3d27 6e6d 2063 726f 7020 2b20 7431  le='nm crop + t1
-00050960: 272c 2066 696c 656e 616d 653d 6d79 6d6d  ', filename=mymm
-00050970: 2b6d 7973 6570 2b22 4e4d 6176 6763 726f  +mysep+"NMavgcro
-00050980: 7074 312e 706e 6722 2029 0a20 2020 2020  pt1.png" ).     
+00050800: 2020 2020 2020 7665 7262 6f73 653d 5472        verbose=Tr
+00050810: 7565 2029 0a20 2020 2020 2020 2020 2020  ue ).           
+00050820: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00050830: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+00050840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050850: 2020 2020 2020 2020 6572 726f 725f 696e          error_in
+00050860: 666f 203d 2074 7261 6365 6261 636b 2e66  fo = traceback.f
+00050870: 6f72 6d61 745f 6578 6328 290a 2020 2020  ormat_exc().    
+00050880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050890: 2020 2020 7072 696e 7428 6572 726f 725f      print(error_
+000508a0: 696e 666f 290a 2020 2020 2020 2020 2020  info).          
+000508b0: 2020 2020 2020 2020 2020 2020 2020 7669                vi
+000508c0: 7375 616c 697a 653d 4661 6c73 650a 2020  sualize=False.  
+000508d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000508e0: 2020 2020 2020 646f 7772 6974 653d 4661        dowrite=Fa
+000508f0: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+00050900: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00050910: 7428 6622 616e 7473 7079 6d6d 6572 726f  t(f"antspymmerro
+00050920: 7220 6f63 6375 7272 6564 2077 6869 6c65  r occurred while
+00050930: 2070 726f 6365 7373 696e 6720 7b6f 7665   processing {ove
+00050940: 726d 6f64 587d 3a20 7b65 7d22 290a 2020  rmodX}: {e}").  
+00050950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050960: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
+00050970: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00050980: 6620 6e6f 7420 7465 7374 5f72 756e 3a0a  f not test_run:.
 00050990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000509a0: 2020 2020 2020 2061 6e74 732e 706c 6f74         ants.plot
-000509b0: 2820 6e6d 7072 6f5b 274e 4d5f 6176 675f  ( nmpro['NM_avg_
-000509c0: 6372 6f70 7065 6427 5d2c 206e 6d70 726f  cropped'], nmpro
-000509d0: 5b27 4e4d 5f6c 6162 656c 7327 5d2c 2061  ['NM_labels'], a
-000509e0: 7869 733d 322c 2073 6c69 6365 733d 6d79  xis=2, slices=my
-000509f0: 736c 2c20 7469 746c 653d 276e 6d20 6372  sl, title='nm cr
-00050a00: 6f70 202b 206c 6162 656c 7327 2c20 6669  op + labels', fi
-00050a10: 6c65 6e61 6d65 3d6d 796d 6d2b 6d79 7365  lename=mymm+myse
-00050a20: 702b 224e 4d61 7667 6372 6f70 6c61 6265  p+"NMavgcroplabe
-00050a30: 6c73 2e70 6e67 2220 290a 2020 2020 2020  ls.png" ).      
-00050a40: 2020 2020 2020 656c 7365 203a 0a20 2020        else :.   
-00050a50: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00050a60: 6c65 6e28 206d 7969 6d67 7372 2029 203e  len( myimgsr ) >
-00050a70: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00050a80: 2020 2020 2020 2020 646f 7772 6974 653d          dowrite=
-00050a90: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
-00050aa0: 2020 2020 2020 2020 2020 6d79 696d 6763            myimgc
-00050ab0: 6f75 6e74 3d30 0a20 2020 2020 2020 2020  ount=0.         
-00050ac0: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-00050ad0: 6e28 206d 7969 6d67 7372 2029 203e 2030  n( myimgsr ) > 0
-00050ae0: 203a 0a20 2020 2020 2020 2020 2020 2020   :.             
-00050af0: 2020 2020 2020 2020 2020 206d 7969 6d67             myimg
-00050b00: 203d 206d 7969 6d67 7372 5b6d 7969 6d67   = myimgsr[myimg
-00050b10: 636f 756e 745d 0a20 2020 2020 2020 2020  count].         
-00050b20: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00050b30: 7562 6a65 6374 7072 6f70 6174 6820 3d20  ubjectpropath = 
-00050b40: 6f73 2e70 6174 682e 6469 726e 616d 6528  os.path.dirname(
-00050b50: 206d 7964 6f63 5b27 6f75 7470 7265 6669   mydoc['outprefi
-00050b60: 7827 5d20 290a 2020 2020 2020 2020 2020  x'] ).          
-00050b70: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00050b80: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-00050b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050ba0: 2020 2020 2020 7072 696e 7428 2273 7562        print("sub
-00050bb0: 6a65 6374 7072 6f70 6174 6820 6973 2229  jectpropath is")
-00050bc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00050bd0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00050be0: 6e74 2873 7562 6a65 6374 7072 6f70 6174  nt(subjectpropat
-00050bf0: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-00050c00: 2020 2020 2020 2020 2020 206f 732e 6d61             os.ma
-00050c10: 6b65 6469 7273 2820 7375 626a 6563 7470  kedirs( subjectp
-00050c20: 726f 7061 7468 2c20 6578 6973 745f 6f6b  ropath, exist_ok
-00050c30: 3d54 7275 6520 2029 0a20 2020 2020 2020  =True  ).       
-00050c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050c50: 206d 796d 6d6f 7574 203d 206d 616b 6577   mymmout = makew
-00050c60: 6964 656f 7574 2820 6d79 6d6d 2029 0a20  ideout( mymm ). 
+000509a0: 2020 2020 2020 2020 6966 2064 6f77 7269          if dowri
+000509b0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+000509c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000509d0: 7772 6974 655f 6d6d 2820 6f75 7470 7574  write_mm( output
+000509e0: 5f70 7265 6669 783d 6d79 6d6d 2c20 6d6d  _prefix=mymm, mm
+000509f0: 3d74 6162 5072 6f2c 0a20 2020 2020 2020  =tabPro,.       
+00050a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050a10: 2020 2020 2020 2020 206d 6d5f 6e6f 726d           mm_norm
+00050a20: 3d6e 6f72 6d50 726f 2c20 7431 7769 6465  =normPro, t1wide
+00050a30: 3d4e 6f6e 652c 2073 6570 6172 6174 6f72  =None, separator
+00050a40: 3d6d 7973 6570 2029 0a20 2020 2020 2020  =mysep ).       
+00050a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050a60: 2069 6620 7669 7375 616c 697a 6520 3a0a   if visualize :.
+00050a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050a80: 2020 2020 2020 2020 2020 2020 6e6d 7072              nmpr
+00050a90: 6f20 3d20 7461 6250 726f 5b27 4e4d 275d  o = tabPro['NM']
+00050aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00050ab0: 2020 2020 2020 2020 2020 2020 206d 7973               mys
+00050ac0: 6c20 3d20 7261 6e67 6528 206e 6d70 726f  l = range( nmpro
+00050ad0: 5b27 4e4d 5f61 7667 275d 2e73 6861 7065  ['NM_avg'].shape
+00050ae0: 5b32 5d20 290a 2020 2020 2020 2020 2020  [2] ).          
+00050af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050b00: 2020 616e 7473 2e70 6c6f 7428 206e 6d70    ants.plot( nmp
+00050b10: 726f 5b27 4e4d 5f61 7667 275d 2c20 206e  ro['NM_avg'],  n
+00050b20: 6d70 726f 5b27 7431 5f74 6f5f 4e4d 275d  mpro['t1_to_NM']
+00050b30: 2c20 736c 6963 6573 3d6d 7973 6c2c 2061  , slices=mysl, a
+00050b40: 7869 733d 322c 2074 6974 6c65 3d27 6e6d  xis=2, title='nm
+00050b50: 202b 2074 3127 2c20 6669 6c65 6e61 6d65   + t1', filename
+00050b60: 3d6d 796d 6d2b 6d79 7365 702b 224e 4d61  =mymm+mysep+"NMa
+00050b70: 7667 2e70 6e67 2220 290a 2020 2020 2020  vg.png" ).      
+00050b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050b90: 2020 2020 2020 6d79 736c 203d 2072 616e        mysl = ran
+00050ba0: 6765 2820 6e6d 7072 6f5b 274e 4d5f 6176  ge( nmpro['NM_av
+00050bb0: 675f 6372 6f70 7065 6427 5d2e 7368 6170  g_cropped'].shap
+00050bc0: 655b 325d 2029 0a20 2020 2020 2020 2020  e[2] ).         
+00050bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050be0: 2020 2061 6e74 732e 706c 6f74 2820 6e6d     ants.plot( nm
+00050bf0: 7072 6f5b 274e 4d5f 6176 675f 6372 6f70  pro['NM_avg_crop
+00050c00: 7065 6427 5d2c 2061 7869 733d 322c 2073  ped'], axis=2, s
+00050c10: 6c69 6365 733d 6d79 736c 2c20 6f76 6572  lices=mysl, over
+00050c20: 6c61 795f 616c 7068 613d 302e 332c 2074  lay_alpha=0.3, t
+00050c30: 6974 6c65 3d27 6e6d 2063 726f 7027 2c20  itle='nm crop', 
+00050c40: 6669 6c65 6e61 6d65 3d6d 796d 6d2b 6d79  filename=mymm+my
+00050c50: 7365 702b 224e 4d61 7667 6372 6f70 2e70  sep+"NMavgcrop.p
+00050c60: 6e67 2220 290a 2020 2020 2020 2020 2020  ng" ).          
 00050c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050c80: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
-00050c90: 6520 616e 6420 6e6f 7420 6578 6973 7473  e and not exists
-00050ca0: 2820 6d79 6d6d 6f75 7420 293a 0a20 2020  ( mymmout ):.   
-00050cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050cc0: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
-00050cd0: 4d6f 6461 6c69 7479 2073 7065 6369 6669  Modality specifi
-00050ce0: 6320 7072 6f63 6573 7369 6e67 3a20 2220  c processing: " 
-00050cf0: 2b20 6d79 6d6f 6420 2b20 2220 6578 6563  + mymod + " exec
-00050d00: 7574 696f 6e20 2220 290a 2020 2020 2020  ution " ).      
-00050d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050d20: 2020 2020 2020 7072 696e 7428 206d 796d        print( mym
-00050d30: 6d20 290a 2020 2020 2020 2020 2020 2020  m ).            
-00050d40: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00050d50: 2076 6572 626f 7365 2061 6e64 2065 7869   verbose and exi
-00050d60: 7374 7328 206d 796d 6d6f 7574 2029 203a  sts( mymmout ) :
-00050d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00050d80: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00050d90: 6e74 2822 4d6f 6461 6c69 7479 2073 7065  nt("Modality spe
-00050da0: 6369 6669 6320 7072 6f63 6573 7369 6e67  cific processing
-00050db0: 3a20 2220 2b20 6d79 6d6f 6420 2b20 2220  : " + mymod + " 
-00050dc0: 636f 6d70 6c65 7465 2022 2029 0a20 2020  complete " ).   
-00050dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050de0: 2020 2020 2069 6620 6578 6973 7473 2820       if exists( 
-00050df0: 6d79 6d6d 6f75 7420 2920 3a0a 2020 2020  mymmout ) :.    
-00050e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050e10: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-00050e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00050e30: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
-00050e40: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-00050e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050e60: 2070 7269 6e74 2873 7562 6a65 6374 7072   print(subjectpr
-00050e70: 6f70 6174 6829 0a20 2020 2020 2020 2020  opath).         
-00050e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050e90: 2020 2070 7269 6e74 2820 6d79 696d 6720     print( myimg 
-00050ea0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00050eb0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00050ec0: 2074 6573 746c 6f6f 703a 0a20 2020 2020   testloop:.     
-00050ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050ee0: 2020 2020 2020 2069 6d67 203d 206d 6d5f         img = mm_
-00050ef0: 7265 6164 2820 6d79 696d 6720 290a 2020  read( myimg ).  
+00050c80: 2020 616e 7473 2e70 6c6f 7428 206e 6d70    ants.plot( nmp
+00050c90: 726f 5b27 4e4d 5f61 7667 5f63 726f 7070  ro['NM_avg_cropp
+00050ca0: 6564 275d 2c20 6e6d 7072 6f5b 2774 315f  ed'], nmpro['t1_
+00050cb0: 746f 5f4e 4d27 5d2c 2061 7869 733d 322c  to_NM'], axis=2,
+00050cc0: 2073 6c69 6365 733d 6d79 736c 2c20 6f76   slices=mysl, ov
+00050cd0: 6572 6c61 795f 616c 7068 613d 302e 332c  erlay_alpha=0.3,
+00050ce0: 2074 6974 6c65 3d27 6e6d 2063 726f 7020   title='nm crop 
+00050cf0: 2b20 7431 272c 2066 696c 656e 616d 653d  + t1', filename=
+00050d00: 6d79 6d6d 2b6d 7973 6570 2b22 4e4d 6176  mymm+mysep+"NMav
+00050d10: 6763 726f 7074 312e 706e 6722 2029 0a20  gcropt1.png" ). 
+00050d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050d30: 2020 2020 2020 2020 2020 2061 6e74 732e             ants.
+00050d40: 706c 6f74 2820 6e6d 7072 6f5b 274e 4d5f  plot( nmpro['NM_
+00050d50: 6176 675f 6372 6f70 7065 6427 5d2c 206e  avg_cropped'], n
+00050d60: 6d70 726f 5b27 4e4d 5f6c 6162 656c 7327  mpro['NM_labels'
+00050d70: 5d2c 2061 7869 733d 322c 2073 6c69 6365  ], axis=2, slice
+00050d80: 733d 6d79 736c 2c20 7469 746c 653d 276e  s=mysl, title='n
+00050d90: 6d20 6372 6f70 202b 206c 6162 656c 7327  m crop + labels'
+00050da0: 2c20 6669 6c65 6e61 6d65 3d6d 796d 6d2b  , filename=mymm+
+00050db0: 6d79 7365 702b 224e 4d61 7667 6372 6f70  mysep+"NMavgcrop
+00050dc0: 6c61 6265 6c73 2e70 6e67 2220 290a 2020  labels.png" ).  
+00050dd0: 2020 2020 2020 2020 2020 656c 7365 203a            else :
+00050de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00050df0: 2069 6620 6c65 6e28 206d 7969 6d67 7372   if len( myimgsr
+00050e00: 2029 203e 2030 3a0a 2020 2020 2020 2020   ) > 0:.        
+00050e10: 2020 2020 2020 2020 2020 2020 646f 7772              dowr
+00050e20: 6974 653d 4661 6c73 650a 2020 2020 2020  ite=False.      
+00050e30: 2020 2020 2020 2020 2020 2020 2020 6d79                my
+00050e40: 696d 6763 6f75 6e74 3d30 0a20 2020 2020  imgcount=0.     
+00050e50: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00050e60: 6620 6c65 6e28 206d 7969 6d67 7372 2029  f len( myimgsr )
+00050e70: 203e 2030 203a 0a20 2020 2020 2020 2020   > 0 :.         
+00050e80: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00050e90: 7969 6d67 203d 206d 7969 6d67 7372 5b6d  yimg = myimgsr[m
+00050ea0: 7969 6d67 636f 756e 745d 0a20 2020 2020  yimgcount].     
+00050eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050ec0: 2020 2073 7562 6a65 6374 7072 6f70 6174     subjectpropat
+00050ed0: 6820 3d20 6f73 2e70 6174 682e 6469 726e  h = os.path.dirn
+00050ee0: 616d 6528 206d 7964 6f63 5b27 6f75 7470  ame( mydoc['outp
+00050ef0: 7265 6669 7827 5d20 290a 2020 2020 2020  refix'] ).      
 00050f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050f10: 2020 2020 2020 2020 2020 6973 6861 7065            ishape
-00050f20: 6c65 6e20 3d20 6c65 6e28 2069 6d67 2e73  len = len( img.s
-00050f30: 6861 7065 2029 0a20 2020 2020 2020 2020  hape ).         
-00050f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050f50: 2020 2069 6620 6d79 6d6f 6420 3d3d 2027     if mymod == '
-00050f60: 5431 7727 2061 6e64 2069 7368 6170 656c  T1w' and ishapel
-00050f70: 656e 203d 3d20 333a 2023 2066 6f72 2061  en == 3: # for a
-00050f80: 2072 6561 6c20 7275 6e2c 2073 6574 2074   real run, set t
-00050f90: 6f20 5472 7565 0a20 2020 2020 2020 2020  o True.         
-00050fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050fb0: 2020 2020 2020 2069 6620 6e6f 7420 6578         if not ex
-00050fc0: 6973 7473 2820 6d79 6d6d 202b 206d 7973  ists( mymm + mys
-00050fd0: 6570 202b 2022 6b6b 5f6e 6f72 6d2e 6e69  ep + "kk_norm.ni
-00050fe0: 692e 677a 2220 293a 0a20 2020 2020 2020  i.gz" ):.       
-00050ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051000: 2020 2020 2020 2020 2020 2020 2064 6f77               dow
-00051010: 7269 7465 3d54 7275 650a 2020 2020 2020  rite=True.      
-00051020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051030: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00051040: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-00051050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051070: 2020 7072 696e 7428 2773 7461 7274 206b    print('start k
-00051080: 6b27 290a 2020 2020 2020 2020 2020 2020  k').            
-00051090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000510a0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-000510b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000510c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000510d0: 2020 2020 2074 6162 5072 6f2c 206e 6f72       tabPro, nor
-000510e0: 6d50 726f 203d 206d 6d28 2074 312c 2068  mPro = mm( t1, h
-000510f0: 6965 722c 0a20 2020 2020 2020 2020 2020  ier,.           
-00051100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050f10: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+00050f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050f30: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00050f40: 2273 7562 6a65 6374 7072 6f70 6174 6820  "subjectpropath 
+00050f50: 6973 2229 0a20 2020 2020 2020 2020 2020  is").           
+00050f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050f70: 2070 7269 6e74 2873 7562 6a65 6374 7072   print(subjectpr
+00050f80: 6f70 6174 6829 0a20 2020 2020 2020 2020  opath).         
+00050f90: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00050fa0: 732e 6d61 6b65 6469 7273 2820 7375 626a  s.makedirs( subj
+00050fb0: 6563 7470 726f 7061 7468 2c20 6578 6973  ectpropath, exis
+00050fc0: 745f 6f6b 3d54 7275 6520 2029 0a20 2020  t_ok=True  ).   
+00050fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050fe0: 2020 2020 206d 796d 6d6f 7574 203d 206d       mymmout = m
+00050ff0: 616b 6577 6964 656f 7574 2820 6d79 6d6d  akewideout( mymm
+00051000: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00051010: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
+00051020: 7262 6f73 6520 616e 6420 6e6f 7420 6578  rbose and not ex
+00051030: 6973 7473 2820 6d79 6d6d 6f75 7420 293a  ists( mymmout ):
+00051040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00051050: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00051060: 6e74 2822 4d6f 6461 6c69 7479 2073 7065  nt("Modality spe
+00051070: 6369 6669 6320 7072 6f63 6573 7369 6e67  cific processing
+00051080: 3a20 2220 2b20 6d79 6d6f 6420 2b20 2220  : " + mymod + " 
+00051090: 6578 6563 7574 696f 6e20 2220 290a 2020  execution " ).  
+000510a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000510b0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+000510c0: 206d 796d 6d20 290a 2020 2020 2020 2020   mymm ).        
+000510d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000510e0: 656c 6966 2076 6572 626f 7365 2061 6e64  elif verbose and
+000510f0: 2065 7869 7374 7328 206d 796d 6d6f 7574   exists( mymmout
+00051100: 2029 203a 0a20 2020 2020 2020 2020 2020   ) :.           
 00051110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051120: 2073 726d 6f64 656c 3d4e 6f6e 652c 0a20   srmodel=None,. 
-00051130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051150: 2020 2020 2020 2020 2020 2064 6f5f 7472             do_tr
-00051160: 6163 746f 6772 6170 6879 3d46 616c 7365  actography=False
-00051170: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00051180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051190: 2020 2020 2020 2020 2020 2020 2020 646f                do
-000511a0: 5f6b 6b3d 5472 7565 2c0a 2020 2020 2020  _kk=True,.      
-000511b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000511c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000511d0: 2020 2020 2020 646f 5f6e 6f72 6d61 6c69        do_normali
-000511e0: 7a61 7469 6f6e 3d74 656d 706c 6174 6554  zation=templateT
-000511f0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-00051200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051210: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00051220: 726f 7570 5f74 656d 706c 6174 6520 3d20  roup_template = 
-00051230: 6e6f 726d 616c 697a 6174 696f 6e5f 7465  normalization_te
-00051240: 6d70 6c61 7465 2c0a 2020 2020 2020 2020  mplate,.        
-00051250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051120: 2070 7269 6e74 2822 4d6f 6461 6c69 7479   print("Modality
+00051130: 2073 7065 6369 6669 6320 7072 6f63 6573   specific proces
+00051140: 7369 6e67 3a20 2220 2b20 6d79 6d6f 6420  sing: " + mymod 
+00051150: 2b20 2220 636f 6d70 6c65 7465 2022 2029  + " complete " )
+00051160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00051170: 2020 2020 2020 2020 2069 6620 6578 6973           if exis
+00051180: 7473 2820 6d79 6d6d 6f75 7420 2920 3a0a  ts( mymmout ) :.
+00051190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000511a0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+000511b0: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+000511c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000511d0: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+000511e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000511f0: 2020 2020 2070 7269 6e74 2873 7562 6a65       print(subje
+00051200: 6374 7072 6f70 6174 6829 0a20 2020 2020  ctpropath).     
+00051210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051220: 2020 2020 2020 2070 7269 6e74 2820 6d79         print( my
+00051230: 696d 6720 290a 2020 2020 2020 2020 2020  img ).          
+00051240: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00051250: 206e 6f74 2074 6573 746c 6f6f 703a 0a20   not testloop:. 
 00051260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051270: 2020 2020 6772 6f75 705f 7472 616e 7366      group_transf
-00051280: 6f72 6d20 3d20 6772 6f75 7054 782c 0a20  orm = groupTx,. 
-00051290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000512a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000512b0: 2020 2020 2020 2020 2020 2074 6573 745f             test_
-000512c0: 7275 6e3d 7465 7374 5f72 756e 2c0a 2020  run=test_run,.  
+00051270: 2020 2020 2020 2020 2020 2069 6d67 203d             img =
+00051280: 206d 6d5f 7265 6164 2820 6d79 696d 6720   mm_read( myimg 
+00051290: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000512a0: 2020 2020 2020 2020 2020 2020 2020 6973                is
+000512b0: 6861 7065 6c65 6e20 3d20 6c65 6e28 2069  hapelen = len( i
+000512c0: 6d67 2e73 6861 7065 2029 0a20 2020 2020  mg.shape ).     
 000512d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000512e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000512f0: 2020 2020 2020 2020 2020 7665 7262 6f73            verbos
-00051300: 653d 5472 7565 2029 0a20 2020 2020 2020  e=True ).       
-00051310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051320: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-00051330: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-00051340: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00051350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051360: 2020 2020 2020 2020 2020 2020 6572 726f              erro
-00051370: 725f 696e 666f 203d 2074 7261 6365 6261  r_info = traceba
-00051380: 636b 2e66 6f72 6d61 745f 6578 6328 290a  ck.format_exc().
+000512e0: 2020 2020 2020 2069 6620 6d79 6d6f 6420         if mymod 
+000512f0: 3d3d 2027 5431 7727 2061 6e64 2069 7368  == 'T1w' and ish
+00051300: 6170 656c 656e 203d 3d20 333a 2023 2066  apelen == 3: # f
+00051310: 6f72 2061 2072 6561 6c20 7275 6e2c 2073  or a real run, s
+00051320: 6574 2074 6f20 5472 7565 0a20 2020 2020  et to True.     
+00051330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051340: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00051350: 7420 6578 6973 7473 2820 6d79 6d6d 202b  t exists( mymm +
+00051360: 206d 7973 6570 202b 2022 6b6b 5f6e 6f72   mysep + "kk_nor
+00051370: 6d2e 6e69 692e 677a 2220 293a 0a20 2020  m.nii.gz" ):.   
+00051380: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00051390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000513a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000513b0: 2020 2020 2020 2020 7072 696e 7428 6572          print(er
-000513c0: 726f 725f 696e 666f 290a 2020 2020 2020  ror_info).      
-000513d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000513a0: 2064 6f77 7269 7465 3d54 7275 650a 2020   dowrite=True.  
+000513b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000513c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000513d0: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
 000513e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000513f0: 2020 7669 7375 616c 697a 653d 4661 6c73    visualize=Fals
-00051400: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00051410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051420: 2020 2020 2020 2020 2020 646f 7772 6974            dowrit
-00051430: 653d 4661 6c73 650a 2020 2020 2020 2020  e=False.        
-00051440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000513f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051400: 2020 2020 2020 7072 696e 7428 2773 7461        print('sta
+00051410: 7274 206b 6b27 290a 2020 2020 2020 2020  rt kk').        
+00051420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051430: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00051440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00051450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051460: 7072 696e 7428 6622 616e 7473 7079 6d6d  print(f"antspymm
-00051470: 6572 726f 7220 6f63 6375 7272 6564 2077  error occurred w
-00051480: 6869 6c65 2070 726f 6365 7373 696e 6720  hile processing 
-00051490: 7b6f 7665 726d 6f64 587d 3a20 7b65 7d22  {overmodX}: {e}"
-000514a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000514b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000514c0: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+00051460: 2020 2020 2020 2020 2074 6162 5072 6f2c           tabPro,
+00051470: 206e 6f72 6d50 726f 203d 206d 6d28 2074   normPro = mm( t
+00051480: 312c 2068 6965 722c 0a20 2020 2020 2020  1, hier,.       
+00051490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000514a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000514b0: 2020 2020 2073 726d 6f64 656c 3d4e 6f6e       srmodel=Non
+000514c0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
 000514d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000514e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000514f0: 2020 2069 6620 7669 7375 616c 697a 653a     if visualize:
-00051500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000514e0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000514f0: 6f5f 7472 6163 746f 6772 6170 6879 3d46  o_tractography=F
+00051500: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
 00051510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051520: 2020 2020 2020 2020 206d 6178 736c 6963           maxslic
-00051530: 6520 3d20 6e70 2e6d 696e 2820 5b32 312c  e = np.min( [21,
-00051540: 2068 6965 725b 2762 7261 696e 5f6e 345f   hier['brain_n4_
-00051550: 646e 7a27 5d2e 7368 6170 655b 325d 205d  dnz'].shape[2] ]
-00051560: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00051570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051580: 2020 2020 2020 2020 2020 2061 6e74 732e             ants.
-00051590: 706c 6f74 2820 6869 6572 5b27 6272 6169  plot( hier['brai
-000515a0: 6e5f 6e34 5f64 6e7a 275d 2c20 2061 7869  n_n4_dnz'],  axi
-000515b0: 733d 322c 206e 736c 6963 6573 3d6d 6178  s=2, nslices=max
-000515c0: 736c 6963 652c 206e 636f 6c3d 372c 2063  slice, ncol=7, c
-000515d0: 726f 703d 5472 7565 2c20 7469 746c 653d  rop=True, title=
-000515e0: 2762 7261 696e 2065 7874 7261 6374 696f  'brain extractio
-000515f0: 6e27 2c20 6669 6c65 6e61 6d65 3d6d 796d  n', filename=mym
-00051600: 6d2b 6d79 7365 702b 2262 7261 696e 6578  m+mysep+"brainex
-00051610: 7472 6163 7469 6f6e 2e70 6e67 2220 290a  traction.png" ).
-00051620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051530: 2020 646f 5f6b 6b3d 5472 7565 2c0a 2020    do_kk=True,.  
+00051540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051560: 2020 2020 2020 2020 2020 646f 5f6e 6f72            do_nor
+00051570: 6d61 6c69 7a61 7469 6f6e 3d74 656d 706c  malization=templ
+00051580: 6174 6554 782c 0a20 2020 2020 2020 2020  ateTx,.         
+00051590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000515a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000515b0: 2020 2067 726f 7570 5f74 656d 706c 6174     group_templat
+000515c0: 6520 3d20 6e6f 726d 616c 697a 6174 696f  e = normalizatio
+000515d0: 6e5f 7465 6d70 6c61 7465 2c0a 2020 2020  n_template,.    
+000515e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000515f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051600: 2020 2020 2020 2020 6772 6f75 705f 7472          group_tr
+00051610: 616e 7366 6f72 6d20 3d20 6772 6f75 7054  ansform = groupT
+00051620: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
 00051630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051640: 2020 2020 2020 2020 616e 7473 2e70 6c6f          ants.plo
-00051650: 7428 2074 6162 5072 6f5b 276b 6b27 5d5b  t( tabPro['kk'][
-00051660: 2774 6869 636b 6e65 7373 5f69 6d61 6765  'thickness_image
-00051670: 275d 2c20 6178 6973 3d32 2c20 6e73 6c69  '], axis=2, nsli
-00051680: 6365 733d 6d61 7873 6c69 6365 2c20 6e63  ces=maxslice, nc
-00051690: 6f6c 3d37 2c20 6372 6f70 3d54 7275 652c  ol=7, crop=True,
-000516a0: 2074 6974 6c65 3d27 6b6b 272c 0a20 2020   title='kk',.   
+00051640: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00051650: 6573 745f 7275 6e3d 7465 7374 5f72 756e  est_run=test_run
+00051660: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00051670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051680: 2020 2020 2020 2020 2020 2020 2020 7665                ve
+00051690: 7262 6f73 653d 5472 7565 2029 0a20 2020  rbose=True ).   
+000516a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000516b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000516c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000516d0: 2020 2020 2063 6d61 703d 2770 6c61 736d       cmap='plasm
-000516e0: 6127 2c20 6669 6c65 6e61 6d65 3d6d 796d  a', filename=mym
-000516f0: 6d2b 6d79 7365 702b 226b 6b74 6869 636b  m+mysep+"kkthick
-00051700: 6e65 7373 2e70 6e67 2220 290a 2020 2020  ness.png" ).    
-00051710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051720: 2020 2020 2020 2020 6966 206d 796d 6f64          if mymod
-00051730: 203d 3d20 2754 3246 6c61 6972 2720 616e   == 'T2Flair' an
-00051740: 6420 6973 6861 7065 6c65 6e20 3d3d 2033  d ishapelen == 3
-00051750: 2061 6e64 206e 702e 6d69 6e28 696d 672e   and np.min(img.
-00051760: 7368 6170 6529 203e 2031 353a 0a20 2020  shape) > 15:.   
+000516c0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+000516d0: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
+000516e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000516f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051700: 6572 726f 725f 696e 666f 203d 2074 7261  error_info = tra
+00051710: 6365 6261 636b 2e66 6f72 6d61 745f 6578  ceback.format_ex
+00051720: 6328 290a 2020 2020 2020 2020 2020 2020  c().            
+00051730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051740: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00051750: 7428 6572 726f 725f 696e 666f 290a 2020  t(error_info).  
+00051760: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00051770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051780: 2020 2020 2020 2020 2020 2020 2064 6f77               dow
-00051790: 7269 7465 3d54 7275 650a 2020 2020 2020  rite=True.      
+00051780: 2020 2020 2020 7669 7375 616c 697a 653d        visualize=
+00051790: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
 000517a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000517b0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-000517c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000517b0: 2020 2020 2020 2020 2020 2020 2020 646f                do
+000517c0: 7772 6974 653d 4661 6c73 650a 2020 2020  write=False.    
 000517d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000517e0: 2020 2074 6162 5072 6f2c 206e 6f72 6d50     tabPro, normP
-000517f0: 726f 203d 206d 6d28 2074 312c 2068 6965  ro = mm( t1, hie
-00051800: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-00051810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051820: 2020 2020 2020 2020 2020 2066 6c61 6972             flair
-00051830: 5f69 6d61 6765 203d 2069 6d67 2c0a 2020  _image = img,.  
+000517e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000517f0: 2020 2020 7072 696e 7428 6622 616e 7473      print(f"ants
+00051800: 7079 6d6d 6572 726f 7220 6f63 6375 7272  pymmerror occurr
+00051810: 6564 2077 6869 6c65 2070 726f 6365 7373  ed while process
+00051820: 696e 6720 7b6f 7665 726d 6f64 587d 3a20  ing {overmodX}: 
+00051830: 7b65 7d22 290a 2020 2020 2020 2020 2020  {e}").          
 00051840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051860: 2020 2020 2020 7372 6d6f 6465 6c3d 4e6f        srmodel=No
-00051870: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00051880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051890: 2020 2020 2020 2020 2020 2020 646f 5f74              do_t
-000518a0: 7261 6374 6f67 7261 7068 793d 4661 6c73  ractography=Fals
-000518b0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-000518c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000518d0: 2020 2020 2020 2020 2020 2064 6f5f 6b6b             do_kk
-000518e0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-000518f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051850: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00051860: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
+00051870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051880: 2020 2020 2020 2069 6620 7669 7375 616c         if visual
+00051890: 697a 653a 0a20 2020 2020 2020 2020 2020  ize:.           
+000518a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000518b0: 2020 2020 2020 2020 2020 2020 206d 6178               max
+000518c0: 736c 6963 6520 3d20 6e70 2e6d 696e 2820  slice = np.min( 
+000518d0: 5b32 312c 2068 6965 725b 2762 7261 696e  [21, hier['brain
+000518e0: 5f6e 345f 646e 7a27 5d2e 7368 6170 655b  _n4_dnz'].shape[
+000518f0: 325d 205d 2029 0a20 2020 2020 2020 2020  2] ] ).         
 00051900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051910: 646f 5f6e 6f72 6d61 6c69 7a61 7469 6f6e  do_normalization
-00051920: 3d74 656d 706c 6174 6554 782c 0a20 2020  =templateTx,.   
-00051930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051950: 2020 2020 2067 726f 7570 5f74 656d 706c       group_templ
-00051960: 6174 6520 3d20 6e6f 726d 616c 697a 6174  ate = normalizat
-00051970: 696f 6e5f 7465 6d70 6c61 7465 2c0a 2020  ion_template,.  
-00051980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000519a0: 2020 2020 2020 6772 6f75 705f 7472 616e        group_tran
-000519b0: 7366 6f72 6d20 3d20 6772 6f75 7054 782c  sform = groupTx,
-000519c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000519d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000519e0: 2020 2020 2020 2020 2074 6573 745f 7275           test_ru
-000519f0: 6e3d 7465 7374 5f72 756e 2c0a 2020 2020  n=test_run,.    
-00051a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051a20: 2020 2020 7665 7262 6f73 653d 5472 7565      verbose=True
-00051a30: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00051a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051a50: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-00051a60: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-00051a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051a90: 2020 6572 726f 725f 696e 666f 203d 2074    error_info = t
-00051aa0: 7261 6365 6261 636b 2e66 6f72 6d61 745f  raceback.format_
-00051ab0: 6578 6328 290a 2020 2020 2020 2020 2020  exc().          
-00051ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051ad0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00051ae0: 696e 7428 6572 726f 725f 696e 666f 290a  int(error_info).
-00051af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051b10: 2020 2020 2020 2020 7669 7375 616c 697a          visualiz
-00051b20: 653d 4661 6c73 650a 2020 2020 2020 2020  e=False.        
+00051910: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00051920: 6e74 732e 706c 6f74 2820 6869 6572 5b27  nts.plot( hier['
+00051930: 6272 6169 6e5f 6e34 5f64 6e7a 275d 2c20  brain_n4_dnz'], 
+00051940: 2061 7869 733d 322c 206e 736c 6963 6573   axis=2, nslices
+00051950: 3d6d 6178 736c 6963 652c 206e 636f 6c3d  =maxslice, ncol=
+00051960: 372c 2063 726f 703d 5472 7565 2c20 7469  7, crop=True, ti
+00051970: 746c 653d 2762 7261 696e 2065 7874 7261  tle='brain extra
+00051980: 6374 696f 6e27 2c20 6669 6c65 6e61 6d65  ction', filename
+00051990: 3d6d 796d 6d2b 6d79 7365 702b 2262 7261  =mymm+mysep+"bra
+000519a0: 696e 6578 7472 6163 7469 6f6e 2e70 6e67  inextraction.png
+000519b0: 2220 290a 2020 2020 2020 2020 2020 2020  " ).            
+000519c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000519d0: 2020 2020 2020 2020 2020 2020 616e 7473              ants
+000519e0: 2e70 6c6f 7428 2074 6162 5072 6f5b 276b  .plot( tabPro['k
+000519f0: 6b27 5d5b 2774 6869 636b 6e65 7373 5f69  k']['thickness_i
+00051a00: 6d61 6765 275d 2c20 6178 6973 3d32 2c20  mage'], axis=2, 
+00051a10: 6e73 6c69 6365 733d 6d61 7873 6c69 6365  nslices=maxslice
+00051a20: 2c20 6e63 6f6c 3d37 2c20 6372 6f70 3d54  , ncol=7, crop=T
+00051a30: 7275 652c 2074 6974 6c65 3d27 6b6b 272c  rue, title='kk',
+00051a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00051a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051a60: 2020 2020 2020 2020 2063 6d61 703d 2770           cmap='p
+00051a70: 6c61 736d 6127 2c20 6669 6c65 6e61 6d65  lasma', filename
+00051a80: 3d6d 796d 6d2b 6d79 7365 702b 226b 6b74  =mymm+mysep+"kkt
+00051a90: 6869 636b 6e65 7373 2e70 6e67 2220 290a  hickness.png" ).
+00051aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051ab0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00051ac0: 796d 6f64 203d 3d20 2754 3246 6c61 6972  ymod == 'T2Flair
+00051ad0: 2720 616e 6420 6973 6861 7065 6c65 6e20  ' and ishapelen 
+00051ae0: 3d3d 2033 2061 6e64 206e 702e 6d69 6e28  == 3 and np.min(
+00051af0: 696d 672e 7368 6170 6529 203e 2031 353a  img.shape) > 15:
+00051b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00051b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051b20: 2064 6f77 7269 7465 3d54 7275 650a 2020   dowrite=True.  
 00051b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051b50: 646f 7772 6974 653d 4661 6c73 650a 2020  dowrite=False.  
+00051b40: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00051b50: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
 00051b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051b80: 2020 2020 2020 7072 696e 7428 6622 616e        print(f"an
-00051b90: 7473 7079 6d6d 6572 726f 7220 6f63 6375  tspymmerror occu
-00051ba0: 7272 6564 2077 6869 6c65 2070 726f 6365  rred while proce
-00051bb0: 7373 696e 6720 7b6f 7665 726d 6f64 587d  ssing {overmodX}
-00051bc0: 3a20 7b65 7d22 290a 2020 2020 2020 2020  : {e}").        
-00051bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051b70: 2020 2020 2020 2074 6162 5072 6f2c 206e         tabPro, n
+00051b80: 6f72 6d50 726f 203d 206d 6d28 2074 312c  ormPro = mm( t1,
+00051b90: 2068 6965 722c 0a20 2020 2020 2020 2020   hier,.         
+00051ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051bb0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00051bc0: 6c61 6972 5f69 6d61 6765 203d 2069 6d67  lair_image = img
+00051bd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00051be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051bf0: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
-00051c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051c10: 2020 2020 2069 6620 7669 7375 616c 697a       if visualiz
-00051c20: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00051c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051c40: 2020 2020 2020 206d 6178 736c 6963 6520         maxslice 
-00051c50: 3d20 6e70 2e6d 696e 2820 5b32 312c 2069  = np.min( [21, i
-00051c60: 6d67 2e73 6861 7065 5b32 5d20 5d20 290a  mg.shape[2] ] ).
-00051c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051bf0: 2020 2020 2020 2020 2020 7372 6d6f 6465            srmode
+00051c00: 6c3d 4e6f 6e65 2c0a 2020 2020 2020 2020  l=None,.        
+00051c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051c30: 646f 5f74 7261 6374 6f67 7261 7068 793d  do_tractography=
+00051c40: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
+00051c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051c60: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00051c70: 6f5f 6b6b 3d46 616c 7365 2c0a 2020 2020  o_kk=False,.    
 00051c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051c90: 2020 2020 616e 7473 2e70 6c6f 745f 6f72      ants.plot_or
-00051ca0: 7468 6f28 2069 6d67 2c20 6372 6f70 3d54  tho( img, crop=T
-00051cb0: 7275 652c 2074 6974 6c65 3d27 466c 6169  rue, title='Flai
-00051cc0: 7227 2c20 6669 6c65 6e61 6d65 3d6d 796d  r', filename=mym
-00051cd0: 6d2b 6d79 7365 702b 2266 6c61 6972 2e70  m+mysep+"flair.p
-00051ce0: 6e67 222c 2066 6c61 743d 5472 7565 2029  ng", flat=True )
-00051cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00051d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051d10: 2020 2020 2061 6e74 732e 706c 6f74 5f6f       ants.plot_o
-00051d20: 7274 686f 2820 696d 672c 2074 6162 5072  rtho( img, tabPr
-00051d30: 6f5b 2766 6c61 6972 275d 5b27 574d 485f  o['flair']['WMH_
-00051d40: 7072 6f62 6162 696c 6974 795f 6d61 7027  probability_map'
-00051d50: 5d2c 2063 726f 703d 5472 7565 2c20 7469  ], crop=True, ti
-00051d60: 746c 653d 2746 6c61 6972 202b 2057 4d48  tle='Flair + WMH
-00051d70: 272c 2066 696c 656e 616d 653d 6d79 6d6d  ', filename=mymm
-00051d80: 2b6d 7973 6570 2b22 666c 6169 7257 4d48  +mysep+"flairWMH
-00051d90: 2e70 6e67 222c 2066 6c61 743d 5472 7565  .png", flat=True
-00051da0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00051db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051dc0: 2020 2020 2020 2069 6620 7461 6250 726f         if tabPro
-00051dd0: 5b27 666c 6169 7227 5d5b 2757 4d48 5f70  ['flair']['WMH_p
-00051de0: 6f73 7465 7269 6f72 5f70 726f 6261 6269  osterior_probabi
-00051df0: 6c69 7479 5f6d 6170 275d 2069 7320 6e6f  lity_map'] is no
-00051e00: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00051c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051ca0: 2020 2020 646f 5f6e 6f72 6d61 6c69 7a61      do_normaliza
+00051cb0: 7469 6f6e 3d74 656d 706c 6174 6554 782c  tion=templateTx,
+00051cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00051cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051ce0: 2020 2020 2020 2020 2067 726f 7570 5f74           group_t
+00051cf0: 656d 706c 6174 6520 3d20 6e6f 726d 616c  emplate = normal
+00051d00: 697a 6174 696f 6e5f 7465 6d70 6c61 7465  ization_template
+00051d10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00051d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051d30: 2020 2020 2020 2020 2020 6772 6f75 705f            group_
+00051d40: 7472 616e 7366 6f72 6d20 3d20 6772 6f75  transform = grou
+00051d50: 7054 782c 0a20 2020 2020 2020 2020 2020  pTx,.           
+00051d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051d70: 2020 2020 2020 2020 2020 2020 2074 6573               tes
+00051d80: 745f 7275 6e3d 7465 7374 5f72 756e 2c0a  t_run=test_run,.
+00051d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051db0: 2020 2020 2020 2020 7665 7262 6f73 653d          verbose=
+00051dc0: 5472 7565 2029 0a20 2020 2020 2020 2020  True ).         
+00051dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051de0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+00051df0: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
+00051e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00051e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051e30: 616e 7473 2e70 6c6f 745f 6f72 7468 6f28  ants.plot_ortho(
-00051e40: 2069 6d67 2c20 7461 6250 726f 5b27 666c   img, tabPro['fl
-00051e50: 6169 7227 5d5b 2757 4d48 5f70 6f73 7465  air']['WMH_poste
-00051e60: 7269 6f72 5f70 726f 6261 6269 6c69 7479  rior_probability
-00051e70: 5f6d 6170 275d 2c20 2063 726f 703d 5472  _map'],  crop=Tr
-00051e80: 7565 2c20 7469 746c 653d 2746 6c61 6972  ue, title='Flair
-00051e90: 202b 2070 7269 6f72 2057 4d48 272c 2066   + prior WMH', f
-00051ea0: 696c 656e 616d 653d 6d79 6d6d 2b6d 7973  ilename=mymm+mys
-00051eb0: 6570 2b22 666c 6169 7270 7269 6f72 574d  ep+"flairpriorWM
-00051ec0: 482e 706e 6722 2c20 666c 6174 3d54 7275  H.png", flat=Tru
-00051ed0: 6520 290a 2020 2020 2020 2020 2020 2020  e ).            
-00051ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051ef0: 6966 2028 206d 796d 6f64 203d 3d20 2772  if ( mymod == 'r
-00051f00: 7366 4d52 495f 4c52 2720 6f72 206d 796d  sfMRI_LR' or mym
-00051f10: 6f64 203d 3d20 2772 7366 4d52 495f 524c  od == 'rsfMRI_RL
-00051f20: 2720 6f72 206d 796d 6f64 203d 3d20 2772  ' or mymod == 'r
-00051f30: 7366 4d52 4927 2029 2020 616e 6420 6973  sfMRI' )  and is
-00051f40: 6861 7065 6c65 6e20 3d3d 2034 3a0a 2020  hapelen == 4:.  
-00051f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051f60: 2020 2020 2020 2020 2020 2020 2020 696d                im
-00051f70: 6732 203d 204e 6f6e 650a 2020 2020 2020  g2 = None.      
-00051f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051f90: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-00051fa0: 2820 6d79 696d 6773 7220 2920 3e20 313a  ( myimgsr ) > 1:
-00051fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00051e20: 2020 2020 2020 6572 726f 725f 696e 666f        error_info
+00051e30: 203d 2074 7261 6365 6261 636b 2e66 6f72   = traceback.for
+00051e40: 6d61 745f 6578 6328 290a 2020 2020 2020  mat_exc().      
+00051e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051e70: 2020 7072 696e 7428 6572 726f 725f 696e    print(error_in
+00051e80: 666f 290a 2020 2020 2020 2020 2020 2020  fo).            
+00051e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051ea0: 2020 2020 2020 2020 2020 2020 7669 7375              visu
+00051eb0: 616c 697a 653d 4661 6c73 650a 2020 2020  alize=False.    
+00051ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051ee0: 2020 2020 646f 7772 6974 653d 4661 6c73      dowrite=Fals
+00051ef0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00051f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051f10: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00051f20: 6622 616e 7473 7079 6d6d 6572 726f 7220  f"antspymmerror 
+00051f30: 6f63 6375 7272 6564 2077 6869 6c65 2070  occurred while p
+00051f40: 726f 6365 7373 696e 6720 7b6f 7665 726d  rocessing {overm
+00051f50: 6f64 587d 3a20 7b65 7d22 290a 2020 2020  odX}: {e}").    
+00051f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051f80: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
+00051f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051fa0: 2020 2020 2020 2020 2069 6620 7669 7375           if visu
+00051fb0: 616c 697a 653a 0a20 2020 2020 2020 2020  alize:.         
 00051fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051fd0: 2020 2020 2069 6d67 3220 3d20 6d6d 5f72       img2 = mm_r
-00051fe0: 6561 6428 206d 7969 6d67 7372 5b6d 7969  ead( myimgsr[myi
-00051ff0: 6d67 636f 756e 742b 315d 2029 0a20 2020  mgcount+1] ).   
-00052000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051fd0: 2020 2020 2020 2020 2020 206d 6178 736c             maxsl
+00051fe0: 6963 6520 3d20 6e70 2e6d 696e 2820 5b32  ice = np.min( [2
+00051ff0: 312c 2069 6d67 2e73 6861 7065 5b32 5d20  1, img.shape[2] 
+00052000: 5d20 290a 2020 2020 2020 2020 2020 2020  ] ).            
 00052010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052020: 2069 7368 6170 656c 656e 3220 3d20 6c65   ishapelen2 = le
-00052030: 6e28 2069 6d67 322e 7368 6170 6520 290a  n( img2.shape ).
-00052040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052060: 2020 2020 6966 2069 7368 6170 656c 656e      if ishapelen
-00052070: 3220 213d 2034 206f 7220 3120 696e 2069  2 != 4 or 1 in i
-00052080: 6d67 322e 7368 6170 653a 0a20 2020 2020  mg2.shape:.     
+00052020: 2020 2020 2020 2020 616e 7473 2e70 6c6f          ants.plo
+00052030: 745f 6f72 7468 6f28 2069 6d67 2c20 6372  t_ortho( img, cr
+00052040: 6f70 3d54 7275 652c 2074 6974 6c65 3d27  op=True, title='
+00052050: 466c 6169 7227 2c20 6669 6c65 6e61 6d65  Flair', filename
+00052060: 3d6d 796d 6d2b 6d79 7365 702b 2266 6c61  =mymm+mysep+"fla
+00052070: 6972 2e70 6e67 222c 2066 6c61 743d 5472  ir.png", flat=Tr
+00052080: 7565 2029 0a20 2020 2020 2020 2020 2020  ue ).           
 00052090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000520a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000520b0: 2020 2069 6d67 3220 3d20 4e6f 6e65 0a20     img2 = None. 
-000520c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000520d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000520e0: 6620 3120 696e 2069 6d67 2e73 6861 7065  f 1 in img.shape
-000520f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00052100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052110: 2020 2020 2020 7761 726e 696e 6773 2e77        warnings.w
-00052120: 6172 6e28 2027 7273 664d 5249 2069 6d61  arn( 'rsfMRI ima
-00052130: 6765 2073 6861 7065 2073 7567 6765 7374  ge shape suggest
-00052140: 7320 6974 2069 7320 616e 2069 6e63 6f72  s it is an incor
-00052150: 7265 6374 6c79 2063 6f6e 7665 7274 6564  rectly converted
-00052160: 206d 6f73 6169 6320 696d 6167 6520 2d20   mosaic image - 
-00052170: 7769 6c6c 206e 6f74 2070 726f 6365 7373  will not process
-00052180: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
-00052190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000521a0: 2020 2020 2020 2020 646f 7772 6974 653d          dowrite=
-000521b0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
-000521c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000521d0: 2020 2020 2020 2020 2020 7461 6250 726f            tabPro
-000521e0: 3d7b 2772 7366 273a 4e6f 6e65 7d0a 2020  ={'rsf':None}.  
-000521f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052210: 2020 6e6f 726d 5072 6f3d 7b27 7273 6627    normPro={'rsf'
-00052220: 3a4e 6f6e 657d 0a20 2020 2020 2020 2020  :None}.         
-00052230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052240: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00052250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052270: 2064 6f77 7269 7465 3d54 7275 650a 2020   dowrite=True.  
-00052280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000522a0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-000522b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000522c0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000522d0: 6162 5072 6f2c 206e 6f72 6d50 726f 203d  abPro, normPro =
-000522e0: 206d 6d28 2074 312c 2068 6965 722c 0a20   mm( t1, hier,. 
+000520a0: 2020 2020 2020 2020 2061 6e74 732e 706c           ants.pl
+000520b0: 6f74 5f6f 7274 686f 2820 696d 672c 2074  ot_ortho( img, t
+000520c0: 6162 5072 6f5b 2766 6c61 6972 275d 5b27  abPro['flair']['
+000520d0: 574d 485f 7072 6f62 6162 696c 6974 795f  WMH_probability_
+000520e0: 6d61 7027 5d2c 2063 726f 703d 5472 7565  map'], crop=True
+000520f0: 2c20 7469 746c 653d 2746 6c61 6972 202b  , title='Flair +
+00052100: 2057 4d48 272c 2066 696c 656e 616d 653d   WMH', filename=
+00052110: 6d79 6d6d 2b6d 7973 6570 2b22 666c 6169  mymm+mysep+"flai
+00052120: 7257 4d48 2e70 6e67 222c 2066 6c61 743d  rWMH.png", flat=
+00052130: 5472 7565 2029 0a20 2020 2020 2020 2020  True ).         
+00052140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052150: 2020 2020 2020 2020 2020 2069 6620 7461             if ta
+00052160: 6250 726f 5b27 666c 6169 7227 5d5b 2757  bPro['flair']['W
+00052170: 4d48 5f70 6f73 7465 7269 6f72 5f70 726f  MH_posterior_pro
+00052180: 6261 6269 6c69 7479 5f6d 6170 275d 2069  bability_map'] i
+00052190: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+000521a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000521b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000521c0: 2020 2020 616e 7473 2e70 6c6f 745f 6f72      ants.plot_or
+000521d0: 7468 6f28 2069 6d67 2c20 7461 6250 726f  tho( img, tabPro
+000521e0: 5b27 666c 6169 7227 5d5b 2757 4d48 5f70  ['flair']['WMH_p
+000521f0: 6f73 7465 7269 6f72 5f70 726f 6261 6269  osterior_probabi
+00052200: 6c69 7479 5f6d 6170 275d 2c20 2063 726f  lity_map'],  cro
+00052210: 703d 5472 7565 2c20 7469 746c 653d 2746  p=True, title='F
+00052220: 6c61 6972 202b 2070 7269 6f72 2057 4d48  lair + prior WMH
+00052230: 272c 2066 696c 656e 616d 653d 6d79 6d6d  ', filename=mymm
+00052240: 2b6d 7973 6570 2b22 666c 6169 7270 7269  +mysep+"flairpri
+00052250: 6f72 574d 482e 706e 6722 2c20 666c 6174  orWMH.png", flat
+00052260: 3d54 7275 6520 290a 2020 2020 2020 2020  =True ).        
+00052270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052280: 2020 2020 6966 2028 206d 796d 6f64 203d      if ( mymod =
+00052290: 3d20 2772 7366 4d52 495f 4c52 2720 6f72  = 'rsfMRI_LR' or
+000522a0: 206d 796d 6f64 203d 3d20 2772 7366 4d52   mymod == 'rsfMR
+000522b0: 495f 524c 2720 6f72 206d 796d 6f64 203d  I_RL' or mymod =
+000522c0: 3d20 2772 7366 4d52 4927 2029 2020 616e  = 'rsfMRI' )  an
+000522d0: 6420 6973 6861 7065 6c65 6e20 3d3d 2034  d ishapelen == 4
+000522e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
 000522f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052310: 2020 2020 2020 2020 2020 2072 7366 5f69             rsf_i
-00052320: 6d61 6765 3d5b 696d 672c 696d 6732 5d2c  mage=[img,img2],
-00052330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00052340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052350: 2020 2020 2020 2020 2020 2020 2073 726d               srm
-00052360: 6f64 656c 3d4e 6f6e 652c 0a20 2020 2020  odel=None,.     
-00052370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052390: 2020 2020 2020 2064 6f5f 7472 6163 746f         do_tracto
-000523a0: 6772 6170 6879 3d46 616c 7365 2c0a 2020  graphy=False,.  
-000523b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000523c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000523d0: 2020 2020 2020 2020 2020 646f 5f6b 6b3d            do_kk=
-000523e0: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
-000523f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052410: 2020 2064 6f5f 6e6f 726d 616c 697a 6174     do_normalizat
-00052420: 696f 6e3d 7465 6d70 6c61 7465 5478 2c0a  ion=templateTx,.
+00052300: 2020 696d 6732 203d 204e 6f6e 650a 2020    img2 = None.  
+00052310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052320: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00052330: 206c 656e 2820 6d79 696d 6773 7220 2920   len( myimgsr ) 
+00052340: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
+00052350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052360: 2020 2020 2020 2020 2069 6d67 3220 3d20           img2 = 
+00052370: 6d6d 5f72 6561 6428 206d 7969 6d67 7372  mm_read( myimgsr
+00052380: 5b6d 7969 6d67 636f 756e 742b 315d 2029  [myimgcount+1] )
+00052390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000523a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000523b0: 2020 2020 2069 7368 6170 656c 656e 3220       ishapelen2 
+000523c0: 3d20 6c65 6e28 2069 6d67 322e 7368 6170  = len( img2.shap
+000523d0: 6520 290a 2020 2020 2020 2020 2020 2020  e ).            
+000523e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000523f0: 2020 2020 2020 2020 6966 2069 7368 6170          if ishap
+00052400: 656c 656e 3220 213d 2034 206f 7220 3120  elen2 != 4 or 1 
+00052410: 696e 2069 6d67 322e 7368 6170 653a 0a20  in img2.shape:. 
+00052420: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00052430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052450: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
-00052460: 705f 7465 6d70 6c61 7465 203d 206e 6f72  p_template = nor
-00052470: 6d61 6c69 7a61 7469 6f6e 5f74 656d 706c  malization_templ
-00052480: 6174 652c 0a20 2020 2020 2020 2020 2020  ate,.           
+00052440: 2020 2020 2020 2069 6d67 3220 3d20 4e6f         img2 = No
+00052450: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
+00052460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052470: 2020 2069 6620 3120 696e 2069 6d67 2e73     if 1 in img.s
+00052480: 6861 7065 3a0a 2020 2020 2020 2020 2020  hape:.          
 00052490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000524a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000524b0: 2067 726f 7570 5f74 7261 6e73 666f 726d   group_transform
-000524c0: 203d 2067 726f 7570 5478 2c0a 2020 2020   = groupTx,.    
-000524d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000524e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000524f0: 2020 2020 2020 2020 7273 665f 7570 7361          rsf_upsa
-00052500: 6d70 6c69 6e67 203d 2072 7366 5f75 7073  mpling = rsf_ups
-00052510: 616d 706c 696e 672c 0a20 2020 2020 2020  ampling,.       
+000524a0: 2020 2020 2020 2020 2020 7761 726e 696e            warnin
+000524b0: 6773 2e77 6172 6e28 2027 7273 664d 5249  gs.warn( 'rsfMRI
+000524c0: 2069 6d61 6765 2073 6861 7065 2073 7567   image shape sug
+000524d0: 6765 7374 7320 6974 2069 7320 616e 2069  gests it is an i
+000524e0: 6e63 6f72 7265 6374 6c79 2063 6f6e 7665  ncorrectly conve
+000524f0: 7274 6564 206d 6f73 6169 6320 696d 6167  rted mosaic imag
+00052500: 6520 2d20 7769 6c6c 206e 6f74 2070 726f  e - will not pro
+00052510: 6365 7373 2e27 290a 2020 2020 2020 2020  cess.').        
 00052520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052540: 2020 2020 2074 6573 745f 7275 6e3d 7465       test_run=te
-00052550: 7374 5f72 756e 2c0a 2020 2020 2020 2020  st_run,.        
-00052560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052580: 2020 2020 7665 7262 6f73 653d 5472 7565      verbose=True
-00052590: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-000525a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000525b0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-000525c0: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-000525d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000525e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000525f0: 2020 2020 2020 6572 726f 725f 696e 666f        error_info
-00052600: 203d 2074 7261 6365 6261 636b 2e66 6f72   = traceback.for
-00052610: 6d61 745f 6578 6328 290a 2020 2020 2020  mat_exc().      
+00052530: 2020 2020 2020 2020 2020 2020 646f 7772              dowr
+00052540: 6974 653d 4661 6c73 650a 2020 2020 2020  ite=False.      
+00052550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052560: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+00052570: 6250 726f 3d7b 2772 7366 273a 4e6f 6e65  bPro={'rsf':None
+00052580: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00052590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000525a0: 2020 2020 2020 6e6f 726d 5072 6f3d 7b27        normPro={'
+000525b0: 7273 6627 3a4e 6f6e 657d 0a20 2020 2020  rsf':None}.     
+000525c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000525d0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000525e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000525f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052600: 2020 2020 2064 6f77 7269 7465 3d54 7275       dowrite=Tru
+00052610: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
 00052620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052640: 2020 7072 696e 7428 6572 726f 725f 696e    print(error_in
-00052650: 666f 290a 2020 2020 2020 2020 2020 2020  fo).            
-00052660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052670: 2020 2020 2020 2020 2020 2020 7669 7375              visu
-00052680: 616c 697a 653d 4661 6c73 650a 2020 2020  alize=False.    
+00052630: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00052640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052660: 2020 2074 6162 5072 6f2c 206e 6f72 6d50     tabPro, normP
+00052670: 726f 203d 206d 6d28 2074 312c 2068 6965  ro = mm( t1, hie
+00052680: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
 00052690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000526a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000526b0: 2020 2020 646f 7772 6974 653d 4661 6c73      dowrite=Fals
-000526c0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+000526a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000526b0: 7366 5f69 6d61 6765 3d5b 696d 672c 696d  sf_image=[img,im
+000526c0: 6732 5d2c 0a20 2020 2020 2020 2020 2020  g2],.           
 000526d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000526e0: 2020 2020 2020 2020 2020 7461 6250 726f            tabPro
-000526f0: 3d7b 2772 7366 273a 4e6f 6e65 7d0a 2020  ={'rsf':None}.  
+000526e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000526f0: 2073 726d 6f64 656c 3d4e 6f6e 652c 0a20   srmodel=None,. 
 00052700: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00052710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052720: 2020 2020 2020 6e6f 726d 5072 6f3d 7b27        normPro={'
-00052730: 7273 6627 3a4e 6f6e 657d 0a20 2020 2020  rsf':None}.     
-00052740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052720: 2020 2020 2020 2020 2020 2064 6f5f 7472             do_tr
+00052730: 6163 746f 6772 6170 6879 3d46 616c 7365  actography=False
+00052740: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00052750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052760: 2020 2070 7269 6e74 2866 2261 6e74 7370     print(f"antsp
-00052770: 796d 6d65 7272 6f72 206f 6363 7572 7265  ymmerror occurre
-00052780: 6420 7768 696c 6520 7072 6f63 6573 7369  d while processi
-00052790: 6e67 207b 6f76 6572 6d6f 6458 7d3a 207b  ng {overmodX}: {
-000527a0: 657d 2229 0a20 2020 2020 2020 2020 2020  e}").           
-000527b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000527c0: 2020 2020 2020 2020 2020 2020 2070 6173               pas
-000527d0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00052760: 2020 2020 2020 2020 2020 2020 2020 646f                do
+00052770: 5f6b 6b3d 4661 6c73 652c 0a20 2020 2020  _kk=False,.     
+00052780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000527a0: 2020 2020 2020 2064 6f5f 6e6f 726d 616c         do_normal
+000527b0: 697a 6174 696f 6e3d 7465 6d70 6c61 7465  ization=template
+000527c0: 5478 2c0a 2020 2020 2020 2020 2020 2020  Tx,.            
+000527d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000527e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000527f0: 2020 6966 2074 6162 5072 6f5b 2772 7366    if tabPro['rsf
-00052800: 275d 2069 7320 6e6f 7420 4e6f 6e65 2061  '] is not None a
-00052810: 6e64 2076 6973 7561 6c69 7a65 3a0a 2020  nd visualize:.  
+000527f0: 6772 6f75 705f 7465 6d70 6c61 7465 203d  group_template =
+00052800: 206e 6f72 6d61 6c69 7a61 7469 6f6e 5f74   normalization_t
+00052810: 656d 706c 6174 652c 0a20 2020 2020 2020  emplate,.       
 00052820: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00052830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052840: 2020 666f 7220 7470 726f 2069 6e20 7461    for tpro in ta
-00052850: 6250 726f 5b27 7273 6627 5d3a 2023 2046  bPro['rsf']: # F
-00052860: 4958 4d45 5253 460a 2020 2020 2020 2020  IXMERSF.        
+00052840: 2020 2020 2067 726f 7570 5f74 7261 6e73       group_trans
+00052850: 666f 726d 203d 2067 726f 7570 5478 2c0a  form = groupTx,.
+00052860: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00052870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052890: 6d61 7873 6c69 6365 203d 206e 702e 6d69  maxslice = np.mi
-000528a0: 6e28 205b 3231 2c20 7470 726f 5b27 6d65  n( [21, tpro['me
-000528b0: 616e 426f 6c64 275d 2e73 6861 7065 5b32  anBold'].shape[2
-000528c0: 5d20 5d20 290a 2020 2020 2020 2020 2020  ] ] ).          
-000528d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000528e0: 2020 2020 2020 2020 2020 2020 2020 7470                tp
-000528f0: 726f 7072 6566 6978 203d 206d 796d 6d2b  roprefix = mymm+
-00052900: 6d79 7365 702b 7374 7228 7470 726f 5b27  mysep+str(tpro['
-00052910: 7061 7261 6d73 6574 275d 292b 6d79 7365  paramset'])+myse
-00052920: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
+00052880: 2020 2020 2020 2020 2020 2020 7273 665f              rsf_
+00052890: 7570 7361 6d70 6c69 6e67 203d 2072 7366  upsampling = rsf
+000528a0: 5f75 7073 616d 706c 696e 672c 0a20 2020  _upsampling,.   
+000528b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000528c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000528d0: 2020 2020 2020 2020 2074 6573 745f 7275           test_ru
+000528e0: 6e3d 7465 7374 5f72 756e 2c0a 2020 2020  n=test_run,.    
+000528f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052910: 2020 2020 2020 2020 7665 7262 6f73 653d          verbose=
+00052920: 5472 7565 2029 0a20 2020 2020 2020 2020  True ).         
 00052930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052940: 2020 2020 2020 2020 2020 616e 7473 2e70            ants.p
-00052950: 6c6f 7428 2074 7072 6f5b 276d 6561 6e42  lot( tpro['meanB
-00052960: 6f6c 6427 5d2c 0a20 2020 2020 2020 2020  old'],.         
+00052940: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00052950: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+00052960: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
 00052970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052990: 2020 2061 7869 733d 322c 206e 736c 6963     axis=2, nslic
-000529a0: 6573 3d6d 6178 736c 6963 652c 206e 636f  es=maxslice, nco
-000529b0: 6c3d 372c 2063 726f 703d 5472 7565 2c20  l=7, crop=True, 
-000529c0: 7469 746c 653d 276d 6561 6e42 4f4c 4427  title='meanBOLD'
-000529d0: 2c20 6669 6c65 6e61 6d65 3d74 7072 6f70  , filename=tprop
-000529e0: 7265 6669 782b 226d 6561 6e42 4f4c 442e  refix+"meanBOLD.
-000529f0: 706e 6722 2029 0a20 2020 2020 2020 2020  png" ).         
+00052980: 2020 2020 2020 2020 2020 6572 726f 725f            error_
+00052990: 696e 666f 203d 2074 7261 6365 6261 636b  info = traceback
+000529a0: 2e66 6f72 6d61 745f 6578 6328 290a 2020  .format_exc().  
+000529b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000529c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000529d0: 2020 2020 2020 7072 696e 7428 6572 726f        print(erro
+000529e0: 725f 696e 666f 290a 2020 2020 2020 2020  r_info).        
+000529f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00052a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052a10: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00052a20: 6e74 732e 706c 6f74 2820 7470 726f 5b27  nts.plot( tpro['
-00052a30: 6d65 616e 426f 6c64 275d 2c20 616e 7473  meanBold'], ants
-00052a40: 2e69 4d61 7468 2874 7072 6f5b 2761 6c66  .iMath(tpro['alf
-00052a50: 6627 5d2c 224e 6f72 6d61 6c69 7a65 2229  f'],"Normalize")
-00052a60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00052a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052a80: 2020 2020 2020 2020 2020 2020 2020 6178                ax
-00052a90: 6973 3d32 2c20 6e73 6c69 6365 733d 6d61  is=2, nslices=ma
-00052aa0: 7873 6c69 6365 2c20 6e63 6f6c 3d37 2c20  xslice, ncol=7, 
-00052ab0: 6372 6f70 3d54 7275 652c 2074 6974 6c65  crop=True, title
-00052ac0: 3d27 414c 4646 272c 2066 696c 656e 616d  ='ALFF', filenam
-00052ad0: 653d 7470 726f 7072 6566 6978 2b22 626f  e=tproprefix+"bo
-00052ae0: 6c64 414c 4646 2e70 6e67 2220 290a 2020  ldALFF.png" ).  
-00052af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052b10: 2020 2020 2020 616e 7473 2e70 6c6f 7428        ants.plot(
-00052b20: 2074 7072 6f5b 276d 6561 6e42 6f6c 6427   tpro['meanBold'
-00052b30: 5d2c 2061 6e74 732e 694d 6174 6828 7470  ], ants.iMath(tp
-00052b40: 726f 5b27 6661 6c66 6627 5d2c 224e 6f72  ro['falff'],"Nor
-00052b50: 6d61 6c69 7a65 2229 2c0a 2020 2020 2020  malize"),.      
-00052b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052a10: 7669 7375 616c 697a 653d 4661 6c73 650a  visualize=False.
+00052a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052a40: 2020 2020 2020 2020 646f 7772 6974 653d          dowrite=
+00052a50: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+00052a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052a70: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+00052a80: 6250 726f 3d7b 2772 7366 273a 4e6f 6e65  bPro={'rsf':None
+00052a90: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00052aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052ab0: 2020 2020 2020 2020 2020 6e6f 726d 5072            normPr
+00052ac0: 6f3d 7b27 7273 6627 3a4e 6f6e 657d 0a20  o={'rsf':None}. 
+00052ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052af0: 2020 2020 2020 2070 7269 6e74 2866 2261         print(f"a
+00052b00: 6e74 7370 796d 6d65 7272 6f72 206f 6363  ntspymmerror occ
+00052b10: 7572 7265 6420 7768 696c 6520 7072 6f63  urred while proc
+00052b20: 6573 7369 6e67 207b 6f76 6572 6d6f 6458  essing {overmodX
+00052b30: 7d3a 207b 657d 2229 0a20 2020 2020 2020  }: {e}").       
+00052b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052b60: 2070 6173 730a 2020 2020 2020 2020 2020   pass.          
 00052b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052b80: 2020 2020 2020 6178 6973 3d32 2c20 6e73        axis=2, ns
-00052b90: 6c69 6365 733d 6d61 7873 6c69 6365 2c20  lices=maxslice, 
-00052ba0: 6e63 6f6c 3d37 2c20 6372 6f70 3d54 7275  ncol=7, crop=Tru
-00052bb0: 652c 2074 6974 6c65 3d27 6641 4c46 4627  e, title='fALFF'
-00052bc0: 2c20 6669 6c65 6e61 6d65 3d74 7072 6f70  , filename=tprop
-00052bd0: 7265 6669 782b 2262 6f6c 6466 414c 4646  refix+"boldfALFF
-00052be0: 2e70 6e67 2220 290a 2020 2020 2020 2020  .png" ).        
-00052bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052b80: 2020 2020 2020 6966 2074 6162 5072 6f5b        if tabPro[
+00052b90: 2772 7366 275d 2069 7320 6e6f 7420 4e6f  'rsf'] is not No
+00052ba0: 6e65 2061 6e64 2076 6973 7561 6c69 7a65  ne and visualize
+00052bb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00052bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052bd0: 2020 2020 2020 666f 7220 7470 726f 2069        for tpro i
+00052be0: 6e20 7461 6250 726f 5b27 7273 6627 5d3a  n tabPro['rsf']:
+00052bf0: 2023 2046 4958 4d45 5253 460a 2020 2020   # FIXMERSF.    
 00052c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052c10: 6466 6e3d 7470 726f 5b27 6466 6e6e 616d  dfn=tpro['dfnnam
-00052c20: 6527 5d0a 2020 2020 2020 2020 2020 2020  e'].            
-00052c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052c40: 2020 2020 2020 2020 2020 2020 616e 7473              ants
-00052c50: 2e70 6c6f 7428 2074 7072 6f5b 276d 6561  .plot( tpro['mea
-00052c60: 6e42 6f6c 6427 5d2c 2074 7072 6f5b 6466  nBold'], tpro[df
-00052c70: 6e5d 2c0a 2020 2020 2020 2020 2020 2020  n],.            
-00052c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052ca0: 6178 6973 3d32 2c20 6e73 6c69 6365 733d  axis=2, nslices=
-00052cb0: 6d61 7873 6c69 6365 2c20 6e63 6f6c 3d37  maxslice, ncol=7
-00052cc0: 2c20 6372 6f70 3d54 7275 652c 2074 6974  , crop=True, tit
-00052cd0: 6c65 3d64 666e 2c20 6669 6c65 6e61 6d65  le=dfn, filename
-00052ce0: 3d74 7072 6f70 7265 6669 782b 2262 6f6c  =tproprefix+"bol
-00052cf0: 6444 6566 6175 6c74 4d6f 6465 2e70 6e67  dDefaultMode.png
-00052d00: 2220 290a 2020 2020 2020 2020 2020 2020  " ).            
+00052c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052c20: 2020 2020 6d61 7873 6c69 6365 203d 206e      maxslice = n
+00052c30: 702e 6d69 6e28 205b 3231 2c20 7470 726f  p.min( [21, tpro
+00052c40: 5b27 6d65 616e 426f 6c64 275d 2e73 6861  ['meanBold'].sha
+00052c50: 7065 5b32 5d20 5d20 290a 2020 2020 2020  pe[2] ] ).      
+00052c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052c80: 2020 7470 726f 7072 6566 6978 203d 206d    tproprefix = m
+00052c90: 796d 6d2b 6d79 7365 702b 7374 7228 7470  ymm+mysep+str(tp
+00052ca0: 726f 5b27 7061 7261 6d73 6574 275d 292b  ro['paramset'])+
+00052cb0: 6d79 7365 700a 2020 2020 2020 2020 2020  mysep.          
+00052cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052cd0: 2020 2020 2020 2020 2020 2020 2020 616e                an
+00052ce0: 7473 2e70 6c6f 7428 2074 7072 6f5b 276d  ts.plot( tpro['m
+00052cf0: 6561 6e42 6f6c 6427 5d2c 0a20 2020 2020  eanBold'],.     
+00052d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00052d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052d20: 6966 2028 206d 796d 6f64 203d 3d20 2770  if ( mymod == 'p
-00052d30: 6572 6627 2029 2061 6e64 2069 7368 6170  erf' ) and ishap
-00052d40: 656c 656e 203d 3d20 343a 0a20 2020 2020  elen == 4:.     
-00052d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052d60: 2020 2020 2020 2020 2020 2064 6f77 7269             dowri
-00052d70: 7465 3d54 7275 650a 2020 2020 2020 2020  te=True.        
-00052d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052d90: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00052d20: 2020 2020 2020 2061 7869 733d 322c 206e         axis=2, n
+00052d30: 736c 6963 6573 3d6d 6178 736c 6963 652c  slices=maxslice,
+00052d40: 206e 636f 6c3d 372c 2063 726f 703d 5472   ncol=7, crop=Tr
+00052d50: 7565 2c20 7469 746c 653d 276d 6561 6e42  ue, title='meanB
+00052d60: 4f4c 4427 2c20 6669 6c65 6e61 6d65 3d74  OLD', filename=t
+00052d70: 7072 6f70 7265 6669 782b 226d 6561 6e42  proprefix+"meanB
+00052d80: 4f4c 442e 706e 6722 2029 0a20 2020 2020  OLD.png" ).     
+00052d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00052da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052dc0: 2074 6162 5072 6f2c 206e 6f72 6d50 726f   tabPro, normPro
-00052dd0: 203d 206d 6d28 2074 312c 2068 6965 722c   = mm( t1, hier,
-00052de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00052df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052e00: 2020 2020 2020 2020 2070 6572 6675 7369           perfusi
-00052e10: 6f6e 5f69 6d61 6765 3d69 6d67 2c0a 2020  on_image=img,.  
-00052e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052e40: 2020 2020 2020 7372 6d6f 6465 6c3d 4e6f        srmodel=No
-00052e50: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00052e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052e70: 2020 2020 2020 2020 2020 2020 646f 5f74              do_t
-00052e80: 7261 6374 6f67 7261 7068 793d 4661 6c73  ractography=Fals
-00052e90: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00052ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052eb0: 2020 2020 2020 2020 2020 2064 6f5f 6b6b             do_kk
-00052ec0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-00052ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052ef0: 646f 5f6e 6f72 6d61 6c69 7a61 7469 6f6e  do_normalization
-00052f00: 3d74 656d 706c 6174 6554 782c 0a20 2020  =templateTx,.   
-00052f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052f30: 2020 2020 2067 726f 7570 5f74 656d 706c       group_templ
-00052f40: 6174 6520 3d20 6e6f 726d 616c 697a 6174  ate = normalizat
-00052f50: 696f 6e5f 7465 6d70 6c61 7465 2c0a 2020  ion_template,.  
-00052f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052f80: 2020 2020 2020 6772 6f75 705f 7472 616e        group_tran
-00052f90: 7366 6f72 6d20 3d20 6772 6f75 7054 782c  sform = groupTx,
-00052fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00052fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052fc0: 2020 2020 2020 2020 2074 6573 745f 7275           test_ru
-00052fd0: 6e3d 7465 7374 5f72 756e 2c0a 2020 2020  n=test_run,.    
-00052fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053000: 2020 2020 7065 7266 7573 696f 6e5f 7472      perfusion_tr
-00053010: 696d 3d70 6572 6675 7369 6f6e 5f74 7269  im=perfusion_tri
-00053020: 6d2c 0a20 2020 2020 2020 2020 2020 2020  m,.             
-00053030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053040: 2020 2020 2020 2020 2020 2070 6572 6675             perfu
-00053050: 7369 6f6e 5f6d 305f 696d 6167 653d 7065  sion_m0_image=pe
-00053060: 7266 7573 696f 6e5f 6d30 5f69 6d61 6765  rfusion_m0_image
-00053070: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00053080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053090: 2020 2020 2020 2020 2020 7065 7266 7573            perfus
-000530a0: 696f 6e5f 6d30 3d70 6572 6675 7369 6f6e  ion_m0=perfusion
-000530b0: 5f6d 302c 0a20 2020 2020 2020 2020 2020  _m0,.           
-000530c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000530d0: 2020 2020 2020 2020 2020 2020 2076 6572               ver
-000530e0: 626f 7365 3d54 7275 6520 290a 2020 2020  bose=True ).    
-000530f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053100: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00053110: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
-00053120: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00053130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053140: 2020 2020 2020 2020 2020 2065 7272 6f72             error
-00053150: 5f69 6e66 6f20 3d20 7472 6163 6562 6163  _info = tracebac
-00053160: 6b2e 666f 726d 6174 5f65 7863 2829 0a20  k.format_exc(). 
-00053170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052db0: 2020 2061 6e74 732e 706c 6f74 2820 7470     ants.plot( tp
+00052dc0: 726f 5b27 6d65 616e 426f 6c64 275d 2c20  ro['meanBold'], 
+00052dd0: 616e 7473 2e69 4d61 7468 2874 7072 6f5b  ants.iMath(tpro[
+00052de0: 2761 6c66 6627 5d2c 224e 6f72 6d61 6c69  'alff'],"Normali
+00052df0: 7a65 2229 2c0a 2020 2020 2020 2020 2020  ze"),.          
+00052e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052e20: 2020 6178 6973 3d32 2c20 6e73 6c69 6365    axis=2, nslice
+00052e30: 733d 6d61 7873 6c69 6365 2c20 6e63 6f6c  s=maxslice, ncol
+00052e40: 3d37 2c20 6372 6f70 3d54 7275 652c 2074  =7, crop=True, t
+00052e50: 6974 6c65 3d27 414c 4646 272c 2066 696c  itle='ALFF', fil
+00052e60: 656e 616d 653d 7470 726f 7072 6566 6978  ename=tproprefix
+00052e70: 2b22 626f 6c64 414c 4646 2e70 6e67 2220  +"boldALFF.png" 
+00052e80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00052e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052ea0: 2020 2020 2020 2020 2020 616e 7473 2e70            ants.p
+00052eb0: 6c6f 7428 2074 7072 6f5b 276d 6561 6e42  lot( tpro['meanB
+00052ec0: 6f6c 6427 5d2c 2061 6e74 732e 694d 6174  old'], ants.iMat
+00052ed0: 6828 7470 726f 5b27 6661 6c66 6627 5d2c  h(tpro['falff'],
+00052ee0: 224e 6f72 6d61 6c69 7a65 2229 2c0a 2020  "Normalize"),.  
+00052ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052f10: 2020 2020 2020 2020 2020 6178 6973 3d32            axis=2
+00052f20: 2c20 6e73 6c69 6365 733d 6d61 7873 6c69  , nslices=maxsli
+00052f30: 6365 2c20 6e63 6f6c 3d37 2c20 6372 6f70  ce, ncol=7, crop
+00052f40: 3d54 7275 652c 2074 6974 6c65 3d27 6641  =True, title='fA
+00052f50: 4c46 4627 2c20 6669 6c65 6e61 6d65 3d74  LFF', filename=t
+00052f60: 7072 6f70 7265 6669 782b 2262 6f6c 6466  proprefix+"boldf
+00052f70: 414c 4646 2e70 6e67 2220 290a 2020 2020  ALFF.png" ).    
+00052f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052fa0: 2020 2020 6466 6e3d 7470 726f 5b27 6466      dfn=tpro['df
+00052fb0: 6e6e 616d 6527 5d0a 2020 2020 2020 2020  nname'].        
+00052fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052fe0: 616e 7473 2e70 6c6f 7428 2074 7072 6f5b  ants.plot( tpro[
+00052ff0: 276d 6561 6e42 6f6c 6427 5d2c 2074 7072  'meanBold'], tpr
+00053000: 6f5b 6466 6e5d 2c0a 2020 2020 2020 2020  o[dfn],.        
+00053010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053030: 2020 2020 6178 6973 3d32 2c20 6e73 6c69      axis=2, nsli
+00053040: 6365 733d 6d61 7873 6c69 6365 2c20 6e63  ces=maxslice, nc
+00053050: 6f6c 3d37 2c20 6372 6f70 3d54 7275 652c  ol=7, crop=True,
+00053060: 2074 6974 6c65 3d64 666e 2c20 6669 6c65   title=dfn, file
+00053070: 6e61 6d65 3d74 7072 6f70 7265 6669 782b  name=tproprefix+
+00053080: 2262 6f6c 6444 6566 6175 6c74 4d6f 6465  "boldDefaultMode
+00053090: 2e70 6e67 2220 290a 2020 2020 2020 2020  .png" ).        
+000530a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000530b0: 2020 2020 6966 2028 206d 796d 6f64 203d      if ( mymod =
+000530c0: 3d20 2770 6572 6627 2029 2061 6e64 2069  = 'perf' ) and i
+000530d0: 7368 6170 656c 656e 203d 3d20 343a 0a20  shapelen == 4:. 
+000530e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000530f0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00053100: 6f77 7269 7465 3d54 7275 650a 2020 2020  owrite=True.    
+00053110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053120: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00053130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00053140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053150: 2020 2020 2074 6162 5072 6f2c 206e 6f72       tabPro, nor
+00053160: 6d50 726f 203d 206d 6d28 2074 312c 2068  mPro = mm( t1, h
+00053170: 6965 722c 0a20 2020 2020 2020 2020 2020  ier,.           
 00053180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053190: 2020 2020 2020 2070 7269 6e74 2865 7272         print(err
-000531a0: 6f72 5f69 6e66 6f29 0a20 2020 2020 2020  or_info).       
-000531b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053190: 2020 2020 2020 2020 2020 2020 2070 6572               per
+000531a0: 6675 7369 6f6e 5f69 6d61 6765 3d69 6d67  fusion_image=img
+000531b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 000531c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000531d0: 2076 6973 7561 6c69 7a65 3d46 616c 7365   visualize=False
-000531e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000531d0: 2020 2020 2020 2020 2020 7372 6d6f 6465            srmode
+000531e0: 6c3d 4e6f 6e65 2c0a 2020 2020 2020 2020  l=None,.        
 000531f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053200: 2020 2020 2020 2020 2064 6f77 7269 7465           dowrite
-00053210: 3d46 616c 7365 0a20 2020 2020 2020 2020  =False.         
-00053220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053230: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00053240: 6162 5072 6f3d 7b27 7065 7266 273a 4e6f  abPro={'perf':No
-00053250: 6e65 7d0a 2020 2020 2020 2020 2020 2020  ne}.            
+00053200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053210: 646f 5f74 7261 6374 6f67 7261 7068 793d  do_tractography=
+00053220: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
+00053230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053240: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00053250: 6f5f 6b6b 3d46 616c 7365 2c0a 2020 2020  o_kk=False,.    
 00053260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053270: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00053280: 7428 6622 616e 7473 7079 6d6d 6572 726f  t(f"antspymmerro
-00053290: 7220 6f63 6375 7272 6564 2077 6869 6c65  r occurred while
-000532a0: 2070 726f 6365 7373 696e 6720 7b6f 7665   processing {ove
-000532b0: 726d 6f64 587d 3a20 7b65 7d22 290a 2020  rmodX}: {e}").  
-000532c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000532d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000532e0: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
-000532f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053300: 2020 2020 2020 2020 2020 2069 6620 7461             if ta
-00053310: 6250 726f 5b27 7065 7266 275d 2069 7320  bPro['perf'] is 
-00053320: 6e6f 7420 4e6f 6e65 2061 6e64 2076 6973  not None and vis
-00053330: 7561 6c69 7a65 3a0a 2020 2020 2020 2020  ualize:.        
+00053270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053280: 2020 2020 646f 5f6e 6f72 6d61 6c69 7a61      do_normaliza
+00053290: 7469 6f6e 3d74 656d 706c 6174 6554 782c  tion=templateTx,
+000532a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000532b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000532c0: 2020 2020 2020 2020 2067 726f 7570 5f74           group_t
+000532d0: 656d 706c 6174 6520 3d20 6e6f 726d 616c  emplate = normal
+000532e0: 697a 6174 696f 6e5f 7465 6d70 6c61 7465  ization_template
+000532f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00053300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053310: 2020 2020 2020 2020 2020 6772 6f75 705f            group_
+00053320: 7472 616e 7366 6f72 6d20 3d20 6772 6f75  transform = grou
+00053330: 7054 782c 0a20 2020 2020 2020 2020 2020  pTx,.           
 00053340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053350: 2020 2020 2020 2020 2020 2020 6d61 7873              maxs
-00053360: 6c69 6365 203d 206e 702e 6d69 6e28 205b  lice = np.min( [
-00053370: 3231 2c20 7461 6250 726f 5b27 7065 7266  21, tabPro['perf
-00053380: 275d 5b27 6d65 616e 426f 6c64 275d 2e73  ']['meanBold'].s
-00053390: 6861 7065 5b32 5d20 5d20 290a 2020 2020  hape[2] ] ).    
-000533a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000533b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000533c0: 616e 7473 2e70 6c6f 7428 2074 6162 5072  ants.plot( tabPr
-000533d0: 6f5b 2770 6572 6627 5d5b 2770 6572 6675  o['perf']['perfu
-000533e0: 7369 6f6e 275d 2c0a 2020 2020 2020 2020  sion'],.        
-000533f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053410: 6178 6973 3d32 2c20 6e73 6c69 6365 733d  axis=2, nslices=
-00053420: 6d61 7873 6c69 6365 2c20 6e63 6f6c 3d37  maxslice, ncol=7
-00053430: 2c20 6372 6f70 3d54 7275 652c 2074 6974  , crop=True, tit
-00053440: 6c65 3d27 7065 7266 7573 696f 6e20 696d  le='perfusion im
-00053450: 6167 6527 2c20 6669 6c65 6e61 6d65 3d6d  age', filename=m
-00053460: 796d 6d2b 6d79 7365 702b 2270 6572 6675  ymm+mysep+"perfu
-00053470: 7369 6f6e 2e70 6e67 2220 290a 2020 2020  sion.png" ).    
+00053350: 2020 2020 2020 2020 2020 2020 2074 6573               tes
+00053360: 745f 7275 6e3d 7465 7374 5f72 756e 2c0a  t_run=test_run,.
+00053370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053390: 2020 2020 2020 2020 7065 7266 7573 696f          perfusio
+000533a0: 6e5f 7472 696d 3d70 6572 6675 7369 6f6e  n_trim=perfusion
+000533b0: 5f74 7269 6d2c 0a20 2020 2020 2020 2020  _trim,.         
+000533c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000533d0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000533e0: 6572 6675 7369 6f6e 5f6d 305f 696d 6167  erfusion_m0_imag
+000533f0: 653d 7065 7266 7573 696f 6e5f 6d30 5f69  e=perfusion_m0_i
+00053400: 6d61 6765 2c0a 2020 2020 2020 2020 2020  mage,.          
+00053410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053420: 2020 2020 2020 2020 2020 2020 2020 7065                pe
+00053430: 7266 7573 696f 6e5f 6d30 3d70 6572 6675  rfusion_m0=perfu
+00053440: 7369 6f6e 5f6d 302c 0a20 2020 2020 2020  sion_m0,.       
+00053450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053470: 2076 6572 626f 7365 3d54 7275 6520 290a   verbose=True ).
 00053480: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00053490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000534a0: 616e 7473 2e70 6c6f 7428 2074 6162 5072  ants.plot( tabPr
-000534b0: 6f5b 2770 6572 6627 5d5b 2763 6266 275d  o['perf']['cbf']
-000534c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000534d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000534e0: 2020 2020 2020 2020 2020 6178 6973 3d32            axis=2
-000534f0: 2c20 6e73 6c69 6365 733d 6d61 7873 6c69  , nslices=maxsli
-00053500: 6365 2c20 6e63 6f6c 3d37 2c20 6372 6f70  ce, ncol=7, crop
-00053510: 3d54 7275 652c 2074 6974 6c65 3d27 4342  =True, title='CB
-00053520: 4620 696d 6167 6527 2c20 6669 6c65 6e61  F image', filena
-00053530: 6d65 3d6d 796d 6d2b 6d79 7365 702b 2263  me=mymm+mysep+"c
-00053540: 6266 2e70 6e67 2220 290a 2020 2020 2020  bf.png" ).      
+000534a0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+000534b0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+000534c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000534d0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000534e0: 7272 6f72 5f69 6e66 6f20 3d20 7472 6163  rror_info = trac
+000534f0: 6562 6163 6b2e 666f 726d 6174 5f65 7863  eback.format_exc
+00053500: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00053510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053520: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00053530: 2865 7272 6f72 5f69 6e66 6f29 0a20 2020  (error_info).   
+00053540: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00053550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053560: 2020 2020 2020 2020 2020 2020 2020 616e                an
-00053570: 7473 2e70 6c6f 7428 2074 6162 5072 6f5b  ts.plot( tabPro[
-00053580: 2770 6572 6627 5d5b 276d 3027 5d2c 0a20  'perf']['m0'],. 
-00053590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000535a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000535b0: 2020 2020 2020 2061 7869 733d 322c 206e         axis=2, n
-000535c0: 736c 6963 6573 3d6d 6178 736c 6963 652c  slices=maxslice,
-000535d0: 206e 636f 6c3d 372c 2063 726f 703d 5472   ncol=7, crop=Tr
-000535e0: 7565 2c20 7469 746c 653d 274d 3020 696d  ue, title='M0 im
-000535f0: 6167 6527 2c20 6669 6c65 6e61 6d65 3d6d  age', filename=m
-00053600: 796d 6d2b 6d79 7365 702b 226d 302e 706e  ymm+mysep+"m0.pn
-00053610: 6722 2029 0a20 2020 2020 2020 2020 2020  g" ).           
-00053620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053630: 2069 6620 2820 6d79 6d6f 6420 3d3d 2027   if ( mymod == '
-00053640: 4454 495f 4c52 2720 6f72 206d 796d 6f64  DTI_LR' or mymod
-00053650: 203d 3d20 2744 5449 5f52 4c27 206f 7220   == 'DTI_RL' or 
-00053660: 6d79 6d6f 6420 3d3d 2027 4454 4927 2029  mymod == 'DTI' )
-00053670: 2061 6e64 2069 7368 6170 656c 656e 203d   and ishapelen =
-00053680: 3d20 343a 0a20 2020 2020 2020 2020 2020  = 4:.           
-00053690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000536a0: 2020 2020 2062 7661 6c66 6e20 3d20 7265       bvalfn = re
-000536b0: 2e73 7562 2820 272e 6e69 692e 677a 272c  .sub( '.nii.gz',
-000536c0: 2027 2e62 7661 6c27 202c 206d 7969 6d67   '.bval' , myimg
-000536d0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00053560: 2020 2020 2076 6973 7561 6c69 7a65 3d46       visualize=F
+00053570: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
+00053580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053590: 2020 2020 2020 2020 2020 2020 2064 6f77               dow
+000535a0: 7269 7465 3d46 616c 7365 0a20 2020 2020  rite=False.     
+000535b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000535c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000535d0: 2020 2074 6162 5072 6f3d 7b27 7065 7266     tabPro={'perf
+000535e0: 273a 4e6f 6e65 7d0a 2020 2020 2020 2020  ':None}.        
+000535f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053610: 7072 696e 7428 6622 616e 7473 7079 6d6d  print(f"antspymm
+00053620: 6572 726f 7220 6f63 6375 7272 6564 2077  error occurred w
+00053630: 6869 6c65 2070 726f 6365 7373 696e 6720  hile processing 
+00053640: 7b6f 7665 726d 6f64 587d 3a20 7b65 7d22  {overmodX}: {e}"
+00053650: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00053660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053670: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+00053680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053690: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000536a0: 6620 7461 6250 726f 5b27 7065 7266 275d  f tabPro['perf']
+000536b0: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+000536c0: 2076 6973 7561 6c69 7a65 3a0a 2020 2020   visualize:.    
+000536d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000536e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000536f0: 2020 2062 7665 6366 6e20 3d20 7265 2e73     bvecfn = re.s
-00053700: 7562 2820 272e 6e69 692e 677a 272c 2027  ub( '.nii.gz', '
-00053710: 2e62 7665 6327 202c 206d 7969 6d67 2029  .bvec' , myimg )
-00053720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000536f0: 6d61 7873 6c69 6365 203d 206e 702e 6d69  maxslice = np.mi
+00053700: 6e28 205b 3231 2c20 7461 6250 726f 5b27  n( [21, tabPro['
+00053710: 7065 7266 275d 5b27 6d65 616e 426f 6c64  perf']['meanBold
+00053720: 275d 2e73 6861 7065 5b32 5d20 5d20 290a  '].shape[2] ] ).
 00053730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053740: 2069 6d67 4c69 7374 203d 205b 2069 6d67   imgList = [ img
-00053750: 205d 0a20 2020 2020 2020 2020 2020 2020   ].             
-00053760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053770: 2020 2062 7661 6c66 6e4c 6973 7420 3d20     bvalfnList = 
-00053780: 5b20 6276 616c 666e 205d 0a20 2020 2020  [ bvalfn ].     
+00053740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053750: 2020 2020 616e 7473 2e70 6c6f 7428 2074      ants.plot( t
+00053760: 6162 5072 6f5b 2770 6572 6627 5d5b 2770  abPro['perf']['p
+00053770: 6572 6675 7369 6f6e 275d 2c0a 2020 2020  erfusion'],.    
+00053780: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00053790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000537a0: 2020 2020 2020 2020 2020 2062 7665 6366             bvecf
-000537b0: 6e4c 6973 7420 3d20 5b20 6276 6563 666e  nList = [ bvecfn
-000537c0: 205d 0a20 2020 2020 2020 2020 2020 2020   ].             
-000537d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000537e0: 2020 206d 6973 7369 6e67 5f64 7469 5f64     missing_dti_d
-000537f0: 6174 613d 4661 6c73 6520 2320 6276 616c  ata=False # bval
-00053800: 2c20 6276 6563 206f 7220 696d 6167 6573  , bvec or images
-00053810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000537a0: 2020 2020 6178 6973 3d32 2c20 6e73 6c69      axis=2, nsli
+000537b0: 6365 733d 6d61 7873 6c69 6365 2c20 6e63  ces=maxslice, nc
+000537c0: 6f6c 3d37 2c20 6372 6f70 3d54 7275 652c  ol=7, crop=True,
+000537d0: 2074 6974 6c65 3d27 7065 7266 7573 696f   title='perfusio
+000537e0: 6e20 696d 6167 6527 2c20 6669 6c65 6e61  n image', filena
+000537f0: 6d65 3d6d 796d 6d2b 6d79 7365 702b 2270  me=mymm+mysep+"p
+00053800: 6572 6675 7369 6f6e 2e70 6e67 2220 290a  erfusion.png" ).
+00053810: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00053820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053830: 2069 6620 6c65 6e28 206d 7969 6d67 7372   if len( myimgsr
-00053840: 2029 203d 3d20 323a 2020 2320 6669 6e64   ) == 2:  # find
-00053850: 2044 5449 5f52 4c0a 2020 2020 2020 2020   DTI_RL.        
+00053830: 2020 2020 616e 7473 2e70 6c6f 7428 2074      ants.plot( t
+00053840: 6162 5072 6f5b 2770 6572 6627 5d5b 2763  abPro['perf']['c
+00053850: 6266 275d 2c0a 2020 2020 2020 2020 2020  bf'],.          
 00053860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053870: 2020 2020 2020 2020 2020 2020 6474 696c              dtil
-00053880: 7266 6e20 3d20 6d79 696d 6773 725b 6d79  rfn = myimgsr[my
-00053890: 696d 6763 6f75 6e74 2b31 5d0a 2020 2020  imgcount+1].    
-000538a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000538b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000538c0: 6966 2065 7869 7374 7328 2064 7469 6c72  if exists( dtilr
-000538d0: 666e 2029 3a0a 2020 2020 2020 2020 2020  fn ):.          
+00053870: 2020 2020 2020 2020 2020 2020 2020 6178                ax
+00053880: 6973 3d32 2c20 6e73 6c69 6365 733d 6d61  is=2, nslices=ma
+00053890: 7873 6c69 6365 2c20 6e63 6f6c 3d37 2c20  xslice, ncol=7, 
+000538a0: 6372 6f70 3d54 7275 652c 2074 6974 6c65  crop=True, title
+000538b0: 3d27 4342 4620 696d 6167 6527 2c20 6669  ='CBF image', fi
+000538c0: 6c65 6e61 6d65 3d6d 796d 6d2b 6d79 7365  lename=mymm+myse
+000538d0: 702b 2263 6266 2e70 6e67 2220 290a 2020  p+"cbf.png" ).  
 000538e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000538f0: 2020 2020 2020 2020 2020 2020 2020 6276                bv
-00053900: 616c 666e 524c 203d 2072 652e 7375 6228  alfnRL = re.sub(
-00053910: 2027 2e6e 6969 2e67 7a27 2c20 272e 6276   '.nii.gz', '.bv
-00053920: 616c 2720 2c20 6474 696c 7266 6e20 290a  al' , dtilrfn ).
+000538f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053900: 2020 616e 7473 2e70 6c6f 7428 2074 6162    ants.plot( tab
+00053910: 5072 6f5b 2770 6572 6627 5d5b 276d 3027  Pro['perf']['m0'
+00053920: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
 00053930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053950: 2020 2020 2020 2020 6276 6563 666e 524c          bvecfnRL
-00053960: 203d 2072 652e 7375 6228 2027 2e6e 6969   = re.sub( '.nii
-00053970: 2e67 7a27 2c20 272e 6276 6563 2720 2c20  .gz', '.bvec' , 
-00053980: 6474 696c 7266 6e20 290a 2020 2020 2020  dtilrfn ).      
-00053990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000539a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000539b0: 2020 696d 6752 4c20 3d20 616e 7473 2e69    imgRL = ants.i
-000539c0: 6d61 6765 5f72 6561 6428 2064 7469 6c72  mage_read( dtilr
-000539d0: 666e 2029 0a20 2020 2020 2020 2020 2020  fn ).           
-000539e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000539f0: 2020 2020 2020 2020 2020 2020 2069 6d67               img
-00053a00: 4c69 7374 2e61 7070 656e 6428 2069 6d67  List.append( img
-00053a10: 524c 2029 0a20 2020 2020 2020 2020 2020  RL ).           
+00053940: 2020 2020 2020 2020 2020 2061 7869 733d             axis=
+00053950: 322c 206e 736c 6963 6573 3d6d 6178 736c  2, nslices=maxsl
+00053960: 6963 652c 206e 636f 6c3d 372c 2063 726f  ice, ncol=7, cro
+00053970: 703d 5472 7565 2c20 7469 746c 653d 274d  p=True, title='M
+00053980: 3020 696d 6167 6527 2c20 6669 6c65 6e61  0 image', filena
+00053990: 6d65 3d6d 796d 6d2b 6d79 7365 702b 226d  me=mymm+mysep+"m
+000539a0: 302e 706e 6722 2029 0a20 2020 2020 2020  0.png" ).       
+000539b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000539c0: 2020 2020 2069 6620 2820 6d79 6d6f 6420       if ( mymod 
+000539d0: 3d3d 2027 4454 495f 4c52 2720 6f72 206d  == 'DTI_LR' or m
+000539e0: 796d 6f64 203d 3d20 2744 5449 5f52 4c27  ymod == 'DTI_RL'
+000539f0: 206f 7220 6d79 6d6f 6420 3d3d 2027 4454   or mymod == 'DT
+00053a00: 4927 2029 2061 6e64 2069 7368 6170 656c  I' ) and ishapel
+00053a10: 656e 203d 3d20 343a 0a20 2020 2020 2020  en == 4:.       
 00053a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053a30: 2020 2020 2020 2020 2020 2020 2062 7661               bva
-00053a40: 6c66 6e4c 6973 742e 6170 7065 6e64 2820  lfnList.append( 
-00053a50: 6276 616c 666e 524c 2029 0a20 2020 2020  bvalfnRL ).     
-00053a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053a30: 2020 2020 2020 2020 2062 7661 6c66 6e20           bvalfn 
+00053a40: 3d20 7265 2e73 7562 2820 272e 6e69 692e  = re.sub( '.nii.
+00053a50: 677a 272c 2027 2e62 7661 6c27 202c 206d  gz', '.bval' , m
+00053a60: 7969 6d67 2029 0a20 2020 2020 2020 2020  yimg ).         
 00053a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053a80: 2020 2062 7665 6366 6e4c 6973 742e 6170     bvecfnList.ap
-00053a90: 7065 6e64 2820 6276 6563 666e 524c 2029  pend( bvecfnRL )
-00053aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00053ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053ac0: 2065 6c69 6620 6c65 6e28 206d 7969 6d67   elif len( myimg
-00053ad0: 7372 2029 203d 3d20 333a 2020 2320 6669  sr ) == 3:  # fi
-00053ae0: 6e64 2044 5449 5f52 4c0a 2020 2020 2020  nd DTI_RL.      
+00053a80: 2020 2020 2020 2062 7665 6366 6e20 3d20         bvecfn = 
+00053a90: 7265 2e73 7562 2820 272e 6e69 692e 677a  re.sub( '.nii.gz
+00053aa0: 272c 2027 2e62 7665 6327 202c 206d 7969  ', '.bvec' , myi
+00053ab0: 6d67 2029 0a20 2020 2020 2020 2020 2020  mg ).           
+00053ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053ad0: 2020 2020 2069 6d67 4c69 7374 203d 205b       imgList = [
+00053ae0: 2069 6d67 205d 0a20 2020 2020 2020 2020   img ].         
 00053af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053b00: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00053b10: 696e 7428 2244 5449 2074 7269 6e69 7479  int("DTI trinity
-00053b20: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00053b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053b40: 2020 2020 2020 2064 7469 6c72 666e 203d         dtilrfn =
-00053b50: 206d 7969 6d67 7372 5b6d 7969 6d67 636f   myimgsr[myimgco
-00053b60: 756e 742b 315d 0a20 2020 2020 2020 2020  unt+1].         
-00053b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053b80: 2020 2020 2020 2020 2020 2064 7469 6c72             dtilr
-00053b90: 666e 3220 3d20 6d79 696d 6773 725b 6d79  fn2 = myimgsr[my
-00053ba0: 696d 6763 6f75 6e74 2b32 5d0a 2020 2020  imgcount+2].    
+00053b00: 2020 2020 2020 2062 7661 6c66 6e4c 6973         bvalfnLis
+00053b10: 7420 3d20 5b20 6276 616c 666e 205d 0a20  t = [ bvalfn ]. 
+00053b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053b30: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00053b40: 7665 6366 6e4c 6973 7420 3d20 5b20 6276  vecfnList = [ bv
+00053b50: 6563 666e 205d 0a20 2020 2020 2020 2020  ecfn ].         
+00053b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053b70: 2020 2020 2020 206d 6973 7369 6e67 5f64         missing_d
+00053b80: 7469 5f64 6174 613d 4661 6c73 6520 2320  ti_data=False # 
+00053b90: 6276 616c 2c20 6276 6563 206f 7220 696d  bval, bvec or im
+00053ba0: 6167 6573 0a20 2020 2020 2020 2020 2020  ages.           
 00053bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053bd0: 6966 2065 7869 7374 7328 2064 7469 6c72  if exists( dtilr
-00053be0: 666e 2029 2061 6e64 2065 7869 7374 7328  fn ) and exists(
-00053bf0: 2064 7469 6c72 666e 3220 293a 0a20 2020   dtilrfn2 ):.   
+00053bc0: 2020 2020 2069 6620 6c65 6e28 206d 7969       if len( myi
+00053bd0: 6d67 7372 2029 203d 3d20 323a 2020 2320  mgsr ) == 2:  # 
+00053be0: 6669 6e64 2044 5449 5f52 4c0a 2020 2020  find DTI_RL.    
+00053bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00053c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053c20: 2020 2020 2062 7661 6c66 6e52 4c20 3d20       bvalfnRL = 
-00053c30: 7265 2e73 7562 2820 272e 6e69 692e 677a  re.sub( '.nii.gz
-00053c40: 272c 2027 2e62 7661 6c27 202c 2064 7469  ', '.bval' , dti
-00053c50: 6c72 666e 2029 0a20 2020 2020 2020 2020  lrfn ).         
-00053c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053c70: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00053c80: 7665 6366 6e52 4c20 3d20 7265 2e73 7562  vecfnRL = re.sub
-00053c90: 2820 272e 6e69 692e 677a 272c 2027 2e62  ( '.nii.gz', '.b
-00053ca0: 7665 6327 202c 2064 7469 6c72 666e 2029  vec' , dtilrfn )
-00053cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00053cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053cd0: 2020 2020 2020 2020 2062 7661 6c66 6e52           bvalfnR
-00053ce0: 4c32 203d 2072 652e 7375 6228 2027 2e6e  L2 = re.sub( '.n
-00053cf0: 6969 2e67 7a27 2c20 272e 6276 616c 2720  ii.gz', '.bval' 
-00053d00: 2c20 6474 696c 7266 6e32 2029 0a20 2020  , dtilrfn2 ).   
-00053d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053c10: 6474 696c 7266 6e20 3d20 6d79 696d 6773  dtilrfn = myimgs
+00053c20: 725b 6d79 696d 6763 6f75 6e74 2b31 5d0a  r[myimgcount+1].
+00053c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053c50: 2020 2020 6966 2065 7869 7374 7328 2064      if exists( d
+00053c60: 7469 6c72 666e 2029 3a0a 2020 2020 2020  tilrfn ):.      
+00053c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053c90: 2020 6276 616c 666e 524c 203d 2072 652e    bvalfnRL = re.
+00053ca0: 7375 6228 2027 2e6e 6969 2e67 7a27 2c20  sub( '.nii.gz', 
+00053cb0: 272e 6276 616c 2720 2c20 6474 696c 7266  '.bval' , dtilrf
+00053cc0: 6e20 290a 2020 2020 2020 2020 2020 2020  n ).            
+00053cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053ce0: 2020 2020 2020 2020 2020 2020 6276 6563              bvec
+00053cf0: 666e 524c 203d 2072 652e 7375 6228 2027  fnRL = re.sub( '
+00053d00: 2e6e 6969 2e67 7a27 2c20 272e 6276 6563  .nii.gz', '.bvec
+00053d10: 2720 2c20 6474 696c 7266 6e20 290a 2020  ' , dtilrfn ).  
 00053d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053d30: 2020 2020 2062 7665 6366 6e52 4c32 203d       bvecfnRL2 =
-00053d40: 2072 652e 7375 6228 2027 2e6e 6969 2e67   re.sub( '.nii.g
-00053d50: 7a27 2c20 272e 6276 6563 2720 2c20 6474  z', '.bvec' , dt
-00053d60: 696c 7266 6e32 2029 0a20 2020 2020 2020  ilrfn2 ).       
+00053d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053d40: 2020 2020 2020 696d 6752 4c20 3d20 616e        imgRL = an
+00053d50: 7473 2e69 6d61 6765 5f72 6561 6428 2064  ts.image_read( d
+00053d60: 7469 6c72 666e 2029 0a20 2020 2020 2020  tilrfn ).       
 00053d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00053d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053d90: 2069 6d67 524c 203d 2061 6e74 732e 696d   imgRL = ants.im
-00053da0: 6167 655f 7265 6164 2820 6474 696c 7266  age_read( dtilrf
-00053db0: 6e20 290a 2020 2020 2020 2020 2020 2020  n ).            
+00053d90: 2069 6d67 4c69 7374 2e61 7070 656e 6428   imgList.append(
+00053da0: 2069 6d67 524c 2029 0a20 2020 2020 2020   imgRL ).       
+00053db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00053dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053dd0: 2020 2020 2020 2020 2020 2020 696d 6752              imgR
-00053de0: 4c32 203d 2061 6e74 732e 696d 6167 655f  L2 = ants.image_
-00053df0: 7265 6164 2820 6474 696c 7266 6e32 2029  read( dtilrfn2 )
-00053e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00053e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053e20: 2020 2020 2020 2020 2062 7661 6c73 2c20           bvals, 
-00053e30: 6276 6563 7320 3d20 7265 6164 5f62 7661  bvecs = read_bva
-00053e40: 6c73 5f62 7665 6373 2820 6276 616c 666e  ls_bvecs( bvalfn
-00053e50: 524c 202c 2062 7665 6366 6e52 4c20 2029  RL , bvecfnRL  )
-00053e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00053e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053e80: 2020 2020 2020 2020 2070 7269 6e74 2820           print( 
-00053e90: 6276 616c 732e 6d61 7828 2920 290a 2020  bvals.max() ).  
-00053ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053ec0: 2020 2020 2020 6276 616c 7332 2c20 6276        bvals2, bv
-00053ed0: 6563 7332 203d 2072 6561 645f 6276 616c  ecs2 = read_bval
-00053ee0: 735f 6276 6563 7328 2062 7661 6c66 6e52  s_bvecs( bvalfnR
-00053ef0: 4c32 202c 2062 7665 6366 6e52 4c32 2020  L2 , bvecfnRL2  
-00053f00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00053f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053f20: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00053f30: 2062 7661 6c73 322e 6d61 7828 2920 290a   bvals2.max() ).
+00053dd0: 2062 7661 6c66 6e4c 6973 742e 6170 7065   bvalfnList.appe
+00053de0: 6e64 2820 6276 616c 666e 524c 2029 0a20  nd( bvalfnRL ). 
+00053df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053e10: 2020 2020 2020 2062 7665 6366 6e4c 6973         bvecfnLis
+00053e20: 742e 6170 7065 6e64 2820 6276 6563 666e  t.append( bvecfn
+00053e30: 524c 2029 0a20 2020 2020 2020 2020 2020  RL ).           
+00053e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053e50: 2020 2020 2065 6c69 6620 6c65 6e28 206d       elif len( m
+00053e60: 7969 6d67 7372 2029 203d 3d20 333a 2020  yimgsr ) == 3:  
+00053e70: 2320 6669 6e64 2044 5449 5f52 4c0a 2020  # find DTI_RL.  
+00053e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053ea0: 2020 7072 696e 7428 2244 5449 2074 7269    print("DTI tri
+00053eb0: 6e69 7479 2229 0a20 2020 2020 2020 2020  nity").         
+00053ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053ed0: 2020 2020 2020 2020 2020 2064 7469 6c72             dtilr
+00053ee0: 666e 203d 206d 7969 6d67 7372 5b6d 7969  fn = myimgsr[myi
+00053ef0: 6d67 636f 756e 742b 315d 0a20 2020 2020  mgcount+1].     
+00053f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053f10: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00053f20: 7469 6c72 666e 3220 3d20 6d79 696d 6773  tilrfn2 = myimgs
+00053f30: 725b 6d79 696d 6763 6f75 6e74 2b32 5d0a  r[myimgcount+2].
 00053f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00053f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053f60: 2020 2020 2020 2020 7465 6d70 203d 206d          temp = m
-00053f70: 6572 6765 5f64 7769 5f64 6174 6128 2069  erge_dwi_data( i
-00053f80: 6d67 524c 2c20 6276 616c 732c 2062 7665  mgRL, bvals, bve
-00053f90: 6373 2c20 696d 6752 4c32 2c20 6276 616c  cs, imgRL2, bval
-00053fa0: 7332 2c20 6276 6563 7332 2020 290a 2020  s2, bvecs2  ).  
-00053fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053fd0: 2020 2020 2020 696d 674c 6973 742e 6170        imgList.ap
-00053fe0: 7065 6e64 2820 7465 6d70 5b30 5d20 290a  pend( temp[0] ).
+00053f60: 2020 2020 6966 2065 7869 7374 7328 2064      if exists( d
+00053f70: 7469 6c72 666e 2029 2061 6e64 2065 7869  tilrfn ) and exi
+00053f80: 7374 7328 2064 7469 6c72 666e 3220 293a  sts( dtilrfn2 ):
+00053f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00053fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053fb0: 2020 2020 2020 2020 2062 7661 6c66 6e52           bvalfnR
+00053fc0: 4c20 3d20 7265 2e73 7562 2820 272e 6e69  L = re.sub( '.ni
+00053fd0: 692e 677a 272c 2027 2e62 7661 6c27 202c  i.gz', '.bval' ,
+00053fe0: 2064 7469 6c72 666e 2029 0a20 2020 2020   dtilrfn ).     
 00053ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00054000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054010: 2020 2020 2020 2020 6276 616c 666e 4c69          bvalfnLi
-00054020: 7374 2e61 7070 656e 6428 206d 796d 6d2b  st.append( mymm+
-00054030: 6d79 7365 702b 276a 6f69 6e65 642e 6276  mysep+'joined.bv
-00054040: 616c 2720 290a 2020 2020 2020 2020 2020  al' ).          
+00054010: 2020 2062 7665 6366 6e52 4c20 3d20 7265     bvecfnRL = re
+00054020: 2e73 7562 2820 272e 6e69 692e 677a 272c  .sub( '.nii.gz',
+00054030: 2027 2e62 7665 6327 202c 2064 7469 6c72   '.bvec' , dtilr
+00054040: 666e 2029 0a20 2020 2020 2020 2020 2020  fn ).           
 00054050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054060: 2020 2020 2020 2020 2020 2020 2020 6276                bv
-00054070: 6563 666e 4c69 7374 2e61 7070 656e 6428  ecfnList.append(
-00054080: 206d 796d 6d2b 6d79 7365 702b 276a 6f69   mymm+mysep+'joi
-00054090: 6e65 642e 6276 6563 2720 290a 2020 2020  ned.bvec' ).    
-000540a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054060: 2020 2020 2020 2020 2020 2020 2062 7661               bva
+00054070: 6c66 6e52 4c32 203d 2072 652e 7375 6228  lfnRL2 = re.sub(
+00054080: 2027 2e6e 6969 2e67 7a27 2c20 272e 6276   '.nii.gz', '.bv
+00054090: 616c 2720 2c20 6474 696c 7266 6e32 2029  al' , dtilrfn2 )
+000540a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 000540b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000540c0: 2020 2020 7772 6974 655f 6276 616c 735f      write_bvals_
-000540d0: 6276 6563 7328 2074 656d 705b 315d 2c20  bvecs( temp[1], 
-000540e0: 7465 6d70 5b32 5d2c 206d 796d 6d2b 6d79  temp[2], mymm+my
-000540f0: 7365 702b 276a 6f69 6e65 6427 2029 0a20  sep+'joined' ). 
+000540c0: 2020 2020 2020 2020 2062 7665 6366 6e52           bvecfnR
+000540d0: 4c32 203d 2072 652e 7375 6228 2027 2e6e  L2 = re.sub( '.n
+000540e0: 6969 2e67 7a27 2c20 272e 6276 6563 2720  ii.gz', '.bvec' 
+000540f0: 2c20 6474 696c 7266 6e32 2029 0a20 2020  , dtilrfn2 ).   
 00054100: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00054110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054120: 2020 2020 2020 2062 7661 6c73 582c 2062         bvalsX, b
-00054130: 7665 6373 5820 3d20 7265 6164 5f62 7661  vecsX = read_bva
-00054140: 6c73 5f62 7665 6373 2820 6276 616c 666e  ls_bvecs( bvalfn
-00054150: 524c 3220 2c20 6276 6563 666e 524c 3220  RL2 , bvecfnRL2 
-00054160: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00054170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054180: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00054190: 2820 6276 616c 7358 2e6d 6178 2829 2029  ( bvalsX.max() )
-000541a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000541b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000541c0: 2023 2063 6865 636b 2065 7869 7374 656e   # check existen
-000541d0: 6365 206f 6620 616c 6c20 6669 6c65 7320  ce of all files 
-000541e0: 6578 7065 6374 6564 202e 2e2e 0a20 2020  expected ....   
-000541f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054200: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00054210: 2064 7469 6578 2069 6e20 6276 616c 666e   dtiex in bvalfn
-00054220: 4c69 7374 2b62 7665 6366 6e4c 6973 742b  List+bvecfnList+
-00054230: 6d79 696d 6773 723a 0a20 2020 2020 2020  myimgsr:.       
+00054120: 2020 2020 2069 6d67 524c 203d 2061 6e74       imgRL = ant
+00054130: 732e 696d 6167 655f 7265 6164 2820 6474  s.image_read( dt
+00054140: 696c 7266 6e20 290a 2020 2020 2020 2020  ilrfn ).        
+00054150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054170: 696d 6752 4c32 203d 2061 6e74 732e 696d  imgRL2 = ants.im
+00054180: 6167 655f 7265 6164 2820 6474 696c 7266  age_read( dtilrf
+00054190: 6e32 2029 0a20 2020 2020 2020 2020 2020  n2 ).           
+000541a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000541b0: 2020 2020 2020 2020 2020 2020 2062 7661               bva
+000541c0: 6c73 2c20 6276 6563 7320 3d20 7265 6164  ls, bvecs = read
+000541d0: 5f62 7661 6c73 5f62 7665 6373 2820 6276  _bvals_bvecs( bv
+000541e0: 616c 666e 524c 202c 2062 7665 6366 6e52  alfnRL , bvecfnR
+000541f0: 4c20 2029 0a20 2020 2020 2020 2020 2020  L  ).           
+00054200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054210: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00054220: 6e74 2820 6276 616c 732e 6d61 7828 2920  nt( bvals.max() 
+00054230: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
 00054240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054250: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00054260: 6e6f 7420 6578 6973 7473 2864 7469 6578  not exists(dtiex
-00054270: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00054280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054290: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-000542a0: 2827 6d6d 5f63 7376 3a20 6d69 7373 696e  ('mm_csv: missin
-000542b0: 6720 6474 6920 6461 7461 2027 202b 2064  g dti data ' + d
-000542c0: 7469 6578 2029 0a20 2020 2020 2020 2020  tiex ).         
-000542d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000542e0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-000542f0: 6973 7369 6e67 5f64 7469 5f64 6174 613d  issing_dti_data=
-00054300: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-00054310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054320: 2020 2020 2020 2020 2020 2020 2064 6f77               dow
-00054330: 7269 7465 3d46 616c 7365 0a20 2020 2020  rite=False.     
-00054340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054350: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00054360: 7420 6d69 7373 696e 675f 6474 695f 6461  t missing_dti_da
-00054370: 7461 3a0a 2020 2020 2020 2020 2020 2020  ta:.            
-00054380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054390: 2020 2020 2020 2020 646f 7772 6974 653d          dowrite=
-000543a0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-000543b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000543c0: 2020 2020 2020 2020 2073 726d 6f64 656c           srmodel
-000543d0: 5f44 5449 5f6d 646c 3d4e 6f6e 650a 2020  _DTI_mdl=None.  
+00054250: 2020 2020 2020 2020 2020 6276 616c 7332            bvals2
+00054260: 2c20 6276 6563 7332 203d 2072 6561 645f  , bvecs2 = read_
+00054270: 6276 616c 735f 6276 6563 7328 2062 7661  bvals_bvecs( bva
+00054280: 6c66 6e52 4c32 202c 2062 7665 6366 6e52  lfnRL2 , bvecfnR
+00054290: 4c32 2020 290a 2020 2020 2020 2020 2020  L2  ).          
+000542a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000542b0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000542c0: 696e 7428 2062 7661 6c73 322e 6d61 7828  int( bvals2.max(
+000542d0: 2920 290a 2020 2020 2020 2020 2020 2020  ) ).            
+000542e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000542f0: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
+00054300: 203d 206d 6572 6765 5f64 7769 5f64 6174   = merge_dwi_dat
+00054310: 6128 2069 6d67 524c 2c20 6276 616c 732c  a( imgRL, bvals,
+00054320: 2062 7665 6373 2c20 696d 6752 4c32 2c20   bvecs, imgRL2, 
+00054330: 6276 616c 7332 2c20 6276 6563 7332 2020  bvals2, bvecs2  
+00054340: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00054350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054360: 2020 2020 2020 2020 2020 696d 674c 6973            imgLis
+00054370: 742e 6170 7065 6e64 2820 7465 6d70 5b30  t.append( temp[0
+00054380: 5d20 290a 2020 2020 2020 2020 2020 2020  ] ).            
+00054390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000543a0: 2020 2020 2020 2020 2020 2020 6276 616c              bval
+000543b0: 666e 4c69 7374 2e61 7070 656e 6428 206d  fnList.append( m
+000543c0: 796d 6d2b 6d79 7365 702b 276a 6f69 6e65  ymm+mysep+'joine
+000543d0: 642e 6276 616c 2720 290a 2020 2020 2020  d.bval' ).      
 000543e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000543f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054400: 2020 6966 2073 726d 6f64 656c 5f44 5449    if srmodel_DTI
-00054410: 2069 7320 6e6f 7420 4661 6c73 653a 0a20   is not False:. 
-00054420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054400: 2020 6276 6563 666e 4c69 7374 2e61 7070    bvecfnList.app
+00054410: 656e 6428 206d 796d 6d2b 6d79 7365 702b  end( mymm+mysep+
+00054420: 276a 6f69 6e65 642e 6276 6563 2720 290a  'joined.bvec' ).
 00054430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054440: 2020 2020 2020 2074 656d 7020 3d20 616e         temp = an
-00054450: 7473 2e67 6574 5f73 7061 6369 6e67 2869  ts.get_spacing(i
-00054460: 6d67 290a 2020 2020 2020 2020 2020 2020  mg).            
-00054470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054480: 2020 2020 2020 2020 2020 2020 6474 7370              dtsp
-00054490: 633d 5b74 656d 705b 305d 2c74 656d 705b  c=[temp[0],temp[
-000544a0: 315d 2c74 656d 705b 325d 5d0a 2020 2020  1],temp[2]].    
-000544b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000544c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000544d0: 2020 2020 6265 7374 7570 203d 2073 6971      bestup = siq
-000544e0: 2e6f 7074 696d 697a 655f 7570 7361 6d70  .optimize_upsamp
-000544f0: 6c69 6e67 5f73 6861 7065 2820 6474 7370  ling_shape( dtsp
-00054500: 632c 206d 6f64 616c 6974 793d 2744 5449  c, modality='DTI
-00054510: 2720 290a 2020 2020 2020 2020 2020 2020  ' ).            
-00054520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054530: 2020 2020 2020 2020 2020 2020 6d64 6c66              mdlf
-00054540: 6e20 3d20 6578 5f70 6174 686d 6d20 2b20  n = ex_pathmm + 
-00054550: 2273 6971 5f64 6566 6175 6c74 5f73 6973  "siq_default_sis
-00054560: 725f 2220 2b20 6265 7374 7570 202b 2022  r_" + bestup + "
-00054570: 5f31 6368 616e 5f66 6561 7476 6767 4c36  _1chan_featvggL6
-00054580: 5f62 6573 745f 6d64 6c2e 6835 220a 2020  _best_mdl.h5".  
+00054440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054450: 2020 2020 2020 2020 7772 6974 655f 6276          write_bv
+00054460: 616c 735f 6276 6563 7328 2074 656d 705b  als_bvecs( temp[
+00054470: 315d 2c20 7465 6d70 5b32 5d2c 206d 796d  1], temp[2], mym
+00054480: 6d2b 6d79 7365 702b 276a 6f69 6e65 6427  m+mysep+'joined'
+00054490: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+000544a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000544b0: 2020 2020 2020 2020 2020 2062 7661 6c73             bvals
+000544c0: 582c 2062 7665 6373 5820 3d20 7265 6164  X, bvecsX = read
+000544d0: 5f62 7661 6c73 5f62 7665 6373 2820 6276  _bvals_bvecs( bv
+000544e0: 616c 666e 524c 3220 2c20 6276 6563 666e  alfnRL2 , bvecfn
+000544f0: 524c 3220 2029 0a20 2020 2020 2020 2020  RL2  ).         
+00054500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054510: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00054520: 7269 6e74 2820 6276 616c 7358 2e6d 6178  rint( bvalsX.max
+00054530: 2829 2029 0a20 2020 2020 2020 2020 2020  () ).           
+00054540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054550: 2020 2020 2023 2063 6865 636b 2065 7869       # check exi
+00054560: 7374 656e 6365 206f 6620 616c 6c20 6669  stence of all fi
+00054570: 6c65 7320 6578 7065 6374 6564 202e 2e2e  les expected ...
+00054580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00054590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000545a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000545b0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-000545c0: 6e63 6528 2073 726d 6f64 656c 5f44 5449  nce( srmodel_DTI
-000545d0: 2c20 7374 7220 293a 0a20 2020 2020 2020  , str ):.       
+000545a0: 2066 6f72 2064 7469 6578 2069 6e20 6276   for dtiex in bv
+000545b0: 616c 666e 4c69 7374 2b62 7665 6366 6e4c  alfnList+bvecfnL
+000545c0: 6973 742b 6d79 696d 6773 723a 0a20 2020  ist+myimgsr:.   
+000545d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000545e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000545f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054600: 2020 2020 2073 726d 6f64 656c 5f44 5449       srmodel_DTI
-00054610: 203d 2072 652e 7375 6228 2022 6265 7374   = re.sub( "best
-00054620: 7570 222c 2062 6573 7475 702c 2073 726d  up", bestup, srm
-00054630: 6f64 656c 5f44 5449 2029 0a20 2020 2020  odel_DTI ).     
-00054640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054660: 2020 2020 2020 206d 646c 666e 203d 206f         mdlfn = o
-00054670: 732e 7061 7468 2e6a 6f69 6e28 2065 785f  s.path.join( ex_
-00054680: 7061 7468 6d6d 2c20 7372 6d6f 6465 6c5f  pathmm, srmodel_
-00054690: 4454 4920 290a 2020 2020 2020 2020 2020  DTI ).          
+000545f0: 2069 6620 6e6f 7420 6578 6973 7473 2864   if not exists(d
+00054600: 7469 6578 293a 0a20 2020 2020 2020 2020  tiex):.         
+00054610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054620: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00054630: 7269 6e74 2827 6d6d 5f63 7376 3a20 6d69  rint('mm_csv: mi
+00054640: 7373 696e 6720 6474 6920 6461 7461 2027  ssing dti data '
+00054650: 202b 2064 7469 6578 2029 0a20 2020 2020   + dtiex ).     
+00054660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054680: 2020 206d 6973 7369 6e67 5f64 7469 5f64     missing_dti_d
+00054690: 6174 613d 5472 7565 0a20 2020 2020 2020  ata=True.       
 000546a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000546b0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000546c0: 2065 7869 7374 7328 206d 646c 666e 2029   exists( mdlfn )
-000546d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000546e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000546f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00054700: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+000546b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000546c0: 2064 6f77 7269 7465 3d46 616c 7365 0a20   dowrite=False. 
+000546d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000546e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000546f0: 6620 6e6f 7420 6d69 7373 696e 675f 6474  f not missing_dt
+00054700: 695f 6461 7461 3a0a 2020 2020 2020 2020  i_data:.        
 00054710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054730: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00054740: 6d64 6c66 6e29 0a20 2020 2020 2020 2020  mdlfn).         
-00054750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054770: 2020 2073 726d 6f64 656c 5f44 5449 5f6d     srmodel_DTI_m
-00054780: 646c 203d 2074 662e 6b65 7261 732e 6d6f  dl = tf.keras.mo
-00054790: 6465 6c73 2e6c 6f61 645f 6d6f 6465 6c28  dels.load_model(
-000547a0: 206d 646c 666e 2c20 636f 6d70 696c 653d   mdlfn, compile=
-000547b0: 4661 6c73 6520 290a 2020 2020 2020 2020  False ).        
+00054720: 2020 2020 2020 2020 2020 2020 646f 7772              dowr
+00054730: 6974 653d 5472 7565 0a20 2020 2020 2020  ite=True.       
+00054740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054750: 2020 2020 2020 2020 2020 2020 2073 726d               srm
+00054760: 6f64 656c 5f44 5449 5f6d 646c 3d4e 6f6e  odel_DTI_mdl=Non
+00054770: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00054780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054790: 2020 2020 2020 6966 2073 726d 6f64 656c        if srmodel
+000547a0: 5f44 5449 2069 7320 6e6f 7420 4661 6c73  _DTI is not Fals
+000547b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
 000547c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000547d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000547e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000547f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000547d0: 2020 2020 2020 2020 2020 2074 656d 7020             temp 
+000547e0: 3d20 616e 7473 2e67 6574 5f73 7061 6369  = ants.get_spaci
+000547f0: 6e67 2869 6d67 290a 2020 2020 2020 2020  ng(img).        
 00054800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054810: 2020 7072 696e 7428 6d64 6c66 6e20 2b20    print(mdlfn + 
-00054820: 2220 646f 6573 206e 6f74 2065 7869 7374  " does not exist
-00054830: 202d 2077 6f6e 7420 7573 6520 5352 2229   - wont use SR")
-00054840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00054810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054820: 6474 7370 633d 5b74 656d 705b 305d 2c74  dtspc=[temp[0],t
+00054830: 656d 705b 315d 2c74 656d 705b 325d 5d0a  emp[1],temp[2]].
+00054840: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00054850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054860: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00054870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054890: 2020 7461 6250 726f 2c20 6e6f 726d 5072    tabPro, normPr
-000548a0: 6f20 3d20 6d6d 2820 7431 2c20 6869 6572  o = mm( t1, hier
-000548b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00054860: 2020 2020 2020 2020 6265 7374 7570 203d          bestup =
+00054870: 2073 6971 2e6f 7074 696d 697a 655f 7570   siq.optimize_up
+00054880: 7361 6d70 6c69 6e67 5f73 6861 7065 2820  sampling_shape( 
+00054890: 6474 7370 632c 206d 6f64 616c 6974 793d  dtspc, modality=
+000548a0: 2744 5449 2720 290a 2020 2020 2020 2020  'DTI' ).        
+000548b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000548c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000548d0: 2020 2020 2020 2020 2020 2020 2020 6477                dw
-000548e0: 5f69 6d61 6765 3d69 6d67 4c69 7374 2c0a  _image=imgList,.
-000548f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054910: 2020 2020 2020 2020 2020 2020 6276 616c              bval
-00054920: 7320 3d20 6276 616c 666e 4c69 7374 2c0a  s = bvalfnList,.
+000548d0: 6d64 6c66 6e20 3d20 6578 5f70 6174 686d  mdlfn = ex_pathm
+000548e0: 6d20 2b20 2273 6971 5f64 6566 6175 6c74  m + "siq_default
+000548f0: 5f73 6973 725f 2220 2b20 6265 7374 7570  _sisr_" + bestup
+00054900: 202b 2022 5f31 6368 616e 5f66 6561 7476   + "_1chan_featv
+00054910: 6767 4c36 5f62 6573 745f 6d64 6c2e 6835  ggL6_best_mdl.h5
+00054920: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
 00054930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054950: 2020 2020 2020 2020 2020 2020 6276 6563              bvec
-00054960: 7320 3d20 6276 6563 666e 4c69 7374 2c0a  s = bvecfnList,.
+00054940: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
+00054950: 6e73 7461 6e63 6528 2073 726d 6f64 656c  nstance( srmodel
+00054960: 5f44 5449 2c20 7374 7220 293a 0a20 2020  _DTI, str ):.   
 00054970: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00054980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054990: 2020 2020 2020 2020 2020 2020 7372 6d6f              srmo
-000549a0: 6465 6c3d 7372 6d6f 6465 6c5f 4454 495f  del=srmodel_DTI_
-000549b0: 6d64 6c2c 0a20 2020 2020 2020 2020 2020  mdl,.           
-000549c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054990: 2020 2020 2020 2020 2073 726d 6f64 656c           srmodel
+000549a0: 5f44 5449 203d 2072 652e 7375 6228 2022  _DTI = re.sub( "
+000549b0: 6265 7374 7570 222c 2062 6573 7475 702c  bestup", bestup,
+000549c0: 2073 726d 6f64 656c 5f44 5449 2029 0a20   srmodel_DTI ). 
 000549d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000549e0: 2064 6f5f 7472 6163 746f 6772 6170 6879   do_tractography
-000549f0: 3d6e 6f74 2074 6573 745f 7275 6e2c 0a20  =not test_run,. 
-00054a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054a20: 2020 2020 2020 2020 2020 2064 6f5f 6b6b             do_kk
-00054a30: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+000549e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000549f0: 2020 2020 2020 2020 2020 206d 646c 666e             mdlfn
+00054a00: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
+00054a10: 2065 785f 7061 7468 6d6d 2c20 7372 6d6f   ex_pathmm, srmo
+00054a20: 6465 6c5f 4454 4920 290a 2020 2020 2020  del_DTI ).      
+00054a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00054a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054a60: 2020 2020 646f 5f6e 6f72 6d61 6c69 7a61      do_normaliza
-00054a70: 7469 6f6e 3d74 656d 706c 6174 6554 782c  tion=templateTx,
-00054a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00054a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054aa0: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-00054ab0: 7570 5f74 656d 706c 6174 6520 3d20 6e6f  up_template = no
-00054ac0: 726d 616c 697a 6174 696f 6e5f 7465 6d70  rmalization_temp
-00054ad0: 6c61 7465 2c0a 2020 2020 2020 2020 2020  late,.          
+00054a50: 2020 6966 2065 7869 7374 7328 206d 646c    if exists( mdl
+00054a60: 666e 2029 3a0a 2020 2020 2020 2020 2020  fn ):.          
+00054a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054a90: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+00054aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054ac0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00054ad0: 696e 7428 6d64 6c66 6e29 0a20 2020 2020  int(mdlfn).     
 00054ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00054af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054b00: 2020 6772 6f75 705f 7472 616e 7366 6f72    group_transfor
-00054b10: 6d20 3d20 6772 6f75 7054 782c 0a20 2020  m = groupTx,.   
-00054b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054b40: 2020 2020 2020 2020 2064 7469 5f6d 6f74           dti_mot
-00054b50: 696f 6e5f 636f 7272 6563 7420 3d20 6474  ion_correct = dt
-00054b60: 695f 6d6f 7469 6f6e 5f63 6f72 7265 6374  i_motion_correct
-00054b70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00054b00: 2020 2020 2020 2073 726d 6f64 656c 5f44         srmodel_D
+00054b10: 5449 5f6d 646c 203d 2074 662e 6b65 7261  TI_mdl = tf.kera
+00054b20: 732e 6d6f 6465 6c73 2e6c 6f61 645f 6d6f  s.models.load_mo
+00054b30: 6465 6c28 206d 646c 666e 2c20 636f 6d70  del( mdlfn, comp
+00054b40: 696c 653d 4661 6c73 6520 290a 2020 2020  ile=False ).    
+00054b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054b70: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
 00054b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054b90: 2020 2020 2020 2020 2020 2020 2020 6474                dt
-00054ba0: 695f 6465 6e6f 6973 6520 3d20 6474 695f  i_denoise = dti_
-00054bb0: 6465 6e6f 6973 652c 0a20 2020 2020 2020  denoise,.       
-00054bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054be0: 2020 2020 2074 6573 745f 7275 6e3d 7465       test_run=te
-00054bf0: 7374 5f72 756e 2c0a 2020 2020 2020 2020  st_run,.        
+00054b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054ba0: 2020 2020 2020 7072 696e 7428 6d64 6c66        print(mdlf
+00054bb0: 6e20 2b20 2220 646f 6573 206e 6f74 2065  n + " does not e
+00054bc0: 7869 7374 202d 2077 6f6e 7420 7573 6520  xist - wont use 
+00054bd0: 5352 2229 0a20 2020 2020 2020 2020 2020  SR").           
+00054be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054bf0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
 00054c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00054c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054c20: 2020 2020 7665 7262 6f73 653d 5472 7565      verbose=True
-00054c30: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00054c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054c50: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-00054c60: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-00054c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054c90: 2020 2020 2020 2020 2020 6572 726f 725f            error_
-00054ca0: 696e 666f 203d 2074 7261 6365 6261 636b  info = traceback
-00054cb0: 2e66 6f72 6d61 745f 6578 6328 290a 2020  .format_exc().  
-00054cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054c20: 2020 2020 2020 7461 6250 726f 2c20 6e6f        tabPro, no
+00054c30: 726d 5072 6f20 3d20 6d6d 2820 7431 2c20  rmPro = mm( t1, 
+00054c40: 6869 6572 2c0a 2020 2020 2020 2020 2020  hier,.          
+00054c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054c70: 2020 6477 5f69 6d61 6765 3d69 6d67 4c69    dw_image=imgLi
+00054c80: 7374 2c0a 2020 2020 2020 2020 2020 2020  st,.            
+00054c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054cb0: 6276 616c 7320 3d20 6276 616c 666e 4c69  bvals = bvalfnLi
+00054cc0: 7374 2c0a 2020 2020 2020 2020 2020 2020  st,.            
 00054cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054ce0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00054cf0: 6572 726f 725f 696e 666f 290a 2020 2020  error_info).    
-00054d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054cf0: 6276 6563 7320 3d20 6276 6563 666e 4c69  bvecs = bvecfnLi
+00054d00: 7374 2c0a 2020 2020 2020 2020 2020 2020  st,.            
 00054d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054d20: 2020 2020 2020 2020 7669 7375 616c 697a          visualiz
-00054d30: 653d 4661 6c73 650a 2020 2020 2020 2020  e=False.        
-00054d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054d30: 7372 6d6f 6465 6c3d 7372 6d6f 6465 6c5f  srmodel=srmodel_
+00054d40: 4454 495f 6d64 6c2c 0a20 2020 2020 2020  DTI_mdl,.       
 00054d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054d60: 2020 2020 646f 7772 6974 653d 4661 6c73      dowrite=Fals
-00054d70: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00054d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054d90: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-00054da0: 6250 726f 3d7b 2744 5449 273a 4e6f 6e65  bPro={'DTI':None
-00054db0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00054dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054dd0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00054de0: 696e 7428 6622 616e 7473 7079 6d6d 6572  int(f"antspymmer
-00054df0: 726f 7220 6f63 6375 7272 6564 2077 6869  ror occurred whi
-00054e00: 6c65 2070 726f 6365 7373 696e 6720 7b6f  le processing {o
-00054e10: 7665 726d 6f64 587d 3a20 7b65 7d22 290a  vermodX}: {e}").
+00054d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054d70: 2020 2020 2064 6f5f 7472 6163 746f 6772       do_tractogr
+00054d80: 6170 6879 3d6e 6f74 2074 6573 745f 7275  aphy=not test_ru
+00054d90: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+00054da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054db0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00054dc0: 6f5f 6b6b 3d46 616c 7365 2c0a 2020 2020  o_kk=False,.    
+00054dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054df0: 2020 2020 2020 2020 646f 5f6e 6f72 6d61          do_norma
+00054e00: 6c69 7a61 7469 6f6e 3d74 656d 706c 6174  lization=templat
+00054e10: 6554 782c 0a20 2020 2020 2020 2020 2020  eTx,.           
 00054e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00054e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054e40: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-00054e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00054e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054e70: 2020 2020 206d 7964 7469 203d 2074 6162       mydti = tab
-00054e80: 5072 6f5b 2744 5449 275d 0a20 2020 2020  Pro['DTI'].     
-00054e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054ea0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00054eb0: 6620 7669 7375 616c 697a 6520 616e 6420  f visualize and 
-00054ec0: 7461 6250 726f 5b27 4454 4927 5d20 6973  tabPro['DTI'] is
-00054ed0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00054ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054f00: 2020 206d 6178 736c 6963 6520 3d20 6e70     maxslice = np
-00054f10: 2e6d 696e 2820 5b32 312c 206d 7964 7469  .min( [21, mydti
-00054f20: 5b27 7265 636f 6e5f 6661 275d 205d 2029  ['recon_fa'] ] )
-00054f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00054f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054f50: 2020 2020 2020 2020 2061 6e74 732e 706c           ants.pl
-00054f60: 6f74 2820 6d79 6474 695b 2772 6563 6f6e  ot( mydti['recon
-00054f70: 5f66 6127 5d2c 2020 6178 6973 3d32 2c20  _fa'],  axis=2, 
-00054f80: 6e73 6c69 6365 733d 6d61 7873 6c69 6365  nslices=maxslice
-00054f90: 2c20 6e63 6f6c 3d37 2c20 6372 6f70 3d54  , ncol=7, crop=T
-00054fa0: 7275 652c 2074 6974 6c65 3d27 4641 272c  rue, title='FA',
-00054fb0: 2066 696c 656e 616d 653d 6d79 6d6d 2b6d   filename=mymm+m
-00054fc0: 7973 6570 2b22 4641 6265 7474 6572 2e70  ysep+"FAbetter.p
-00054fd0: 6e67 2220 2029 0a20 2020 2020 2020 2020  ng"  ).         
-00054fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054ff0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00055000: 6e74 732e 706c 6f74 2820 6d79 6474 695b  nts.plot( mydti[
-00055010: 2772 6563 6f6e 5f66 6127 5d2c 206d 7964  'recon_fa'], myd
-00055020: 7469 5b27 6a68 755f 6c61 6265 6c73 275d  ti['jhu_labels']
-00055030: 2c20 6178 6973 3d32 2c20 6e73 6c69 6365  , axis=2, nslice
-00055040: 733d 6d61 7873 6c69 6365 2c20 6e63 6f6c  s=maxslice, ncol
-00055050: 3d37 2c20 6372 6f70 3d54 7275 652c 2074  =7, crop=True, t
-00055060: 6974 6c65 3d27 4641 202b 204a 4855 272c  itle='FA + JHU',
-00055070: 2066 696c 656e 616d 653d 6d79 6d6d 2b6d   filename=mymm+m
-00055080: 7973 6570 2b22 4641 4a48 552e 706e 6722  ysep+"FAJHU.png"
-00055090: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00054e40: 2067 726f 7570 5f74 656d 706c 6174 6520   group_template 
+00054e50: 3d20 6e6f 726d 616c 697a 6174 696f 6e5f  = normalization_
+00054e60: 7465 6d70 6c61 7465 2c0a 2020 2020 2020  template,.      
+00054e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054e90: 2020 2020 2020 6772 6f75 705f 7472 616e        group_tran
+00054ea0: 7366 6f72 6d20 3d20 6772 6f75 7054 782c  sform = groupTx,
+00054eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00054ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054ed0: 2020 2020 2020 2020 2020 2020 2064 7469               dti
+00054ee0: 5f6d 6f74 696f 6e5f 636f 7272 6563 7420  _motion_correct 
+00054ef0: 3d20 6474 695f 6d6f 7469 6f6e 5f63 6f72  = dti_motion_cor
+00054f00: 7265 6374 2c0a 2020 2020 2020 2020 2020  rect,.          
+00054f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054f30: 2020 6474 695f 6465 6e6f 6973 6520 3d20    dti_denoise = 
+00054f40: 6474 695f 6465 6e6f 6973 652c 0a20 2020  dti_denoise,.   
+00054f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054f70: 2020 2020 2020 2020 2074 6573 745f 7275           test_ru
+00054f80: 6e3d 7465 7374 5f72 756e 2c0a 2020 2020  n=test_run,.    
+00054f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054fb0: 2020 2020 2020 2020 7665 7262 6f73 653d          verbose=
+00054fc0: 5472 7565 2029 0a20 2020 2020 2020 2020  True ).         
+00054fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054fe0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00054ff0: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+00055000: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00055010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055020: 2020 2020 2020 2020 2020 2020 2020 6572                er
+00055030: 726f 725f 696e 666f 203d 2074 7261 6365  ror_info = trace
+00055040: 6261 636b 2e66 6f72 6d61 745f 6578 6328  back.format_exc(
+00055050: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00055060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055070: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00055080: 696e 7428 6572 726f 725f 696e 666f 290a  int(error_info).
+00055090: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000550a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000550b0: 2020 2020 2020 2020 2020 2020 616e 7473              ants
-000550c0: 2e70 6c6f 7428 206d 7964 7469 5b27 7265  .plot( mydti['re
-000550d0: 636f 6e5f 6d64 275d 2c20 2061 7869 733d  con_md'],  axis=
-000550e0: 322c 206e 736c 6963 6573 3d6d 6178 736c  2, nslices=maxsl
-000550f0: 6963 652c 206e 636f 6c3d 372c 2063 726f  ice, ncol=7, cro
-00055100: 703d 5472 7565 2c20 7469 746c 653d 274d  p=True, title='M
-00055110: 4427 2c20 6669 6c65 6e61 6d65 3d6d 796d  D', filename=mym
-00055120: 6d2b 6d79 7365 702b 224d 442e 706e 6722  m+mysep+"MD.png"
-00055130: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00055140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00055150: 6966 2064 6f77 7269 7465 3a0a 2020 2020  if dowrite:.    
+000550b0: 2020 2020 2020 2020 2020 2020 7669 7375              visu
+000550c0: 616c 697a 653d 4661 6c73 650a 2020 2020  alize=False.    
+000550d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000550e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000550f0: 2020 2020 2020 2020 646f 7772 6974 653d          dowrite=
+00055100: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+00055110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055130: 2020 7461 6250 726f 3d7b 2744 5449 273a    tabPro={'DTI':
+00055140: 4e6f 6e65 7d0a 2020 2020 2020 2020 2020  None}.          
+00055150: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00055160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00055170: 2020 2020 2020 2020 2020 2020 7772 6974              writ
-00055180: 655f 6d6d 2820 6f75 7470 7574 5f70 7265  e_mm( output_pre
-00055190: 6669 783d 6d79 6d6d 2c20 6d6d 3d74 6162  fix=mymm, mm=tab
-000551a0: 5072 6f2c 206d 6d5f 6e6f 726d 3d6e 6f72  Pro, mm_norm=nor
-000551b0: 6d50 726f 2c20 7431 7769 6465 3d74 3177  mPro, t1wide=t1w
-000551c0: 6964 652c 2073 6570 6172 6174 6f72 3d6d  ide, separator=m
-000551d0: 7973 6570 2029 0a20 2020 2020 2020 2020  ysep ).         
-000551e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000551f0: 2020 2020 2020 2066 6f72 206d 796b 6579         for mykey
-00055200: 2069 6e20 6e6f 726d 5072 6f2e 6b65 7973   in normPro.keys
-00055210: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00055170: 2020 7072 696e 7428 6622 616e 7473 7079    print(f"antspy
+00055180: 6d6d 6572 726f 7220 6f63 6375 7272 6564  mmerror occurred
+00055190: 2077 6869 6c65 2070 726f 6365 7373 696e   while processin
+000551a0: 6720 7b6f 7665 726d 6f64 587d 3a20 7b65  g {overmodX}: {e
+000551b0: 7d22 290a 2020 2020 2020 2020 2020 2020  }").            
+000551c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000551d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000551e0: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
+000551f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055200: 2020 2020 2020 2020 206d 7964 7469 203d           mydti =
+00055210: 2074 6162 5072 6f5b 2744 5449 275d 0a20   tabPro['DTI']. 
 00055220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00055230: 2020 2020 2020 2020 6966 206e 6f72 6d50          if normP
-00055240: 726f 5b6d 796b 6579 5d20 6973 206e 6f74  ro[mykey] is not
-00055250: 204e 6f6e 6520 616e 6420 6e6f 726d 5072   None and normPr
-00055260: 6f5b 6d79 6b65 795d 2e63 6f6d 706f 6e65  o[mykey].compone
-00055270: 6e74 7320 3d3d 2031 3a0a 2020 2020 2020  nts == 1:.      
+00055230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055240: 2020 2069 6620 7669 7375 616c 697a 6520     if visualize 
+00055250: 616e 6420 7461 6250 726f 5b27 4454 4927  and tabPro['DTI'
+00055260: 5d20 6973 206e 6f74 204e 6f6e 653a 0a20  ] is not None:. 
+00055270: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00055280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00055290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000552a0: 2020 6966 2076 6973 7561 6c69 7a65 2061    if visualize a
-000552b0: 6e64 2046 616c 7365 3a0a 2020 2020 2020  nd False:.      
-000552c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055290: 2020 2020 2020 206d 6178 736c 6963 6520         maxslice 
+000552a0: 3d20 6e70 2e6d 696e 2820 5b32 312c 206d  = np.min( [21, m
+000552b0: 7964 7469 5b27 7265 636f 6e5f 6661 275d  ydti['recon_fa']
+000552c0: 205d 2029 0a20 2020 2020 2020 2020 2020   ] ).           
 000552d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000552e0: 2020 2020 2020 616e 7473 2e70 6c6f 7428        ants.plot(
-000552f0: 2074 656d 706c 6174 652c 206e 6f72 6d50   template, normP
-00055300: 726f 5b6d 796b 6579 5d2c 2061 7869 733d  ro[mykey], axis=
-00055310: 322c 206e 736c 6963 6573 3d32 312c 206e  2, nslices=21, n
-00055320: 636f 6c3d 372c 2063 726f 703d 5472 7565  col=7, crop=True
-00055330: 2c20 7469 746c 653d 6d79 6b65 792c 2066  , title=mykey, f
-00055340: 696c 656e 616d 653d 6d79 6d6d 2b6d 7973  ilename=mymm+mys
-00055350: 6570 2b6d 796b 6579 2b22 2e70 6e67 2220  ep+mykey+".png" 
-00055360: 2020 290a 2020 2020 2020 2020 6966 206f    ).        if o
-00055370: 7665 726d 6f64 5820 3d3d 206e 7267 5f6d  vermodX == nrg_m
-00055380: 6f64 616c 6974 795f 6c69 7374 5b20 6c65  odality_list[ le
-00055390: 6e28 206e 7267 5f6d 6f64 616c 6974 795f  n( nrg_modality_
-000553a0: 6c69 7374 2029 202d 2031 205d 3a0a 2020  list ) - 1 ]:.  
-000553b0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000553c0: 0a20 2020 2020 2020 2069 6620 7665 7262  .        if verb
-000553d0: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-000553e0: 2070 7269 6e74 2822 646f 6e65 2077 6974   print("done wit
-000553f0: 6820 2220 2b20 6f76 6572 6d6f 6458 2029  h " + overmodX )
-00055400: 0a20 2020 2069 6620 7665 7262 6f73 653a  .    if verbose:
-00055410: 0a20 2020 2020 2020 2070 7269 6e74 2822  .        print("
-00055420: 6d6d 5f6e 7267 2063 6f6d 706c 6574 652e  mm_nrg complete.
-00055430: 2229 0a20 2020 2072 6574 7572 6e0a 0a64  ").    return..d
-00055440: 6566 2073 7065 635f 7461 7065 7228 782c  ef spec_taper(x,
-00055450: 2070 3d30 2e31 293a 0a20 2020 2066 726f   p=0.1):.    fro
-00055460: 6d20 7363 6970 7920 696d 706f 7274 2073  m scipy import s
-00055470: 7461 7473 2c20 7369 676e 616c 2c20 6666  tats, signal, ff
-00055480: 740a 2020 2020 6672 6f6d 2073 7461 7473  t.    from stats
-00055490: 6d6f 6465 6c73 2e72 6567 7265 7373 696f  models.regressio
-000554a0: 6e2e 6c69 6e65 6172 5f6d 6f64 656c 2069  n.linear_model i
-000554b0: 6d70 6f72 7420 7975 6c65 5f77 616c 6b65  mport yule_walke
-000554c0: 720a 2020 2020 2222 220a 2020 2020 436f  r.    """.    Co
-000554d0: 6d70 7574 6573 2061 2074 6170 6572 6564  mputes a tapered
-000554e0: 2076 6572 7369 6f6e 206f 6620 782c 2077   version of x, w
-000554f0: 6974 6820 7461 7065 7269 6e67 2070 2e0a  ith tapering p..
-00055500: 0a20 2020 2041 6461 7074 6564 2066 726f  .    Adapted fro
-00055510: 6d20 5227 7320 7374 6174 733a 3a73 7065  m R's stats::spe
-00055520: 632e 7461 7065 7220 6174 2068 7474 7073  c.taper at https
-00055530: 3a2f 2f67 6974 6875 622e 636f 6d2f 7465  ://github.com/te
-00055540: 6c6d 6f2d 636f 7272 6561 2f74 696d 652d  lmo-correa/time-
-00055550: 7365 7269 6573 2d61 6e61 6c79 7369 732f  series-analysis/
-00055560: 626c 6f62 2f6d 6173 7465 722f 5079 7468  blob/master/Pyth
-00055570: 6f6e 2f73 7065 6374 7275 6d2e 7079 0a0a  on/spectrum.py..
-00055580: 2020 2020 2222 220a 0a20 2020 2070 203d      """..    p =
-00055590: 206e 702e 725f 5b70 5d0a 2020 2020 6173   np.r_[p].    as
-000555a0: 7365 7274 206e 702e 616c 6c28 2870 203e  sert np.all((p >
-000555b0: 3d20 3029 2026 2028 7020 3c20 302e 3529  = 0) & (p < 0.5)
-000555c0: 292c 2022 2770 2720 6d75 7374 2062 6520  ), "'p' must be 
-000555d0: 6265 7477 6565 6e20 3020 616e 6420 302e  between 0 and 0.
-000555e0: 3522 0a0a 2020 2020 7820 3d20 6e70 2e72  5"..    x = np.r
-000555f0: 5f5b 785d 2e61 7374 7970 6528 2766 6c6f  _[x].astype('flo
-00055600: 6174 3634 2729 0a20 2020 206f 7269 6769  at64').    origi
-00055610: 6e61 6c5f 7368 6170 6520 3d20 782e 7368  nal_shape = x.sh
-00055620: 6170 650a 0a20 2020 2061 7373 6572 7420  ape..    assert 
-00055630: 6c65 6e28 6f72 6967 696e 616c 5f73 6861  len(original_sha
-00055640: 7065 2920 3c3d 2032 2c20 2227 7827 206d  pe) <= 2, "'x' m
-00055650: 7573 7420 6861 7665 2061 7420 6d6f 7374  ust have at most
-00055660: 2032 2064 696d 656e 7369 6f6e 7322 0a20   2 dimensions". 
-00055670: 2020 2077 6869 6c65 206c 656e 2878 2e73     while len(x.s
-00055680: 6861 7065 2920 3c20 323a 0a20 2020 2020  hape) < 2:.     
-00055690: 2020 2078 203d 206e 702e 6578 7061 6e64     x = np.expand
-000556a0: 5f64 696d 7328 782c 2061 7869 733d 3129  _dims(x, axis=1)
-000556b0: 0a0a 2020 2020 6e72 2c20 6e63 203d 2078  ..    nr, nc = x
-000556c0: 2e73 6861 7065 0a20 2020 2069 6620 6c65  .shape.    if le
-000556d0: 6e28 7029 203d 3d20 313a 0a20 2020 2020  n(p) == 1:.     
-000556e0: 2020 2070 203d 2070 202a 206e 702e 6f6e     p = p * np.on
-000556f0: 6573 286e 6329 0a20 2020 2065 6c73 653a  es(nc).    else:
-00055700: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00055710: 6c65 6e28 7029 203d 3d20 6e63 2c20 226c  len(p) == nc, "l
-00055720: 656e 6774 6820 6f66 2027 7027 206d 7573  ength of 'p' mus
-00055730: 7420 6265 2031 206f 7220 6571 7561 6c20  t be 1 or equal 
-00055740: 7468 6520 6e75 6d62 6572 206f 6620 636f  the number of co
-00055750: 6c75 6d6e 7320 6f66 2027 7827 220a 0a20  lumns of 'x'".. 
-00055760: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-00055770: 6528 6e63 293a 0a20 2020 2020 2020 206d  e(nc):.        m
-00055780: 203d 2069 6e74 286e 702e 666c 6f6f 7228   = int(np.floor(
-00055790: 6e72 202a 2070 5b69 5d29 290a 2020 2020  nr * p[i])).    
-000557a0: 2020 2020 6966 206d 203d 3d20 303a 0a20      if m == 0:. 
-000557b0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-000557c0: 6e75 650a 2020 2020 2020 2020 7720 3d20  nue.        w = 
-000557d0: 302e 3520 2a20 2831 202d 206e 702e 636f  0.5 * (1 - np.co
-000557e0: 7328 6e70 2e70 6920 2a20 6e70 2e61 7261  s(np.pi * np.ara
-000557f0: 6e67 6528 312c 2032 202a 206d 2c20 7374  nge(1, 2 * m, st
-00055800: 6570 3d32 292f 2832 202a 206d 2929 290a  ep=2)/(2 * m))).
-00055810: 2020 2020 2020 2020 785b 3a2c 2069 5d20          x[:, i] 
-00055820: 3d20 6e70 2e72 5f5b 772c 206e 702e 6f6e  = np.r_[w, np.on
-00055830: 6573 286e 7220 2d20 3220 2a20 6d29 2c20  es(nr - 2 * m), 
-00055840: 775b 3a3a 2d31 5d5d 202a 2078 5b3a 2c20  w[::-1]] * x[:, 
-00055850: 695d 0a0a 2020 2020 7820 3d20 6e70 2e72  i]..    x = np.r
-00055860: 6573 6861 7065 2878 2c20 6f72 6967 696e  eshape(x, origin
-00055870: 616c 5f73 6861 7065 290a 2020 2020 7265  al_shape).    re
-00055880: 7475 726e 2078 0a0a 6465 6620 706c 6f74  turn x..def plot
-00055890: 5f73 7065 6328 7370 6563 5f72 6573 2c20  _spec(spec_res, 
-000558a0: 636f 7665 7261 6765 3d4e 6f6e 652c 2061  coverage=None, a
-000558b0: 783d 4e6f 6e65 2c20 7469 746c 653d 4e6f  x=None, title=No
-000558c0: 6e65 293a 0a20 2020 2069 6d70 6f72 7420  ne):.    import 
-000558d0: 6d61 7470 6c6f 746c 6962 2e70 7970 6c6f  matplotlib.pyplo
-000558e0: 7420 6173 2070 6c74 0a20 2020 2022 2222  t as plt.    """
-000558f0: 436f 6e76 656e 6965 6e63 6520 706c 6f74  Convenience plot
-00055900: 7469 6e67 206d 6574 686f 642c 2061 6c73  ting method, als
-00055910: 6f20 696e 636c 7564 6573 2063 6f6e 6669  o includes confi
-00055920: 6465 6e63 6520 6372 6f73 7320 696e 2074  dence cross in t
-00055930: 6865 2073 616d 6520 7374 796c 6520 6173  he same style as
-00055940: 2052 2e0a 0a20 2020 204e 6f74 6520 7468   R...    Note th
-00055950: 6174 2074 6865 206c 6f63 6174 696f 6e20  at the location 
-00055960: 6f66 2074 6865 2063 726f 7373 2069 7320  of the cross is 
-00055970: 6972 7265 6c65 7661 6e74 3b20 6f6e 6c79  irrelevant; only
-00055980: 2077 6964 7468 2061 6e64 2068 6569 6768   width and heigh
-00055990: 7420 6d61 7474 6572 2e22 2222 0a20 2020  t matter.""".   
-000559a0: 2066 2c20 5078 7820 3d20 7370 6563 5f72   f, Pxx = spec_r
-000559b0: 6573 5b27 6672 6571 275d 2c20 7370 6563  es['freq'], spec
-000559c0: 5f72 6573 5b27 7370 6563 275d 0a0a 2020  _res['spec']..  
-000559d0: 2020 6966 2063 6f76 6572 6167 6520 6973    if coverage is
-000559e0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-000559f0: 2020 2063 6920 3d20 7370 6563 5f63 6928     ci = spec_ci(
-00055a00: 7370 6563 5f72 6573 5b27 6466 275d 2c20  spec_res['df'], 
-00055a10: 636f 7665 7261 6765 3d63 6f76 6572 6167  coverage=coverag
-00055a20: 6529 0a20 2020 2020 2020 2063 6f6e 665f  e).        conf_
-00055a30: 7820 3d20 286d 6178 2873 7065 635f 7265  x = (max(spec_re
-00055a40: 735b 2766 7265 7127 5d29 202d 2073 7065  s['freq']) - spe
-00055a50: 635f 7265 735b 2762 616e 6477 6964 7468  c_res['bandwidth
-00055a60: 275d 2920 2b20 6e70 2e72 5f5b 2d30 2e35  ']) + np.r_[-0.5
-00055a70: 2c20 302e 355d 202a 2073 7065 635f 7265  , 0.5] * spec_re
-00055a80: 735b 2762 616e 6477 6964 7468 275d 0a20  s['bandwidth']. 
-00055a90: 2020 2020 2020 2063 6f6e 665f 7920 3d20         conf_y = 
-00055aa0: 6d61 7828 7370 6563 5f72 6573 5b27 7370  max(spec_res['sp
-00055ab0: 6563 275d 2920 2f20 6369 5b31 5d0a 0a20  ec']) / ci[1].. 
-00055ac0: 2020 2069 6620 6178 2069 7320 4e6f 6e65     if ax is None
-00055ad0: 3a0a 2020 2020 2020 2020 6178 203d 2070  :.        ax = p
-00055ae0: 6c74 2e67 6361 2829 0a0a 2020 2020 6178  lt.gca()..    ax
-00055af0: 2e70 6c6f 7428 662c 2050 7878 2c20 636f  .plot(f, Pxx, co
-00055b00: 6c6f 723d 2743 3027 290a 2020 2020 6178  lor='C0').    ax
-00055b10: 2e73 6574 5f78 6c61 6265 6c28 2746 7265  .set_xlabel('Fre
-00055b20: 7175 656e 6379 2729 0a20 2020 2061 782e  quency').    ax.
-00055b30: 7365 745f 796c 6162 656c 2827 4c6f 6720  set_ylabel('Log 
-00055b40: 5370 6563 7472 756d 2729 0a20 2020 2061  Spectrum').    a
-00055b50: 782e 7365 745f 7973 6361 6c65 2827 6c6f  x.set_yscale('lo
-00055b60: 6727 290a 2020 2020 6966 2063 6f76 6572  g').    if cover
-00055b70: 6167 6520 6973 206e 6f74 204e 6f6e 653a  age is not None:
-00055b80: 0a20 2020 2020 2020 2061 782e 706c 6f74  .        ax.plot
-00055b90: 286e 702e 6d65 616e 2863 6f6e 665f 7829  (np.mean(conf_x)
-00055ba0: 202a 206e 702e 725f 5b31 2c20 315d 2c20   * np.r_[1, 1], 
-00055bb0: 636f 6e66 5f79 202a 2063 692c 2063 6f6c  conf_y * ci, col
-00055bc0: 6f72 3d27 7265 6427 290a 2020 2020 2020  or='red').      
-00055bd0: 2020 6178 2e70 6c6f 7428 636f 6e66 5f78    ax.plot(conf_x
-00055be0: 2c20 6e70 2e6d 6561 6e28 636f 6e66 5f79  , np.mean(conf_y
-00055bf0: 2920 2a20 6e70 2e72 5f5b 312c 2031 5d2c  ) * np.r_[1, 1],
-00055c00: 2063 6f6c 6f72 3d27 7265 6427 290a 0a20   color='red').. 
-00055c10: 2020 2061 782e 7365 745f 7469 746c 6528     ax.set_title(
-00055c20: 7370 6563 5f72 6573 5b27 6d65 7468 6f64  spec_res['method
-00055c30: 275d 2069 6620 7469 746c 6520 6973 204e  '] if title is N
-00055c40: 6f6e 6520 656c 7365 2074 6974 6c65 290a  one else title).
-00055c50: 0a64 6566 2073 7065 635f 6369 2864 662c  .def spec_ci(df,
-00055c60: 2063 6f76 6572 6167 653d 302e 3935 293a   coverage=0.95):
-00055c70: 0a20 2020 2066 726f 6d20 7363 6970 7920  .    from scipy 
-00055c80: 696d 706f 7274 2073 7461 7473 2c20 7369  import stats, si
-00055c90: 676e 616c 2c20 6666 740a 2020 2020 6672  gnal, fft.    fr
-00055ca0: 6f6d 2073 7461 7473 6d6f 6465 6c73 2e72  om statsmodels.r
-00055cb0: 6567 7265 7373 696f 6e2e 6c69 6e65 6172  egression.linear
-00055cc0: 5f6d 6f64 656c 2069 6d70 6f72 7420 7975  _model import yu
-00055cd0: 6c65 5f77 616c 6b65 720a 2020 2020 2222  le_walker.    ""
-00055ce0: 220a 2020 2020 436f 6d70 7574 6573 2074  ".    Computes t
-00055cf0: 6865 2063 6f6e 6669 6465 6e63 6520 696e  he confidence in
-00055d00: 7465 7276 616c 2066 6f72 2061 2073 7065  terval for a spe
-00055d10: 6374 7261 6c20 6669 742c 2062 6173 6564  ctral fit, based
-00055d20: 206f 6e20 7468 6520 6e75 6d62 6572 206f   on the number o
-00055d30: 6620 6465 6772 6565 7320 6f66 2066 7265  f degrees of fre
-00055d40: 6564 6f6d 2e0a 0a20 2020 2041 6461 7074  edom...    Adapt
-00055d50: 6564 2066 726f 6d20 5227 7320 7374 6174  ed from R's stat
-00055d60: 733a 3a70 6c6f 742e 7370 6563 2061 7420  s::plot.spec at 
-00055d70: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
-00055d80: 6f6d 2f74 656c 6d6f 2d63 6f72 7265 612f  om/telmo-correa/
-00055d90: 7469 6d65 2d73 6572 6965 732d 616e 616c  time-series-anal
-00055da0: 7973 6973 2f62 6c6f 622f 6d61 7374 6572  ysis/blob/master
-00055db0: 2f50 7974 686f 6e2f 7370 6563 7472 756d  /Python/spectrum
-00055dc0: 2e70 790a 0a20 2020 2022 2222 0a0a 2020  .py..    """..  
-00055dd0: 2020 6173 7365 7274 2063 6f76 6572 6167    assert coverag
-00055de0: 6520 3e3d 2030 2061 6e64 2063 6f76 6572  e >= 0 and cover
-00055df0: 6167 6520 3c20 312c 2022 636f 7665 7261  age < 1, "covera
-00055e00: 6765 2070 726f 6261 6269 6c69 7479 206f  ge probability o
-00055e10: 7574 206f 6620 7261 6e67 6520 5b30 2c20  ut of range [0, 
-00055e20: 3129 220a 0a20 2020 2074 6169 6c20 3d20  1)"..    tail = 
-00055e30: 3120 2d20 636f 7665 7261 6765 0a0a 2020  1 - coverage..  
-00055e40: 2020 7068 6920 3d20 7374 6174 732e 6368    phi = stats.ch
-00055e50: 6932 2e63 6466 2878 3d64 662c 2064 663d  i2.cdf(x=df, df=
-00055e60: 6466 290a 2020 2020 7570 7065 725f 7175  df).    upper_qu
-00055e70: 616e 7469 6c65 203d 2031 202d 2074 6169  antile = 1 - tai
-00055e80: 6c20 2a20 2831 202d 2070 6869 290a 2020  l * (1 - phi).  
-00055e90: 2020 6c6f 7765 725f 7175 616e 7469 6c65    lower_quantile
-00055ea0: 203d 2074 6169 6c20 2a20 7068 690a 0a20   = tail * phi.. 
-00055eb0: 2020 2072 6574 7572 6e20 6466 202f 2073     return df / s
-00055ec0: 7461 7473 2e63 6869 322e 7070 6628 5b75  tats.chi2.ppf([u
-00055ed0: 7070 6572 5f71 7561 6e74 696c 652c 206c  pper_quantile, l
-00055ee0: 6f77 6572 5f71 7561 6e74 696c 655d 2c20  ower_quantile], 
-00055ef0: 6466 3d64 6629 0a0a 6465 6620 7370 6563  df=df)..def spec
-00055f00: 5f70 6772 616d 2878 2c20 7866 7265 713d  _pgram(x, xfreq=
-00055f10: 312c 2073 7061 6e73 3d4e 6f6e 652c 206b  1, spans=None, k
-00055f20: 6572 6e65 6c3d 4e6f 6e65 2c20 7461 7065  ernel=None, tape
-00055f30: 723d 302e 312c 2070 6164 3d30 2c20 6661  r=0.1, pad=0, fa
-00055f40: 7374 3d54 7275 652c 2064 656d 6561 6e3d  st=True, demean=
-00055f50: 4661 6c73 652c 2064 6574 7265 6e64 3d54  False, detrend=T
-00055f60: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-00055f70: 2020 2020 706c 6f74 3d54 7275 652c 202a      plot=True, *
-00055f80: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
-00055f90: 220a 2020 2020 436f 6d70 7574 6573 2074  ".    Computes t
-00055fa0: 6865 2073 7065 6374 7261 6c20 6465 6e73  he spectral dens
-00055fb0: 6974 7920 6573 7469 6d61 7465 2075 7369  ity estimate usi
-00055fc0: 6e67 2061 2070 6572 696f 646f 6772 616d  ng a periodogram
-00055fd0: 2e20 204f 7074 696f 6e61 6c6c 792c 2069  .  Optionally, i
-00055fe0: 7420 616c 736f 3a0a 2020 2020 2d20 5573  t also:.    - Us
-00055ff0: 6573 2061 2070 726f 7669 6465 6420 6b65  es a provided ke
-00056000: 726e 656c 2077 696e 646f 772c 206f 7220  rnel window, or 
-00056010: 6120 7365 7175 656e 6365 206f 6620 7370  a sequence of sp
-00056020: 616e 7320 666f 7220 636f 6e76 6f6c 7574  ans for convolut
-00056030: 6564 206d 6f64 6966 6965 6420 4461 6e69  ed modified Dani
-00056040: 656c 6c20 6b65 726e 656c 732e 0a20 2020  ell kernels..   
-00056050: 202d 2054 6170 6572 7320 7468 6520 7374   - Tapers the st
-00056060: 6172 7420 616e 6420 656e 6420 6f66 2074  art and end of t
-00056070: 6865 2073 6572 6965 7320 746f 2061 766f  he series to avo
-00056080: 6964 2065 6e64 2d6f 662d 7369 676e 616c  id end-of-signal
-00056090: 2065 6666 6563 7473 2e0a 2020 2020 2d20   effects..    - 
-000560a0: 5061 6473 2074 6865 2070 726f 7669 6465  Pads the provide
-000560b0: 6420 7365 7269 6573 2062 6566 6f72 6520  d series before 
-000560c0: 636f 6d70 7574 6174 696f 6e2c 2061 6464  computation, add
-000560d0: 696e 6720 7061 642a 286c 656e 6774 6820  ing pad*(length 
-000560e0: 6f66 2073 6572 6965 7329 207a 6572 6f73  of series) zeros
-000560f0: 2061 7420 7468 6520 656e 642e 0a20 2020   at the end..   
-00056100: 202d 2050 6164 7320 7468 6520 7072 6f76   - Pads the prov
-00056110: 6964 6564 2073 6572 6965 7320 6265 666f  ided series befo
-00056120: 7265 2063 6f6d 7075 7461 7469 6f6e 2074  re computation t
-00056130: 6f20 7370 6565 6420 7570 2046 4654 2063  o speed up FFT c
-00056140: 616c 6375 6c61 7469 6f6e 2e0a 2020 2020  alculation..    
-00056150: 2d20 5065 7266 6f72 6d73 2064 656d 6561  - Performs demea
-00056160: 6e69 6e67 206f 7220 6465 7472 656e 6469  ning or detrendi
-00056170: 6e67 206f 6e20 7468 6520 7365 7269 6573  ng on the series
-00056180: 2e0a 2020 2020 2d20 506c 6f74 7320 7265  ..    - Plots re
-00056190: 7375 6c74 732e 0a0a 2020 2020 496d 706c  sults...    Impl
-000561a0: 656d 656e 7465 6420 746f 2065 6e73 7572  emented to ensur
-000561b0: 6520 636f 6d70 6174 6962 696c 6974 7920  e compatibility 
-000561c0: 7769 7468 2052 2773 2073 7065 6374 7261  with R's spectra
-000561d0: 6c20 6675 6e63 7469 6f6e 732c 2061 7320  l functions, as 
-000561e0: 6f70 706f 7365 6420 746f 2072 6575 7369  opposed to reusi
-000561f0: 6e67 2073 6369 7079 2773 2070 6572 696f  ng scipy's perio
-00056200: 646f 6772 616d 2e0a 0a20 2020 2041 6461  dogram...    Ada
-00056210: 7074 6564 2066 726f 6d20 5227 7320 7374  pted from R's st
-00056220: 6174 733a 3a73 7065 632e 7067 7261 6d20  ats::spec.pgram 
-00056230: 6174 2068 7474 7073 3a2f 2f67 6974 6875  at https://githu
-00056240: 622e 636f 6d2f 7465 6c6d 6f2d 636f 7272  b.com/telmo-corr
-00056250: 6561 2f74 696d 652d 7365 7269 6573 2d61  ea/time-series-a
-00056260: 6e61 6c79 7369 732f 626c 6f62 2f6d 6173  nalysis/blob/mas
-00056270: 7465 722f 5079 7468 6f6e 2f73 7065 6374  ter/Python/spect
-00056280: 7275 6d2e 7079 0a0a 2020 2020 6578 616d  rum.py..    exam
-00056290: 706c 653a 0a0a 2020 2020 696d 706f 7274  ple:..    import
-000562a0: 206e 756d 7079 2061 7320 6e70 0a20 2020   numpy as np.   
-000562b0: 2069 6d70 6f72 7420 616e 7473 7079 6d6d   import antspymm
-000562c0: 0a20 2020 206d 7978 203d 206e 702e 7261  .    myx = np.ra
-000562d0: 6e64 6f6d 2e72 616e 6428 3130 302c 3129  ndom.rand(100,1)
-000562e0: 0a20 2020 206d 7973 7065 6320 3d20 616e  .    myspec = an
-000562f0: 7473 7079 6d6d 2e73 7065 635f 7067 7261  tspymm.spec_pgra
-00056300: 6d28 6d79 782c 302e 3529 0a0a 2020 2020  m(myx,0.5)..    
-00056310: 2222 220a 2020 2020 6672 6f6d 2073 6369  """.    from sci
-00056320: 7079 2069 6d70 6f72 7420 7374 6174 732c  py import stats,
-00056330: 2073 6967 6e61 6c2c 2066 6674 0a20 2020   signal, fft.   
-00056340: 2066 726f 6d20 7374 6174 736d 6f64 656c   from statsmodel
-00056350: 732e 7265 6772 6573 7369 6f6e 2e6c 696e  s.regression.lin
-00056360: 6561 725f 6d6f 6465 6c20 696d 706f 7274  ear_model import
-00056370: 2079 756c 655f 7761 6c6b 6572 0a20 2020   yule_walker.   
-00056380: 2064 6566 2064 616e 6965 6c6c 5f77 696e   def daniell_win
-00056390: 646f 775f 6d6f 6469 6669 6564 286d 293a  dow_modified(m):
-000563a0: 0a20 2020 2020 2020 2022 2222 2053 696e  .        """ Sin
-000563b0: 676c 652d 7061 7373 206d 6f64 6966 6965  gle-pass modifie
-000563c0: 6420 4461 6e69 656c 6c20 6b65 726e 656c  d Daniell kernel
-000563d0: 2077 696e 646f 772e 0a0a 2020 2020 2020   window...      
-000563e0: 2020 5765 6967 6874 2069 7320 6e6f 726d    Weight is norm
-000563f0: 616c 697a 6564 2074 6f20 6164 6420 7570  alized to add up
-00056400: 2074 6f20 312c 2061 6e64 2061 6c6c 2076   to 1, and all v
-00056410: 616c 7565 7320 6172 6520 7468 6520 7361  alues are the sa
-00056420: 6d65 2c20 6f74 6865 7220 7468 616e 2074  me, other than t
-00056430: 6865 2066 6972 7374 2061 6e64 2074 6865  he first and the
-00056440: 0a20 2020 2020 2020 206c 6173 742c 2077  .        last, w
-00056450: 6869 6368 2061 7265 2064 6976 6964 6564  hich are divided
-00056460: 2062 7920 322e 0a20 2020 2020 2020 2022   by 2..        "
-00056470: 2222 0a20 2020 2020 2020 2064 6566 2077  "".        def w
-00056480: 286b 293a 0a20 2020 2020 2020 2020 2020  (k):.           
-00056490: 2072 6574 7572 6e20 6e70 2e77 6865 7265   return np.where
-000564a0: 286e 702e 6162 7328 6b29 203c 206d 2c20  (np.abs(k) < m, 
-000564b0: 3120 2f20 2832 2a6d 292c 206e 702e 7768  1 / (2*m), np.wh
-000564c0: 6572 6528 6e70 2e61 6273 286b 2920 3d3d  ere(np.abs(k) ==
-000564d0: 206d 2c20 312f 2834 2a6d 292c 2030 2929   m, 1/(4*m), 0))
-000564e0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-000564f0: 2077 286e 702e 6172 616e 6765 282d 6d2c   w(np.arange(-m,
-00056500: 206d 2b31 2929 0a0a 2020 2020 6465 6620   m+1))..    def 
-00056510: 6461 6e69 656c 6c5f 7769 6e64 6f77 5f63  daniell_window_c
-00056520: 6f6e 766f 6c76 6528 7629 3a0a 2020 2020  onvolve(v):.    
-00056530: 2020 2020 2222 2220 436f 6e76 6f6c 7665      """ Convolve
-00056540: 6420 7665 7273 696f 6e20 6f66 206d 756c  d version of mul
-00056550: 7469 706c 6520 6d6f 6469 6669 6564 2044  tiple modified D
-00056560: 616e 6965 6c6c 206b 6572 6e65 6c20 7769  aniell kernel wi
-00056570: 6e64 6f77 732e 0a0a 2020 2020 2020 2020  ndows...        
-00056580: 5061 7261 6d65 7465 7220 7620 7368 6f75  Parameter v shou
-00056590: 6c64 2062 6520 616e 2069 7465 7261 626c  ld be an iterabl
-000565a0: 6520 6f66 206d 2076 616c 7565 732e 0a20  e of m values.. 
-000565b0: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-000565c0: 2020 2020 6966 206c 656e 2876 2920 3d3d      if len(v) ==
-000565d0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-000565e0: 7265 7475 726e 206e 702e 725f 5b31 5d0a  return np.r_[1].
-000565f0: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-00056600: 7629 203d 3d20 313a 0a20 2020 2020 2020  v) == 1:.       
-00056610: 2020 2020 2072 6574 7572 6e20 6461 6e69       return dani
-00056620: 656c 6c5f 7769 6e64 6f77 5f6d 6f64 6966  ell_window_modif
-00056630: 6965 6428 765b 305d 290a 0a20 2020 2020  ied(v[0])..     
-00056640: 2020 2072 6574 7572 6e20 7369 676e 616c     return signal
-00056650: 2e63 6f6e 766f 6c76 6528 6461 6e69 656c  .convolve(daniel
-00056660: 6c5f 7769 6e64 6f77 5f6d 6f64 6966 6965  l_window_modifie
-00056670: 6428 765b 305d 292c 2064 616e 6965 6c6c  d(v[0]), daniell
-00056680: 5f77 696e 646f 775f 636f 6e76 6f6c 7665  _window_convolve
-00056690: 2876 5b31 3a5d 2929 0a0a 2020 2020 2320  (v[1:]))..    # 
-000566a0: 456e 7375 7265 2077 6520 6361 6e20 7374  Ensure we can st
-000566b0: 6f72 6520 6e6f 6e2d 696e 7465 6765 7273  ore non-integers
-000566c0: 2069 6e20 782c 2061 6e64 2074 6861 7420   in x, and that 
-000566d0: 6974 2069 7320 6120 6e75 6d70 7920 6f62  it is a numpy ob
-000566e0: 6a65 6374 0a20 2020 2078 203d 206e 702e  ject.    x = np.
-000566f0: 725f 5b78 5d2e 6173 7479 7065 2827 666c  r_[x].astype('fl
-00056700: 6f61 7436 3427 290a 2020 2020 6f72 6967  oat64').    orig
-00056710: 696e 616c 5f73 6861 7065 203d 2078 2e73  inal_shape = x.s
-00056720: 6861 7065 0a0a 2020 2020 2320 456e 7375  hape..    # Ensu
-00056730: 7265 2063 6f72 7265 6374 2064 696d 656e  re correct dimen
-00056740: 7369 6f6e 730a 2020 2020 6173 7365 7274  sions.    assert
-00056750: 206c 656e 286f 7269 6769 6e61 6c5f 7368   len(original_sh
-00056760: 6170 6529 203c 3d20 322c 2022 2778 2720  ape) <= 2, "'x' 
-00056770: 6d75 7374 2068 6176 6520 6174 206d 6f73  must have at mos
-00056780: 7420 3220 6469 6d65 6e73 696f 6e73 220a  t 2 dimensions".
-00056790: 2020 2020 7768 696c 6520 6c65 6e28 782e      while len(x.
-000567a0: 7368 6170 6529 203c 2032 3a0a 2020 2020  shape) < 2:.    
-000567b0: 2020 2020 7820 3d20 6e70 2e65 7870 616e      x = np.expan
-000567c0: 645f 6469 6d73 2878 2c20 6178 6973 3d31  d_dims(x, axis=1
-000567d0: 290a 0a20 2020 204e 2c20 6e73 6572 203d  )..    N, nser =
-000567e0: 2078 2e73 6861 7065 0a20 2020 204e 3020   x.shape.    N0 
-000567f0: 3d20 4e0a 0a20 2020 2023 2045 6e73 7572  = N..    # Ensur
-00056800: 6520 6f6e 6c79 206f 6e65 206f 6620 7370  e only one of sp
-00056810: 616e 732c 206b 6572 6e65 6c20 6973 2070  ans, kernel is p
-00056820: 726f 7669 6465 642c 2061 6e64 2062 7569  rovided, and bui
-00056830: 6c64 2074 6865 206b 6572 6e65 6c20 7769  ld the kernel wi
-00056840: 6e64 6f77 2069 6620 6e65 6564 6564 0a20  ndow if needed. 
-00056850: 2020 2061 7373 6572 7420 2873 7061 6e73     assert (spans
-00056860: 2069 7320 4e6f 6e65 2920 6f72 2028 6b65   is None) or (ke
-00056870: 726e 656c 2069 7320 4e6f 6e65 292c 2022  rnel is None), "
-00056880: 6d75 7374 2073 7065 6369 6679 206f 6e6c  must specify onl
-00056890: 7920 6f6e 6520 6f66 2027 7370 616e 7327  y one of 'spans'
-000568a0: 206f 7220 276b 6572 6e65 6c27 220a 2020   or 'kernel'".  
-000568b0: 2020 6966 2073 7061 6e73 2069 7320 6e6f    if spans is no
-000568c0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000568d0: 6b65 726e 656c 203d 2064 616e 6965 6c6c  kernel = daniell
-000568e0: 5f77 696e 646f 775f 636f 6e76 6f6c 7665  _window_convolve
-000568f0: 286e 702e 666c 6f6f 725f 6469 7669 6465  (np.floor_divide
-00056900: 286e 702e 725f 5b73 7061 6e73 5d2c 2032  (np.r_[spans], 2
-00056910: 2929 0a0a 2020 2020 2320 4465 7472 656e  ))..    # Detren
-00056920: 6420 6f72 2064 656d 6561 6e20 7468 6520  d or demean the 
-00056930: 7365 7269 6573 0a20 2020 2069 6620 6465  series.    if de
-00056940: 7472 656e 643a 0a20 2020 2020 2020 2074  trend:.        t
-00056950: 203d 206e 702e 6172 616e 6765 284e 2920   = np.arange(N) 
-00056960: 2d20 284e 202d 2031 292f 320a 2020 2020  - (N - 1)/2.    
-00056970: 2020 2020 7375 6d74 3220 3d20 4e20 2a20      sumt2 = N * 
-00056980: 284e 2a2a 3220 2d20 3129 2f31 320a 2020  (N**2 - 1)/12.  
-00056990: 2020 2020 2020 7820 2d3d 2028 6e70 2e72        x -= (np.r
-000569a0: 6570 6561 7428 6e70 2e65 7870 616e 645f  epeat(np.expand_
-000569b0: 6469 6d73 286e 702e 6d65 616e 2878 2c20  dims(np.mean(x, 
-000569c0: 6178 6973 3d30 292c 2030 292c 204e 2c20  axis=0), 0), N, 
-000569d0: 6178 6973 3d30 2920 2b20 6e70 2e6f 7574  axis=0) + np.out
-000569e0: 6572 286e 702e 7375 6d28 782e 5420 2a20  er(np.sum(x.T * 
-000569f0: 742c 2061 7869 733d 3129 2c20 742f 7375  t, axis=1), t/su
-00056a00: 6d74 3229 2e54 290a 2020 2020 656c 6966  mt2).T).    elif
-00056a10: 2064 656d 6561 6e3a 0a20 2020 2020 2020   demean:.       
-00056a20: 2078 202d 3d20 6e70 2e6d 6561 6e28 782c   x -= np.mean(x,
-00056a30: 2061 7869 733d 3029 0a0a 2020 2020 2320   axis=0)..    # 
-00056a40: 436f 6d70 7574 6520 7461 7065 7220 616e  Compute taper an
-00056a50: 6420 7461 7065 7220 6164 6a75 7374 6d65  d taper adjustme
-00056a60: 6e74 2076 6172 6961 626c 6573 0a20 2020  nt variables.   
-00056a70: 2078 203d 2073 7065 635f 7461 7065 7228   x = spec_taper(
-00056a80: 782c 2074 6170 6572 290a 2020 2020 7532  x, taper).    u2
-00056a90: 203d 2028 3120 2d20 2835 2f38 2920 2a20   = (1 - (5/8) * 
-00056aa0: 7461 7065 7220 2a20 3229 0a20 2020 2075  taper * 2).    u
-00056ab0: 3420 3d20 2831 202d 2028 3933 2f31 3238  4 = (1 - (93/128
-00056ac0: 2920 2a20 7461 7065 7220 2a20 3229 0a0a  ) * taper * 2)..
-00056ad0: 2020 2020 2320 5061 6420 7468 6520 7365      # Pad the se
-00056ae0: 7269 6573 2077 6974 6820 636f 7069 6573  ries with copies
-00056af0: 206f 6620 7468 6520 7361 6d65 2073 6861   of the same sha
-00056b00: 7065 2c20 6275 7420 6669 6c6c 6564 2077  pe, but filled w
-00056b10: 6974 6820 7a65 726f 6573 0a20 2020 2069  ith zeroes.    i
-00056b20: 6620 7061 6420 3e20 303a 0a20 2020 2020  f pad > 0:.     
-00056b30: 2020 2078 203d 206e 702e 725f 5b78 2c20     x = np.r_[x, 
-00056b40: 6e70 2e7a 6572 6f73 2828 7061 6420 2a20  np.zeros((pad * 
-00056b50: 782e 7368 6170 655b 305d 2c20 782e 7368  x.shape[0], x.sh
-00056b60: 6170 655b 315d 2929 5d0a 2020 2020 2020  ape[1]))].      
-00056b70: 2020 4e20 3d20 782e 7368 6170 655b 305d    N = x.shape[0]
-00056b80: 0a0a 2020 2020 2320 4675 7274 6865 7220  ..    # Further 
-00056b90: 7061 6420 7468 6520 7365 7269 6573 2074  pad the series t
-00056ba0: 6f20 6163 6365 6c65 7261 7465 2046 4654  o accelerate FFT
-00056bb0: 2063 6f6d 7075 7461 7469 6f6e 0a20 2020   computation.   
-00056bc0: 2069 6620 6661 7374 3a0a 2020 2020 2020   if fast:.      
-00056bd0: 2020 6e65 774e 203d 2066 6674 2e6e 6578    newN = fft.nex
-00056be0: 745f 6661 7374 5f6c 656e 284e 2c20 5472  t_fast_len(N, Tr
-00056bf0: 7565 290a 2020 2020 2020 2020 7820 3d20  ue).        x = 
-00056c00: 6e70 2e72 5f5b 782c 206e 702e 7a65 726f  np.r_[x, np.zero
-00056c10: 7328 286e 6577 4e20 2d20 4e2c 2078 2e73  s((newN - N, x.s
-00056c20: 6861 7065 5b31 5d29 295d 0a20 2020 2020  hape[1]))].     
-00056c30: 2020 204e 203d 206e 6577 4e0a 0a20 2020     N = newN..   
-00056c40: 2023 2043 6f6d 7075 7465 2074 6865 2046   # Compute the F
-00056c50: 6f75 7269 6572 2066 7265 7175 656e 6369  ourier frequenci
-00056c60: 6573 2028 5227 7320 7370 6563 2e70 6772  es (R's spec.pgr
-00056c70: 616d 2063 6f6e 7665 6e74 696f 6e20 7374  am convention st
-00056c80: 796c 6529 0a20 2020 204e 7370 6563 203d  yle).    Nspec =
-00056c90: 2069 6e74 286e 702e 666c 6f6f 7228 4e2f   int(np.floor(N/
-00056ca0: 3229 290a 2020 2020 6672 6571 203d 2028  2)).    freq = (
-00056cb0: 6e70 2e61 7261 6e67 6528 4e73 7065 6329  np.arange(Nspec)
-00056cc0: 202b 2031 2920 2a20 7866 7265 7120 2f20   + 1) * xfreq / 
-00056cd0: 4e0a 0a20 2020 2023 2054 7261 6e73 6c61  N..    # Transla
-00056ce0: 7469 6f6e 7320 746f 206b 6565 7020 7361  tions to keep sa
-00056cf0: 6d65 2072 6f77 202f 2063 6f6c 756d 6e20  me row / column 
-00056d00: 636f 6e76 656e 7469 6f6e 2061 7320 7374  convention as st
-00056d10: 6174 733a 3a6d 7666 6674 0a20 2020 2078  ats::mvfft.    x
-00056d20: 6666 7420 3d20 6666 742e 6666 7428 782e  fft = fft.fft(x.
-00056d30: 5429 2e54 0a0a 2020 2020 2320 436f 6d70  T).T..    # Comp
-00056d40: 7574 6520 7468 6520 7065 7269 6f64 6f67  ute the periodog
-00056d50: 7261 6d20 666f 7220 6561 6368 2069 2c20  ram for each i, 
-00056d60: 6a0a 2020 2020 7067 7261 6d20 3d20 6e70  j.    pgram = np
-00056d70: 2e65 6d70 7479 2828 4e2c 206e 7365 722c  .empty((N, nser,
-00056d80: 206e 7365 7229 2c20 6474 7970 653d 2763   nser), dtype='c
-00056d90: 6f6d 706c 6578 2729 0a20 2020 2066 6f72  omplex').    for
-00056da0: 2069 2069 6e20 7261 6e67 6528 6e73 6572   i in range(nser
-00056db0: 293a 0a20 2020 2020 2020 2066 6f72 206a  ):.        for j
-00056dc0: 2069 6e20 7261 6e67 6528 6e73 6572 293a   in range(nser):
-00056dd0: 0a20 2020 2020 2020 2020 2020 2070 6772  .            pgr
-00056de0: 616d 5b3a 2c20 692c 206a 5d20 3d20 7866  am[:, i, j] = xf
-00056df0: 6674 5b3a 2c20 695d 202a 206e 702e 636f  ft[:, i] * np.co
-00056e00: 6e6a 2878 6666 745b 3a2c 206a 5d29 202f  nj(xfft[:, j]) /
-00056e10: 2028 4e30 202a 2078 6672 6571 290a 2020   (N0 * xfreq).  
-00056e20: 2020 2020 2020 2020 2020 7067 7261 6d5b            pgram[
-00056e30: 302c 2069 2c20 6a5d 203d 2030 2e35 202a  0, i, j] = 0.5 *
-00056e40: 2028 7067 7261 6d5b 312c 2069 2c20 6a5d   (pgram[1, i, j]
-00056e50: 202b 2070 6772 616d 5b2d 312c 2069 2c20   + pgram[-1, i, 
-00056e60: 6a5d 290a 0a20 2020 2069 6620 6b65 726e  j])..    if kern
-00056e70: 656c 2069 7320 4e6f 6e65 3a0a 2020 2020  el is None:.    
-00056e80: 2020 2020 2320 5661 6c75 6573 2070 7265      # Values pre
-00056e90: 2d61 646a 7573 746d 656e 740a 2020 2020  -adjustment.    
-00056ea0: 2020 2020 6466 203d 2032 0a20 2020 2020      df = 2.     
-00056eb0: 2020 2062 616e 6477 6964 7468 203d 206e     bandwidth = n
-00056ec0: 702e 7371 7274 2831 202f 2031 3229 0a20  p.sqrt(1 / 12). 
-00056ed0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00056ee0: 2064 6566 2063 6f6e 765f 6369 7263 756c   def conv_circul
-00056ef0: 6172 2873 6967 6e61 6c2c 206b 6572 6e65  ar(signal, kerne
-00056f00: 6c29 3a0a 2020 2020 2020 2020 2020 2020  l):.            
-00056f10: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
-00056f20: 5065 7266 6f72 6d73 2031 4420 6369 7263  Performs 1D circ
-00056f30: 756c 6172 2063 6f6e 766f 6c75 7469 6f6e  ular convolution
-00056f40: 2c20 696e 2074 6865 2073 616d 6520 7374  , in the same st
-00056f50: 796c 6520 6173 2052 3a3a 6b65 726e 6170  yle as R::kernap
-00056f60: 706c 792c 0a20 2020 2020 2020 2020 2020  ply,.           
-00056f70: 2061 7373 756d 696e 6720 7468 6520 6b65   assuming the ke
-00056f80: 726e 656c 2077 696e 646f 7720 6973 2063  rnel window is c
-00056f90: 656e 7465 7265 6420 6174 2030 2e0a 2020  entered at 0..  
-00056fa0: 2020 2020 2020 2020 2020 2222 220a 2020            """.  
-00056fb0: 2020 2020 2020 2020 2020 7061 6420 3d20            pad = 
-00056fc0: 6c65 6e28 7369 676e 616c 2920 2d20 6c65  len(signal) - le
-00056fd0: 6e28 6b65 726e 656c 290a 2020 2020 2020  n(kernel).      
-00056fe0: 2020 2020 2020 6861 6c66 5f77 696e 646f        half_windo
-00056ff0: 7720 3d20 696e 7428 286c 656e 286b 6572  w = int((len(ker
-00057000: 6e65 6c29 202b 2031 2920 2f20 3229 0a20  nel) + 1) / 2). 
-00057010: 2020 2020 2020 2020 2020 2069 6e64 6578             index
-00057020: 6573 203d 2072 616e 6765 282d 6861 6c66  es = range(-half
-00057030: 5f77 696e 646f 772c 206c 656e 2873 6967  _window, len(sig
-00057040: 6e61 6c29 202d 2068 616c 665f 7769 6e64  nal) - half_wind
-00057050: 6f77 290a 2020 2020 2020 2020 2020 2020  ow).            
-00057060: 6f72 6967 5f63 6f6e 7620 3d20 6e70 2e72  orig_conv = np.r
-00057070: 6561 6c28 6666 742e 6966 6674 2866 6674  eal(fft.ifft(fft
-00057080: 2e66 6674 2873 6967 6e61 6c29 202a 2066  .fft(signal) * f
-00057090: 6674 2e66 6674 286e 702e 725f 5b6e 702e  ft.fft(np.r_[np.
-000570a0: 7a65 726f 7328 7061 6429 2c20 6b65 726e  zeros(pad), kern
-000570b0: 656c 5d29 2929 0a20 2020 2020 2020 2020  el]))).         
-000570c0: 2020 2072 6574 7572 6e20 6f72 6967 5f63     return orig_c
-000570d0: 6f6e 762e 7461 6b65 2869 6e64 6578 6573  onv.take(indexes
-000570e0: 2c20 6d6f 6465 3d27 7772 6170 2729 0a0a  , mode='wrap')..
-000570f0: 2020 2020 2020 2020 2320 436f 6e76 6f6c          # Convol
-00057100: 7665 2070 6772 616d 2077 6974 6820 6b65  ve pgram with ke
-00057110: 726e 656c 2077 6974 6820 6369 7263 756c  rnel with circul
-00057120: 6172 2063 6f6e 760a 2020 2020 2020 2020  ar conv.        
-00057130: 666f 7220 6920 696e 2072 616e 6765 286e  for i in range(n
-00057140: 7365 7229 3a0a 2020 2020 2020 2020 2020  ser):.          
-00057150: 2020 666f 7220 6a20 696e 2072 616e 6765    for j in range
-00057160: 286e 7365 7229 3a0a 2020 2020 2020 2020  (nser):.        
-00057170: 2020 2020 2020 2020 7067 7261 6d5b 3a2c          pgram[:,
-00057180: 2069 2c20 6a5d 203d 2063 6f6e 765f 6369   i, j] = conv_ci
-00057190: 7263 756c 6172 2870 6772 616d 5b3a 2c20  rcular(pgram[:, 
-000571a0: 692c 206a 5d2c 206b 6572 6e65 6c29 0a0a  i, j], kernel)..
-000571b0: 2020 2020 2020 2020 6466 203d 2032 202f          df = 2 /
-000571c0: 206e 702e 7375 6d28 6b65 726e 656c 2a2a   np.sum(kernel**
-000571d0: 3229 0a20 2020 2020 2020 206d 203d 2028  2).        m = (
-000571e0: 6c65 6e28 6b65 726e 656c 2920 2d20 3129  len(kernel) - 1)
-000571f0: 2f32 0a20 2020 2020 2020 206b 203d 206e  /2.        k = n
-00057200: 702e 6172 616e 6765 282d 6d2c 206d 2b31  p.arange(-m, m+1
-00057210: 290a 2020 2020 2020 2020 6261 6e64 7769  ).        bandwi
-00057220: 6474 6820 3d20 6e70 2e73 7172 7428 6e70  dth = np.sqrt(np
-00057230: 2e73 756d 2828 312f 3132 202b 206b 2a2a  .sum((1/12 + k**
-00057240: 3229 202a 206b 6572 6e65 6c29 290a 0a20  2) * kernel)).. 
-00057250: 2020 2064 6620 3d20 6466 2f28 7534 2f75     df = df/(u4/u
-00057260: 322a 2a32 292a 284e 302f 4e29 0a20 2020  2**2)*(N0/N).   
-00057270: 2062 616e 6477 6964 7468 203d 2062 616e   bandwidth = ban
-00057280: 6477 6964 7468 202a 2078 6672 6571 2f4e  dwidth * xfreq/N
-00057290: 0a0a 2020 2020 2320 5265 6d6f 7665 2070  ..    # Remove p
-000572a0: 6164 6465 6420 7265 7375 6c74 730a 2020  added results.  
-000572b0: 2020 7067 7261 6d20 3d20 7067 7261 6d5b    pgram = pgram[
-000572c0: 313a 284e 7370 6563 2b31 292c 203a 2c20  1:(Nspec+1), :, 
-000572d0: 3a5d 0a0a 2020 2020 7370 6563 203d 206e  :]..    spec = n
-000572e0: 702e 656d 7074 7928 284e 7370 6563 2c20  p.empty((Nspec, 
-000572f0: 6e73 6572 2929 0a20 2020 2066 6f72 2069  nser)).    for i
-00057300: 2069 6e20 7261 6e67 6528 6e73 6572 293a   in range(nser):
-00057310: 0a20 2020 2020 2020 2073 7065 635b 3a2c  .        spec[:,
-00057320: 2069 5d20 3d20 6e70 2e72 6561 6c28 7067   i] = np.real(pg
-00057330: 7261 6d5b 3a2c 2069 2c20 695d 290a 0a20  ram[:, i, i]).. 
-00057340: 2020 2069 6620 6e73 6572 203d 3d20 313a     if nser == 1:
-00057350: 0a20 2020 2020 2020 2063 6f68 203d 204e  .        coh = N
-00057360: 6f6e 650a 2020 2020 2020 2020 7068 6173  one.        phas
-00057370: 6520 3d20 4e6f 6e65 0a20 2020 2065 6c73  e = None.    els
-00057380: 653a 0a20 2020 2020 2020 2063 6f68 203d  e:.        coh =
-00057390: 206e 702e 656d 7074 7928 284e 7370 6563   np.empty((Nspec
-000573a0: 2c20 696e 7428 6e73 6572 202a 2028 6e73  , int(nser * (ns
-000573b0: 6572 202d 2031 292f 3229 2929 0a20 2020  er - 1)/2))).   
-000573c0: 2020 2020 2070 6861 7365 203d 206e 702e       phase = np.
-000573d0: 656d 7074 7928 284e 7370 6563 2c20 696e  empty((Nspec, in
-000573e0: 7428 6e73 6572 202a 2028 6e73 6572 202d  t(nser * (nser -
-000573f0: 2031 292f 3229 2929 0a20 2020 2020 2020   1)/2))).       
-00057400: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-00057410: 6e73 6572 293a 0a20 2020 2020 2020 2020  nser):.         
-00057420: 2020 2066 6f72 206a 2069 6e20 7261 6e67     for j in rang
-00057430: 6528 692b 312c 206e 7365 7229 3a0a 2020  e(i+1, nser):.  
-00057440: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00057450: 6465 7820 3d20 696e 7428 6920 2b20 6a2a  dex = int(i + j*
-00057460: 286a 2d31 292f 3229 0a20 2020 2020 2020  (j-1)/2).       
-00057470: 2020 2020 2020 2020 2063 6f68 5b3a 2c20           coh[:, 
-00057480: 696e 6465 785d 203d 206e 702e 6162 7328  index] = np.abs(
-00057490: 7067 7261 6d5b 3a2c 2069 2c20 6a5d 292a  pgram[:, i, j])*
-000574a0: 2a32 202f 2028 7370 6563 5b3a 2c20 695d  *2 / (spec[:, i]
-000574b0: 202a 2073 7065 635b 3a2c 206a 5d29 0a20   * spec[:, j]). 
-000574c0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000574d0: 6861 7365 5b3a 2c20 696e 6465 785d 203d  hase[:, index] =
-000574e0: 206e 702e 616e 676c 6528 7067 7261 6d5b   np.angle(pgram[
-000574f0: 3a2c 2069 2c20 6a5d 290a 0a20 2020 2073  :, i, j])..    s
-00057500: 7065 6320 3d20 7370 6563 202f 2075 320a  pec = spec / u2.
-00057510: 2020 2020 7370 6563 203d 2073 7065 632e      spec = spec.
-00057520: 7371 7565 657a 6528 290a 0a20 2020 2072  squeeze()..    r
-00057530: 6573 756c 7473 203d 207b 0a20 2020 2020  esults = {.     
-00057540: 2020 2027 6672 6571 273a 2066 7265 712c     'freq': freq,
-00057550: 0a20 2020 2020 2020 2027 7370 6563 273a  .        'spec':
-00057560: 2073 7065 632c 0a20 2020 2020 2020 2027   spec,.        '
-00057570: 636f 6827 3a20 636f 682c 0a20 2020 2020  coh': coh,.     
-00057580: 2020 2027 7068 6173 6527 3a20 7068 6173     'phase': phas
-00057590: 652c 0a20 2020 2020 2020 2027 6b65 726e  e,.        'kern
-000575a0: 656c 273a 206b 6572 6e65 6c2c 0a20 2020  el': kernel,.   
-000575b0: 2020 2020 2027 6466 273a 2064 662c 0a20       'df': df,. 
-000575c0: 2020 2020 2020 2027 6261 6e64 7769 6474         'bandwidt
-000575d0: 6827 3a20 6261 6e64 7769 6474 682c 0a20  h': bandwidth,. 
-000575e0: 2020 2020 2020 2027 6e2e 7573 6564 273a         'n.used':
-000575f0: 204e 2c0a 2020 2020 2020 2020 276f 7269   N,.        'ori
-00057600: 672e 6e27 3a20 4e30 2c0a 2020 2020 2020  g.n': N0,.      
-00057610: 2020 2774 6170 6572 273a 2074 6170 6572    'taper': taper
-00057620: 2c0a 2020 2020 2020 2020 2770 6164 273a  ,.        'pad':
-00057630: 2070 6164 2c0a 2020 2020 2020 2020 2764   pad,.        'd
-00057640: 6574 7265 6e64 273a 2064 6574 7265 6e64  etrend': detrend
-00057650: 2c0a 2020 2020 2020 2020 2764 656d 6561  ,.        'demea
-00057660: 6e27 3a20 6465 6d65 616e 2c0a 2020 2020  n': demean,.    
-00057670: 2020 2020 276d 6574 686f 6427 3a20 2752      'method': 'R
-00057680: 6177 2050 6572 696f 646f 6772 616d 2720  aw Periodogram' 
-00057690: 6966 206b 6572 6e65 6c20 6973 204e 6f6e  if kernel is Non
-000576a0: 6520 656c 7365 2027 536d 6f6f 7468 6564  e else 'Smoothed
-000576b0: 2050 6572 696f 646f 6772 616d 270a 2020   Periodogram'.  
-000576c0: 2020 7d0a 0a20 2020 2069 6620 706c 6f74    }..    if plot
-000576d0: 3a0a 2020 2020 2020 2020 706c 6f74 5f73  :.        plot_s
-000576e0: 7065 6328 7265 7375 6c74 732c 2063 6f76  pec(results, cov
-000576f0: 6572 6167 653d 302e 3935 2c20 2a2a 6b77  erage=0.95, **kw
-00057700: 6172 6773 290a 0a20 2020 2072 6574 7572  args)..    retur
-00057710: 6e20 7265 7375 6c74 730a 0a64 6566 2061  n results..def a
-00057720: 6c66 666d 6170 2820 782c 2066 6c6f 3d30  lffmap( x, flo=0
-00057730: 2e30 312c 2066 6869 3d30 2e31 2c20 7472  .01, fhi=0.1, tr
-00057740: 3d31 2c20 6465 7472 656e 6420 3d20 5472  =1, detrend = Tr
-00057750: 7565 2029 3a0a 2020 2020 2222 220a 2020  ue ):.    """.  
-00057760: 2020 416d 706c 6974 7564 6520 6f66 204c    Amplitude of L
-00057770: 6f77 2046 7265 7175 656e 6379 2046 6c75  ow Frequency Flu
-00057780: 6374 7561 7469 6f6e 7320 2841 4c46 463b  ctuations (ALFF;
-00057790: 205a 616e 6720 6574 2061 6c2e 2c20 3230   Zang et al., 20
-000577a0: 3037 2920 616e 640a 2020 2020 6672 6163  07) and.    frac
-000577b0: 7469 6f6e 616c 2041 6d70 6c69 7475 6465  tional Amplitude
-000577c0: 206f 6620 4c6f 7720 4672 6571 7565 6e63   of Low Frequenc
-000577d0: 7920 466c 7563 7475 6174 696f 6e73 2028  y Fluctuations (
-000577e0: 662f 414c 4646 3b20 5a6f 7520 6574 2061  f/ALFF; Zou et a
-000577f0: 6c2e 2c20 3230 3038 290a 2020 2020 6172  l., 2008).    ar
-00057800: 6520 7265 6c61 7465 6420 6d65 6173 7572  e related measur
-00057810: 6573 2074 6861 7420 7175 616e 7469 6679  es that quantify
-00057820: 2074 6865 2061 6d70 6c69 7475 6465 206f   the amplitude o
-00057830: 6620 6c6f 7720 6672 6571 7565 6e63 790a  f low frequency.
-00057840: 2020 2020 6f73 6369 6c6c 6174 696f 6e73      oscillations
-00057850: 2028 4c46 4f73 292e 2020 5468 6973 2066   (LFOs).  This f
-00057860: 756e 6374 696f 6e20 6f75 7470 7574 7320  unction outputs 
-00057870: 414c 4646 2061 6e64 2066 414c 4646 2066  ALFF and fALFF f
-00057880: 6f72 2074 6865 2069 6e70 7574 2e0a 2020  or the input..  
-00057890: 2020 7361 6d65 2066 756e 6374 696f 6e20    same function 
-000578a0: 696e 2041 4e54 7352 2e0a 0a20 2020 2078  in ANTsR...    x
-000578b0: 2069 6e70 7574 2076 6563 746f 7220 666f   input vector fo
-000578c0: 7220 7468 6520 7469 6d65 2073 6572 6965  r the time serie
-000578d0: 7320 6f66 2069 6e74 6572 6573 740a 2020  s of interest.  
-000578e0: 2020 666c 6f20 6c6f 7720 6672 6571 7565    flo low freque
-000578f0: 6e63 792c 2074 7970 6963 616c 6c79 2030  ncy, typically 0
-00057900: 2e30 310a 2020 2020 6668 6920 6869 6768  .01.    fhi high
-00057910: 2066 7265 7175 656e 6379 2c20 7479 7069   frequency, typi
-00057920: 6361 6c6c 7920 302e 310a 2020 2020 7472  cally 0.1.    tr
-00057930: 2074 6865 2070 6572 696f 6420 6173 736f   the period asso
-00057940: 6369 6174 6564 2077 6974 6820 7468 6520  ciated with the 
-00057950: 7665 6374 6f72 2078 2028 696e 7665 7273  vector x (invers
-00057960: 6520 6f66 2066 7265 7175 656e 6379 290a  e of frequency).
-00057970: 2020 2020 6465 7472 656e 6420 6465 7472      detrend detr
-00057980: 656e 6420 7468 6520 696e 7075 7420 7469  end the input ti
-00057990: 6d65 2073 6572 6965 730a 0a20 2020 2072  me series..    r
-000579a0: 6574 7572 6e20 7665 6374 6f72 2069 7320  eturn vector is 
-000579b0: 6f75 7470 7574 2073 686f 7769 6e67 2041  output showing A
-000579c0: 4c46 4620 616e 6420 6641 4c46 4620 7661  LFF and fALFF va
-000579d0: 6c75 6573 0a20 2020 2022 2222 0a20 2020  lues.    """.   
-000579e0: 2074 656d 7020 3d20 7370 6563 5f70 6772   temp = spec_pgr
-000579f0: 616d 2820 782c 2078 6672 6571 3d31 2e30  am( x, xfreq=1.0
-00057a00: 2f74 722c 2064 656d 6561 6e3d 4661 6c73  /tr, demean=Fals
-00057a10: 652c 2064 6574 7265 6e64 3d64 6574 7265  e, detrend=detre
-00057a20: 6e64 2c20 7461 7065 723d 302c 2066 6173  nd, taper=0, fas
-00057a30: 743d 5472 7565 2c20 706c 6f74 3d46 616c  t=True, plot=Fal
-00057a40: 7365 2029 0a20 2020 2066 7365 6c65 6374  se ).    fselect
-00057a50: 203d 206e 702e 6c6f 6769 6361 6c5f 616e   = np.logical_an
-00057a60: 6428 2074 656d 705b 2766 7265 7127 5d20  d( temp['freq'] 
-00057a70: 3e3d 2066 6c6f 2c20 7465 6d70 5b27 6672  >= flo, temp['fr
-00057a80: 6571 275d 203c 3d20 6668 6920 290a 2020  eq'] <= fhi ).  
-00057a90: 2020 6465 6e6f 6d20 3d20 2874 656d 705b    denom = (temp[
-00057aa0: 2773 7065 6327 5d29 2e73 756d 2829 0a20  'spec']).sum(). 
-00057ab0: 2020 206e 756d 6572 203d 2028 7465 6d70     numer = (temp
-00057ac0: 5b27 7370 6563 275d 5b66 7365 6c65 6374  ['spec'][fselect
-00057ad0: 5d29 2e73 756d 2829 0a20 2020 2072 6574  ]).sum().    ret
-00057ae0: 7572 6e20 7b20 2027 616c 6666 273a 6e75  urn {  'alff':nu
-00057af0: 6d65 722c 2027 6661 6c66 6627 3a20 6e75  mer, 'falff': nu
-00057b00: 6d65 722f 6465 6e6f 6d20 7d0a 0a0a 6465  mer/denom }...de
-00057b10: 6620 616c 6666 5f69 6d61 6765 2820 782c  f alff_image( x,
-00057b20: 206d 6173 6b2c 2066 6c6f 3d30 2e30 312c   mask, flo=0.01,
-00057b30: 2066 6869 3d30 2e31 2c20 6e75 6973 616e   fhi=0.1, nuisan
-00057b40: 6365 3d4e 6f6e 6520 293a 0a20 2020 2022  ce=None ):.    "
-00057b50: 2222 0a20 2020 2041 6d70 6c69 7475 6465  "".    Amplitude
-00057b60: 206f 6620 4c6f 7720 4672 6571 7565 6e63   of Low Frequenc
-00057b70: 7920 466c 7563 7475 6174 696f 6e73 2028  y Fluctuations (
-00057b80: 414c 4646 3b20 5a61 6e67 2065 7420 616c  ALFF; Zang et al
-00057b90: 2e2c 2032 3030 3729 2061 6e64 0a20 2020  ., 2007) and.   
-00057ba0: 2066 7261 6374 696f 6e61 6c20 416d 706c   fractional Ampl
-00057bb0: 6974 7564 6520 6f66 204c 6f77 2046 7265  itude of Low Fre
-00057bc0: 7175 656e 6379 2046 6c75 6374 7561 7469  quency Fluctuati
-00057bd0: 6f6e 7320 2866 2f41 4c46 463b 205a 6f75  ons (f/ALFF; Zou
-00057be0: 2065 7420 616c 2e2c 2032 3030 3829 0a20   et al., 2008). 
-00057bf0: 2020 2061 7265 2072 656c 6174 6564 206d     are related m
-00057c00: 6561 7375 7265 7320 7468 6174 2071 7561  easures that qua
-00057c10: 6e74 6966 7920 7468 6520 616d 706c 6974  ntify the amplit
-00057c20: 7564 6520 6f66 206c 6f77 2066 7265 7175  ude of low frequ
-00057c30: 656e 6379 0a20 2020 206f 7363 696c 6c61  ency.    oscilla
-00057c40: 7469 6f6e 7320 284c 464f 7329 2e20 2054  tions (LFOs).  T
-00057c50: 6869 7320 6675 6e63 7469 6f6e 206f 7574  his function out
-00057c60: 7075 7473 2041 4c46 4620 616e 6420 6641  puts ALFF and fA
-00057c70: 4c46 4620 666f 7220 7468 6520 696e 7075  LFF for the inpu
-00057c80: 742e 0a0a 2020 2020 7820 2d20 696e 7075  t...    x - inpu
-00057c90: 7420 636c 6561 6e20 7265 7374 696e 6720  t clean resting 
-00057ca0: 7374 6174 6520 666d 7269 0a20 2020 206d  state fmri.    m
-00057cb0: 6173 6b20 2d20 6d61 736b 206f 7665 7220  ask - mask over 
-00057cc0: 7768 6963 6820 746f 2063 6f6d 7075 7465  which to compute
-00057cd0: 2066 2f61 6c66 660a 2020 2020 666c 6f20   f/alff.    flo 
-00057ce0: 2d20 6c6f 7720 6672 6571 7565 6e63 792c  - low frequency,
-00057cf0: 2074 7970 6963 616c 6c79 2030 2e30 310a   typically 0.01.
-00057d00: 2020 2020 6668 6920 2d20 6869 6768 2066      fhi - high f
-00057d10: 7265 7175 656e 6379 2c20 7479 7069 6361  requency, typica
-00057d20: 6c6c 7920 302e 310a 2020 2020 6e75 6973  lly 0.1.    nuis
-00057d30: 616e 6365 202d 206f 7074 696f 6e61 6c20  ance - optional 
-00057d40: 6e75 6973 616e 6365 206d 6174 7269 780a  nuisance matrix.
-00057d50: 0a20 2020 2072 6574 7572 6e20 6469 6374  .    return dict
-00057d60: 696f 6e61 7279 2077 6974 6820 414c 4646  ionary with ALFF
-00057d70: 2061 6e64 2066 414c 4646 2069 6d61 6765   and fALFF image
-00057d80: 730a 2020 2020 2222 220a 2020 2020 786d  s.    """.    xm
-00057d90: 6174 203d 2061 6e74 732e 7469 6d65 7365  at = ants.timese
-00057da0: 7269 6573 5f74 6f5f 6d61 7472 6978 2820  ries_to_matrix( 
-00057db0: 782c 206d 6173 6b20 290a 2020 2020 6966  x, mask ).    if
-00057dc0: 206e 7569 7361 6e63 6520 6973 206e 6f74   nuisance is not
-00057dd0: 204e 6f6e 653a 0a20 2020 2020 2020 2078   None:.        x
-00057de0: 6d61 7420 3d20 616e 7473 2e72 6567 7265  mat = ants.regre
-00057df0: 7373 5f63 6f6d 706f 6e65 6e74 7328 2078  ss_components( x
-00057e00: 6d61 742c 206e 7569 7361 6e63 6520 290a  mat, nuisance ).
-00057e10: 2020 2020 616c 6666 7665 6320 3d20 786d      alffvec = xm
-00057e20: 6174 5b30 2c3a 5d2a 300a 2020 2020 6661  at[0,:]*0.    fa
-00057e30: 6c66 6676 6563 203d 2078 6d61 745b 302c  lffvec = xmat[0,
-00057e40: 3a5d 2a30 0a20 2020 206d 7974 7220 3d20  :]*0.    mytr = 
-00057e50: 616e 7473 2e67 6574 5f73 7061 6369 6e67  ants.get_spacing
-00057e60: 2820 7820 295b 335d 0a20 2020 2066 6f72  ( x )[3].    for
-00057e70: 206e 2069 6e20 7261 6e67 6528 2078 6d61   n in range( xma
-00057e80: 742e 7368 6170 655b 315d 2029 3a0a 2020  t.shape[1] ):.  
-00057e90: 2020 2020 2020 7465 6d70 203d 2061 6c66        temp = alf
-00057ea0: 666d 6170 2820 786d 6174 5b3a 2c6e 5d2c  fmap( xmat[:,n],
-00057eb0: 2066 6c6f 3d66 6c6f 2c20 6668 693d 6668   flo=flo, fhi=fh
-00057ec0: 692c 2074 723d 6d79 7472 2029 0a20 2020  i, tr=mytr ).   
-00057ed0: 2020 2020 2061 6c66 6676 6563 5b6e 5d3d       alffvec[n]=
-00057ee0: 7465 6d70 5b27 616c 6666 275d 0a20 2020  temp['alff'].   
-00057ef0: 2020 2020 2066 616c 6666 7665 635b 6e5d       falffvec[n]
-00057f00: 3d74 656d 705b 2766 616c 6666 275d 0a20  =temp['falff']. 
-00057f10: 2020 2061 6c66 6669 3d61 6e74 732e 6d61     alffi=ants.ma
-00057f20: 6b65 5f69 6d61 6765 2820 6d61 736b 2c20  ke_image( mask, 
-00057f30: 616c 6666 7665 6320 290a 2020 2020 6661  alffvec ).    fa
-00057f40: 6c66 6669 3d61 6e74 732e 6d61 6b65 5f69  lffi=ants.make_i
-00057f50: 6d61 6765 2820 6d61 736b 2c20 6661 6c66  mage( mask, falf
-00057f60: 6676 6563 2029 0a20 2020 2061 6c66 6674  fvec ).    alfft
-00057f70: 7269 6d6d 6564 6d65 616e 203d 2063 616c  rimmedmean = cal
-00057f80: 6375 6c61 7465 5f74 7269 6d6d 6564 5f6d  culate_trimmed_m
-00057f90: 6561 6e28 2061 6c66 6676 6563 2c20 302e  ean( alffvec, 0.
-00057fa0: 3031 2029 0a20 2020 2066 616c 6666 7472  01 ).    falfftr
-00057fb0: 696d 6d65 646d 6561 6e20 3d20 6361 6c63  immedmean = calc
-00057fc0: 756c 6174 655f 7472 696d 6d65 645f 6d65  ulate_trimmed_me
-00057fd0: 616e 2820 6661 6c66 6676 6563 2c20 302e  an( falffvec, 0.
-00057fe0: 3031 2029 0a20 2020 2061 6c66 6669 3d61  01 ).    alffi=a
-00057ff0: 6c66 6669 202f 2061 6c66 6674 7269 6d6d  lffi / alfftrimm
-00058000: 6564 6d65 616e 0a20 2020 2066 616c 6666  edmean.    falff
-00058010: 693d 6661 6c66 6669 202f 2066 616c 6666  i=falffi / falff
-00058020: 7472 696d 6d65 646d 6561 6e0a 2020 2020  trimmedmean.    
-00058030: 7265 7475 726e 207b 2020 2761 6c66 6627  return {  'alff'
-00058040: 3a20 616c 6666 692c 2027 6661 6c66 6627  : alffi, 'falff'
-00058050: 3a20 6661 6c66 6669 207d 0a0a 0a64 6566  : falffi }...def
-00058060: 2064 6f77 6e32 6973 6f28 2078 2c20 696e   down2iso( x, in
-00058070: 7465 7270 6f6c 6174 696f 6e3d 276c 696e  terpolation='lin
-00058080: 6561 7227 2c20 7461 6b65 6d69 6e3d 4661  ear', takemin=Fa
-00058090: 6c73 6520 293a 0a20 2020 2022 2222 0a20  lse ):.    """. 
-000580a0: 2020 2077 696c 6c20 646f 776e 7361 6d70     will downsamp
-000580b0: 6c65 2061 6e20 616e 6973 6f74 726f 7069  le an anisotropi
-000580c0: 6320 696d 6167 6520 746f 2061 6e20 6973  c image to an is
-000580d0: 6f74 726f 7069 6320 7265 736f 6c75 7469  otropic resoluti
-000580e0: 6f6e 0a0a 2020 2020 783a 2069 6e70 7574  on..    x: input
-000580f0: 2069 6d61 6765 0a0a 2020 2020 696e 7465   image..    inte
-00058100: 7270 6f6c 6174 696f 6e3a 206c 696e 6561  rpolation: linea
-00058110: 7220 6f72 206e 6561 7265 7374 6e65 6967  r or nearestneig
-00058120: 6862 6f72 0a0a 2020 2020 7461 6b65 6d69  hbor..    takemi
-00058130: 6e20 3a20 626f 6f6c 6561 6e20 6d61 7020  n : boolean map 
-00058140: 746f 206d 696e 2073 7061 6365 3b20 6f74  to min space; ot
-00058150: 6865 7277 6973 6520 6d61 780a 0a20 2020  herwise max..   
-00058160: 2072 6574 7572 6e20 696d 6167 6520 646f   return image do
-00058170: 776e 7361 6d70 6c65 6420 746f 2069 736f  wnsampled to iso
-00058180: 7472 6f70 6963 2072 6573 6f6c 7574 696f  tropic resolutio
-00058190: 6e0a 2020 2020 2222 220a 2020 2020 7370  n.    """.    sp
-000581a0: 6320 3d20 616e 7473 2e67 6574 5f73 7061  c = ants.get_spa
-000581b0: 6369 6e67 2820 7820 290a 2020 2020 6966  cing( x ).    if
-000581c0: 2074 616b 656d 696e 3a0a 2020 2020 2020   takemin:.      
-000581d0: 2020 6e65 7773 7063 203d 206e 702e 6173    newspc = np.as
-000581e0: 6172 7261 7928 7370 6329 2e6d 696e 2829  array(spc).min()
-000581f0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00058200: 2020 206e 6577 7370 6320 3d20 6e70 2e61     newspc = np.a
-00058210: 7361 7272 6179 2873 7063 292e 6d61 7828  sarray(spc).max(
-00058220: 290a 2020 2020 6e65 7773 7063 203d 206e  ).    newspc = n
-00058230: 702e 7265 7065 6174 2820 6e65 7773 7063  p.repeat( newspc
-00058240: 2c20 782e 6469 6d65 6e73 696f 6e20 290a  , x.dimension ).
-00058250: 2020 2020 6966 2069 6e74 6572 706f 6c61      if interpola
-00058260: 7469 6f6e 203d 3d20 276c 696e 6561 7227  tion == 'linear'
-00058270: 3a0a 2020 2020 2020 2020 7873 203d 2061  :.        xs = a
-00058280: 6e74 732e 7265 7361 6d70 6c65 5f69 6d61  nts.resample_ima
-00058290: 6765 2820 782c 206e 6577 7370 632c 2069  ge( x, newspc, i
-000582a0: 6e74 6572 705f 7479 7065 3d30 290a 2020  nterp_type=0).  
-000582b0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000582c0: 7873 203d 2061 6e74 732e 7265 7361 6d70  xs = ants.resamp
-000582d0: 6c65 5f69 6d61 6765 2820 782c 206e 6577  le_image( x, new
-000582e0: 7370 632c 2069 6e74 6572 705f 7479 7065  spc, interp_type
-000582f0: 3d31 290a 2020 2020 7265 7475 726e 2078  =1).    return x
-00058300: 730a 0a0a 6465 6620 7265 6164 5f6d 6d5f  s...def read_mm_
-00058310: 6373 7628 2078 2c20 6973 5f74 313d 4661  csv( x, is_t1=Fa
-00058320: 6c73 652c 2063 6f6c 7072 6566 6978 3d4e  lse, colprefix=N
-00058330: 6f6e 652c 2073 6570 6172 6174 6f72 3d27  one, separator='
-00058340: 2d27 2c20 7665 7262 6f73 653d 4661 6c73  -', verbose=Fals
-00058350: 6520 293a 0a20 2020 2073 706c 6974 7465  e ):.    splitte
-00058360: 723d 6f73 2e70 6174 682e 6261 7365 6e61  r=os.path.basena
-00058370: 6d65 2878 292e 7370 6c69 7428 2073 6570  me(x).split( sep
-00058380: 6172 6174 6f72 2029 0a20 2020 206c 656e  arator ).    len
-00058390: 7370 6c69 7420 3d20 6c65 6e28 2073 706c  split = len( spl
-000583a0: 6974 7465 7220 292d 310a 2020 2020 7465  itter )-1.    te
-000583b0: 6d70 203d 206f 732e 7061 7468 2e62 6173  mp = os.path.bas
-000583c0: 656e 616d 6528 7829 0a20 2020 2074 656d  ename(x).    tem
-000583d0: 7020 3d20 6f73 2e70 6174 682e 7370 6c69  p = os.path.spli
-000583e0: 7465 7874 2874 656d 7029 5b30 5d0a 2020  text(temp)[0].  
-000583f0: 2020 7465 6d70 203d 2072 652e 7375 6228    temp = re.sub(
-00058400: 7365 7061 7261 746f 722b 276d 6d77 6964  separator+'mmwid
-00058410: 6527 2c27 272c 7465 6d70 290a 2020 2020  e','',temp).    
-00058420: 6964 636f 6c73 203d 205b 2775 5f68 6965  idcols = ['u_hie
-00058430: 725f 6964 272c 2773 6964 272c 2776 6973  r_id','sid','vis
-00058440: 6974 6461 7465 272c 276d 6f64 616c 6974  itdate','modalit
-00058450: 7927 2c27 6d6d 696d 6167 6575 6964 272c  y','mmimageuid',
-00058460: 2774 3169 6d61 6765 7569 6427 5d0a 2020  't1imageuid'].  
-00058470: 2020 6466 203d 2070 642e 4461 7461 4672    df = pd.DataFr
-00058480: 616d 6528 2063 6f6c 756d 6e73 203d 2069  ame( columns = i
-00058490: 6463 6f6c 732c 2069 6e64 6578 3d72 616e  dcols, index=ran
-000584a0: 6765 2831 2920 290a 2020 2020 7661 6c73  ge(1) ).    vals
-000584b0: 746f 6164 6420 3d20 5b74 656d 705d 202b  toadd = [temp] +
-000584c0: 2073 706c 6974 7465 725b 313a 286c 656e   splitter[1:(len
-000584d0: 7370 6c69 742d 3129 5d0a 2020 2020 6966  split-1)].    if
-000584e0: 2069 735f 7431 3a0a 2020 2020 2020 2020   is_t1:.        
-000584f0: 7661 6c73 746f 6164 6420 3d20 7661 6c73  valstoadd = vals
-00058500: 746f 6164 6420 2b20 5b73 706c 6974 7465  toadd + [splitte
-00058510: 725b 286c 656e 7370 6c69 742d 3129 5d2c  r[(lensplit-1)],
-00058520: 7370 6c69 7474 6572 5b28 6c65 6e73 706c  splitter[(lenspl
-00058530: 6974 2d31 295d 5d0a 2020 2020 656c 7365  it-1)]].    else
-00058540: 3a0a 2020 2020 2020 2020 7370 6c69 7432  :.        split2
-00058550: 3d73 706c 6974 7465 725b 286c 656e 7370  =splitter[(lensp
-00058560: 6c69 742d 3129 5d2e 7370 6c69 7428 2022  lit-1)].split( "
-00058570: 5f22 2029 0a20 2020 2020 2020 2069 6620  _" ).        if 
-00058580: 6c65 6e28 7370 6c69 7432 2920 3d3d 2031  len(split2) == 1
-00058590: 3a0a 2020 2020 2020 2020 2020 2020 7370  :.            sp
-000585a0: 6c69 7432 2e61 7070 656e 6428 2073 706c  lit2.append( spl
-000585b0: 6974 325b 305d 2029 0a20 2020 2020 2020  it2[0] ).       
-000585c0: 2069 6620 6c65 6e28 7661 6c73 746f 6164   if len(valstoad
-000585d0: 6429 203d 3d20 333a 0a20 2020 2020 2020  d) == 3:.       
-000585e0: 2020 2020 2076 616c 7374 6f61 6464 203d       valstoadd =
-000585f0: 2076 616c 7374 6f61 6464 202b 205b 7370   valstoadd + [sp
-00058600: 6c69 7432 5b30 5d5d 202b 205b 6d61 7468  lit2[0]] + [math
-00058610: 2e6e 616e 5d20 2b20 5b73 706c 6974 325b  .nan] + [split2[
-00058620: 315d 5d0a 2020 2020 2020 2020 656c 7365  1]].        else
-00058630: 3a0a 2020 2020 2020 2020 2020 2020 7661  :.            va
-00058640: 6c73 746f 6164 6420 3d20 7661 6c73 746f  lstoadd = valsto
-00058650: 6164 6420 2b20 5b73 706c 6974 325b 305d  add + [split2[0]
-00058660: 2c73 706c 6974 325b 315d 5d0a 2020 2020  ,split2[1]].    
-00058670: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-00058680: 2020 2020 7072 696e 7428 2076 616c 7374      print( valst
-00058690: 6f61 6464 2029 0a20 2020 2064 662e 696c  oadd ).    df.il
-000586a0: 6f63 5b30 5d20 3d20 7661 6c73 746f 6164  oc[0] = valstoad
-000586b0: 640a 2020 2020 6966 2076 6572 626f 7365  d.    if verbose
-000586c0: 3a0a 2020 2020 2020 2020 7072 696e 7428  :.        print(
-000586d0: 2022 7265 6164 2078 6466 3a20 2220 2b20   "read xdf: " + 
-000586e0: 7820 290a 2020 2020 7864 6620 3d20 7064  x ).    xdf = pd
-000586f0: 2e72 6561 645f 6373 7628 2078 2029 0a20  .read_csv( x ). 
-00058700: 2020 2064 662e 7265 7365 745f 696e 6465     df.reset_inde
-00058710: 7828 290a 2020 2020 7864 662e 7265 7365  x().    xdf.rese
-00058720: 745f 696e 6465 7828 6472 6f70 3d54 7275  t_index(drop=Tru
-00058730: 6529 0a20 2020 2069 6620 2255 6e6e 616d  e).    if "Unnam
-00058740: 6564 3a20 3022 2069 6e20 7864 662e 636f  ed: 0" in xdf.co
-00058750: 6c75 6d6e 733a 0a20 2020 2020 2020 2068  lumns:.        h
-00058760: 6f6c 6465 723d 7864 662e 706f 7028 2022  older=xdf.pop( "
-00058770: 556e 6e61 6d65 643a 2030 2220 290a 2020  Unnamed: 0" ).  
-00058780: 2020 6966 2022 556e 6e61 6d65 643a 2031    if "Unnamed: 1
-00058790: 2220 696e 2078 6466 2e63 6f6c 756d 6e73  " in xdf.columns
-000587a0: 3a0a 2020 2020 2020 2020 686f 6c64 6572  :.        holder
-000587b0: 3d78 6466 2e70 6f70 2820 2255 6e6e 616d  =xdf.pop( "Unnam
-000587c0: 6564 3a20 3122 2029 0a20 2020 2069 6620  ed: 1" ).    if 
-000587d0: 2275 5f68 6965 725f 6964 2e31 2220 696e  "u_hier_id.1" in
-000587e0: 2078 6466 2e63 6f6c 756d 6e73 3a0a 2020   xdf.columns:.  
-000587f0: 2020 2020 2020 686f 6c64 6572 3d78 6466        holder=xdf
-00058800: 2e70 6f70 2820 2275 5f68 6965 725f 6964  .pop( "u_hier_id
-00058810: 2e31 2220 290a 2020 2020 6966 2022 755f  .1" ).    if "u_
-00058820: 6869 6572 5f69 6422 2069 6e20 7864 662e  hier_id" in xdf.
-00058830: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
-00058840: 2068 6f6c 6465 723d 7864 662e 706f 7028   holder=xdf.pop(
-00058850: 2022 755f 6869 6572 5f69 6422 2029 0a20   "u_hier_id" ). 
-00058860: 2020 2069 6620 6e6f 7420 6973 5f74 313a     if not is_t1:
-00058870: 0a20 2020 2020 2020 2069 6620 2772 6573  .        if 'res
-00058880: 6e65 7447 7261 6465 2720 696e 2078 6466  netGrade' in xdf
-00058890: 2e63 6f6c 756d 6e73 3a0a 2020 2020 2020  .columns:.      
-000588a0: 2020 2020 2020 696e 6465 785f 6e6f 203d        index_no =
-000588b0: 2078 6466 2e63 6f6c 756d 6e73 2e67 6574   xdf.columns.get
-000588c0: 5f6c 6f63 2827 7265 736e 6574 4772 6164  _loc('resnetGrad
-000588d0: 6527 290a 2020 2020 2020 2020 2020 2020  e').            
-000588e0: 7864 6620 3d20 7864 662e 6472 6f70 2820  xdf = xdf.drop( 
-000588f0: 7864 662e 636f 6c75 6d6e 735b 7261 6e67  xdf.columns[rang
-00058900: 6528 696e 6465 785f 6e6f 2b31 295d 202c  e(index_no+1)] ,
-00058910: 2061 7869 733d 3129 0a0a 2020 2020 6966   axis=1)..    if
-00058920: 2078 6466 2e73 6861 7065 5b30 5d20 3d3d   xdf.shape[0] ==
-00058930: 2032 3a0a 2020 2020 2020 2020 7864 6663   2:.        xdfc
-00058940: 6f6c 7320 3d20 7864 662e 636f 6c75 6d6e  ols = xdf.column
-00058950: 730a 2020 2020 2020 2020 7864 6620 3d20  s.        xdf = 
-00058960: 7864 662e 696c 6f63 5b31 5d0a 2020 2020  xdf.iloc[1].    
-00058970: 2020 2020 6464 6e75 6d20 3d20 7864 662e      ddnum = xdf.
-00058980: 746f 5f6e 756d 7079 2829 0a20 2020 2020  to_numpy().     
-00058990: 2020 2064 646e 756d 203d 2064 646e 756d     ddnum = ddnum
-000589a0: 2e72 6573 6861 7065 285b 312c 6464 6e75  .reshape([1,ddnu
-000589b0: 6d2e 7368 6170 655b 305d 5d29 0a20 2020  m.shape[0]]).   
-000589c0: 2020 2020 206e 6577 636f 6c6e 616d 6573       newcolnames
-000589d0: 203d 2078 6466 2e69 6e64 6578 2e74 6f5f   = xdf.index.to_
-000589e0: 6c69 7374 2829 0a20 2020 2020 2020 2069  list().        i
-000589f0: 6620 6c65 6e28 6e65 7763 6f6c 6e61 6d65  f len(newcolname
-00058a00: 7329 2021 3d20 6464 6e75 6d2e 7368 6170  s) != ddnum.shap
-00058a10: 655b 315d 3a0a 2020 2020 2020 2020 2020  e[1]:.          
-00058a20: 2020 7072 696e 7428 2243 616e 6e6f 7420    print("Cannot 
-00058a30: 4d65 7267 6520 3a20 5368 6170 6520 4d69  Merge : Shape Mi
-00058a40: 734d 6174 6368 2022 202b 2073 7472 2820  sMatch " + str( 
-00058a50: 6c65 6e28 6e65 7763 6f6c 6e61 6d65 7329  len(newcolnames)
-00058a60: 2029 202b 2022 2022 202b 2073 7472 2864   ) + " " + str(d
-00058a70: 646e 756d 2e73 6861 7065 5b31 5d29 290a  dnum.shape[1])).
-00058a80: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00058a90: 2020 2020 2020 2020 2020 7864 6620 3d20            xdf = 
-00058aa0: 7064 2e44 6174 6146 7261 6d65 2864 646e  pd.DataFrame(ddn
-00058ab0: 756d 2c20 636f 6c75 6d6e 733d 7864 6663  um, columns=xdfc
-00058ac0: 6f6c 7320 290a 2020 2020 6966 2078 6466  ols ).    if xdf
-00058ad0: 2e73 6861 7065 5b31 5d20 3d3d 2030 3a0a  .shape[1] == 0:.
-00058ae0: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-00058af0: 6f6e 650a 2020 2020 6966 2063 6f6c 7072  one.    if colpr
-00058b00: 6566 6978 2069 7320 6e6f 7420 4e6f 6e65  efix is not None
-00058b10: 3a0a 2020 2020 2020 2020 7864 662e 636f  :.        xdf.co
-00058b20: 6c75 6d6e 733d 636f 6c70 7265 6669 7820  lumns=colprefix 
-00058b30: 2b20 7864 662e 636f 6c75 6d6e 730a 2020  + xdf.columns.  
-00058b40: 2020 7265 7475 726e 2070 642e 636f 6e63    return pd.conc
-00058b50: 6174 2820 5b64 662c 7864 665d 2c20 6178  at( [df,xdf], ax
-00058b60: 6973 3d31 2c20 6967 6e6f 7265 5f69 6e64  is=1, ignore_ind
-00058b70: 6578 3d46 616c 7365 2029 0a0a 6465 6620  ex=False )..def 
-00058b80: 6d65 7267 655f 7769 6465 735f 746f 5f73  merge_wides_to_s
-00058b90: 7475 6479 5f64 6174 6166 7261 6d65 2820  tudy_dataframe( 
-00058ba0: 7364 662c 2070 726f 6365 7373 696e 675f  sdf, processing_
-00058bb0: 6469 722c 2073 6570 6172 6174 6f72 3d27  dir, separator='
-00058bc0: 2d27 2c20 7369 645f 6973 5f69 6e74 3d54  -', sid_is_int=T
-00058bd0: 7275 652c 2069 645f 6973 5f69 6e74 3d54  rue, id_is_int=T
-00058be0: 7275 652c 2064 6174 655f 6973 5f69 6e74  rue, date_is_int
-00058bf0: 3d54 7275 652c 2072 6570 6f72 745f 6d69  =True, report_mi
-00058c00: 7373 696e 673d 4661 6c73 652c 0a70 726f  ssing=False,.pro
-00058c10: 6772 6573 733d 4661 6c73 652c 2076 6572  gress=False, ver
-00058c20: 626f 7365 3d46 616c 7365 2029 3a0a 2020  bose=False ):.  
-00058c30: 2020 2222 220a 2020 2020 6578 7465 6e64    """.    extend
-00058c40: 2061 2073 7475 6479 2064 6174 6120 6672   a study data fr
-00058c50: 616d 6520 7769 7468 2077 6964 6520 6f75  ame with wide ou
-00058c60: 7470 7574 730a 0a20 2020 2073 6466 203a  tputs..    sdf :
-00058c70: 2074 6865 2069 6e70 7574 2073 7475 6479   the input study
-00058c80: 2064 6174 6166 7261 6d65 2066 726f 6d20   dataframe from 
-00058c90: 616e 7473 7079 6d6d 2051 4320 6f75 7470  antspymm QC outp
-00058ca0: 7574 0a0a 2020 2020 7072 6f63 6573 7369  ut..    processi
-00058cb0: 6e67 5f64 6972 3a20 2074 6865 2064 6972  ng_dir:  the dir
-00058cc0: 6563 746f 7279 206c 6f63 6174 696f 6e20  ectory location 
-00058cd0: 6f66 2074 6865 2070 726f 6365 7373 6564  of the processed
-00058ce0: 2064 6174 6120 0a0a 2020 2020 7365 7061   data ..    sepa
-00058cf0: 7261 746f 7220 3a20 7374 7269 6e67 2075  rator : string u
-00058d00: 7375 616c 6c79 2027 2d27 206f 7220 275f  sually '-' or '_
-00058d10: 270a 0a20 2020 2073 6964 5f69 735f 696e  '..    sid_is_in
-00058d20: 7420 3a20 626f 6f6c 6561 6e20 7365 7420  t : boolean set 
-00058d30: 746f 2054 7275 6520 746f 2063 6173 7420  to True to cast 
-00058d40: 756e 6971 7565 2073 7562 6a65 6374 2069  unique subject i
-00058d50: 6473 2074 6f20 696e 743b 2063 616e 2062  ds to int; can b
-00058d60: 6520 7573 6566 756c 2069 6620 7468 6579  e useful if they
-00058d70: 2061 7265 2069 6e61 6476 6572 7465 6e74   are inadvertent
-00058d80: 6c79 2073 746f 7265 6420 6173 2066 6c6f  ly stored as flo
-00058d90: 6174 2062 7920 7061 6e64 6173 0a0a 2020  at by pandas..  
-00058da0: 2020 6461 7465 5f69 735f 696e 7420 3a20    date_is_int : 
-00058db0: 626f 6f6c 6561 6e20 7365 7420 746f 2054  boolean set to T
-00058dc0: 7275 6520 746f 2063 6173 7420 6461 7465  rue to cast date
-00058dd0: 2074 6f20 696e 743b 2063 616e 2062 6520   to int; can be 
-00058de0: 7573 6566 756c 2069 6620 7468 6579 2061  useful if they a
-00058df0: 7265 2069 6e61 6476 6572 7465 6e74 6c79  re inadvertently
-00058e00: 2073 746f 7265 6420 6173 2066 6c6f 6174   stored as float
-00058e10: 2062 7920 7061 6e64 6173 0a0a 2020 2020   by pandas..    
-00058e20: 6964 5f69 735f 696e 7420 3a20 626f 6f6c  id_is_int : bool
-00058e30: 6561 6e20 7365 7420 746f 2054 7275 6520  ean set to True 
-00058e40: 746f 2063 6173 7420 756e 6971 7565 2069  to cast unique i
-00058e50: 6d61 6765 2069 6473 2074 6f20 696e 743b  mage ids to int;
-00058e60: 2063 616e 2062 6520 7573 6566 756c 2069   can be useful i
-00058e70: 6620 7468 6579 2061 7265 2069 6e61 6476  f they are inadv
-00058e80: 6572 7465 6e74 6c79 2073 746f 7265 6420  ertently stored 
-00058e90: 6173 2066 6c6f 6174 2062 7920 7061 6e64  as float by pand
-00058ea0: 6173 0a0a 2020 2020 7265 706f 7274 5f6d  as..    report_m
-00058eb0: 6973 7369 6e67 203a 2062 6f6f 6c65 616e  issing : boolean
-00058ec0: 2063 6f6d 6269 6e65 6420 7769 7468 2076   combined with v
-00058ed0: 6572 626f 7365 2077 696c 6c20 7265 706f  erbose will repo
-00058ee0: 7274 206d 6973 7369 6e67 206d 6f64 616c  rt missing modal
-00058ef0: 6974 6965 730a 0a20 2020 2070 726f 6772  ities..    progr
-00058f00: 6573 7320 3a20 696e 7465 6765 7220 7265  ess : integer re
-00058f10: 706f 7274 7320 7065 7263 656e 7420 7072  ports percent pr
-00058f20: 6f67 7265 7373 206d 6f64 756c 6f20 7072  ogress modulo pr
-00058f30: 6f67 7265 7373 2076 616c 7565 200a 0a20  ogress value .. 
-00058f40: 2020 2076 6572 626f 7365 203a 2062 6f6f     verbose : boo
-00058f50: 6c65 616e 0a20 2020 2022 2222 0a20 2020  lean.    """.   
-00058f60: 2066 726f 6d20 6f73 2e70 6174 6820 696d   from os.path im
-00058f70: 706f 7274 2065 7869 7374 730a 2020 2020  port exists.    
-00058f80: 6d75 7374 6861 7665 636f 6c73 203d 205b  musthavecols = [
-00058f90: 2770 726f 6a65 6374 4944 272c 2027 7375  'projectID', 'su
-00058fa0: 626a 6563 7449 4427 2c27 6461 7465 272c  bjectID','date',
-00058fb0: 2769 6d61 6765 4944 275d 0a20 2020 2066  'imageID'].    f
-00058fc0: 6f72 206b 2069 6e20 7261 6e67 6528 6c65  or k in range(le
-00058fd0: 6e28 6d75 7374 6861 7665 636f 6c73 2929  n(musthavecols))
-00058fe0: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
-00058ff0: 206d 7573 7468 6176 6563 6f6c 735b 6b5d   musthavecols[k]
-00059000: 2069 6e20 7364 662e 6b65 7973 2829 3a0a   in sdf.keys():.
-00059010: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00059020: 6520 5661 6c75 6545 7272 6f72 2827 7364  e ValueError('sd
-00059030: 6620 6973 206d 6973 7369 6e67 2063 6f6c  f is missing col
-00059040: 756d 6e20 2720 2b6d 7573 7468 6176 6563  umn ' +musthavec
-00059050: 6f6c 735b 6b5d 202b 2027 2069 6e20 6d65  ols[k] + ' in me
-00059060: 7267 655f 7769 6465 735f 746f 5f73 7475  rge_wides_to_stu
-00059070: 6479 5f64 6174 6166 7261 6d65 2720 290a  dy_dataframe' ).
-00059080: 2020 2020 706f 7373 6962 6c65 5f69 6964      possible_iid
-00059090: 7320 3d20 5b20 2769 6d61 6765 4944 272c  s = [ 'imageID',
-000590a0: 2027 696d 6167 6549 4427 2c20 2769 6d61   'imageID', 'ima
-000590b0: 6765 4944 272c 2027 666c 6169 7269 6427  geID', 'flairid'
-000590c0: 2c20 2764 7469 6431 272c 2027 6474 6964  , 'dtid1', 'dtid
-000590d0: 3227 2c20 2772 7366 6964 3127 2c20 2772  2', 'rsfid1', 'r
-000590e0: 7366 6964 3227 2c20 276e 6d69 6431 272c  sfid2', 'nmid1',
-000590f0: 2027 6e6d 6964 3227 2c20 276e 6d69 6433   'nmid2', 'nmid3
-00059100: 272c 2027 6e6d 6964 3427 2c20 276e 6d69  ', 'nmid4', 'nmi
-00059110: 6435 272c 2027 6e6d 6964 3627 2c20 276e  d5', 'nmid6', 'n
-00059120: 6d69 6437 272c 2027 6e6d 6964 3827 2c20  mid7', 'nmid8', 
-00059130: 276e 6d69 6439 272c 2027 6e6d 6964 3130  'nmid9', 'nmid10
-00059140: 272c 2027 7065 7266 6964 2720 5d0a 2020  ', 'perfid' ].  
-00059150: 2020 6d6f 6461 6c69 7479 5f69 6473 203d    modality_ids =
-00059160: 205b 2027 5431 7748 6965 7261 7263 6869   [ 'T1wHierarchi
-00059170: 6361 6c27 2c20 2754 3177 4869 6572 6172  cal', 'T1wHierar
-00059180: 6368 6963 616c 5352 272c 2027 5431 7727  chicalSR', 'T1w'
-00059190: 2c20 2754 3246 6c61 6972 272c 2027 4454  , 'T2Flair', 'DT
-000591a0: 4927 2c20 2744 5449 272c 2027 7273 664d  I', 'DTI', 'rsfM
-000591b0: 5249 272c 2027 7273 664d 5249 272c 2027  RI', 'rsfMRI', '
-000591c0: 4e4d 3244 4d54 272c 2027 4e4d 3244 4d54  NM2DMT', 'NM2DMT
-000591d0: 272c 2027 4e4d 3244 4d54 272c 2027 4e4d  ', 'NM2DMT', 'NM
-000591e0: 3244 4d54 272c 2027 4e4d 3244 4d54 272c  2DMT', 'NM2DMT',
-000591f0: 2027 4e4d 3244 4d54 272c 2027 4e4d 3244   'NM2DMT', 'NM2D
-00059200: 4d54 272c 2027 4e4d 3244 4d54 272c 2027  MT', 'NM2DMT', '
-00059210: 4e4d 3244 4d54 272c 2027 4e4d 3244 4d54  NM2DMT', 'NM2DMT
-00059220: 272c 2027 7065 7266 275d 0a20 2020 2061  ', 'perf'].    a
-00059230: 6c6c 6466 3d70 642e 4461 7461 4672 616d  lldf=pd.DataFram
-00059240: 6528 290a 2020 2020 666f 7220 6d79 6b20  e().    for myk 
-00059250: 696e 2073 6466 2e69 6e64 6578 3a0a 2020  in sdf.index:.  
-00059260: 2020 2020 2020 6966 2070 726f 6772 6573        if progres
-00059270: 7320 3e20 3020 616e 6420 696e 7428 6d79  s > 0 and int(my
-00059280: 6b29 2025 2069 6e74 2870 726f 6772 6573  k) % int(progres
-00059290: 7329 203d 3d20 303a 0a20 2020 2020 2020  s) == 0:.       
-000592a0: 2020 2020 2070 7269 6e74 2820 7374 7228       print( str(
-000592b0: 2072 6f75 6e64 2820 6d79 6b2f 7364 662e   round( myk/sdf.
-000592c0: 7368 6170 655b 305d 2a31 3030 2e30 2929  shape[0]*100.0))
-000592d0: 202b 2022 252e 2e2e 222c 2065 6e64 3d27   + "%...", end='
-000592e0: 272c 2066 6c75 7368 3d54 7275 6529 0a20  ', flush=True). 
-000592f0: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
-00059300: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
-00059310: 7269 6e74 2820 2244 4f52 4f57 2022 202b  rint( "DOROW " +
-00059320: 2073 7472 286d 796b 2920 2b20 2720 6f66   str(myk) + ' of
-00059330: 2027 202b 2073 7472 2820 7364 662e 7368   ' + str( sdf.sh
-00059340: 6170 655b 305d 2029 2029 0a20 2020 2020  ape[0] ) ).     
-00059350: 2020 2063 7376 726f 7720 3d20 7364 662e     csvrow = sdf.
-00059360: 6c6f 635b 7364 662e 696e 6465 7820 3d3d  loc[sdf.index ==
-00059370: 206d 796b 5d2e 6472 6f70 6e61 2861 7869   myk].dropna(axi
-00059380: 733d 3129 0a20 2020 2020 2020 2063 743d  s=1).        ct=
-00059390: 2d31 0a20 2020 2020 2020 2066 6f72 2069  -1.        for i
-000593a0: 6964 6b65 7920 696e 2070 6f73 7369 626c  idkey in possibl
-000593b0: 655f 6969 6473 3a0a 2020 2020 2020 2020  e_iids:.        
-000593c0: 2020 2020 6374 3d63 742b 310a 2020 2020      ct=ct+1.    
-000593d0: 2020 2020 2020 2020 6d6f 645f 6e61 6d65          mod_name
-000593e0: 203d 206d 6f64 616c 6974 795f 6964 735b   = modality_ids[
-000593f0: 6374 5d0a 2020 2020 2020 2020 2020 2020  ct].            
-00059400: 6966 2069 6964 6b65 7920 696e 2063 7376  if iidkey in csv
-00059410: 726f 772e 6b65 7973 2829 3a0a 2020 2020  row.keys():.    
-00059420: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00059430: 645f 6973 5f69 6e74 3a0a 2020 2020 2020  d_is_int:.      
-00059440: 2020 2020 2020 2020 2020 2020 2020 6969                ii
-00059450: 6420 3d20 7374 7228 2069 6e74 2820 6373  d = str( int( cs
-00059460: 7672 6f77 5b69 6964 6b65 795d 2e69 6c6f  vrow[iidkey].ilo
-00059470: 635b 305d 2029 2029 0a20 2020 2020 2020  c[0] ) ).       
-00059480: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00059490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000594a0: 2020 2069 6964 203d 2073 7472 2820 6373     iid = str( cs
-000594b0: 7672 6f77 5b69 6964 6b65 795d 2e69 6c6f  vrow[iidkey].ilo
-000594c0: 635b 305d 2029 0a20 2020 2020 2020 2020  c[0] ).         
-000594d0: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
-000594e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000594f0: 2020 2020 2020 2070 7269 6e74 2820 2269         print( "i
-00059500: 6964 6b65 7920 2220 2b20 6969 646b 6579  idkey " + iidkey
-00059510: 202b 2022 206d 6f64 616c 6974 7920 2220   + " modality " 
-00059520: 2b20 6d6f 645f 6e61 6d65 202b 2027 2069  + mod_name + ' i
-00059530: 6964 2027 2b20 6969 6420 290a 2020 2020  id '+ iid ).    
-00059540: 2020 2020 2020 2020 2020 2020 7069 643d              pid=
-00059550: 7374 7228 6373 7672 6f77 5b27 7072 6f6a  str(csvrow['proj
-00059560: 6563 7449 4427 5d2e 696c 6f63 5b30 5d20  ectID'].iloc[0] 
-00059570: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00059580: 2020 6966 2073 6964 5f69 735f 696e 743a    if sid_is_int:
-00059590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000595a0: 2020 2020 2073 6964 3d73 7472 2869 6e74       sid=str(int
-000595b0: 2863 7376 726f 775b 2773 7562 6a65 6374  (csvrow['subject
-000595c0: 4944 275d 2e69 6c6f 635b 305d 2029 290a  ID'].iloc[0] )).
-000595d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000595e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000595f0: 2020 2020 2020 2020 2020 7369 643d 7374            sid=st
-00059600: 7228 6373 7672 6f77 5b27 7375 626a 6563  r(csvrow['subjec
-00059610: 7449 4427 5d2e 696c 6f63 5b30 5d20 290a  tID'].iloc[0] ).
-00059620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059630: 6966 2064 6174 655f 6973 5f69 6e74 3a0a  if date_is_int:.
-00059640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059650: 2020 2020 6474 3d73 7472 2869 6e74 2863      dt=str(int(c
-00059660: 7376 726f 775b 2764 6174 6527 5d2e 696c  svrow['date'].il
-00059670: 6f63 5b30 5d29 290a 2020 2020 2020 2020  oc[0])).        
-00059680: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00059690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000596a0: 2020 6474 3d73 7472 2863 7376 726f 775b    dt=str(csvrow[
-000596b0: 2764 6174 6527 5d2e 696c 6f63 5b30 5d29  'date'].iloc[0])
-000596c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000596d0: 2069 6620 6964 5f69 735f 696e 743a 0a20   if id_is_int:. 
-000596e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000596f0: 2020 2074 3169 6964 3d73 7472 2869 6e74     t1iid=str(int
-00059700: 2863 7376 726f 775b 2769 6d61 6765 4944  (csvrow['imageID
-00059710: 275d 2e69 6c6f 635b 305d 2929 0a20 2020  '].iloc[0])).   
-00059720: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00059730: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00059740: 2020 2020 2020 2074 3169 6964 3d73 7472         t1iid=str
-00059750: 2863 7376 726f 775b 2769 6d61 6765 4944  (csvrow['imageID
-00059760: 275d 2e69 6c6f 635b 305d 290a 2020 2020  '].iloc[0]).    
-00059770: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-00059780: 3169 6964 2021 3d20 6969 643a 0a20 2020  1iid != iid:.   
-00059790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000597a0: 2069 6964 6a3d 6969 642b 225f 222b 7431   iidj=iid+"_"+t1
-000597b0: 6969 640a 2020 2020 2020 2020 2020 2020  iid.            
-000597c0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000597d0: 2020 2020 2020 2020 2020 2020 2020 6969                ii
-000597e0: 646a 3d69 6964 0a20 2020 2020 2020 2020  dj=iid.         
-000597f0: 2020 2020 2020 2072 6f6f 7469 6420 3d20         rootid = 
-00059800: 7069 6420 2b73 6570 6172 6174 6f72 2b20  pid +separator+ 
-00059810: 7369 6420 2b73 6570 6172 6174 6f72 2b64  sid +separator+d
-00059820: 742b 7365 7061 7261 746f 722b 6d6f 645f  t+separator+mod_
-00059830: 6e61 6d65 2b73 6570 6172 6174 6f72 2b69  name+separator+i
-00059840: 6964 6a0a 2020 2020 2020 2020 2020 2020  idj.            
-00059850: 2020 2020 6d79 6578 7420 3d20 726f 6f74      myext = root
-00059860: 6964 202b 7365 7061 7261 746f 722b 276d  id +separator+'m
-00059870: 6d77 6964 652e 6373 7627 0a20 2020 2020  mwide.csv'.     
-00059880: 2020 2020 2020 2020 2020 206e 7267 7769             nrgwi
-00059890: 6465 666e 3d6f 732e 7061 7468 2e6a 6f69  defn=os.path.joi
-000598a0: 6e28 2070 726f 6365 7373 696e 675f 6469  n( processing_di
-000598b0: 722c 2070 6964 2c20 7369 642c 2064 742c  r, pid, sid, dt,
-000598c0: 206d 6f64 5f6e 616d 652c 2069 6964 2c20   mod_name, iid, 
-000598d0: 6d79 6578 7420 290a 2020 2020 2020 2020  myext ).        
-000598e0: 2020 2020 2020 2020 6d6f 6464 6572 7375          moddersu
-000598f0: 6220 3d20 6d6f 645f 6e61 6d65 0a20 2020  b = mod_name.   
-00059900: 2020 2020 2020 2020 2020 2020 2069 735f               is_
-00059910: 7431 3d46 616c 7365 0a20 2020 2020 2020  t1=False.       
-00059920: 2020 2020 2020 2020 2069 6620 6d6f 645f           if mod_
-00059930: 6e61 6d65 203d 3d20 2754 3177 4869 6572  name == 'T1wHier
-00059940: 6172 6368 6963 616c 273a 0a20 2020 2020  archical':.     
-00059950: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00059960: 735f 7431 3d54 7275 650a 2020 2020 2020  s_t1=True.      
-00059970: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-00059980: 6464 6572 7375 623d 2754 3148 6965 7227  ddersub='T1Hier'
-00059990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000599a0: 2065 6c69 6620 6d6f 645f 6e61 6d65 203d   elif mod_name =
-000599b0: 3d20 2754 3177 4869 6572 6172 6368 6963  = 'T1wHierarchic
-000599c0: 616c 5352 273a 0a20 2020 2020 2020 2020  alSR':.         
-000599d0: 2020 2020 2020 2020 2020 2069 735f 7431             is_t1
-000599e0: 3d54 7275 650a 2020 2020 2020 2020 2020  =True.          
-000599f0: 2020 2020 2020 2020 2020 6d6f 6464 6572            modder
-00059a00: 7375 623d 2754 3148 5352 270a 2020 2020  sub='T1HSR'.    
-00059a10: 2020 2020 2020 2020 2020 2020 6966 2065              if e
-00059a20: 7869 7374 7328 206e 7267 7769 6465 666e  xists( nrgwidefn
-00059a30: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-00059a40: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-00059a50: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00059a60: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00059a70: 7428 206e 7267 7769 6465 666e 202b 2022  t( nrgwidefn + "
-00059a80: 2065 7869 7374 7322 290a 2020 2020 2020   exists").      
-00059a90: 2020 2020 2020 2020 2020 2020 2020 6d6d                mm
-00059aa0: 3d72 6561 645f 6d6d 5f63 7376 2820 6e72  =read_mm_csv( nr
-00059ab0: 6777 6964 6566 6e2c 2063 6f6c 7072 6566  gwidefn, colpref
-00059ac0: 6978 3d6d 6f64 6465 7273 7562 2b27 5f27  ix=moddersub+'_'
-00059ad0: 2c20 6973 5f74 313d 6973 5f74 312c 2073  , is_t1=is_t1, s
-00059ae0: 6570 6172 6174 6f72 3d73 6570 6172 6174  eparator=separat
-00059af0: 6f72 2c20 7665 7262 6f73 653d 7665 7262  or, verbose=verb
-00059b00: 6f73 6520 290a 2020 2020 2020 2020 2020  ose ).          
-00059b10: 2020 2020 2020 2020 2020 6966 206d 6d20            if mm 
-00059b20: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00059b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059b40: 2020 2020 2069 6620 6d6f 645f 6e61 6d65       if mod_name
-00059b50: 203d 3d20 2754 3177 4869 6572 6172 6368   == 'T1wHierarch
-00059b60: 6963 616c 273a 0a20 2020 2020 2020 2020  ical':.         
-00059b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059b80: 2020 2061 3d6c 6973 7428 2063 7376 726f     a=list( csvro
-00059b90: 772e 6b65 7973 2829 2029 0a20 2020 2020  w.keys() ).     
-00059ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059bb0: 2020 2020 2020 2062 3d6c 6973 7428 206d         b=list( m
-00059bc0: 6d2e 6b65 7973 2829 2029 0a20 2020 2020  m.keys() ).     
-00059bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059be0: 2020 2020 2020 2061 6269 6e74 6572 7365         abinterse
-00059bf0: 6374 3d6c 6973 7428 7365 7428 6229 2e69  ct=list(set(b).i
-00059c00: 6e74 6572 7365 6374 696f 6e28 2073 6574  ntersection( set
-00059c10: 2861 2920 2920 290a 2020 2020 2020 2020  (a) ) ).        
-00059c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059c30: 2020 2020 6966 206c 656e 2820 6162 696e      if len( abin
-00059c40: 7465 7273 6563 7420 2029 203e 2030 203a  tersect  ) > 0 :
-00059c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00059c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059c70: 2066 6f72 2071 7120 696e 2061 6269 6e74   for qq in abint
-00059c80: 6572 7365 6374 3a0a 2020 2020 2020 2020  ersect:.        
-00059c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059ca0: 2020 2020 2020 2020 2020 2020 6d6d 2e70              mm.p
-00059cb0: 6f70 2820 7171 2029 0a20 2020 2020 2020  op( qq ).       
-00059cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059cd0: 2023 206d 6d2e 696e 6465 783d 6373 7672   # mm.index=csvr
-00059ce0: 6f77 2e69 6e64 6578 0a20 2020 2020 2020  ow.index.       
-00059cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059d00: 2075 6964 6e61 6d65 203d 206d 6f64 5f6e   uidname = mod_n
-00059d10: 616d 6520 2b20 275f 6d6d 7769 6465 5f66  ame + '_mmwide_f
-00059d20: 696c 656e 616d 6527 0a20 2020 2020 2020  ilename'.       
-00059d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059d40: 206d 6d5b 2075 6964 6e61 6d65 205d 203d   mm[ uidname ] =
-00059d50: 2072 6f6f 7469 640a 2020 2020 2020 2020   rootid.        
-00059d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059d70: 6373 7672 6f77 3d70 642e 636f 6e63 6174  csvrow=pd.concat
-00059d80: 2820 5b63 7376 726f 772c 6d6d 5d2c 2061  ( [csvrow,mm], a
-00059d90: 7869 733d 312c 2069 676e 6f72 655f 696e  xis=1, ignore_in
-00059da0: 6465 783d 4661 6c73 6520 290a 2020 2020  dex=False ).    
-00059db0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00059dc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00059dd0: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-00059de0: 2061 6e64 2072 6570 6f72 745f 6d69 7373   and report_miss
-00059df0: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
-00059e00: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00059e10: 6e74 2820 6e72 6777 6964 6566 6e20 2b20  nt( nrgwidefn + 
-00059e20: 2220 6162 7365 6e74 2229 0a20 2020 2020  " absent").     
-00059e30: 2020 2069 6620 616c 6c64 662e 7368 6170     if alldf.shap
-00059e40: 655b 305d 203d 3d20 303a 0a20 2020 2020  e[0] == 0:.     
-00059e50: 2020 2020 2020 2061 6c6c 6466 203d 2063         alldf = c
-00059e60: 7376 726f 772e 636f 7079 2829 0a20 2020  svrow.copy().   
-00059e70: 2020 2020 2020 2020 2061 6c6c 6466 203d           alldf =
-00059e80: 2061 6c6c 6466 2e6c 6f63 5b3a 2c7e 616c   alldf.loc[:,~al
-00059e90: 6c64 662e 636f 6c75 6d6e 732e 6475 706c  ldf.columns.dupl
-00059ea0: 6963 6174 6564 2829 5d0a 2020 2020 2020  icated()].      
-00059eb0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00059ec0: 2020 2020 6373 7672 6f77 3d63 7376 726f      csvrow=csvro
-00059ed0: 772e 6c6f 635b 3a2c 7e63 7376 726f 772e  w.loc[:,~csvrow.
-00059ee0: 636f 6c75 6d6e 732e 6475 706c 6963 6174  columns.duplicat
-00059ef0: 6564 2829 5d0a 2020 2020 2020 2020 2020  ed()].          
-00059f00: 2020 616c 6c64 6620 3d20 616c 6c64 662e    alldf = alldf.
-00059f10: 6c6f 635b 3a2c 7e61 6c6c 6466 2e63 6f6c  loc[:,~alldf.col
-00059f20: 756d 6e73 2e64 7570 6c69 6361 7465 6428  umns.duplicated(
-00059f30: 295d 0a20 2020 2020 2020 2020 2020 2061  )].            a
-00059f40: 6c6c 6466 203d 2070 642e 636f 6e63 6174  lldf = pd.concat
-00059f50: 2820 5b61 6c6c 6466 2c20 6373 7672 6f77  ( [alldf, csvrow
-00059f60: 5d2c 2061 7869 733d 302c 2069 676e 6f72  ], axis=0, ignor
-00059f70: 655f 696e 6465 783d 5472 7565 2029 0a20  e_index=True ). 
-00059f80: 2020 2072 6574 7572 6e20 616c 6c64 660a     return alldf.
-00059f90: 0a64 6566 2061 7373 656d 626c 655f 6d6f  .def assemble_mo
-00059fa0: 6461 6c69 7479 5f73 7065 6369 6669 635f  dality_specific_
-00059fb0: 6461 7461 6672 616d 6573 2820 6d6d 5f77  dataframes( mm_w
-00059fc0: 6964 655f 6373 7673 2c20 6869 6572 6466  ide_csvs, hierdf
-00059fd0: 696e 2c20 6e72 675f 6d6f 6461 6c69 7479  in, nrg_modality
-00059fe0: 2c20 7365 7061 7261 746f 723d 272d 272c  , separator='-',
-00059ff0: 2070 726f 6772 6573 733d 4e6f 6e65 2c20   progress=None, 
-0005a000: 7665 7262 6f73 653d 4661 6c73 6520 293a  verbose=False ):
-0005a010: 0a20 2020 206d 6f64 6465 7273 7562 203d  .    moddersub =
-0005a020: 2072 652e 7375 6228 2022 5b2a 5d22 2c22   re.sub( "[*]","
-0005a030: 222c 6e72 675f 6d6f 6461 6c69 7479 290a  ",nrg_modality).
-0005a040: 2020 2020 6e6d 6466 3d70 642e 4461 7461      nmdf=pd.Data
-0005a050: 4672 616d 6528 290a 2020 2020 666f 7220  Frame().    for 
-0005a060: 6b20 696e 2072 616e 6765 2820 6869 6572  k in range( hier
-0005a070: 6466 696e 2e73 6861 7065 5b30 5d20 293a  dfin.shape[0] ):
-0005a080: 0a20 2020 2020 2020 2069 6620 7072 6f67  .        if prog
-0005a090: 7265 7373 2069 7320 6e6f 7420 4e6f 6e65  ress is not None
-0005a0a0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0005a0b0: 206b 2025 2070 726f 6772 6573 7320 3d3d   k % progress ==
-0005a0c0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-0005a0d0: 2020 2020 7072 6f67 6765 7220 3d20 7374      progger = st
-0005a0e0: 7228 206e 702e 726f 756e 6428 206b 202f  r( np.round( k /
-0005a0f0: 2068 6965 7264 6669 6e2e 7368 6170 655b   hierdfin.shape[
-0005a100: 305d 202a 2031 3030 2029 2029 0a20 2020  0] * 100 ) ).   
-0005a110: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0005a120: 6e74 2820 7072 6f67 6765 722c 2065 6e64  nt( progger, end
-0005a130: 203d 222e 2e2e 222c 2066 6c75 7368 3d54   ="...", flush=T
-0005a140: 7275 6529 0a20 2020 2020 2020 2074 656d  rue).        tem
-0005a150: 7020 3d20 6d6d 5f77 6964 655f 6373 7673  p = mm_wide_csvs
-0005a160: 5b6b 5d0a 2020 2020 2020 2020 6d79 7061  [k].        mypa
-0005a170: 7274 7366 203d 2074 656d 702e 7370 6c69  rtsf = temp.spli
-0005a180: 7428 2254 3177 4869 6572 6172 6368 6963  t("T1wHierarchic
-0005a190: 616c 2229 0a20 2020 2020 2020 206d 7970  al").        myp
-0005a1a0: 6172 7473 203d 206d 7970 6172 7473 665b  arts = mypartsf[
-0005a1b0: 305d 0a20 2020 2020 2020 2074 3169 6964  0].        t1iid
-0005a1c0: 203d 2073 7472 286d 7970 6172 7473 665b   = str(mypartsf[
-0005a1d0: 315d 2e73 706c 6974 2822 2f22 295b 315d  1].split("/")[1]
-0005a1e0: 290a 2020 2020 2020 2020 666e 736e 6d20  ).        fnsnm 
-0005a1f0: 3d20 676c 6f62 2e67 6c6f 6228 6d79 7061  = glob.glob(mypa
-0005a200: 7274 732b 222f 2220 2b20 6e72 675f 6d6f  rts+"/" + nrg_mo
-0005a210: 6461 6c69 7479 202b 2022 2f2a 2f2a 2220  dality + "/*/*" 
-0005a220: 2b20 7431 6969 6420 2b20 222a 7769 6465  + t1iid + "*wide
-0005a230: 2e63 7376 2229 0a20 2020 2020 2020 2069  .csv").        i
-0005a240: 6620 6c65 6e28 2066 6e73 6e6d 2029 203e  f len( fnsnm ) >
-0005a250: 2030 203a 0a20 2020 2020 2020 2020 2020   0 :.           
-0005a260: 2066 6f72 2079 2069 6e20 666e 736e 6d3a   for y in fnsnm:
-0005a270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005a280: 2074 656d 703d 7265 6164 5f6d 6d5f 6373   temp=read_mm_cs
-0005a290: 7628 2079 2c20 636f 6c70 7265 6669 783d  v( y, colprefix=
-0005a2a0: 6d6f 6464 6572 7375 622b 275f 272c 2069  moddersub+'_', i
-0005a2b0: 735f 7431 3d46 616c 7365 2c20 7365 7061  s_t1=False, sepa
-0005a2c0: 7261 746f 723d 7365 7061 7261 746f 722c  rator=separator,
-0005a2d0: 2076 6572 626f 7365 3d76 6572 626f 7365   verbose=verbose
-0005a2e0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0005a2f0: 2020 2069 6620 7465 6d70 2069 7320 6e6f     if temp is no
-0005a300: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0005a310: 2020 2020 2020 2020 2020 2020 6e6d 6466              nmdf
-0005a320: 3d70 642e 636f 6e63 6174 2820 5b6e 6d64  =pd.concat( [nmd
-0005a330: 662c 2074 656d 705d 2c20 6178 6973 3d30  f, temp], axis=0
-0005a340: 2c20 6967 6e6f 7265 5f69 6e64 6578 3d46  , ignore_index=F
-0005a350: 616c 7365 2029 0a20 2020 2072 6574 7572  alse ).    retur
-0005a360: 6e20 6e6d 6466 0a0a 6465 6620 6269 6e64  n nmdf..def bind
-0005a370: 5f77 6964 655f 6d6d 5f63 7376 7328 206d  _wide_mm_csvs( m
-0005a380: 6d5f 7769 6465 5f63 7376 732c 206d 6572  m_wide_csvs, mer
-0005a390: 6765 3d54 7275 652c 2073 6570 6172 6174  ge=True, separat
-0005a3a0: 6f72 3d27 2d27 2c20 7665 7262 6f73 6520  or='-', verbose 
-0005a3b0: 3d20 3020 2920 3a0a 2020 2020 2222 220a  = 0 ) :.    """.
-0005a3c0: 2020 2020 7769 6c6c 2063 6f6e 7665 7274      will convert
-0005a3d0: 2061 206c 6973 7420 6f66 2074 3177 2068   a list of t1w h
-0005a3e0: 6965 7261 7263 6869 6361 6c20 6373 7620  ierarchical csv 
-0005a3f0: 6669 6c65 6e61 6d65 7320 746f 2061 206d  filenames to a m
-0005a400: 6572 6765 6420 6461 7461 6672 616d 650a  erged dataframe.
-0005a410: 0a20 2020 2072 6574 7572 6e73 2061 2070  .    returns a p
-0005a420: 6169 7220 6f66 2064 6174 6120 6672 616d  air of data fram
-0005a430: 6573 2c20 7468 6520 6c65 6674 2073 6964  es, the left sid
-0005a440: 6520 6861 7669 6e67 2061 6c6c 2065 6e74  e having all ent
-0005a450: 7269 6573 2061 6e64 2074 6865 0a20 2020  ries and the.   
-0005a460: 2020 2020 2072 6967 6874 2073 6964 6520       right side 
-0005a470: 6861 7669 6e67 2072 6f77 2061 7665 7261  having row avera
-0005a480: 6765 6420 656e 7472 6965 7320 692e 652e  ged entries i.e.
-0005a490: 2075 6e69 7175 6520 7661 6c75 6573 2066   unique values f
-0005a4a0: 6f72 2065 6163 6820 7669 7369 740a 0a20  or each visit.. 
-0005a4b0: 2020 2073 6574 206d 6572 6765 2074 6f20     set merge to 
-0005a4c0: 4661 6c73 6520 746f 2072 6574 7572 6e20  False to return 
-0005a4d0: 696e 6469 7669 6475 616c 2064 6174 6166  individual dataf
-0005a4e0: 7261 6d65 7320 2820 666f 7220 6465 6275  rames ( for debu
-0005a4f0: 6767 696e 6720 290a 0a20 2020 2072 6574  gging )..    ret
-0005a500: 7572 6e20 616c 6c64 6174 612c 2072 6f77  urn alldata, row
-0005a510: 5f61 7665 7261 6765 645f 6461 7461 0a20  _averaged_data. 
-0005a520: 2020 2022 2222 0a20 2020 206d 6d5f 7769     """.    mm_wi
-0005a530: 6465 5f63 7376 732e 736f 7274 2829 0a20  de_csvs.sort(). 
-0005a540: 2020 2069 6620 6e6f 7420 6d6d 5f77 6964     if not mm_wid
-0005a550: 655f 6373 7673 3a0a 2020 2020 2020 2020  e_csvs:.        
-0005a560: 7072 696e 7428 224e 6f20 6669 6c65 7320  print("No files 
-0005a570: 666f 756e 6420 7769 7468 2073 7065 6369  found with speci
-0005a580: 6669 6564 2070 6174 7465 726e 2229 0a20  fied pattern"). 
-0005a590: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-0005a5a0: 2020 2320 312e 2072 6f77 2d62 696e 6420    # 1. row-bind 
-0005a5b0: 7468 6520 7431 7768 6965 7220 6461 7461  the t1whier data
-0005a5c0: 0a20 2020 2023 2032 2e20 7361 6d65 2066  .    # 2. same f
-0005a5d0: 6f72 2065 6163 6820 6f74 6865 7220 6d6f  or each other mo
-0005a5e0: 6461 6c69 7479 0a20 2020 2023 2033 2e20  dality.    # 3. 
-0005a5f0: 6d65 7267 6520 7468 6520 6d6f 6461 6c69  merge the modali
-0005a600: 7469 6573 2062 7920 7468 6520 6b65 7973  ties by the keys
-0005a610: 0a20 2020 2068 6965 7264 6620 3d20 7064  .    hierdf = pd
-0005a620: 2e44 6174 6146 7261 6d65 2829 0a20 2020  .DataFrame().   
-0005a630: 2066 6f72 2079 2069 6e20 6d6d 5f77 6964   for y in mm_wid
-0005a640: 655f 6373 7673 3a0a 2020 2020 2020 2020  e_csvs:.        
-0005a650: 7465 6d70 3d72 6561 645f 6d6d 5f63 7376  temp=read_mm_csv
-0005a660: 2820 792c 2063 6f6c 7072 6566 6978 3d27  ( y, colprefix='
-0005a670: 5431 4869 6572 5f27 2c20 7365 7061 7261  T1Hier_', separa
-0005a680: 746f 723d 7365 7061 7261 746f 722c 2069  tor=separator, i
-0005a690: 735f 7431 3d54 7275 6520 290a 2020 2020  s_t1=True ).    
-0005a6a0: 2020 2020 6966 2074 656d 7020 6973 206e      if temp is n
-0005a6b0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0005a6c0: 2020 2020 2068 6965 7264 663d 7064 2e63       hierdf=pd.c
-0005a6d0: 6f6e 6361 7428 205b 6869 6572 6466 2c20  oncat( [hierdf, 
-0005a6e0: 7465 6d70 5d2c 2061 7869 733d 302c 2069  temp], axis=0, i
-0005a6f0: 676e 6f72 655f 696e 6465 783d 4661 6c73  gnore_index=Fals
-0005a700: 6520 290a 2020 2020 6966 2076 6572 626f  e ).    if verbo
-0005a710: 7365 203e 2030 3a0a 2020 2020 2020 2020  se > 0:.        
-0005a720: 6d79 7072 6f3d 3530 0a20 2020 2065 6c73  mypro=50.    els
-0005a730: 653a 0a20 2020 2020 2020 206d 7970 726f  e:.        mypro
-0005a740: 3d4e 6f6e 650a 2020 2020 6966 2076 6572  =None.    if ver
-0005a750: 626f 7365 203e 2030 3a0a 2020 2020 2020  bose > 0:.      
-0005a760: 2020 7072 696e 7428 2274 6869 636b 6e65    print("thickne
-0005a770: 7373 2229 0a20 2020 2074 686b 6466 203d  ss").    thkdf =
-0005a780: 2061 7373 656d 626c 655f 6d6f 6461 6c69   assemble_modali
-0005a790: 7479 5f73 7065 6369 6669 635f 6461 7461  ty_specific_data
-0005a7a0: 6672 616d 6573 2820 6d6d 5f77 6964 655f  frames( mm_wide_
-0005a7b0: 6373 7673 2c20 6869 6572 6466 2c20 2754  csvs, hierdf, 'T
-0005a7c0: 3177 272c 2070 726f 6772 6573 733d 6d79  1w', progress=my
-0005a7d0: 7072 6f2c 2076 6572 626f 7365 3d76 6572  pro, verbose=ver
-0005a7e0: 626f 7365 3d3d 3229 0a20 2020 2069 6620  bose==2).    if 
-0005a7f0: 7665 7262 6f73 6520 3e20 303a 0a20 2020  verbose > 0:.   
-0005a800: 2020 2020 2070 7269 6e74 2822 666c 6169       print("flai
-0005a810: 7222 290a 2020 2020 666c 6169 7264 6620  r").    flairdf 
-0005a820: 3d20 6173 7365 6d62 6c65 5f6d 6f64 616c  = assemble_modal
-0005a830: 6974 795f 7370 6563 6966 6963 5f64 6174  ity_specific_dat
-0005a840: 6166 7261 6d65 7328 206d 6d5f 7769 6465  aframes( mm_wide
-0005a850: 5f63 7376 732c 2068 6965 7264 662c 2027  _csvs, hierdf, '
-0005a860: 5432 466c 6169 7227 2c20 7072 6f67 7265  T2Flair', progre
-0005a870: 7373 3d6d 7970 726f 2c20 7665 7262 6f73  ss=mypro, verbos
-0005a880: 653d 7665 7262 6f73 653d 3d32 290a 2020  e=verbose==2).  
-0005a890: 2020 6966 2076 6572 626f 7365 203e 2030    if verbose > 0
-0005a8a0: 3a0a 2020 2020 2020 2020 7072 696e 7428  :.        print(
-0005a8b0: 224e 4d22 290a 2020 2020 6e6d 6466 203d  "NM").    nmdf =
-0005a8c0: 2061 7373 656d 626c 655f 6d6f 6461 6c69   assemble_modali
-0005a8d0: 7479 5f73 7065 6369 6669 635f 6461 7461  ty_specific_data
-0005a8e0: 6672 616d 6573 2820 6d6d 5f77 6964 655f  frames( mm_wide_
-0005a8f0: 6373 7673 2c20 6869 6572 6466 2c20 274e  csvs, hierdf, 'N
-0005a900: 4d32 444d 5427 2c20 7072 6f67 7265 7373  M2DMT', progress
-0005a910: 3d6d 7970 726f 2c20 7665 7262 6f73 653d  =mypro, verbose=
-0005a920: 7665 7262 6f73 653d 3d32 290a 2020 2020  verbose==2).    
-0005a930: 6966 2076 6572 626f 7365 203e 2030 3a0a  if verbose > 0:.
-0005a940: 2020 2020 2020 2020 7072 696e 7428 2272          print("r
-0005a950: 7366 2229 0a20 2020 2072 7366 6466 203d  sf").    rsfdf =
-0005a960: 2061 7373 656d 626c 655f 6d6f 6461 6c69   assemble_modali
-0005a970: 7479 5f73 7065 6369 6669 635f 6461 7461  ty_specific_data
-0005a980: 6672 616d 6573 2820 6d6d 5f77 6964 655f  frames( mm_wide_
-0005a990: 6373 7673 2c20 6869 6572 6466 2c20 2772  csvs, hierdf, 'r
-0005a9a0: 7366 4d52 492a 272c 2070 726f 6772 6573  sfMRI*', progres
-0005a9b0: 733d 6d79 7072 6f2c 2076 6572 626f 7365  s=mypro, verbose
-0005a9c0: 3d76 6572 626f 7365 3d3d 3229 0a20 2020  =verbose==2).   
-0005a9d0: 2069 6620 7665 7262 6f73 6520 3e20 303a   if verbose > 0:
-0005a9e0: 0a20 2020 2020 2020 2070 7269 6e74 2822  .        print("
-0005a9f0: 6474 6922 290a 2020 2020 6474 6964 6620  dti").    dtidf 
-0005aa00: 3d20 6173 7365 6d62 6c65 5f6d 6f64 616c  = assemble_modal
-0005aa10: 6974 795f 7370 6563 6966 6963 5f64 6174  ity_specific_dat
-0005aa20: 6166 7261 6d65 7328 206d 6d5f 7769 6465  aframes( mm_wide
-0005aa30: 5f63 7376 732c 2068 6965 7264 662c 2027  _csvs, hierdf, '
-0005aa40: 4454 492a 272c 2070 726f 6772 6573 733d  DTI*', progress=
-0005aa50: 6d79 7072 6f2c 2076 6572 626f 7365 3d76  mypro, verbose=v
-0005aa60: 6572 626f 7365 3d3d 3220 290a 2020 2020  erbose==2 ).    
-0005aa70: 6966 206e 6f74 206d 6572 6765 3a0a 2020  if not merge:.  
-0005aa80: 2020 2020 2020 7265 7475 726e 2068 6965        return hie
-0005aa90: 7264 662c 2074 686b 6466 2c20 666c 6169  rdf, thkdf, flai
-0005aaa0: 7264 662c 206e 6d64 662c 2072 7366 6466  rdf, nmdf, rsfdf
-0005aab0: 2c20 6474 6964 660a 2020 2020 6869 6572  , dtidf.    hier
-0005aac0: 6466 6d69 7820 3d20 6869 6572 6466 2e63  dfmix = hierdf.c
-0005aad0: 6f70 7928 290a 2020 2020 6d6f 6461 6c69  opy().    modali
-0005aae0: 7479 5f64 665f 7375 6666 6978 6573 203d  ty_df_suffixes =
-0005aaf0: 205b 0a20 2020 2020 2020 2028 7468 6b64   [.        (thkd
-0005ab00: 662c 2022 5f74 686b 2229 2c0a 2020 2020  f, "_thk"),.    
-0005ab10: 2020 2020 2866 6c61 6972 6466 2c20 225f      (flairdf, "_
-0005ab20: 666c 6169 7222 292c 0a20 2020 2020 2020  flair"),.       
-0005ab30: 2028 6e6d 6466 2c20 225f 6e6d 2229 2c0a   (nmdf, "_nm"),.
-0005ab40: 2020 2020 2020 2020 2872 7366 6466 2c20          (rsfdf, 
-0005ab50: 225f 7273 6622 292c 0a20 2020 2020 2020  "_rsf"),.       
-0005ab60: 2028 6474 6964 662c 2022 5f64 7469 2229   (dtidf, "_dti")
-0005ab70: 2c0a 2020 2020 5d0a 2020 2020 666f 7220  ,.    ].    for 
-0005ab80: 7061 6972 2069 6e20 6d6f 6461 6c69 7479  pair in modality
-0005ab90: 5f64 665f 7375 6666 6978 6573 3a0a 2020  _df_suffixes:.  
-0005aba0: 2020 2020 2020 6869 6572 6466 6d69 7820        hierdfmix 
-0005abb0: 3d20 6d65 7267 655f 6d6d 5f64 6174 6166  = merge_mm_dataf
-0005abc0: 7261 6d65 2868 6965 7264 666d 6978 2c20  rame(hierdfmix, 
-0005abd0: 7061 6972 5b30 5d2c 2070 6169 725b 315d  pair[0], pair[1]
-0005abe0: 290a 2020 2020 6869 6572 6466 6d69 7820  ).    hierdfmix 
-0005abf0: 3d20 6869 6572 6466 6d69 782e 7265 706c  = hierdfmix.repl
-0005ac00: 6163 6528 7227 5e5c 732a 2427 2c20 6e70  ace(r'^\s*$', np
-0005ac10: 2e6e 616e 2c20 7265 6765 783d 5472 7565  .nan, regex=True
-0005ac20: 290a 2020 2020 7265 7475 726e 2068 6965  ).    return hie
-0005ac30: 7264 666d 6978 2c20 6869 6572 6466 6d69  rdfmix, hierdfmi
-0005ac40: 782e 6772 6f75 7062 7928 2275 5f68 6965  x.groupby("u_hie
-0005ac50: 725f 6964 222c 2061 735f 696e 6465 783d  r_id", as_index=
-0005ac60: 4661 6c73 6529 2e6d 6561 6e28 6e75 6d65  False).mean(nume
-0005ac70: 7269 635f 6f6e 6c79 3d54 7275 6529 0a0a  ric_only=True)..
-0005ac80: 6465 6620 6d65 7267 655f 6d6d 5f64 6174  def merge_mm_dat
-0005ac90: 6166 7261 6d65 2868 6965 7264 662c 206d  aframe(hierdf, m
-0005aca0: 6d64 662c 206d 6d5f 7375 6666 6978 293a  mdf, mm_suffix):
-0005acb0: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
-0005acc0: 2020 6869 6572 6466 203d 2068 6965 7264    hierdf = hierd
-0005acd0: 662e 6d65 7267 6528 6d6d 6466 2c20 6f6e  f.merge(mmdf, on
-0005ace0: 3d5b 2773 6964 272c 2027 7669 7369 7464  =['sid', 'visitd
-0005acf0: 6174 6527 2c20 2774 3169 6d61 6765 7569  ate', 't1imageui
-0005ad00: 6427 5d2c 2073 7566 6669 7865 733d 2822  d'], suffixes=("
-0005ad10: 222c 6d6d 5f73 7566 6669 7829 2c68 6f77  ",mm_suffix),how
-0005ad20: 3d27 6c65 6674 2729 0a20 2020 2020 2020  ='left').       
-0005ad30: 2072 6574 7572 6e20 6869 6572 6466 0a20   return hierdf. 
-0005ad40: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
-0005ad50: 6f72 3a0a 2020 2020 2020 2020 7265 7475  or:.        retu
-0005ad60: 726e 2068 6965 7264 660a 0a64 6566 2061  rn hierdf..def a
-0005ad70: 7567 6d65 6e74 5f69 6d61 6765 2820 782c  ugment_image( x,
-0005ad80: 2020 6d61 785f 726f 743d 3130 2c20 6e7a    max_rot=10, nz
-0005ad90: 7364 3d31 2029 3a0a 2020 2020 7252 6f74  sd=1 ):.    rRot
-0005ada0: 4765 6e65 7261 746f 7220 3d20 616e 7473  Generator = ants
-0005adb0: 2e63 6f6e 7472 6962 2e52 616e 646f 6d52  .contrib.RandomR
-0005adc0: 6f74 6174 6533 4428 2028 206d 6178 5f72  otate3D( ( max_r
-0005add0: 6f74 2a28 2d31 2e30 292c 206d 6178 5f72  ot*(-1.0), max_r
-0005ade0: 6f74 2029 2c20 7265 6665 7265 6e63 653d  ot ), reference=
-0005adf0: 7820 290a 2020 2020 7478 203d 2072 526f  x ).    tx = rRo
-0005ae00: 7447 656e 6572 6174 6f72 2e74 7261 6e73  tGenerator.trans
-0005ae10: 666f 726d 2829 0a20 2020 2069 7478 203d  form().    itx =
-0005ae20: 2061 6e74 732e 696e 7665 7274 5f61 6e74   ants.invert_ant
-0005ae30: 735f 7472 616e 7366 6f72 6d28 7478 290a  s_transform(tx).
-0005ae40: 2020 2020 7920 3d20 616e 7473 2e61 7070      y = ants.app
-0005ae50: 6c79 5f61 6e74 735f 7472 616e 7366 6f72  ly_ants_transfor
-0005ae60: 6d5f 746f 5f69 6d61 6765 2820 7478 2c20  m_to_image( tx, 
-0005ae70: 782c 2078 2c20 696e 7465 7270 6f6c 6174  x, x, interpolat
-0005ae80: 696f 6e3d 276c 696e 6561 7227 290a 2020  ion='linear').  
-0005ae90: 2020 7920 3d20 616e 7473 2e61 6464 5f6e    y = ants.add_n
-0005aea0: 6f69 7365 5f74 6f5f 696d 6167 6528 2079  oise_to_image( y
-0005aeb0: 2c27 6164 6469 7469 7665 6761 7573 7369  ,'additivegaussi
-0005aec0: 616e 272c 205b 302c 6e7a 7364 5d20 290a  an', [0,nzsd] ).
-0005aed0: 2020 2020 7265 7475 726e 2079 2c20 7478      return y, tx
-0005aee0: 2c20 6974 780a 0a64 6566 2062 6f6f 745f  , itx..def boot_
-0005aef0: 776d 6828 2066 6c61 6972 2c20 7431 2c20  wmh( flair, t1, 
-0005af00: 7431 7365 672c 206d 6d66 726f 6d63 6f6e  t1seg, mmfromcon
-0005af10: 7665 7868 756c 6c20 3d20 302e 302c 2073  vexhull = 0.0, s
-0005af20: 7472 6963 743d 5472 7565 2c0a 2020 2020  trict=True,.    
-0005af30: 2020 2020 7072 6f62 6162 696c 6974 795f      probability_
-0005af40: 6d61 736b 3d4e 6f6e 652c 2070 7269 6f72  mask=None, prior
-0005af50: 5f70 726f 6261 6269 6c69 7479 3d4e 6f6e  _probability=Non
-0005af60: 652c 206e 5f73 696d 756c 6174 696f 6e73  e, n_simulations
-0005af70: 3d31 362c 0a20 2020 2020 2020 2076 6572  =16,.        ver
-0005af80: 626f 7365 3d46 616c 7365 2029 203a 0a20  bose=False ) :. 
-0005af90: 2020 2069 6620 7665 7262 6f73 6520 616e     if verbose an
-0005afa0: 6420 7072 696f 725f 7072 6f62 6162 696c  d prior_probabil
-0005afb0: 6974 7920 6973 204e 6f6e 653a 0a20 2020  ity is None:.   
-0005afc0: 2020 2020 2070 7269 6e74 2822 6175 676d       print("augm
-0005afd0: 656e 7465 6420 666c 6169 7222 290a 2020  ented flair").  
-0005afe0: 2020 6966 2076 6572 626f 7365 2061 6e64    if verbose and
-0005aff0: 2070 7269 6f72 5f70 726f 6261 6269 6c69   prior_probabili
-0005b000: 7479 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ty is not None:.
-0005b010: 2020 2020 2020 2020 7072 696e 7428 2261          print("a
-0005b020: 7567 6d65 6e74 6564 2066 6c61 6972 2077  ugmented flair w
-0005b030: 6974 6820 7072 696f 7222 290a 2020 2020  ith prior").    
-0005b040: 776d 685f 7375 6d5f 6175 6720 3d20 300a  wmh_sum_aug = 0.
-0005b050: 2020 2020 776d 685f 7375 6d5f 7072 696f      wmh_sum_prio
-0005b060: 725f 6175 6720 3d20 300a 2020 2020 6175  r_aug = 0.    au
-0005b070: 6770 726f 6220 3d20 666c 6169 7220 2a20  gprob = flair * 
-0005b080: 302e 300a 2020 2020 6175 6770 726f 625f  0.0.    augprob_
-0005b090: 7072 696f 7220 3d20 4e6f 6e65 0a20 2020  prior = None.   
-0005b0a0: 2069 6620 7072 696f 725f 7072 6f62 6162   if prior_probab
-0005b0b0: 696c 6974 7920 6973 206e 6f74 204e 6f6e  ility is not Non
-0005b0c0: 653a 0a20 2020 2020 2020 2061 7567 7072  e:.        augpr
-0005b0d0: 6f62 5f70 7269 6f72 203d 2066 6c61 6972  ob_prior = flair
-0005b0e0: 202a 2030 2e30 0a20 2020 2066 6f72 206e   * 0.0.    for n
-0005b0f0: 2069 6e20 7261 6e67 6528 6e5f 7369 6d75   in range(n_simu
-0005b100: 6c61 7469 6f6e 7329 3a0a 2020 2020 2020  lations):.      
-0005b110: 2020 6175 6766 6c61 6972 2c20 7478 2c20    augflair, tx, 
-0005b120: 6974 7820 3d20 6175 676d 656e 745f 696d  itx = augment_im
-0005b130: 6167 6528 2061 6e74 732e 694d 6174 6828  age( ants.iMath(
-0005b140: 666c 6169 722c 224e 6f72 6d61 6c69 7a65  flair,"Normalize
-0005b150: 2229 2c20 352c 2030 2e30 3120 290a 2020  "), 5, 0.01 ).  
-0005b160: 2020 2020 2020 6c6f 6377 6d68 203d 2077        locwmh = w
-0005b170: 6d68 2820 6175 6766 6c61 6972 2c20 7431  mh( augflair, t1
-0005b180: 2c20 7431 7365 672c 206d 6d66 726f 6d63  , t1seg, mmfromc
-0005b190: 6f6e 7665 7868 756c 6c20 3d20 6d6d 6672  onvexhull = mmfr
-0005b1a0: 6f6d 636f 6e76 6578 6875 6c6c 2c0a 2020  omconvexhull,.  
-0005b1b0: 2020 2020 2020 2020 2020 7374 7269 6374            strict
-0005b1c0: 3d73 7472 6963 742c 2070 726f 6261 6269  =strict, probabi
-0005b1d0: 6c69 7479 5f6d 6173 6b3d 4e6f 6e65 2c20  lity_mask=None, 
-0005b1e0: 7072 696f 725f 7072 6f62 6162 696c 6974  prior_probabilit
-0005b1f0: 793d 7072 696f 725f 7072 6f62 6162 696c  y=prior_probabil
-0005b200: 6974 7920 290a 2020 2020 2020 2020 6966  ity ).        if
-0005b210: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-0005b220: 2020 2020 2020 7072 696e 7428 2022 666c        print( "fl
-0005b230: 6169 7220 7369 6d3a 2022 202b 2073 7472  air sim: " + str
-0005b240: 286e 2920 2b20 2220 766f 6c3a 2022 202b  (n) + " vol: " +
-0005b250: 2073 7472 2820 6c6f 6377 6d68 5b27 776d   str( locwmh['wm
-0005b260: 685f 6d61 7373 275d 2029 2b20 2220 766f  h_mass'] )+ " vo
-0005b270: 6c2d 7072 696f 723a 2022 202b 2073 7472  l-prior: " + str
-0005b280: 2820 6c6f 6377 6d68 5b27 776d 685f 6d61  ( locwmh['wmh_ma
-0005b290: 7373 5f70 7269 6f72 275d 2029 2b20 2220  ss_prior'] )+ " 
-0005b2a0: 736e 723a 2022 202b 2073 7472 2820 6c6f  snr: " + str( lo
-0005b2b0: 6377 6d68 5b27 776d 685f 534e 5227 5d20  cwmh['wmh_SNR'] 
-0005b2c0: 2920 290a 2020 2020 2020 2020 776d 685f  ) ).        wmh_
-0005b2d0: 7375 6d5f 6175 6720 3d20 776d 685f 7375  sum_aug = wmh_su
-0005b2e0: 6d5f 6175 6720 2b20 6c6f 6377 6d68 5b27  m_aug + locwmh['
-0005b2f0: 776d 685f 6d61 7373 275d 0a20 2020 2020  wmh_mass'].     
-0005b300: 2020 2077 6d68 5f73 756d 5f70 7269 6f72     wmh_sum_prior
-0005b310: 5f61 7567 203d 2077 6d68 5f73 756d 5f70  _aug = wmh_sum_p
-0005b320: 7269 6f72 5f61 7567 202b 206c 6f63 776d  rior_aug + locwm
-0005b330: 685b 2777 6d68 5f6d 6173 735f 7072 696f  h['wmh_mass_prio
-0005b340: 7227 5d0a 2020 2020 2020 2020 7465 6d70  r'].        temp
-0005b350: 203d 206c 6f63 776d 685b 2757 4d48 5f70   = locwmh['WMH_p
-0005b360: 726f 6261 6269 6c69 7479 5f6d 6170 275d  robability_map']
-0005b370: 0a20 2020 2020 2020 2061 7567 7072 6f62  .        augprob
-0005b380: 203d 2061 7567 7072 6f62 202b 2061 6e74   = augprob + ant
-0005b390: 732e 6170 706c 795f 616e 7473 5f74 7261  s.apply_ants_tra
-0005b3a0: 6e73 666f 726d 5f74 6f5f 696d 6167 6528  nsform_to_image(
-0005b3b0: 2069 7478 2c20 7465 6d70 2c20 666c 6169   itx, temp, flai
-0005b3c0: 722c 2069 6e74 6572 706f 6c61 7469 6f6e  r, interpolation
-0005b3d0: 3d27 6c69 6e65 6172 2729 0a20 2020 2020  ='linear').     
-0005b3e0: 2020 2069 6620 7072 696f 725f 7072 6f62     if prior_prob
-0005b3f0: 6162 696c 6974 7920 6973 206e 6f74 204e  ability is not N
-0005b400: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0005b410: 2074 656d 7020 3d20 6c6f 6377 6d68 5b27   temp = locwmh['
-0005b420: 574d 485f 706f 7374 6572 696f 725f 7072  WMH_posterior_pr
-0005b430: 6f62 6162 696c 6974 795f 6d61 7027 5d0a  obability_map'].
-0005b440: 2020 2020 2020 2020 2020 2020 6175 6770              augp
-0005b450: 726f 625f 7072 696f 7220 3d20 6175 6770  rob_prior = augp
-0005b460: 726f 625f 7072 696f 7220 2b20 616e 7473  rob_prior + ants
-0005b470: 2e61 7070 6c79 5f61 6e74 735f 7472 616e  .apply_ants_tran
-0005b480: 7366 6f72 6d5f 746f 5f69 6d61 6765 2820  sform_to_image( 
-0005b490: 6974 782c 2074 656d 702c 2066 6c61 6972  itx, temp, flair
-0005b4a0: 2c20 696e 7465 7270 6f6c 6174 696f 6e3d  , interpolation=
-0005b4b0: 276c 696e 6561 7227 290a 2020 2020 6175  'linear').    au
-0005b4c0: 6770 726f 6220 3d20 6175 6770 726f 6220  gprob = augprob 
-0005b4d0: 2a20 2831 2e30 2f66 6c6f 6174 2820 6e5f  * (1.0/float( n_
-0005b4e0: 7369 6d75 6c61 7469 6f6e 7320 2929 0a20  simulations )). 
-0005b4f0: 2020 2069 6620 7072 696f 725f 7072 6f62     if prior_prob
-0005b500: 6162 696c 6974 7920 6973 206e 6f74 204e  ability is not N
-0005b510: 6f6e 653a 0a20 2020 2020 2020 2061 7567  one:.        aug
-0005b520: 7072 6f62 5f70 7269 6f72 203d 2061 7567  prob_prior = aug
-0005b530: 7072 6f62 5f70 7269 6f72 202a 2028 312e  prob_prior * (1.
-0005b540: 302f 666c 6f61 7428 206e 5f73 696d 756c  0/float( n_simul
-0005b550: 6174 696f 6e73 2029 290a 2020 2020 776d  ations )).    wm
-0005b560: 685f 7375 6d5f 6175 6720 3d20 776d 685f  h_sum_aug = wmh_
-0005b570: 7375 6d5f 6175 6720 2f20 666c 6f61 7428  sum_aug / float(
-0005b580: 206e 5f73 696d 756c 6174 696f 6e73 2029   n_simulations )
-0005b590: 0a20 2020 2077 6d68 5f73 756d 5f70 7269  .    wmh_sum_pri
-0005b5a0: 6f72 5f61 7567 203d 2077 6d68 5f73 756d  or_aug = wmh_sum
-0005b5b0: 5f70 7269 6f72 5f61 7567 202f 2066 6c6f  _prior_aug / flo
-0005b5c0: 6174 2820 6e5f 7369 6d75 6c61 7469 6f6e  at( n_simulation
-0005b5d0: 7320 290a 2020 2020 7265 7475 726e 7b0a  s ).    return{.
-0005b5e0: 2020 2020 2020 2766 6c61 6972 2720 3a20        'flair' : 
-0005b5f0: 616e 7473 2e69 4d61 7468 2866 6c61 6972  ants.iMath(flair
-0005b600: 2c22 4e6f 726d 616c 697a 6522 292c 0a20  ,"Normalize"),. 
-0005b610: 2020 2020 2027 574d 485f 7072 6f62 6162       'WMH_probab
-0005b620: 696c 6974 795f 6d61 7027 203a 2061 7567  ility_map' : aug
-0005b630: 7072 6f62 2c0a 2020 2020 2020 2757 4d48  prob,.      'WMH
-0005b640: 5f70 6f73 7465 7269 6f72 5f70 726f 6261  _posterior_proba
-0005b650: 6269 6c69 7479 5f6d 6170 2720 3a20 6175  bility_map' : au
-0005b660: 6770 726f 625f 7072 696f 722c 0a20 2020  gprob_prior,.   
-0005b670: 2020 2027 776d 685f 6d61 7373 273a 2077     'wmh_mass': w
-0005b680: 6d68 5f73 756d 5f61 7567 2c0a 2020 2020  mh_sum_aug,.    
-0005b690: 2020 2777 6d68 5f6d 6173 735f 7072 696f    'wmh_mass_prio
-0005b6a0: 7227 3a20 776d 685f 7375 6d5f 7072 696f  r': wmh_sum_prio
-0005b6b0: 725f 6175 672c 0a20 2020 2020 2027 776d  r_aug,.      'wm
-0005b6c0: 685f 6576 7227 3a20 6c6f 6377 6d68 5b27  h_evr': locwmh['
-0005b6d0: 776d 685f 6576 7227 5d2c 0a20 2020 2020  wmh_evr'],.     
-0005b6e0: 2027 776d 685f 534e 5227 3a20 6c6f 6377   'wmh_SNR': locw
-0005b6f0: 6d68 5b27 776d 685f 534e 5227 5d20 207d  mh['wmh_SNR']  }
-0005b700: 0a0a 0a64 6566 2074 6872 6561 6465 645f  ...def threaded_
-0005b710: 6269 6e64 5f77 6964 655f 6d6d 5f63 7376  bind_wide_mm_csv
-0005b720: 7328 206d 6d5f 7769 6465 5f63 7376 732c  s( mm_wide_csvs,
-0005b730: 206e 5f77 6f72 6b65 7273 2029 3a0a 2020   n_workers ):.  
-0005b740: 2020 6672 6f6d 2063 6f6e 6375 7272 656e    from concurren
-0005b750: 742e 6675 7475 7265 7320 696d 706f 7274  t.futures import
-0005b760: 2061 735f 636f 6d70 6c65 7465 640a 2020   as_completed.  
-0005b770: 2020 6672 6f6d 2063 6f6e 6375 7272 656e    from concurren
-0005b780: 7420 696d 706f 7274 2066 7574 7572 6573  t import futures
-0005b790: 0a20 2020 2069 6d70 6f72 7420 636f 6e63  .    import conc
-0005b7a0: 7572 7265 6e74 2e66 7574 7572 6573 0a20  urrent.futures. 
-0005b7b0: 2020 2064 6566 2063 6875 6e6b 7328 6c2c     def chunks(l,
-0005b7c0: 206e 293a 0a20 2020 2020 2020 2022 2222   n):.        """
-0005b7d0: 5969 656c 6420 6e20 6e75 6d62 6572 206f  Yield n number o
-0005b7e0: 6620 7365 7175 656e 7469 616c 2063 6875  f sequential chu
-0005b7f0: 6e6b 7320 6672 6f6d 206c 2e22 2222 0a20  nks from l.""". 
-0005b800: 2020 2020 2020 2064 2c20 7220 3d20 6469         d, r = di
-0005b810: 766d 6f64 286c 656e 286c 292c 206e 290a  vmod(len(l), n).
-0005b820: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
-0005b830: 2072 616e 6765 286e 293a 0a20 2020 2020   range(n):.     
-0005b840: 2020 2020 2020 2073 6920 3d20 2864 2b31         si = (d+1
-0005b850: 292a 2869 2069 6620 6920 3c20 7220 656c  )*(i if i < r el
-0005b860: 7365 2072 2920 2b20 642a 2830 2069 6620  se r) + d*(0 if 
-0005b870: 6920 3c20 7220 656c 7365 2069 202d 2072  i < r else i - r
-0005b880: 290a 2020 2020 2020 2020 2020 2020 7969  ).            yi
-0005b890: 656c 6420 6c5b 7369 3a73 692b 2864 2b31  eld l[si:si+(d+1
-0005b8a0: 2069 6620 6920 3c20 7220 656c 7365 2064   if i < r else d
-0005b8b0: 295d 0a20 2020 2069 6d70 6f72 7420 6e75  )].    import nu
-0005b8c0: 6d70 7920 6173 206e 700a 2020 2020 6e65  mpy as np.    ne
-0005b8d0: 7778 203d 206c 6973 7428 2063 6875 6e6b  wx = list( chunk
-0005b8e0: 7328 206d 6d5f 7769 6465 5f63 7376 732c  s( mm_wide_csvs,
-0005b8f0: 206e 5f77 6f72 6b65 7273 2029 2029 0a20   n_workers ) ). 
-0005b900: 2020 2069 6d70 6f72 7420 7061 6e64 6173     import pandas
-0005b910: 2061 7320 7064 0a20 2020 2061 6c6c 6466   as pd.    alldf
-0005b920: 203d 2070 642e 4461 7461 4672 616d 6528   = pd.DataFrame(
-0005b930: 290a 2020 2020 616c 6c64 6661 7667 203d  ).    alldfavg =
-0005b940: 2070 642e 4461 7461 4672 616d 6528 290a   pd.DataFrame().
-0005b950: 2020 2020 7769 7468 2066 7574 7572 6573      with futures
-0005b960: 2e54 6872 6561 6450 6f6f 6c45 7865 6375  .ThreadPoolExecu
-0005b970: 746f 7228 6d61 785f 776f 726b 6572 733d  tor(max_workers=
-0005b980: 6e5f 776f 726b 6572 7329 2061 7320 6578  n_workers) as ex
-0005b990: 6563 7574 6f72 3a0a 2020 2020 2020 2020  ecutor:.        
-0005b9a0: 746f 5f64 6f20 3d20 5b5d 0a20 2020 2020  to_do = [].     
-0005b9b0: 2020 2066 6f72 2067 726f 7570 2069 6e20     for group in 
-0005b9c0: 7261 6e67 6528 6c65 6e28 6e65 7778 2929  range(len(newx))
-0005b9d0: 203a 0a20 2020 2020 2020 2020 2020 2066   :.            f
-0005b9e0: 7574 7572 6520 3d20 6578 6563 7574 6f72  uture = executor
-0005b9f0: 2e73 7562 6d69 7428 6269 6e64 5f77 6964  .submit(bind_wid
-0005ba00: 655f 6d6d 5f63 7376 732c 206e 6577 785b  e_mm_csvs, newx[
-0005ba10: 6772 6f75 705d 2029 0a20 2020 2020 2020  group] ).       
-0005ba20: 2020 2020 2074 6f5f 646f 2e61 7070 656e       to_do.appen
-0005ba30: 6428 6675 7475 7265 290a 2020 2020 2020  d(future).      
-0005ba40: 2020 7265 7375 6c74 7320 3d20 5b5d 0a20    results = []. 
-0005ba50: 2020 2020 2020 2066 6f72 2066 7574 7572         for futur
-0005ba60: 6520 696e 2066 7574 7572 6573 2e61 735f  e in futures.as_
-0005ba70: 636f 6d70 6c65 7465 6428 746f 5f64 6f29  completed(to_do)
-0005ba80: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0005ba90: 7330 2c20 7265 7331 203d 2066 7574 7572  s0, res1 = futur
-0005baa0: 652e 7265 7375 6c74 2829 0a20 2020 2020  e.result().     
-0005bab0: 2020 2020 2020 2061 6c6c 6466 3d70 642e         alldf=pd.
-0005bac0: 636f 6e63 6174 2820 205b 616c 6c64 662c  concat(  [alldf,
-0005bad0: 2072 6573 3020 5d2c 2061 7869 733d 302c   res0 ], axis=0,
-0005bae0: 2069 676e 6f72 655f 696e 6465 783d 4661   ignore_index=Fa
-0005baf0: 6c73 6520 290a 2020 2020 2020 2020 2020  lse ).          
-0005bb00: 2020 616c 6c64 6661 7667 3d70 642e 636f    alldfavg=pd.co
-0005bb10: 6e63 6174 2820 205b 616c 6c64 6661 7667  ncat(  [alldfavg
-0005bb20: 2c20 7265 7331 205d 2c20 6178 6973 3d30  , res1 ], axis=0
-0005bb30: 2c20 6967 6e6f 7265 5f69 6e64 6578 3d46  , ignore_index=F
-0005bb40: 616c 7365 2029 0a20 2020 2072 6574 7572  alse ).    retur
-0005bb50: 6e20 616c 6c64 662c 2061 6c6c 6466 6176  n alldf, alldfav
-0005bb60: 670a 0a0a 6465 6620 6765 745f 6e61 6d65  g...def get_name
-0005bb70: 735f 6672 6f6d 5f64 6174 615f 6672 616d  s_from_data_fram
-0005bb80: 6528 782c 2064 656d 6f67 496e 2c20 6578  e(x, demogIn, ex
-0005bb90: 636c 7573 696f 6e73 3d4e 6f6e 6529 3a0a  clusions=None):.
-0005bba0: 2020 2020 2222 220a 2020 2020 6461 7461      """.    data
-0005bbb0: 203d 207b 274e 616d 6527 3a5b 2754 6f6d   = {'Name':['Tom
-0005bbc0: 272c 2027 6e69 636b 272c 2027 6b72 6973  ', 'nick', 'kris
-0005bbd0: 6827 2c20 276a 6163 6b27 5d2c 2027 4167  h', 'jack'], 'Ag
-0005bbe0: 6527 3a5b 3230 2c20 3231 2c20 3139 2c20  e':[20, 21, 19, 
-0005bbf0: 3138 5d7d 0a20 2020 2061 6e74 7370 796d  18]}.    antspym
-0005bc00: 6d2e 6765 745f 6e61 6d65 735f 6672 6f6d  m.get_names_from
-0005bc10: 5f64 6174 615f 6672 616d 6528 205b 2765  _data_frame( ['e
-0005bc20: 275d 2c20 6466 2029 0a20 2020 2061 6e74  '], df ).    ant
-0005bc30: 7370 796d 6d2e 6765 745f 6e61 6d65 735f  spymm.get_names_
-0005bc40: 6672 6f6d 5f64 6174 615f 6672 616d 6528  from_data_frame(
-0005bc50: 205b 2761 272c 2765 275d 2c20 6466 2029   ['a','e'], df )
-0005bc60: 0a20 2020 2061 6e74 7370 796d 6d2e 6765  .    antspymm.ge
-0005bc70: 745f 6e61 6d65 735f 6672 6f6d 5f64 6174  t_names_from_dat
-0005bc80: 615f 6672 616d 6528 205b 2765 275d 2c20  a_frame( ['e'], 
-0005bc90: 6466 2c20 6578 636c 7573 696f 6e73 3d27  df, exclusions='
-0005bca0: 4e27 2029 0a20 2020 2022 2222 0a20 2020  N' ).    """.   
-0005bcb0: 2023 2043 6865 636b 2069 6620 7820 6973   # Check if x is
-0005bcc0: 2061 2073 7472 696e 6720 616e 6420 636f   a string and co
-0005bcd0: 6e76 6572 7420 6974 2074 6f20 6120 6c69  nvert it to a li
-0005bce0: 7374 0a20 2020 2069 6620 6973 696e 7374  st.    if isinst
-0005bcf0: 616e 6365 2878 2c20 7374 7229 3a0a 2020  ance(x, str):.  
-0005bd00: 2020 2020 2020 7820 3d20 5b78 5d0a 2020        x = [x].  
-0005bd10: 2020 6465 6620 6765 745f 756e 6971 7565    def get_unique
-0005bd20: 2820 7171 2029 3a0a 2020 2020 2020 2020  ( qq ):.        
-0005bd30: 756e 6971 7565 203d 205b 5d0a 2020 2020  unique = [].    
-0005bd40: 2020 2020 666f 7220 6e75 6d62 6572 2069      for number i
-0005bd50: 6e20 7171 3a0a 2020 2020 2020 2020 2020  n qq:.          
-0005bd60: 2020 6966 206e 756d 6265 7220 696e 2075    if number in u
-0005bd70: 6e69 7175 653a 0a20 2020 2020 2020 2020  nique:.         
-0005bd80: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-0005bd90: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0005bda0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0005bdb0: 2020 756e 6971 7565 2e61 7070 656e 6428    unique.append(
-0005bdc0: 6e75 6d62 6572 290a 2020 2020 2020 2020  number).        
-0005bdd0: 7265 7475 726e 2075 6e69 7175 650a 2020  return unique.  
-0005bde0: 2020 6f75 746e 616d 6573 203d 206c 6973    outnames = lis
-0005bdf0: 7428 6465 6d6f 6749 6e2e 636f 6c75 6d6e  t(demogIn.column
-0005be00: 735b 6465 6d6f 6749 6e2e 636f 6c75 6d6e  s[demogIn.column
-0005be10: 732e 7374 722e 636f 6e74 6169 6e73 2878  s.str.contains(x
-0005be20: 5b30 5d29 5d29 0a20 2020 2069 6620 6c65  [0])]).    if le
-0005be30: 6e28 7829 203e 2031 3a0a 2020 2020 2020  n(x) > 1:.      
-0005be40: 2020 666f 7220 7920 696e 2078 5b31 3a5d    for y in x[1:]
-0005be50: 3a0a 2020 2020 2020 2020 2020 2020 6f75  :.            ou
-0005be60: 746e 616d 6573 203d 205b 6920 666f 7220  tnames = [i for 
-0005be70: 6920 696e 206f 7574 6e61 6d65 7320 6966  i in outnames if
-0005be80: 2079 2069 6e20 695d 0a20 2020 206f 7574   y in i].    out
-0005be90: 6e61 6d65 7320 3d20 6765 745f 756e 6971  names = get_uniq
-0005bea0: 7565 2820 6f75 746e 616d 6573 2029 0a20  ue( outnames ). 
-0005beb0: 2020 2069 6620 6578 636c 7573 696f 6e73     if exclusions
-0005bec0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0005bed0: 2020 2020 2020 746f 6578 636c 7564 6520        toexclude 
-0005bee0: 3d20 5b6e 616d 6520 666f 7220 6e61 6d65  = [name for name
-0005bef0: 2069 6e20 6f75 746e 616d 6573 2069 6620   in outnames if 
-0005bf00: 6578 636c 7573 696f 6e73 5b30 5d20 696e  exclusions[0] in
-0005bf10: 206e 616d 6520 5d0a 2020 2020 2020 2020   name ].        
-0005bf20: 6966 206c 656e 2865 7863 6c75 7369 6f6e  if len(exclusion
-0005bf30: 7329 203e 2031 3a0a 2020 2020 2020 2020  s) > 1:.        
-0005bf40: 2020 2020 666f 7220 7a7a 2069 6e20 6578      for zz in ex
-0005bf50: 636c 7573 696f 6e73 5b31 3a5d 3a0a 2020  clusions[1:]:.  
-0005bf60: 2020 2020 2020 2020 2020 2020 2020 746f                to
-0005bf70: 6578 636c 7564 652e 6578 7465 6e64 285b  exclude.extend([
-0005bf80: 6e61 6d65 2066 6f72 206e 616d 6520 696e  name for name in
-0005bf90: 206f 7574 6e61 6d65 7320 6966 207a 7a20   outnames if zz 
-0005bfa0: 696e 206e 616d 6520 5d29 0a20 2020 2020  in name ]).     
-0005bfb0: 2020 2069 6620 6c65 6e28 746f 6578 636c     if len(toexcl
-0005bfc0: 7564 6529 203e 2030 3a0a 2020 2020 2020  ude) > 0:.      
-0005bfd0: 2020 2020 2020 6f75 746e 616d 6573 203d        outnames =
-0005bfe0: 205b 6e61 6d65 2066 6f72 206e 616d 6520   [name for name 
-0005bff0: 696e 206f 7574 6e61 6d65 7320 6966 206e  in outnames if n
-0005c000: 616d 6520 6e6f 7420 696e 2074 6f65 7863  ame not in toexc
-0005c010: 6c75 6465 5d0a 2020 2020 7265 7475 726e  lude].    return
-0005c020: 206f 7574 6e61 6d65 730a 0a0a 6465 6620   outnames...def 
-0005c030: 6176 6572 6167 655f 6d6d 5f64 6628 206a  average_mm_df( j
-0005c040: 6d6d 5f69 6e2c 2064 6961 676e 6f73 7469  mm_in, diagnosti
-0005c050: 635f 6e3d 3235 2c20 636f 7272 5f74 6872  c_n=25, corr_thr
-0005c060: 6573 683d 302e 392c 2076 6572 626f 7365  esh=0.9, verbose
-0005c070: 3d46 616c 7365 2029 3a0a 2020 2020 2222  =False ):.    ""
-0005c080: 220a 2020 2020 6a6d 726f 7761 7667 2c20  ".    jmrowavg, 
-0005c090: 6a6d 6d63 6f6c 6176 672c 2064 6961 676e  jmmcolavg, diagn
-0005c0a0: 6f73 7469 6373 203d 2061 6e74 7370 796d  ostics = antspym
-0005c0b0: 6d2e 6176 6572 6167 655f 6d6d 5f64 6628  m.average_mm_df(
-0005c0c0: 206a 6d6d 5f69 6e2c 2076 6572 626f 7365   jmm_in, verbose
-0005c0d0: 3d54 7275 6520 290a 2020 2020 2222 220a  =True ).    """.
-0005c0e0: 0a20 2020 206a 6d6d 203d 206a 6d6d 5f69  .    jmm = jmm_i
-0005c0f0: 6e2e 636f 7079 2829 0a20 2020 2064 7863  n.copy().    dxc
-0005c100: 6f6c 733d 5b27 7375 626a 6563 7469 6431  ols=['subjectid1
-0005c110: 272c 2773 7562 6a65 6374 6964 3227 2c27  ','subjectid2','
-0005c120: 6d6f 6461 6c69 7479 6964 272c 276a 6f69  modalityid','joi
-0005c130: 6e69 6427 2c27 636f 7272 656c 6174 696f  nid','correlatio
-0005c140: 6e27 2c27 6469 7374 616e 6365 275d 0a20  n','distance']. 
-0005c150: 2020 206a 6f69 6e44 6961 676e 6f73 7469     joinDiagnosti
-0005c160: 6373 203d 2070 642e 4461 7461 4672 616d  cs = pd.DataFram
-0005c170: 6528 2063 6f6c 756d 6e73 203d 2064 7863  e( columns = dxc
-0005c180: 6f6c 7320 290a 2020 2020 6e61 6e4c 6973  ols ).    nanLis
-0005c190: 743d 5b6d 6174 682e 6e61 6e5d 0a20 2020  t=[math.nan].   
-0005c1a0: 2064 6566 2072 6f62 2878 2c20 793d 302e   def rob(x, y=0.
-0005c1b0: 3939 293a 0a20 2020 2020 2020 2078 5b78  99):.        x[x
-0005c1c0: 203e 206e 702e 7175 616e 7469 6c65 2878   > np.quantile(x
-0005c1d0: 2c20 792c 206e 616e 5f70 6f6c 6963 793d  , y, nan_policy=
-0005c1e0: 226f 6d69 7422 295d 203d 206e 702e 6e61  "omit")] = np.na
-0005c1f0: 6e0a 2020 2020 2020 2020 7265 7475 726e  n.        return
-0005c200: 2078 0a0a 2020 2020 6a6d 6d20 3d20 6a6d   x..    jmm = jm
-0005c210: 6d2e 7265 706c 6163 6528 7227 5e5c 732a  m.replace(r'^\s*
-0005c220: 2427 2c20 6e70 2e6e 616e 2c20 7265 6765  $', np.nan, rege
-0005c230: 783d 5472 7565 290a 0a20 2020 2069 6620  x=True)..    if 
-0005c240: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-0005c250: 2070 7269 6e74 2822 646f 2072 7366 4d52   print("do rsfMR
-0005c260: 4922 290a 2020 2020 2320 6865 7265 202d  I").    # here -
-0005c270: 2077 6520 6669 7273 7420 6861 7665 2074   we first have t
-0005c280: 6f20 6176 6572 6167 6520 7769 7468 696e  o average within
-0005c290: 2065 6163 6820 726f 770a 2020 2020 6474   each row.    dt
-0005c2a0: 3020 3d20 6765 745f 6e61 6d65 735f 6672  0 = get_names_fr
-0005c2b0: 6f6d 5f64 6174 615f 6672 616d 6528 5b22  om_data_frame(["
-0005c2c0: 7273 664d 5249 225d 2c20 6a6d 6d2c 2065  rsfMRI"], jmm, e
-0005c2d0: 7863 6c75 7369 6f6e 733d 5b22 556e 6e61  xclusions=["Unna
-0005c2e0: 6d65 6422 2c20 2272 7366 4d52 495f 4c52  med", "rsfMRI_LR
-0005c2f0: 222c 2022 7273 664d 5249 5f52 4c22 5d29  ", "rsfMRI_RL"])
-0005c300: 0a20 2020 2064 7431 203d 2067 6574 5f6e  .    dt1 = get_n
-0005c310: 616d 6573 5f66 726f 6d5f 6461 7461 5f66  ames_from_data_f
-0005c320: 7261 6d65 285b 2272 7366 4d52 495f 524c  rame(["rsfMRI_RL
-0005c330: 225d 2c20 6a6d 6d2c 2065 7863 6c75 7369  "], jmm, exclusi
-0005c340: 6f6e 733d 5b22 556e 6e61 6d65 6422 5d29  ons=["Unnamed"])
-0005c350: 0a20 2020 2069 6620 6c65 6e28 2064 7430  .    if len( dt0
-0005c360: 2029 203e 2030 2061 6e64 206c 656e 2820   ) > 0 and len( 
-0005c370: 6474 3120 2920 3e20 303a 0a20 2020 2020  dt1 ) > 0:.     
-0005c380: 2020 2066 6c69 6420 3d20 6474 305b 305d     flid = dt0[0]
-0005c390: 0a20 2020 2020 2020 2077 726f 7773 203d  .        wrows =
-0005c3a0: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
-0005c3b0: 6920 696e 2072 616e 6765 286a 6d6d 2e73  i in range(jmm.s
-0005c3c0: 6861 7065 5b30 5d29 3a0a 2020 2020 2020  hape[0]):.      
-0005c3d0: 2020 2020 2020 6966 206e 6f74 2070 642e        if not pd.
-0005c3e0: 6973 6e61 286a 6d6d 5b64 7430 5b31 5d5d  isna(jmm[dt0[1]]
-0005c3f0: 5b69 5d29 206f 7220 6e6f 7420 7064 2e69  [i]) or not pd.i
-0005c400: 736e 6128 6a6d 6d5b 6474 315b 315d 5d5b  sna(jmm[dt1[1]][
-0005c410: 695d 2920 3a0a 2020 2020 2020 2020 2020  i]) :.          
-0005c420: 2020 2020 2020 7772 6f77 732e 6170 7065        wrows.appe
-0005c430: 6e64 2869 290a 2020 2020 2020 2020 666f  nd(i).        fo
-0005c440: 7220 6b20 696e 2077 726f 7773 3a0a 2020  r k in wrows:.  
-0005c450: 2020 2020 2020 2020 2020 7631 203d 206a            v1 = j
-0005c460: 6d6d 2e69 6c6f 635b 6b5d 5b64 7430 5b31  mm.iloc[k][dt0[1
-0005c470: 3a5d 5d2e 6173 7479 7065 2866 6c6f 6174  :]].astype(float
-0005c480: 290a 2020 2020 2020 2020 2020 2020 7632  ).            v2
-0005c490: 203d 206a 6d6d 2e69 6c6f 635b 6b5d 5b64   = jmm.iloc[k][d
-0005c4a0: 7431 5b31 3a5d 5d2e 6173 7479 7065 2866  t1[1:]].astype(f
-0005c4b0: 6c6f 6174 290a 2020 2020 2020 2020 2020  loat).          
-0005c4c0: 2020 7676 6563 203d 205b 7631 5b30 5d2c    vvec = [v1[0],
-0005c4d0: 2076 325b 305d 5d0a 2020 2020 2020 2020   v2[0]].        
-0005c4e0: 2020 2020 6966 2061 6e79 287e 6e70 2e69      if any(~np.i
-0005c4f0: 736e 616e 2876 7665 6329 293a 0a20 2020  snan(vvec)):.   
-0005c500: 2020 2020 2020 2020 2020 2020 206d 796e               myn
-0005c510: 6e61 203d 205b 6920 666f 7220 692c 2078  na = [i for i, x
-0005c520: 2069 6e20 656e 756d 6572 6174 6528 7676   in enumerate(vv
-0005c530: 6563 2920 6966 207e 6e70 2e69 736e 616e  ec) if ~np.isnan
-0005c540: 2878 295d 0a20 2020 2020 2020 2020 2020  (x)].           
-0005c550: 2020 2020 206a 6d6d 2e69 6c6f 635b 6b5d       jmm.iloc[k]
-0005c560: 5b64 7430 5b30 5d5d 203d 2027 7273 664d  [dt0[0]] = 'rsfM
-0005c570: 5249 270a 2020 2020 2020 2020 2020 2020  RI'.            
-0005c580: 2020 2020 6966 206c 656e 286d 796e 6e61      if len(mynna
-0005c590: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
-0005c5a0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-0005c5b0: 796e 6e61 5b30 5d20 3d3d 2030 3a0a 2020  ynna[0] == 0:.  
-0005c5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c5d0: 2020 2020 2020 6a6d 6d2e 696c 6f63 5b6b        jmm.iloc[k
-0005c5e0: 5d5b 6474 305b 313a 5d5d 203d 2076 310a  ][dt0[1:]] = v1.
-0005c5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c600: 2020 2020 6966 206d 796e 6e61 5b30 5d20      if mynna[0] 
-0005c610: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
-0005c620: 2020 2020 2020 2020 2020 2020 2020 6a6d                jm
-0005c630: 6d2e 696c 6f63 5b6b 5d5b 6474 305b 313a  m.iloc[k][dt0[1:
-0005c640: 5d5d 203d 2076 320a 2020 2020 2020 2020  ]] = v2.        
-0005c650: 2020 2020 2020 2020 656c 6966 206c 656e          elif len
-0005c660: 286d 796e 6e61 2920 3e20 313a 0a20 2020  (mynna) > 1:.   
-0005c670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c680: 2069 6620 6c65 6e28 7632 2920 3e20 6469   if len(v2) > di
-0005c690: 6167 6e6f 7374 6963 5f6e 3a0a 2020 2020  agnostic_n:.    
-0005c6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c6b0: 2020 2020 7631 6478 3d76 315b 303a 6469      v1dx=v1[0:di
-0005c6c0: 6167 6e6f 7374 6963 5f6e 5d0a 2020 2020  agnostic_n].    
-0005c6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c6e0: 2020 2020 7632 6478 3d76 325b 303a 6469      v2dx=v2[0:di
-0005c6f0: 6167 6e6f 7374 6963 5f6e 5d0a 2020 2020  agnostic_n].    
-0005c700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c710: 656c 7365 203a 0a20 2020 2020 2020 2020  else :.         
-0005c720: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-0005c730: 3164 783d 7631 0a20 2020 2020 2020 2020  1dx=v1.         
-0005c740: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-0005c750: 3264 783d 7632 0a20 2020 2020 2020 2020  2dx=v2.         
-0005c760: 2020 2020 2020 2020 2020 206a 6f69 6e44             joinD
-0005c770: 6961 676e 6f73 7469 6373 4c6f 6320 3d20  iagnosticsLoc = 
-0005c780: 7064 2e44 6174 6146 7261 6d65 2820 636f  pd.DataFrame( co
-0005c790: 6c75 6d6e 7320 3d20 6478 636f 6c73 2c20  lumns = dxcols, 
-0005c7a0: 696e 6465 783d 7261 6e67 6528 3129 2029  index=range(1) )
-0005c7b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005c7c0: 2020 2020 206d 7963 6f72 7220 3d20 6e70       mycorr = np
-0005c7d0: 2e63 6f72 7263 6f65 6628 2076 3164 782e  .corrcoef( v1dx.
-0005c7e0: 7661 6c75 6573 2c20 7632 6478 2e76 616c  values, v2dx.val
-0005c7f0: 7565 7320 295b 302c 315d 0a20 2020 2020  ues )[0,1].     
-0005c800: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0005c810: 7965 7272 3d6e 702e 7371 7274 286e 702e  yerr=np.sqrt(np.
-0005c820: 6d65 616e 2828 7631 6478 2e76 616c 7565  mean((v1dx.value
-0005c830: 7320 2d20 7632 6478 2e76 616c 7565 7329  s - v2dx.values)
-0005c840: 2a2a 3229 290a 2020 2020 2020 2020 2020  **2)).          
-0005c850: 2020 2020 2020 2020 2020 6a6f 696e 4469            joinDi
-0005c860: 6167 6e6f 7374 6963 734c 6f63 2e69 6c6f  agnosticsLoc.ilo
-0005c870: 635b 305d 203d 205b 6a6d 6d2e 6c6f 635b  c[0] = [jmm.loc[
-0005c880: 6b2c 2775 5f68 6965 725f 6964 275d 2c6d  k,'u_hier_id'],m
-0005c890: 6174 682e 6e61 6e2c 2772 7366 4d52 4927  ath.nan,'rsfMRI'
-0005c8a0: 2c27 636f 6c61 7667 272c 6d79 636f 7272  ,'colavg',mycorr
-0005c8b0: 2c6d 7965 7272 5d0a 2020 2020 2020 2020  ,myerr].        
-0005c8c0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-0005c8d0: 7963 6f72 7220 3e20 636f 7272 5f74 6872  ycorr > corr_thr
-0005c8e0: 6573 683a 0a20 2020 2020 2020 2020 2020  esh:.           
-0005c8f0: 2020 2020 2020 2020 2020 2020 206a 6d6d               jmm
-0005c900: 2e6c 6f63 5b6b 2c20 6474 305b 313a 5d5d  .loc[k, dt0[1:]]
-0005c910: 203d 2076 312e 7661 6c75 6573 2a30 2e35   = v1.values*0.5
-0005c920: 202b 2076 322e 7661 6c75 6573 2a30 2e35   + v2.values*0.5
-0005c930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005c940: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0005c950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c960: 2020 206a 6d6d 2e6c 6f63 5b6b 2c20 6474     jmm.loc[k, dt
-0005c970: 305b 313a 5d5d 203d 206e 616e 4c69 7374  0[1:]] = nanList
-0005c980: 202a 206c 656e 2876 3129 0a20 2020 2020   * len(v1).     
-0005c990: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0005c9a0: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+000552e0: 2020 2020 2020 2020 2020 2020 2061 6e74               ant
+000552f0: 732e 706c 6f74 2820 6d79 6474 695b 2772  s.plot( mydti['r
+00055300: 6563 6f6e 5f66 6127 5d2c 2020 6178 6973  econ_fa'],  axis
+00055310: 3d32 2c20 6e73 6c69 6365 733d 6d61 7873  =2, nslices=maxs
+00055320: 6c69 6365 2c20 6e63 6f6c 3d37 2c20 6372  lice, ncol=7, cr
+00055330: 6f70 3d54 7275 652c 2074 6974 6c65 3d27  op=True, title='
+00055340: 4641 272c 2066 696c 656e 616d 653d 6d79  FA', filename=my
+00055350: 6d6d 2b6d 7973 6570 2b22 4641 6265 7474  mm+mysep+"FAbett
+00055360: 6572 2e70 6e67 2220 2029 0a20 2020 2020  er.png"  ).     
+00055370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055390: 2020 2061 6e74 732e 706c 6f74 2820 6d79     ants.plot( my
+000553a0: 6474 695b 2772 6563 6f6e 5f66 6127 5d2c  dti['recon_fa'],
+000553b0: 206d 7964 7469 5b27 6a68 755f 6c61 6265   mydti['jhu_labe
+000553c0: 6c73 275d 2c20 6178 6973 3d32 2c20 6e73  ls'], axis=2, ns
+000553d0: 6c69 6365 733d 6d61 7873 6c69 6365 2c20  lices=maxslice, 
+000553e0: 6e63 6f6c 3d37 2c20 6372 6f70 3d54 7275  ncol=7, crop=Tru
+000553f0: 652c 2074 6974 6c65 3d27 4641 202b 204a  e, title='FA + J
+00055400: 4855 272c 2066 696c 656e 616d 653d 6d79  HU', filename=my
+00055410: 6d6d 2b6d 7973 6570 2b22 4641 4a48 552e  mm+mysep+"FAJHU.
+00055420: 706e 6722 2020 290a 2020 2020 2020 2020  png"  ).        
+00055430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055450: 616e 7473 2e70 6c6f 7428 206d 7964 7469  ants.plot( mydti
+00055460: 5b27 7265 636f 6e5f 6d64 275d 2c20 2061  ['recon_md'],  a
+00055470: 7869 733d 322c 206e 736c 6963 6573 3d6d  xis=2, nslices=m
+00055480: 6178 736c 6963 652c 206e 636f 6c3d 372c  axslice, ncol=7,
+00055490: 2063 726f 703d 5472 7565 2c20 7469 746c   crop=True, titl
+000554a0: 653d 274d 4427 2c20 6669 6c65 6e61 6d65  e='MD', filename
+000554b0: 3d6d 796d 6d2b 6d79 7365 702b 224d 442e  =mymm+mysep+"MD.
+000554c0: 706e 6722 2020 290a 2020 2020 2020 2020  png"  ).        
+000554d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000554e0: 2020 2020 6966 2064 6f77 7269 7465 3a0a      if dowrite:.
+000554f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055510: 7772 6974 655f 6d6d 2820 6f75 7470 7574  write_mm( output
+00055520: 5f70 7265 6669 783d 6d79 6d6d 2c20 6d6d  _prefix=mymm, mm
+00055530: 3d74 6162 5072 6f2c 206d 6d5f 6e6f 726d  =tabPro, mm_norm
+00055540: 3d6e 6f72 6d50 726f 2c20 7431 7769 6465  =normPro, t1wide
+00055550: 3d74 3177 6964 652c 2073 6570 6172 6174  =t1wide, separat
+00055560: 6f72 3d6d 7973 6570 2029 0a20 2020 2020  or=mysep ).     
+00055570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055580: 2020 2020 2020 2020 2020 2066 6f72 206d             for m
+00055590: 796b 6579 2069 6e20 6e6f 726d 5072 6f2e  ykey in normPro.
+000555a0: 6b65 7973 2829 3a0a 2020 2020 2020 2020  keys():.        
+000555b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000555c0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+000555d0: 6f72 6d50 726f 5b6d 796b 6579 5d20 6973  ormPro[mykey] is
+000555e0: 206e 6f74 204e 6f6e 6520 616e 6420 6e6f   not None and no
+000555f0: 726d 5072 6f5b 6d79 6b65 795d 2e63 6f6d  rmPro[mykey].com
+00055600: 706f 6e65 6e74 7320 3d3d 2031 3a0a 2020  ponents == 1:.  
+00055610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055630: 2020 2020 2020 6966 2076 6973 7561 6c69        if visuali
+00055640: 7a65 2061 6e64 2046 616c 7365 3a0a 2020  ze and False:.  
+00055650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055670: 2020 2020 2020 2020 2020 616e 7473 2e70            ants.p
+00055680: 6c6f 7428 2074 656d 706c 6174 652c 206e  lot( template, n
+00055690: 6f72 6d50 726f 5b6d 796b 6579 5d2c 2061  ormPro[mykey], a
+000556a0: 7869 733d 322c 206e 736c 6963 6573 3d32  xis=2, nslices=2
+000556b0: 312c 206e 636f 6c3d 372c 2063 726f 703d  1, ncol=7, crop=
+000556c0: 5472 7565 2c20 7469 746c 653d 6d79 6b65  True, title=myke
+000556d0: 792c 2066 696c 656e 616d 653d 6d79 6d6d  y, filename=mymm
+000556e0: 2b6d 7973 6570 2b6d 796b 6579 2b22 2e70  +mysep+mykey+".p
+000556f0: 6e67 2220 2020 290a 2020 2020 2020 2020  ng"   ).        
+00055700: 6966 206f 7665 726d 6f64 5820 3d3d 206e  if overmodX == n
+00055710: 7267 5f6d 6f64 616c 6974 795f 6c69 7374  rg_modality_list
+00055720: 5b20 6c65 6e28 206e 7267 5f6d 6f64 616c  [ len( nrg_modal
+00055730: 6974 795f 6c69 7374 2029 202d 2031 205d  ity_list ) - 1 ]
+00055740: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00055750: 7475 726e 0a20 2020 2020 2020 2069 6620  turn.        if 
+00055760: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+00055770: 2020 2020 2070 7269 6e74 2822 646f 6e65       print("done
+00055780: 2077 6974 6820 2220 2b20 6f76 6572 6d6f   with " + overmo
+00055790: 6458 2029 0a20 2020 2069 6620 7665 7262  dX ).    if verb
+000557a0: 6f73 653a 0a20 2020 2020 2020 2070 7269  ose:.        pri
+000557b0: 6e74 2822 6d6d 5f6e 7267 2063 6f6d 706c  nt("mm_nrg compl
+000557c0: 6574 652e 2229 0a20 2020 2072 6574 7572  ete.").    retur
+000557d0: 6e0a 0a64 6566 2073 7065 635f 7461 7065  n..def spec_tape
+000557e0: 7228 782c 2070 3d30 2e31 293a 0a20 2020  r(x, p=0.1):.   
+000557f0: 2066 726f 6d20 7363 6970 7920 696d 706f   from scipy impo
+00055800: 7274 2073 7461 7473 2c20 7369 676e 616c  rt stats, signal
+00055810: 2c20 6666 740a 2020 2020 6672 6f6d 2073  , fft.    from s
+00055820: 7461 7473 6d6f 6465 6c73 2e72 6567 7265  tatsmodels.regre
+00055830: 7373 696f 6e2e 6c69 6e65 6172 5f6d 6f64  ssion.linear_mod
+00055840: 656c 2069 6d70 6f72 7420 7975 6c65 5f77  el import yule_w
+00055850: 616c 6b65 720a 2020 2020 2222 220a 2020  alker.    """.  
+00055860: 2020 436f 6d70 7574 6573 2061 2074 6170    Computes a tap
+00055870: 6572 6564 2076 6572 7369 6f6e 206f 6620  ered version of 
+00055880: 782c 2077 6974 6820 7461 7065 7269 6e67  x, with tapering
+00055890: 2070 2e0a 0a20 2020 2041 6461 7074 6564   p...    Adapted
+000558a0: 2066 726f 6d20 5227 7320 7374 6174 733a   from R's stats:
+000558b0: 3a73 7065 632e 7461 7065 7220 6174 2068  :spec.taper at h
+000558c0: 7474 7073 3a2f 2f67 6974 6875 622e 636f  ttps://github.co
+000558d0: 6d2f 7465 6c6d 6f2d 636f 7272 6561 2f74  m/telmo-correa/t
+000558e0: 696d 652d 7365 7269 6573 2d61 6e61 6c79  ime-series-analy
+000558f0: 7369 732f 626c 6f62 2f6d 6173 7465 722f  sis/blob/master/
+00055900: 5079 7468 6f6e 2f73 7065 6374 7275 6d2e  Python/spectrum.
+00055910: 7079 0a0a 2020 2020 2222 220a 0a20 2020  py..    """..   
+00055920: 2070 203d 206e 702e 725f 5b70 5d0a 2020   p = np.r_[p].  
+00055930: 2020 6173 7365 7274 206e 702e 616c 6c28    assert np.all(
+00055940: 2870 203e 3d20 3029 2026 2028 7020 3c20  (p >= 0) & (p < 
+00055950: 302e 3529 292c 2022 2770 2720 6d75 7374  0.5)), "'p' must
+00055960: 2062 6520 6265 7477 6565 6e20 3020 616e   be between 0 an
+00055970: 6420 302e 3522 0a0a 2020 2020 7820 3d20  d 0.5"..    x = 
+00055980: 6e70 2e72 5f5b 785d 2e61 7374 7970 6528  np.r_[x].astype(
+00055990: 2766 6c6f 6174 3634 2729 0a20 2020 206f  'float64').    o
+000559a0: 7269 6769 6e61 6c5f 7368 6170 6520 3d20  riginal_shape = 
+000559b0: 782e 7368 6170 650a 0a20 2020 2061 7373  x.shape..    ass
+000559c0: 6572 7420 6c65 6e28 6f72 6967 696e 616c  ert len(original
+000559d0: 5f73 6861 7065 2920 3c3d 2032 2c20 2227  _shape) <= 2, "'
+000559e0: 7827 206d 7573 7420 6861 7665 2061 7420  x' must have at 
+000559f0: 6d6f 7374 2032 2064 696d 656e 7369 6f6e  most 2 dimension
+00055a00: 7322 0a20 2020 2077 6869 6c65 206c 656e  s".    while len
+00055a10: 2878 2e73 6861 7065 2920 3c20 323a 0a20  (x.shape) < 2:. 
+00055a20: 2020 2020 2020 2078 203d 206e 702e 6578         x = np.ex
+00055a30: 7061 6e64 5f64 696d 7328 782c 2061 7869  pand_dims(x, axi
+00055a40: 733d 3129 0a0a 2020 2020 6e72 2c20 6e63  s=1)..    nr, nc
+00055a50: 203d 2078 2e73 6861 7065 0a20 2020 2069   = x.shape.    i
+00055a60: 6620 6c65 6e28 7029 203d 3d20 313a 0a20  f len(p) == 1:. 
+00055a70: 2020 2020 2020 2070 203d 2070 202a 206e         p = p * n
+00055a80: 702e 6f6e 6573 286e 6329 0a20 2020 2065  p.ones(nc).    e
+00055a90: 6c73 653a 0a20 2020 2020 2020 2061 7373  lse:.        ass
+00055aa0: 6572 7420 6c65 6e28 7029 203d 3d20 6e63  ert len(p) == nc
+00055ab0: 2c20 226c 656e 6774 6820 6f66 2027 7027  , "length of 'p'
+00055ac0: 206d 7573 7420 6265 2031 206f 7220 6571   must be 1 or eq
+00055ad0: 7561 6c20 7468 6520 6e75 6d62 6572 206f  ual the number o
+00055ae0: 6620 636f 6c75 6d6e 7320 6f66 2027 7827  f columns of 'x'
+00055af0: 220a 0a20 2020 2066 6f72 2069 2069 6e20  "..    for i in 
+00055b00: 7261 6e67 6528 6e63 293a 0a20 2020 2020  range(nc):.     
+00055b10: 2020 206d 203d 2069 6e74 286e 702e 666c     m = int(np.fl
+00055b20: 6f6f 7228 6e72 202a 2070 5b69 5d29 290a  oor(nr * p[i])).
+00055b30: 2020 2020 2020 2020 6966 206d 203d 3d20          if m == 
+00055b40: 303a 0a20 2020 2020 2020 2020 2020 2063  0:.            c
+00055b50: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
+00055b60: 7720 3d20 302e 3520 2a20 2831 202d 206e  w = 0.5 * (1 - n
+00055b70: 702e 636f 7328 6e70 2e70 6920 2a20 6e70  p.cos(np.pi * np
+00055b80: 2e61 7261 6e67 6528 312c 2032 202a 206d  .arange(1, 2 * m
+00055b90: 2c20 7374 6570 3d32 292f 2832 202a 206d  , step=2)/(2 * m
+00055ba0: 2929 290a 2020 2020 2020 2020 785b 3a2c  ))).        x[:,
+00055bb0: 2069 5d20 3d20 6e70 2e72 5f5b 772c 206e   i] = np.r_[w, n
+00055bc0: 702e 6f6e 6573 286e 7220 2d20 3220 2a20  p.ones(nr - 2 * 
+00055bd0: 6d29 2c20 775b 3a3a 2d31 5d5d 202a 2078  m), w[::-1]] * x
+00055be0: 5b3a 2c20 695d 0a0a 2020 2020 7820 3d20  [:, i]..    x = 
+00055bf0: 6e70 2e72 6573 6861 7065 2878 2c20 6f72  np.reshape(x, or
+00055c00: 6967 696e 616c 5f73 6861 7065 290a 2020  iginal_shape).  
+00055c10: 2020 7265 7475 726e 2078 0a0a 6465 6620    return x..def 
+00055c20: 706c 6f74 5f73 7065 6328 7370 6563 5f72  plot_spec(spec_r
+00055c30: 6573 2c20 636f 7665 7261 6765 3d4e 6f6e  es, coverage=Non
+00055c40: 652c 2061 783d 4e6f 6e65 2c20 7469 746c  e, ax=None, titl
+00055c50: 653d 4e6f 6e65 293a 0a20 2020 2069 6d70  e=None):.    imp
+00055c60: 6f72 7420 6d61 7470 6c6f 746c 6962 2e70  ort matplotlib.p
+00055c70: 7970 6c6f 7420 6173 2070 6c74 0a20 2020  yplot as plt.   
+00055c80: 2022 2222 436f 6e76 656e 6965 6e63 6520   """Convenience 
+00055c90: 706c 6f74 7469 6e67 206d 6574 686f 642c  plotting method,
+00055ca0: 2061 6c73 6f20 696e 636c 7564 6573 2063   also includes c
+00055cb0: 6f6e 6669 6465 6e63 6520 6372 6f73 7320  onfidence cross 
+00055cc0: 696e 2074 6865 2073 616d 6520 7374 796c  in the same styl
+00055cd0: 6520 6173 2052 2e0a 0a20 2020 204e 6f74  e as R...    Not
+00055ce0: 6520 7468 6174 2074 6865 206c 6f63 6174  e that the locat
+00055cf0: 696f 6e20 6f66 2074 6865 2063 726f 7373  ion of the cross
+00055d00: 2069 7320 6972 7265 6c65 7661 6e74 3b20   is irrelevant; 
+00055d10: 6f6e 6c79 2077 6964 7468 2061 6e64 2068  only width and h
+00055d20: 6569 6768 7420 6d61 7474 6572 2e22 2222  eight matter."""
+00055d30: 0a20 2020 2066 2c20 5078 7820 3d20 7370  .    f, Pxx = sp
+00055d40: 6563 5f72 6573 5b27 6672 6571 275d 2c20  ec_res['freq'], 
+00055d50: 7370 6563 5f72 6573 5b27 7370 6563 275d  spec_res['spec']
+00055d60: 0a0a 2020 2020 6966 2063 6f76 6572 6167  ..    if coverag
+00055d70: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
+00055d80: 2020 2020 2020 2063 6920 3d20 7370 6563         ci = spec
+00055d90: 5f63 6928 7370 6563 5f72 6573 5b27 6466  _ci(spec_res['df
+00055da0: 275d 2c20 636f 7665 7261 6765 3d63 6f76  '], coverage=cov
+00055db0: 6572 6167 6529 0a20 2020 2020 2020 2063  erage).        c
+00055dc0: 6f6e 665f 7820 3d20 286d 6178 2873 7065  onf_x = (max(spe
+00055dd0: 635f 7265 735b 2766 7265 7127 5d29 202d  c_res['freq']) -
+00055de0: 2073 7065 635f 7265 735b 2762 616e 6477   spec_res['bandw
+00055df0: 6964 7468 275d 2920 2b20 6e70 2e72 5f5b  idth']) + np.r_[
+00055e00: 2d30 2e35 2c20 302e 355d 202a 2073 7065  -0.5, 0.5] * spe
+00055e10: 635f 7265 735b 2762 616e 6477 6964 7468  c_res['bandwidth
+00055e20: 275d 0a20 2020 2020 2020 2063 6f6e 665f  '].        conf_
+00055e30: 7920 3d20 6d61 7828 7370 6563 5f72 6573  y = max(spec_res
+00055e40: 5b27 7370 6563 275d 2920 2f20 6369 5b31  ['spec']) / ci[1
+00055e50: 5d0a 0a20 2020 2069 6620 6178 2069 7320  ]..    if ax is 
+00055e60: 4e6f 6e65 3a0a 2020 2020 2020 2020 6178  None:.        ax
+00055e70: 203d 2070 6c74 2e67 6361 2829 0a0a 2020   = plt.gca()..  
+00055e80: 2020 6178 2e70 6c6f 7428 662c 2050 7878    ax.plot(f, Pxx
+00055e90: 2c20 636f 6c6f 723d 2743 3027 290a 2020  , color='C0').  
+00055ea0: 2020 6178 2e73 6574 5f78 6c61 6265 6c28    ax.set_xlabel(
+00055eb0: 2746 7265 7175 656e 6379 2729 0a20 2020  'Frequency').   
+00055ec0: 2061 782e 7365 745f 796c 6162 656c 2827   ax.set_ylabel('
+00055ed0: 4c6f 6720 5370 6563 7472 756d 2729 0a20  Log Spectrum'). 
+00055ee0: 2020 2061 782e 7365 745f 7973 6361 6c65     ax.set_yscale
+00055ef0: 2827 6c6f 6727 290a 2020 2020 6966 2063  ('log').    if c
+00055f00: 6f76 6572 6167 6520 6973 206e 6f74 204e  overage is not N
+00055f10: 6f6e 653a 0a20 2020 2020 2020 2061 782e  one:.        ax.
+00055f20: 706c 6f74 286e 702e 6d65 616e 2863 6f6e  plot(np.mean(con
+00055f30: 665f 7829 202a 206e 702e 725f 5b31 2c20  f_x) * np.r_[1, 
+00055f40: 315d 2c20 636f 6e66 5f79 202a 2063 692c  1], conf_y * ci,
+00055f50: 2063 6f6c 6f72 3d27 7265 6427 290a 2020   color='red').  
+00055f60: 2020 2020 2020 6178 2e70 6c6f 7428 636f        ax.plot(co
+00055f70: 6e66 5f78 2c20 6e70 2e6d 6561 6e28 636f  nf_x, np.mean(co
+00055f80: 6e66 5f79 2920 2a20 6e70 2e72 5f5b 312c  nf_y) * np.r_[1,
+00055f90: 2031 5d2c 2063 6f6c 6f72 3d27 7265 6427   1], color='red'
+00055fa0: 290a 0a20 2020 2061 782e 7365 745f 7469  )..    ax.set_ti
+00055fb0: 746c 6528 7370 6563 5f72 6573 5b27 6d65  tle(spec_res['me
+00055fc0: 7468 6f64 275d 2069 6620 7469 746c 6520  thod'] if title 
+00055fd0: 6973 204e 6f6e 6520 656c 7365 2074 6974  is None else tit
+00055fe0: 6c65 290a 0a64 6566 2073 7065 635f 6369  le)..def spec_ci
+00055ff0: 2864 662c 2063 6f76 6572 6167 653d 302e  (df, coverage=0.
+00056000: 3935 293a 0a20 2020 2066 726f 6d20 7363  95):.    from sc
+00056010: 6970 7920 696d 706f 7274 2073 7461 7473  ipy import stats
+00056020: 2c20 7369 676e 616c 2c20 6666 740a 2020  , signal, fft.  
+00056030: 2020 6672 6f6d 2073 7461 7473 6d6f 6465    from statsmode
+00056040: 6c73 2e72 6567 7265 7373 696f 6e2e 6c69  ls.regression.li
+00056050: 6e65 6172 5f6d 6f64 656c 2069 6d70 6f72  near_model impor
+00056060: 7420 7975 6c65 5f77 616c 6b65 720a 2020  t yule_walker.  
+00056070: 2020 2222 220a 2020 2020 436f 6d70 7574    """.    Comput
+00056080: 6573 2074 6865 2063 6f6e 6669 6465 6e63  es the confidenc
+00056090: 6520 696e 7465 7276 616c 2066 6f72 2061  e interval for a
+000560a0: 2073 7065 6374 7261 6c20 6669 742c 2062   spectral fit, b
+000560b0: 6173 6564 206f 6e20 7468 6520 6e75 6d62  ased on the numb
+000560c0: 6572 206f 6620 6465 6772 6565 7320 6f66  er of degrees of
+000560d0: 2066 7265 6564 6f6d 2e0a 0a20 2020 2041   freedom...    A
+000560e0: 6461 7074 6564 2066 726f 6d20 5227 7320  dapted from R's 
+000560f0: 7374 6174 733a 3a70 6c6f 742e 7370 6563  stats::plot.spec
+00056100: 2061 7420 6874 7470 733a 2f2f 6769 7468   at https://gith
+00056110: 7562 2e63 6f6d 2f74 656c 6d6f 2d63 6f72  ub.com/telmo-cor
+00056120: 7265 612f 7469 6d65 2d73 6572 6965 732d  rea/time-series-
+00056130: 616e 616c 7973 6973 2f62 6c6f 622f 6d61  analysis/blob/ma
+00056140: 7374 6572 2f50 7974 686f 6e2f 7370 6563  ster/Python/spec
+00056150: 7472 756d 2e70 790a 0a20 2020 2022 2222  trum.py..    """
+00056160: 0a0a 2020 2020 6173 7365 7274 2063 6f76  ..    assert cov
+00056170: 6572 6167 6520 3e3d 2030 2061 6e64 2063  erage >= 0 and c
+00056180: 6f76 6572 6167 6520 3c20 312c 2022 636f  overage < 1, "co
+00056190: 7665 7261 6765 2070 726f 6261 6269 6c69  verage probabili
+000561a0: 7479 206f 7574 206f 6620 7261 6e67 6520  ty out of range 
+000561b0: 5b30 2c20 3129 220a 0a20 2020 2074 6169  [0, 1)"..    tai
+000561c0: 6c20 3d20 3120 2d20 636f 7665 7261 6765  l = 1 - coverage
+000561d0: 0a0a 2020 2020 7068 6920 3d20 7374 6174  ..    phi = stat
+000561e0: 732e 6368 6932 2e63 6466 2878 3d64 662c  s.chi2.cdf(x=df,
+000561f0: 2064 663d 6466 290a 2020 2020 7570 7065   df=df).    uppe
+00056200: 725f 7175 616e 7469 6c65 203d 2031 202d  r_quantile = 1 -
+00056210: 2074 6169 6c20 2a20 2831 202d 2070 6869   tail * (1 - phi
+00056220: 290a 2020 2020 6c6f 7765 725f 7175 616e  ).    lower_quan
+00056230: 7469 6c65 203d 2074 6169 6c20 2a20 7068  tile = tail * ph
+00056240: 690a 0a20 2020 2072 6574 7572 6e20 6466  i..    return df
+00056250: 202f 2073 7461 7473 2e63 6869 322e 7070   / stats.chi2.pp
+00056260: 6628 5b75 7070 6572 5f71 7561 6e74 696c  f([upper_quantil
+00056270: 652c 206c 6f77 6572 5f71 7561 6e74 696c  e, lower_quantil
+00056280: 655d 2c20 6466 3d64 6629 0a0a 6465 6620  e], df=df)..def 
+00056290: 7370 6563 5f70 6772 616d 2878 2c20 7866  spec_pgram(x, xf
+000562a0: 7265 713d 312c 2073 7061 6e73 3d4e 6f6e  req=1, spans=Non
+000562b0: 652c 206b 6572 6e65 6c3d 4e6f 6e65 2c20  e, kernel=None, 
+000562c0: 7461 7065 723d 302e 312c 2070 6164 3d30  taper=0.1, pad=0
+000562d0: 2c20 6661 7374 3d54 7275 652c 2064 656d  , fast=True, dem
+000562e0: 6561 6e3d 4661 6c73 652c 2064 6574 7265  ean=False, detre
+000562f0: 6e64 3d54 7275 652c 0a20 2020 2020 2020  nd=True,.       
+00056300: 2020 2020 2020 2020 706c 6f74 3d54 7275          plot=Tru
+00056310: 652c 202a 2a6b 7761 7267 7329 3a0a 2020  e, **kwargs):.  
+00056320: 2020 2222 220a 2020 2020 436f 6d70 7574    """.    Comput
+00056330: 6573 2074 6865 2073 7065 6374 7261 6c20  es the spectral 
+00056340: 6465 6e73 6974 7920 6573 7469 6d61 7465  density estimate
+00056350: 2075 7369 6e67 2061 2070 6572 696f 646f   using a periodo
+00056360: 6772 616d 2e20 204f 7074 696f 6e61 6c6c  gram.  Optionall
+00056370: 792c 2069 7420 616c 736f 3a0a 2020 2020  y, it also:.    
+00056380: 2d20 5573 6573 2061 2070 726f 7669 6465  - Uses a provide
+00056390: 6420 6b65 726e 656c 2077 696e 646f 772c  d kernel window,
+000563a0: 206f 7220 6120 7365 7175 656e 6365 206f   or a sequence o
+000563b0: 6620 7370 616e 7320 666f 7220 636f 6e76  f spans for conv
+000563c0: 6f6c 7574 6564 206d 6f64 6966 6965 6420  oluted modified 
+000563d0: 4461 6e69 656c 6c20 6b65 726e 656c 732e  Daniell kernels.
+000563e0: 0a20 2020 202d 2054 6170 6572 7320 7468  .    - Tapers th
+000563f0: 6520 7374 6172 7420 616e 6420 656e 6420  e start and end 
+00056400: 6f66 2074 6865 2073 6572 6965 7320 746f  of the series to
+00056410: 2061 766f 6964 2065 6e64 2d6f 662d 7369   avoid end-of-si
+00056420: 676e 616c 2065 6666 6563 7473 2e0a 2020  gnal effects..  
+00056430: 2020 2d20 5061 6473 2074 6865 2070 726f    - Pads the pro
+00056440: 7669 6465 6420 7365 7269 6573 2062 6566  vided series bef
+00056450: 6f72 6520 636f 6d70 7574 6174 696f 6e2c  ore computation,
+00056460: 2061 6464 696e 6720 7061 642a 286c 656e   adding pad*(len
+00056470: 6774 6820 6f66 2073 6572 6965 7329 207a  gth of series) z
+00056480: 6572 6f73 2061 7420 7468 6520 656e 642e  eros at the end.
+00056490: 0a20 2020 202d 2050 6164 7320 7468 6520  .    - Pads the 
+000564a0: 7072 6f76 6964 6564 2073 6572 6965 7320  provided series 
+000564b0: 6265 666f 7265 2063 6f6d 7075 7461 7469  before computati
+000564c0: 6f6e 2074 6f20 7370 6565 6420 7570 2046  on to speed up F
+000564d0: 4654 2063 616c 6375 6c61 7469 6f6e 2e0a  FT calculation..
+000564e0: 2020 2020 2d20 5065 7266 6f72 6d73 2064      - Performs d
+000564f0: 656d 6561 6e69 6e67 206f 7220 6465 7472  emeaning or detr
+00056500: 656e 6469 6e67 206f 6e20 7468 6520 7365  ending on the se
+00056510: 7269 6573 2e0a 2020 2020 2d20 506c 6f74  ries..    - Plot
+00056520: 7320 7265 7375 6c74 732e 0a0a 2020 2020  s results...    
+00056530: 496d 706c 656d 656e 7465 6420 746f 2065  Implemented to e
+00056540: 6e73 7572 6520 636f 6d70 6174 6962 696c  nsure compatibil
+00056550: 6974 7920 7769 7468 2052 2773 2073 7065  ity with R's spe
+00056560: 6374 7261 6c20 6675 6e63 7469 6f6e 732c  ctral functions,
+00056570: 2061 7320 6f70 706f 7365 6420 746f 2072   as opposed to r
+00056580: 6575 7369 6e67 2073 6369 7079 2773 2070  eusing scipy's p
+00056590: 6572 696f 646f 6772 616d 2e0a 0a20 2020  eriodogram...   
+000565a0: 2041 6461 7074 6564 2066 726f 6d20 5227   Adapted from R'
+000565b0: 7320 7374 6174 733a 3a73 7065 632e 7067  s stats::spec.pg
+000565c0: 7261 6d20 6174 2068 7474 7073 3a2f 2f67  ram at https://g
+000565d0: 6974 6875 622e 636f 6d2f 7465 6c6d 6f2d  ithub.com/telmo-
+000565e0: 636f 7272 6561 2f74 696d 652d 7365 7269  correa/time-seri
+000565f0: 6573 2d61 6e61 6c79 7369 732f 626c 6f62  es-analysis/blob
+00056600: 2f6d 6173 7465 722f 5079 7468 6f6e 2f73  /master/Python/s
+00056610: 7065 6374 7275 6d2e 7079 0a0a 2020 2020  pectrum.py..    
+00056620: 6578 616d 706c 653a 0a0a 2020 2020 696d  example:..    im
+00056630: 706f 7274 206e 756d 7079 2061 7320 6e70  port numpy as np
+00056640: 0a20 2020 2069 6d70 6f72 7420 616e 7473  .    import ants
+00056650: 7079 6d6d 0a20 2020 206d 7978 203d 206e  pymm.    myx = n
+00056660: 702e 7261 6e64 6f6d 2e72 616e 6428 3130  p.random.rand(10
+00056670: 302c 3129 0a20 2020 206d 7973 7065 6320  0,1).    myspec 
+00056680: 3d20 616e 7473 7079 6d6d 2e73 7065 635f  = antspymm.spec_
+00056690: 7067 7261 6d28 6d79 782c 302e 3529 0a0a  pgram(myx,0.5)..
+000566a0: 2020 2020 2222 220a 2020 2020 6672 6f6d      """.    from
+000566b0: 2073 6369 7079 2069 6d70 6f72 7420 7374   scipy import st
+000566c0: 6174 732c 2073 6967 6e61 6c2c 2066 6674  ats, signal, fft
+000566d0: 0a20 2020 2066 726f 6d20 7374 6174 736d  .    from statsm
+000566e0: 6f64 656c 732e 7265 6772 6573 7369 6f6e  odels.regression
+000566f0: 2e6c 696e 6561 725f 6d6f 6465 6c20 696d  .linear_model im
+00056700: 706f 7274 2079 756c 655f 7761 6c6b 6572  port yule_walker
+00056710: 0a20 2020 2064 6566 2064 616e 6965 6c6c  .    def daniell
+00056720: 5f77 696e 646f 775f 6d6f 6469 6669 6564  _window_modified
+00056730: 286d 293a 0a20 2020 2020 2020 2022 2222  (m):.        """
+00056740: 2053 696e 676c 652d 7061 7373 206d 6f64   Single-pass mod
+00056750: 6966 6965 6420 4461 6e69 656c 6c20 6b65  ified Daniell ke
+00056760: 726e 656c 2077 696e 646f 772e 0a0a 2020  rnel window...  
+00056770: 2020 2020 2020 5765 6967 6874 2069 7320        Weight is 
+00056780: 6e6f 726d 616c 697a 6564 2074 6f20 6164  normalized to ad
+00056790: 6420 7570 2074 6f20 312c 2061 6e64 2061  d up to 1, and a
+000567a0: 6c6c 2076 616c 7565 7320 6172 6520 7468  ll values are th
+000567b0: 6520 7361 6d65 2c20 6f74 6865 7220 7468  e same, other th
+000567c0: 616e 2074 6865 2066 6972 7374 2061 6e64  an the first and
+000567d0: 2074 6865 0a20 2020 2020 2020 206c 6173   the.        las
+000567e0: 742c 2077 6869 6368 2061 7265 2064 6976  t, which are div
+000567f0: 6964 6564 2062 7920 322e 0a20 2020 2020  ided by 2..     
+00056800: 2020 2022 2222 0a20 2020 2020 2020 2064     """.        d
+00056810: 6566 2077 286b 293a 0a20 2020 2020 2020  ef w(k):.       
+00056820: 2020 2020 2072 6574 7572 6e20 6e70 2e77       return np.w
+00056830: 6865 7265 286e 702e 6162 7328 6b29 203c  here(np.abs(k) <
+00056840: 206d 2c20 3120 2f20 2832 2a6d 292c 206e   m, 1 / (2*m), n
+00056850: 702e 7768 6572 6528 6e70 2e61 6273 286b  p.where(np.abs(k
+00056860: 2920 3d3d 206d 2c20 312f 2834 2a6d 292c  ) == m, 1/(4*m),
+00056870: 2030 2929 0a0a 2020 2020 2020 2020 7265   0))..        re
+00056880: 7475 726e 2077 286e 702e 6172 616e 6765  turn w(np.arange
+00056890: 282d 6d2c 206d 2b31 2929 0a0a 2020 2020  (-m, m+1))..    
+000568a0: 6465 6620 6461 6e69 656c 6c5f 7769 6e64  def daniell_wind
+000568b0: 6f77 5f63 6f6e 766f 6c76 6528 7629 3a0a  ow_convolve(v):.
+000568c0: 2020 2020 2020 2020 2222 2220 436f 6e76          """ Conv
+000568d0: 6f6c 7665 6420 7665 7273 696f 6e20 6f66  olved version of
+000568e0: 206d 756c 7469 706c 6520 6d6f 6469 6669   multiple modifi
+000568f0: 6564 2044 616e 6965 6c6c 206b 6572 6e65  ed Daniell kerne
+00056900: 6c20 7769 6e64 6f77 732e 0a0a 2020 2020  l windows...    
+00056910: 2020 2020 5061 7261 6d65 7465 7220 7620      Parameter v 
+00056920: 7368 6f75 6c64 2062 6520 616e 2069 7465  should be an ite
+00056930: 7261 626c 6520 6f66 206d 2076 616c 7565  rable of m value
+00056940: 732e 0a20 2020 2020 2020 2022 2222 0a0a  s..        """..
+00056950: 2020 2020 2020 2020 6966 206c 656e 2876          if len(v
+00056960: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
+00056970: 2020 2020 7265 7475 726e 206e 702e 725f      return np.r_
+00056980: 5b31 5d0a 0a20 2020 2020 2020 2069 6620  [1]..        if 
+00056990: 6c65 6e28 7629 203d 3d20 313a 0a20 2020  len(v) == 1:.   
+000569a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000569b0: 6461 6e69 656c 6c5f 7769 6e64 6f77 5f6d  daniell_window_m
+000569c0: 6f64 6966 6965 6428 765b 305d 290a 0a20  odified(v[0]).. 
+000569d0: 2020 2020 2020 2072 6574 7572 6e20 7369         return si
+000569e0: 676e 616c 2e63 6f6e 766f 6c76 6528 6461  gnal.convolve(da
+000569f0: 6e69 656c 6c5f 7769 6e64 6f77 5f6d 6f64  niell_window_mod
+00056a00: 6966 6965 6428 765b 305d 292c 2064 616e  ified(v[0]), dan
+00056a10: 6965 6c6c 5f77 696e 646f 775f 636f 6e76  iell_window_conv
+00056a20: 6f6c 7665 2876 5b31 3a5d 2929 0a0a 2020  olve(v[1:]))..  
+00056a30: 2020 2320 456e 7375 7265 2077 6520 6361    # Ensure we ca
+00056a40: 6e20 7374 6f72 6520 6e6f 6e2d 696e 7465  n store non-inte
+00056a50: 6765 7273 2069 6e20 782c 2061 6e64 2074  gers in x, and t
+00056a60: 6861 7420 6974 2069 7320 6120 6e75 6d70  hat it is a nump
+00056a70: 7920 6f62 6a65 6374 0a20 2020 2078 203d  y object.    x =
+00056a80: 206e 702e 725f 5b78 5d2e 6173 7479 7065   np.r_[x].astype
+00056a90: 2827 666c 6f61 7436 3427 290a 2020 2020  ('float64').    
+00056aa0: 6f72 6967 696e 616c 5f73 6861 7065 203d  original_shape =
+00056ab0: 2078 2e73 6861 7065 0a0a 2020 2020 2320   x.shape..    # 
+00056ac0: 456e 7375 7265 2063 6f72 7265 6374 2064  Ensure correct d
+00056ad0: 696d 656e 7369 6f6e 730a 2020 2020 6173  imensions.    as
+00056ae0: 7365 7274 206c 656e 286f 7269 6769 6e61  sert len(origina
+00056af0: 6c5f 7368 6170 6529 203c 3d20 322c 2022  l_shape) <= 2, "
+00056b00: 2778 2720 6d75 7374 2068 6176 6520 6174  'x' must have at
+00056b10: 206d 6f73 7420 3220 6469 6d65 6e73 696f   most 2 dimensio
+00056b20: 6e73 220a 2020 2020 7768 696c 6520 6c65  ns".    while le
+00056b30: 6e28 782e 7368 6170 6529 203c 2032 3a0a  n(x.shape) < 2:.
+00056b40: 2020 2020 2020 2020 7820 3d20 6e70 2e65          x = np.e
+00056b50: 7870 616e 645f 6469 6d73 2878 2c20 6178  xpand_dims(x, ax
+00056b60: 6973 3d31 290a 0a20 2020 204e 2c20 6e73  is=1)..    N, ns
+00056b70: 6572 203d 2078 2e73 6861 7065 0a20 2020  er = x.shape.   
+00056b80: 204e 3020 3d20 4e0a 0a20 2020 2023 2045   N0 = N..    # E
+00056b90: 6e73 7572 6520 6f6e 6c79 206f 6e65 206f  nsure only one o
+00056ba0: 6620 7370 616e 732c 206b 6572 6e65 6c20  f spans, kernel 
+00056bb0: 6973 2070 726f 7669 6465 642c 2061 6e64  is provided, and
+00056bc0: 2062 7569 6c64 2074 6865 206b 6572 6e65   build the kerne
+00056bd0: 6c20 7769 6e64 6f77 2069 6620 6e65 6564  l window if need
+00056be0: 6564 0a20 2020 2061 7373 6572 7420 2873  ed.    assert (s
+00056bf0: 7061 6e73 2069 7320 4e6f 6e65 2920 6f72  pans is None) or
+00056c00: 2028 6b65 726e 656c 2069 7320 4e6f 6e65   (kernel is None
+00056c10: 292c 2022 6d75 7374 2073 7065 6369 6679  ), "must specify
+00056c20: 206f 6e6c 7920 6f6e 6520 6f66 2027 7370   only one of 'sp
+00056c30: 616e 7327 206f 7220 276b 6572 6e65 6c27  ans' or 'kernel'
+00056c40: 220a 2020 2020 6966 2073 7061 6e73 2069  ".    if spans i
+00056c50: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00056c60: 2020 2020 6b65 726e 656c 203d 2064 616e      kernel = dan
+00056c70: 6965 6c6c 5f77 696e 646f 775f 636f 6e76  iell_window_conv
+00056c80: 6f6c 7665 286e 702e 666c 6f6f 725f 6469  olve(np.floor_di
+00056c90: 7669 6465 286e 702e 725f 5b73 7061 6e73  vide(np.r_[spans
+00056ca0: 5d2c 2032 2929 0a0a 2020 2020 2320 4465  ], 2))..    # De
+00056cb0: 7472 656e 6420 6f72 2064 656d 6561 6e20  trend or demean 
+00056cc0: 7468 6520 7365 7269 6573 0a20 2020 2069  the series.    i
+00056cd0: 6620 6465 7472 656e 643a 0a20 2020 2020  f detrend:.     
+00056ce0: 2020 2074 203d 206e 702e 6172 616e 6765     t = np.arange
+00056cf0: 284e 2920 2d20 284e 202d 2031 292f 320a  (N) - (N - 1)/2.
+00056d00: 2020 2020 2020 2020 7375 6d74 3220 3d20          sumt2 = 
+00056d10: 4e20 2a20 284e 2a2a 3220 2d20 3129 2f31  N * (N**2 - 1)/1
+00056d20: 320a 2020 2020 2020 2020 7820 2d3d 2028  2.        x -= (
+00056d30: 6e70 2e72 6570 6561 7428 6e70 2e65 7870  np.repeat(np.exp
+00056d40: 616e 645f 6469 6d73 286e 702e 6d65 616e  and_dims(np.mean
+00056d50: 2878 2c20 6178 6973 3d30 292c 2030 292c  (x, axis=0), 0),
+00056d60: 204e 2c20 6178 6973 3d30 2920 2b20 6e70   N, axis=0) + np
+00056d70: 2e6f 7574 6572 286e 702e 7375 6d28 782e  .outer(np.sum(x.
+00056d80: 5420 2a20 742c 2061 7869 733d 3129 2c20  T * t, axis=1), 
+00056d90: 742f 7375 6d74 3229 2e54 290a 2020 2020  t/sumt2).T).    
+00056da0: 656c 6966 2064 656d 6561 6e3a 0a20 2020  elif demean:.   
+00056db0: 2020 2020 2078 202d 3d20 6e70 2e6d 6561       x -= np.mea
+00056dc0: 6e28 782c 2061 7869 733d 3029 0a0a 2020  n(x, axis=0)..  
+00056dd0: 2020 2320 436f 6d70 7574 6520 7461 7065    # Compute tape
+00056de0: 7220 616e 6420 7461 7065 7220 6164 6a75  r and taper adju
+00056df0: 7374 6d65 6e74 2076 6172 6961 626c 6573  stment variables
+00056e00: 0a20 2020 2078 203d 2073 7065 635f 7461  .    x = spec_ta
+00056e10: 7065 7228 782c 2074 6170 6572 290a 2020  per(x, taper).  
+00056e20: 2020 7532 203d 2028 3120 2d20 2835 2f38    u2 = (1 - (5/8
+00056e30: 2920 2a20 7461 7065 7220 2a20 3229 0a20  ) * taper * 2). 
+00056e40: 2020 2075 3420 3d20 2831 202d 2028 3933     u4 = (1 - (93
+00056e50: 2f31 3238 2920 2a20 7461 7065 7220 2a20  /128) * taper * 
+00056e60: 3229 0a0a 2020 2020 2320 5061 6420 7468  2)..    # Pad th
+00056e70: 6520 7365 7269 6573 2077 6974 6820 636f  e series with co
+00056e80: 7069 6573 206f 6620 7468 6520 7361 6d65  pies of the same
+00056e90: 2073 6861 7065 2c20 6275 7420 6669 6c6c   shape, but fill
+00056ea0: 6564 2077 6974 6820 7a65 726f 6573 0a20  ed with zeroes. 
+00056eb0: 2020 2069 6620 7061 6420 3e20 303a 0a20     if pad > 0:. 
+00056ec0: 2020 2020 2020 2078 203d 206e 702e 725f         x = np.r_
+00056ed0: 5b78 2c20 6e70 2e7a 6572 6f73 2828 7061  [x, np.zeros((pa
+00056ee0: 6420 2a20 782e 7368 6170 655b 305d 2c20  d * x.shape[0], 
+00056ef0: 782e 7368 6170 655b 315d 2929 5d0a 2020  x.shape[1]))].  
+00056f00: 2020 2020 2020 4e20 3d20 782e 7368 6170        N = x.shap
+00056f10: 655b 305d 0a0a 2020 2020 2320 4675 7274  e[0]..    # Furt
+00056f20: 6865 7220 7061 6420 7468 6520 7365 7269  her pad the seri
+00056f30: 6573 2074 6f20 6163 6365 6c65 7261 7465  es to accelerate
+00056f40: 2046 4654 2063 6f6d 7075 7461 7469 6f6e   FFT computation
+00056f50: 0a20 2020 2069 6620 6661 7374 3a0a 2020  .    if fast:.  
+00056f60: 2020 2020 2020 6e65 774e 203d 2066 6674        newN = fft
+00056f70: 2e6e 6578 745f 6661 7374 5f6c 656e 284e  .next_fast_len(N
+00056f80: 2c20 5472 7565 290a 2020 2020 2020 2020  , True).        
+00056f90: 7820 3d20 6e70 2e72 5f5b 782c 206e 702e  x = np.r_[x, np.
+00056fa0: 7a65 726f 7328 286e 6577 4e20 2d20 4e2c  zeros((newN - N,
+00056fb0: 2078 2e73 6861 7065 5b31 5d29 295d 0a20   x.shape[1]))]. 
+00056fc0: 2020 2020 2020 204e 203d 206e 6577 4e0a         N = newN.
+00056fd0: 0a20 2020 2023 2043 6f6d 7075 7465 2074  .    # Compute t
+00056fe0: 6865 2046 6f75 7269 6572 2066 7265 7175  he Fourier frequ
+00056ff0: 656e 6369 6573 2028 5227 7320 7370 6563  encies (R's spec
+00057000: 2e70 6772 616d 2063 6f6e 7665 6e74 696f  .pgram conventio
+00057010: 6e20 7374 796c 6529 0a20 2020 204e 7370  n style).    Nsp
+00057020: 6563 203d 2069 6e74 286e 702e 666c 6f6f  ec = int(np.floo
+00057030: 7228 4e2f 3229 290a 2020 2020 6672 6571  r(N/2)).    freq
+00057040: 203d 2028 6e70 2e61 7261 6e67 6528 4e73   = (np.arange(Ns
+00057050: 7065 6329 202b 2031 2920 2a20 7866 7265  pec) + 1) * xfre
+00057060: 7120 2f20 4e0a 0a20 2020 2023 2054 7261  q / N..    # Tra
+00057070: 6e73 6c61 7469 6f6e 7320 746f 206b 6565  nslations to kee
+00057080: 7020 7361 6d65 2072 6f77 202f 2063 6f6c  p same row / col
+00057090: 756d 6e20 636f 6e76 656e 7469 6f6e 2061  umn convention a
+000570a0: 7320 7374 6174 733a 3a6d 7666 6674 0a20  s stats::mvfft. 
+000570b0: 2020 2078 6666 7420 3d20 6666 742e 6666     xfft = fft.ff
+000570c0: 7428 782e 5429 2e54 0a0a 2020 2020 2320  t(x.T).T..    # 
+000570d0: 436f 6d70 7574 6520 7468 6520 7065 7269  Compute the peri
+000570e0: 6f64 6f67 7261 6d20 666f 7220 6561 6368  odogram for each
+000570f0: 2069 2c20 6a0a 2020 2020 7067 7261 6d20   i, j.    pgram 
+00057100: 3d20 6e70 2e65 6d70 7479 2828 4e2c 206e  = np.empty((N, n
+00057110: 7365 722c 206e 7365 7229 2c20 6474 7970  ser, nser), dtyp
+00057120: 653d 2763 6f6d 706c 6578 2729 0a20 2020  e='complex').   
+00057130: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+00057140: 6e73 6572 293a 0a20 2020 2020 2020 2066  nser):.        f
+00057150: 6f72 206a 2069 6e20 7261 6e67 6528 6e73  or j in range(ns
+00057160: 6572 293a 0a20 2020 2020 2020 2020 2020  er):.           
+00057170: 2070 6772 616d 5b3a 2c20 692c 206a 5d20   pgram[:, i, j] 
+00057180: 3d20 7866 6674 5b3a 2c20 695d 202a 206e  = xfft[:, i] * n
+00057190: 702e 636f 6e6a 2878 6666 745b 3a2c 206a  p.conj(xfft[:, j
+000571a0: 5d29 202f 2028 4e30 202a 2078 6672 6571  ]) / (N0 * xfreq
+000571b0: 290a 2020 2020 2020 2020 2020 2020 7067  ).            pg
+000571c0: 7261 6d5b 302c 2069 2c20 6a5d 203d 2030  ram[0, i, j] = 0
+000571d0: 2e35 202a 2028 7067 7261 6d5b 312c 2069  .5 * (pgram[1, i
+000571e0: 2c20 6a5d 202b 2070 6772 616d 5b2d 312c  , j] + pgram[-1,
+000571f0: 2069 2c20 6a5d 290a 0a20 2020 2069 6620   i, j])..    if 
+00057200: 6b65 726e 656c 2069 7320 4e6f 6e65 3a0a  kernel is None:.
+00057210: 2020 2020 2020 2020 2320 5661 6c75 6573          # Values
+00057220: 2070 7265 2d61 646a 7573 746d 656e 740a   pre-adjustment.
+00057230: 2020 2020 2020 2020 6466 203d 2032 0a20          df = 2. 
+00057240: 2020 2020 2020 2062 616e 6477 6964 7468         bandwidth
+00057250: 203d 206e 702e 7371 7274 2831 202f 2031   = np.sqrt(1 / 1
+00057260: 3229 0a20 2020 2065 6c73 653a 0a20 2020  2).    else:.   
+00057270: 2020 2020 2064 6566 2063 6f6e 765f 6369       def conv_ci
+00057280: 7263 756c 6172 2873 6967 6e61 6c2c 206b  rcular(signal, k
+00057290: 6572 6e65 6c29 3a0a 2020 2020 2020 2020  ernel):.        
+000572a0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000572b0: 2020 2020 5065 7266 6f72 6d73 2031 4420      Performs 1D 
+000572c0: 6369 7263 756c 6172 2063 6f6e 766f 6c75  circular convolu
+000572d0: 7469 6f6e 2c20 696e 2074 6865 2073 616d  tion, in the sam
+000572e0: 6520 7374 796c 6520 6173 2052 3a3a 6b65  e style as R::ke
+000572f0: 726e 6170 706c 792c 0a20 2020 2020 2020  rnapply,.       
+00057300: 2020 2020 2061 7373 756d 696e 6720 7468       assuming th
+00057310: 6520 6b65 726e 656c 2077 696e 646f 7720  e kernel window 
+00057320: 6973 2063 656e 7465 7265 6420 6174 2030  is centered at 0
+00057330: 2e0a 2020 2020 2020 2020 2020 2020 2222  ..            ""
+00057340: 220a 2020 2020 2020 2020 2020 2020 7061  ".            pa
+00057350: 6420 3d20 6c65 6e28 7369 676e 616c 2920  d = len(signal) 
+00057360: 2d20 6c65 6e28 6b65 726e 656c 290a 2020  - len(kernel).  
+00057370: 2020 2020 2020 2020 2020 6861 6c66 5f77            half_w
+00057380: 696e 646f 7720 3d20 696e 7428 286c 656e  indow = int((len
+00057390: 286b 6572 6e65 6c29 202b 2031 2920 2f20  (kernel) + 1) / 
+000573a0: 3229 0a20 2020 2020 2020 2020 2020 2069  2).            i
+000573b0: 6e64 6578 6573 203d 2072 616e 6765 282d  ndexes = range(-
+000573c0: 6861 6c66 5f77 696e 646f 772c 206c 656e  half_window, len
+000573d0: 2873 6967 6e61 6c29 202d 2068 616c 665f  (signal) - half_
+000573e0: 7769 6e64 6f77 290a 2020 2020 2020 2020  window).        
+000573f0: 2020 2020 6f72 6967 5f63 6f6e 7620 3d20      orig_conv = 
+00057400: 6e70 2e72 6561 6c28 6666 742e 6966 6674  np.real(fft.ifft
+00057410: 2866 6674 2e66 6674 2873 6967 6e61 6c29  (fft.fft(signal)
+00057420: 202a 2066 6674 2e66 6674 286e 702e 725f   * fft.fft(np.r_
+00057430: 5b6e 702e 7a65 726f 7328 7061 6429 2c20  [np.zeros(pad), 
+00057440: 6b65 726e 656c 5d29 2929 0a20 2020 2020  kernel]))).     
+00057450: 2020 2020 2020 2072 6574 7572 6e20 6f72         return or
+00057460: 6967 5f63 6f6e 762e 7461 6b65 2869 6e64  ig_conv.take(ind
+00057470: 6578 6573 2c20 6d6f 6465 3d27 7772 6170  exes, mode='wrap
+00057480: 2729 0a0a 2020 2020 2020 2020 2320 436f  ')..        # Co
+00057490: 6e76 6f6c 7665 2070 6772 616d 2077 6974  nvolve pgram wit
+000574a0: 6820 6b65 726e 656c 2077 6974 6820 6369  h kernel with ci
+000574b0: 7263 756c 6172 2063 6f6e 760a 2020 2020  rcular conv.    
+000574c0: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+000574d0: 6765 286e 7365 7229 3a0a 2020 2020 2020  ge(nser):.      
+000574e0: 2020 2020 2020 666f 7220 6a20 696e 2072        for j in r
+000574f0: 616e 6765 286e 7365 7229 3a0a 2020 2020  ange(nser):.    
+00057500: 2020 2020 2020 2020 2020 2020 7067 7261              pgra
+00057510: 6d5b 3a2c 2069 2c20 6a5d 203d 2063 6f6e  m[:, i, j] = con
+00057520: 765f 6369 7263 756c 6172 2870 6772 616d  v_circular(pgram
+00057530: 5b3a 2c20 692c 206a 5d2c 206b 6572 6e65  [:, i, j], kerne
+00057540: 6c29 0a0a 2020 2020 2020 2020 6466 203d  l)..        df =
+00057550: 2032 202f 206e 702e 7375 6d28 6b65 726e   2 / np.sum(kern
+00057560: 656c 2a2a 3229 0a20 2020 2020 2020 206d  el**2).        m
+00057570: 203d 2028 6c65 6e28 6b65 726e 656c 2920   = (len(kernel) 
+00057580: 2d20 3129 2f32 0a20 2020 2020 2020 206b  - 1)/2.        k
+00057590: 203d 206e 702e 6172 616e 6765 282d 6d2c   = np.arange(-m,
+000575a0: 206d 2b31 290a 2020 2020 2020 2020 6261   m+1).        ba
+000575b0: 6e64 7769 6474 6820 3d20 6e70 2e73 7172  ndwidth = np.sqr
+000575c0: 7428 6e70 2e73 756d 2828 312f 3132 202b  t(np.sum((1/12 +
+000575d0: 206b 2a2a 3229 202a 206b 6572 6e65 6c29   k**2) * kernel)
+000575e0: 290a 0a20 2020 2064 6620 3d20 6466 2f28  )..    df = df/(
+000575f0: 7534 2f75 322a 2a32 292a 284e 302f 4e29  u4/u2**2)*(N0/N)
+00057600: 0a20 2020 2062 616e 6477 6964 7468 203d  .    bandwidth =
+00057610: 2062 616e 6477 6964 7468 202a 2078 6672   bandwidth * xfr
+00057620: 6571 2f4e 0a0a 2020 2020 2320 5265 6d6f  eq/N..    # Remo
+00057630: 7665 2070 6164 6465 6420 7265 7375 6c74  ve padded result
+00057640: 730a 2020 2020 7067 7261 6d20 3d20 7067  s.    pgram = pg
+00057650: 7261 6d5b 313a 284e 7370 6563 2b31 292c  ram[1:(Nspec+1),
+00057660: 203a 2c20 3a5d 0a0a 2020 2020 7370 6563   :, :]..    spec
+00057670: 203d 206e 702e 656d 7074 7928 284e 7370   = np.empty((Nsp
+00057680: 6563 2c20 6e73 6572 2929 0a20 2020 2066  ec, nser)).    f
+00057690: 6f72 2069 2069 6e20 7261 6e67 6528 6e73  or i in range(ns
+000576a0: 6572 293a 0a20 2020 2020 2020 2073 7065  er):.        spe
+000576b0: 635b 3a2c 2069 5d20 3d20 6e70 2e72 6561  c[:, i] = np.rea
+000576c0: 6c28 7067 7261 6d5b 3a2c 2069 2c20 695d  l(pgram[:, i, i]
+000576d0: 290a 0a20 2020 2069 6620 6e73 6572 203d  )..    if nser =
+000576e0: 3d20 313a 0a20 2020 2020 2020 2063 6f68  = 1:.        coh
+000576f0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+00057700: 7068 6173 6520 3d20 4e6f 6e65 0a20 2020  phase = None.   
+00057710: 2065 6c73 653a 0a20 2020 2020 2020 2063   else:.        c
+00057720: 6f68 203d 206e 702e 656d 7074 7928 284e  oh = np.empty((N
+00057730: 7370 6563 2c20 696e 7428 6e73 6572 202a  spec, int(nser *
+00057740: 2028 6e73 6572 202d 2031 292f 3229 2929   (nser - 1)/2)))
+00057750: 0a20 2020 2020 2020 2070 6861 7365 203d  .        phase =
+00057760: 206e 702e 656d 7074 7928 284e 7370 6563   np.empty((Nspec
+00057770: 2c20 696e 7428 6e73 6572 202a 2028 6e73  , int(nser * (ns
+00057780: 6572 202d 2031 292f 3229 2929 0a20 2020  er - 1)/2))).   
+00057790: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
+000577a0: 6e67 6528 6e73 6572 293a 0a20 2020 2020  nge(nser):.     
+000577b0: 2020 2020 2020 2066 6f72 206a 2069 6e20         for j in 
+000577c0: 7261 6e67 6528 692b 312c 206e 7365 7229  range(i+1, nser)
+000577d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000577e0: 2020 696e 6465 7820 3d20 696e 7428 6920    index = int(i 
+000577f0: 2b20 6a2a 286a 2d31 292f 3229 0a20 2020  + j*(j-1)/2).   
+00057800: 2020 2020 2020 2020 2020 2020 2063 6f68               coh
+00057810: 5b3a 2c20 696e 6465 785d 203d 206e 702e  [:, index] = np.
+00057820: 6162 7328 7067 7261 6d5b 3a2c 2069 2c20  abs(pgram[:, i, 
+00057830: 6a5d 292a 2a32 202f 2028 7370 6563 5b3a  j])**2 / (spec[:
+00057840: 2c20 695d 202a 2073 7065 635b 3a2c 206a  , i] * spec[:, j
+00057850: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00057860: 2020 2070 6861 7365 5b3a 2c20 696e 6465     phase[:, inde
+00057870: 785d 203d 206e 702e 616e 676c 6528 7067  x] = np.angle(pg
+00057880: 7261 6d5b 3a2c 2069 2c20 6a5d 290a 0a20  ram[:, i, j]).. 
+00057890: 2020 2073 7065 6320 3d20 7370 6563 202f     spec = spec /
+000578a0: 2075 320a 2020 2020 7370 6563 203d 2073   u2.    spec = s
+000578b0: 7065 632e 7371 7565 657a 6528 290a 0a20  pec.squeeze().. 
+000578c0: 2020 2072 6573 756c 7473 203d 207b 0a20     results = {. 
+000578d0: 2020 2020 2020 2027 6672 6571 273a 2066         'freq': f
+000578e0: 7265 712c 0a20 2020 2020 2020 2027 7370  req,.        'sp
+000578f0: 6563 273a 2073 7065 632c 0a20 2020 2020  ec': spec,.     
+00057900: 2020 2027 636f 6827 3a20 636f 682c 0a20     'coh': coh,. 
+00057910: 2020 2020 2020 2027 7068 6173 6527 3a20         'phase': 
+00057920: 7068 6173 652c 0a20 2020 2020 2020 2027  phase,.        '
+00057930: 6b65 726e 656c 273a 206b 6572 6e65 6c2c  kernel': kernel,
+00057940: 0a20 2020 2020 2020 2027 6466 273a 2064  .        'df': d
+00057950: 662c 0a20 2020 2020 2020 2027 6261 6e64  f,.        'band
+00057960: 7769 6474 6827 3a20 6261 6e64 7769 6474  width': bandwidt
+00057970: 682c 0a20 2020 2020 2020 2027 6e2e 7573  h,.        'n.us
+00057980: 6564 273a 204e 2c0a 2020 2020 2020 2020  ed': N,.        
+00057990: 276f 7269 672e 6e27 3a20 4e30 2c0a 2020  'orig.n': N0,.  
+000579a0: 2020 2020 2020 2774 6170 6572 273a 2074        'taper': t
+000579b0: 6170 6572 2c0a 2020 2020 2020 2020 2770  aper,.        'p
+000579c0: 6164 273a 2070 6164 2c0a 2020 2020 2020  ad': pad,.      
+000579d0: 2020 2764 6574 7265 6e64 273a 2064 6574    'detrend': det
+000579e0: 7265 6e64 2c0a 2020 2020 2020 2020 2764  rend,.        'd
+000579f0: 656d 6561 6e27 3a20 6465 6d65 616e 2c0a  emean': demean,.
+00057a00: 2020 2020 2020 2020 276d 6574 686f 6427          'method'
+00057a10: 3a20 2752 6177 2050 6572 696f 646f 6772  : 'Raw Periodogr
+00057a20: 616d 2720 6966 206b 6572 6e65 6c20 6973  am' if kernel is
+00057a30: 204e 6f6e 6520 656c 7365 2027 536d 6f6f   None else 'Smoo
+00057a40: 7468 6564 2050 6572 696f 646f 6772 616d  thed Periodogram
+00057a50: 270a 2020 2020 7d0a 0a20 2020 2069 6620  '.    }..    if 
+00057a60: 706c 6f74 3a0a 2020 2020 2020 2020 706c  plot:.        pl
+00057a70: 6f74 5f73 7065 6328 7265 7375 6c74 732c  ot_spec(results,
+00057a80: 2063 6f76 6572 6167 653d 302e 3935 2c20   coverage=0.95, 
+00057a90: 2a2a 6b77 6172 6773 290a 0a20 2020 2072  **kwargs)..    r
+00057aa0: 6574 7572 6e20 7265 7375 6c74 730a 0a64  eturn results..d
+00057ab0: 6566 2061 6c66 666d 6170 2820 782c 2066  ef alffmap( x, f
+00057ac0: 6c6f 3d30 2e30 312c 2066 6869 3d30 2e31  lo=0.01, fhi=0.1
+00057ad0: 2c20 7472 3d31 2c20 6465 7472 656e 6420  , tr=1, detrend 
+00057ae0: 3d20 5472 7565 2029 3a0a 2020 2020 2222  = True ):.    ""
+00057af0: 220a 2020 2020 416d 706c 6974 7564 6520  ".    Amplitude 
+00057b00: 6f66 204c 6f77 2046 7265 7175 656e 6379  of Low Frequency
+00057b10: 2046 6c75 6374 7561 7469 6f6e 7320 2841   Fluctuations (A
+00057b20: 4c46 463b 205a 616e 6720 6574 2061 6c2e  LFF; Zang et al.
+00057b30: 2c20 3230 3037 2920 616e 640a 2020 2020  , 2007) and.    
+00057b40: 6672 6163 7469 6f6e 616c 2041 6d70 6c69  fractional Ampli
+00057b50: 7475 6465 206f 6620 4c6f 7720 4672 6571  tude of Low Freq
+00057b60: 7565 6e63 7920 466c 7563 7475 6174 696f  uency Fluctuatio
+00057b70: 6e73 2028 662f 414c 4646 3b20 5a6f 7520  ns (f/ALFF; Zou 
+00057b80: 6574 2061 6c2e 2c20 3230 3038 290a 2020  et al., 2008).  
+00057b90: 2020 6172 6520 7265 6c61 7465 6420 6d65    are related me
+00057ba0: 6173 7572 6573 2074 6861 7420 7175 616e  asures that quan
+00057bb0: 7469 6679 2074 6865 2061 6d70 6c69 7475  tify the amplitu
+00057bc0: 6465 206f 6620 6c6f 7720 6672 6571 7565  de of low freque
+00057bd0: 6e63 790a 2020 2020 6f73 6369 6c6c 6174  ncy.    oscillat
+00057be0: 696f 6e73 2028 4c46 4f73 292e 2020 5468  ions (LFOs).  Th
+00057bf0: 6973 2066 756e 6374 696f 6e20 6f75 7470  is function outp
+00057c00: 7574 7320 414c 4646 2061 6e64 2066 414c  uts ALFF and fAL
+00057c10: 4646 2066 6f72 2074 6865 2069 6e70 7574  FF for the input
+00057c20: 2e0a 2020 2020 7361 6d65 2066 756e 6374  ..    same funct
+00057c30: 696f 6e20 696e 2041 4e54 7352 2e0a 0a20  ion in ANTsR... 
+00057c40: 2020 2078 2069 6e70 7574 2076 6563 746f     x input vecto
+00057c50: 7220 666f 7220 7468 6520 7469 6d65 2073  r for the time s
+00057c60: 6572 6965 7320 6f66 2069 6e74 6572 6573  eries of interes
+00057c70: 740a 2020 2020 666c 6f20 6c6f 7720 6672  t.    flo low fr
+00057c80: 6571 7565 6e63 792c 2074 7970 6963 616c  equency, typical
+00057c90: 6c79 2030 2e30 310a 2020 2020 6668 6920  ly 0.01.    fhi 
+00057ca0: 6869 6768 2066 7265 7175 656e 6379 2c20  high frequency, 
+00057cb0: 7479 7069 6361 6c6c 7920 302e 310a 2020  typically 0.1.  
+00057cc0: 2020 7472 2074 6865 2070 6572 696f 6420    tr the period 
+00057cd0: 6173 736f 6369 6174 6564 2077 6974 6820  associated with 
+00057ce0: 7468 6520 7665 6374 6f72 2078 2028 696e  the vector x (in
+00057cf0: 7665 7273 6520 6f66 2066 7265 7175 656e  verse of frequen
+00057d00: 6379 290a 2020 2020 6465 7472 656e 6420  cy).    detrend 
+00057d10: 6465 7472 656e 6420 7468 6520 696e 7075  detrend the inpu
+00057d20: 7420 7469 6d65 2073 6572 6965 730a 0a20  t time series.. 
+00057d30: 2020 2072 6574 7572 6e20 7665 6374 6f72     return vector
+00057d40: 2069 7320 6f75 7470 7574 2073 686f 7769   is output showi
+00057d50: 6e67 2041 4c46 4620 616e 6420 6641 4c46  ng ALFF and fALF
+00057d60: 4620 7661 6c75 6573 0a20 2020 2022 2222  F values.    """
+00057d70: 0a20 2020 2074 656d 7020 3d20 7370 6563  .    temp = spec
+00057d80: 5f70 6772 616d 2820 782c 2078 6672 6571  _pgram( x, xfreq
+00057d90: 3d31 2e30 2f74 722c 2064 656d 6561 6e3d  =1.0/tr, demean=
+00057da0: 4661 6c73 652c 2064 6574 7265 6e64 3d64  False, detrend=d
+00057db0: 6574 7265 6e64 2c20 7461 7065 723d 302c  etrend, taper=0,
+00057dc0: 2066 6173 743d 5472 7565 2c20 706c 6f74   fast=True, plot
+00057dd0: 3d46 616c 7365 2029 0a20 2020 2066 7365  =False ).    fse
+00057de0: 6c65 6374 203d 206e 702e 6c6f 6769 6361  lect = np.logica
+00057df0: 6c5f 616e 6428 2074 656d 705b 2766 7265  l_and( temp['fre
+00057e00: 7127 5d20 3e3d 2066 6c6f 2c20 7465 6d70  q'] >= flo, temp
+00057e10: 5b27 6672 6571 275d 203c 3d20 6668 6920  ['freq'] <= fhi 
+00057e20: 290a 2020 2020 6465 6e6f 6d20 3d20 2874  ).    denom = (t
+00057e30: 656d 705b 2773 7065 6327 5d29 2e73 756d  emp['spec']).sum
+00057e40: 2829 0a20 2020 206e 756d 6572 203d 2028  ().    numer = (
+00057e50: 7465 6d70 5b27 7370 6563 275d 5b66 7365  temp['spec'][fse
+00057e60: 6c65 6374 5d29 2e73 756d 2829 0a20 2020  lect]).sum().   
+00057e70: 2072 6574 7572 6e20 7b20 2027 616c 6666   return {  'alff
+00057e80: 273a 6e75 6d65 722c 2027 6661 6c66 6627  ':numer, 'falff'
+00057e90: 3a20 6e75 6d65 722f 6465 6e6f 6d20 7d0a  : numer/denom }.
+00057ea0: 0a0a 6465 6620 616c 6666 5f69 6d61 6765  ..def alff_image
+00057eb0: 2820 782c 206d 6173 6b2c 2066 6c6f 3d30  ( x, mask, flo=0
+00057ec0: 2e30 312c 2066 6869 3d30 2e31 2c20 6e75  .01, fhi=0.1, nu
+00057ed0: 6973 616e 6365 3d4e 6f6e 6520 293a 0a20  isance=None ):. 
+00057ee0: 2020 2022 2222 0a20 2020 2041 6d70 6c69     """.    Ampli
+00057ef0: 7475 6465 206f 6620 4c6f 7720 4672 6571  tude of Low Freq
+00057f00: 7565 6e63 7920 466c 7563 7475 6174 696f  uency Fluctuatio
+00057f10: 6e73 2028 414c 4646 3b20 5a61 6e67 2065  ns (ALFF; Zang e
+00057f20: 7420 616c 2e2c 2032 3030 3729 2061 6e64  t al., 2007) and
+00057f30: 0a20 2020 2066 7261 6374 696f 6e61 6c20  .    fractional 
+00057f40: 416d 706c 6974 7564 6520 6f66 204c 6f77  Amplitude of Low
+00057f50: 2046 7265 7175 656e 6379 2046 6c75 6374   Frequency Fluct
+00057f60: 7561 7469 6f6e 7320 2866 2f41 4c46 463b  uations (f/ALFF;
+00057f70: 205a 6f75 2065 7420 616c 2e2c 2032 3030   Zou et al., 200
+00057f80: 3829 0a20 2020 2061 7265 2072 656c 6174  8).    are relat
+00057f90: 6564 206d 6561 7375 7265 7320 7468 6174  ed measures that
+00057fa0: 2071 7561 6e74 6966 7920 7468 6520 616d   quantify the am
+00057fb0: 706c 6974 7564 6520 6f66 206c 6f77 2066  plitude of low f
+00057fc0: 7265 7175 656e 6379 0a20 2020 206f 7363  requency.    osc
+00057fd0: 696c 6c61 7469 6f6e 7320 284c 464f 7329  illations (LFOs)
+00057fe0: 2e20 2054 6869 7320 6675 6e63 7469 6f6e  .  This function
+00057ff0: 206f 7574 7075 7473 2041 4c46 4620 616e   outputs ALFF an
+00058000: 6420 6641 4c46 4620 666f 7220 7468 6520  d fALFF for the 
+00058010: 696e 7075 742e 0a0a 2020 2020 7820 2d20  input...    x - 
+00058020: 696e 7075 7420 636c 6561 6e20 7265 7374  input clean rest
+00058030: 696e 6720 7374 6174 6520 666d 7269 0a20  ing state fmri. 
+00058040: 2020 206d 6173 6b20 2d20 6d61 736b 206f     mask - mask o
+00058050: 7665 7220 7768 6963 6820 746f 2063 6f6d  ver which to com
+00058060: 7075 7465 2066 2f61 6c66 660a 2020 2020  pute f/alff.    
+00058070: 666c 6f20 2d20 6c6f 7720 6672 6571 7565  flo - low freque
+00058080: 6e63 792c 2074 7970 6963 616c 6c79 2030  ncy, typically 0
+00058090: 2e30 310a 2020 2020 6668 6920 2d20 6869  .01.    fhi - hi
+000580a0: 6768 2066 7265 7175 656e 6379 2c20 7479  gh frequency, ty
+000580b0: 7069 6361 6c6c 7920 302e 310a 2020 2020  pically 0.1.    
+000580c0: 6e75 6973 616e 6365 202d 206f 7074 696f  nuisance - optio
+000580d0: 6e61 6c20 6e75 6973 616e 6365 206d 6174  nal nuisance mat
+000580e0: 7269 780a 0a20 2020 2072 6574 7572 6e20  rix..    return 
+000580f0: 6469 6374 696f 6e61 7279 2077 6974 6820  dictionary with 
+00058100: 414c 4646 2061 6e64 2066 414c 4646 2069  ALFF and fALFF i
+00058110: 6d61 6765 730a 2020 2020 2222 220a 2020  mages.    """.  
+00058120: 2020 786d 6174 203d 2061 6e74 732e 7469    xmat = ants.ti
+00058130: 6d65 7365 7269 6573 5f74 6f5f 6d61 7472  meseries_to_matr
+00058140: 6978 2820 782c 206d 6173 6b20 290a 2020  ix( x, mask ).  
+00058150: 2020 6966 206e 7569 7361 6e63 6520 6973    if nuisance is
+00058160: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00058170: 2020 2078 6d61 7420 3d20 616e 7473 2e72     xmat = ants.r
+00058180: 6567 7265 7373 5f63 6f6d 706f 6e65 6e74  egress_component
+00058190: 7328 2078 6d61 742c 206e 7569 7361 6e63  s( xmat, nuisanc
+000581a0: 6520 290a 2020 2020 616c 6666 7665 6320  e ).    alffvec 
+000581b0: 3d20 786d 6174 5b30 2c3a 5d2a 300a 2020  = xmat[0,:]*0.  
+000581c0: 2020 6661 6c66 6676 6563 203d 2078 6d61    falffvec = xma
+000581d0: 745b 302c 3a5d 2a30 0a20 2020 206d 7974  t[0,:]*0.    myt
+000581e0: 7220 3d20 616e 7473 2e67 6574 5f73 7061  r = ants.get_spa
+000581f0: 6369 6e67 2820 7820 295b 335d 0a20 2020  cing( x )[3].   
+00058200: 2066 6f72 206e 2069 6e20 7261 6e67 6528   for n in range(
+00058210: 2078 6d61 742e 7368 6170 655b 315d 2029   xmat.shape[1] )
+00058220: 3a0a 2020 2020 2020 2020 7465 6d70 203d  :.        temp =
+00058230: 2061 6c66 666d 6170 2820 786d 6174 5b3a   alffmap( xmat[:
+00058240: 2c6e 5d2c 2066 6c6f 3d66 6c6f 2c20 6668  ,n], flo=flo, fh
+00058250: 693d 6668 692c 2074 723d 6d79 7472 2029  i=fhi, tr=mytr )
+00058260: 0a20 2020 2020 2020 2061 6c66 6676 6563  .        alffvec
+00058270: 5b6e 5d3d 7465 6d70 5b27 616c 6666 275d  [n]=temp['alff']
+00058280: 0a20 2020 2020 2020 2066 616c 6666 7665  .        falffve
+00058290: 635b 6e5d 3d74 656d 705b 2766 616c 6666  c[n]=temp['falff
+000582a0: 275d 0a20 2020 2061 6c66 6669 3d61 6e74  '].    alffi=ant
+000582b0: 732e 6d61 6b65 5f69 6d61 6765 2820 6d61  s.make_image( ma
+000582c0: 736b 2c20 616c 6666 7665 6320 290a 2020  sk, alffvec ).  
+000582d0: 2020 6661 6c66 6669 3d61 6e74 732e 6d61    falffi=ants.ma
+000582e0: 6b65 5f69 6d61 6765 2820 6d61 736b 2c20  ke_image( mask, 
+000582f0: 6661 6c66 6676 6563 2029 0a20 2020 2061  falffvec ).    a
+00058300: 6c66 6674 7269 6d6d 6564 6d65 616e 203d  lfftrimmedmean =
+00058310: 2063 616c 6375 6c61 7465 5f74 7269 6d6d   calculate_trimm
+00058320: 6564 5f6d 6561 6e28 2061 6c66 6676 6563  ed_mean( alffvec
+00058330: 2c20 302e 3031 2029 0a20 2020 2066 616c  , 0.01 ).    fal
+00058340: 6666 7472 696d 6d65 646d 6561 6e20 3d20  fftrimmedmean = 
+00058350: 6361 6c63 756c 6174 655f 7472 696d 6d65  calculate_trimme
+00058360: 645f 6d65 616e 2820 6661 6c66 6676 6563  d_mean( falffvec
+00058370: 2c20 302e 3031 2029 0a20 2020 2061 6c66  , 0.01 ).    alf
+00058380: 6669 3d61 6c66 6669 202f 2061 6c66 6674  fi=alffi / alfft
+00058390: 7269 6d6d 6564 6d65 616e 0a20 2020 2066  rimmedmean.    f
+000583a0: 616c 6666 693d 6661 6c66 6669 202f 2066  alffi=falffi / f
+000583b0: 616c 6666 7472 696d 6d65 646d 6561 6e0a  alfftrimmedmean.
+000583c0: 2020 2020 7265 7475 726e 207b 2020 2761      return {  'a
+000583d0: 6c66 6627 3a20 616c 6666 692c 2027 6661  lff': alffi, 'fa
+000583e0: 6c66 6627 3a20 6661 6c66 6669 207d 0a0a  lff': falffi }..
+000583f0: 0a64 6566 2064 6f77 6e32 6973 6f28 2078  .def down2iso( x
+00058400: 2c20 696e 7465 7270 6f6c 6174 696f 6e3d  , interpolation=
+00058410: 276c 696e 6561 7227 2c20 7461 6b65 6d69  'linear', takemi
+00058420: 6e3d 4661 6c73 6520 293a 0a20 2020 2022  n=False ):.    "
+00058430: 2222 0a20 2020 2077 696c 6c20 646f 776e  "".    will down
+00058440: 7361 6d70 6c65 2061 6e20 616e 6973 6f74  sample an anisot
+00058450: 726f 7069 6320 696d 6167 6520 746f 2061  ropic image to a
+00058460: 6e20 6973 6f74 726f 7069 6320 7265 736f  n isotropic reso
+00058470: 6c75 7469 6f6e 0a0a 2020 2020 783a 2069  lution..    x: i
+00058480: 6e70 7574 2069 6d61 6765 0a0a 2020 2020  nput image..    
+00058490: 696e 7465 7270 6f6c 6174 696f 6e3a 206c  interpolation: l
+000584a0: 696e 6561 7220 6f72 206e 6561 7265 7374  inear or nearest
+000584b0: 6e65 6967 6862 6f72 0a0a 2020 2020 7461  neighbor..    ta
+000584c0: 6b65 6d69 6e20 3a20 626f 6f6c 6561 6e20  kemin : boolean 
+000584d0: 6d61 7020 746f 206d 696e 2073 7061 6365  map to min space
+000584e0: 3b20 6f74 6865 7277 6973 6520 6d61 780a  ; otherwise max.
+000584f0: 0a20 2020 2072 6574 7572 6e20 696d 6167  .    return imag
+00058500: 6520 646f 776e 7361 6d70 6c65 6420 746f  e downsampled to
+00058510: 2069 736f 7472 6f70 6963 2072 6573 6f6c   isotropic resol
+00058520: 7574 696f 6e0a 2020 2020 2222 220a 2020  ution.    """.  
+00058530: 2020 7370 6320 3d20 616e 7473 2e67 6574    spc = ants.get
+00058540: 5f73 7061 6369 6e67 2820 7820 290a 2020  _spacing( x ).  
+00058550: 2020 6966 2074 616b 656d 696e 3a0a 2020    if takemin:.  
+00058560: 2020 2020 2020 6e65 7773 7063 203d 206e        newspc = n
+00058570: 702e 6173 6172 7261 7928 7370 6329 2e6d  p.asarray(spc).m
+00058580: 696e 2829 0a20 2020 2065 6c73 653a 0a20  in().    else:. 
+00058590: 2020 2020 2020 206e 6577 7370 6320 3d20         newspc = 
+000585a0: 6e70 2e61 7361 7272 6179 2873 7063 292e  np.asarray(spc).
+000585b0: 6d61 7828 290a 2020 2020 6e65 7773 7063  max().    newspc
+000585c0: 203d 206e 702e 7265 7065 6174 2820 6e65   = np.repeat( ne
+000585d0: 7773 7063 2c20 782e 6469 6d65 6e73 696f  wspc, x.dimensio
+000585e0: 6e20 290a 2020 2020 6966 2069 6e74 6572  n ).    if inter
+000585f0: 706f 6c61 7469 6f6e 203d 3d20 276c 696e  polation == 'lin
+00058600: 6561 7227 3a0a 2020 2020 2020 2020 7873  ear':.        xs
+00058610: 203d 2061 6e74 732e 7265 7361 6d70 6c65   = ants.resample
+00058620: 5f69 6d61 6765 2820 782c 206e 6577 7370  _image( x, newsp
+00058630: 632c 2069 6e74 6572 705f 7479 7065 3d30  c, interp_type=0
+00058640: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00058650: 2020 2020 7873 203d 2061 6e74 732e 7265      xs = ants.re
+00058660: 7361 6d70 6c65 5f69 6d61 6765 2820 782c  sample_image( x,
+00058670: 206e 6577 7370 632c 2069 6e74 6572 705f   newspc, interp_
+00058680: 7479 7065 3d31 290a 2020 2020 7265 7475  type=1).    retu
+00058690: 726e 2078 730a 0a0a 6465 6620 7265 6164  rn xs...def read
+000586a0: 5f6d 6d5f 6373 7628 2078 2c20 6973 5f74  _mm_csv( x, is_t
+000586b0: 313d 4661 6c73 652c 2063 6f6c 7072 6566  1=False, colpref
+000586c0: 6978 3d4e 6f6e 652c 2073 6570 6172 6174  ix=None, separat
+000586d0: 6f72 3d27 2d27 2c20 7665 7262 6f73 653d  or='-', verbose=
+000586e0: 4661 6c73 6520 293a 0a20 2020 2073 706c  False ):.    spl
+000586f0: 6974 7465 723d 6f73 2e70 6174 682e 6261  itter=os.path.ba
+00058700: 7365 6e61 6d65 2878 292e 7370 6c69 7428  sename(x).split(
+00058710: 2073 6570 6172 6174 6f72 2029 0a20 2020   separator ).   
+00058720: 206c 656e 7370 6c69 7420 3d20 6c65 6e28   lensplit = len(
+00058730: 2073 706c 6974 7465 7220 292d 310a 2020   splitter )-1.  
+00058740: 2020 7465 6d70 203d 206f 732e 7061 7468    temp = os.path
+00058750: 2e62 6173 656e 616d 6528 7829 0a20 2020  .basename(x).   
+00058760: 2074 656d 7020 3d20 6f73 2e70 6174 682e   temp = os.path.
+00058770: 7370 6c69 7465 7874 2874 656d 7029 5b30  splitext(temp)[0
+00058780: 5d0a 2020 2020 7465 6d70 203d 2072 652e  ].    temp = re.
+00058790: 7375 6228 7365 7061 7261 746f 722b 276d  sub(separator+'m
+000587a0: 6d77 6964 6527 2c27 272c 7465 6d70 290a  mwide','',temp).
+000587b0: 2020 2020 6964 636f 6c73 203d 205b 2775      idcols = ['u
+000587c0: 5f68 6965 725f 6964 272c 2773 6964 272c  _hier_id','sid',
+000587d0: 2776 6973 6974 6461 7465 272c 276d 6f64  'visitdate','mod
+000587e0: 616c 6974 7927 2c27 6d6d 696d 6167 6575  ality','mmimageu
+000587f0: 6964 272c 2774 3169 6d61 6765 7569 6427  id','t1imageuid'
+00058800: 5d0a 2020 2020 6466 203d 2070 642e 4461  ].    df = pd.Da
+00058810: 7461 4672 616d 6528 2063 6f6c 756d 6e73  taFrame( columns
+00058820: 203d 2069 6463 6f6c 732c 2069 6e64 6578   = idcols, index
+00058830: 3d72 616e 6765 2831 2920 290a 2020 2020  =range(1) ).    
+00058840: 7661 6c73 746f 6164 6420 3d20 5b74 656d  valstoadd = [tem
+00058850: 705d 202b 2073 706c 6974 7465 725b 313a  p] + splitter[1:
+00058860: 286c 656e 7370 6c69 742d 3129 5d0a 2020  (lensplit-1)].  
+00058870: 2020 6966 2069 735f 7431 3a0a 2020 2020    if is_t1:.    
+00058880: 2020 2020 7661 6c73 746f 6164 6420 3d20      valstoadd = 
+00058890: 7661 6c73 746f 6164 6420 2b20 5b73 706c  valstoadd + [spl
+000588a0: 6974 7465 725b 286c 656e 7370 6c69 742d  itter[(lensplit-
+000588b0: 3129 5d2c 7370 6c69 7474 6572 5b28 6c65  1)],splitter[(le
+000588c0: 6e73 706c 6974 2d31 295d 5d0a 2020 2020  nsplit-1)]].    
+000588d0: 656c 7365 3a0a 2020 2020 2020 2020 7370  else:.        sp
+000588e0: 6c69 7432 3d73 706c 6974 7465 725b 286c  lit2=splitter[(l
+000588f0: 656e 7370 6c69 742d 3129 5d2e 7370 6c69  ensplit-1)].spli
+00058900: 7428 2022 5f22 2029 0a20 2020 2020 2020  t( "_" ).       
+00058910: 2069 6620 6c65 6e28 7370 6c69 7432 2920   if len(split2) 
+00058920: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
+00058930: 2020 7370 6c69 7432 2e61 7070 656e 6428    split2.append(
+00058940: 2073 706c 6974 325b 305d 2029 0a20 2020   split2[0] ).   
+00058950: 2020 2020 2069 6620 6c65 6e28 7661 6c73       if len(vals
+00058960: 746f 6164 6429 203d 3d20 333a 0a20 2020  toadd) == 3:.   
+00058970: 2020 2020 2020 2020 2076 616c 7374 6f61           valstoa
+00058980: 6464 203d 2076 616c 7374 6f61 6464 202b  dd = valstoadd +
+00058990: 205b 7370 6c69 7432 5b30 5d5d 202b 205b   [split2[0]] + [
+000589a0: 6d61 7468 2e6e 616e 5d20 2b20 5b73 706c  math.nan] + [spl
+000589b0: 6974 325b 315d 5d0a 2020 2020 2020 2020  it2[1]].        
+000589c0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000589d0: 2020 7661 6c73 746f 6164 6420 3d20 7661    valstoadd = va
+000589e0: 6c73 746f 6164 6420 2b20 5b73 706c 6974  lstoadd + [split
+000589f0: 325b 305d 2c73 706c 6974 325b 315d 5d0a  2[0],split2[1]].
+00058a00: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
+00058a10: 2020 2020 2020 2020 7072 696e 7428 2076          print( v
+00058a20: 616c 7374 6f61 6464 2029 0a20 2020 2064  alstoadd ).    d
+00058a30: 662e 696c 6f63 5b30 5d20 3d20 7661 6c73  f.iloc[0] = vals
+00058a40: 746f 6164 640a 2020 2020 6966 2076 6572  toadd.    if ver
+00058a50: 626f 7365 3a0a 2020 2020 2020 2020 7072  bose:.        pr
+00058a60: 696e 7428 2022 7265 6164 2078 6466 3a20  int( "read xdf: 
+00058a70: 2220 2b20 7820 290a 2020 2020 7864 6620  " + x ).    xdf 
+00058a80: 3d20 7064 2e72 6561 645f 6373 7628 2078  = pd.read_csv( x
+00058a90: 2029 0a20 2020 2064 662e 7265 7365 745f   ).    df.reset_
+00058aa0: 696e 6465 7828 290a 2020 2020 7864 662e  index().    xdf.
+00058ab0: 7265 7365 745f 696e 6465 7828 6472 6f70  reset_index(drop
+00058ac0: 3d54 7275 6529 0a20 2020 2069 6620 2255  =True).    if "U
+00058ad0: 6e6e 616d 6564 3a20 3022 2069 6e20 7864  nnamed: 0" in xd
+00058ae0: 662e 636f 6c75 6d6e 733a 0a20 2020 2020  f.columns:.     
+00058af0: 2020 2068 6f6c 6465 723d 7864 662e 706f     holder=xdf.po
+00058b00: 7028 2022 556e 6e61 6d65 643a 2030 2220  p( "Unnamed: 0" 
+00058b10: 290a 2020 2020 6966 2022 556e 6e61 6d65  ).    if "Unname
+00058b20: 643a 2031 2220 696e 2078 6466 2e63 6f6c  d: 1" in xdf.col
+00058b30: 756d 6e73 3a0a 2020 2020 2020 2020 686f  umns:.        ho
+00058b40: 6c64 6572 3d78 6466 2e70 6f70 2820 2255  lder=xdf.pop( "U
+00058b50: 6e6e 616d 6564 3a20 3122 2029 0a20 2020  nnamed: 1" ).   
+00058b60: 2069 6620 2275 5f68 6965 725f 6964 2e31   if "u_hier_id.1
+00058b70: 2220 696e 2078 6466 2e63 6f6c 756d 6e73  " in xdf.columns
+00058b80: 3a0a 2020 2020 2020 2020 686f 6c64 6572  :.        holder
+00058b90: 3d78 6466 2e70 6f70 2820 2275 5f68 6965  =xdf.pop( "u_hie
+00058ba0: 725f 6964 2e31 2220 290a 2020 2020 6966  r_id.1" ).    if
+00058bb0: 2022 755f 6869 6572 5f69 6422 2069 6e20   "u_hier_id" in 
+00058bc0: 7864 662e 636f 6c75 6d6e 733a 0a20 2020  xdf.columns:.   
+00058bd0: 2020 2020 2068 6f6c 6465 723d 7864 662e       holder=xdf.
+00058be0: 706f 7028 2022 755f 6869 6572 5f69 6422  pop( "u_hier_id"
+00058bf0: 2029 0a20 2020 2069 6620 6e6f 7420 6973   ).    if not is
+00058c00: 5f74 313a 0a20 2020 2020 2020 2069 6620  _t1:.        if 
+00058c10: 2772 6573 6e65 7447 7261 6465 2720 696e  'resnetGrade' in
+00058c20: 2078 6466 2e63 6f6c 756d 6e73 3a0a 2020   xdf.columns:.  
+00058c30: 2020 2020 2020 2020 2020 696e 6465 785f            index_
+00058c40: 6e6f 203d 2078 6466 2e63 6f6c 756d 6e73  no = xdf.columns
+00058c50: 2e67 6574 5f6c 6f63 2827 7265 736e 6574  .get_loc('resnet
+00058c60: 4772 6164 6527 290a 2020 2020 2020 2020  Grade').        
+00058c70: 2020 2020 7864 6620 3d20 7864 662e 6472      xdf = xdf.dr
+00058c80: 6f70 2820 7864 662e 636f 6c75 6d6e 735b  op( xdf.columns[
+00058c90: 7261 6e67 6528 696e 6465 785f 6e6f 2b31  range(index_no+1
+00058ca0: 295d 202c 2061 7869 733d 3129 0a0a 2020  )] , axis=1)..  
+00058cb0: 2020 6966 2078 6466 2e73 6861 7065 5b30    if xdf.shape[0
+00058cc0: 5d20 3d3d 2032 3a0a 2020 2020 2020 2020  ] == 2:.        
+00058cd0: 7864 6663 6f6c 7320 3d20 7864 662e 636f  xdfcols = xdf.co
+00058ce0: 6c75 6d6e 730a 2020 2020 2020 2020 7864  lumns.        xd
+00058cf0: 6620 3d20 7864 662e 696c 6f63 5b31 5d0a  f = xdf.iloc[1].
+00058d00: 2020 2020 2020 2020 6464 6e75 6d20 3d20          ddnum = 
+00058d10: 7864 662e 746f 5f6e 756d 7079 2829 0a20  xdf.to_numpy(). 
+00058d20: 2020 2020 2020 2064 646e 756d 203d 2064         ddnum = d
+00058d30: 646e 756d 2e72 6573 6861 7065 285b 312c  dnum.reshape([1,
+00058d40: 6464 6e75 6d2e 7368 6170 655b 305d 5d29  ddnum.shape[0]])
+00058d50: 0a20 2020 2020 2020 206e 6577 636f 6c6e  .        newcoln
+00058d60: 616d 6573 203d 2078 6466 2e69 6e64 6578  ames = xdf.index
+00058d70: 2e74 6f5f 6c69 7374 2829 0a20 2020 2020  .to_list().     
+00058d80: 2020 2069 6620 6c65 6e28 6e65 7763 6f6c     if len(newcol
+00058d90: 6e61 6d65 7329 2021 3d20 6464 6e75 6d2e  names) != ddnum.
+00058da0: 7368 6170 655b 315d 3a0a 2020 2020 2020  shape[1]:.      
+00058db0: 2020 2020 2020 7072 696e 7428 2243 616e        print("Can
+00058dc0: 6e6f 7420 4d65 7267 6520 3a20 5368 6170  not Merge : Shap
+00058dd0: 6520 4d69 734d 6174 6368 2022 202b 2073  e MisMatch " + s
+00058de0: 7472 2820 6c65 6e28 6e65 7763 6f6c 6e61  tr( len(newcolna
+00058df0: 6d65 7329 2029 202b 2022 2022 202b 2073  mes) ) + " " + s
+00058e00: 7472 2864 646e 756d 2e73 6861 7065 5b31  tr(ddnum.shape[1
+00058e10: 5d29 290a 2020 2020 2020 2020 656c 7365  ])).        else
+00058e20: 3a0a 2020 2020 2020 2020 2020 2020 7864  :.            xd
+00058e30: 6620 3d20 7064 2e44 6174 6146 7261 6d65  f = pd.DataFrame
+00058e40: 2864 646e 756d 2c20 636f 6c75 6d6e 733d  (ddnum, columns=
+00058e50: 7864 6663 6f6c 7320 290a 2020 2020 6966  xdfcols ).    if
+00058e60: 2078 6466 2e73 6861 7065 5b31 5d20 3d3d   xdf.shape[1] ==
+00058e70: 2030 3a0a 2020 2020 2020 2020 7265 7475   0:.        retu
+00058e80: 726e 204e 6f6e 650a 2020 2020 6966 2063  rn None.    if c
+00058e90: 6f6c 7072 6566 6978 2069 7320 6e6f 7420  olprefix is not 
+00058ea0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7864  None:.        xd
+00058eb0: 662e 636f 6c75 6d6e 733d 636f 6c70 7265  f.columns=colpre
+00058ec0: 6669 7820 2b20 7864 662e 636f 6c75 6d6e  fix + xdf.column
+00058ed0: 730a 2020 2020 7265 7475 726e 2070 642e  s.    return pd.
+00058ee0: 636f 6e63 6174 2820 5b64 662c 7864 665d  concat( [df,xdf]
+00058ef0: 2c20 6178 6973 3d31 2c20 6967 6e6f 7265  , axis=1, ignore
+00058f00: 5f69 6e64 6578 3d46 616c 7365 2029 0a0a  _index=False )..
+00058f10: 6465 6620 6d65 7267 655f 7769 6465 735f  def merge_wides_
+00058f20: 746f 5f73 7475 6479 5f64 6174 6166 7261  to_study_datafra
+00058f30: 6d65 2820 7364 662c 2070 726f 6365 7373  me( sdf, process
+00058f40: 696e 675f 6469 722c 2073 6570 6172 6174  ing_dir, separat
+00058f50: 6f72 3d27 2d27 2c20 7369 645f 6973 5f69  or='-', sid_is_i
+00058f60: 6e74 3d54 7275 652c 2069 645f 6973 5f69  nt=True, id_is_i
+00058f70: 6e74 3d54 7275 652c 2064 6174 655f 6973  nt=True, date_is
+00058f80: 5f69 6e74 3d54 7275 652c 2072 6570 6f72  _int=True, repor
+00058f90: 745f 6d69 7373 696e 673d 4661 6c73 652c  t_missing=False,
+00058fa0: 0a70 726f 6772 6573 733d 4661 6c73 652c  .progress=False,
+00058fb0: 2076 6572 626f 7365 3d46 616c 7365 2029   verbose=False )
+00058fc0: 3a0a 2020 2020 2222 220a 2020 2020 6578  :.    """.    ex
+00058fd0: 7465 6e64 2061 2073 7475 6479 2064 6174  tend a study dat
+00058fe0: 6120 6672 616d 6520 7769 7468 2077 6964  a frame with wid
+00058ff0: 6520 6f75 7470 7574 730a 0a20 2020 2073  e outputs..    s
+00059000: 6466 203a 2074 6865 2069 6e70 7574 2073  df : the input s
+00059010: 7475 6479 2064 6174 6166 7261 6d65 2066  tudy dataframe f
+00059020: 726f 6d20 616e 7473 7079 6d6d 2051 4320  rom antspymm QC 
+00059030: 6f75 7470 7574 0a0a 2020 2020 7072 6f63  output..    proc
+00059040: 6573 7369 6e67 5f64 6972 3a20 2074 6865  essing_dir:  the
+00059050: 2064 6972 6563 746f 7279 206c 6f63 6174   directory locat
+00059060: 696f 6e20 6f66 2074 6865 2070 726f 6365  ion of the proce
+00059070: 7373 6564 2064 6174 6120 0a0a 2020 2020  ssed data ..    
+00059080: 7365 7061 7261 746f 7220 3a20 7374 7269  separator : stri
+00059090: 6e67 2075 7375 616c 6c79 2027 2d27 206f  ng usually '-' o
+000590a0: 7220 275f 270a 0a20 2020 2073 6964 5f69  r '_'..    sid_i
+000590b0: 735f 696e 7420 3a20 626f 6f6c 6561 6e20  s_int : boolean 
+000590c0: 7365 7420 746f 2054 7275 6520 746f 2063  set to True to c
+000590d0: 6173 7420 756e 6971 7565 2073 7562 6a65  ast unique subje
+000590e0: 6374 2069 6473 2074 6f20 696e 743b 2063  ct ids to int; c
+000590f0: 616e 2062 6520 7573 6566 756c 2069 6620  an be useful if 
+00059100: 7468 6579 2061 7265 2069 6e61 6476 6572  they are inadver
+00059110: 7465 6e74 6c79 2073 746f 7265 6420 6173  tently stored as
+00059120: 2066 6c6f 6174 2062 7920 7061 6e64 6173   float by pandas
+00059130: 0a0a 2020 2020 6461 7465 5f69 735f 696e  ..    date_is_in
+00059140: 7420 3a20 626f 6f6c 6561 6e20 7365 7420  t : boolean set 
+00059150: 746f 2054 7275 6520 746f 2063 6173 7420  to True to cast 
+00059160: 6461 7465 2074 6f20 696e 743b 2063 616e  date to int; can
+00059170: 2062 6520 7573 6566 756c 2069 6620 7468   be useful if th
+00059180: 6579 2061 7265 2069 6e61 6476 6572 7465  ey are inadverte
+00059190: 6e74 6c79 2073 746f 7265 6420 6173 2066  ntly stored as f
+000591a0: 6c6f 6174 2062 7920 7061 6e64 6173 0a0a  loat by pandas..
+000591b0: 2020 2020 6964 5f69 735f 696e 7420 3a20      id_is_int : 
+000591c0: 626f 6f6c 6561 6e20 7365 7420 746f 2054  boolean set to T
+000591d0: 7275 6520 746f 2063 6173 7420 756e 6971  rue to cast uniq
+000591e0: 7565 2069 6d61 6765 2069 6473 2074 6f20  ue image ids to 
+000591f0: 696e 743b 2063 616e 2062 6520 7573 6566  int; can be usef
+00059200: 756c 2069 6620 7468 6579 2061 7265 2069  ul if they are i
+00059210: 6e61 6476 6572 7465 6e74 6c79 2073 746f  nadvertently sto
+00059220: 7265 6420 6173 2066 6c6f 6174 2062 7920  red as float by 
+00059230: 7061 6e64 6173 0a0a 2020 2020 7265 706f  pandas..    repo
+00059240: 7274 5f6d 6973 7369 6e67 203a 2062 6f6f  rt_missing : boo
+00059250: 6c65 616e 2063 6f6d 6269 6e65 6420 7769  lean combined wi
+00059260: 7468 2076 6572 626f 7365 2077 696c 6c20  th verbose will 
+00059270: 7265 706f 7274 206d 6973 7369 6e67 206d  report missing m
+00059280: 6f64 616c 6974 6965 730a 0a20 2020 2070  odalities..    p
+00059290: 726f 6772 6573 7320 3a20 696e 7465 6765  rogress : intege
+000592a0: 7220 7265 706f 7274 7320 7065 7263 656e  r reports percen
+000592b0: 7420 7072 6f67 7265 7373 206d 6f64 756c  t progress modul
+000592c0: 6f20 7072 6f67 7265 7373 2076 616c 7565  o progress value
+000592d0: 200a 0a20 2020 2076 6572 626f 7365 203a   ..    verbose :
+000592e0: 2062 6f6f 6c65 616e 0a20 2020 2022 2222   boolean.    """
+000592f0: 0a20 2020 2066 726f 6d20 6f73 2e70 6174  .    from os.pat
+00059300: 6820 696d 706f 7274 2065 7869 7374 730a  h import exists.
+00059310: 2020 2020 6d75 7374 6861 7665 636f 6c73      musthavecols
+00059320: 203d 205b 2770 726f 6a65 6374 4944 272c   = ['projectID',
+00059330: 2027 7375 626a 6563 7449 4427 2c27 6461   'subjectID','da
+00059340: 7465 272c 2769 6d61 6765 4944 275d 0a20  te','imageID']. 
+00059350: 2020 2066 6f72 206b 2069 6e20 7261 6e67     for k in rang
+00059360: 6528 6c65 6e28 6d75 7374 6861 7665 636f  e(len(musthaveco
+00059370: 6c73 2929 3a0a 2020 2020 2020 2020 6966  ls)):.        if
+00059380: 206e 6f74 206d 7573 7468 6176 6563 6f6c   not musthavecol
+00059390: 735b 6b5d 2069 6e20 7364 662e 6b65 7973  s[k] in sdf.keys
+000593a0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+000593b0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+000593c0: 2827 7364 6620 6973 206d 6973 7369 6e67  ('sdf is missing
+000593d0: 2063 6f6c 756d 6e20 2720 2b6d 7573 7468   column ' +musth
+000593e0: 6176 6563 6f6c 735b 6b5d 202b 2027 2069  avecols[k] + ' i
+000593f0: 6e20 6d65 7267 655f 7769 6465 735f 746f  n merge_wides_to
+00059400: 5f73 7475 6479 5f64 6174 6166 7261 6d65  _study_dataframe
+00059410: 2720 290a 2020 2020 706f 7373 6962 6c65  ' ).    possible
+00059420: 5f69 6964 7320 3d20 5b20 2769 6d61 6765  _iids = [ 'image
+00059430: 4944 272c 2027 696d 6167 6549 4427 2c20  ID', 'imageID', 
+00059440: 2769 6d61 6765 4944 272c 2027 666c 6169  'imageID', 'flai
+00059450: 7269 6427 2c20 2764 7469 6431 272c 2027  rid', 'dtid1', '
+00059460: 6474 6964 3227 2c20 2772 7366 6964 3127  dtid2', 'rsfid1'
+00059470: 2c20 2772 7366 6964 3227 2c20 276e 6d69  , 'rsfid2', 'nmi
+00059480: 6431 272c 2027 6e6d 6964 3227 2c20 276e  d1', 'nmid2', 'n
+00059490: 6d69 6433 272c 2027 6e6d 6964 3427 2c20  mid3', 'nmid4', 
+000594a0: 276e 6d69 6435 272c 2027 6e6d 6964 3627  'nmid5', 'nmid6'
+000594b0: 2c20 276e 6d69 6437 272c 2027 6e6d 6964  , 'nmid7', 'nmid
+000594c0: 3827 2c20 276e 6d69 6439 272c 2027 6e6d  8', 'nmid9', 'nm
+000594d0: 6964 3130 272c 2027 7065 7266 6964 2720  id10', 'perfid' 
+000594e0: 5d0a 2020 2020 6d6f 6461 6c69 7479 5f69  ].    modality_i
+000594f0: 6473 203d 205b 2027 5431 7748 6965 7261  ds = [ 'T1wHiera
+00059500: 7263 6869 6361 6c27 2c20 2754 3177 4869  rchical', 'T1wHi
+00059510: 6572 6172 6368 6963 616c 5352 272c 2027  erarchicalSR', '
+00059520: 5431 7727 2c20 2754 3246 6c61 6972 272c  T1w', 'T2Flair',
+00059530: 2027 4454 4927 2c20 2744 5449 272c 2027   'DTI', 'DTI', '
+00059540: 7273 664d 5249 272c 2027 7273 664d 5249  rsfMRI', 'rsfMRI
+00059550: 272c 2027 4e4d 3244 4d54 272c 2027 4e4d  ', 'NM2DMT', 'NM
+00059560: 3244 4d54 272c 2027 4e4d 3244 4d54 272c  2DMT', 'NM2DMT',
+00059570: 2027 4e4d 3244 4d54 272c 2027 4e4d 3244   'NM2DMT', 'NM2D
+00059580: 4d54 272c 2027 4e4d 3244 4d54 272c 2027  MT', 'NM2DMT', '
+00059590: 4e4d 3244 4d54 272c 2027 4e4d 3244 4d54  NM2DMT', 'NM2DMT
+000595a0: 272c 2027 4e4d 3244 4d54 272c 2027 4e4d  ', 'NM2DMT', 'NM
+000595b0: 3244 4d54 272c 2027 7065 7266 275d 0a20  2DMT', 'perf']. 
+000595c0: 2020 2061 6c6c 6466 3d70 642e 4461 7461     alldf=pd.Data
+000595d0: 4672 616d 6528 290a 2020 2020 666f 7220  Frame().    for 
+000595e0: 6d79 6b20 696e 2073 6466 2e69 6e64 6578  myk in sdf.index
+000595f0: 3a0a 2020 2020 2020 2020 6966 2070 726f  :.        if pro
+00059600: 6772 6573 7320 3e20 3020 616e 6420 696e  gress > 0 and in
+00059610: 7428 6d79 6b29 2025 2069 6e74 2870 726f  t(myk) % int(pro
+00059620: 6772 6573 7329 203d 3d20 303a 0a20 2020  gress) == 0:.   
+00059630: 2020 2020 2020 2020 2070 7269 6e74 2820           print( 
+00059640: 7374 7228 2072 6f75 6e64 2820 6d79 6b2f  str( round( myk/
+00059650: 7364 662e 7368 6170 655b 305d 2a31 3030  sdf.shape[0]*100
+00059660: 2e30 2929 202b 2022 252e 2e2e 222c 2065  .0)) + "%...", e
+00059670: 6e64 3d27 272c 2066 6c75 7368 3d54 7275  nd='', flush=Tru
+00059680: 6529 0a20 2020 2020 2020 2069 6620 7665  e).        if ve
+00059690: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
+000596a0: 2020 2070 7269 6e74 2820 2244 4f52 4f57     print( "DOROW
+000596b0: 2022 202b 2073 7472 286d 796b 2920 2b20   " + str(myk) + 
+000596c0: 2720 6f66 2027 202b 2073 7472 2820 7364  ' of ' + str( sd
+000596d0: 662e 7368 6170 655b 305d 2029 2029 0a20  f.shape[0] ) ). 
+000596e0: 2020 2020 2020 2063 7376 726f 7720 3d20         csvrow = 
+000596f0: 7364 662e 6c6f 635b 7364 662e 696e 6465  sdf.loc[sdf.inde
+00059700: 7820 3d3d 206d 796b 5d2e 6472 6f70 6e61  x == myk].dropna
+00059710: 2861 7869 733d 3129 0a20 2020 2020 2020  (axis=1).       
+00059720: 2063 743d 2d31 0a20 2020 2020 2020 2066   ct=-1.        f
+00059730: 6f72 2069 6964 6b65 7920 696e 2070 6f73  or iidkey in pos
+00059740: 7369 626c 655f 6969 6473 3a0a 2020 2020  sible_iids:.    
+00059750: 2020 2020 2020 2020 6374 3d63 742b 310a          ct=ct+1.
+00059760: 2020 2020 2020 2020 2020 2020 6d6f 645f              mod_
+00059770: 6e61 6d65 203d 206d 6f64 616c 6974 795f  name = modality_
+00059780: 6964 735b 6374 5d0a 2020 2020 2020 2020  ids[ct].        
+00059790: 2020 2020 6966 2069 6964 6b65 7920 696e      if iidkey in
+000597a0: 2063 7376 726f 772e 6b65 7973 2829 3a0a   csvrow.keys():.
+000597b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000597c0: 6966 2069 645f 6973 5f69 6e74 3a0a 2020  if id_is_int:.  
+000597d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000597e0: 2020 6969 6420 3d20 7374 7228 2069 6e74    iid = str( int
+000597f0: 2820 6373 7672 6f77 5b69 6964 6b65 795d  ( csvrow[iidkey]
+00059800: 2e69 6c6f 635b 305d 2029 2029 0a20 2020  .iloc[0] ) ).   
+00059810: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00059820: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00059830: 2020 2020 2020 2069 6964 203d 2073 7472         iid = str
+00059840: 2820 6373 7672 6f77 5b69 6964 6b65 795d  ( csvrow[iidkey]
+00059850: 2e69 6c6f 635b 305d 2029 0a20 2020 2020  .iloc[0] ).     
+00059860: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
+00059870: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
+00059880: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00059890: 2820 2269 6964 6b65 7920 2220 2b20 6969  ( "iidkey " + ii
+000598a0: 646b 6579 202b 2022 206d 6f64 616c 6974  dkey + " modalit
+000598b0: 7920 2220 2b20 6d6f 645f 6e61 6d65 202b  y " + mod_name +
+000598c0: 2027 2069 6964 2027 2b20 6969 6420 290a   ' iid '+ iid ).
+000598d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000598e0: 7069 643d 7374 7228 6373 7672 6f77 5b27  pid=str(csvrow['
+000598f0: 7072 6f6a 6563 7449 4427 5d2e 696c 6f63  projectID'].iloc
+00059900: 5b30 5d20 290a 2020 2020 2020 2020 2020  [0] ).          
+00059910: 2020 2020 2020 6966 2073 6964 5f69 735f        if sid_is_
+00059920: 696e 743a 0a20 2020 2020 2020 2020 2020  int:.           
+00059930: 2020 2020 2020 2020 2073 6964 3d73 7472           sid=str
+00059940: 2869 6e74 2863 7376 726f 775b 2773 7562  (int(csvrow['sub
+00059950: 6a65 6374 4944 275d 2e69 6c6f 635b 305d  jectID'].iloc[0]
+00059960: 2029 290a 2020 2020 2020 2020 2020 2020   )).            
+00059970: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00059980: 2020 2020 2020 2020 2020 2020 2020 7369                si
+00059990: 643d 7374 7228 6373 7672 6f77 5b27 7375  d=str(csvrow['su
+000599a0: 626a 6563 7449 4427 5d2e 696c 6f63 5b30  bjectID'].iloc[0
+000599b0: 5d20 290a 2020 2020 2020 2020 2020 2020  ] ).            
+000599c0: 2020 2020 6966 2064 6174 655f 6973 5f69      if date_is_i
+000599d0: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
+000599e0: 2020 2020 2020 2020 6474 3d73 7472 2869          dt=str(i
+000599f0: 6e74 2863 7376 726f 775b 2764 6174 6527  nt(csvrow['date'
+00059a00: 5d2e 696c 6f63 5b30 5d29 290a 2020 2020  ].iloc[0])).    
+00059a10: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00059a20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00059a30: 2020 2020 2020 6474 3d73 7472 2863 7376        dt=str(csv
+00059a40: 726f 775b 2764 6174 6527 5d2e 696c 6f63  row['date'].iloc
+00059a50: 5b30 5d29 0a20 2020 2020 2020 2020 2020  [0]).           
+00059a60: 2020 2020 2069 6620 6964 5f69 735f 696e       if id_is_in
+00059a70: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00059a80: 2020 2020 2020 2074 3169 6964 3d73 7472         t1iid=str
+00059a90: 2869 6e74 2863 7376 726f 775b 2769 6d61  (int(csvrow['ima
+00059aa0: 6765 4944 275d 2e69 6c6f 635b 305d 2929  geID'].iloc[0]))
+00059ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00059ac0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00059ad0: 2020 2020 2020 2020 2020 2074 3169 6964             t1iid
+00059ae0: 3d73 7472 2863 7376 726f 775b 2769 6d61  =str(csvrow['ima
+00059af0: 6765 4944 275d 2e69 6c6f 635b 305d 290a  geID'].iloc[0]).
+00059b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059b10: 6966 2074 3169 6964 2021 3d20 6969 643a  if t1iid != iid:
+00059b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00059b30: 2020 2020 2069 6964 6a3d 6969 642b 225f       iidj=iid+"_
+00059b40: 222b 7431 6969 640a 2020 2020 2020 2020  "+t1iid.        
+00059b50: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00059b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059b70: 2020 6969 646a 3d69 6964 0a20 2020 2020    iidj=iid.     
+00059b80: 2020 2020 2020 2020 2020 2072 6f6f 7469             rooti
+00059b90: 6420 3d20 7069 6420 2b73 6570 6172 6174  d = pid +separat
+00059ba0: 6f72 2b20 7369 6420 2b73 6570 6172 6174  or+ sid +separat
+00059bb0: 6f72 2b64 742b 7365 7061 7261 746f 722b  or+dt+separator+
+00059bc0: 6d6f 645f 6e61 6d65 2b73 6570 6172 6174  mod_name+separat
+00059bd0: 6f72 2b69 6964 6a0a 2020 2020 2020 2020  or+iidj.        
+00059be0: 2020 2020 2020 2020 6d79 6578 7420 3d20          myext = 
+00059bf0: 726f 6f74 6964 202b 7365 7061 7261 746f  rootid +separato
+00059c00: 722b 276d 6d77 6964 652e 6373 7627 0a20  r+'mmwide.csv'. 
+00059c10: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00059c20: 7267 7769 6465 666e 3d6f 732e 7061 7468  rgwidefn=os.path
+00059c30: 2e6a 6f69 6e28 2070 726f 6365 7373 696e  .join( processin
+00059c40: 675f 6469 722c 2070 6964 2c20 7369 642c  g_dir, pid, sid,
+00059c50: 2064 742c 206d 6f64 5f6e 616d 652c 2069   dt, mod_name, i
+00059c60: 6964 2c20 6d79 6578 7420 290a 2020 2020  id, myext ).    
+00059c70: 2020 2020 2020 2020 2020 2020 6d6f 6464              modd
+00059c80: 6572 7375 6220 3d20 6d6f 645f 6e61 6d65  ersub = mod_name
+00059c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00059ca0: 2069 735f 7431 3d46 616c 7365 0a20 2020   is_t1=False.   
+00059cb0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00059cc0: 6d6f 645f 6e61 6d65 203d 3d20 2754 3177  mod_name == 'T1w
+00059cd0: 4869 6572 6172 6368 6963 616c 273a 0a20  Hierarchical':. 
+00059ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059cf0: 2020 2069 735f 7431 3d54 7275 650a 2020     is_t1=True.  
+00059d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059d10: 2020 6d6f 6464 6572 7375 623d 2754 3148    moddersub='T1H
+00059d20: 6965 7227 0a20 2020 2020 2020 2020 2020  ier'.           
+00059d30: 2020 2020 2065 6c69 6620 6d6f 645f 6e61       elif mod_na
+00059d40: 6d65 203d 3d20 2754 3177 4869 6572 6172  me == 'T1wHierar
+00059d50: 6368 6963 616c 5352 273a 0a20 2020 2020  chicalSR':.     
+00059d60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00059d70: 735f 7431 3d54 7275 650a 2020 2020 2020  s_t1=True.      
+00059d80: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+00059d90: 6464 6572 7375 623d 2754 3148 5352 270a  ddersub='T1HSR'.
+00059da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059db0: 6966 2065 7869 7374 7328 206e 7267 7769  if exists( nrgwi
+00059dc0: 6465 666e 2029 3a0a 2020 2020 2020 2020  defn ):.        
+00059dd0: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+00059de0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+00059df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059e00: 7072 696e 7428 206e 7267 7769 6465 666e  print( nrgwidefn
+00059e10: 202b 2022 2065 7869 7374 7322 290a 2020   + " exists").  
+00059e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059e30: 2020 6d6d 3d72 6561 645f 6d6d 5f63 7376    mm=read_mm_csv
+00059e40: 2820 6e72 6777 6964 6566 6e2c 2063 6f6c  ( nrgwidefn, col
+00059e50: 7072 6566 6978 3d6d 6f64 6465 7273 7562  prefix=moddersub
+00059e60: 2b27 5f27 2c20 6973 5f74 313d 6973 5f74  +'_', is_t1=is_t
+00059e70: 312c 2073 6570 6172 6174 6f72 3d73 6570  1, separator=sep
+00059e80: 6172 6174 6f72 2c20 7665 7262 6f73 653d  arator, verbose=
+00059e90: 7665 7262 6f73 6520 290a 2020 2020 2020  verbose ).      
+00059ea0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00059eb0: 206d 6d20 6973 206e 6f74 204e 6f6e 653a   mm is not None:
+00059ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00059ed0: 2020 2020 2020 2020 2069 6620 6d6f 645f           if mod_
+00059ee0: 6e61 6d65 203d 3d20 2754 3177 4869 6572  name == 'T1wHier
+00059ef0: 6172 6368 6963 616c 273a 0a20 2020 2020  archical':.     
+00059f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059f10: 2020 2020 2020 2061 3d6c 6973 7428 2063         a=list( c
+00059f20: 7376 726f 772e 6b65 7973 2829 2029 0a20  svrow.keys() ). 
+00059f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059f40: 2020 2020 2020 2020 2020 2062 3d6c 6973             b=lis
+00059f50: 7428 206d 6d2e 6b65 7973 2829 2029 0a20  t( mm.keys() ). 
+00059f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059f70: 2020 2020 2020 2020 2020 2061 6269 6e74             abint
+00059f80: 6572 7365 6374 3d6c 6973 7428 7365 7428  ersect=list(set(
+00059f90: 6229 2e69 6e74 6572 7365 6374 696f 6e28  b).intersection(
+00059fa0: 2073 6574 2861 2920 2920 290a 2020 2020   set(a) ) ).    
+00059fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059fc0: 2020 2020 2020 2020 6966 206c 656e 2820          if len( 
+00059fd0: 6162 696e 7465 7273 6563 7420 2029 203e  abintersect  ) >
+00059fe0: 2030 203a 0a20 2020 2020 2020 2020 2020   0 :.           
+00059ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005a000: 2020 2020 2066 6f72 2071 7120 696e 2061       for qq in a
+0005a010: 6269 6e74 6572 7365 6374 3a0a 2020 2020  bintersect:.    
+0005a020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005a040: 6d6d 2e70 6f70 2820 7171 2029 0a20 2020  mm.pop( qq ).   
+0005a050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005a060: 2020 2020 2023 206d 6d2e 696e 6465 783d       # mm.index=
+0005a070: 6373 7672 6f77 2e69 6e64 6578 0a20 2020  csvrow.index.   
+0005a080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005a090: 2020 2020 2075 6964 6e61 6d65 203d 206d       uidname = m
+0005a0a0: 6f64 5f6e 616d 6520 2b20 275f 6d6d 7769  od_name + '_mmwi
+0005a0b0: 6465 5f66 696c 656e 616d 6527 0a20 2020  de_filename'.   
+0005a0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005a0d0: 2020 2020 206d 6d5b 2075 6964 6e61 6d65       mm[ uidname
+0005a0e0: 205d 203d 2072 6f6f 7469 640a 2020 2020   ] = rootid.    
+0005a0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005a100: 2020 2020 6373 7672 6f77 3d70 642e 636f      csvrow=pd.co
+0005a110: 6e63 6174 2820 5b63 7376 726f 772c 6d6d  ncat( [csvrow,mm
+0005a120: 5d2c 2061 7869 733d 312c 2069 676e 6f72  ], axis=1, ignor
+0005a130: 655f 696e 6465 783d 4661 6c73 6520 290a  e_index=False ).
+0005a140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005a150: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0005a160: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+0005a170: 626f 7365 2061 6e64 2072 6570 6f72 745f  bose and report_
+0005a180: 6d69 7373 696e 673a 0a20 2020 2020 2020  missing:.       
+0005a190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005a1a0: 2070 7269 6e74 2820 6e72 6777 6964 6566   print( nrgwidef
+0005a1b0: 6e20 2b20 2220 6162 7365 6e74 2229 0a20  n + " absent"). 
+0005a1c0: 2020 2020 2020 2069 6620 616c 6c64 662e         if alldf.
+0005a1d0: 7368 6170 655b 305d 203d 3d20 303a 0a20  shape[0] == 0:. 
+0005a1e0: 2020 2020 2020 2020 2020 2061 6c6c 6466             alldf
+0005a1f0: 203d 2063 7376 726f 772e 636f 7079 2829   = csvrow.copy()
+0005a200: 0a20 2020 2020 2020 2020 2020 2061 6c6c  .            all
+0005a210: 6466 203d 2061 6c6c 6466 2e6c 6f63 5b3a  df = alldf.loc[:
+0005a220: 2c7e 616c 6c64 662e 636f 6c75 6d6e 732e  ,~alldf.columns.
+0005a230: 6475 706c 6963 6174 6564 2829 5d0a 2020  duplicated()].  
+0005a240: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0005a250: 2020 2020 2020 2020 6373 7672 6f77 3d63          csvrow=c
+0005a260: 7376 726f 772e 6c6f 635b 3a2c 7e63 7376  svrow.loc[:,~csv
+0005a270: 726f 772e 636f 6c75 6d6e 732e 6475 706c  row.columns.dupl
+0005a280: 6963 6174 6564 2829 5d0a 2020 2020 2020  icated()].      
+0005a290: 2020 2020 2020 616c 6c64 6620 3d20 616c        alldf = al
+0005a2a0: 6c64 662e 6c6f 635b 3a2c 7e61 6c6c 6466  ldf.loc[:,~alldf
+0005a2b0: 2e63 6f6c 756d 6e73 2e64 7570 6c69 6361  .columns.duplica
+0005a2c0: 7465 6428 295d 0a20 2020 2020 2020 2020  ted()].         
+0005a2d0: 2020 2061 6c6c 6466 203d 2070 642e 636f     alldf = pd.co
+0005a2e0: 6e63 6174 2820 5b61 6c6c 6466 2c20 6373  ncat( [alldf, cs
+0005a2f0: 7672 6f77 5d2c 2061 7869 733d 302c 2069  vrow], axis=0, i
+0005a300: 676e 6f72 655f 696e 6465 783d 5472 7565  gnore_index=True
+0005a310: 2029 0a20 2020 2072 6574 7572 6e20 616c   ).    return al
+0005a320: 6c64 660a 0a64 6566 2061 7373 656d 626c  ldf..def assembl
+0005a330: 655f 6d6f 6461 6c69 7479 5f73 7065 6369  e_modality_speci
+0005a340: 6669 635f 6461 7461 6672 616d 6573 2820  fic_dataframes( 
+0005a350: 6d6d 5f77 6964 655f 6373 7673 2c20 6869  mm_wide_csvs, hi
+0005a360: 6572 6466 696e 2c20 6e72 675f 6d6f 6461  erdfin, nrg_moda
+0005a370: 6c69 7479 2c20 7365 7061 7261 746f 723d  lity, separator=
+0005a380: 272d 272c 2070 726f 6772 6573 733d 4e6f  '-', progress=No
+0005a390: 6e65 2c20 7665 7262 6f73 653d 4661 6c73  ne, verbose=Fals
+0005a3a0: 6520 293a 0a20 2020 206d 6f64 6465 7273  e ):.    modders
+0005a3b0: 7562 203d 2072 652e 7375 6228 2022 5b2a  ub = re.sub( "[*
+0005a3c0: 5d22 2c22 222c 6e72 675f 6d6f 6461 6c69  ]","",nrg_modali
+0005a3d0: 7479 290a 2020 2020 6e6d 6466 3d70 642e  ty).    nmdf=pd.
+0005a3e0: 4461 7461 4672 616d 6528 290a 2020 2020  DataFrame().    
+0005a3f0: 666f 7220 6b20 696e 2072 616e 6765 2820  for k in range( 
+0005a400: 6869 6572 6466 696e 2e73 6861 7065 5b30  hierdfin.shape[0
+0005a410: 5d20 293a 0a20 2020 2020 2020 2069 6620  ] ):.        if 
+0005a420: 7072 6f67 7265 7373 2069 7320 6e6f 7420  progress is not 
+0005a430: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0005a440: 2020 6966 206b 2025 2070 726f 6772 6573    if k % progres
+0005a450: 7320 3d3d 2030 3a0a 2020 2020 2020 2020  s == 0:.        
+0005a460: 2020 2020 2020 2020 7072 6f67 6765 7220          progger 
+0005a470: 3d20 7374 7228 206e 702e 726f 756e 6428  = str( np.round(
+0005a480: 206b 202f 2068 6965 7264 6669 6e2e 7368   k / hierdfin.sh
+0005a490: 6170 655b 305d 202a 2031 3030 2029 2029  ape[0] * 100 ) )
+0005a4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005a4b0: 2070 7269 6e74 2820 7072 6f67 6765 722c   print( progger,
+0005a4c0: 2065 6e64 203d 222e 2e2e 222c 2066 6c75   end ="...", flu
+0005a4d0: 7368 3d54 7275 6529 0a20 2020 2020 2020  sh=True).       
+0005a4e0: 2074 656d 7020 3d20 6d6d 5f77 6964 655f   temp = mm_wide_
+0005a4f0: 6373 7673 5b6b 5d0a 2020 2020 2020 2020  csvs[k].        
+0005a500: 6d79 7061 7274 7366 203d 2074 656d 702e  mypartsf = temp.
+0005a510: 7370 6c69 7428 2254 3177 4869 6572 6172  split("T1wHierar
+0005a520: 6368 6963 616c 2229 0a20 2020 2020 2020  chical").       
+0005a530: 206d 7970 6172 7473 203d 206d 7970 6172   myparts = mypar
+0005a540: 7473 665b 305d 0a20 2020 2020 2020 2074  tsf[0].        t
+0005a550: 3169 6964 203d 2073 7472 286d 7970 6172  1iid = str(mypar
+0005a560: 7473 665b 315d 2e73 706c 6974 2822 2f22  tsf[1].split("/"
+0005a570: 295b 315d 290a 2020 2020 2020 2020 666e  )[1]).        fn
+0005a580: 736e 6d20 3d20 676c 6f62 2e67 6c6f 6228  snm = glob.glob(
+0005a590: 6d79 7061 7274 732b 222f 2220 2b20 6e72  myparts+"/" + nr
+0005a5a0: 675f 6d6f 6461 6c69 7479 202b 2022 2f2a  g_modality + "/*
+0005a5b0: 2f2a 2220 2b20 7431 6969 6420 2b20 222a  /*" + t1iid + "*
+0005a5c0: 7769 6465 2e63 7376 2229 0a20 2020 2020  wide.csv").     
+0005a5d0: 2020 2069 6620 6c65 6e28 2066 6e73 6e6d     if len( fnsnm
+0005a5e0: 2029 203e 2030 203a 0a20 2020 2020 2020   ) > 0 :.       
+0005a5f0: 2020 2020 2066 6f72 2079 2069 6e20 666e       for y in fn
+0005a600: 736e 6d3a 0a20 2020 2020 2020 2020 2020  snm:.           
+0005a610: 2020 2020 2074 656d 703d 7265 6164 5f6d       temp=read_m
+0005a620: 6d5f 6373 7628 2079 2c20 636f 6c70 7265  m_csv( y, colpre
+0005a630: 6669 783d 6d6f 6464 6572 7375 622b 275f  fix=moddersub+'_
+0005a640: 272c 2069 735f 7431 3d46 616c 7365 2c20  ', is_t1=False, 
+0005a650: 7365 7061 7261 746f 723d 7365 7061 7261  separator=separa
+0005a660: 746f 722c 2076 6572 626f 7365 3d76 6572  tor, verbose=ver
+0005a670: 626f 7365 2029 0a20 2020 2020 2020 2020  bose ).         
+0005a680: 2020 2020 2020 2069 6620 7465 6d70 2069         if temp i
+0005a690: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0005a6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005a6b0: 6e6d 6466 3d70 642e 636f 6e63 6174 2820  nmdf=pd.concat( 
+0005a6c0: 5b6e 6d64 662c 2074 656d 705d 2c20 6178  [nmdf, temp], ax
+0005a6d0: 6973 3d30 2c20 6967 6e6f 7265 5f69 6e64  is=0, ignore_ind
+0005a6e0: 6578 3d46 616c 7365 2029 0a20 2020 2072  ex=False ).    r
+0005a6f0: 6574 7572 6e20 6e6d 6466 0a0a 6465 6620  eturn nmdf..def 
+0005a700: 6269 6e64 5f77 6964 655f 6d6d 5f63 7376  bind_wide_mm_csv
+0005a710: 7328 206d 6d5f 7769 6465 5f63 7376 732c  s( mm_wide_csvs,
+0005a720: 206d 6572 6765 3d54 7275 652c 2073 6570   merge=True, sep
+0005a730: 6172 6174 6f72 3d27 2d27 2c20 7665 7262  arator='-', verb
+0005a740: 6f73 6520 3d20 3020 2920 3a0a 2020 2020  ose = 0 ) :.    
+0005a750: 2222 220a 2020 2020 7769 6c6c 2063 6f6e  """.    will con
+0005a760: 7665 7274 2061 206c 6973 7420 6f66 2074  vert a list of t
+0005a770: 3177 2068 6965 7261 7263 6869 6361 6c20  1w hierarchical 
+0005a780: 6373 7620 6669 6c65 6e61 6d65 7320 746f  csv filenames to
+0005a790: 2061 206d 6572 6765 6420 6461 7461 6672   a merged datafr
+0005a7a0: 616d 650a 0a20 2020 2072 6574 7572 6e73  ame..    returns
+0005a7b0: 2061 2070 6169 7220 6f66 2064 6174 6120   a pair of data 
+0005a7c0: 6672 616d 6573 2c20 7468 6520 6c65 6674  frames, the left
+0005a7d0: 2073 6964 6520 6861 7669 6e67 2061 6c6c   side having all
+0005a7e0: 2065 6e74 7269 6573 2061 6e64 2074 6865   entries and the
+0005a7f0: 0a20 2020 2020 2020 2072 6967 6874 2073  .        right s
+0005a800: 6964 6520 6861 7669 6e67 2072 6f77 2061  ide having row a
+0005a810: 7665 7261 6765 6420 656e 7472 6965 7320  veraged entries 
+0005a820: 692e 652e 2075 6e69 7175 6520 7661 6c75  i.e. unique valu
+0005a830: 6573 2066 6f72 2065 6163 6820 7669 7369  es for each visi
+0005a840: 740a 0a20 2020 2073 6574 206d 6572 6765  t..    set merge
+0005a850: 2074 6f20 4661 6c73 6520 746f 2072 6574   to False to ret
+0005a860: 7572 6e20 696e 6469 7669 6475 616c 2064  urn individual d
+0005a870: 6174 6166 7261 6d65 7320 2820 666f 7220  ataframes ( for 
+0005a880: 6465 6275 6767 696e 6720 290a 0a20 2020  debugging )..   
+0005a890: 2072 6574 7572 6e20 616c 6c64 6174 612c   return alldata,
+0005a8a0: 2072 6f77 5f61 7665 7261 6765 645f 6461   row_averaged_da
+0005a8b0: 7461 0a20 2020 2022 2222 0a20 2020 206d  ta.    """.    m
+0005a8c0: 6d5f 7769 6465 5f63 7376 732e 736f 7274  m_wide_csvs.sort
+0005a8d0: 2829 0a20 2020 2069 6620 6e6f 7420 6d6d  ().    if not mm
+0005a8e0: 5f77 6964 655f 6373 7673 3a0a 2020 2020  _wide_csvs:.    
+0005a8f0: 2020 2020 7072 696e 7428 224e 6f20 6669      print("No fi
+0005a900: 6c65 7320 666f 756e 6420 7769 7468 2073  les found with s
+0005a910: 7065 6369 6669 6564 2070 6174 7465 726e  pecified pattern
+0005a920: 2229 0a20 2020 2020 2020 2072 6574 7572  ").        retur
+0005a930: 6e0a 2020 2020 2320 312e 2072 6f77 2d62  n.    # 1. row-b
+0005a940: 696e 6420 7468 6520 7431 7768 6965 7220  ind the t1whier 
+0005a950: 6461 7461 0a20 2020 2023 2032 2e20 7361  data.    # 2. sa
+0005a960: 6d65 2066 6f72 2065 6163 6820 6f74 6865  me for each othe
+0005a970: 7220 6d6f 6461 6c69 7479 0a20 2020 2023  r modality.    #
+0005a980: 2033 2e20 6d65 7267 6520 7468 6520 6d6f   3. merge the mo
+0005a990: 6461 6c69 7469 6573 2062 7920 7468 6520  dalities by the 
+0005a9a0: 6b65 7973 0a20 2020 2068 6965 7264 6620  keys.    hierdf 
+0005a9b0: 3d20 7064 2e44 6174 6146 7261 6d65 2829  = pd.DataFrame()
+0005a9c0: 0a20 2020 2066 6f72 2079 2069 6e20 6d6d  .    for y in mm
+0005a9d0: 5f77 6964 655f 6373 7673 3a0a 2020 2020  _wide_csvs:.    
+0005a9e0: 2020 2020 7465 6d70 3d72 6561 645f 6d6d      temp=read_mm
+0005a9f0: 5f63 7376 2820 792c 2063 6f6c 7072 6566  _csv( y, colpref
+0005aa00: 6978 3d27 5431 4869 6572 5f27 2c20 7365  ix='T1Hier_', se
+0005aa10: 7061 7261 746f 723d 7365 7061 7261 746f  parator=separato
+0005aa20: 722c 2069 735f 7431 3d54 7275 6520 290a  r, is_t1=True ).
+0005aa30: 2020 2020 2020 2020 6966 2074 656d 7020          if temp 
+0005aa40: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0005aa50: 2020 2020 2020 2020 2068 6965 7264 663d           hierdf=
+0005aa60: 7064 2e63 6f6e 6361 7428 205b 6869 6572  pd.concat( [hier
+0005aa70: 6466 2c20 7465 6d70 5d2c 2061 7869 733d  df, temp], axis=
+0005aa80: 302c 2069 676e 6f72 655f 696e 6465 783d  0, ignore_index=
+0005aa90: 4661 6c73 6520 290a 2020 2020 6966 2076  False ).    if v
+0005aaa0: 6572 626f 7365 203e 2030 3a0a 2020 2020  erbose > 0:.    
+0005aab0: 2020 2020 6d79 7072 6f3d 3530 0a20 2020      mypro=50.   
+0005aac0: 2065 6c73 653a 0a20 2020 2020 2020 206d   else:.        m
+0005aad0: 7970 726f 3d4e 6f6e 650a 2020 2020 6966  ypro=None.    if
+0005aae0: 2076 6572 626f 7365 203e 2030 3a0a 2020   verbose > 0:.  
+0005aaf0: 2020 2020 2020 7072 696e 7428 2274 6869        print("thi
+0005ab00: 636b 6e65 7373 2229 0a20 2020 2074 686b  ckness").    thk
+0005ab10: 6466 203d 2061 7373 656d 626c 655f 6d6f  df = assemble_mo
+0005ab20: 6461 6c69 7479 5f73 7065 6369 6669 635f  dality_specific_
+0005ab30: 6461 7461 6672 616d 6573 2820 6d6d 5f77  dataframes( mm_w
+0005ab40: 6964 655f 6373 7673 2c20 6869 6572 6466  ide_csvs, hierdf
+0005ab50: 2c20 2754 3177 272c 2070 726f 6772 6573  , 'T1w', progres
+0005ab60: 733d 6d79 7072 6f2c 2076 6572 626f 7365  s=mypro, verbose
+0005ab70: 3d76 6572 626f 7365 3d3d 3229 0a20 2020  =verbose==2).   
+0005ab80: 2069 6620 7665 7262 6f73 6520 3e20 303a   if verbose > 0:
+0005ab90: 0a20 2020 2020 2020 2070 7269 6e74 2822  .        print("
+0005aba0: 666c 6169 7222 290a 2020 2020 666c 6169  flair").    flai
+0005abb0: 7264 6620 3d20 6173 7365 6d62 6c65 5f6d  rdf = assemble_m
+0005abc0: 6f64 616c 6974 795f 7370 6563 6966 6963  odality_specific
+0005abd0: 5f64 6174 6166 7261 6d65 7328 206d 6d5f  _dataframes( mm_
+0005abe0: 7769 6465 5f63 7376 732c 2068 6965 7264  wide_csvs, hierd
+0005abf0: 662c 2027 5432 466c 6169 7227 2c20 7072  f, 'T2Flair', pr
+0005ac00: 6f67 7265 7373 3d6d 7970 726f 2c20 7665  ogress=mypro, ve
+0005ac10: 7262 6f73 653d 7665 7262 6f73 653d 3d32  rbose=verbose==2
+0005ac20: 290a 2020 2020 6966 2076 6572 626f 7365  ).    if verbose
+0005ac30: 203e 2030 3a0a 2020 2020 2020 2020 7072   > 0:.        pr
+0005ac40: 696e 7428 224e 4d22 290a 2020 2020 6e6d  int("NM").    nm
+0005ac50: 6466 203d 2061 7373 656d 626c 655f 6d6f  df = assemble_mo
+0005ac60: 6461 6c69 7479 5f73 7065 6369 6669 635f  dality_specific_
+0005ac70: 6461 7461 6672 616d 6573 2820 6d6d 5f77  dataframes( mm_w
+0005ac80: 6964 655f 6373 7673 2c20 6869 6572 6466  ide_csvs, hierdf
+0005ac90: 2c20 274e 4d32 444d 5427 2c20 7072 6f67  , 'NM2DMT', prog
+0005aca0: 7265 7373 3d6d 7970 726f 2c20 7665 7262  ress=mypro, verb
+0005acb0: 6f73 653d 7665 7262 6f73 653d 3d32 290a  ose=verbose==2).
+0005acc0: 2020 2020 6966 2076 6572 626f 7365 203e      if verbose >
+0005acd0: 2030 3a0a 2020 2020 2020 2020 7072 696e   0:.        prin
+0005ace0: 7428 2272 7366 2229 0a20 2020 2072 7366  t("rsf").    rsf
+0005acf0: 6466 203d 2061 7373 656d 626c 655f 6d6f  df = assemble_mo
+0005ad00: 6461 6c69 7479 5f73 7065 6369 6669 635f  dality_specific_
+0005ad10: 6461 7461 6672 616d 6573 2820 6d6d 5f77  dataframes( mm_w
+0005ad20: 6964 655f 6373 7673 2c20 6869 6572 6466  ide_csvs, hierdf
+0005ad30: 2c20 2772 7366 4d52 492a 272c 2070 726f  , 'rsfMRI*', pro
+0005ad40: 6772 6573 733d 6d79 7072 6f2c 2076 6572  gress=mypro, ver
+0005ad50: 626f 7365 3d76 6572 626f 7365 3d3d 3229  bose=verbose==2)
+0005ad60: 0a20 2020 2069 6620 7665 7262 6f73 6520  .    if verbose 
+0005ad70: 3e20 303a 0a20 2020 2020 2020 2070 7269  > 0:.        pri
+0005ad80: 6e74 2822 6474 6922 290a 2020 2020 6474  nt("dti").    dt
+0005ad90: 6964 6620 3d20 6173 7365 6d62 6c65 5f6d  idf = assemble_m
+0005ada0: 6f64 616c 6974 795f 7370 6563 6966 6963  odality_specific
+0005adb0: 5f64 6174 6166 7261 6d65 7328 206d 6d5f  _dataframes( mm_
+0005adc0: 7769 6465 5f63 7376 732c 2068 6965 7264  wide_csvs, hierd
+0005add0: 662c 2027 4454 492a 272c 2070 726f 6772  f, 'DTI*', progr
+0005ade0: 6573 733d 6d79 7072 6f2c 2076 6572 626f  ess=mypro, verbo
+0005adf0: 7365 3d76 6572 626f 7365 3d3d 3220 290a  se=verbose==2 ).
+0005ae00: 2020 2020 6966 206e 6f74 206d 6572 6765      if not merge
+0005ae10: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0005ae20: 2068 6965 7264 662c 2074 686b 6466 2c20   hierdf, thkdf, 
+0005ae30: 666c 6169 7264 662c 206e 6d64 662c 2072  flairdf, nmdf, r
+0005ae40: 7366 6466 2c20 6474 6964 660a 2020 2020  sfdf, dtidf.    
+0005ae50: 6869 6572 6466 6d69 7820 3d20 6869 6572  hierdfmix = hier
+0005ae60: 6466 2e63 6f70 7928 290a 2020 2020 6d6f  df.copy().    mo
+0005ae70: 6461 6c69 7479 5f64 665f 7375 6666 6978  dality_df_suffix
+0005ae80: 6573 203d 205b 0a20 2020 2020 2020 2028  es = [.        (
+0005ae90: 7468 6b64 662c 2022 5f74 686b 2229 2c0a  thkdf, "_thk"),.
+0005aea0: 2020 2020 2020 2020 2866 6c61 6972 6466          (flairdf
+0005aeb0: 2c20 225f 666c 6169 7222 292c 0a20 2020  , "_flair"),.   
+0005aec0: 2020 2020 2028 6e6d 6466 2c20 225f 6e6d       (nmdf, "_nm
+0005aed0: 2229 2c0a 2020 2020 2020 2020 2872 7366  "),.        (rsf
+0005aee0: 6466 2c20 225f 7273 6622 292c 0a20 2020  df, "_rsf"),.   
+0005aef0: 2020 2020 2028 6474 6964 662c 2022 5f64       (dtidf, "_d
+0005af00: 7469 2229 2c0a 2020 2020 5d0a 2020 2020  ti"),.    ].    
+0005af10: 666f 7220 7061 6972 2069 6e20 6d6f 6461  for pair in moda
+0005af20: 6c69 7479 5f64 665f 7375 6666 6978 6573  lity_df_suffixes
+0005af30: 3a0a 2020 2020 2020 2020 6869 6572 6466  :.        hierdf
+0005af40: 6d69 7820 3d20 6d65 7267 655f 6d6d 5f64  mix = merge_mm_d
+0005af50: 6174 6166 7261 6d65 2868 6965 7264 666d  ataframe(hierdfm
+0005af60: 6978 2c20 7061 6972 5b30 5d2c 2070 6169  ix, pair[0], pai
+0005af70: 725b 315d 290a 2020 2020 6869 6572 6466  r[1]).    hierdf
+0005af80: 6d69 7820 3d20 6869 6572 6466 6d69 782e  mix = hierdfmix.
+0005af90: 7265 706c 6163 6528 7227 5e5c 732a 2427  replace(r'^\s*$'
+0005afa0: 2c20 6e70 2e6e 616e 2c20 7265 6765 783d  , np.nan, regex=
+0005afb0: 5472 7565 290a 2020 2020 7265 7475 726e  True).    return
+0005afc0: 2068 6965 7264 666d 6978 2c20 6869 6572   hierdfmix, hier
+0005afd0: 6466 6d69 782e 6772 6f75 7062 7928 2275  dfmix.groupby("u
+0005afe0: 5f68 6965 725f 6964 222c 2061 735f 696e  _hier_id", as_in
+0005aff0: 6465 783d 4661 6c73 6529 2e6d 6561 6e28  dex=False).mean(
+0005b000: 6e75 6d65 7269 635f 6f6e 6c79 3d54 7275  numeric_only=Tru
+0005b010: 6529 0a0a 6465 6620 6d65 7267 655f 6d6d  e)..def merge_mm
+0005b020: 5f64 6174 6166 7261 6d65 2868 6965 7264  _dataframe(hierd
+0005b030: 662c 206d 6d64 662c 206d 6d5f 7375 6666  f, mmdf, mm_suff
+0005b040: 6978 293a 0a20 2020 2074 7279 3a0a 2020  ix):.    try:.  
+0005b050: 2020 2020 2020 6869 6572 6466 203d 2068        hierdf = h
+0005b060: 6965 7264 662e 6d65 7267 6528 6d6d 6466  ierdf.merge(mmdf
+0005b070: 2c20 6f6e 3d5b 2773 6964 272c 2027 7669  , on=['sid', 'vi
+0005b080: 7369 7464 6174 6527 2c20 2774 3169 6d61  sitdate', 't1ima
+0005b090: 6765 7569 6427 5d2c 2073 7566 6669 7865  geuid'], suffixe
+0005b0a0: 733d 2822 222c 6d6d 5f73 7566 6669 7829  s=("",mm_suffix)
+0005b0b0: 2c68 6f77 3d27 6c65 6674 2729 0a20 2020  ,how='left').   
+0005b0c0: 2020 2020 2072 6574 7572 6e20 6869 6572       return hier
+0005b0d0: 6466 0a20 2020 2065 7863 6570 7420 4b65  df.    except Ke
+0005b0e0: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
+0005b0f0: 7265 7475 726e 2068 6965 7264 660a 0a64  return hierdf..d
+0005b100: 6566 2061 7567 6d65 6e74 5f69 6d61 6765  ef augment_image
+0005b110: 2820 782c 2020 6d61 785f 726f 743d 3130  ( x,  max_rot=10
+0005b120: 2c20 6e7a 7364 3d31 2029 3a0a 2020 2020  , nzsd=1 ):.    
+0005b130: 7252 6f74 4765 6e65 7261 746f 7220 3d20  rRotGenerator = 
+0005b140: 616e 7473 2e63 6f6e 7472 6962 2e52 616e  ants.contrib.Ran
+0005b150: 646f 6d52 6f74 6174 6533 4428 2028 206d  domRotate3D( ( m
+0005b160: 6178 5f72 6f74 2a28 2d31 2e30 292c 206d  ax_rot*(-1.0), m
+0005b170: 6178 5f72 6f74 2029 2c20 7265 6665 7265  ax_rot ), refere
+0005b180: 6e63 653d 7820 290a 2020 2020 7478 203d  nce=x ).    tx =
+0005b190: 2072 526f 7447 656e 6572 6174 6f72 2e74   rRotGenerator.t
+0005b1a0: 7261 6e73 666f 726d 2829 0a20 2020 2069  ransform().    i
+0005b1b0: 7478 203d 2061 6e74 732e 696e 7665 7274  tx = ants.invert
+0005b1c0: 5f61 6e74 735f 7472 616e 7366 6f72 6d28  _ants_transform(
+0005b1d0: 7478 290a 2020 2020 7920 3d20 616e 7473  tx).    y = ants
+0005b1e0: 2e61 7070 6c79 5f61 6e74 735f 7472 616e  .apply_ants_tran
+0005b1f0: 7366 6f72 6d5f 746f 5f69 6d61 6765 2820  sform_to_image( 
+0005b200: 7478 2c20 782c 2078 2c20 696e 7465 7270  tx, x, x, interp
+0005b210: 6f6c 6174 696f 6e3d 276c 696e 6561 7227  olation='linear'
+0005b220: 290a 2020 2020 7920 3d20 616e 7473 2e61  ).    y = ants.a
+0005b230: 6464 5f6e 6f69 7365 5f74 6f5f 696d 6167  dd_noise_to_imag
+0005b240: 6528 2079 2c27 6164 6469 7469 7665 6761  e( y,'additivega
+0005b250: 7573 7369 616e 272c 205b 302c 6e7a 7364  ussian', [0,nzsd
+0005b260: 5d20 290a 2020 2020 7265 7475 726e 2079  ] ).    return y
+0005b270: 2c20 7478 2c20 6974 780a 0a64 6566 2062  , tx, itx..def b
+0005b280: 6f6f 745f 776d 6828 2066 6c61 6972 2c20  oot_wmh( flair, 
+0005b290: 7431 2c20 7431 7365 672c 206d 6d66 726f  t1, t1seg, mmfro
+0005b2a0: 6d63 6f6e 7665 7868 756c 6c20 3d20 302e  mconvexhull = 0.
+0005b2b0: 302c 2073 7472 6963 743d 5472 7565 2c0a  0, strict=True,.
+0005b2c0: 2020 2020 2020 2020 7072 6f62 6162 696c          probabil
+0005b2d0: 6974 795f 6d61 736b 3d4e 6f6e 652c 2070  ity_mask=None, p
+0005b2e0: 7269 6f72 5f70 726f 6261 6269 6c69 7479  rior_probability
+0005b2f0: 3d4e 6f6e 652c 206e 5f73 696d 756c 6174  =None, n_simulat
+0005b300: 696f 6e73 3d31 362c 0a20 2020 2020 2020  ions=16,.       
+0005b310: 2076 6572 626f 7365 3d46 616c 7365 2029   verbose=False )
+0005b320: 203a 0a20 2020 2069 6620 7665 7262 6f73   :.    if verbos
+0005b330: 6520 616e 6420 7072 696f 725f 7072 6f62  e and prior_prob
+0005b340: 6162 696c 6974 7920 6973 204e 6f6e 653a  ability is None:
+0005b350: 0a20 2020 2020 2020 2070 7269 6e74 2822  .        print("
+0005b360: 6175 676d 656e 7465 6420 666c 6169 7222  augmented flair"
+0005b370: 290a 2020 2020 6966 2076 6572 626f 7365  ).    if verbose
+0005b380: 2061 6e64 2070 7269 6f72 5f70 726f 6261   and prior_proba
+0005b390: 6269 6c69 7479 2069 7320 6e6f 7420 4e6f  bility is not No
+0005b3a0: 6e65 3a0a 2020 2020 2020 2020 7072 696e  ne:.        prin
+0005b3b0: 7428 2261 7567 6d65 6e74 6564 2066 6c61  t("augmented fla
+0005b3c0: 6972 2077 6974 6820 7072 696f 7222 290a  ir with prior").
+0005b3d0: 2020 2020 776d 685f 7375 6d5f 6175 6720      wmh_sum_aug 
+0005b3e0: 3d20 300a 2020 2020 776d 685f 7375 6d5f  = 0.    wmh_sum_
+0005b3f0: 7072 696f 725f 6175 6720 3d20 300a 2020  prior_aug = 0.  
+0005b400: 2020 6175 6770 726f 6220 3d20 666c 6169    augprob = flai
+0005b410: 7220 2a20 302e 300a 2020 2020 6175 6770  r * 0.0.    augp
+0005b420: 726f 625f 7072 696f 7220 3d20 4e6f 6e65  rob_prior = None
+0005b430: 0a20 2020 2069 6620 7072 696f 725f 7072  .    if prior_pr
+0005b440: 6f62 6162 696c 6974 7920 6973 206e 6f74  obability is not
+0005b450: 204e 6f6e 653a 0a20 2020 2020 2020 2061   None:.        a
+0005b460: 7567 7072 6f62 5f70 7269 6f72 203d 2066  ugprob_prior = f
+0005b470: 6c61 6972 202a 2030 2e30 0a20 2020 2066  lair * 0.0.    f
+0005b480: 6f72 206e 2069 6e20 7261 6e67 6528 6e5f  or n in range(n_
+0005b490: 7369 6d75 6c61 7469 6f6e 7329 3a0a 2020  simulations):.  
+0005b4a0: 2020 2020 2020 6175 6766 6c61 6972 2c20        augflair, 
+0005b4b0: 7478 2c20 6974 7820 3d20 6175 676d 656e  tx, itx = augmen
+0005b4c0: 745f 696d 6167 6528 2061 6e74 732e 694d  t_image( ants.iM
+0005b4d0: 6174 6828 666c 6169 722c 224e 6f72 6d61  ath(flair,"Norma
+0005b4e0: 6c69 7a65 2229 2c20 352c 2030 2e30 3120  lize"), 5, 0.01 
+0005b4f0: 290a 2020 2020 2020 2020 6c6f 6377 6d68  ).        locwmh
+0005b500: 203d 2077 6d68 2820 6175 6766 6c61 6972   = wmh( augflair
+0005b510: 2c20 7431 2c20 7431 7365 672c 206d 6d66  , t1, t1seg, mmf
+0005b520: 726f 6d63 6f6e 7665 7868 756c 6c20 3d20  romconvexhull = 
+0005b530: 6d6d 6672 6f6d 636f 6e76 6578 6875 6c6c  mmfromconvexhull
+0005b540: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
+0005b550: 7269 6374 3d73 7472 6963 742c 2070 726f  rict=strict, pro
+0005b560: 6261 6269 6c69 7479 5f6d 6173 6b3d 4e6f  bability_mask=No
+0005b570: 6e65 2c20 7072 696f 725f 7072 6f62 6162  ne, prior_probab
+0005b580: 696c 6974 793d 7072 696f 725f 7072 6f62  ility=prior_prob
+0005b590: 6162 696c 6974 7920 290a 2020 2020 2020  ability ).      
+0005b5a0: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+0005b5b0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0005b5c0: 2022 666c 6169 7220 7369 6d3a 2022 202b   "flair sim: " +
+0005b5d0: 2073 7472 286e 2920 2b20 2220 766f 6c3a   str(n) + " vol:
+0005b5e0: 2022 202b 2073 7472 2820 6c6f 6377 6d68   " + str( locwmh
+0005b5f0: 5b27 776d 685f 6d61 7373 275d 2029 2b20  ['wmh_mass'] )+ 
+0005b600: 2220 766f 6c2d 7072 696f 723a 2022 202b  " vol-prior: " +
+0005b610: 2073 7472 2820 6c6f 6377 6d68 5b27 776d   str( locwmh['wm
+0005b620: 685f 6d61 7373 5f70 7269 6f72 275d 2029  h_mass_prior'] )
+0005b630: 2b20 2220 736e 723a 2022 202b 2073 7472  + " snr: " + str
+0005b640: 2820 6c6f 6377 6d68 5b27 776d 685f 534e  ( locwmh['wmh_SN
+0005b650: 5227 5d20 2920 290a 2020 2020 2020 2020  R'] ) ).        
+0005b660: 776d 685f 7375 6d5f 6175 6720 3d20 776d  wmh_sum_aug = wm
+0005b670: 685f 7375 6d5f 6175 6720 2b20 6c6f 6377  h_sum_aug + locw
+0005b680: 6d68 5b27 776d 685f 6d61 7373 275d 0a20  mh['wmh_mass']. 
+0005b690: 2020 2020 2020 2077 6d68 5f73 756d 5f70         wmh_sum_p
+0005b6a0: 7269 6f72 5f61 7567 203d 2077 6d68 5f73  rior_aug = wmh_s
+0005b6b0: 756d 5f70 7269 6f72 5f61 7567 202b 206c  um_prior_aug + l
+0005b6c0: 6f63 776d 685b 2777 6d68 5f6d 6173 735f  ocwmh['wmh_mass_
+0005b6d0: 7072 696f 7227 5d0a 2020 2020 2020 2020  prior'].        
+0005b6e0: 7465 6d70 203d 206c 6f63 776d 685b 2757  temp = locwmh['W
+0005b6f0: 4d48 5f70 726f 6261 6269 6c69 7479 5f6d  MH_probability_m
+0005b700: 6170 275d 0a20 2020 2020 2020 2061 7567  ap'].        aug
+0005b710: 7072 6f62 203d 2061 7567 7072 6f62 202b  prob = augprob +
+0005b720: 2061 6e74 732e 6170 706c 795f 616e 7473   ants.apply_ants
+0005b730: 5f74 7261 6e73 666f 726d 5f74 6f5f 696d  _transform_to_im
+0005b740: 6167 6528 2069 7478 2c20 7465 6d70 2c20  age( itx, temp, 
+0005b750: 666c 6169 722c 2069 6e74 6572 706f 6c61  flair, interpola
+0005b760: 7469 6f6e 3d27 6c69 6e65 6172 2729 0a20  tion='linear'). 
+0005b770: 2020 2020 2020 2069 6620 7072 696f 725f         if prior_
+0005b780: 7072 6f62 6162 696c 6974 7920 6973 206e  probability is n
+0005b790: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0005b7a0: 2020 2020 2074 656d 7020 3d20 6c6f 6377       temp = locw
+0005b7b0: 6d68 5b27 574d 485f 706f 7374 6572 696f  mh['WMH_posterio
+0005b7c0: 725f 7072 6f62 6162 696c 6974 795f 6d61  r_probability_ma
+0005b7d0: 7027 5d0a 2020 2020 2020 2020 2020 2020  p'].            
+0005b7e0: 6175 6770 726f 625f 7072 696f 7220 3d20  augprob_prior = 
+0005b7f0: 6175 6770 726f 625f 7072 696f 7220 2b20  augprob_prior + 
+0005b800: 616e 7473 2e61 7070 6c79 5f61 6e74 735f  ants.apply_ants_
+0005b810: 7472 616e 7366 6f72 6d5f 746f 5f69 6d61  transform_to_ima
+0005b820: 6765 2820 6974 782c 2074 656d 702c 2066  ge( itx, temp, f
+0005b830: 6c61 6972 2c20 696e 7465 7270 6f6c 6174  lair, interpolat
+0005b840: 696f 6e3d 276c 696e 6561 7227 290a 2020  ion='linear').  
+0005b850: 2020 6175 6770 726f 6220 3d20 6175 6770    augprob = augp
+0005b860: 726f 6220 2a20 2831 2e30 2f66 6c6f 6174  rob * (1.0/float
+0005b870: 2820 6e5f 7369 6d75 6c61 7469 6f6e 7320  ( n_simulations 
+0005b880: 2929 0a20 2020 2069 6620 7072 696f 725f  )).    if prior_
+0005b890: 7072 6f62 6162 696c 6974 7920 6973 206e  probability is n
+0005b8a0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0005b8b0: 2061 7567 7072 6f62 5f70 7269 6f72 203d   augprob_prior =
+0005b8c0: 2061 7567 7072 6f62 5f70 7269 6f72 202a   augprob_prior *
+0005b8d0: 2028 312e 302f 666c 6f61 7428 206e 5f73   (1.0/float( n_s
+0005b8e0: 696d 756c 6174 696f 6e73 2029 290a 2020  imulations )).  
+0005b8f0: 2020 776d 685f 7375 6d5f 6175 6720 3d20    wmh_sum_aug = 
+0005b900: 776d 685f 7375 6d5f 6175 6720 2f20 666c  wmh_sum_aug / fl
+0005b910: 6f61 7428 206e 5f73 696d 756c 6174 696f  oat( n_simulatio
+0005b920: 6e73 2029 0a20 2020 2077 6d68 5f73 756d  ns ).    wmh_sum
+0005b930: 5f70 7269 6f72 5f61 7567 203d 2077 6d68  _prior_aug = wmh
+0005b940: 5f73 756d 5f70 7269 6f72 5f61 7567 202f  _sum_prior_aug /
+0005b950: 2066 6c6f 6174 2820 6e5f 7369 6d75 6c61   float( n_simula
+0005b960: 7469 6f6e 7320 290a 2020 2020 7265 7475  tions ).    retu
+0005b970: 726e 7b0a 2020 2020 2020 2766 6c61 6972  rn{.      'flair
+0005b980: 2720 3a20 616e 7473 2e69 4d61 7468 2866  ' : ants.iMath(f
+0005b990: 6c61 6972 2c22 4e6f 726d 616c 697a 6522  lair,"Normalize"
+0005b9a0: 292c 0a20 2020 2020 2027 574d 485f 7072  ),.      'WMH_pr
+0005b9b0: 6f62 6162 696c 6974 795f 6d61 7027 203a  obability_map' :
+0005b9c0: 2061 7567 7072 6f62 2c0a 2020 2020 2020   augprob,.      
+0005b9d0: 2757 4d48 5f70 6f73 7465 7269 6f72 5f70  'WMH_posterior_p
+0005b9e0: 726f 6261 6269 6c69 7479 5f6d 6170 2720  robability_map' 
+0005b9f0: 3a20 6175 6770 726f 625f 7072 696f 722c  : augprob_prior,
+0005ba00: 0a20 2020 2020 2027 776d 685f 6d61 7373  .      'wmh_mass
+0005ba10: 273a 2077 6d68 5f73 756d 5f61 7567 2c0a  ': wmh_sum_aug,.
+0005ba20: 2020 2020 2020 2777 6d68 5f6d 6173 735f        'wmh_mass_
+0005ba30: 7072 696f 7227 3a20 776d 685f 7375 6d5f  prior': wmh_sum_
+0005ba40: 7072 696f 725f 6175 672c 0a20 2020 2020  prior_aug,.     
+0005ba50: 2027 776d 685f 6576 7227 3a20 6c6f 6377   'wmh_evr': locw
+0005ba60: 6d68 5b27 776d 685f 6576 7227 5d2c 0a20  mh['wmh_evr'],. 
+0005ba70: 2020 2020 2027 776d 685f 534e 5227 3a20       'wmh_SNR': 
+0005ba80: 6c6f 6377 6d68 5b27 776d 685f 534e 5227  locwmh['wmh_SNR'
+0005ba90: 5d20 207d 0a0a 0a64 6566 2074 6872 6561  ]  }...def threa
+0005baa0: 6465 645f 6269 6e64 5f77 6964 655f 6d6d  ded_bind_wide_mm
+0005bab0: 5f63 7376 7328 206d 6d5f 7769 6465 5f63  _csvs( mm_wide_c
+0005bac0: 7376 732c 206e 5f77 6f72 6b65 7273 2029  svs, n_workers )
+0005bad0: 3a0a 2020 2020 6672 6f6d 2063 6f6e 6375  :.    from concu
+0005bae0: 7272 656e 742e 6675 7475 7265 7320 696d  rrent.futures im
+0005baf0: 706f 7274 2061 735f 636f 6d70 6c65 7465  port as_complete
+0005bb00: 640a 2020 2020 6672 6f6d 2063 6f6e 6375  d.    from concu
+0005bb10: 7272 656e 7420 696d 706f 7274 2066 7574  rrent import fut
+0005bb20: 7572 6573 0a20 2020 2069 6d70 6f72 7420  ures.    import 
+0005bb30: 636f 6e63 7572 7265 6e74 2e66 7574 7572  concurrent.futur
+0005bb40: 6573 0a20 2020 2064 6566 2063 6875 6e6b  es.    def chunk
+0005bb50: 7328 6c2c 206e 293a 0a20 2020 2020 2020  s(l, n):.       
+0005bb60: 2022 2222 5969 656c 6420 6e20 6e75 6d62   """Yield n numb
+0005bb70: 6572 206f 6620 7365 7175 656e 7469 616c  er of sequential
+0005bb80: 2063 6875 6e6b 7320 6672 6f6d 206c 2e22   chunks from l."
+0005bb90: 2222 0a20 2020 2020 2020 2064 2c20 7220  "".        d, r 
+0005bba0: 3d20 6469 766d 6f64 286c 656e 286c 292c  = divmod(len(l),
+0005bbb0: 206e 290a 2020 2020 2020 2020 666f 7220   n).        for 
+0005bbc0: 6920 696e 2072 616e 6765 286e 293a 0a20  i in range(n):. 
+0005bbd0: 2020 2020 2020 2020 2020 2073 6920 3d20             si = 
+0005bbe0: 2864 2b31 292a 2869 2069 6620 6920 3c20  (d+1)*(i if i < 
+0005bbf0: 7220 656c 7365 2072 2920 2b20 642a 2830  r else r) + d*(0
+0005bc00: 2069 6620 6920 3c20 7220 656c 7365 2069   if i < r else i
+0005bc10: 202d 2072 290a 2020 2020 2020 2020 2020   - r).          
+0005bc20: 2020 7969 656c 6420 6c5b 7369 3a73 692b    yield l[si:si+
+0005bc30: 2864 2b31 2069 6620 6920 3c20 7220 656c  (d+1 if i < r el
+0005bc40: 7365 2064 295d 0a20 2020 2069 6d70 6f72  se d)].    impor
+0005bc50: 7420 6e75 6d70 7920 6173 206e 700a 2020  t numpy as np.  
+0005bc60: 2020 6e65 7778 203d 206c 6973 7428 2063    newx = list( c
+0005bc70: 6875 6e6b 7328 206d 6d5f 7769 6465 5f63  hunks( mm_wide_c
+0005bc80: 7376 732c 206e 5f77 6f72 6b65 7273 2029  svs, n_workers )
+0005bc90: 2029 0a20 2020 2069 6d70 6f72 7420 7061   ).    import pa
+0005bca0: 6e64 6173 2061 7320 7064 0a20 2020 2061  ndas as pd.    a
+0005bcb0: 6c6c 6466 203d 2070 642e 4461 7461 4672  lldf = pd.DataFr
+0005bcc0: 616d 6528 290a 2020 2020 616c 6c64 6661  ame().    alldfa
+0005bcd0: 7667 203d 2070 642e 4461 7461 4672 616d  vg = pd.DataFram
+0005bce0: 6528 290a 2020 2020 7769 7468 2066 7574  e().    with fut
+0005bcf0: 7572 6573 2e54 6872 6561 6450 6f6f 6c45  ures.ThreadPoolE
+0005bd00: 7865 6375 746f 7228 6d61 785f 776f 726b  xecutor(max_work
+0005bd10: 6572 733d 6e5f 776f 726b 6572 7329 2061  ers=n_workers) a
+0005bd20: 7320 6578 6563 7574 6f72 3a0a 2020 2020  s executor:.    
+0005bd30: 2020 2020 746f 5f64 6f20 3d20 5b5d 0a20      to_do = []. 
+0005bd40: 2020 2020 2020 2066 6f72 2067 726f 7570         for group
+0005bd50: 2069 6e20 7261 6e67 6528 6c65 6e28 6e65   in range(len(ne
+0005bd60: 7778 2929 203a 0a20 2020 2020 2020 2020  wx)) :.         
+0005bd70: 2020 2066 7574 7572 6520 3d20 6578 6563     future = exec
+0005bd80: 7574 6f72 2e73 7562 6d69 7428 6269 6e64  utor.submit(bind
+0005bd90: 5f77 6964 655f 6d6d 5f63 7376 732c 206e  _wide_mm_csvs, n
+0005bda0: 6577 785b 6772 6f75 705d 2029 0a20 2020  ewx[group] ).   
+0005bdb0: 2020 2020 2020 2020 2074 6f5f 646f 2e61           to_do.a
+0005bdc0: 7070 656e 6428 6675 7475 7265 290a 2020  ppend(future).  
+0005bdd0: 2020 2020 2020 7265 7375 6c74 7320 3d20        results = 
+0005bde0: 5b5d 0a20 2020 2020 2020 2066 6f72 2066  [].        for f
+0005bdf0: 7574 7572 6520 696e 2066 7574 7572 6573  uture in futures
+0005be00: 2e61 735f 636f 6d70 6c65 7465 6428 746f  .as_completed(to
+0005be10: 5f64 6f29 3a0a 2020 2020 2020 2020 2020  _do):.          
+0005be20: 2020 7265 7330 2c20 7265 7331 203d 2066    res0, res1 = f
+0005be30: 7574 7572 652e 7265 7375 6c74 2829 0a20  uture.result(). 
+0005be40: 2020 2020 2020 2020 2020 2061 6c6c 6466             alldf
+0005be50: 3d70 642e 636f 6e63 6174 2820 205b 616c  =pd.concat(  [al
+0005be60: 6c64 662c 2072 6573 3020 5d2c 2061 7869  ldf, res0 ], axi
+0005be70: 733d 302c 2069 676e 6f72 655f 696e 6465  s=0, ignore_inde
+0005be80: 783d 4661 6c73 6520 290a 2020 2020 2020  x=False ).      
+0005be90: 2020 2020 2020 616c 6c64 6661 7667 3d70        alldfavg=p
+0005bea0: 642e 636f 6e63 6174 2820 205b 616c 6c64  d.concat(  [alld
+0005beb0: 6661 7667 2c20 7265 7331 205d 2c20 6178  favg, res1 ], ax
+0005bec0: 6973 3d30 2c20 6967 6e6f 7265 5f69 6e64  is=0, ignore_ind
+0005bed0: 6578 3d46 616c 7365 2029 0a20 2020 2072  ex=False ).    r
+0005bee0: 6574 7572 6e20 616c 6c64 662c 2061 6c6c  eturn alldf, all
+0005bef0: 6466 6176 670a 0a0a 6465 6620 6765 745f  dfavg...def get_
+0005bf00: 6e61 6d65 735f 6672 6f6d 5f64 6174 615f  names_from_data_
+0005bf10: 6672 616d 6528 782c 2064 656d 6f67 496e  frame(x, demogIn
+0005bf20: 2c20 6578 636c 7573 696f 6e73 3d4e 6f6e  , exclusions=Non
+0005bf30: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
+0005bf40: 6461 7461 203d 207b 274e 616d 6527 3a5b  data = {'Name':[
+0005bf50: 2754 6f6d 272c 2027 6e69 636b 272c 2027  'Tom', 'nick', '
+0005bf60: 6b72 6973 6827 2c20 276a 6163 6b27 5d2c  krish', 'jack'],
+0005bf70: 2027 4167 6527 3a5b 3230 2c20 3231 2c20   'Age':[20, 21, 
+0005bf80: 3139 2c20 3138 5d7d 0a20 2020 2061 6e74  19, 18]}.    ant
+0005bf90: 7370 796d 6d2e 6765 745f 6e61 6d65 735f  spymm.get_names_
+0005bfa0: 6672 6f6d 5f64 6174 615f 6672 616d 6528  from_data_frame(
+0005bfb0: 205b 2765 275d 2c20 6466 2029 0a20 2020   ['e'], df ).   
+0005bfc0: 2061 6e74 7370 796d 6d2e 6765 745f 6e61   antspymm.get_na
+0005bfd0: 6d65 735f 6672 6f6d 5f64 6174 615f 6672  mes_from_data_fr
+0005bfe0: 616d 6528 205b 2761 272c 2765 275d 2c20  ame( ['a','e'], 
+0005bff0: 6466 2029 0a20 2020 2061 6e74 7370 796d  df ).    antspym
+0005c000: 6d2e 6765 745f 6e61 6d65 735f 6672 6f6d  m.get_names_from
+0005c010: 5f64 6174 615f 6672 616d 6528 205b 2765  _data_frame( ['e
+0005c020: 275d 2c20 6466 2c20 6578 636c 7573 696f  '], df, exclusio
+0005c030: 6e73 3d27 4e27 2029 0a20 2020 2022 2222  ns='N' ).    """
+0005c040: 0a20 2020 2023 2043 6865 636b 2069 6620  .    # Check if 
+0005c050: 7820 6973 2061 2073 7472 696e 6720 616e  x is a string an
+0005c060: 6420 636f 6e76 6572 7420 6974 2074 6f20  d convert it to 
+0005c070: 6120 6c69 7374 0a20 2020 2069 6620 6973  a list.    if is
+0005c080: 696e 7374 616e 6365 2878 2c20 7374 7229  instance(x, str)
+0005c090: 3a0a 2020 2020 2020 2020 7820 3d20 5b78  :.        x = [x
+0005c0a0: 5d0a 2020 2020 6465 6620 6765 745f 756e  ].    def get_un
+0005c0b0: 6971 7565 2820 7171 2029 3a0a 2020 2020  ique( qq ):.    
+0005c0c0: 2020 2020 756e 6971 7565 203d 205b 5d0a      unique = [].
+0005c0d0: 2020 2020 2020 2020 666f 7220 6e75 6d62          for numb
+0005c0e0: 6572 2069 6e20 7171 3a0a 2020 2020 2020  er in qq:.      
+0005c0f0: 2020 2020 2020 6966 206e 756d 6265 7220        if number 
+0005c100: 696e 2075 6e69 7175 653a 0a20 2020 2020  in unique:.     
+0005c110: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0005c120: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
+0005c130: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0005c140: 2020 2020 2020 756e 6971 7565 2e61 7070        unique.app
+0005c150: 656e 6428 6e75 6d62 6572 290a 2020 2020  end(number).    
+0005c160: 2020 2020 7265 7475 726e 2075 6e69 7175      return uniqu
+0005c170: 650a 2020 2020 6f75 746e 616d 6573 203d  e.    outnames =
+0005c180: 206c 6973 7428 6465 6d6f 6749 6e2e 636f   list(demogIn.co
+0005c190: 6c75 6d6e 735b 6465 6d6f 6749 6e2e 636f  lumns[demogIn.co
+0005c1a0: 6c75 6d6e 732e 7374 722e 636f 6e74 6169  lumns.str.contai
+0005c1b0: 6e73 2878 5b30 5d29 5d29 0a20 2020 2069  ns(x[0])]).    i
+0005c1c0: 6620 6c65 6e28 7829 203e 2031 3a0a 2020  f len(x) > 1:.  
+0005c1d0: 2020 2020 2020 666f 7220 7920 696e 2078        for y in x
+0005c1e0: 5b31 3a5d 3a0a 2020 2020 2020 2020 2020  [1:]:.          
+0005c1f0: 2020 6f75 746e 616d 6573 203d 205b 6920    outnames = [i 
+0005c200: 666f 7220 6920 696e 206f 7574 6e61 6d65  for i in outname
+0005c210: 7320 6966 2079 2069 6e20 695d 0a20 2020  s if y in i].   
+0005c220: 206f 7574 6e61 6d65 7320 3d20 6765 745f   outnames = get_
+0005c230: 756e 6971 7565 2820 6f75 746e 616d 6573  unique( outnames
+0005c240: 2029 0a20 2020 2069 6620 6578 636c 7573   ).    if exclus
+0005c250: 696f 6e73 2069 7320 6e6f 7420 4e6f 6e65  ions is not None
+0005c260: 3a0a 2020 2020 2020 2020 746f 6578 636c  :.        toexcl
+0005c270: 7564 6520 3d20 5b6e 616d 6520 666f 7220  ude = [name for 
+0005c280: 6e61 6d65 2069 6e20 6f75 746e 616d 6573  name in outnames
+0005c290: 2069 6620 6578 636c 7573 696f 6e73 5b30   if exclusions[0
+0005c2a0: 5d20 696e 206e 616d 6520 5d0a 2020 2020  ] in name ].    
+0005c2b0: 2020 2020 6966 206c 656e 2865 7863 6c75      if len(exclu
+0005c2c0: 7369 6f6e 7329 203e 2031 3a0a 2020 2020  sions) > 1:.    
+0005c2d0: 2020 2020 2020 2020 666f 7220 7a7a 2069          for zz i
+0005c2e0: 6e20 6578 636c 7573 696f 6e73 5b31 3a5d  n exclusions[1:]
+0005c2f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0005c300: 2020 746f 6578 636c 7564 652e 6578 7465    toexclude.exte
+0005c310: 6e64 285b 6e61 6d65 2066 6f72 206e 616d  nd([name for nam
+0005c320: 6520 696e 206f 7574 6e61 6d65 7320 6966  e in outnames if
+0005c330: 207a 7a20 696e 206e 616d 6520 5d29 0a20   zz in name ]). 
+0005c340: 2020 2020 2020 2069 6620 6c65 6e28 746f         if len(to
+0005c350: 6578 636c 7564 6529 203e 2030 3a0a 2020  exclude) > 0:.  
+0005c360: 2020 2020 2020 2020 2020 6f75 746e 616d            outnam
+0005c370: 6573 203d 205b 6e61 6d65 2066 6f72 206e  es = [name for n
+0005c380: 616d 6520 696e 206f 7574 6e61 6d65 7320  ame in outnames 
+0005c390: 6966 206e 616d 6520 6e6f 7420 696e 2074  if name not in t
+0005c3a0: 6f65 7863 6c75 6465 5d0a 2020 2020 7265  oexclude].    re
+0005c3b0: 7475 726e 206f 7574 6e61 6d65 730a 0a0a  turn outnames...
+0005c3c0: 6465 6620 6176 6572 6167 655f 6d6d 5f64  def average_mm_d
+0005c3d0: 6628 206a 6d6d 5f69 6e2c 2064 6961 676e  f( jmm_in, diagn
+0005c3e0: 6f73 7469 635f 6e3d 3235 2c20 636f 7272  ostic_n=25, corr
+0005c3f0: 5f74 6872 6573 683d 302e 392c 2076 6572  _thresh=0.9, ver
+0005c400: 626f 7365 3d46 616c 7365 2029 3a0a 2020  bose=False ):.  
+0005c410: 2020 2222 220a 2020 2020 6a6d 726f 7761    """.    jmrowa
+0005c420: 7667 2c20 6a6d 6d63 6f6c 6176 672c 2064  vg, jmmcolavg, d
+0005c430: 6961 676e 6f73 7469 6373 203d 2061 6e74  iagnostics = ant
+0005c440: 7370 796d 6d2e 6176 6572 6167 655f 6d6d  spymm.average_mm
+0005c450: 5f64 6628 206a 6d6d 5f69 6e2c 2076 6572  _df( jmm_in, ver
+0005c460: 626f 7365 3d54 7275 6520 290a 2020 2020  bose=True ).    
+0005c470: 2222 220a 0a20 2020 206a 6d6d 203d 206a  """..    jmm = j
+0005c480: 6d6d 5f69 6e2e 636f 7079 2829 0a20 2020  mm_in.copy().   
+0005c490: 2064 7863 6f6c 733d 5b27 7375 626a 6563   dxcols=['subjec
+0005c4a0: 7469 6431 272c 2773 7562 6a65 6374 6964  tid1','subjectid
+0005c4b0: 3227 2c27 6d6f 6461 6c69 7479 6964 272c  2','modalityid',
+0005c4c0: 276a 6f69 6e69 6427 2c27 636f 7272 656c  'joinid','correl
+0005c4d0: 6174 696f 6e27 2c27 6469 7374 616e 6365  ation','distance
+0005c4e0: 275d 0a20 2020 206a 6f69 6e44 6961 676e  '].    joinDiagn
+0005c4f0: 6f73 7469 6373 203d 2070 642e 4461 7461  ostics = pd.Data
+0005c500: 4672 616d 6528 2063 6f6c 756d 6e73 203d  Frame( columns =
+0005c510: 2064 7863 6f6c 7320 290a 2020 2020 6e61   dxcols ).    na
+0005c520: 6e4c 6973 743d 5b6d 6174 682e 6e61 6e5d  nList=[math.nan]
+0005c530: 0a20 2020 2064 6566 2072 6f62 2878 2c20  .    def rob(x, 
+0005c540: 793d 302e 3939 293a 0a20 2020 2020 2020  y=0.99):.       
+0005c550: 2078 5b78 203e 206e 702e 7175 616e 7469   x[x > np.quanti
+0005c560: 6c65 2878 2c20 792c 206e 616e 5f70 6f6c  le(x, y, nan_pol
+0005c570: 6963 793d 226f 6d69 7422 295d 203d 206e  icy="omit")] = n
+0005c580: 702e 6e61 6e0a 2020 2020 2020 2020 7265  p.nan.        re
+0005c590: 7475 726e 2078 0a0a 2020 2020 6a6d 6d20  turn x..    jmm 
+0005c5a0: 3d20 6a6d 6d2e 7265 706c 6163 6528 7227  = jmm.replace(r'
+0005c5b0: 5e5c 732a 2427 2c20 6e70 2e6e 616e 2c20  ^\s*$', np.nan, 
+0005c5c0: 7265 6765 783d 5472 7565 290a 0a20 2020  regex=True)..   
+0005c5d0: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+0005c5e0: 2020 2020 2070 7269 6e74 2822 646f 2072       print("do r
+0005c5f0: 7366 4d52 4922 290a 2020 2020 2320 6865  sfMRI").    # he
+0005c600: 7265 202d 2077 6520 6669 7273 7420 6861  re - we first ha
+0005c610: 7665 2074 6f20 6176 6572 6167 6520 7769  ve to average wi
+0005c620: 7468 696e 2065 6163 6820 726f 770a 2020  thin each row.  
+0005c630: 2020 6474 3020 3d20 6765 745f 6e61 6d65    dt0 = get_name
+0005c640: 735f 6672 6f6d 5f64 6174 615f 6672 616d  s_from_data_fram
+0005c650: 6528 5b22 7273 664d 5249 225d 2c20 6a6d  e(["rsfMRI"], jm
+0005c660: 6d2c 2065 7863 6c75 7369 6f6e 733d 5b22  m, exclusions=["
+0005c670: 556e 6e61 6d65 6422 2c20 2272 7366 4d52  Unnamed", "rsfMR
+0005c680: 495f 4c52 222c 2022 7273 664d 5249 5f52  I_LR", "rsfMRI_R
+0005c690: 4c22 5d29 0a20 2020 2064 7431 203d 2067  L"]).    dt1 = g
+0005c6a0: 6574 5f6e 616d 6573 5f66 726f 6d5f 6461  et_names_from_da
+0005c6b0: 7461 5f66 7261 6d65 285b 2272 7366 4d52  ta_frame(["rsfMR
+0005c6c0: 495f 524c 225d 2c20 6a6d 6d2c 2065 7863  I_RL"], jmm, exc
+0005c6d0: 6c75 7369 6f6e 733d 5b22 556e 6e61 6d65  lusions=["Unname
+0005c6e0: 6422 5d29 0a20 2020 2069 6620 6c65 6e28  d"]).    if len(
+0005c6f0: 2064 7430 2029 203e 2030 2061 6e64 206c   dt0 ) > 0 and l
+0005c700: 656e 2820 6474 3120 2920 3e20 303a 0a20  en( dt1 ) > 0:. 
+0005c710: 2020 2020 2020 2066 6c69 6420 3d20 6474         flid = dt
+0005c720: 305b 305d 0a20 2020 2020 2020 2077 726f  0[0].        wro
+0005c730: 7773 203d 205b 5d0a 2020 2020 2020 2020  ws = [].        
+0005c740: 666f 7220 6920 696e 2072 616e 6765 286a  for i in range(j
+0005c750: 6d6d 2e73 6861 7065 5b30 5d29 3a0a 2020  mm.shape[0]):.  
+0005c760: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+0005c770: 2070 642e 6973 6e61 286a 6d6d 5b64 7430   pd.isna(jmm[dt0
+0005c780: 5b31 5d5d 5b69 5d29 206f 7220 6e6f 7420  [1]][i]) or not 
+0005c790: 7064 2e69 736e 6128 6a6d 6d5b 6474 315b  pd.isna(jmm[dt1[
+0005c7a0: 315d 5d5b 695d 2920 3a0a 2020 2020 2020  1]][i]) :.      
+0005c7b0: 2020 2020 2020 2020 2020 7772 6f77 732e            wrows.
+0005c7c0: 6170 7065 6e64 2869 290a 2020 2020 2020  append(i).      
+0005c7d0: 2020 666f 7220 6b20 696e 2077 726f 7773    for k in wrows
+0005c7e0: 3a0a 2020 2020 2020 2020 2020 2020 7631  :.            v1
+0005c7f0: 203d 206a 6d6d 2e69 6c6f 635b 6b5d 5b64   = jmm.iloc[k][d
+0005c800: 7430 5b31 3a5d 5d2e 6173 7479 7065 2866  t0[1:]].astype(f
+0005c810: 6c6f 6174 290a 2020 2020 2020 2020 2020  loat).          
+0005c820: 2020 7632 203d 206a 6d6d 2e69 6c6f 635b    v2 = jmm.iloc[
+0005c830: 6b5d 5b64 7431 5b31 3a5d 5d2e 6173 7479  k][dt1[1:]].asty
+0005c840: 7065 2866 6c6f 6174 290a 2020 2020 2020  pe(float).      
+0005c850: 2020 2020 2020 7676 6563 203d 205b 7631        vvec = [v1
+0005c860: 5b30 5d2c 2076 325b 305d 5d0a 2020 2020  [0], v2[0]].    
+0005c870: 2020 2020 2020 2020 6966 2061 6e79 287e          if any(~
+0005c880: 6e70 2e69 736e 616e 2876 7665 6329 293a  np.isnan(vvec)):
+0005c890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005c8a0: 206d 796e 6e61 203d 205b 6920 666f 7220   mynna = [i for 
+0005c8b0: 692c 2078 2069 6e20 656e 756d 6572 6174  i, x in enumerat
+0005c8c0: 6528 7676 6563 2920 6966 207e 6e70 2e69  e(vvec) if ~np.i
+0005c8d0: 736e 616e 2878 295d 0a20 2020 2020 2020  snan(x)].       
+0005c8e0: 2020 2020 2020 2020 206a 6d6d 2e69 6c6f           jmm.ilo
+0005c8f0: 635b 6b5d 5b64 7430 5b30 5d5d 203d 2027  c[k][dt0[0]] = '
+0005c900: 7273 664d 5249 270a 2020 2020 2020 2020  rsfMRI'.        
+0005c910: 2020 2020 2020 2020 6966 206c 656e 286d          if len(m
+0005c920: 796e 6e61 2920 3d3d 2031 3a0a 2020 2020  ynna) == 1:.    
+0005c930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005c940: 6966 206d 796e 6e61 5b30 5d20 3d3d 2030  if mynna[0] == 0
+0005c950: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0005c960: 2020 2020 2020 2020 2020 6a6d 6d2e 696c            jmm.il
+0005c970: 6f63 5b6b 5d5b 6474 305b 313a 5d5d 203d  oc[k][dt0[1:]] =
+0005c980: 2076 310a 2020 2020 2020 2020 2020 2020   v1.            
+0005c990: 2020 2020 2020 2020 6966 206d 796e 6e61          if mynna
+0005c9a0: 5b30 5d20 3d3d 2031 3a0a 2020 2020 2020  [0] == 1:.      
 0005c9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c9c0: 2020 2070 7269 6e74 2820 6a6f 696e 4469     print( joinDi
-0005c9d0: 6167 6e6f 7374 6963 734c 6f63 2029 0a20  agnosticsLoc ). 
-0005c9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c9f0: 2020 206a 6f69 6e44 6961 676e 6f73 7469     joinDiagnosti
-0005ca00: 6373 203d 2070 642e 636f 6e63 6174 2820  cs = pd.concat( 
-0005ca10: 5b6a 6f69 6e44 6961 676e 6f73 7469 6373  [joinDiagnostics
-0005ca20: 2c20 6a6f 696e 4469 6167 6e6f 7374 6963  , joinDiagnostic
-0005ca30: 734c 6f63 5d2c 2061 7869 733d 302c 2069  sLoc], axis=0, i
-0005ca40: 676e 6f72 655f 696e 6465 783d 4661 6c73  gnore_index=Fals
-0005ca50: 6520 290a 0a20 2020 2069 6620 7665 7262  e )..    if verb
-0005ca60: 6f73 653a 0a20 2020 2020 2020 2070 7269  ose:.        pri
-0005ca70: 6e74 2822 646f 2044 5449 2229 0a20 2020  nt("do DTI").   
-0005ca80: 2023 2068 6572 6520 2d20 7765 2066 6972   # here - we fir
-0005ca90: 7374 2068 6176 6520 746f 2061 7665 7261  st have to avera
-0005caa0: 6765 2077 6974 6869 6e20 6561 6368 2072  ge within each r
-0005cab0: 6f77 0a20 2020 2064 7430 203d 2067 6574  ow.    dt0 = get
-0005cac0: 5f6e 616d 6573 5f66 726f 6d5f 6461 7461  _names_from_data
-0005cad0: 5f66 7261 6d65 285b 2244 5449 225d 2c20  _frame(["DTI"], 
-0005cae0: 6a6d 6d2c 2065 7863 6c75 7369 6f6e 733d  jmm, exclusions=
-0005caf0: 5b22 556e 6e61 6d65 6422 2c20 2244 5449  ["Unnamed", "DTI
-0005cb00: 5f4c 5222 2c20 2244 5449 5f52 4c22 5d29  _LR", "DTI_RL"])
-0005cb10: 0a20 2020 2064 7431 203d 2067 6574 5f6e  .    dt1 = get_n
-0005cb20: 616d 6573 5f66 726f 6d5f 6461 7461 5f66  ames_from_data_f
-0005cb30: 7261 6d65 285b 2244 5449 5f4c 5222 5d2c  rame(["DTI_LR"],
-0005cb40: 206a 6d6d 2c20 6578 636c 7573 696f 6e73   jmm, exclusions
-0005cb50: 3d5b 2255 6e6e 616d 6564 225d 290a 2020  =["Unnamed"]).  
-0005cb60: 2020 6474 3220 3d20 6765 745f 6e61 6d65    dt2 = get_name
-0005cb70: 735f 6672 6f6d 5f64 6174 615f 6672 616d  s_from_data_fram
-0005cb80: 6528 205b 2244 5449 5f52 4c22 5d2c 206a  e( ["DTI_RL"], j
-0005cb90: 6d6d 2c20 6578 636c 7573 696f 6e73 3d5b  mm, exclusions=[
-0005cba0: 2255 6e6e 616d 6564 225d 290a 2020 2020  "Unnamed"]).    
-0005cbb0: 666c 6964 203d 2064 7430 5b30 5d0a 2020  flid = dt0[0].  
-0005cbc0: 2020 7772 6f77 7320 3d20 5b5d 0a20 2020    wrows = [].   
-0005cbd0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-0005cbe0: 6a6d 6d2e 7368 6170 655b 305d 293a 0a20  jmm.shape[0]):. 
-0005cbf0: 2020 2020 2020 2069 6620 6e6f 7420 7064         if not pd
-0005cc00: 2e69 736e 6128 6a6d 6d5b 6474 305b 315d  .isna(jmm[dt0[1]
-0005cc10: 5d5b 695d 2920 6f72 206e 6f74 2070 642e  ][i]) or not pd.
-0005cc20: 6973 6e61 286a 6d6d 5b64 7431 5b31 5d5d  isna(jmm[dt1[1]]
-0005cc30: 5b69 5d29 206f 7220 6e6f 7420 7064 2e69  [i]) or not pd.i
-0005cc40: 736e 6128 6a6d 6d5b 6474 325b 315d 5d5b  sna(jmm[dt2[1]][
-0005cc50: 695d 293a 0a20 2020 2020 2020 2020 2020  i]):.           
-0005cc60: 2077 726f 7773 2e61 7070 656e 6428 6929   wrows.append(i)
-0005cc70: 0a20 2020 2066 6f72 206b 2069 6e20 7772  .    for k in wr
-0005cc80: 6f77 733a 0a20 2020 2020 2020 2076 3120  ows:.        v1 
-0005cc90: 3d20 6a6d 6d2e 6c6f 635b 6b2c 2064 7430  = jmm.loc[k, dt0
-0005cca0: 5b31 3a5d 5d2e 6173 7479 7065 2866 6c6f  [1:]].astype(flo
-0005ccb0: 6174 290a 2020 2020 2020 2020 7632 203d  at).        v2 =
-0005ccc0: 206a 6d6d 2e6c 6f63 5b6b 2c20 6474 315b   jmm.loc[k, dt1[
-0005ccd0: 313a 5d5d 2e61 7374 7970 6528 666c 6f61  1:]].astype(floa
-0005cce0: 7429 0a20 2020 2020 2020 2076 3320 3d20  t).        v3 = 
-0005ccf0: 6a6d 6d2e 6c6f 635b 6b2c 2064 7432 5b31  jmm.loc[k, dt2[1
-0005cd00: 3a5d 5d2e 6173 7479 7065 2866 6c6f 6174  :]].astype(float
-0005cd10: 290a 2020 2020 2020 2020 6368 6563 6b63  ).        checkc
-0005cd20: 6f6c 203d 2064 7430 5b35 5d0a 2020 2020  ol = dt0[5].    
-0005cd30: 2020 2020 6966 206e 6f74 206e 702e 6973      if not np.is
-0005cd40: 6e61 6e28 7631 5b63 6865 636b 636f 6c5d  nan(v1[checkcol]
-0005cd50: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-0005cd60: 6620 7631 5b63 6865 636b 636f 6c5d 203c  f v1[checkcol] <
-0005cd70: 2030 2e32 353a 0a20 2020 2020 2020 2020   0.25:.         
-0005cd80: 2020 2020 2020 2076 312e 7265 706c 6163         v1.replac
-0005cd90: 6528 6e70 2e6e 616e 2c20 696e 706c 6163  e(np.nan, inplac
-0005cda0: 653d 5472 7565 290a 2020 2020 2020 2020  e=True).        
-0005cdb0: 6368 6563 6b63 6f6c 203d 2064 7431 5b35  checkcol = dt1[5
-0005cdc0: 5d0a 2020 2020 2020 2020 6966 206e 6f74  ].        if not
-0005cdd0: 206e 702e 6973 6e61 6e28 7632 5b63 6865   np.isnan(v2[che
-0005cde0: 636b 636f 6c5d 293a 0a20 2020 2020 2020  ckcol]):.       
-0005cdf0: 2020 2020 2069 6620 7632 5b63 6865 636b       if v2[check
-0005ce00: 636f 6c5d 203c 2030 2e32 353a 0a20 2020  col] < 0.25:.   
-0005ce10: 2020 2020 2020 2020 2020 2020 2076 322e               v2.
-0005ce20: 7265 706c 6163 6528 6e70 2e6e 616e 2c20  replace(np.nan, 
-0005ce30: 696e 706c 6163 653d 5472 7565 290a 2020  inplace=True).  
-0005ce40: 2020 2020 2020 6368 6563 6b63 6f6c 203d        checkcol =
-0005ce50: 2064 7432 5b35 5d0a 2020 2020 2020 2020   dt2[5].        
-0005ce60: 6966 206e 6f74 206e 702e 6973 6e61 6e28  if not np.isnan(
-0005ce70: 7633 5b63 6865 636b 636f 6c5d 293a 0a20  v3[checkcol]):. 
-0005ce80: 2020 2020 2020 2020 2020 2069 6620 7633             if v3
-0005ce90: 5b63 6865 636b 636f 6c5d 203c 2030 2e32  [checkcol] < 0.2
-0005cea0: 353a 0a20 2020 2020 2020 2020 2020 2020  5:.             
-0005ceb0: 2020 2076 332e 7265 706c 6163 6528 6e70     v3.replace(np
-0005cec0: 2e6e 616e 2c20 696e 706c 6163 653d 5472  .nan, inplace=Tr
-0005ced0: 7565 290a 2020 2020 2020 2020 7676 6563  ue).        vvec
-0005cee0: 203d 205b 7631 5b30 5d2c 2076 325b 305d   = [v1[0], v2[0]
-0005cef0: 2c20 7633 5b30 5d5d 0a20 2020 2020 2020  , v3[0]].       
-0005cf00: 2069 6620 616e 7928 7e6e 702e 6973 6e61   if any(~np.isna
-0005cf10: 6e28 7676 6563 2929 3a0a 2020 2020 2020  n(vvec)):.      
-0005cf20: 2020 2020 2020 6d79 6e6e 6120 3d20 5b69        mynna = [i
-0005cf30: 2066 6f72 2069 2c20 7820 696e 2065 6e75   for i, x in enu
-0005cf40: 6d65 7261 7465 2876 7665 6329 2069 6620  merate(vvec) if 
-0005cf50: 7e6e 702e 6973 6e61 6e28 7829 5d0a 2020  ~np.isnan(x)].  
-0005cf60: 2020 2020 2020 2020 2020 6a6d 6d2e 6c6f            jmm.lo
-0005cf70: 635b 6b2c 2064 7430 5b30 5d5d 203d 2027  c[k, dt0[0]] = '
-0005cf80: 4454 4927 0a20 2020 2020 2020 2020 2020  DTI'.           
-0005cf90: 2069 6620 6c65 6e28 6d79 6e6e 6129 203d   if len(mynna) =
-0005cfa0: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
-0005cfb0: 2020 2020 2069 6620 6d79 6e6e 615b 305d       if mynna[0]
-0005cfc0: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-0005cfd0: 2020 2020 2020 2020 2020 206a 6d6d 2e6c             jmm.l
-0005cfe0: 6f63 5b6b 2c20 6474 305b 313a 5d5d 203d  oc[k, dt0[1:]] =
-0005cff0: 2076 310a 2020 2020 2020 2020 2020 2020   v1.            
-0005d000: 2020 2020 6966 206d 796e 6e61 5b30 5d20      if mynna[0] 
-0005d010: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
-0005d020: 2020 2020 2020 2020 2020 6a6d 6d2e 6c6f            jmm.lo
-0005d030: 635b 6b2c 2064 7430 5b31 3a5d 5d20 3d20  c[k, dt0[1:]] = 
-0005d040: 7632 0a20 2020 2020 2020 2020 2020 2020  v2.             
-0005d050: 2020 2069 6620 6d79 6e6e 615b 305d 203d     if mynna[0] =
-0005d060: 3d20 323a 0a20 2020 2020 2020 2020 2020  = 2:.           
-0005d070: 2020 2020 2020 2020 206a 6d6d 2e6c 6f63           jmm.loc
-0005d080: 5b6b 2c20 6474 305b 313a 5d5d 203d 2076  [k, dt0[1:]] = v
-0005d090: 330a 2020 2020 2020 2020 2020 2020 656c  3.            el
-0005d0a0: 6966 206c 656e 286d 796e 6e61 2920 3e20  if len(mynna) > 
-0005d0b0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-0005d0c0: 2020 2069 6620 6d79 6e6e 615b 305d 203d     if mynna[0] =
-0005d0d0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-0005d0e0: 2020 2020 2020 2020 206a 6d6d 2e6c 6f63           jmm.loc
-0005d0f0: 5b6b 2c20 6474 305b 313a 5d5d 203d 2076  [k, dt0[1:]] = v
-0005d100: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-0005d110: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0005d120: 2020 2020 2020 2020 2020 2020 6a6f 696e              join
-0005d130: 4469 6167 6e6f 7374 6963 734c 6f63 203d  DiagnosticsLoc =
-0005d140: 2070 642e 4461 7461 4672 616d 6528 2063   pd.DataFrame( c
-0005d150: 6f6c 756d 6e73 203d 2064 7863 6f6c 732c  olumns = dxcols,
-0005d160: 2069 6e64 6578 3d72 616e 6765 2831 2920   index=range(1) 
-0005d170: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0005d180: 2020 2020 2020 6d79 636f 7272 203d 206e        mycorr = n
-0005d190: 702e 636f 7272 636f 6566 2820 7632 5b30  p.corrcoef( v2[0
-0005d1a0: 3a64 6961 676e 6f73 7469 635f 6e5d 2e76  :diagnostic_n].v
-0005d1b0: 616c 7565 732c 2076 335b 303a 6469 6167  alues, v3[0:diag
-0005d1c0: 6e6f 7374 6963 5f6e 5d2e 7661 6c75 6573  nostic_n].values
-0005d1d0: 2029 5b30 2c31 5d0a 2020 2020 2020 2020   )[0,1].        
-0005d1e0: 2020 2020 2020 2020 2020 2020 6d79 6572              myer
-0005d1f0: 723d 6e70 2e73 7172 7428 6e70 2e6d 6561  r=np.sqrt(np.mea
-0005d200: 6e28 2876 325b 303a 6469 6167 6e6f 7374  n((v2[0:diagnost
-0005d210: 6963 5f6e 5d2e 7661 6c75 6573 202d 2076  ic_n].values - v
-0005d220: 335b 303a 6469 6167 6e6f 7374 6963 5f6e  3[0:diagnostic_n
-0005d230: 5d2e 7661 6c75 6573 292a 2a32 2929 0a20  ].values)**2)). 
-0005d240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005d250: 2020 206a 6f69 6e44 6961 676e 6f73 7469     joinDiagnosti
-0005d260: 6373 4c6f 632e 696c 6f63 5b30 5d20 3d20  csLoc.iloc[0] = 
-0005d270: 5b6a 6d6d 2e6c 6f63 5b6b 2c27 755f 6869  [jmm.loc[k,'u_hi
-0005d280: 6572 5f69 6427 5d2c 6d61 7468 2e6e 616e  er_id'],math.nan
-0005d290: 2c27 4454 4927 2c27 636f 6c61 7667 272c  ,'DTI','colavg',
-0005d2a0: 6d79 636f 7272 2c6d 7965 7272 5d0a 2020  mycorr,myerr].  
-0005d2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005d2c0: 2020 6966 206d 7963 6f72 7220 3e20 636f    if mycorr > co
-0005d2d0: 7272 5f74 6872 6573 683a 0a20 2020 2020  rr_thresh:.     
-0005d2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005d2f0: 2020 206a 6d6d 2e6c 6f63 5b6b 2c20 6474     jmm.loc[k, dt
-0005d300: 305b 313a 5d5d 203d 2076 322e 7661 6c75  0[1:]] = v2.valu
-0005d310: 6573 2a30 2e35 202b 2076 332e 7661 6c75  es*0.5 + v3.valu
-0005d320: 6573 2a30 2e35 0a20 2020 2020 2020 2020  es*0.5.         
-0005d330: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0005d340: 2023 0a20 2020 2020 2020 2020 2020 2020   #.             
-0005d350: 2020 2020 2020 2020 2020 206a 6d6d 2e6c             jmm.l
-0005d360: 6f63 5b6b 2c20 6474 305b 313a 5d5d 203d  oc[k, dt0[1:]] =
-0005d370: 206e 616e 4c69 7374 202a 206c 656e 2820   nanList * len( 
-0005d380: 6474 305b 313a 5d20 290a 2020 2020 2020  dt0[1:] ).      
-0005d390: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0005d3a0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-0005d3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005d3c0: 2020 7072 696e 7428 206a 6f69 6e44 6961    print( joinDia
-0005d3d0: 676e 6f73 7469 6373 4c6f 6320 290a 2020  gnosticsLoc ).  
-0005d3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005d3f0: 2020 6a6f 696e 4469 6167 6e6f 7374 6963    joinDiagnostic
-0005d400: 7320 3d20 7064 2e63 6f6e 6361 7428 205b  s = pd.concat( [
-0005d410: 6a6f 696e 4469 6167 6e6f 7374 6963 732c  joinDiagnostics,
-0005d420: 206a 6f69 6e44 6961 676e 6f73 7469 6373   joinDiagnostics
-0005d430: 4c6f 635d 2c20 6178 6973 3d30 2c20 6967  Loc], axis=0, ig
-0005d440: 6e6f 7265 5f69 6e64 6578 3d46 616c 7365  nore_index=False
-0005d450: 2029 0a0a 0a20 2020 2023 2066 6972 7374   )...    # first
-0005d460: 2074 6173 6b20 2d20 736f 7274 2062 7920   task - sort by 
-0005d470: 755f 6869 6572 5f69 640a 2020 2020 6a6d  u_hier_id.    jm
-0005d480: 6d20 3d20 6a6d 6d2e 736f 7274 5f76 616c  m = jmm.sort_val
-0005d490: 7565 7328 2022 755f 6869 6572 5f69 6422  ues( "u_hier_id"
-0005d4a0: 2029 0a20 2020 2023 2067 6574 2072 6964   ).    # get rid
-0005d4b0: 206f 6620 6a75 6e6b 2063 6f6c 756d 6e73   of junk columns
-0005d4c0: 0a20 2020 2062 6164 6e61 6d65 7320 3d20  .    badnames = 
-0005d4d0: 6765 745f 6e61 6d65 735f 6672 6f6d 5f64  get_names_from_d
-0005d4e0: 6174 615f 6672 616d 6528 205b 2755 6e6e  ata_frame( ['Unn
-0005d4f0: 616d 6564 275d 2c20 6a6d 6d20 290a 2020  amed'], jmm ).  
-0005d500: 2020 6a6d 6d3d 6a6d 6d2e 6472 6f70 2862    jmm=jmm.drop(b
-0005d510: 6164 6e61 6d65 732c 2061 7869 733d 3129  adnames, axis=1)
-0005d520: 0a20 2020 206a 6d6d 3d6a 6d6d 2e73 6574  .    jmm=jmm.set
-0005d530: 5f69 6e64 6578 2822 755f 6869 6572 5f69  _index("u_hier_i
-0005d540: 6422 2c64 726f 703d 4661 6c73 6529 0a20  d",drop=False). 
-0005d550: 2020 2023 2032 6e64 202d 2067 6574 2072     # 2nd - get r
-0005d560: 6964 206f 6620 6475 706c 6963 6174 6564  id of duplicated
-0005d570: 2075 5f68 6965 725f 6964 0a20 2020 206a   u_hier_id.    j
-0005d580: 6d6d 556e 6971 203d 206a 6d6d 2e64 726f  mmUniq = jmm.dro
-0005d590: 705f 6475 706c 6963 6174 6573 2820 7375  p_duplicates( su
-0005d5a0: 6273 6574 3d22 755f 6869 6572 5f69 6422  bset="u_hier_id"
-0005d5b0: 2029 2023 2066 6173 7420 616e 6420 6561   ) # fast and ea
-0005d5c0: 7379 0a20 2020 2023 2066 6f72 2065 6163  sy.    # for eac
-0005d5d0: 6820 6d6f 6461 6c69 7479 2c20 636f 756e  h modality, coun
-0005d5e0: 7420 7768 6963 6820 6964 7320 6861 7665  t which ids have
-0005d5f0: 206d 6f72 6520 7468 616e 206f 6e65 0a20   more than one. 
-0005d600: 2020 206d 6f64 5f6e 616d 6573 203d 2067     mod_names = g
-0005d610: 6574 5f76 616c 6964 5f6d 6f64 616c 6974  et_valid_modalit
-0005d620: 6965 7328 290a 2020 2020 666f 7220 6d6f  ies().    for mo
-0005d630: 645f 6e61 6d65 2069 6e20 6d6f 645f 6e61  d_name in mod_na
-0005d640: 6d65 733a 0a20 2020 2020 2020 2066 6c5f  mes:.        fl_
-0005d650: 6e61 6d65 7320 3d20 6765 745f 6e61 6d65  names = get_name
-0005d660: 735f 6672 6f6d 5f64 6174 615f 6672 616d  s_from_data_fram
-0005d670: 6528 5b6d 6f64 5f6e 616d 655d 2c20 6a6d  e([mod_name], jm
-0005d680: 6d2c 0a20 2020 2020 2020 2020 2020 2065  m,.            e
-0005d690: 7863 6c75 7369 6f6e 733d 5b27 556e 6e61  xclusions=['Unna
-0005d6a0: 6d65 6427 2c22 4454 495f 4c52 222c 2244  med',"DTI_LR","D
-0005d6b0: 5449 5f52 4c22 2c22 7273 664d 5249 5f52  TI_RL","rsfMRI_R
-0005d6c0: 4c22 2c22 7273 664d 5249 5f4c 5222 5d29  L","rsfMRI_LR"])
-0005d6d0: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-0005d6e0: 2066 6c5f 6e61 6d65 7320 2920 3e20 313a   fl_names ) > 1:
-0005d6f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0005d700: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-0005d710: 2020 2020 2020 2020 2070 7269 6e74 286d           print(m
-0005d720: 6f64 5f6e 616d 6529 0a20 2020 2020 2020  od_name).       
-0005d730: 2020 2020 2020 2020 2070 7269 6e74 2866           print(f
-0005d740: 6c5f 6e61 6d65 7329 0a20 2020 2020 2020  l_names).       
-0005d750: 2020 2020 2066 6c5f 6964 203d 2066 6c5f       fl_id = fl_
-0005d760: 6e61 6d65 735b 305d 0a20 2020 2020 2020  names[0].       
-0005d770: 2020 2020 206e 5f6e 616d 6573 203d 206c       n_names = l
-0005d780: 656e 2866 6c5f 6e61 6d65 7329 0a20 2020  en(fl_names).   
-0005d790: 2020 2020 2020 2020 206c 6f63 7665 6320           locvec 
-0005d7a0: 3d20 6a6d 6d5b 666c 5f6e 616d 6573 5b6e  = jmm[fl_names[n
-0005d7b0: 5f6e 616d 6573 2d31 5d5d 2e61 7374 7970  _names-1]].astyp
-0005d7c0: 6528 666c 6f61 7429 0a20 2020 2020 2020  e(float).       
-0005d7d0: 2020 2020 2062 6f6f 6c76 6563 3d7e 7064       boolvec=~pd
-0005d7e0: 2e69 736e 6128 6c6f 6376 6563 290a 2020  .isna(locvec).  
-0005d7f0: 2020 2020 2020 2020 2020 6a6d 6d73 7562            jmmsub
-0005d800: 203d 206a 6d6d 5b62 6f6f 6c76 6563 5d5b   = jmm[boolvec][
-0005d810: 205b 2775 5f68 6965 725f 6964 275d 2b66   ['u_hier_id']+f
-0005d820: 6c5f 6e61 6d65 735d 0a20 2020 2020 2020  l_names].       
-0005d830: 2020 2020 206d 795f 7462 6c20 3d20 436f       my_tbl = Co
-0005d840: 756e 7465 7228 6a6d 6d73 7562 5b27 755f  unter(jmmsub['u_
-0005d850: 6869 6572 5f69 6427 5d29 0a20 2020 2020  hier_id']).     
-0005d860: 2020 2020 2020 2067 746f 6176 6720 3d20         gtoavg = 
-0005d870: 5b6e 616d 6520 666f 7220 6e61 6d65 2069  [name for name i
-0005d880: 6e20 6d79 5f74 626c 2e6b 6579 7328 2920  n my_tbl.keys() 
-0005d890: 6966 206d 795f 7462 6c5b 6e61 6d65 5d20  if my_tbl[name] 
-0005d8a0: 3d3d 2031 5d0a 2020 2020 2020 2020 2020  == 1].          
-0005d8b0: 2020 6774 6f61 7667 4731 203d 205b 6e61    gtoavgG1 = [na
-0005d8c0: 6d65 2066 6f72 206e 616d 6520 696e 206d  me for name in m
-0005d8d0: 795f 7462 6c2e 6b65 7973 2829 2069 6620  y_tbl.keys() if 
-0005d8e0: 6d79 5f74 626c 5b6e 616d 655d 203e 2031  my_tbl[name] > 1
-0005d8f0: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
-0005d900: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-0005d910: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0005d920: 224a 6f69 6e20 3122 290a 2020 2020 2020  "Join 1").      
-0005d930: 2020 2020 2020 6a6d 6d73 7562 3120 3d20        jmmsub1 = 
-0005d940: 6a6d 6d73 7562 2e6c 6f63 5b6a 6d6d 7375  jmmsub.loc[jmmsu
-0005d950: 625b 2775 5f68 6965 725f 6964 275d 2e69  b['u_hier_id'].i
-0005d960: 7369 6e28 6774 6f61 7667 295d 5b5b 2775  sin(gtoavg)][['u
-0005d970: 5f68 6965 725f 6964 275d 2b66 6c5f 6e61  _hier_id']+fl_na
-0005d980: 6d65 735d 0a20 2020 2020 2020 2020 2020  mes].           
-0005d990: 2066 6f72 2075 2069 6e20 6774 6f61 7667   for u in gtoavg
-0005d9a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0005d9b0: 2020 6a6d 6d55 6e69 712e 6c6f 635b 755d    jmmUniq.loc[u]
-0005d9c0: 5b66 6c5f 6e61 6d65 735b 313a 5d5d 203d  [fl_names[1:]] =
-0005d9d0: 206a 6d6d 7375 6231 2e6c 6f63 5b75 5d5b   jmmsub1.loc[u][
-0005d9e0: 666c 5f6e 616d 6573 5b31 3a5d 5d0a 2020  fl_names[1:]].  
-0005d9f0: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
-0005da00: 626f 7365 2061 6e64 206c 656e 2867 746f  bose and len(gto
-0005da10: 6176 6747 3129 203e 2031 3a0a 2020 2020  avgG1) > 1:.    
-0005da20: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0005da30: 7428 224a 6f69 6e20 3e31 2229 0a20 2020  t("Join >1").   
-0005da40: 2020 2020 2020 2020 206a 6d6d 7375 6247           jmmsubG
-0005da50: 3120 3d20 6a6d 6d73 7562 2e6c 6f63 5b6a  1 = jmmsub.loc[j
-0005da60: 6d6d 7375 625b 2775 5f68 6965 725f 6964  mmsub['u_hier_id
-0005da70: 275d 2e69 7369 6e28 6774 6f61 7667 4731  '].isin(gtoavgG1
-0005da80: 295d 5b5b 2775 5f68 6965 725f 6964 275d  )][['u_hier_id']
-0005da90: 2b66 6c5f 6e61 6d65 735d 0a20 2020 2020  +fl_names].     
-0005daa0: 2020 2020 2020 2066 6f72 2075 2069 6e20         for u in 
-0005dab0: 6774 6f61 7667 4731 3a0a 2020 2020 2020  gtoavgG1:.      
-0005dac0: 2020 2020 2020 2020 2020 7465 6d70 203d            temp =
-0005dad0: 206a 6d6d 7375 6247 312e 6c6f 635b 755d   jmmsubG1.loc[u]
-0005dae0: 5b20 5b27 755f 6869 6572 5f69 6427 5d2b  [ ['u_hier_id']+
-0005daf0: 666c 5f6e 616d 6573 205d 0a20 2020 2020  fl_names ].     
-0005db00: 2020 2020 2020 2020 2020 2064 726f 706e             dropn
-0005db10: 616d 6573 203d 2067 6574 5f6e 616d 6573  ames = get_names
-0005db20: 5f66 726f 6d5f 6461 7461 5f66 7261 6d65  _from_data_frame
-0005db30: 2820 5b27 4d4d 2e49 4427 5d2c 2074 656d  ( ['MM.ID'], tem
-0005db40: 7020 290a 2020 2020 2020 2020 2020 2020  p ).            
-0005db50: 2020 2020 7465 6d70 5665 6320 3d20 7465      tempVec = te
-0005db60: 6d70 2e64 726f 7028 636f 6c75 6d6e 733d  mp.drop(columns=
-0005db70: 6472 6f70 6e61 6d65 7329 0a20 2020 2020  dropnames).     
-0005db80: 2020 2020 2020 2020 2020 206a 6f69 6e44             joinD
-0005db90: 6961 676e 6f73 7469 6373 4c6f 6320 3d20  iagnosticsLoc = 
-0005dba0: 7064 2e44 6174 6146 7261 6d65 2820 636f  pd.DataFrame( co
-0005dbb0: 6c75 6d6e 7320 3d20 6478 636f 6c73 2c20  lumns = dxcols, 
-0005dbc0: 696e 6465 783d 7261 6e67 6528 3129 2029  index=range(1) )
-0005dbd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005dbe0: 2069 6431 3d74 656d 705b 666c 5f69 645d   id1=temp[fl_id]
-0005dbf0: 2e69 6c6f 635b 305d 0a20 2020 2020 2020  .iloc[0].       
-0005dc00: 2020 2020 2020 2020 2069 6432 3d74 656d           id2=tem
-0005dc10: 705b 666c 5f69 645d 2e69 6c6f 635b 315d  p[fl_id].iloc[1]
-0005dc20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005dc30: 2076 313d 7465 6d70 5665 632e 696c 6f63   v1=tempVec.iloc
-0005dc40: 5b30 5d5b 313a 5d2e 6173 7479 7065 2866  [0][1:].astype(f
-0005dc50: 6c6f 6174 292e 746f 5f6e 756d 7079 2829  loat).to_numpy()
-0005dc60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005dc70: 2076 323d 7465 6d70 5665 632e 696c 6f63   v2=tempVec.iloc
-0005dc80: 5b31 5d5b 313a 5d2e 6173 7479 7065 2866  [1][1:].astype(f
-0005dc90: 6c6f 6174 292e 746f 5f6e 756d 7079 2829  loat).to_numpy()
-0005dca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005dcb0: 2069 6620 6c65 6e28 7632 2920 3e20 6469   if len(v2) > di
-0005dcc0: 6167 6e6f 7374 6963 5f6e 3a0a 2020 2020  agnostic_n:.    
-0005dcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005dce0: 7631 3d76 315b 303a 6469 6167 6e6f 7374  v1=v1[0:diagnost
-0005dcf0: 6963 5f6e 5d0a 2020 2020 2020 2020 2020  ic_n].          
-0005dd00: 2020 2020 2020 2020 2020 7632 3d76 325b            v2=v2[
-0005dd10: 303a 6469 6167 6e6f 7374 6963 5f6e 5d0a  0:diagnostic_n].
-0005dd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005dd30: 6d79 636f 7272 203d 206e 702e 636f 7272  mycorr = np.corr
-0005dd40: 636f 6566 2820 7631 2c20 7632 2029 5b30  coef( v1, v2 )[0
-0005dd50: 2c31 5d0a 2020 2020 2020 2020 2020 2020  ,1].            
-0005dd60: 2020 2020 2320 6d79 636f 7272 3d74 656d      # mycorr=tem
-0005dd70: 7061 7272 5b6e 702e 7472 6975 5f69 6e64  parr[np.triu_ind
-0005dd80: 6963 6573 5f66 726f 6d28 7465 6d70 6172  ices_from(tempar
-0005dd90: 722c 206b 3d31 295d 2e6d 6561 6e28 290a  r, k=1)].mean().
-0005dda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ddb0: 6d79 6572 723d 6e70 2e73 7172 7428 6e70  myerr=np.sqrt(np
-0005ddc0: 2e6d 6561 6e28 2876 3120 2d20 7632 292a  .mean((v1 - v2)*
-0005ddd0: 2a32 2929 0a20 2020 2020 2020 2020 2020  *2)).           
-0005dde0: 2020 2020 206a 6f69 6e44 6961 676e 6f73       joinDiagnos
-0005ddf0: 7469 6373 4c6f 632e 696c 6f63 5b30 5d20  ticsLoc.iloc[0] 
-0005de00: 3d20 5b69 6431 2c69 6432 2c6d 6f64 5f6e  = [id1,id2,mod_n
-0005de10: 616d 652c 2772 6f77 6176 6727 2c6d 7963  ame,'rowavg',myc
-0005de20: 6f72 722c 6d79 6572 725d 0a20 2020 2020  orr,myerr].     
-0005de30: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
-0005de40: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
-0005de50: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0005de60: 2820 6a6f 696e 4469 6167 6e6f 7374 6963  ( joinDiagnostic
-0005de70: 734c 6f63 2029 0a20 2020 2020 2020 2020  sLoc ).         
-0005de80: 2020 2020 2020 2074 656d 7020 3d20 6a6d         temp = jm
-0005de90: 6d73 7562 4731 2e6c 6f63 5b75 5d5b 666c  msubG1.loc[u][fl
-0005dea0: 5f6e 616d 6573 5b31 3a5d 5d2e 6173 7479  _names[1:]].asty
-0005deb0: 7065 2866 6c6f 6174 290a 2020 2020 2020  pe(float).      
-0005dec0: 2020 2020 2020 2020 2020 6966 206d 7963            if myc
-0005ded0: 6f72 7220 3e20 636f 7272 5f74 6872 6573  orr > corr_thres
-0005dee0: 6820 6f72 206c 656e 2820 7631 2029 203c  h or len( v1 ) <
-0005def0: 2031 303a 0a20 2020 2020 2020 2020 2020   10:.           
-0005df00: 2020 2020 2020 2020 206a 6d6d 556e 6971           jmmUniq
-0005df10: 2e6c 6f63 5b75 5d5b 666c 5f6e 616d 6573  .loc[u][fl_names
-0005df20: 5b31 3a5d 5d20 3d20 7465 6d70 2e6d 6561  [1:]] = temp.mea
-0005df30: 6e28 6178 6973 3d30 290a 2020 2020 2020  n(axis=0).      
-0005df40: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0005df50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005df60: 2020 2020 6a6d 6d55 6e69 712e 6c6f 635b      jmmUniq.loc[
-0005df70: 755d 5b66 6c5f 6e61 6d65 735b 313a 5d5d  u][fl_names[1:]]
-0005df80: 203d 206e 616e 4c69 7374 202a 2074 656d   = nanList * tem
-0005df90: 702e 7368 6170 655b 315d 0a20 2020 2020  p.shape[1].     
-0005dfa0: 2020 2020 2020 2020 2020 206a 6f69 6e44             joinD
-0005dfb0: 6961 676e 6f73 7469 6373 203d 2070 642e  iagnostics = pd.
-0005dfc0: 636f 6e63 6174 2820 5b6a 6f69 6e44 6961  concat( [joinDia
-0005dfd0: 676e 6f73 7469 6373 2c20 6a6f 696e 4469  gnostics, joinDi
-0005dfe0: 6167 6e6f 7374 6963 734c 6f63 5d2c 200a  agnosticsLoc], .
-0005dff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e010: 2020 2020 2020 2020 2020 2020 6178 6973              axis
-0005e020: 3d30 2c20 6967 6e6f 7265 5f69 6e64 6578  =0, ignore_index
-0005e030: 3d46 616c 7365 2029 0a0a 2020 2020 7265  =False )..    re
-0005e040: 7475 726e 206a 6d6d 556e 6971 2c20 6a6d  turn jmmUniq, jm
-0005e050: 6d2c 206a 6f69 6e44 6961 676e 6f73 7469  m, joinDiagnosti
-0005e060: 6373 0a0a 0a0a 6465 6620 7175 6963 6b5f  cs....def quick_
-0005e070: 7669 7a5f 6d6d 5f6e 7267 280a 2020 2020  viz_mm_nrg(.    
-0005e080: 736f 7572 6365 6469 722c 2023 2072 6f6f  sourcedir, # roo
-0005e090: 7420 666f 6c64 6572 0a20 2020 2070 726f  t folder.    pro
-0005e0a0: 6a65 6374 6964 2c20 2320 7072 6f6a 6563  jectid, # projec
-0005e0b0: 7420 6e61 6d65 0a20 2020 2073 6964 202c  t name.    sid ,
-0005e0c0: 2023 2073 7562 6a65 6374 2075 6e69 7175   # subject uniqu
-0005e0d0: 6520 6964 0a20 2020 2064 7469 642c 2023  e id.    dtid, #
-0005e0e0: 2064 6174 650a 2020 2020 6578 7472 6163   date.    extrac
-0005e0f0: 745f 6272 6169 6e3d 5472 7565 2c0a 2020  t_brain=True,.  
-0005e100: 2020 736c 6963 655f 6661 6374 6f72 203d    slice_factor =
-0005e110: 2030 2e35 352c 0a20 2020 2073 686f 775f   0.55,.    show_
-0005e120: 6974 203d 204e 6f6e 652c 2023 206f 7574  it = None, # out
-0005e130: 7075 7420 7061 7468 0a20 2020 2076 6572  put path.    ver
-0005e140: 626f 7365 203d 2054 7275 650a 293a 0a20  bose = True.):. 
-0005e150: 2020 2022 2222 0a20 2020 2054 6869 7320     """.    This 
-0005e160: 6675 6e63 7469 6f6e 2063 7265 6174 6573  function creates
-0005e170: 2076 6973 7561 6c69 7a61 7469 6f6e 7320   visualizations 
-0005e180: 6f66 2062 7261 696e 2069 6d61 6765 7320  of brain images 
-0005e190: 666f 7220 6120 7370 6563 6966 6963 2073  for a specific s
-0005e1a0: 7562 6a65 6374 2069 6e20 6120 7072 6f6a  ubject in a proj
-0005e1b0: 6563 7420 7573 696e 6720 414e 5473 5079  ect using ANTsPy
-0005e1c0: 2e0a 0a20 2020 2041 7267 733a 0a0a 2020  ...    Args:..  
-0005e1d0: 2020 736f 7572 6365 6469 7220 2873 7472    sourcedir (str
-0005e1e0: 293a 2052 6f6f 7420 666f 6c64 6572 2e0a  ): Root folder..
-0005e1f0: 2020 2020 0a20 2020 2070 726f 6a65 6374      .    project
-0005e200: 6964 2028 7374 7229 3a20 5072 6f6a 6563  id (str): Projec
-0005e210: 7420 6e61 6d65 2e0a 2020 2020 0a20 2020  t name..    .   
-0005e220: 2073 6964 2028 7374 7229 3a20 5375 626a   sid (str): Subj
-0005e230: 6563 7420 756e 6971 7565 2069 642e 0a20  ect unique id.. 
-0005e240: 2020 200a 2020 2020 6474 6964 2028 7374     .    dtid (st
-0005e250: 7229 3a20 4461 7465 2e0a 2020 2020 0a20  r): Date..    . 
-0005e260: 2020 2065 7874 7261 6374 5f62 7261 696e     extract_brain
-0005e270: 2028 626f 6f6c 293a 2049 6620 5472 7565   (bool): If True
-0005e280: 2c20 7468 6520 6675 6e63 7469 6f6e 2065  , the function e
-0005e290: 7874 7261 6374 7320 7468 6520 6272 6169  xtracts the brai
-0005e2a0: 6e20 6672 6f6d 2074 6865 2054 3177 2069  n from the T1w i
-0005e2b0: 6d61 6765 2e20 4465 6661 756c 7420 6973  mage. Default is
-0005e2c0: 2054 7275 652e 0a20 2020 200a 2020 2020   True..    .    
-0005e2d0: 736c 6963 655f 6661 6374 6f72 2028 666c  slice_factor (fl
-0005e2e0: 6f61 7429 3a20 5468 6520 736c 6963 6520  oat): The slice 
-0005e2f0: 746f 2062 6520 7669 7375 616c 697a 6564  to be visualized
-0005e300: 2069 7320 6465 7465 726d 696e 6564 2062   is determined b
-0005e310: 7920 6d75 6c74 6970 6c79 696e 6720 7468  y multiplying th
-0005e320: 6520 696d 6167 6520 7369 7a65 2062 7920  e image size by 
-0005e330: 7468 6973 2066 6163 746f 722e 2044 6566  this factor. Def
-0005e340: 6175 6c74 2069 7320 302e 3535 2e0a 2020  ault is 0.55..  
-0005e350: 2020 0a20 2020 2073 686f 775f 6974 2028    .    show_it (
-0005e360: 7374 7229 3a20 4f75 7470 7574 2070 6174  str): Output pat
-0005e370: 682e 2049 6620 6e6f 7420 4e6f 6e65 2c20  h. If not None, 
-0005e380: 7468 6520 7669 7375 616c 697a 6174 696f  the visualizatio
-0005e390: 6e73 2077 696c 6c20 6265 2073 6176 6564  ns will be saved
-0005e3a0: 2061 7420 7468 6973 206c 6f63 6174 696f   at this locatio
-0005e3b0: 6e2e 2044 6566 6175 6c74 2069 7320 4e6f  n. Default is No
-0005e3c0: 6e65 2e0a 2020 2020 0a20 2020 2076 6572  ne..    .    ver
-0005e3d0: 626f 7365 2028 626f 6f6c 293a 2049 6620  bose (bool): If 
-0005e3e0: 5472 7565 2c20 696e 666f 726d 6174 696f  True, informatio
-0005e3f0: 6e20 7769 6c6c 2062 6520 7072 696e 7465  n will be printe
-0005e400: 6420 7768 696c 6520 7275 6e6e 696e 6720  d while running 
-0005e410: 7468 6520 6675 6e63 7469 6f6e 2e20 4465  the function. De
-0005e420: 6661 756c 7420 6973 2054 7275 652e 0a0a  fault is True...
-0005e430: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0005e440: 2076 697a 6c69 7374 2028 6c69 7374 293a   vizlist (list):
-0005e450: 204c 6973 7420 6f66 2069 6d61 6765 2076   List of image v
-0005e460: 6973 7561 6c69 7a61 7469 6f6e 732e 0a0a  isualizations...
-0005e470: 2020 2020 2222 220a 2020 2020 6969 643d      """.    iid=
-0005e480: 272a 270a 2020 2020 696d 706f 7274 2067  '*'.    import g
-0005e490: 6c6f 6220 6173 2067 6c6f 620a 2020 2020  lob as glob.    
-0005e4a0: 6672 6f6d 206f 732e 7061 7468 2069 6d70  from os.path imp
-0005e4b0: 6f72 7420 6578 6973 7473 0a20 2020 2069  ort exists.    i
-0005e4c0: 6d70 6f72 7420 616e 7473 0a20 2020 2065  mport ants.    e
-0005e4d0: 785f 7061 7468 203d 206f 732e 7061 7468  x_path = os.path
-0005e4e0: 2e65 7870 616e 6475 7365 7228 2022 7e2f  .expanduser( "~/
-0005e4f0: 2e61 6e74 7370 7974 3177 2f22 2029 0a20  .antspyt1w/" ). 
-0005e500: 2020 2065 785f 7061 7468 6d6d 203d 206f     ex_pathmm = o
-0005e510: 732e 7061 7468 2e65 7870 616e 6475 7365  s.path.expanduse
-0005e520: 7228 2022 7e2f 2e61 6e74 7370 796d 6d2f  r( "~/.antspymm/
-0005e530: 2220 290a 2020 2020 7465 6d70 6c61 7465  " ).    template
-0005e540: 666e 203d 2065 785f 7061 7468 202b 2027  fn = ex_path + '
-0005e550: 4349 5431 3638 5f54 3177 5f37 3030 756d  CIT168_T1w_700um
-0005e560: 5f70 6164 5f61 646e 692e 6e69 692e 677a  _pad_adni.nii.gz
-0005e570: 270a 2020 2020 6966 206e 6f74 2065 7869  '.    if not exi
-0005e580: 7374 7328 2074 656d 706c 6174 6566 6e20  sts( templatefn 
-0005e590: 293a 0a20 2020 2020 2020 2070 7269 6e74  ):.        print
-0005e5a0: 2820 222a 2a6d 6973 7369 6e67 2066 696c  ( "**missing fil
-0005e5b0: 6573 2a2a 203d 3e20 6361 6c6c 2067 6574  es** => call get
-0005e5c0: 5f64 6174 6120 6672 6f6d 206c 6174 6573  _data from lates
-0005e5d0: 7420 616e 7473 7079 7431 7720 616e 6420  t antspyt1w and 
-0005e5e0: 616e 7473 7079 6d6d 2e22 2029 0a20 2020  antspymm." ).   
-0005e5f0: 2020 2020 2061 6e74 7370 7974 3177 2e67       antspyt1w.g
-0005e600: 6574 5f64 6174 6128 2066 6f72 6365 5f64  et_data( force_d
-0005e610: 6f77 6e6c 6f61 643d 5472 7565 2029 0a20  ownload=True ). 
-0005e620: 2020 2020 2020 2067 6574 5f64 6174 6128         get_data(
-0005e630: 2066 6f72 6365 5f64 6f77 6e6c 6f61 643d   force_download=
-0005e640: 5472 7565 2029 0a20 2020 2074 656d 7020  True ).    temp 
-0005e650: 3d20 736f 7572 6365 6469 722e 7370 6c69  = sourcedir.spli
-0005e660: 7428 2022 2f22 2029 0a20 2020 2073 706c  t( "/" ).    spl
-0005e670: 6974 436f 756e 7420 3d20 6c65 6e28 2074  itCount = len( t
-0005e680: 656d 7020 290a 2020 2020 7465 6d70 6c61  emp ).    templa
-0005e690: 7465 203d 206d 6d5f 7265 6164 2820 7465  te = mm_read( te
-0005e6a0: 6d70 6c61 7465 666e 2029 2023 2052 6561  mplatefn ) # Rea
-0005e6b0: 6420 696e 2074 656d 706c 6174 650a 2020  d in template.  
-0005e6c0: 2020 7375 626a 6563 7472 6f6f 7470 6174    subjectrootpat
-0005e6d0: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
-0005e6e0: 2873 6f75 7263 6564 6972 2c20 7072 6f6a  (sourcedir, proj
-0005e6f0: 6563 7469 642c 2073 6964 2c20 6474 6964  ectid, sid, dtid
-0005e700: 290a 2020 2020 6d79 696d 6773 496e 7075  ).    myimgsInpu
-0005e710: 7420 3d20 676c 6f62 2e67 6c6f 6228 2073  t = glob.glob( s
-0005e720: 7562 6a65 6374 726f 6f74 7061 7468 2b22  ubjectrootpath+"
-0005e730: 2f2a 2220 290a 2020 2020 6d79 696d 6773  /*" ).    myimgs
-0005e740: 496e 7075 742e 736f 7274 2820 290a 2020  Input.sort( ).  
-0005e750: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-0005e760: 2020 2020 2020 7072 696e 7428 206d 7969        print( myi
-0005e770: 6d67 7349 6e70 7574 2029 0a20 2020 2074  mgsInput ).    t
-0005e780: 315f 7365 6172 6368 5f70 6174 6820 3d20  1_search_path = 
-0005e790: 6f73 2e70 6174 682e 6a6f 696e 2873 7562  os.path.join(sub
-0005e7a0: 6a65 6374 726f 6f74 7061 7468 2c20 2254  jectrootpath, "T
-0005e7b0: 3177 222c 2022 2a22 2c20 222a 6e69 692e  1w", "*", "*nii.
-0005e7c0: 677a 2229 0a20 2020 2069 6620 7665 7262  gz").    if verb
-0005e7d0: 6f73 653a 0a20 2020 2020 2020 2070 7269  ose:.        pri
-0005e7e0: 6e74 2866 2274 3120 7365 6172 6368 2070  nt(f"t1 search p
-0005e7f0: 6174 683a 207b 7431 5f73 6561 7263 685f  ath: {t1_search_
-0005e800: 7061 7468 7d22 290a 2020 2020 7431 666e  path}").    t1fn
-0005e810: 203d 2067 6c6f 622e 676c 6f62 2874 315f   = glob.glob(t1_
-0005e820: 7365 6172 6368 5f70 6174 6829 0a20 2020  search_path).   
-0005e830: 2074 3166 6e2e 736f 7274 2829 0a20 2020   t1fn.sort().   
-0005e840: 2069 6620 6c65 6e28 2074 3166 6e20 2920   if len( t1fn ) 
-0005e850: 3c20 313a 0a20 2020 2020 2020 2072 6169  < 1:.        rai
-0005e860: 7365 2056 616c 7565 4572 726f 7228 2771  se ValueError('q
-0005e870: 7569 636b 5f76 697a 5f6d 6d5f 6e72 6720  uick_viz_mm_nrg 
-0005e880: 6361 6e6e 6f74 2066 696e 6420 7468 6520  cannot find the 
-0005e890: 5431 7720 4020 2720 2b20 7375 626a 6563  T1w @ ' + subjec
-0005e8a0: 7472 6f6f 7470 6174 6820 290a 2020 2020  trootpath ).    
-0005e8b0: 7431 666e 203d 2074 3166 6e5b 305d 0a20  t1fn = t1fn[0]. 
-0005e8c0: 2020 2074 3120 3d20 6d6d 5f72 6561 6428     t1 = mm_read(
-0005e8d0: 2074 3166 6e20 290a 2020 2020 6e69 6d61   t1fn ).    nima
-0005e8e0: 6765 7320 3d20 6c65 6e28 6d79 696d 6773  ges = len(myimgs
-0005e8f0: 496e 7075 7429 0a20 2020 2076 697a 6c69  Input).    vizli
-0005e900: 7374 3d5b 5d0a 2020 2020 6966 2076 6572  st=[].    if ver
-0005e910: 626f 7365 3a0a 2020 2020 2020 2020 7072  bose:.        pr
-0005e920: 696e 7428 2020 2220 7765 2068 6176 6520  int(  " we have 
-0005e930: 3a20 2220 2b20 7374 7228 6e69 6d61 6765  : " + str(nimage
-0005e940: 7329 202b 2022 206d 6f64 616c 6974 6965  s) + " modalitie
-0005e950: 732e 2020 7769 6c6c 2076 6973 7561 6c69  s.  will visuali
-0005e960: 7a65 2054 3120 4e4d 2072 7366 4d52 4920  ze T1 NM rsfMRI 
-0005e970: 4454 4942 3020 4454 4944 5749 2046 4c41  DTIB0 DTIDWI FLA
-0005e980: 4952 2229 0a20 2020 2023 206e 7267 5f6d  IR").    # nrg_m
-0005e990: 6f64 616c 6974 795f 6c69 7374 203d 205b  odality_list = [
-0005e9a0: 2254 3177 222c 2022 4e4d 3244 4d54 222c  "T1w", "NM2DMT",
-0005e9b0: 2022 7273 664d 5249 222c 2272 7366 4d52   "rsfMRI","rsfMR
-0005e9c0: 495f 4c52 222c 2272 7366 4d52 495f 524c  I_LR","rsfMRI_RL
-0005e9d0: 222c 2244 5449 222c 2244 5449 5f4c 5222  ","DTI","DTI_LR"
-0005e9e0: 2c20 2254 3246 6c61 6972 2220 5d2c 0a20  , "T2Flair" ],. 
-0005e9f0: 2020 206e 7267 5f6d 6f64 616c 6974 795f     nrg_modality_
-0005ea00: 6c69 7374 203d 205b 2027 5431 7727 2c20  list = [ 'T1w', 
-0005ea10: 274e 4d32 444d 5427 2c20 2772 7366 4d52  'NM2DMT', 'rsfMR
-0005ea20: 4927 2c20 2744 5749 3127 2c20 2744 5749  I', 'DWI1', 'DWI
-0005ea30: 3227 2c20 2754 3246 6c61 6972 2720 5d0a  2', 'T2Flair' ].
-0005ea40: 2020 2020 666f 7220 6e72 674e 756d 2069      for nrgNum i
-0005ea50: 6e20 5b30 2c31 2c32 2c33 2c34 2c35 5d3a  n [0,1,2,3,4,5]:
-0005ea60: 0a20 2020 2020 2020 206f 7665 726d 6f64  .        overmod
-0005ea70: 5820 3d20 6e72 675f 6d6f 6461 6c69 7479  X = nrg_modality
-0005ea80: 5f6c 6973 745b 6e72 674e 756d 5d0a 2020  _list[nrgNum].  
-0005ea90: 2020 2020 2020 6966 206f 7665 726d 6f64        if overmod
-0005eaa0: 5820 3d3d 2027 5431 7727 3a0a 2020 2020  X == 'T1w':.    
-0005eab0: 2020 2020 2020 2020 6d6f 645f 7365 6172          mod_sear
-0005eac0: 6368 5f70 6174 6820 3d20 6f73 2e70 6174  ch_path = os.pat
-0005ead0: 682e 6a6f 696e 2873 7562 6a65 6374 726f  h.join(subjectro
-0005eae0: 6f74 7061 7468 2c20 6f76 6572 6d6f 6458  otpath, overmodX
-0005eaf0: 2c20 6969 642c 2022 2a6e 6969 2e67 7a22  , iid, "*nii.gz"
-0005eb00: 290a 2020 2020 2020 2020 2020 2020 6d79  ).            my
-0005eb10: 696d 6773 7220 3d20 676c 6f62 2e67 6c6f  imgsr = glob.glo
-0005eb20: 6228 6d6f 645f 7365 6172 6368 5f70 6174  b(mod_search_pat
-0005eb30: 6829 0a20 2020 2020 2020 2020 2020 2069  h).            i
-0005eb40: 6620 6c65 6e28 206d 7969 6d67 7372 2029  f len( myimgsr )
-0005eb50: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-0005eb60: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
-0005eb70: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0005eb80: 2020 2020 2020 2070 7269 6e74 2822 4e6f         print("No
-0005eb90: 2074 3120 696d 6167 6573 3a20 2220 2b20   t1 images: " + 
-0005eba0: 7369 6420 2b20 6474 6964 2029 0a20 2020  sid + dtid ).   
-0005ebb0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0005ebc0: 7572 6e20 4e6f 6e65 0a20 2020 2020 2020  urn None.       
-0005ebd0: 2020 2020 206d 7969 6d67 7372 2e73 6f72       myimgsr.sor
-0005ebe0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-0005ebf0: 6d79 696d 6773 723d 6d79 696d 6773 725b  myimgsr=myimgsr[
-0005ec00: 305d 0a20 2020 2020 2020 2020 2020 2076  0].            v
-0005ec10: 696d 673d 616e 7473 2e69 6d61 6765 5f72  img=ants.image_r
-0005ec20: 6561 6428 206d 7969 6d67 7372 2029 0a20  ead( myimgsr ). 
-0005ec30: 2020 2020 2020 2065 6c69 6620 6f76 6572         elif over
-0005ec40: 6d6f 6458 203d 3d20 2744 5749 3127 3a0a  modX == 'DWI1':.
-0005ec50: 2020 2020 2020 2020 2020 2020 6d6f 645f              mod_
-0005ec60: 7365 6172 6368 5f70 6174 6820 3d20 6f73  search_path = os
-0005ec70: 2e70 6174 682e 6a6f 696e 2873 7562 6a65  .path.join(subje
-0005ec80: 6374 726f 6f74 7061 7468 2c20 2744 5449  ctrootpath, 'DTI
-0005ec90: 2a27 2c20 222a 222c 2022 2a6e 6969 2e67  *', "*", "*nii.g
-0005eca0: 7a22 290a 2020 2020 2020 2020 2020 2020  z").            
-0005ecb0: 6d79 696d 6773 7220 3d20 676c 6f62 2e67  myimgsr = glob.g
-0005ecc0: 6c6f 6228 6d6f 645f 7365 6172 6368 5f70  lob(mod_search_p
-0005ecd0: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-0005ece0: 2069 6620 6c65 6e28 206d 7969 6d67 7372   if len( myimgsr
-0005ecf0: 2029 203e 2030 3a0a 2020 2020 2020 2020   ) > 0:.        
-0005ed00: 2020 2020 2020 2020 6d79 696d 6773 722e          myimgsr.
-0005ed10: 736f 7274 2829 0a20 2020 2020 2020 2020  sort().         
-0005ed20: 2020 2020 2020 206d 7969 6d67 7372 3d6d         myimgsr=m
-0005ed30: 7969 6d67 7372 5b30 5d0a 2020 2020 2020  yimgsr[0].      
-0005ed40: 2020 2020 2020 2020 2020 7669 6d67 3d61            vimg=a
-0005ed50: 6e74 732e 696d 6167 655f 7265 6164 2820  nts.image_read( 
-0005ed60: 6d79 696d 6773 7220 290a 2020 2020 2020  myimgsr ).      
-0005ed70: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0005ed80: 2020 2020 2020 2020 2020 2020 6966 2076              if v
-0005ed90: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-0005eda0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0005edb0: 7428 224e 6f20 2220 2b20 6f76 6572 6d6f  t("No " + overmo
-0005edc0: 6458 290a 2020 2020 2020 2020 2020 2020  dX).            
-0005edd0: 2020 2020 7669 6d67 203d 206e 6f69 7a69      vimg = noizi
-0005ede0: 6d67 0a20 2020 2020 2020 2065 6c69 6620  mg.        elif 
-0005edf0: 6f76 6572 6d6f 6458 203d 3d20 2744 5749  overmodX == 'DWI
-0005ee00: 3227 3a0a 2020 2020 2020 2020 2020 2020  2':.            
-0005ee10: 6d6f 645f 7365 6172 6368 5f70 6174 6820  mod_search_path 
-0005ee20: 3d20 6f73 2e70 6174 682e 6a6f 696e 2873  = os.path.join(s
-0005ee30: 7562 6a65 6374 726f 6f74 7061 7468 2c20  ubjectrootpath, 
-0005ee40: 2744 5449 2a27 2c20 222a 222c 2022 2a6e  'DTI*', "*", "*n
-0005ee50: 6969 2e67 7a22 290a 2020 2020 2020 2020  ii.gz").        
-0005ee60: 2020 2020 6d79 696d 6773 7220 3d20 676c      myimgsr = gl
-0005ee70: 6f62 2e67 6c6f 6228 6d6f 645f 7365 6172  ob.glob(mod_sear
-0005ee80: 6368 5f70 6174 6829 0a20 2020 2020 2020  ch_path).       
-0005ee90: 2020 2020 2069 6620 6c65 6e28 206d 7969       if len( myi
-0005eea0: 6d67 7372 2029 203e 2030 3a0a 2020 2020  mgsr ) > 0:.    
-0005eeb0: 2020 2020 2020 2020 2020 2020 6d79 696d              myim
-0005eec0: 6773 722e 736f 7274 2829 0a20 2020 2020  gsr.sort().     
-0005eed0: 2020 2020 2020 2020 2020 206d 7969 6d67             myimg
-0005eee0: 7372 3d6d 7969 6d67 7372 5b6c 656e 286d  sr=myimgsr[len(m
-0005eef0: 7969 6d67 7372 292d 315d 0a20 2020 2020  yimgsr)-1].     
-0005ef00: 2020 2020 2020 2020 2020 2076 696d 673d             vimg=
-0005ef10: 616e 7473 2e69 6d61 6765 5f72 6561 6428  ants.image_read(
-0005ef20: 206d 7969 6d67 7372 2029 0a20 2020 2020   myimgsr ).     
-0005ef30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0005ef40: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0005ef50: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-0005ef60: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0005ef70: 6e74 2822 4e6f 2022 202b 206f 7665 726d  nt("No " + overm
-0005ef80: 6f64 5829 0a20 2020 2020 2020 2020 2020  odX).           
-0005ef90: 2020 2020 2076 696d 6720 3d20 6e6f 697a       vimg = noiz
-0005efa0: 696d 670a 2020 2020 2020 2020 656c 6966  img.        elif
-0005efb0: 206f 7665 726d 6f64 5820 3d3d 2027 4e4d   overmodX == 'NM
-0005efc0: 3244 4d54 273a 0a20 2020 2020 2020 2020  2DMT':.         
-0005efd0: 2020 206d 6f64 5f73 6561 7263 685f 7061     mod_search_pa
-0005efe0: 7468 203d 206f 732e 7061 7468 2e6a 6f69  th = os.path.joi
-0005eff0: 6e28 7375 626a 6563 7472 6f6f 7470 6174  n(subjectrootpat
-0005f000: 682c 206f 7665 726d 6f64 582c 2022 2a22  h, overmodX, "*"
-0005f010: 2c20 222a 6e69 692e 677a 2229 0a20 2020  , "*nii.gz").   
-0005f020: 2020 2020 2020 2020 206d 7969 6d67 7372           myimgsr
-0005f030: 203d 2067 6c6f 622e 676c 6f62 286d 6f64   = glob.glob(mod
-0005f040: 5f73 6561 7263 685f 7061 7468 290a 2020  _search_path).  
-0005f050: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-0005f060: 2820 6d79 696d 6773 7220 2920 3e20 303a  ( myimgsr ) > 0:
-0005f070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005f080: 206d 7969 6d67 7372 2e73 6f72 7428 290a   myimgsr.sort().
-0005f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f0a0: 6d79 696d 6773 7230 3d6d 7969 6d67 7372  myimgsr0=myimgsr
-0005f0b0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-0005f0c0: 2020 2020 7669 6d67 3d61 6e74 732e 696d      vimg=ants.im
-0005f0d0: 6167 655f 7265 6164 2820 6d79 696d 6773  age_read( myimgs
-0005f0e0: 7230 2029 0a20 2020 2020 2020 2020 2020  r0 ).           
-0005f0f0: 2020 2020 2066 6f72 206b 2069 6e20 7261       for k in ra
-0005f100: 6e67 6528 312c 6c65 6e28 6d79 696d 6773  nge(1,len(myimgs
-0005f110: 7229 293a 0a20 2020 2020 2020 2020 2020  r)):.           
-0005f120: 2020 2020 2020 2020 2074 656d 7020 3d20           temp = 
-0005f130: 616e 7473 2e69 6d61 6765 5f72 6561 6428  ants.image_read(
-0005f140: 206d 7969 6d67 7372 5b6b 5d29 0a20 2020   myimgsr[k]).   
-0005f150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f160: 2076 696d 673d 7669 6d67 2b61 6e74 732e   vimg=vimg+ants.
-0005f170: 7265 7361 6d70 6c65 5f69 6d61 6765 5f74  resample_image_t
-0005f180: 6f5f 7461 7267 6574 2874 656d 702c 7669  o_target(temp,vi
-0005f190: 6d67 290a 2020 2020 2020 2020 2020 2020  mg).            
-0005f1a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0005f1b0: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-0005f1c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0005f1d0: 2020 2020 2020 7072 696e 7428 224e 6f20        print("No 
-0005f1e0: 2220 2b20 6f76 6572 6d6f 6458 290a 2020  " + overmodX).  
-0005f1f0: 2020 2020 2020 2020 2020 2020 2020 7669                vi
-0005f200: 6d67 203d 206e 6f69 7a69 6d67 0a20 2020  mg = noizimg.   
-0005f210: 2020 2020 2065 6c69 6620 6f76 6572 6d6f       elif overmo
-0005f220: 6458 203d 3d20 2772 7366 4d52 4927 3a0a  dX == 'rsfMRI':.
-0005f230: 2020 2020 2020 2020 2020 2020 6d6f 645f              mod_
-0005f240: 7365 6172 6368 5f70 6174 6820 3d20 6f73  search_path = os
-0005f250: 2e70 6174 682e 6a6f 696e 2873 7562 6a65  .path.join(subje
-0005f260: 6374 726f 6f74 7061 7468 2c20 2772 7366  ctrootpath, 'rsf
-0005f270: 4d52 492a 272c 2022 2a22 2c20 222a 6e69  MRI*', "*", "*ni
-0005f280: 692e 677a 2229 0a20 2020 2020 2020 2020  i.gz").         
-0005f290: 2020 206d 7969 6d67 7372 203d 2067 6c6f     myimgsr = glo
-0005f2a0: 622e 676c 6f62 286d 6f64 5f73 6561 7263  b.glob(mod_searc
-0005f2b0: 685f 7061 7468 290a 2020 2020 2020 2020  h_path).        
-0005f2c0: 2020 2020 6966 206c 656e 2820 6d79 696d      if len( myim
-0005f2d0: 6773 7220 2920 3e20 303a 0a20 2020 2020  gsr ) > 0:.     
-0005f2e0: 2020 2020 2020 2020 2020 206d 7969 6d67             myimg
-0005f2f0: 7372 2e73 6f72 7428 290a 2020 2020 2020  sr.sort().      
-0005f300: 2020 2020 2020 2020 2020 6d79 696d 6773            myimgs
-0005f310: 723d 6d79 696d 6773 725b 305d 0a20 2020  r=myimgsr[0].   
-0005f320: 2020 2020 2020 2020 2020 2020 2076 696d               vim
-0005f330: 673d 6d6d 5f72 6561 645f 746f 5f33 6428  g=mm_read_to_3d(
-0005f340: 206d 7969 6d67 7372 2029 0a20 2020 2020   myimgsr ).     
-0005f350: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0005f360: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0005f370: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-0005f380: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0005f390: 6e74 2822 4e6f 2022 202b 206f 7665 726d  nt("No " + overm
-0005f3a0: 6f64 5829 0a20 2020 2020 2020 2020 2020  odX).           
-0005f3b0: 2020 2020 2076 696d 6720 3d20 6e6f 697a       vimg = noiz
-0005f3c0: 696d 670a 2020 2020 2020 2020 656c 7365  img.        else
-0005f3d0: 203a 0a20 2020 2020 2020 2020 2020 206d   :.            m
-0005f3e0: 6f64 5f73 6561 7263 685f 7061 7468 203d  od_search_path =
-0005f3f0: 206f 732e 7061 7468 2e6a 6f69 6e28 7375   os.path.join(su
-0005f400: 626a 6563 7472 6f6f 7470 6174 682c 206f  bjectrootpath, o
-0005f410: 7665 726d 6f64 582c 2022 2a22 2c20 222a  vermodX, "*", "*
-0005f420: 6e69 692e 677a 2229 0a20 2020 2020 2020  nii.gz").       
-0005f430: 2020 2020 206d 7969 6d67 7372 203d 2067       myimgsr = g
-0005f440: 6c6f 622e 676c 6f62 286d 6f64 5f73 6561  lob.glob(mod_sea
-0005f450: 7263 685f 7061 7468 290a 2020 2020 2020  rch_path).      
-0005f460: 2020 2020 2020 6966 206c 656e 2820 6d79        if len( my
-0005f470: 696d 6773 7220 2920 3e20 303a 0a20 2020  imgsr ) > 0:.   
-0005f480: 2020 2020 2020 2020 2020 2020 206d 7969               myi
-0005f490: 6d67 7372 2e73 6f72 7428 290a 2020 2020  mgsr.sort().    
-0005f4a0: 2020 2020 2020 2020 2020 2020 6d79 696d              myim
-0005f4b0: 6773 723d 6d79 696d 6773 725b 305d 0a20  gsr=myimgsr[0]. 
-0005f4c0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-0005f4d0: 696d 673d 616e 7473 2e69 6d61 6765 5f72  img=ants.image_r
-0005f4e0: 6561 6428 206d 7969 6d67 7372 2029 0a20  ead( myimgsr ). 
-0005f4f0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0005f500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005f510: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
-0005f520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f530: 2070 7269 6e74 2822 4e6f 2022 202b 206f   print("No " + o
-0005f540: 7665 726d 6f64 5829 0a20 2020 2020 2020  vermodX).       
-0005f550: 2020 2020 2020 2020 2076 696d 6720 3d20           vimg = 
-0005f560: 6e6f 697a 696d 670a 2020 2020 2020 2020  noizimg.        
-0005f570: 6966 2054 7275 653a 0a20 2020 2020 2020  if True:.       
-0005f580: 2020 2020 2069 6620 6578 7472 6163 745f       if extract_
-0005f590: 6272 6169 6e20 616e 6420 6f76 6572 6d6f  brain and overmo
-0005f5a0: 6458 203d 3d20 2754 3177 273a 0a20 2020  dX == 'T1w':.   
-0005f5b0: 2020 2020 2020 2020 2020 2020 2076 696d               vim
-0005f5c0: 6720 3d20 7669 6d67 202a 2061 6e74 7370  g = vimg * antsp
-0005f5d0: 7974 3177 2e62 7261 696e 5f65 7874 7261  yt1w.brain_extra
-0005f5e0: 6374 696f 6e28 7669 6d67 290a 2020 2020  ction(vimg).    
-0005f5f0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-0005f600: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0005f610: 2020 2020 7072 696e 7428 6622 6d6f 6461      print(f"moda
-0005f620: 6c69 7479 2073 6561 7263 6820 7061 7468  lity search path
-0005f630: 3a20 7b6d 7969 6d67 7372 7d22 202b 2022  : {myimgsr}" + "
-0005f640: 206e 756d 3a20 2220 2b20 7374 7228 6e72   num: " + str(nr
-0005f650: 674e 756d 2929 0a20 2020 2020 2020 2020  gNum)).         
-0005f660: 2020 2069 6620 6c65 6e28 2076 696d 672e     if len( vimg.
-0005f670: 7368 6170 6520 2920 3d3d 2034 2061 6e64  shape ) == 4 and
-0005f680: 2028 206f 7665 726d 6f64 5820 3d3d 2022   ( overmodX == "
-0005f690: 4457 4932 2220 2029 3a0a 2020 2020 2020  DWI2"  ):.      
-0005f6a0: 2020 2020 2020 2020 2020 7474 6230 2c20            ttb0, 
-0005f6b0: 7474 6477 3d67 6574 5f61 7665 7261 6765  ttdw=get_average
-0005f6c0: 5f64 7769 5f62 3028 7669 6d67 290a 2020  _dwi_b0(vimg).  
-0005f6d0: 2020 2020 2020 2020 2020 2020 2020 7669                vi
-0005f6e0: 6d67 203d 2074 7464 770a 2020 2020 2020  mg = ttdw.      
-0005f6f0: 2020 2020 2020 656c 6966 206c 656e 2820        elif len( 
-0005f700: 7669 6d67 2e73 6861 7065 2029 203d 3d20  vimg.shape ) == 
-0005f710: 3420 616e 6420 6f76 6572 6d6f 6458 203d  4 and overmodX =
-0005f720: 3d20 2244 5749 3122 3a0a 2020 2020 2020  = "DWI1":.      
-0005f730: 2020 2020 2020 2020 2020 7474 6230 2c20            ttb0, 
-0005f740: 7474 6477 3d67 6574 5f61 7665 7261 6765  ttdw=get_average
-0005f750: 5f64 7769 5f62 3028 7669 6d67 290a 2020  _dwi_b0(vimg).  
-0005f760: 2020 2020 2020 2020 2020 2020 2020 7669                vi
-0005f770: 6d67 203d 2074 7462 300a 2020 2020 2020  mg = ttb0.      
-0005f780: 2020 2020 2020 656c 6966 206c 656e 2820        elif len( 
-0005f790: 7669 6d67 2e73 6861 7065 2029 203d 3d20  vimg.shape ) == 
-0005f7a0: 3420 3a0a 2020 2020 2020 2020 2020 2020  4 :.            
-0005f7b0: 2020 2020 7669 6d67 3d61 6e74 732e 6765      vimg=ants.ge
-0005f7c0: 745f 6176 6572 6167 655f 6f66 5f74 696d  t_average_of_tim
-0005f7d0: 6573 6572 6965 7328 7669 6d67 290a 2020  eseries(vimg).  
-0005f7e0: 2020 2020 2020 2020 2020 6d73 6b3d 616e            msk=an
-0005f7f0: 7473 2e67 6574 5f6d 6173 6b28 7669 6d67  ts.get_mask(vimg
-0005f800: 290a 2020 2020 2020 2020 2020 2020 7669  ).            vi
-0005f810: 6d67 3d61 6e74 732e 6372 6f70 5f69 6d61  mg=ants.crop_ima
-0005f820: 6765 2876 696d 672c 6d73 6b29 0a20 2020  ge(vimg,msk).   
-0005f830: 2020 2020 2020 2020 2069 6620 6f76 6572           if over
-0005f840: 6d6f 6458 203d 3d20 2754 3177 273a 0a20  modX == 'T1w':. 
-0005f850: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0005f860: 6566 696d 673d 616e 7473 2e69 6d61 6765  efimg=ants.image
-0005f870: 5f63 6c6f 6e65 2820 7669 6d67 2029 0a20  _clone( vimg ). 
-0005f880: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0005f890: 6f69 7a69 6d67 203d 2061 6e74 732e 6164  oizimg = ants.ad
-0005f8a0: 645f 6e6f 6973 655f 746f 5f69 6d61 6765  d_noise_to_image
-0005f8b0: 2820 7265 6669 6d67 2a30 2c20 2761 6464  ( refimg*0, 'add
-0005f8c0: 6974 6976 6567 6175 7373 6961 6e27 2c20  itivegaussian', 
-0005f8d0: 5b31 3030 2c31 5d20 290a 2020 2020 2020  [100,1] ).      
-0005f8e0: 2020 2020 2020 2020 2020 7669 7a6c 6973            vizlis
-0005f8f0: 742e 6170 7065 6e64 2820 7669 6d67 2029  t.append( vimg )
-0005f900: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0005f910: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0005f920: 2020 2076 696d 6720 3d20 616e 7473 2e72     vimg = ants.r
-0005f930: 6573 616d 706c 655f 696d 6167 655f 746f  esample_image_to
-0005f940: 5f74 6172 6765 7428 2076 696d 672c 2072  _target( vimg, r
-0005f950: 6566 696d 6720 290a 2020 2020 2020 2020  efimg ).        
-0005f960: 2020 2020 2020 2020 7669 6d67 203d 2061          vimg = a
-0005f970: 6e74 732e 694d 6174 6828 2076 696d 672c  nts.iMath( vimg,
-0005f980: 2027 5472 756e 6361 7465 496e 7465 6e73   'TruncateIntens
-0005f990: 6974 7927 2c30 2e30 312c 302e 3938 290a  ity',0.01,0.98).
-0005f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f9b0: 7669 7a6c 6973 742e 6170 7065 6e64 2820  vizlist.append( 
-0005f9c0: 616e 7473 2e69 4d61 7468 2820 7669 6d67  ants.iMath( vimg
-0005f9d0: 2c20 274e 6f72 6d61 6c69 7a65 2720 2920  , 'Normalize' ) 
-0005f9e0: 2a20 3235 3520 290a 0a20 2020 206c 6973  * 255 )..    lis
-0005f9f0: 746c 656e 203d 206c 656e 2820 7669 7a6c  tlen = len( vizl
-0005fa00: 6973 7420 290a 2020 2020 7669 7a6c 6973  ist ).    vizlis
-0005fa10: 7420 3d20 6e70 2e61 7361 7272 6179 2820  t = np.asarray( 
-0005fa20: 7669 7a6c 6973 7420 290a 2020 2020 6966  vizlist ).    if
-0005fa30: 2073 686f 775f 6974 2069 7320 6e6f 7420   show_it is not 
-0005fa40: 4e6f 6e65 3a0a 2020 2020 2020 2020 6669  None:.        fi
-0005fa50: 6c65 6e61 6d65 6f75 743d 4e6f 6e65 0a20  lenameout=None. 
-0005fa60: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
-0005fa70: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
-0005fa80: 7269 6e74 2820 7368 6f77 5f69 7420 290a  rint( show_it ).
-0005fa90: 2020 2020 2020 2020 666f 7220 6120 696e          for a in
-0005faa0: 205b 302c 312c 325d 3a0a 2020 2020 2020   [0,1,2]:.      
-0005fab0: 2020 2020 2020 6e3d 696e 7428 6e70 2e72        n=int(np.r
-0005fac0: 6f75 6e64 2820 7265 6669 6d67 2e73 6861  ound( refimg.sha
-0005fad0: 7065 5b61 5d20 2a20 736c 6963 655f 6661  pe[a] * slice_fa
-0005fae0: 6374 6f72 2029 290a 2020 2020 2020 2020  ctor )).        
-0005faf0: 2020 2020 736c 6963 6573 3d6e 702e 7265      slices=np.re
-0005fb00: 7065 6174 2820 696e 7428 6e29 2c20 6c69  peat( int(n), li
-0005fb10: 7374 6c65 6e20 2029 0a20 2020 2020 2020  stlen  ).       
-0005fb20: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-0005fb30: 6365 2873 686f 775f 6974 2c73 7472 293a  ce(show_it,str):
-0005fb40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005fb50: 2066 696c 656e 616d 656f 7574 3d73 686f   filenameout=sho
-0005fb60: 775f 6974 2b27 5f61 7827 2b73 7472 2869  w_it+'_ax'+str(i
-0005fb70: 6e74 2861 2929 2b27 5f73 6c27 2b73 7472  nt(a))+'_sl'+str
-0005fb80: 286e 292b 272e 706e 6727 0a20 2020 2020  (n)+'.png'.     
-0005fb90: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
-0005fba0: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
-0005fbb0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0005fbc0: 2820 6669 6c65 6e61 6d65 6f75 7420 290a  ( filenameout ).
-0005fbd0: 2020 2020 2020 2020 2020 2020 616e 7473              ants
-0005fbe0: 2e70 6c6f 745f 6772 6964 2876 697a 6c69  .plot_grid(vizli
-0005fbf0: 7374 2e72 6573 6861 7065 2832 2c33 292c  st.reshape(2,3),
-0005fc00: 2073 6c69 6365 732e 7265 7368 6170 6528   slices.reshape(
-0005fc10: 322c 3329 2c20 7469 746c 653d 274d 4d20  2,3), title='MM 
-0005fc20: 5375 626a 6563 7420 2720 2b20 7369 6420  Subject ' + sid 
-0005fc30: 2b20 2720 2720 2b20 6474 6964 2c20 7266  + ' ' + dtid, rf
-0005fc40: 6163 6563 6f6c 6f72 3d27 7768 6974 6527  acecolor='white'
-0005fc50: 2c20 6178 6573 3d61 2c20 6669 6c65 6e61  , axes=a, filena
-0005fc60: 6d65 3d66 696c 656e 616d 656f 7574 2029  me=filenameout )
-0005fc70: 0a20 2020 2069 6620 7665 7262 6f73 653a  .    if verbose:
-0005fc80: 0a20 2020 2020 2020 2070 7269 6e74 2822  .        print("
-0005fc90: 7669 7a20 636f 6d70 6c65 7465 2e22 290a  viz complete.").
-0005fca0: 2020 2020 7265 7475 726e 2076 697a 6c69      return vizli
-0005fcb0: 7374 0a0a 0a64 6566 2062 6c69 6e64 5f69  st...def blind_i
-0005fcc0: 6d61 6765 5f61 7373 6573 736d 656e 7428  mage_assessment(
-0005fcd0: 0a20 2020 2069 6d61 6765 2c0a 2020 2020  .    image,.    
-0005fce0: 7669 7a5f 6669 6c65 6e61 6d65 3d4e 6f6e  viz_filename=Non
-0005fcf0: 652c 0a20 2020 2074 6974 6c65 3d46 616c  e,.    title=Fal
-0005fd00: 7365 2c0a 2020 2020 7075 6c6c 5f72 616e  se,.    pull_ran
-0005fd10: 6b3d 4661 6c73 652c 0a20 2020 2072 6573  k=False,.    res
-0005fd20: 616d 706c 653d 4e6f 6e65 2c0a 2020 2020  ample=None,.    
-0005fd30: 6e5f 746f 5f73 6b69 7020 3d20 3130 2c0a  n_to_skip = 10,.
-0005fd40: 2020 2020 7665 7262 6f73 653d 4661 6c73      verbose=Fals
-0005fd50: 650a 293a 0a20 2020 2022 2222 0a20 2020  e.):.    """.   
-0005fd60: 2071 7569 636b 2062 6c69 6e64 2069 6d61   quick blind ima
-0005fd70: 6765 2061 7373 6573 736d 656e 7420 616e  ge assessment an
-0005fd80: 6420 7472 6970 6c61 6e61 7220 7669 7375  d triplanar visu
-0005fd90: 616c 697a 6174 696f 6e20 6f66 2061 6e20  alization of an 
-0005fda0: 696d 6167 6520 2e2e 2e20 3444 2069 6e70  image ... 4D inp
-0005fdb0: 7574 2077 696c 6c20 6265 2076 6973 7561  ut will be visua
-0005fdc0: 6c69 7a65 6420 616e 6420 6173 7365 7373  lized and assess
-0005fdd0: 6564 2069 6e20 3344 2e20 2070 726f 6475  ed in 3D.  produ
-0005fde0: 6365 7320 6120 706e 6720 616e 6420 6373  ces a png and cs
-0005fdf0: 7620 7768 6572 6520 6373 7620 636f 6e74  v where csv cont
-0005fe00: 6169 6e73 3a0a 0a20 2020 202a 2072 6566  ains:..    * ref
-0005fe10: 6c65 6374 696f 6e20 6572 726f 7220 2820  lection error ( 
-0005fe20: 6573 7469 6d61 7465 7320 6173 796d 6d65  estimates asymme
-0005fe30: 7472 7920 290a 0a20 2020 202a 2062 7269  try )..    * bri
-0005fe40: 7371 2028 2062 6c69 6e64 2071 7561 6c69  sq ( blind quali
-0005fe50: 7479 2061 7373 6573 736d 656e 7420 290a  ty assessment ).
-0005fe60: 0a20 2020 202a 2070 6174 6368 2065 6967  .    * patch eig
-0005fe70: 656e 7661 6c75 6520 7261 7469 6f20 2820  envalue ratio ( 
-0005fe80: 626c 696e 6420 7175 616c 6974 7920 6173  blind quality as
-0005fe90: 7365 7373 6d65 6e74 2029 0a0a 2020 2020  sessment )..    
-0005fea0: 2a20 5053 4e52 2061 6e64 2053 5349 4d20  * PSNR and SSIM 
-0005feb0: 7673 2061 2073 6d6f 6f74 6865 6420 7265  vs a smoothed re
-0005fec0: 6665 7265 6e63 6520 2834 4420 6f72 2033  ference (4D or 3
-0005fed0: 4420 6170 7072 6f70 7269 6174 6529 0a0a  D appropriate)..
-0005fee0: 2020 2020 2a20 6d61 736b 2076 6f6c 756d      * mask volum
-0005fef0: 6520 2820 6573 7469 6d61 7465 7320 666f  e ( estimates fo
-0005ff00: 7265 6772 6f75 6e64 206f 626a 6563 7420  reground object 
-0005ff10: 7369 7a65 2029 0a0a 2020 2020 2a20 7370  size )..    * sp
-0005ff20: 6163 696e 670a 0a20 2020 202a 2064 696d  acing..    * dim
-0005ff30: 656e 7369 6f6e 2061 6674 6572 2063 726f  ension after cro
-0005ff40: 7070 696e 6720 6279 206d 6173 6b0a 0a20  pping by mask.. 
-0005ff50: 2020 2069 6d61 6765 203a 2063 6861 7261     image : chara
-0005ff60: 6374 6572 206f 7220 696d 6167 6520 6f62  cter or image ob
-0005ff70: 6a65 6374 2075 7375 616c 6c79 2061 206e  ject usually a n
-0005ff80: 6966 7469 2069 6d61 6765 0a0a 2020 2020  ifti image..    
-0005ff90: 7669 7a5f 6669 6c65 6e61 6d65 203a 2063  viz_filename : c
-0005ffa0: 6861 7261 6374 6572 2066 6f72 2061 2070  haracter for a p
-0005ffb0: 6e67 206f 7574 7075 7420 696d 6167 650a  ng output image.
-0005ffc0: 0a20 2020 2074 6974 6c65 203a 2064 6973  .    title : dis
-0005ffd0: 706c 6179 2061 2073 756d 6d61 7279 2074  play a summary t
-0005ffe0: 6974 6c65 206f 6e20 7468 6520 706e 670a  itle on the png.
-0005fff0: 0a20 2020 2070 756c 6c5f 7261 6e6b 203a  .    pull_rank :
-00060000: 2062 6f6f 6c65 616e 0a0a 2020 2020 7265   boolean..    re
-00060010: 7361 6d70 6c65 203a 204e 6f6e 652c 206e  sample : None, n
-00060020: 756d 6572 6963 206d 6178 206f 7220 6d69  umeric max or mi
-00060030: 6e2c 2072 6573 616d 706c 6573 2069 6d61  n, resamples ima
-00060040: 6765 2074 6f20 6973 6f74 726f 7079 0a0a  ge to isotropy..
-00060050: 2020 2020 6e5f 746f 5f73 6b69 7020 3a20      n_to_skip : 
-00060060: 3130 2062 7920 6465 6661 756c 743b 2073  10 by default; s
-00060070: 616d 706c 6573 2074 696d 6520 7365 7269  amples time seri
-00060080: 6573 2065 7665 7279 206e 5f74 6f5f 736b  es every n_to_sk
-00060090: 6970 2076 6f6c 756d 650a 0a20 2020 2076  ip volume..    v
-000600a0: 6572 626f 7365 203a 2062 6f6f 6c65 616e  erbose : boolean
-000600b0: 0a0a 2020 2020 2222 220a 2020 2020 696d  ..    """.    im
-000600c0: 706f 7274 2067 6c6f 6220 6173 2067 6c6f  port glob as glo
-000600d0: 620a 2020 2020 6672 6f6d 206f 732e 7061  b.    from os.pa
-000600e0: 7468 2069 6d70 6f72 7420 6578 6973 7473  th import exists
-000600f0: 0a20 2020 2069 6d70 6f72 7420 616e 7473  .    import ants
-00060100: 0a20 2020 2069 6d70 6f72 7420 6d61 7470  .    import matp
-00060110: 6c6f 746c 6962 2e70 7970 6c6f 7420 6173  lotlib.pyplot as
-00060120: 2070 6c74 0a20 2020 2066 726f 6d20 5049   plt.    from PI
-00060130: 4c20 696d 706f 7274 2049 6d61 6765 0a20  L import Image. 
-00060140: 2020 2066 726f 6d20 7061 7468 6c69 6220     from pathlib 
-00060150: 696d 706f 7274 2050 6174 680a 2020 2020  import Path.    
-00060160: 696d 706f 7274 206a 736f 6e0a 2020 2020  import json.    
-00060170: 696d 706f 7274 2072 650a 2020 2020 6672  import re.    fr
-00060180: 6f6d 2064 6970 792e 696f 2e67 7261 6469  om dipy.io.gradi
-00060190: 656e 7473 2069 6d70 6f72 7420 7265 6164  ents import read
-000601a0: 5f62 7661 6c73 5f62 7665 6373 0a20 2020  _bvals_bvecs.   
-000601b0: 206d 7973 7465 6d3d 2727 0a20 2020 2069   mystem=''.    i
-000601c0: 6620 6973 696e 7374 616e 6365 2869 6d61  f isinstance(ima
-000601d0: 6765 2c6c 6973 7429 3a0a 2020 2020 2020  ge,list):.      
-000601e0: 2020 6973 6669 6c65 6e61 6d65 3d69 7369    isfilename=isi
-000601f0: 6e73 7461 6e63 6528 2069 6d61 6765 5b30  nstance( image[0
-00060200: 5d2c 2073 7472 290a 2020 2020 2020 2020  ], str).        
-00060210: 696d 6167 6520 3d20 696d 6167 655b 305d  image = image[0]
-00060220: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00060230: 2020 2069 7366 696c 656e 616d 653d 6973     isfilename=is
-00060240: 696e 7374 616e 6365 2820 696d 6167 652c  instance( image,
-00060250: 2073 7472 290a 2020 2020 6f75 7464 6620   str).    outdf 
-00060260: 3d20 7064 2e44 6174 6146 7261 6d65 2829  = pd.DataFrame()
-00060270: 0a20 2020 206d 796d 6574 6120 3d20 4e6f  .    mymeta = No
-00060280: 6e65 0a20 2020 204d 6167 6e65 7469 6346  ne.    MagneticF
-00060290: 6965 6c64 5374 7265 6e67 7468 203d 204e  ieldStrength = N
-000602a0: 6f6e 650a 2020 2020 696d 6167 655f 6669  one.    image_fi
-000602b0: 6c65 6e61 6d65 3d27 270a 2020 2020 6966  lename=''.    if
-000602c0: 2069 7366 696c 656e 616d 653a 0a20 2020   isfilename:.   
-000602d0: 2020 2020 2069 6d61 6765 5f66 696c 656e       image_filen
-000602e0: 616d 6520 3d20 696d 6167 650a 2020 2020  ame = image.    
-000602f0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00060300: 6528 696d 6167 652c 6c69 7374 293a 0a20  e(image,list):. 
-00060310: 2020 2020 2020 2020 2020 2069 6d61 6765             image
-00060320: 5f66 696c 656e 616d 653d 696d 6167 655b  _filename=image[
-00060330: 305d 0a20 2020 2020 2020 206a 736f 6e5f  0].        json_
-00060340: 6e61 6d65 203d 2072 652e 7375 6228 222e  name = re.sub(".
-00060350: 6e69 692e 677a 222c 222e 6a73 6f6e 222c  nii.gz",".json",
-00060360: 696d 6167 655f 6669 6c65 6e61 6d65 290a  image_filename).
-00060370: 2020 2020 2020 2020 6966 2065 7869 7374          if exist
-00060380: 7328 206a 736f 6e5f 6e61 6d65 2029 3a0a  s( json_name ):.
-00060390: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-000603a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000603b0: 2077 6974 6820 6f70 656e 286a 736f 6e5f   with open(json_
-000603c0: 6e61 6d65 2c20 2772 2729 2061 7320 6663  name, 'r') as fc
-000603d0: 635f 6669 6c65 3a0a 2020 2020 2020 2020  c_file:.        
-000603e0: 2020 2020 2020 2020 2020 2020 6d79 6d65              myme
-000603f0: 7461 203d 206a 736f 6e2e 6c6f 6164 2866  ta = json.load(f
-00060400: 6363 5f66 696c 6529 0a20 2020 2020 2020  cc_file).       
-00060410: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00060420: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-00060430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060440: 2070 7269 6e74 286a 736f 6e2e 6475 6d70   print(json.dump
-00060450: 7328 6d79 6d65 7461 2c20 696e 6465 6e74  s(mymeta, indent
-00060460: 3d34 2929 0a20 2020 2020 2020 2020 2020  =4)).           
-00060470: 2020 2020 2020 2020 2066 6363 5f66 696c           fcc_fil
-00060480: 652e 636c 6f73 6528 290a 2020 2020 2020  e.close().      
-00060490: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
-000604a0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-000604b0: 7373 0a20 2020 2020 2020 206d 7973 7465  ss.        myste
-000604c0: 6d3d 5061 7468 2820 696d 6167 6520 292e  m=Path( image ).
-000604d0: 7374 656d 0a20 2020 2020 2020 206d 7973  stem.        mys
-000604e0: 7465 6d3d 5061 7468 2820 6d79 7374 656d  tem=Path( mystem
-000604f0: 2029 2e73 7465 6d0a 2020 2020 2020 2020   ).stem.        
-00060500: 696d 6167 655f 7265 6665 7265 6e63 6520  image_reference 
-00060510: 3d20 616e 7473 2e69 6d61 6765 5f72 6561  = ants.image_rea
-00060520: 6428 2069 6d61 6765 2029 0a20 2020 2020  d( image ).     
-00060530: 2020 2069 6d61 6765 203d 2061 6e74 732e     image = ants.
-00060540: 696d 6167 655f 7265 6164 2820 696d 6167  image_read( imag
-00060550: 6520 290a 2020 2020 656c 7365 3a0a 2020  e ).    else:.  
-00060560: 2020 2020 2020 696d 6167 655f 7265 6665        image_refe
-00060570: 7265 6e63 6520 3d20 616e 7473 2e69 6d61  rence = ants.ima
-00060580: 6765 5f63 6c6f 6e65 2820 696d 6167 6520  ge_clone( image 
-00060590: 290a 2020 2020 6e74 696d 6570 6f69 6e74  ).    ntimepoint
-000605a0: 7320 3d20 310a 2020 2020 6276 616c 7565  s = 1.    bvalue
-000605b0: 4d61 783d 4e6f 6e65 0a20 2020 2062 7665  Max=None.    bve
-000605c0: 636e 6f72 6d3d 4e6f 6e65 0a20 2020 2069  cnorm=None.    i
-000605d0: 6620 696d 6167 655f 7265 6665 7265 6e63  f image_referenc
-000605e0: 652e 6469 6d65 6e73 696f 6e20 3d3d 2034  e.dimension == 4
-000605f0: 3a0a 2020 2020 2020 2020 6e74 696d 6570  :.        ntimep
-00060600: 6f69 6e74 7320 3d20 696d 6167 655f 7265  oints = image_re
-00060610: 6665 7265 6e63 652e 7368 6170 655b 335d  ference.shape[3]
-00060620: 0a20 2020 2020 2020 2069 6620 2244 5449  .        if "DTI
-00060630: 2220 696e 2069 6d61 6765 5f66 696c 656e  " in image_filen
-00060640: 616d 653a 0a20 2020 2020 2020 2020 2020  ame:.           
-00060650: 206d 7954 5373 6567 203d 2073 6567 6d65   myTSseg = segme
-00060660: 6e74 5f74 696d 6573 6572 6965 735f 6279  nt_timeseries_by
-00060670: 5f6d 6561 6e76 616c 7565 2820 696d 6167  _meanvalue( imag
-00060680: 655f 7265 6665 7265 6e63 6520 290a 2020  e_reference ).  
-00060690: 2020 2020 2020 2020 2020 696d 6167 655f            image_
-000606a0: 6230 2c20 696d 6167 655f 6477 6920 3d20  b0, image_dwi = 
-000606b0: 6765 745f 6176 6572 6167 655f 6477 695f  get_average_dwi_
-000606c0: 6230 2820 696d 6167 655f 7265 6665 7265  b0( image_refere
-000606d0: 6e63 652c 2066 6173 743d 5472 7565 2029  nce, fast=True )
-000606e0: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
-000606f0: 6765 5f62 3020 3d20 616e 7473 2e69 4d61  ge_b0 = ants.iMa
-00060700: 7468 2820 696d 6167 655f 6230 2c20 274e  th( image_b0, 'N
-00060710: 6f72 6d61 6c69 7a65 2720 290a 2020 2020  ormalize' ).    
-00060720: 2020 2020 2020 2020 696d 6167 655f 6477          image_dw
-00060730: 6920 3d20 616e 7473 2e69 4d61 7468 2820  i = ants.iMath( 
-00060740: 696d 6167 655f 6477 692c 2027 4e6f 726d  image_dwi, 'Norm
-00060750: 616c 697a 6527 2029 0a20 2020 2020 2020  alize' ).       
-00060760: 2020 2020 2062 7661 6c5f 6e61 6d65 203d       bval_name =
-00060770: 2072 652e 7375 6228 222e 6e69 692e 677a   re.sub(".nii.gz
-00060780: 222c 222e 6276 616c 222c 696d 6167 655f  ",".bval",image_
-00060790: 6669 6c65 6e61 6d65 290a 2020 2020 2020  filename).      
-000607a0: 2020 2020 2020 6276 6563 5f6e 616d 6520        bvec_name 
-000607b0: 3d20 7265 2e73 7562 2822 2e6e 6969 2e67  = re.sub(".nii.g
-000607c0: 7a22 2c22 2e62 7665 6322 2c69 6d61 6765  z",".bvec",image
-000607d0: 5f66 696c 656e 616d 6529 0a20 2020 2020  _filename).     
-000607e0: 2020 2020 2020 2069 6620 6578 6973 7473         if exists
-000607f0: 2820 6276 616c 5f6e 616d 6520 2920 616e  ( bval_name ) an
-00060800: 6420 6578 6973 7473 2820 6276 6563 5f6e  d exists( bvec_n
-00060810: 616d 6520 293a 0a20 2020 2020 2020 2020  ame ):.         
-00060820: 2020 2020 2020 2062 7661 6c73 2c20 6276         bvals, bv
-00060830: 6563 7320 3d20 7265 6164 5f62 7661 6c73  ecs = read_bvals
-00060840: 5f62 7665 6373 2820 6276 616c 5f6e 616d  _bvecs( bval_nam
-00060850: 6520 2c20 6276 6563 5f6e 616d 6520 2029  e , bvec_name  )
-00060860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00060870: 2062 7661 6c75 654d 6178 203d 2062 7661   bvalueMax = bva
-00060880: 6c73 2e6d 6178 2829 0a20 2020 2020 2020  ls.max().       
-00060890: 2020 2020 2020 2020 2062 7665 636e 6f72           bvecnor
-000608a0: 6d20 3d20 6e70 2e6c 696e 616c 672e 6e6f  m = np.linalg.no
-000608b0: 726d 2862 7665 6373 2c61 7869 733d 3129  rm(bvecs,axis=1)
-000608c0: 2e72 6573 6861 7065 2820 6276 6563 732e  .reshape( bvecs.
-000608d0: 7368 6170 655b 305d 2c31 2029 0a20 2020  shape[0],1 ).   
-000608e0: 2020 2020 2020 2020 2020 2020 2062 7665               bve
-000608f0: 636e 6f72 6d20 3d20 6276 6563 6e6f 726d  cnorm = bvecnorm
-00060900: 2e6d 6178 2829 0a20 2020 2020 2020 2065  .max().        e
-00060910: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00060920: 2069 6d61 6765 5f62 3020 3d20 616e 7473   image_b0 = ants
-00060930: 2e67 6574 5f61 7665 7261 6765 5f6f 665f  .get_average_of_
-00060940: 7469 6d65 7365 7269 6573 2820 696d 6167  timeseries( imag
-00060950: 655f 7265 6665 7265 6e63 6520 292e 694d  e_reference ).iM
-00060960: 6174 6828 224e 6f72 6d61 6c69 7a65 2229  ath("Normalize")
-00060970: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00060980: 2020 2069 6d61 6765 5f63 6f6d 7061 7265     image_compare
-00060990: 203d 2061 6e74 732e 736d 6f6f 7468 5f69   = ants.smooth_i
-000609a0: 6d61 6765 2820 696d 6167 655f 7265 6665  mage( image_refe
-000609b0: 7265 6e63 652c 2033 2c20 7369 676d 615f  rence, 3, sigma_
-000609c0: 696e 5f70 6879 7369 6361 6c5f 636f 6f72  in_physical_coor
-000609d0: 6469 6e61 7465 733d 4661 6c73 6520 290a  dinates=False ).
-000609e0: 2020 2020 666f 7220 6a6a 6a20 696e 2072      for jjj in r
-000609f0: 616e 6765 2830 2c6e 7469 6d65 706f 696e  ange(0,ntimepoin
-00060a00: 7473 2c6e 5f74 6f5f 736b 6970 293a 0a20  ts,n_to_skip):. 
-00060a10: 2020 2020 2020 206d 6f64 616c 6974 793d         modality=
-00060a20: 2775 6e6b 6e6f 776e 270a 2020 2020 2020  'unknown'.      
-00060a30: 2020 6966 2022 7273 664d 5249 2220 696e    if "rsfMRI" in
-00060a40: 2069 6d61 6765 5f66 696c 656e 616d 653a   image_filename:
-00060a50: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
-00060a60: 616c 6974 793d 2772 7366 4d52 4927 0a20  ality='rsfMRI'. 
-00060a70: 2020 2020 2020 2065 6c69 6620 2254 3177         elif "T1w
-00060a80: 2220 696e 2069 6d61 6765 5f66 696c 656e  " in image_filen
-00060a90: 616d 653a 0a20 2020 2020 2020 2020 2020  ame:.           
-00060aa0: 206d 6f64 616c 6974 793d 2754 3177 270a   modality='T1w'.
-00060ab0: 2020 2020 2020 2020 656c 6966 2022 5432          elif "T2
-00060ac0: 466c 6169 7222 2069 6e20 696d 6167 655f  Flair" in image_
-00060ad0: 6669 6c65 6e61 6d65 3a0a 2020 2020 2020  filename:.      
-00060ae0: 2020 2020 2020 6d6f 6461 6c69 7479 3d27        modality='
-00060af0: 5432 466c 6169 7227 0a20 2020 2020 2020  T2Flair'.       
-00060b00: 2065 6c69 6620 224e 4d32 444d 5422 2069   elif "NM2DMT" i
-00060b10: 6e20 696d 6167 655f 6669 6c65 6e61 6d65  n image_filename
-00060b20: 3a0a 2020 2020 2020 2020 2020 2020 6d6f  :.            mo
-00060b30: 6461 6c69 7479 3d27 4e4d 3244 4d54 270a  dality='NM2DMT'.
-00060b40: 2020 2020 2020 2020 6966 2069 6d61 6765          if image
-00060b50: 5f72 6566 6572 656e 6365 2e64 696d 656e  _reference.dimen
-00060b60: 7369 6f6e 203d 3d20 343a 0a20 2020 2020  sion == 4:.     
-00060b70: 2020 2020 2020 2069 6d61 6765 203d 2061         image = a
-00060b80: 6e74 732e 736c 6963 655f 696d 6167 6528  nts.slice_image(
-00060b90: 2069 6d61 6765 5f72 6566 6572 656e 6365   image_reference
-00060ba0: 2c20 6964 783d 696e 7428 6a6a 6a29 2c20  , idx=int(jjj), 
-00060bb0: 6178 6973 3d33 2029 0a20 2020 2020 2020  axis=3 ).       
-00060bc0: 2020 2020 2069 6620 2244 5449 2220 696e       if "DTI" in
-00060bd0: 2069 6d61 6765 5f66 696c 656e 616d 653a   image_filename:
-00060be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00060bf0: 2069 6620 6a6a 6a20 696e 206d 7954 5373   if jjj in myTSs
-00060c00: 6567 5b27 6869 6768 6572 6d65 616e 7327  eg['highermeans'
-00060c10: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-00060c20: 2020 2020 2020 2069 6d61 6765 5f63 6f6d         image_com
-00060c30: 7061 7265 203d 2061 6e74 732e 696d 6167  pare = ants.imag
-00060c40: 655f 636c 6f6e 6528 2069 6d61 6765 5f62  e_clone( image_b
-00060c50: 3020 290a 2020 2020 2020 2020 2020 2020  0 ).            
-00060c60: 2020 2020 2020 2020 6d6f 6461 6c69 7479          modality
-00060c70: 3d27 4454 4962 3027 0a20 2020 2020 2020  ='DTIb0'.       
-00060c80: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00060c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060ca0: 2020 2069 6d61 6765 5f63 6f6d 7061 7265     image_compare
-00060cb0: 203d 2061 6e74 732e 696d 6167 655f 636c   = ants.image_cl
-00060cc0: 6f6e 6528 2069 6d61 6765 5f64 7769 2029  one( image_dwi )
-00060cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00060ce0: 2020 2020 206d 6f64 616c 6974 793d 2744       modality='D
-00060cf0: 5449 6477 6927 0a20 2020 2020 2020 2020  TIdwi'.         
-00060d00: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00060d10: 2020 2020 2020 2020 2069 6d61 6765 5f63           image_c
-00060d20: 6f6d 7061 7265 203d 2061 6e74 732e 696d  ompare = ants.im
-00060d30: 6167 655f 636c 6f6e 6528 2069 6d61 6765  age_clone( image
-00060d40: 5f62 3020 290a 2020 2020 2020 2020 2320  _b0 ).        # 
-00060d50: 696d 6167 6520 3d20 616e 7473 2e69 4d61  image = ants.iMa
-00060d60: 7468 2820 696d 6167 652c 2027 5472 756e  th( image, 'Trun
-00060d70: 6361 7465 496e 7465 6e73 6974 7927 2c30  cateIntensity',0
-00060d80: 2e30 312c 302e 3939 3529 0a20 2020 2020  .01,0.995).     
-00060d90: 2020 206d 696e 7370 6320 3d20 6e70 2e6d     minspc = np.m
-00060da0: 696e 2861 6e74 732e 6765 745f 7370 6163  in(ants.get_spac
-00060db0: 696e 6728 696d 6167 6529 290a 2020 2020  ing(image)).    
-00060dc0: 2020 2020 6d61 7873 7063 203d 206e 702e      maxspc = np.
-00060dd0: 6d61 7828 616e 7473 2e67 6574 5f73 7061  max(ants.get_spa
-00060de0: 6369 6e67 2869 6d61 6765 2929 0a20 2020  cing(image)).   
-00060df0: 2020 2020 2069 6620 7265 7361 6d70 6c65       if resample
-00060e00: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00060e10: 2020 2020 2020 2020 2020 6966 2072 6573            if res
-00060e20: 616d 706c 6520 3d3d 2027 6d69 6e27 3a0a  ample == 'min':.
-00060e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060e40: 6966 206d 696e 7370 6320 3c20 3165 2d31  if minspc < 1e-1
-00060e50: 323a 0a20 2020 2020 2020 2020 2020 2020  2:.             
-00060e60: 2020 2020 2020 206d 696e 7370 6320 3d20         minspc = 
-00060e70: 6e70 2e6d 6178 2861 6e74 732e 6765 745f  np.max(ants.get_
-00060e80: 7370 6163 696e 6728 696d 6167 6529 290a  spacing(image)).
-00060e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060ea0: 6e65 7773 7063 203d 206e 702e 7265 7065  newspc = np.repe
-00060eb0: 6174 2820 6d69 6e73 7063 2c20 3320 290a  at( minspc, 3 ).
-00060ec0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00060ed0: 2072 6573 616d 706c 6520 3d3d 2027 6d61   resample == 'ma
-00060ee0: 7827 3a0a 2020 2020 2020 2020 2020 2020  x':.            
-00060ef0: 2020 2020 6e65 7773 7063 203d 206e 702e      newspc = np.
-00060f00: 7265 7065 6174 2820 6d61 7873 7063 2c20  repeat( maxspc, 
-00060f10: 3320 290a 2020 2020 2020 2020 2020 2020  3 ).            
-00060f20: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00060f30: 2020 2020 2020 6e65 7773 7063 203d 206e        newspc = n
-00060f40: 702e 7265 7065 6174 2820 7265 7361 6d70  p.repeat( resamp
-00060f50: 6c65 2c20 3320 290a 2020 2020 2020 2020  le, 3 ).        
-00060f60: 2020 2020 696d 6167 6520 3d20 616e 7473      image = ants
-00060f70: 2e72 6573 616d 706c 655f 696d 6167 6528  .resample_image(
-00060f80: 2069 6d61 6765 2c20 6e65 7773 7063 2029   image, newspc )
-00060f90: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
-00060fa0: 6765 5f63 6f6d 7061 7265 203d 2061 6e74  ge_compare = ant
-00060fb0: 732e 7265 7361 6d70 6c65 5f69 6d61 6765  s.resample_image
-00060fc0: 2820 696d 6167 655f 636f 6d70 6172 652c  ( image_compare,
-00060fd0: 206e 6577 7370 6320 290a 2020 2020 2020   newspc ).      
-00060fe0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00060ff0: 2020 2020 2320 6368 6563 6b20 666f 7220      # check for 
-00061000: 7370 6320 636c 6f73 6520 746f 207a 6572  spc close to zer
-00061010: 6f0a 2020 2020 2020 2020 2020 2020 7370  o.            sp
-00061020: 6320 3d20 6c69 7374 2861 6e74 732e 6765  c = list(ants.ge
-00061030: 745f 7370 6163 696e 6728 696d 6167 6529  t_spacing(image)
-00061040: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
-00061050: 7220 7370 636b 2069 6e20 7261 6e67 6528  r spck in range(
-00061060: 6c65 6e28 7370 6329 293a 0a20 2020 2020  len(spc)):.     
-00061070: 2020 2020 2020 2020 2020 2069 6620 7370             if sp
-00061080: 635b 7370 636b 5d20 3c20 3165 2d31 323a  c[spck] < 1e-12:
-00061090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000610a0: 2020 2020 2073 7063 5b73 7063 6b5d 3d31       spc[spck]=1
-000610b0: 0a20 2020 2020 2020 2020 2020 2061 6e74  .            ant
-000610c0: 732e 7365 745f 7370 6163 696e 6728 2069  s.set_spacing( i
-000610d0: 6d61 6765 2c20 7370 6320 290a 2020 2020  mage, spc ).    
-000610e0: 2020 2020 2020 2020 616e 7473 2e73 6574          ants.set
-000610f0: 5f73 7061 6369 6e67 2820 696d 6167 655f  _spacing( image_
-00061100: 636f 6d70 6172 652c 2073 7063 2029 0a20  compare, spc ). 
-00061110: 2020 2020 2020 2023 2069 6620 224e 4d32         # if "NM2
-00061120: 444d 5422 2069 6e20 696d 6167 655f 6669  DMT" in image_fi
-00061130: 6c65 6e61 6d65 206f 7220 2246 4958 4d45  lename or "FIXME
-00061140: 2220 696e 2069 6d61 6765 5f66 696c 656e  " in image_filen
-00061150: 616d 6520 6f72 2022 5350 4543 5422 2069  ame or "SPECT" i
-00061160: 6e20 696d 6167 655f 6669 6c65 6e61 6d65  n image_filename
-00061170: 206f 7220 2255 4e4b 4e4f 574e 2220 696e   or "UNKNOWN" in
-00061180: 2069 6d61 6765 5f66 696c 656e 616d 653a   image_filename:
-00061190: 0a20 2020 2020 2020 206d 696e 7370 6320  .        minspc 
-000611a0: 3d20 6e70 2e6d 696e 2861 6e74 732e 6765  = np.min(ants.ge
-000611b0: 745f 7370 6163 696e 6728 696d 6167 6529  t_spacing(image)
-000611c0: 290a 2020 2020 2020 2020 6d61 7873 7063  ).        maxspc
-000611d0: 203d 206e 702e 6d61 7828 616e 7473 2e67   = np.max(ants.g
-000611e0: 6574 5f73 7061 6369 6e67 2869 6d61 6765  et_spacing(image
-000611f0: 2929 0a20 2020 2020 2020 206d 736b 203d  )).        msk =
-00061200: 2061 6e74 732e 7468 7265 7368 6f6c 645f   ants.threshold_
-00061210: 696d 6167 6528 2061 6e74 732e 694d 6174  image( ants.iMat
-00061220: 6828 696d 6167 652c 274e 6f72 6d61 6c69  h(image,'Normali
-00061230: 7a65 2729 2c20 302e 3135 2c20 312e 3020  ze'), 0.15, 1.0 
-00061240: 290a 2020 2020 2020 2020 2320 656c 7365  ).        # else
-00061250: 3a0a 2020 2020 2020 2020 2320 2020 206d  :.        #    m
-00061260: 736b 203d 2061 6e74 732e 6765 745f 6d61  sk = ants.get_ma
-00061270: 736b 2820 696d 6167 6520 290a 2020 2020  sk( image ).    
-00061280: 2020 2020 6d73 6b20 3d20 616e 7473 2e6d      msk = ants.m
-00061290: 6f72 7068 6f6c 6f67 7928 6d73 6b2c 2022  orphology(msk, "
-000612a0: 636c 6f73 6522 2c20 3320 290a 2020 2020  close", 3 ).    
-000612b0: 2020 2020 6267 6d73 6b20 3d20 6d73 6b2a      bgmsk = msk*
-000612c0: 302b 312d 6d73 6b0a 2020 2020 2020 2020  0+1-msk.        
-000612d0: 6d73 6b64 696c 203d 2061 6e74 732e 694d  mskdil = ants.iM
-000612e0: 6174 6828 6d73 6b2c 2022 4d44 222c 2034  ath(msk, "MD", 4
-000612f0: 2029 0a20 2020 2020 2020 2023 2061 6e74   ).        # ant
-00061300: 732e 706c 6f74 5f6f 7274 686f 2820 696d  s.plot_ortho( im
-00061310: 6167 652c 206d 736b 2c20 6372 6f70 3d46  age, msk, crop=F
-00061320: 616c 7365 2029 0a20 2020 2020 2020 206e  alse ).        n
-00061330: 766f 7820 3d20 696e 7428 206d 736b 2e73  vox = int( msk.s
-00061340: 756d 2829 2029 0a20 2020 2020 2020 2073  um() ).        s
-00061350: 7063 203d 2061 6e74 732e 6765 745f 7370  pc = ants.get_sp
-00061360: 6163 696e 6728 2069 6d61 6765 2029 0a20  acing( image ). 
-00061370: 2020 2020 2020 206f 7267 203d 2061 6e74         org = ant
-00061380: 732e 6765 745f 6f72 6967 696e 2820 696d  s.get_origin( im
-00061390: 6167 6520 290a 2020 2020 2020 2020 6966  age ).        if
-000613a0: 2028 206e 766f 7820 3e20 3020 293a 0a20   ( nvox > 0 ):. 
-000613b0: 2020 2020 2020 2020 2020 2069 6d61 6765             image
-000613c0: 203d 2061 6e74 732e 6372 6f70 5f69 6d61   = ants.crop_ima
-000613d0: 6765 2820 696d 6167 652c 206d 736b 6469  ge( image, mskdi
-000613e0: 6c20 292e 694d 6174 6828 224e 6f72 6d61  l ).iMath("Norma
-000613f0: 6c69 7a65 2229 0a20 2020 2020 2020 2020  lize").         
-00061400: 2020 206d 736b 203d 2061 6e74 732e 6372     msk = ants.cr
-00061410: 6f70 5f69 6d61 6765 2820 6d73 6b2c 206d  op_image( msk, m
-00061420: 736b 6469 6c20 292e 694d 6174 6828 224e  skdil ).iMath("N
-00061430: 6f72 6d61 6c69 7a65 2229 0a20 2020 2020  ormalize").     
-00061440: 2020 2020 2020 2062 676d 736b 203d 2061         bgmsk = a
-00061450: 6e74 732e 6372 6f70 5f69 6d61 6765 2820  nts.crop_image( 
-00061460: 6267 6d73 6b2c 206d 736b 6469 6c20 292e  bgmsk, mskdil ).
-00061470: 694d 6174 6828 224e 6f72 6d61 6c69 7a65  iMath("Normalize
-00061480: 2229 0a20 2020 2020 2020 2020 2020 2069  ").            i
-00061490: 6d61 6765 5f63 6f6d 7061 7265 203d 2061  mage_compare = a
-000614a0: 6e74 732e 6372 6f70 5f69 6d61 6765 2820  nts.crop_image( 
-000614b0: 696d 6167 655f 636f 6d70 6172 652c 206d  image_compare, m
-000614c0: 736b 6469 6c20 292e 694d 6174 6828 224e  skdil ).iMath("N
-000614d0: 6f72 6d61 6c69 7a65 2229 2020 2020 2020  ormalize")      
-000614e0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-000614f0: 2020 6e70 6174 6368 203d 2069 6e74 2820    npatch = int( 
-00061500: 6e70 2e72 6f75 6e64 2820 2030 2e31 202a  np.round(  0.1 *
-00061510: 206e 766f 7820 2920 290a 2020 2020 2020   nvox ) ).      
-00061520: 2020 2020 2020 6e70 6174 6368 203d 206e        npatch = n
-00061530: 702e 6d69 6e28 2020 5b35 3132 2c6e 7061  p.min(  [512,npa
-00061540: 7463 6820 5d20 290a 2020 2020 2020 2020  tch ] ).        
-00061550: 2020 2020 7061 7463 685f 7368 6170 6520      patch_shape 
-00061560: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-00061570: 2066 6f72 206b 2069 6e20 7261 6e67 6528   for k in range(
-00061580: 2033 2029 3a0a 2020 2020 2020 2020 2020   3 ):.          
-00061590: 2020 2020 2020 7020 3d20 696e 7428 2033        p = int( 3
-000615a0: 322e 3020 2f20 616e 7473 2e67 6574 5f73  2.0 / ants.get_s
-000615b0: 7061 6369 6e67 2820 696d 6167 6520 2029  pacing( image  )
-000615c0: 5b6b 5d20 290a 2020 2020 2020 2020 2020  [k] ).          
-000615d0: 2020 2020 2020 6966 2070 203e 2069 6e74        if p > int
-000615e0: 2820 6e70 2e72 6f75 6e64 2820 696d 6167  ( np.round( imag
-000615f0: 652e 7368 6170 655b 6b5d 202a 2030 2e35  e.shape[k] * 0.5
-00061600: 2029 2029 3a0a 2020 2020 2020 2020 2020   ) ):.          
-00061610: 2020 2020 2020 2020 2020 7020 3d20 696e            p = in
-00061620: 7428 206e 702e 726f 756e 6428 2069 6d61  t( np.round( ima
-00061630: 6765 2e73 6861 7065 5b6b 5d20 2a20 302e  ge.shape[k] * 0.
-00061640: 3520 2920 290a 2020 2020 2020 2020 2020  5 ) ).          
-00061650: 2020 2020 2020 7061 7463 685f 7368 6170        patch_shap
-00061660: 652e 6170 7065 6e64 2820 7020 290a 2020  e.append( p ).  
-00061670: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
-00061680: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-00061690: 2020 2020 2020 7072 696e 7428 696d 6167        print(imag
-000616a0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-000616b0: 2020 2070 7269 6e74 2820 7061 7463 685f     print( patch_
-000616c0: 7368 6170 6520 290a 2020 2020 2020 2020  shape ).        
-000616d0: 2020 2020 2020 2020 7072 696e 7428 206e          print( n
-000616e0: 7061 7463 6820 290a 2020 2020 2020 2020  patch ).        
-000616f0: 2020 2020 6d79 6576 7220 3d20 6d61 7468      myevr = math
-00061700: 2e6e 616e 2023 2064 6f6e 7420 7761 6e74  .nan # dont want
-00061710: 2074 6f20 6661 696c 2069 6620 736f 6d65   to fail if some
-00061720: 7468 696e 6720 6f64 6420 6861 7070 656e  thing odd happen
-00061730: 7320 696e 2070 6174 6368 2065 7874 7261  s in patch extra
-00061740: 6374 696f 6e0a 2020 2020 2020 2020 2020  ction.          
-00061750: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00061760: 2020 2020 2020 206d 7965 7672 203d 2061         myevr = a
-00061770: 6e74 7370 7974 3177 2e70 6174 6368 5f65  ntspyt1w.patch_e
-00061780: 6967 656e 7661 6c75 655f 7261 7469 6f28  igenvalue_ratio(
-00061790: 2069 6d61 6765 2c20 6e70 6174 6368 2c20   image, npatch, 
-000617a0: 7061 7463 685f 7368 6170 652c 0a20 2020  patch_shape,.   
-000617b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000617c0: 2065 7664 6570 7468 203d 2030 2e39 2c20   evdepth = 0.9, 
-000617d0: 6d61 736b 3d6d 736b 2029 0a20 2020 2020  mask=msk ).     
-000617e0: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
-000617f0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00061800: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
-00061810: 6966 2070 756c 6c5f 7261 6e6b 3a0a 2020  if pull_rank:.  
-00061820: 2020 2020 2020 2020 2020 2020 2020 696d                im
-00061830: 6167 6520 3d20 616e 7473 2e72 616e 6b5f  age = ants.rank_
-00061840: 696e 7465 6e73 6974 7928 696d 6167 6529  intensity(image)
-00061850: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
-00061860: 6765 7265 666c 6563 7420 3d20 616e 7473  gereflect = ants
-00061870: 2e72 6566 6c65 6374 5f69 6d61 6765 2869  .reflect_image(i
-00061880: 6d61 6765 2c20 6178 6973 3d30 290a 2020  mage, axis=0).  
-00061890: 2020 2020 2020 2020 2020 6173 796d 5f65            asym_e
-000618a0: 7272 203d 2028 2069 6d61 6765 202d 2069  rr = ( image - i
-000618b0: 6d61 6765 7265 666c 6563 7420 292e 6162  magereflect ).ab
-000618c0: 7328 292e 6d65 616e 2829 0a20 2020 2020  s().mean().     
-000618d0: 2020 2020 2020 2023 2065 7374 696d 6174         # estimat
-000618e0: 6520 6e6f 6973 6520 6279 2063 656e 7465  e noise by cente
-000618f0: 7220 6372 6f70 7069 6e67 2c20 6465 6e6f  r cropping, deno
-00061900: 697a 696e 6720 616e 6420 7461 6b69 6e67  izing and taking
-00061910: 206d 6167 6e69 7475 6465 206f 6620 6469   magnitude of di
-00061920: 6666 6572 656e 6365 0a20 2020 2020 2020  fference.       
-00061930: 2020 2020 206e 6f63 726f 703d 4661 6c73       nocrop=Fals
-00061940: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-00061950: 2069 6d61 6765 2e64 696d 656e 7369 6f6e   image.dimension
-00061960: 203d 3d20 333a 0a20 2020 2020 2020 2020   == 3:.         
-00061970: 2020 2020 2020 2069 6620 696d 6167 652e         if image.
-00061980: 7368 6170 655b 325d 203d 3d20 313a 0a20  shape[2] == 1:. 
-00061990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000619a0: 2020 206e 6f63 726f 703d 5472 7565 2020     nocrop=True  
-000619b0: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
-000619c0: 2020 2069 6620 6d61 7873 7063 2f6d 696e     if maxspc/min
-000619d0: 7370 6320 3e20 3130 3a0a 2020 2020 2020  spc > 10:.      
-000619e0: 2020 2020 2020 2020 2020 6e6f 6372 6f70            nocrop
-000619f0: 3d54 7275 650a 2020 2020 2020 2020 2020  =True.          
-00061a00: 2020 6966 206e 6f63 726f 703a 0a20 2020    if nocrop:.   
-00061a10: 2020 2020 2020 2020 2020 2020 206d 7963               myc
-00061a20: 6320 3d20 616e 7473 2e69 6d61 6765 5f63  c = ants.image_c
-00061a30: 6c6f 6e65 2820 696d 6167 6520 290a 2020  lone( image ).  
-00061a40: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00061a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061a60: 6d79 6363 203d 2061 6e74 7370 7974 3177  mycc = antspyt1w
-00061a70: 2e73 7065 6369 616c 5f63 726f 7028 2069  .special_crop( i
-00061a80: 6d61 6765 2c0a 2020 2020 2020 2020 2020  mage,.          
-00061a90: 2020 2020 2020 2020 2020 616e 7473 2e67            ants.g
-00061aa0: 6574 5f63 656e 7465 725f 6f66 5f6d 6173  et_center_of_mas
-00061ab0: 7328 206d 736b 202a 3020 2b20 3120 292c  s( msk *0 + 1 ),
-00061ac0: 2070 6174 6368 5f73 6861 7065 2029 0a20   patch_shape ). 
-00061ad0: 2020 2020 2020 2020 2020 206d 7963 6364             myccd
-00061ae0: 203d 2061 6e74 732e 6465 6e6f 6973 655f   = ants.denoise_
-00061af0: 696d 6167 6528 206d 7963 632c 2070 3d32  image( mycc, p=2
-00061b00: 2c72 3d32 2c6e 6f69 7365 5f6d 6f64 656c  ,r=2,noise_model
-00061b10: 3d27 4761 7573 7369 616e 2720 290a 2020  ='Gaussian' ).  
-00061b20: 2020 2020 2020 2020 2020 6e6f 697a 6c65            noizle
-00061b30: 7665 6c20 3d20 2820 6d79 6363 202d 206d  vel = ( mycc - m
-00061b40: 7963 6364 2029 2e61 6273 2829 2e6d 6561  yccd ).abs().mea
-00061b50: 6e28 290a 2020 2020 2320 2020 2020 2020  n().    #       
-00061b60: 2061 6e74 732e 706c 6f74 5f6f 7274 686f   ants.plot_ortho
-00061b70: 2820 696d 6167 652c 2063 726f 703d 4661  ( image, crop=Fa
-00061b80: 6c73 652c 2066 696c 656e 616d 653d 7669  lse, filename=vi
-00061b90: 7a5f 6669 6c65 6e61 6d65 2c20 666c 6174  z_filename, flat
-00061ba0: 3d54 7275 652c 2078 797a 5f6c 696e 6573  =True, xyz_lines
-00061bb0: 3d46 616c 7365 2c20 6f72 6965 6e74 5f6c  =False, orient_l
-00061bc0: 6162 656c 733d 4661 6c73 652c 2078 797a  abels=False, xyz
-00061bd0: 5f70 6164 3d30 2029 0a20 2020 2023 2020  _pad=0 ).    #  
-00061be0: 2020 2020 2020 6672 6f6d 2062 7269 7371        from brisq
-00061bf0: 7565 2069 6d70 6f72 7420 4252 4953 5155  ue import BRISQU
-00061c00: 450a 2020 2020 2320 2020 2020 2020 206f  E.    #        o
-00061c10: 626a 203d 2042 5249 5351 5545 2875 726c  bj = BRISQUE(url
-00061c20: 3d46 616c 7365 290a 2020 2020 2320 2020  =False).    #   
-00061c30: 2020 2020 206d 7962 7269 7371 203d 206f       mybrisq = o
-00061c40: 626a 2e73 636f 7265 2820 6e70 2e61 7272  bj.score( np.arr
-00061c50: 6179 2820 496d 6167 652e 6f70 656e 2820  ay( Image.open( 
-00061c60: 7669 7a5f 6669 6c65 6e61 6d65 2029 2920  viz_filename )) 
-00061c70: 290a 2020 2020 2020 2020 2020 2020 6d73  ).            ms
-00061c80: 6b5f 766f 6c20 3d20 6d73 6b2e 7375 6d28  k_vol = msk.sum(
-00061c90: 2920 2a20 6e70 2e70 726f 6428 2073 7063  ) * np.prod( spc
-00061ca0: 2029 0a20 2020 2020 2020 2020 2020 2062   ).            b
-00061cb0: 6773 7464 203d 2069 6d61 6765 5b20 6267  gstd = image[ bg
-00061cc0: 6d73 6b20 3d3d 2031 205d 2e73 7464 2829  msk == 1 ].std()
-00061cd0: 0a20 2020 2020 2020 2020 2020 2066 676d  .            fgm
-00061ce0: 6561 6e20 3d20 696d 6167 655b 206d 736b  ean = image[ msk
-00061cf0: 203d 3d20 3120 5d2e 6d65 616e 2829 0a20   == 1 ].mean(). 
-00061d00: 2020 2020 2020 2020 2020 2062 676d 6561             bgmea
-00061d10: 6e20 3d20 696d 6167 655b 2062 676d 736b  n = image[ bgmsk
-00061d20: 203d 3d20 3120 5d2e 6d65 616e 2829 0a20   == 1 ].mean(). 
-00061d30: 2020 2020 2020 2020 2020 2073 6e72 7265             snrre
-00061d40: 6620 3d20 6667 6d65 616e 202f 2062 6773  f = fgmean / bgs
-00061d50: 7464 0a20 2020 2020 2020 2020 2020 2063  td.            c
-00061d60: 6e72 7265 6620 3d20 2820 6667 6d65 616e  nrref = ( fgmean
-00061d70: 202d 2062 676d 6561 6e20 2920 2f20 6267   - bgmean ) / bg
-00061d80: 7374 640a 2020 2020 2020 2020 2020 2020  std.            
-00061d90: 7073 6e72 7265 6620 3d20 616e 7473 7079  psnrref = antspy
-00061da0: 6e65 742e 7073 6e72 2820 2069 6d61 6765  net.psnr(  image
-00061db0: 5f63 6f6d 7061 7265 2c20 696d 6167 6520  _compare, image 
-00061dc0: 2029 0a20 2020 2020 2020 2020 2020 2073   ).            s
-00061dd0: 7369 6d72 6566 203d 2061 6e74 7370 796e  simref = antspyn
-00061de0: 6574 2e73 7369 6d28 2020 696d 6167 655f  et.ssim(  image_
-00061df0: 636f 6d70 6172 652c 2069 6d61 6765 2020  compare, image  
-00061e00: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00061e10: 206e 6f63 726f 703a 0a20 2020 2020 2020   nocrop:.       
-00061e20: 2020 2020 2020 2020 206d 796d 6920 3d20           mymi = 
-00061e30: 6d61 7468 2e69 6e66 0a20 2020 2020 2020  math.inf.       
-00061e40: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00061e50: 2020 2020 2020 2020 2020 206d 796d 6920             mymi 
-00061e60: 3d20 616e 7473 2e69 6d61 6765 5f6d 7574  = ants.image_mut
-00061e70: 7561 6c5f 696e 666f 726d 6174 696f 6e28  ual_information(
-00061e80: 2069 6d61 6765 5f63 6f6d 7061 7265 2c20   image_compare, 
-00061e90: 696d 6167 6520 290a 2020 2020 2020 2020  image ).        
-00061ea0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00061eb0: 2020 6d73 6b5f 766f 6c20 3d20 300a 2020    msk_vol = 0.  
-00061ec0: 2020 2020 2020 2020 2020 6d79 6576 7220            myevr 
-00061ed0: 3d20 6d79 6d69 203d 2073 7369 6d72 6566  = mymi = ssimref
-00061ee0: 203d 2070 736e 7272 6566 203d 2063 6e72   = psnrref = cnr
-00061ef0: 7265 6620 3d20 6173 796d 5f65 7272 203d  ref = asym_err =
-00061f00: 206e 6f69 7a6c 6576 656c 203d 206d 6174   noizlevel = mat
-00061f10: 682e 6e61 6e0a 2020 2020 2020 2020 2020  h.nan.          
-00061f20: 2020 0a20 2020 2020 2020 206d 7269 7365    .        mrise
-00061f30: 7269 6573 3d4e 6f6e 650a 2020 2020 2020  ries=None.      
-00061f40: 2020 6d72 696d 6667 3d4e 6f6e 650a 2020    mrimfg=None.  
-00061f50: 2020 2020 2020 6d72 696d 6f64 656c 3d4e        mrimodel=N
-00061f60: 6f6e 650a 2020 2020 2020 2020 6d72 6953  one.        mriS
-00061f70: 4152 3d4e 6f6e 650a 2020 2020 2020 2020  AR=None.        
-00061f80: 4261 6e64 7769 6474 6850 6572 5069 7865  BandwidthPerPixe
-00061f90: 6c50 6861 7365 456e 636f 6465 3d4e 6f6e  lPhaseEncode=Non
-00061fa0: 650a 2020 2020 2020 2020 5069 7865 6c42  e.        PixelB
-00061fb0: 616e 6477 6964 7468 3d4e 6f6e 650a 2020  andwidth=None.  
-00061fc0: 2020 2020 2020 6966 206d 796d 6574 6120        if mymeta 
-00061fd0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00061fe0: 2020 2020 2020 2020 2023 206d 7269 7365           # mrise
-00061ff0: 7269 6573 3d6d 796d 6574 615b 2727 5d0a  ries=mymeta[''].
-00062000: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00062010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00062020: 206d 7269 6d66 673d 6d79 6d65 7461 5b27   mrimfg=mymeta['
-00062030: 4d61 6e75 6661 6374 7572 6572 275d 0a20  Manufacturer']. 
-00062040: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00062050: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00062060: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
-00062070: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00062080: 2020 2020 2020 2020 206d 7269 6d6f 6465           mrimode
-00062090: 6c3d 6d79 6d65 7461 5b27 4d61 6e75 6661  l=mymeta['Manufa
-000620a0: 6374 7572 6572 734d 6f64 656c 4e61 6d65  cturersModelName
-000620b0: 275d 0a20 2020 2020 2020 2020 2020 2065  '].            e
-000620c0: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
-000620d0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-000620e0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-000620f0: 2020 2020 2020 2020 2020 2020 204d 6167               Mag
-00062100: 6e65 7469 6346 6965 6c64 5374 7265 6e67  neticFieldStreng
-00062110: 7468 3d6d 796d 6574 615b 274d 6167 6e65  th=mymeta['Magne
-00062120: 7469 6346 6965 6c64 5374 7265 6e67 7468  ticFieldStrength
-00062130: 275d 0a20 2020 2020 2020 2020 2020 2065  '].            e
-00062140: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
-00062150: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-00062160: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00062170: 2020 2020 2020 2020 2020 2020 2050 6978               Pix
-00062180: 656c 4261 6e64 7769 6474 683d 6d79 6d65  elBandwidth=myme
-00062190: 7461 5b27 5069 7865 6c42 616e 6477 6964  ta['PixelBandwid
-000621a0: 7468 275d 0a20 2020 2020 2020 2020 2020  th'].           
-000621b0: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
-000621c0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
-000621d0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-000621e0: 2020 2020 2020 2020 2020 2020 2020 2042                 B
-000621f0: 616e 6477 6964 7468 5065 7250 6978 656c  andwidthPerPixel
-00062200: 5068 6173 6545 6e63 6f64 653d 6d79 6d65  PhaseEncode=myme
-00062210: 7461 5b27 4261 6e64 7769 6474 6850 6572  ta['BandwidthPer
-00062220: 5069 7865 6c50 6861 7365 456e 636f 6465  PixelPhaseEncode
-00062230: 275d 0a20 2020 2020 2020 2020 2020 2065  '].            e
-00062240: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
-00062250: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-00062260: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00062270: 2020 2020 2020 2020 2020 2020 206d 7269               mri
-00062280: 5341 523d 6d79 6d65 7461 5b27 5341 5227  SAR=mymeta['SAR'
-00062290: 5d0a 2020 2020 2020 2020 2020 2020 6578  ].            ex
-000622a0: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
-000622b0: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
-000622c0: 2020 2074 746c 3d6d 7973 7465 6d20 2b20     ttl=mystem + 
-000622d0: 2720 270a 2020 2020 2020 2020 7474 6c3d  ' '.        ttl=
-000622e0: 2727 0a20 2020 2020 2020 2074 746c 3d74  ''.        ttl=t
-000622f0: 746c 202b 2022 4e5a 3a20 2220 2b20 227b  tl + "NZ: " + "{
-00062300: 3a30 2e34 667d 222e 666f 726d 6174 286e  :0.4f}".format(n
-00062310: 6f69 7a6c 6576 656c 2920 2b20 2220 534e  oizlevel) + " SN
-00062320: 523a 2022 202b 2022 7b3a 302e 3466 7d22  R: " + "{:0.4f}"
-00062330: 2e66 6f72 6d61 7428 736e 7272 6566 2920  .format(snrref) 
-00062340: 2b20 2220 434e 523a 2022 202b 2022 7b3a  + " CNR: " + "{:
-00062350: 302e 3466 7d22 2e66 6f72 6d61 7428 636e  0.4f}".format(cn
-00062360: 7272 6566 2920 2b20 2220 5053 3a20 2220  rref) + " PS: " 
-00062370: 2b20 227b 3a30 2e34 667d 222e 666f 726d  + "{:0.4f}".form
-00062380: 6174 2870 736e 7272 6566 292b 2022 2053  at(psnrref)+ " S
-00062390: 533a 2022 202b 2022 7b3a 302e 3466 7d22  S: " + "{:0.4f}"
-000623a0: 2e66 6f72 6d61 7428 7373 696d 7265 6629  .format(ssimref)
-000623b0: 202b 2022 2045 5652 3a20 2220 2b20 227b   + " EVR: " + "{
-000623c0: 3a30 2e34 667d 222e 666f 726d 6174 286d  :0.4f}".format(m
-000623d0: 7965 7672 292b 2022 204d 493a 2022 202b  yevr)+ " MI: " +
-000623e0: 2022 7b3a 302e 3466 7d22 2e66 6f72 6d61   "{:0.4f}".forma
-000623f0: 7428 6d79 6d69 290a 2020 2020 2020 2020  t(mymi).        
-00062400: 6966 2076 697a 5f66 696c 656e 616d 6520  if viz_filename 
-00062410: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
-00062420: 2820 6a6a 6a20 3d3d 2030 206f 7220 286a  ( jjj == 0 or (j
-00062430: 6a6a 2025 2033 3020 3d3d 2030 2920 2920  jj % 30 == 0) ) 
-00062440: 616e 6420 696d 6167 652e 7368 6170 655b  and image.shape[
-00062450: 325d 203c 2036 3835 3a0a 2020 2020 2020  2] < 685:.      
-00062460: 2020 2020 2020 7669 7a5f 6669 6c65 6e61        viz_filena
-00062470: 6d65 5f75 7365 203d 2072 652e 7375 6228  me_use = re.sub(
-00062480: 2022 2e70 6e67 222c 2022 5f73 6c69 6365   ".png", "_slice
-00062490: 222b 7374 7228 6a6a 6a29 2e7a 6669 6c6c  "+str(jjj).zfill
-000624a0: 2834 292b 222e 706e 6722 2c20 7669 7a5f  (4)+".png", viz_
-000624b0: 6669 6c65 6e61 6d65 2029 0a20 2020 2020  filename ).     
-000624c0: 2020 2020 2020 2061 6e74 732e 706c 6f74         ants.plot
-000624d0: 5f6f 7274 686f 2820 696d 6167 652c 2063  _ortho( image, c
-000624e0: 726f 703d 4661 6c73 652c 2066 696c 656e  rop=False, filen
-000624f0: 616d 653d 7669 7a5f 6669 6c65 6e61 6d65  ame=viz_filename
-00062500: 5f75 7365 2c20 666c 6174 3d54 7275 652c  _use, flat=True,
-00062510: 2078 797a 5f6c 696e 6573 3d46 616c 7365   xyz_lines=False
-00062520: 2c20 6f72 6965 6e74 5f6c 6162 656c 733d  , orient_labels=
-00062530: 4661 6c73 652c 2078 797a 5f70 6164 3d30  False, xyz_pad=0
-00062540: 2c20 2074 6974 6c65 3d74 746c 2c20 7469  ,  title=ttl, ti
-00062550: 746c 6566 6f6e 7473 697a 653d 3132 2c20  tlefontsize=12, 
-00062560: 7469 746c 655f 6479 3d2d 302e 3032 2c74  title_dy=-0.02,t
-00062570: 6578 7466 6f6e 7463 6f6c 6f72 3d27 7265  extfontcolor='re
-00062580: 6427 2029 0a20 2020 2020 2020 2064 6620  d' ).        df 
-00062590: 3d20 7064 2e44 6174 6146 7261 6d65 285b  = pd.DataFrame([
-000625a0: 5b20 0a20 2020 2020 2020 2020 2020 206d  [ .            m
-000625b0: 7973 7465 6d2c 200a 2020 2020 2020 2020  ystem, .        
-000625c0: 2020 2020 696d 6167 655f 7265 6665 7265      image_refere
-000625d0: 6e63 652e 6469 6d65 6e73 696f 6e2c 200a  nce.dimension, .
-000625e0: 2020 2020 2020 2020 2020 2020 6e6f 697a              noiz
-000625f0: 6c65 7665 6c2c 2073 6e72 7265 662c 2063  level, snrref, c
-00062600: 6e72 7265 662c 2070 736e 7272 6566 2c20  nrref, psnrref, 
-00062610: 7373 696d 7265 662c 206d 796d 692c 2061  ssimref, mymi, a
-00062620: 7379 6d5f 6572 722c 206d 7965 7672 2c20  sym_err, myevr, 
-00062630: 6d73 6b5f 766f 6c2c 200a 2020 2020 2020  msk_vol, .      
-00062640: 2020 2020 2020 7370 635b 305d 2c20 7370        spc[0], sp
-00062650: 635b 315d 2c20 7370 635b 325d 2c6f 7267  c[1], spc[2],org
-00062660: 5b30 5d2c 206f 7267 5b31 5d2c 206f 7267  [0], org[1], org
-00062670: 5b32 5d2c 200a 2020 2020 2020 2020 2020  [2], .          
-00062680: 2020 696d 6167 652e 7368 6170 655b 305d    image.shape[0]
-00062690: 2c20 696d 6167 652e 7368 6170 655b 315d  , image.shape[1]
-000626a0: 2c20 696d 6167 652e 7368 6170 655b 325d  , image.shape[2]
-000626b0: 2c20 6e74 696d 6570 6f69 6e74 732c 200a  , ntimepoints, .
-000626c0: 2020 2020 2020 2020 2020 2020 6a6a 6a2c              jjj,
-000626d0: 206d 6f64 616c 6974 792c 206d 7269 7365   modality, mrise
-000626e0: 7269 6573 2c20 6d72 696d 6667 2c20 6d72  ries, mrimfg, mr
-000626f0: 696d 6f64 656c 2c20 4d61 676e 6574 6963  imodel, Magnetic
-00062700: 4669 656c 6453 7472 656e 6774 682c 206d  FieldStrength, m
-00062710: 7269 5341 522c 2050 6978 656c 4261 6e64  riSAR, PixelBand
-00062720: 7769 6474 682c 2042 616e 6477 6964 7468  width, Bandwidth
-00062730: 5065 7250 6978 656c 5068 6173 6545 6e63  PerPixelPhaseEnc
-00062740: 6f64 652c 2062 7661 6c75 654d 6178 2c20  ode, bvalueMax, 
-00062750: 6276 6563 6e6f 726d 205d 5d2c 200a 2020  bvecnorm ]], .  
-00062760: 2020 2020 2020 2020 2020 636f 6c75 6d6e            column
-00062770: 733d 5b0a 2020 2020 2020 2020 2020 2020  s=[.            
-00062780: 2020 2020 2766 696c 656e 616d 6527 2c20      'filename', 
-00062790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000627a0: 2027 6469 6d65 6e73 696f 6e61 6c69 7479   'dimensionality
-000627b0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-000627c0: 2020 2027 6e6f 6973 6527 2c20 2773 6e72     'noise', 'snr
-000627d0: 272c 2027 636e 7227 2c20 2770 736e 7227  ', 'cnr', 'psnr'
-000627e0: 2c20 2773 7369 6d27 2c20 276d 6927 2c20  , 'ssim', 'mi', 
-000627f0: 2772 6566 6c65 6374 696f 6e5f 6572 7227  'reflection_err'
-00062800: 2c20 2745 5652 272c 2027 6d73 6b5f 766f  , 'EVR', 'msk_vo
-00062810: 6c27 2c20 2773 7063 3027 2c27 7370 6331  l', 'spc0','spc1
-00062820: 272c 2773 7063 3227 2c27 6f72 6730 272c  ','spc2','org0',
-00062830: 276f 7267 3127 2c27 6f72 6732 272c 2764  'org1','org2','d
-00062840: 696d 7827 2c27 6469 6d79 272c 2764 696d  imx','dimy','dim
-00062850: 7a27 2c27 6469 6d74 272c 2773 6c69 6365  z','dimt','slice
-00062860: 272c 276d 6f64 616c 6974 7927 2c20 276d  ','modality', 'm
-00062870: 7269 7365 7269 6573 272c 2027 6d72 696d  riseries', 'mrim
-00062880: 6667 272c 2027 6d72 696d 6f64 656c 272c  fg', 'mrimodel',
-00062890: 2027 6d72 694d 6167 6e65 7469 6346 6965   'mriMagneticFie
-000628a0: 6c64 5374 7265 6e67 7468 272c 2027 6d72  ldStrength', 'mr
-000628b0: 6953 4152 272c 2027 6d72 6950 6978 656c  iSAR', 'mriPixel
-000628c0: 4261 6e64 7769 6474 6827 2c20 276d 7269  Bandwidth', 'mri
-000628d0: 5069 7865 6c42 616e 6477 6964 7468 5045  PixelBandwidthPE
-000628e0: 272c 2027 6474 695f 6276 616c 7565 4d61  ', 'dti_bvalueMa
-000628f0: 7827 2c20 2764 7469 5f62 7665 636e 6f72  x', 'dti_bvecnor
-00062900: 6d27 205d 290a 2020 2020 2020 2020 6f75  m' ]).        ou
-00062910: 7464 6620 3d20 7064 2e63 6f6e 6361 7428  tdf = pd.concat(
-00062920: 205b 6f75 7464 662c 2064 6620 5d2c 2061   [outdf, df ], a
-00062930: 7869 733d 302c 2069 676e 6f72 655f 696e  xis=0, ignore_in
-00062940: 6465 783d 4661 6c73 6520 290a 2020 2020  dex=False ).    
-00062950: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
-00062960: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00062970: 7428 206f 7574 6466 2029 0a20 2020 2069  t( outdf ).    i
-00062980: 6620 7669 7a5f 6669 6c65 6e61 6d65 2069  f viz_filename i
-00062990: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-000629a0: 2020 2020 6373 7666 6e20 3d20 7265 2e73      csvfn = re.s
-000629b0: 7562 2820 2270 6e67 222c 2022 6373 7622  ub( "png", "csv"
-000629c0: 2c20 7669 7a5f 6669 6c65 6e61 6d65 2029  , viz_filename )
-000629d0: 0a20 2020 2020 2020 206f 7574 6466 2e74  .        outdf.t
-000629e0: 6f5f 6373 7628 2063 7376 666e 2029 0a20  o_csv( csvfn ). 
-000629f0: 2020 2072 6574 7572 6e20 6f75 7464 660a     return outdf.
-00062a00: 0a64 6566 2072 656d 6f76 655f 756e 7761  .def remove_unwa
-00062a10: 6e74 6564 5f63 6f6c 756d 6e73 2864 6629  nted_columns(df)
-00062a20: 3a0a 2020 2020 2320 4964 656e 7469 6679  :.    # Identify
-00062a30: 2063 6f6c 756d 6e73 2074 6f20 6472 6f70   columns to drop
-00062a40: 3a20 7468 6f73 6520 6e61 6d65 6420 2758  : those named 'X
-00062a50: 2720 6f72 2073 7461 7274 696e 6720 7769  ' or starting wi
-00062a60: 7468 2027 556e 6e61 6d65 6427 0a20 2020  th 'Unnamed'.   
-00062a70: 2063 6f6c 735f 746f 5f64 726f 7020 3d20   cols_to_drop = 
-00062a80: 5b63 6f6c 2066 6f72 2063 6f6c 2069 6e20  [col for col in 
-00062a90: 6466 2e63 6f6c 756d 6e73 2069 6620 636f  df.columns if co
-00062aa0: 6c20 3d3d 2027 5827 206f 7220 636f 6c2e  l == 'X' or col.
-00062ab0: 7374 6172 7473 7769 7468 2827 556e 6e61  startswith('Unna
-00062ac0: 6d65 6427 295d 0a20 2020 200a 2020 2020  med')].    .    
-00062ad0: 2320 4472 6f70 2074 6865 2069 6465 6e74  # Drop the ident
-00062ae0: 6966 6965 6420 636f 6c75 6d6e 7320 6672  ified columns fr
-00062af0: 6f6d 2074 6865 2044 6174 6146 7261 6d65  om the DataFrame
-00062b00: 2c20 6966 2061 6e79 0a20 2020 2064 665f  , if any.    df_
-00062b10: 636c 6561 6e65 6420 3d20 6466 2e64 726f  cleaned = df.dro
-00062b20: 7028 636f 6c75 6d6e 733d 636f 6c73 5f74  p(columns=cols_t
-00062b30: 6f5f 6472 6f70 2c20 6572 726f 7273 3d27  o_drop, errors='
-00062b40: 6967 6e6f 7265 2729 0a20 2020 200a 2020  ignore').    .  
-00062b50: 2020 7265 7475 726e 2064 665f 636c 6561    return df_clea
-00062b60: 6e65 640a 0a64 6566 2070 726f 6365 7373  ned..def process
-00062b70: 5f64 6174 6166 7261 6d65 5f67 656e 6572  _dataframe_gener
-00062b80: 616c 697a 6564 2864 662c 2067 726f 7570  alized(df, group
-00062b90: 5f62 795f 636f 6c75 6d6e 293a 0a20 2020  _by_column):.   
-00062ba0: 2023 204d 616b 6520 7375 7265 2074 6865   # Make sure the
-00062bb0: 2067 726f 7570 5f62 795f 636f 6c75 6d6e   group_by_column
-00062bc0: 2069 7320 6578 636c 7564 6564 2066 726f   is excluded fro
-00062bd0: 6d20 626f 7468 206e 756d 6572 6963 2061  m both numeric a
-00062be0: 6e64 206f 7468 6572 2063 6f6c 756d 6e73  nd other columns
-00062bf0: 2063 616c 6375 6c61 7469 6f6e 730a 2020   calculations.  
-00062c00: 2020 6e75 6d65 7269 635f 636f 6c73 203d    numeric_cols =
-00062c10: 2064 662e 7365 6c65 6374 5f64 7479 7065   df.select_dtype
-00062c20: 7328 696e 636c 7564 653d 276e 756d 6265  s(include='numbe
-00062c30: 7227 292e 636f 6c75 6d6e 732e 6469 6666  r').columns.diff
-00062c40: 6572 656e 6365 285b 6772 6f75 705f 6279  erence([group_by
-00062c50: 5f63 6f6c 756d 6e5d 290a 2020 2020 6f74  _column]).    ot
-00062c60: 6865 725f 636f 6c73 203d 2064 662e 636f  her_cols = df.co
-00062c70: 6c75 6d6e 732e 6469 6666 6572 656e 6365  lumns.difference
-00062c80: 286e 756d 6572 6963 5f63 6f6c 7329 2e64  (numeric_cols).d
-00062c90: 6966 6665 7265 6e63 6528 5b67 726f 7570  ifference([group
-00062ca0: 5f62 795f 636f 6c75 6d6e 5d29 0a20 2020  _by_column]).   
-00062cb0: 200a 2020 2020 2320 4465 6669 6e65 2061   .    # Define a
-00062cc0: 6767 7265 6761 7469 6f6e 2066 756e 6374  ggregation funct
-00062cd0: 696f 6e73 3a20 6d65 616e 2066 6f72 206e  ions: mean for n
-00062ce0: 756d 6572 6963 2063 6f6c 732c 206d 6f64  umeric cols, mod
-00062cf0: 6520 666f 7220 6f74 6865 7220 636f 6c73  e for other cols
-00062d00: 0a20 2020 2023 2055 7064 6174 6520 746f  .    # Update to
-00062d10: 2068 616e 646c 6520 656d 7074 7920 6d6f   handle empty mo
-00062d20: 6465 2072 6573 756c 7473 2073 6166 656c  de results safel
-00062d30: 790a 2020 2020 6167 675f 6469 6374 203d  y.    agg_dict =
-00062d40: 207b 636f 6c3a 2027 6d65 616e 2720 666f   {col: 'mean' fo
-00062d50: 7220 636f 6c20 696e 206e 756d 6572 6963  r col in numeric
-00062d60: 5f63 6f6c 737d 0a20 2020 2061 6767 5f64  _cols}.    agg_d
-00062d70: 6963 742e 7570 6461 7465 287b 0a20 2020  ict.update({.   
-00062d80: 2020 2020 2063 6f6c 3a20 6c61 6d62 6461       col: lambda
-00062d90: 2078 3a20 7064 2e53 6572 6965 732e 6d6f   x: pd.Series.mo
-00062da0: 6465 2878 292e 696c 6f63 5b30 5d20 6966  de(x).iloc[0] if
-00062db0: 206e 6f74 2070 642e 5365 7269 6573 2e6d   not pd.Series.m
-00062dc0: 6f64 6528 7829 2e65 6d70 7479 2065 6c73  ode(x).empty els
-00062dd0: 6520 4e6f 6e65 2066 6f72 2063 6f6c 2069  e None for col i
-00062de0: 6e20 6f74 6865 725f 636f 6c73 0a20 2020  n other_cols.   
-00062df0: 207d 2920 2020 200a 2020 2020 2320 4772   })    .    # Gr
-00062e00: 6f75 7020 6279 2074 6865 2073 7065 6369  oup by the speci
-00062e10: 6669 6564 2063 6f6c 756d 6e2c 2061 7070  fied column, app
-00062e20: 6c79 696e 6720 6469 6666 6572 656e 7420  lying different 
-00062e30: 6167 6772 6567 6174 696f 6e20 6675 6e63  aggregation func
-00062e40: 7469 6f6e 7320 746f 2064 6966 6665 7265  tions to differe
-00062e50: 6e74 2063 6f6c 756d 6e73 0a20 2020 2070  nt columns.    p
-00062e60: 726f 6365 7373 6564 5f64 6620 3d20 6466  rocessed_df = df
-00062e70: 2e67 726f 7570 6279 2867 726f 7570 5f62  .groupby(group_b
-00062e80: 795f 636f 6c75 6d6e 2c20 6173 5f69 6e64  y_column, as_ind
-00062e90: 6578 3d46 616c 7365 292e 6167 6728 6167  ex=False).agg(ag
-00062ea0: 675f 6469 6374 290a 2020 2020 7265 7475  g_dict).    retu
-00062eb0: 726e 2070 726f 6365 7373 6564 5f64 660a  rn processed_df.
-00062ec0: 0a64 6566 2061 7665 7261 6765 5f62 6c69  .def average_bli
-00062ed0: 6e64 5f71 635f 6279 5f6d 6f64 616c 6974  nd_qc_by_modalit
-00062ee0: 7928 7163 5f66 756c 6c2c 7665 7262 6f73  y(qc_full,verbos
-00062ef0: 653d 4661 6c73 6529 3a0a 2020 2020 2222  e=False):.    ""
-00062f00: 220a 2020 2020 4176 6572 6167 6573 2074  ".    Averages t
-00062f10: 696d 6520 7365 7269 6573 2071 6320 7265  ime series qc re
-00062f20: 7375 6c74 7320 746f 2079 6965 6c64 206f  sults to yield o
-00062f30: 6e65 2065 6e74 7279 2070 6572 2069 6d61  ne entry per ima
-00062f40: 6765 2e20 7468 6973 2061 6c73 6f20 6669  ge. this also fi
-00062f50: 6c74 6572 7320 746f 2022 6b6e 6f77 6e22  lters to "known"
-00062f60: 2063 6f6c 756d 6e73 2e0a 0a20 2020 2041   columns...    A
-00062f70: 7267 733a 0a20 2020 2071 635f 6675 6c6c  rgs:.    qc_full
-00062f80: 3a20 7061 6e64 6173 2064 6174 6166 7261  : pandas datafra
-00062f90: 6d65 2063 6f6e 7461 696e 696e 6720 7468  me containing th
-00062fa0: 6520 6675 6c6c 2071 6320 6461 7461 2e0a  e full qc data..
-00062fb0: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-00062fc0: 2020 7061 6e64 6173 2064 6174 6166 7261    pandas datafra
-00062fd0: 6d65 2063 6f6e 7461 696e 696e 6720 7468  me containing th
-00062fe0: 6520 7072 6f63 6573 7365 6420 7163 2064  e processed qc d
-00062ff0: 6174 612e 0a20 2020 2022 2222 0a20 2020  ata..    """.   
-00063000: 2071 635f 6675 6c6c 203d 2072 656d 6f76   qc_full = remov
-00063010: 655f 756e 7761 6e74 6564 5f63 6f6c 756d  e_unwanted_colum
-00063020: 6e73 2820 7163 5f66 756c 6c20 290a 2020  ns( qc_full ).  
-00063030: 2020 2320 4765 7420 756e 6971 7565 206d    # Get unique m
-00063040: 6f64 616c 6974 6965 730a 2020 2020 6d6f  odalities.    mo
-00063050: 6461 6c69 7469 6573 203d 2071 635f 6675  dalities = qc_fu
-00063060: 6c6c 5b27 6d6f 6461 6c69 7479 275d 2e75  ll['modality'].u
-00063070: 6e69 7175 6528 290a 2020 2020 6d6f 6461  nique().    moda
-00063080: 6c69 7469 6573 203d 206d 6f64 616c 6974  lities = modalit
-00063090: 6965 735b 6d6f 6461 6c69 7469 6573 2021  ies[modalities !
-000630a0: 3d20 2775 6e6b 6e6f 776e 275d 0a20 2020  = 'unknown'].   
-000630b0: 2023 2047 6574 2075 6e69 7175 6520 6964   # Get unique id
-000630c0: 730a 2020 2020 7569 6420 3d20 7163 5f66  s.    uid = qc_f
-000630d0: 756c 6c5b 2766 696c 656e 616d 6527 5d0a  ull['filename'].
-000630e0: 2020 2020 746f 5f61 7665 7261 6765 203d      to_average =
-000630f0: 2075 6964 2e75 6e69 7175 6528 290a 2020   uid.unique().  
-00063100: 2020 6d65 7461 203d 2070 642e 4461 7461    meta = pd.Data
-00063110: 4672 616d 6528 636f 6c75 6d6e 733d 7163  Frame(columns=qc
-00063120: 5f66 756c 6c2e 636f 6c75 6d6e 7320 290a  _full.columns ).
-00063130: 2020 2020 2320 5072 6f63 6573 7320 6561      # Process ea
-00063140: 6368 2075 6e69 7175 6520 6964 0a20 2020  ch unique id.   
-00063150: 206e 203d 206c 656e 2874 6f5f 6176 6572   n = len(to_aver
-00063160: 6167 6529 0a20 2020 2066 6f72 206b 2069  age).    for k i
-00063170: 6e20 7261 6e67 6528 6e29 3a0a 2020 2020  n range(n):.    
-00063180: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
-00063190: 2020 2020 2020 2020 2020 2020 6966 206b              if k
-000631a0: 2025 2031 3030 203d 3d20 303a 0a20 2020   % 100 == 0:.   
-000631b0: 2020 2020 2020 2020 2020 2020 2070 726f               pro
-000631c0: 6767 6572 203d 2073 7472 2820 6e70 2e72  gger = str( np.r
-000631d0: 6f75 6e64 2820 6b20 2f20 6e20 2a20 3130  ound( k / n * 10
-000631e0: 3020 2920 290a 2020 2020 2020 2020 2020  0 ) ).          
-000631f0: 2020 2020 2020 7072 696e 7428 2070 726f        print( pro
-00063200: 6767 6572 2c20 656e 6420 3d22 2e2e 2e22  gger, end ="..."
-00063210: 2c20 666c 7573 683d 5472 7565 290a 2020  , flush=True).  
-00063220: 2020 2020 2020 6d31 7365 6c20 3d20 7569        m1sel = ui
-00063230: 6420 3d3d 2074 6f5f 6176 6572 6167 655b  d == to_average[
-00063240: 6b5d 0a20 2020 2020 2020 2069 6620 7375  k].        if su
-00063250: 6d28 6d31 7365 6c29 203e 2031 3a0a 2020  m(m1sel) > 1:.  
-00063260: 2020 2020 2020 2020 2020 2320 4966 206d            # If m
-00063270: 6f72 6520 7468 616e 206f 6e65 2065 6e74  ore than one ent
-00063280: 7279 2066 6f72 2069 642c 2074 616b 6520  ry for id, take 
-00063290: 7468 6520 6176 6572 6167 6520 6f66 2063  the average of c
-000632a0: 6f6e 7469 6e75 6f75 7320 636f 6c75 6d6e  ontinuous column
-000632b0: 732c 0a20 2020 2020 2020 2020 2020 2023  s,.            #
-000632c0: 206d 6178 696d 756d 206f 6620 7468 6520   maximum of the 
-000632d0: 736c 6963 6520 636f 6c75 6d6e 2c20 616e  slice column, an
-000632e0: 6420 7468 6520 6669 7273 7420 656e 7472  d the first entr
-000632f0: 7920 6f66 2074 6865 206f 7468 6572 2063  y of the other c
-00063300: 6f6c 756d 6e73 0a20 2020 2020 2020 2020  olumns.         
-00063310: 2020 206d 6673 7562 203d 2070 726f 6365     mfsub = proce
-00063320: 7373 5f64 6174 6166 7261 6d65 5f67 656e  ss_dataframe_gen
-00063330: 6572 616c 697a 6564 2871 635f 6675 6c6c  eralized(qc_full
-00063340: 5b6d 3173 656c 5d2c 2766 696c 656e 616d  [m1sel],'filenam
-00063350: 6527 290a 2020 2020 2020 2020 656c 7365  e').        else
-00063360: 3a0a 2020 2020 2020 2020 2020 2020 6d66  :.            mf
-00063370: 7375 6220 3d20 7163 5f66 756c 6c5b 6d31  sub = qc_full[m1
-00063380: 7365 6c5d 0a20 2020 2020 2020 206d 6574  sel].        met
-00063390: 612e 6c6f 635b 6b5d 203d 206d 6673 7562  a.loc[k] = mfsub
-000633a0: 2e69 6c6f 635b 305d 0a20 2020 206d 6574  .iloc[0].    met
-000633b0: 615b 276d 6f64 616c 6974 7927 5d20 3d20  a['modality'] = 
-000633c0: 6d65 7461 5b27 6d6f 6461 6c69 7479 275d  meta['modality']
-000633d0: 2e72 6570 6c61 6365 285b 2744 5449 6477  .replace(['DTIdw
-000633e0: 6927 2c20 2744 5449 6230 275d 2c20 2744  i', 'DTIb0'], 'D
-000633f0: 5449 272c 2072 6567 6578 3d54 7275 6529  TI', regex=True)
-00063400: 0a20 2020 2072 6574 7572 6e20 6d65 7461  .    return meta
-00063410: 0a0a 6465 6620 776d 6828 2066 6c61 6972  ..def wmh( flair
-00063420: 2c20 7431 2c20 7431 7365 672c 0a20 2020  , t1, t1seg,.   
-00063430: 206d 6d66 726f 6d63 6f6e 7665 7868 756c   mmfromconvexhul
-00063440: 6c20 3d20 332e 302c 0a20 2020 2073 7472  l = 3.0,.    str
-00063450: 6963 743d 5472 7565 2c0a 2020 2020 7072  ict=True,.    pr
-00063460: 6f62 6162 696c 6974 795f 6d61 736b 3d4e  obability_mask=N
-00063470: 6f6e 652c 0a20 2020 2070 7269 6f72 5f70  one,.    prior_p
-00063480: 726f 6261 6269 6c69 7479 3d4e 6f6e 652c  robability=None,
-00063490: 0a20 2020 206d 6f64 656c 3d27 7379 7375  .    model='sysu
-000634a0: 272c 0a20 2020 2076 6572 626f 7365 3d46  ',.    verbose=F
-000634b0: 616c 7365 2029 203a 0a20 2020 2022 2222  alse ) :.    """
-000634c0: 0a20 2020 204f 7574 7075 7473 2074 6865  .    Outputs the
-000634d0: 2057 4d48 2070 726f 6261 6269 6c69 7479   WMH probability
-000634e0: 206d 6173 6b20 616e 6420 6120 7375 6d6d   mask and a summ
-000634f0: 6172 7920 7369 6e67 6c65 206d 6561 7375  ary single measu
-00063500: 7265 6d65 6e74 0a0a 2020 2020 4172 6775  rement..    Argu
-00063510: 6d65 6e74 730a 2020 2020 2d2d 2d2d 2d2d  ments.    ------
-00063520: 2d2d 2d0a 2020 2020 666c 6169 7220 3a20  ---.    flair : 
-00063530: 414e 5473 496d 6167 650a 2020 2020 2020  ANTsImage.      
-00063540: 2020 696e 7075 7420 332d 4420 464c 4149    input 3-D FLAI
-00063550: 5220 6272 6169 6e20 696d 6167 6520 286e  R brain image (n
-00063560: 6f74 2073 6b75 6c6c 2d73 7472 6970 7065  ot skull-strippe
-00063570: 6429 2e0a 0a20 2020 2074 3120 3a20 414e  d)...    t1 : AN
-00063580: 5473 496d 6167 650a 2020 2020 2020 2020  TsImage.        
-00063590: 696e 7075 7420 332d 4420 5431 2062 7261  input 3-D T1 bra
-000635a0: 696e 2069 6d61 6765 2028 6e6f 7420 736b  in image (not sk
-000635b0: 756c 6c2d 7374 7269 7070 6564 292e 0a0a  ull-stripped)...
-000635c0: 2020 2020 7431 7365 6720 3a20 414e 5473      t1seg : ANTs
-000635d0: 496d 6167 650a 2020 2020 2020 2020 5431  Image.        T1
-000635e0: 2073 6567 6d65 6e74 6174 696f 6e20 696d   segmentation im
-000635f0: 6167 650a 0a20 2020 206d 6d66 726f 6d63  age..    mmfromc
-00063600: 6f6e 7665 7868 756c 6c20 3a20 666c 6f61  onvexhull : floa
-00063610: 740a 2020 2020 2020 2020 7265 7374 7269  t.        restri
-00063620: 6374 2057 4d48 2074 6f20 7265 6769 6f6e  ct WMH to region
-00063630: 7320 7468 6174 2061 7265 2057 4d20 6f72  s that are WM or
-00063640: 206d 6d66 726f 6d63 6f6e 7665 7868 756c   mmfromconvexhul
-00063650: 6c20 6d6d 2061 7761 7920 6672 6f6d 2074  l mm away from t
-00063660: 6865 0a20 2020 2020 2020 2063 6f6e 7665  he.        conve
-00063670: 7820 6875 6c6c 206f 6620 7468 6520 6365  x hull of the ce
-00063680: 7265 6272 756d 2e20 2020 7765 2063 686f  rebrum.   we cho
-00063690: 6f73 6520 6120 6465 6661 756c 7420 7661  ose a default va
-000636a0: 6c75 6520 6261 7365 6420 6f6e 0a20 2020  lue based on.   
-000636b0: 2020 2020 2046 6967 7572 6520 3420 6672       Figure 4 fr
-000636c0: 6f6d 3a0a 2020 2020 2020 2020 6874 7470  om:.        http
-000636d0: 733a 2f2f 7777 772e 6e63 6269 2e6e 6c6d  s://www.ncbi.nlm
-000636e0: 2e6e 6968 2e67 6f76 2f70 6d63 2f61 7274  .nih.gov/pmc/art
-000636f0: 6963 6c65 732f 504d 4336 3234 3035 3739  icles/PMC6240579
-00063700: 2f70 6466 2f66 6e61 6769 2d31 302d 3030  /pdf/fnagi-10-00
-00063710: 3333 392e 7064 660a 0a20 2020 2073 7472  339.pdf..    str
-00063720: 6963 743a 2062 6f6f 6c65 616e 202d 2069  ict: boolean - i
-00063730: 6620 5472 7565 2c20 6f6e 6c79 2075 7365  f True, only use
-00063740: 2063 6f6e 7665 7820 6875 6c6c 2064 6973   convex hull dis
-00063750: 7461 6e63 650a 0a20 2020 2070 726f 6261  tance..    proba
-00063760: 6269 6c69 7479 5f6d 6173 6b20 3a20 4e6f  bility_mask : No
-00063770: 6e65 202d 2075 7365 2074 6f20 636f 6d70  ne - use to comp
-00063780: 7574 6520 776d 6820 6a75 7374 206f 6e63  ute wmh just onc
-00063790: 6520 2d20 7468 656e 2074 6869 7320 6675  e - then this fu
-000637a0: 6e63 7469 6f6e 0a20 2020 2020 2020 206a  nction.        j
-000637b0: 7573 7420 646f 6573 2072 6566 696e 656d  ust does refinem
-000637c0: 656e 7420 616e 6420 7375 6d6d 6172 790a  ent and summary.
-000637d0: 0a20 2020 2070 7269 6f72 5f70 726f 6261  .    prior_proba
-000637e0: 6269 6c69 7479 203a 206f 7074 696f 6e61  bility : optiona
-000637f0: 6c20 7072 696f 7220 7072 6f62 6162 696c  l prior probabil
-00063800: 6974 7920 696d 6167 6520 696e 2073 7061  ity image in spa
-00063810: 6365 206f 6620 7468 6520 696e 7075 7420  ce of the input 
-00063820: 7431 0a0a 2020 2020 6d6f 6465 6c20 3a20  t1..    model : 
-00063830: 6569 7468 6572 2073 7973 7520 6f72 2068  either sysu or h
-00063840: 7970 6572 0a0a 2020 2020 7665 7262 6f73  yper..    verbos
-00063850: 6520 3a20 626f 6f6c 6561 6e0a 0a20 2020  e : boolean..   
-00063860: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
-00063870: 2d2d 2d2d 2d2d 0a20 2020 2057 4d48 2070  ------.    WMH p
-00063880: 726f 6261 6269 6c69 7479 206d 6170 2061  robability map a
-00063890: 6e64 2061 2073 756d 6d61 7279 2073 696e  nd a summary sin
-000638a0: 676c 6520 6d65 6173 7572 656d 656e 7420  gle measurement 
-000638b0: 7768 6963 6820 6973 2074 6865 2073 756d  which is the sum
-000638c0: 206f 6620 7468 6520 574d 4820 6d61 700a   of the WMH map.
-000638d0: 0a20 2020 2022 2222 0a20 2020 2069 6d70  .    """.    imp
-000638e0: 6f72 7420 6e75 6d70 7920 6173 206e 700a  ort numpy as np.
-000638f0: 2020 2020 696d 706f 7274 206d 6174 680a      import math.
-00063900: 2020 2020 7431 5f32 5f66 6c61 6972 5f72      t1_2_flair_r
-00063910: 6567 203d 2061 6e74 732e 7265 6769 7374  eg = ants.regist
-00063920: 7261 7469 6f6e 2866 6c61 6972 2c20 7431  ration(flair, t1
-00063930: 2c20 7479 7065 5f6f 665f 7472 616e 7366  , type_of_transf
-00063940: 6f72 6d20 3d20 2752 6967 6964 2729 2023  orm = 'Rigid') #
-00063950: 2052 6567 6973 7465 7220 5431 2074 6f20   Register T1 to 
-00063960: 466c 6169 720a 2020 2020 6966 2070 726f  Flair.    if pro
-00063970: 6261 6269 6c69 7479 5f6d 6173 6b20 6973  bability_mask is
-00063980: 204e 6f6e 6520 616e 6420 6d6f 6465 6c20   None and model 
-00063990: 3d3d 2027 7379 7375 273a 0a20 2020 2020  == 'sysu':.     
-000639a0: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
-000639b0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-000639c0: 2827 7379 7375 2729 0a20 2020 2020 2020  ('sysu').       
-000639d0: 2070 726f 6261 6269 6c69 7479 5f6d 6173   probability_mas
-000639e0: 6b20 3d20 616e 7473 7079 6e65 742e 7379  k = antspynet.sy
-000639f0: 7375 5f6d 6564 6961 5f77 6d68 5f73 6567  su_media_wmh_seg
-00063a00: 6d65 6e74 6174 696f 6e28 2066 6c61 6972  mentation( flair
-00063a10: 2029 0a20 2020 2065 6c69 6620 7072 6f62   ).    elif prob
-00063a20: 6162 696c 6974 795f 6d61 736b 2069 7320  ability_mask is 
-00063a30: 4e6f 6e65 2061 6e64 206d 6f64 656c 203d  None and model =
-00063a40: 3d20 2768 7970 6572 273a 0a20 2020 2020  = 'hyper':.     
-00063a50: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
-00063a60: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00063a70: 2827 6879 7065 7227 290a 2020 2020 2020  ('hyper').      
-00063a80: 2020 7072 6f62 6162 696c 6974 795f 6d61    probability_ma
-00063a90: 736b 203d 2061 6e74 7370 796e 6574 2e68  sk = antspynet.h
-00063aa0: 7970 6572 6d61 7070 3372 5f73 6567 6d65  ypermapp3r_segme
-00063ab0: 6e74 6174 696f 6e28 2074 315f 325f 666c  ntation( t1_2_fl
-00063ac0: 6169 725f 7265 675b 2777 6172 7065 646d  air_reg['warpedm
-00063ad0: 6f76 6f75 7427 5d2c 2066 6c61 6972 2029  ovout'], flair )
-00063ae0: 0a20 2020 2023 2074 315f 325f 666c 6169  .    # t1_2_flai
-00063af0: 725f 7265 6720 3d20 7472 615f 696e 6974  r_reg = tra_init
-00063b00: 6961 6c69 7a65 7228 2066 6c61 6972 2c20  ializer( flair, 
-00063b10: 7431 2c20 6e5f 7369 6d75 6c61 7469 6f6e  t1, n_simulation
-00063b20: 733d 342c 206d 6178 5f72 6f74 6174 696f  s=4, max_rotatio
-00063b30: 6e3d 352c 2074 7261 6e73 666f 726d 3d5b  n=5, transform=[
-00063b40: 2772 6967 6964 275d 2c20 7665 7262 6f73  'rigid'], verbos
-00063b50: 653d 4661 6c73 6520 290a 2020 2020 7072  e=False ).    pr
-00063b60: 696f 725f 7072 6f62 6162 696c 6974 795f  ior_probability_
-00063b70: 666c 6169 7220 3d20 4e6f 6e65 0a20 2020  flair = None.   
-00063b80: 2069 6620 7072 696f 725f 7072 6f62 6162   if prior_probab
-00063b90: 696c 6974 7920 6973 206e 6f74 204e 6f6e  ility is not Non
-00063ba0: 653a 0a20 2020 2020 2020 2070 7269 6f72  e:.        prior
-00063bb0: 5f70 726f 6261 6269 6c69 7479 5f66 6c61  _probability_fla
-00063bc0: 6972 203d 2061 6e74 732e 6170 706c 795f  ir = ants.apply_
-00063bd0: 7472 616e 7366 6f72 6d73 2820 666c 6169  transforms( flai
-00063be0: 722c 2070 7269 6f72 5f70 726f 6261 6269  r, prior_probabi
-00063bf0: 6c69 7479 2c0a 2020 2020 2020 2020 2020  lity,.          
-00063c00: 2020 7431 5f32 5f66 6c61 6972 5f72 6567    t1_2_flair_reg
-00063c10: 5b27 6677 6474 7261 6e73 666f 726d 7327  ['fwdtransforms'
-00063c20: 5d20 290a 2020 2020 776d 7365 675f 6d61  ] ).    wmseg_ma
-00063c30: 736b 203d 2061 6e74 732e 7468 7265 7368  sk = ants.thresh
-00063c40: 6f6c 645f 696d 6167 6528 2074 3173 6567  old_image( t1seg
-00063c50: 2c0a 2020 2020 2020 2020 6c6f 775f 7468  ,.        low_th
-00063c60: 7265 7368 203d 2033 2c20 6869 6768 5f74  resh = 3, high_t
-00063c70: 6872 6573 6820 3d20 3329 2e69 4d61 7468  hresh = 3).iMath
-00063c80: 2822 4669 6c6c 486f 6c65 7322 290a 2020  ("FillHoles").  
-00063c90: 2020 776d 7365 675f 6d61 736b 5f75 7365    wmseg_mask_use
-00063ca0: 203d 2061 6e74 732e 696d 6167 655f 636c   = ants.image_cl
-00063cb0: 6f6e 6528 2077 6d73 6567 5f6d 6173 6b20  one( wmseg_mask 
-00063cc0: 290a 2020 2020 6469 7374 6d61 736b 203d  ).    distmask =
-00063cd0: 204e 6f6e 650a 2020 2020 6966 206d 6d66   None.    if mmf
-00063ce0: 726f 6d63 6f6e 7665 7868 756c 6c20 3e20  romconvexhull > 
-00063cf0: 303a 0a20 2020 2020 2020 2020 2020 2063  0:.            c
-00063d00: 6f6e 7665 7868 756c 6c20 3d20 616e 7473  onvexhull = ants
-00063d10: 2e74 6872 6573 686f 6c64 5f69 6d61 6765  .threshold_image
-00063d20: 2820 7431 7365 672c 2031 2c20 3420 290a  ( t1seg, 1, 4 ).
-00063d30: 2020 2020 2020 2020 2020 2020 7370 6332              spc2
-00063d40: 766f 7820 3d20 6e70 2e70 726f 6428 2061  vox = np.prod( a
-00063d50: 6e74 732e 6765 745f 7370 6163 696e 6728  nts.get_spacing(
-00063d60: 2074 3173 6567 2029 2029 0a20 2020 2020   t1seg ) ).     
-00063d70: 2020 2020 2020 2076 6f78 6469 7374 203d         voxdist =
-00063d80: 2030 2e30 0a20 2020 2020 2020 2020 2020   0.0.           
-00063d90: 206d 7973 7063 203d 2061 6e74 732e 6765   myspc = ants.ge
-00063da0: 745f 7370 6163 696e 6728 2074 3173 6567  t_spacing( t1seg
-00063db0: 2029 0a20 2020 2020 2020 2020 2020 2066   ).            f
-00063dc0: 6f72 206b 2069 6e20 7261 6e67 6528 2074  or k in range( t
-00063dd0: 3173 6567 2e64 696d 656e 7369 6f6e 2029  1seg.dimension )
-00063de0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00063df0: 2020 766f 7864 6973 7420 3d20 766f 7864    voxdist = voxd
-00063e00: 6973 7420 2b20 6d79 7370 635b 6b5d 202a  ist + myspc[k] *
-00063e10: 206d 7973 7063 5b6b 5d0a 2020 2020 2020   myspc[k].      
-00063e20: 2020 2020 2020 766f 7864 6973 7420 3d20        voxdist = 
-00063e30: 6d61 7468 2e73 7172 7428 2076 6f78 6469  math.sqrt( voxdi
-00063e40: 7374 2029 0a20 2020 2020 2020 2020 2020  st ).           
-00063e50: 206e 6d6f 7270 6820 3d20 726f 756e 6428   nmorph = round(
-00063e60: 2032 2e30 202f 2076 6f78 6469 7374 2029   2.0 / voxdist )
-00063e70: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00063e80: 7665 7868 756c 6c20 3d20 616e 7473 2e6d  vexhull = ants.m
-00063e90: 6f72 7068 6f6c 6f67 7928 2063 6f6e 7665  orphology( conve
-00063ea0: 7868 756c 6c2c 2022 636c 6f73 6522 2c20  xhull, "close", 
-00063eb0: 6e6d 6f72 7068 2029 2e69 4d61 7468 2822  nmorph ).iMath("
-00063ec0: 4669 6c6c 486f 6c65 7322 290a 2020 2020  FillHoles").    
-00063ed0: 2020 2020 2020 2020 6469 7374 203d 2061          dist = a
-00063ee0: 6e74 732e 694d 6174 6828 2063 6f6e 7665  nts.iMath( conve
-00063ef0: 7868 756c 6c2c 2022 4d61 7572 6572 4469  xhull, "MaurerDi
-00063f00: 7374 616e 6365 2220 2920 2a20 2d31 2e30  stance" ) * -1.0
-00063f10: 0a20 2020 2020 2020 2020 2020 2064 6973  .            dis
-00063f20: 746d 6173 6b20 3d20 616e 7473 2e74 6872  tmask = ants.thr
-00063f30: 6573 686f 6c64 5f69 6d61 6765 2820 6469  eshold_image( di
-00063f40: 7374 2c20 6d6d 6672 6f6d 636f 6e76 6578  st, mmfromconvex
-00063f50: 6875 6c6c 2c20 312e 6538 3020 290a 2020  hull, 1.e80 ).  
-00063f60: 2020 2020 2020 2020 2020 776d 7365 675f            wmseg_
-00063f70: 6d61 736b 203d 2077 6d73 6567 5f6d 6173  mask = wmseg_mas
-00063f80: 6b20 2b20 6469 7374 6d61 736b 0a20 2020  k + distmask.   
-00063f90: 2020 2020 2020 2020 2069 6620 7374 7269           if stri
-00063fa0: 6374 3a0a 2020 2020 2020 2020 2020 2020  ct:.            
-00063fb0: 2020 2020 776d 7365 675f 6d61 736b 5f75      wmseg_mask_u
-00063fc0: 7365 203d 2061 6e74 732e 7468 7265 7368  se = ants.thresh
-00063fd0: 6f6c 645f 696d 6167 6528 2077 6d73 6567  old_image( wmseg
-00063fe0: 5f6d 6173 6b2c 2032 2c20 3220 290a 2020  _mask, 2, 2 ).  
-00063ff0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00064000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00064010: 776d 7365 675f 6d61 736b 5f75 7365 203d  wmseg_mask_use =
-00064020: 2061 6e74 732e 7468 7265 7368 6f6c 645f   ants.threshold_
-00064030: 696d 6167 6528 2077 6d73 6567 5f6d 6173  image( wmseg_mas
-00064040: 6b2c 2031 2c20 3220 290a 2020 2020 2323  k, 1, 2 ).    ##
-00064050: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00064060: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00064070: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00064080: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00064090: 2323 2323 2323 2323 2323 2323 0a20 2020  ############.   
-000640a0: 2077 6d73 6567 5f32 5f66 6c61 6972 203d   wmseg_2_flair =
-000640b0: 2061 6e74 732e 6170 706c 795f 7472 616e   ants.apply_tran
-000640c0: 7366 6f72 6d73 2866 6c61 6972 2c20 776d  sforms(flair, wm
-000640d0: 7365 675f 6d61 736b 5f75 7365 2c0a 2020  seg_mask_use,.  
-000640e0: 2020 2020 2020 7472 616e 7366 6f72 6d6c        transforml
-000640f0: 6973 7420 3d20 7431 5f32 5f66 6c61 6972  ist = t1_2_flair
-00064100: 5f72 6567 5b27 6677 6474 7261 6e73 666f  _reg['fwdtransfo
-00064110: 726d 7327 5d2c 0a20 2020 2020 2020 2069  rms'],.        i
-00064120: 6e74 6572 706f 6c61 746f 7220 3d20 276e  nterpolator = 'n
-00064130: 6561 7265 7374 4e65 6967 6862 6f72 2720  earestNeighbor' 
-00064140: 290a 2020 2020 7365 675f 325f 666c 6169  ).    seg_2_flai
-00064150: 7220 3d20 616e 7473 2e61 7070 6c79 5f74  r = ants.apply_t
-00064160: 7261 6e73 666f 726d 7328 666c 6169 722c  ransforms(flair,
-00064170: 2074 3173 6567 2c0a 2020 2020 2020 2020   t1seg,.        
-00064180: 7472 616e 7366 6f72 6d6c 6973 7420 3d20  transformlist = 
-00064190: 7431 5f32 5f66 6c61 6972 5f72 6567 5b27  t1_2_flair_reg['
-000641a0: 6677 6474 7261 6e73 666f 726d 7327 5d2c  fwdtransforms'],
-000641b0: 0a20 2020 2020 2020 2069 6e74 6572 706f  .        interpo
-000641c0: 6c61 746f 7220 3d20 276e 6561 7265 7374  lator = 'nearest
-000641d0: 4e65 6967 6862 6f72 2720 290a 2020 2020  Neighbor' ).    
-000641e0: 6373 666d 6173 6b20 3d20 616e 7473 2e74  csfmask = ants.t
-000641f0: 6872 6573 686f 6c64 5f69 6d61 6765 2873  hreshold_image(s
-00064200: 6567 5f32 5f66 6c61 6972 2c31 2c31 290a  eg_2_flair,1,1).
-00064210: 2020 2020 666c 6169 7273 6e72 203d 206d      flairsnr = m
-00064220: 6173 6b5f 736e 7228 2066 6c61 6972 2c20  ask_snr( flair, 
-00064230: 6373 666d 6173 6b2c 2077 6d73 6567 5f32  csfmask, wmseg_2
-00064240: 5f66 6c61 6972 2c20 6269 6173 5f63 6f72  _flair, bias_cor
-00064250: 7265 6374 203d 2046 616c 7365 2029 0a20  rect = False ). 
-00064260: 2020 2070 726f 6261 6269 6c69 7479 5f6d     probability_m
-00064270: 6173 6b5f 574d 203d 2077 6d73 6567 5f32  ask_WM = wmseg_2
-00064280: 5f66 6c61 6972 202a 2070 726f 6261 6269  _flair * probabi
-00064290: 6c69 7479 5f6d 6173 6b20 2320 5265 6d6f  lity_mask # Remo
-000642a0: 7665 2057 4d48 2073 6967 6e61 6c20 6f75  ve WMH signal ou
-000642b0: 7473 6964 6520 6f66 2057 4d0a 2020 2020  tside of WM.    
-000642c0: 776d 685f 7375 6d20 3d20 6e70 2e70 726f  wmh_sum = np.pro
-000642d0: 6428 2061 6e74 732e 6765 745f 7370 6163  d( ants.get_spac
-000642e0: 696e 6728 2066 6c61 6972 2029 2029 202a  ing( flair ) ) *
-000642f0: 2070 726f 6261 6269 6c69 7479 5f6d 6173   probability_mas
-00064300: 6b5f 574d 2e73 756d 2829 0a20 2020 2077  k_WM.sum().    w
-00064310: 6d68 5f73 756d 5f70 7269 6f72 203d 206d  mh_sum_prior = m
-00064320: 6174 682e 6e61 6e0a 2020 2020 7072 6f62  ath.nan.    prob
-00064330: 6162 696c 6974 795f 6d61 736b 5f70 6f73  ability_mask_pos
-00064340: 7465 7269 6f72 203d 204e 6f6e 650a 2020  terior = None.  
-00064350: 2020 6966 2070 7269 6f72 5f70 726f 6261    if prior_proba
-00064360: 6269 6c69 7479 5f66 6c61 6972 2069 7320  bility_flair is 
-00064370: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00064380: 2020 7072 6f62 6162 696c 6974 795f 6d61    probability_ma
-00064390: 736b 5f70 6f73 7465 7269 6f72 203d 2070  sk_posterior = p
-000643a0: 7269 6f72 5f70 726f 6261 6269 6c69 7479  rior_probability
-000643b0: 5f66 6c61 6972 202a 2070 726f 6261 6269  _flair * probabi
-000643c0: 6c69 7479 5f6d 6173 6b20 2320 7573 6520  lity_mask # use 
-000643d0: 7072 696f 720a 2020 2020 2020 2020 776d  prior.        wm
-000643e0: 685f 7375 6d5f 7072 696f 7220 3d20 6e70  h_sum_prior = np
-000643f0: 2e70 726f 6428 2061 6e74 732e 6765 745f  .prod( ants.get_
-00064400: 7370 6163 696e 6728 666c 6169 7229 2029  spacing(flair) )
-00064410: 202a 2070 726f 6261 6269 6c69 7479 5f6d   * probability_m
-00064420: 6173 6b5f 706f 7374 6572 696f 722e 7375  ask_posterior.su
-00064430: 6d28 290a 2020 2020 6966 206d 6174 682e  m().    if math.
-00064440: 6973 6e61 6e28 2077 6d68 5f73 756d 2029  isnan( wmh_sum )
-00064450: 3a0a 2020 2020 2020 2020 776d 685f 7375  :.        wmh_su
-00064460: 6d3d 300a 2020 2020 6966 206d 6174 682e  m=0.    if math.
-00064470: 6973 6e61 6e28 2077 6d68 5f73 756d 5f70  isnan( wmh_sum_p
-00064480: 7269 6f72 2029 3a0a 2020 2020 2020 2020  rior ):.        
-00064490: 776d 685f 7375 6d5f 7072 696f 723d 300a  wmh_sum_prior=0.
-000644a0: 2020 2020 666c 6169 725f 6576 7220 3d20      flair_evr = 
-000644b0: 616e 7473 7079 7431 772e 7061 7463 685f  antspyt1w.patch_
-000644c0: 6569 6765 6e76 616c 7565 5f72 6174 696f  eigenvalue_ratio
-000644d0: 2820 666c 6169 722c 2035 3132 2c20 5b31  ( flair, 512, [1
-000644e0: 362c 3136 2c31 365d 2c20 6576 6465 7074  6,16,16], evdept
-000644f0: 6820 3d20 302e 392c 206d 6173 6b3d 776d  h = 0.9, mask=wm
-00064500: 7365 675f 325f 666c 6169 7220 290a 2020  seg_2_flair ).  
-00064510: 2020 7265 7475 726e 7b0a 2020 2020 2020    return{.      
-00064520: 2020 2757 4d48 5f70 726f 6261 6269 6c69    'WMH_probabili
-00064530: 7479 5f6d 6170 5f72 6177 273a 2070 726f  ty_map_raw': pro
-00064540: 6261 6269 6c69 7479 5f6d 6173 6b2c 0a20  bability_mask,. 
-00064550: 2020 2020 2020 2027 574d 485f 7072 6f62         'WMH_prob
-00064560: 6162 696c 6974 795f 6d61 7027 203a 2070  ability_map' : p
-00064570: 726f 6261 6269 6c69 7479 5f6d 6173 6b5f  robability_mask_
-00064580: 574d 2c0a 2020 2020 2020 2020 2757 4d48  WM,.        'WMH
-00064590: 5f70 6f73 7465 7269 6f72 5f70 726f 6261  _posterior_proba
-000645a0: 6269 6c69 7479 5f6d 6170 2720 3a20 7072  bility_map' : pr
-000645b0: 6f62 6162 696c 6974 795f 6d61 736b 5f70  obability_mask_p
-000645c0: 6f73 7465 7269 6f72 2c0a 2020 2020 2020  osterior,.      
-000645d0: 2020 2777 6d68 5f6d 6173 7327 3a20 776d    'wmh_mass': wm
-000645e0: 685f 7375 6d2c 0a20 2020 2020 2020 2027  h_sum,.        '
-000645f0: 776d 685f 6d61 7373 5f70 7269 6f72 273a  wmh_mass_prior':
-00064600: 2077 6d68 5f73 756d 5f70 7269 6f72 2c0a   wmh_sum_prior,.
-00064610: 2020 2020 2020 2020 2777 6d68 5f65 7672          'wmh_evr
-00064620: 2720 3a20 666c 6169 725f 6576 722c 0a20  ' : flair_evr,. 
-00064630: 2020 2020 2020 2027 776d 685f 534e 5227         'wmh_SNR'
-00064640: 203a 2066 6c61 6972 736e 722c 0a20 2020   : flairsnr,.   
-00064650: 2020 2020 2027 636f 6e76 6578 6875 6c6c       'convexhull
-00064660: 5f6d 6173 6b27 3a20 6469 7374 6d61 736b  _mask': distmask
-00064670: 207d 0a0a 0a64 6566 2072 6570 6c61 6365   }...def replace
-00064680: 5f65 6c65 6d65 6e74 735f 696e 5f6e 756d  _elements_in_num
-00064690: 7079 5f61 7272 6179 286f 7269 6769 6e61  py_array(origina
-000646a0: 6c5f 6172 7261 792c 2069 6e64 6963 6573  l_array, indices
-000646b0: 5f74 6f5f 7265 706c 6163 652c 206e 6577  _to_replace, new
-000646c0: 5f76 616c 7565 293a 0a20 2020 2022 2222  _value):.    """
-000646d0: 0a20 2020 2052 6570 6c61 6365 2073 7065  .    Replace spe
-000646e0: 6369 6669 6564 2065 6c65 6d65 6e74 7320  cified elements 
-000646f0: 6f72 2072 6f77 7320 696e 2061 206e 756d  or rows in a num
-00064700: 7079 2061 7272 6179 2077 6974 6820 6120  py array with a 
-00064710: 6e65 7720 7661 6c75 652e 0a0a 2020 2020  new value...    
-00064720: 5061 7261 6d65 7465 7273 3a0a 2020 2020  Parameters:.    
-00064730: 6f72 6967 696e 616c 5f61 7272 6179 2028  original_array (
-00064740: 6e75 6d70 792e 6e64 6172 7261 7929 3a20  numpy.ndarray): 
-00064750: 4120 6e75 6d70 7920 6172 7261 7920 696e  A numpy array in
-00064760: 2077 6869 6368 2065 6c65 6d65 6e74 7320   which elements 
-00064770: 6f72 2072 6f77 7320 6172 6520 746f 2062  or rows are to b
-00064780: 6520 7265 706c 6163 6564 2e0a 2020 2020  e replaced..    
-00064790: 696e 6469 6365 735f 746f 5f72 6570 6c61  indices_to_repla
-000647a0: 6365 2028 6c69 7374 206f 7220 6e75 6d70  ce (list or nump
-000647b0: 792e 6e64 6172 7261 7929 3a20 496e 6469  y.ndarray): Indi
-000647c0: 6365 7320 6f66 2065 6c65 6d65 6e74 7320  ces of elements 
-000647d0: 6f72 2072 6f77 7320 746f 2062 6520 7265  or rows to be re
-000647e0: 706c 6163 6564 2e0a 2020 2020 6e65 775f  placed..    new_
-000647f0: 7661 6c75 653a 2054 6865 206e 6577 2076  value: The new v
-00064800: 616c 7565 2074 6f20 7265 706c 6163 6520  alue to replace 
-00064810: 7468 6520 7370 6563 6966 6965 6420 656c  the specified el
-00064820: 656d 656e 7473 206f 7220 726f 7773 2e0a  ements or rows..
-00064830: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-00064840: 2020 6e75 6d70 792e 6e64 6172 7261 793a    numpy.ndarray:
-00064850: 2041 206e 6577 206e 756d 7079 2061 7272   A new numpy arr
-00064860: 6179 2077 6974 6820 7468 6520 7370 6563  ay with the spec
-00064870: 6966 6965 6420 656c 656d 656e 7473 206f  ified elements o
-00064880: 7220 726f 7773 2072 6570 6c61 6365 642e  r rows replaced.
-00064890: 2049 6620 7468 6520 696e 7075 7420 6172   If the input ar
-000648a0: 7261 7920 6973 204e 6f6e 652c 0a20 2020  ray is None,.   
-000648b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000648c0: 7468 6520 6675 6e63 7469 6f6e 2072 6574  the function ret
-000648d0: 7572 6e73 204e 6f6e 652e 0a20 2020 2022  urns None..    "
-000648e0: 2222 0a0a 2020 2020 6966 206f 7269 6769  ""..    if origi
-000648f0: 6e61 6c5f 6172 7261 7920 6973 204e 6f6e  nal_array is Non
-00064900: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
-00064910: 6e20 4e6f 6e65 0a0a 2020 2020 6d61 785f  n None..    max_
-00064920: 696e 6465 7820 3d20 6f72 6967 696e 616c  index = original
-00064930: 5f61 7272 6179 2e73 697a 6520 6966 206f  _array.size if o
-00064940: 7269 6769 6e61 6c5f 6172 7261 792e 6e64  riginal_array.nd
-00064950: 696d 203d 3d20 3120 656c 7365 206f 7269  im == 1 else ori
-00064960: 6769 6e61 6c5f 6172 7261 792e 7368 6170  ginal_array.shap
-00064970: 655b 305d 0a0a 2020 2020 2320 4669 6c74  e[0]..    # Filt
-00064980: 6572 206f 7574 2069 6e76 616c 6964 2069  er out invalid i
-00064990: 6e64 6963 6573 2061 6e64 2063 6865 636b  ndices and check
-000649a0: 2066 6f72 2061 6e79 206f 7574 2d6f 662d   for any out-of-
-000649b0: 626f 756e 6473 2069 6e64 6963 6573 0a20  bounds indices. 
-000649c0: 2020 2076 616c 6964 5f69 6e64 6963 6573     valid_indices
-000649d0: 203d 205b 5d0a 2020 2020 666f 7220 6964   = [].    for id
-000649e0: 7820 696e 2069 6e64 6963 6573 5f74 6f5f  x in indices_to_
-000649f0: 7265 706c 6163 653a 0a20 2020 2020 2020  replace:.       
-00064a00: 2069 6620 6964 7820 3c20 6d61 785f 696e   if idx < max_in
-00064a10: 6465 783a 0a20 2020 2020 2020 2020 2020  dex:.           
-00064a20: 2076 616c 6964 5f69 6e64 6963 6573 2e61   valid_indices.a
-00064a30: 7070 656e 6428 6964 7829 0a20 2020 2020  ppend(idx).     
-00064a40: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00064a50: 2020 2020 2077 6172 6e69 6e67 732e 7761       warnings.wa
-00064a60: 726e 2866 2257 6172 6e69 6e67 3a20 496e  rn(f"Warning: In
-00064a70: 6465 7820 7b69 6478 7d20 6973 206f 7574  dex {idx} is out
-00064a80: 206f 6620 626f 756e 6473 2061 6e64 2077   of bounds and w
-00064a90: 696c 6c20 6265 2069 676e 6f72 6564 2e22  ill be ignored."
-00064aa0: 290a 0a20 2020 2069 6620 6f72 6967 696e  )..    if origin
-00064ab0: 616c 5f61 7272 6179 2e6e 6469 6d20 3d3d  al_array.ndim ==
-00064ac0: 2031 3a0a 2020 2020 2020 2020 2320 5265   1:.        # Re
-00064ad0: 706c 6163 6520 656c 656d 656e 7473 2069  place elements i
-00064ae0: 6e20 6120 3144 2061 7272 6179 0a20 2020  n a 1D array.   
-00064af0: 2020 2020 206f 7269 6769 6e61 6c5f 6172       original_ar
-00064b00: 7261 795b 7661 6c69 645f 696e 6469 6365  ray[valid_indice
-00064b10: 735d 203d 206e 6577 5f76 616c 7565 0a20  s] = new_value. 
-00064b20: 2020 2065 6c69 6620 6f72 6967 696e 616c     elif original
-00064b30: 5f61 7272 6179 2e6e 6469 6d20 3d3d 2032  _array.ndim == 2
-00064b40: 3a0a 2020 2020 2020 2020 2320 5265 706c  :.        # Repl
-00064b50: 6163 6520 726f 7773 2069 6e20 6120 3244  ace rows in a 2D
-00064b60: 2061 7272 6179 0a20 2020 2020 2020 206f   array.        o
-00064b70: 7269 6769 6e61 6c5f 6172 7261 795b 7661  riginal_array[va
-00064b80: 6c69 645f 696e 6469 6365 732c 203a 5d20  lid_indices, :] 
-00064b90: 3d20 6e65 775f 7661 6c75 650a 2020 2020  = new_value.    
-00064ba0: 656c 7365 3a0a 2020 2020 2020 2020 7261  else:.        ra
-00064bb0: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
-00064bc0: 6f72 6967 696e 616c 5f61 7272 6179 206d  original_array m
-00064bd0: 7573 7420 6265 2065 6974 6865 7220 3144  ust be either 1D
-00064be0: 206f 7220 3244 2e22 290a 0a20 2020 2072   or 2D.")..    r
-00064bf0: 6574 7572 6e20 6f72 6967 696e 616c 5f61  eturn original_a
-00064c00: 7272 6179 0a0a 0a0a 6465 6620 7265 6d6f  rray....def remo
-00064c10: 7665 5f65 6c65 6d65 6e74 735f 6672 6f6d  ve_elements_from
-00064c20: 5f6e 756d 7079 5f61 7272 6179 286f 7269  _numpy_array(ori
-00064c30: 6769 6e61 6c5f 6172 7261 792c 2069 6e64  ginal_array, ind
-00064c40: 6963 6573 5f74 6f5f 7265 6d6f 7665 293a  ices_to_remove):
-00064c50: 0a20 2020 2022 2222 0a20 2020 2052 656d  .    """.    Rem
-00064c60: 6f76 6520 7370 6563 6966 6965 6420 656c  ove specified el
-00064c70: 656d 656e 7473 206f 7220 726f 7773 2066  ements or rows f
-00064c80: 726f 6d20 6120 6e75 6d70 7920 6172 7261  rom a numpy arra
-00064c90: 792e 0a0a 2020 2020 5061 7261 6d65 7465  y...    Paramete
-00064ca0: 7273 3a0a 2020 2020 6f72 6967 696e 616c  rs:.    original
-00064cb0: 5f61 7272 6179 2028 6e75 6d70 792e 6e64  _array (numpy.nd
-00064cc0: 6172 7261 7929 3a20 4120 6e75 6d70 7920  array): A numpy 
-00064cd0: 6172 7261 7920 6672 6f6d 2077 6869 6368  array from which
-00064ce0: 2065 6c65 6d65 6e74 7320 6f72 2072 6f77   elements or row
-00064cf0: 7320 6172 6520 746f 2062 6520 7265 6d6f  s are to be remo
-00064d00: 7665 642e 0a20 2020 2069 6e64 6963 6573  ved..    indices
-00064d10: 5f74 6f5f 7265 6d6f 7665 2028 6c69 7374  _to_remove (list
-00064d20: 206f 7220 6e75 6d70 792e 6e64 6172 7261   or numpy.ndarra
-00064d30: 7929 3a20 496e 6469 6365 7320 6f66 2065  y): Indices of e
-00064d40: 6c65 6d65 6e74 7320 6f72 2072 6f77 7320  lements or rows 
-00064d50: 746f 2062 6520 7265 6d6f 7665 642e 0a0a  to be removed...
-00064d60: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-00064d70: 206e 756d 7079 2e6e 6461 7272 6179 3a20   numpy.ndarray: 
-00064d80: 4120 6e65 7720 6e75 6d70 7920 6172 7261  A new numpy arra
-00064d90: 7920 7769 7468 2074 6865 2073 7065 6369  y with the speci
-00064da0: 6669 6564 2065 6c65 6d65 6e74 7320 6f72  fied elements or
-00064db0: 2072 6f77 7320 7265 6d6f 7665 642e 2049   rows removed. I
-00064dc0: 6620 7468 6520 696e 7075 7420 6172 7261  f the input arra
-00064dd0: 7920 6973 204e 6f6e 652c 0a20 2020 2020  y is None,.     
-00064de0: 2020 2020 2020 2020 2020 2020 2020 7468                th
-00064df0: 6520 6675 6e63 7469 6f6e 2072 6574 7572  e function retur
-00064e00: 6e73 204e 6f6e 652e 0a20 2020 2022 2222  ns None..    """
-00064e10: 0a0a 2020 2020 6966 206f 7269 6769 6e61  ..    if origina
-00064e20: 6c5f 6172 7261 7920 6973 204e 6f6e 653a  l_array is None:
-00064e30: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00064e40: 4e6f 6e65 0a0a 2020 2020 6966 206f 7269  None..    if ori
-00064e50: 6769 6e61 6c5f 6172 7261 792e 6e64 696d  ginal_array.ndim
-00064e60: 203d 3d20 313a 0a20 2020 2020 2020 2023   == 1:.        #
-00064e70: 2052 656d 6f76 6520 656c 656d 656e 7473   Remove elements
-00064e80: 2066 726f 6d20 6120 3144 2061 7272 6179   from a 1D array
-00064e90: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00064ea0: 6e70 2e64 656c 6574 6528 6f72 6967 696e  np.delete(origin
-00064eb0: 616c 5f61 7272 6179 2c20 696e 6469 6365  al_array, indice
-00064ec0: 735f 746f 5f72 656d 6f76 6529 0a20 2020  s_to_remove).   
-00064ed0: 2065 6c69 6620 6f72 6967 696e 616c 5f61   elif original_a
-00064ee0: 7272 6179 2e6e 6469 6d20 3d3d 2032 3a0a  rray.ndim == 2:.
-00064ef0: 2020 2020 2020 2020 2320 5265 6d6f 7665          # Remove
-00064f00: 2072 6f77 7320 6672 6f6d 2061 2032 4420   rows from a 2D 
-00064f10: 6172 7261 790a 2020 2020 2020 2020 7265  array.        re
-00064f20: 7475 726e 206e 702e 6465 6c65 7465 286f  turn np.delete(o
-00064f30: 7269 6769 6e61 6c5f 6172 7261 792c 2069  riginal_array, i
-00064f40: 6e64 6963 6573 5f74 6f5f 7265 6d6f 7665  ndices_to_remove
-00064f50: 2c20 6178 6973 3d30 290a 2020 2020 656c  , axis=0).    el
-00064f60: 7365 3a0a 2020 2020 2020 2020 7261 6973  se:.        rais
-00064f70: 6520 5661 6c75 6545 7272 6f72 2822 6f72  e ValueError("or
-00064f80: 6967 696e 616c 5f61 7272 6179 206d 7573  iginal_array mus
-00064f90: 7420 6265 2065 6974 6865 7220 3144 206f  t be either 1D o
-00064fa0: 7220 3244 2e22 290a 0a64 6566 2072 656d  r 2D.")..def rem
-00064fb0: 6f76 655f 766f 6c75 6d65 735f 6672 6f6d  ove_volumes_from
-00064fc0: 5f74 696d 6573 6572 6965 7328 7469 6d65  _timeseries(time
-00064fd0: 5f73 6572 6965 732c 2076 6f6c 756d 6573  _series, volumes
-00064fe0: 5f74 6f5f 7265 6d6f 7665 293a 0a20 2020  _to_remove):.   
-00064ff0: 2022 2222 0a20 2020 2052 656d 6f76 6520   """.    Remove 
-00065000: 7370 6563 6966 6965 6420 766f 6c75 6d65  specified volume
-00065010: 7320 6672 6f6d 2061 2074 696d 6520 7365  s from a time se
-00065020: 7269 6573 2e0a 0a20 2020 203a 7061 7261  ries...    :para
-00065030: 6d20 7469 6d65 5f73 6572 6965 733a 2041  m time_series: A
-00065040: 4e54 7349 6d61 6765 2072 6570 7265 7365  NTsImage represe
-00065050: 6e74 696e 6720 7468 6520 7469 6d65 2073  nting the time s
-00065060: 6572 6965 7320 2834 4420 696d 6167 6529  eries (4D image)
-00065070: 2e0a 2020 2020 3a70 6172 616d 2076 6f6c  ..    :param vol
-00065080: 756d 6573 5f74 6f5f 7265 6d6f 7665 3a20  umes_to_remove: 
-00065090: 4c69 7374 206f 6620 766f 6c75 6d65 2069  List of volume i
-000650a0: 6e64 6963 6573 2074 6f20 7265 6d6f 7665  ndices to remove
-000650b0: 2e0a 2020 2020 3a72 6574 7572 6e3a 2041  ..    :return: A
-000650c0: 4e54 7349 6d61 6765 2077 6974 6820 7370  NTsImage with sp
-000650d0: 6563 6966 6965 6420 766f 6c75 6d65 7320  ecified volumes 
-000650e0: 7265 6d6f 7665 642e 0a20 2020 2022 2222  removed..    """
-000650f0: 0a20 2020 2069 6620 6e6f 7420 6973 696e  .    if not isin
-00065100: 7374 616e 6365 2874 696d 655f 7365 7269  stance(time_seri
-00065110: 6573 2c20 616e 7473 2e41 4e54 7349 6d61  es, ants.ANTsIma
-00065120: 6765 293a 0a20 2020 2020 2020 2072 6169  ge):.        rai
-00065130: 7365 2056 616c 7565 4572 726f 7228 2274  se ValueError("t
-00065140: 696d 655f 7365 7269 6573 206d 7573 7420  ime_series must 
-00065150: 6265 2061 6e20 414e 5473 496d 6167 652e  be an ANTsImage.
-00065160: 2229 0a0a 2020 2020 6966 2074 696d 655f  ")..    if time_
-00065170: 7365 7269 6573 2e64 696d 656e 7369 6f6e  series.dimension
-00065180: 2021 3d20 343a 0a20 2020 2020 2020 2072   != 4:.        r
-00065190: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-000651a0: 2274 696d 655f 7365 7269 6573 206d 7573  "time_series mus
-000651b0: 7420 6265 2061 2034 4420 696d 6167 652e  t be a 4D image.
-000651c0: 2229 0a0a 2020 2020 2320 4372 6561 7465  ")..    # Create
-000651d0: 2061 2062 6f6f 6c65 616e 2069 6e64 6578   a boolean index
-000651e0: 2066 6f72 2076 6f6c 756d 6573 2074 6f20   for volumes to 
-000651f0: 6b65 6570 0a20 2020 2076 6f6c 756d 6573  keep.    volumes
-00065200: 5f74 6f5f 6b65 6570 203d 205b 6920 666f  _to_keep = [i fo
-00065210: 7220 6920 696e 2072 616e 6765 2874 696d  r i in range(tim
-00065220: 655f 7365 7269 6573 2e73 6861 7065 5b33  e_series.shape[3
-00065230: 5d29 2069 6620 6920 6e6f 7420 696e 2076  ]) if i not in v
-00065240: 6f6c 756d 6573 5f74 6f5f 7265 6d6f 7665  olumes_to_remove
-00065250: 5d0a 0a20 2020 2023 2053 656c 6563 7420  ]..    # Select 
-00065260: 7468 6520 766f 6c75 6d65 7320 746f 206b  the volumes to k
-00065270: 6565 700a 2020 2020 6669 6c74 6572 6564  eep.    filtered
-00065280: 5f74 696d 655f 7365 7269 6573 203d 2061  _time_series = a
-00065290: 6e74 732e 6672 6f6d 5f6e 756d 7079 2820  nts.from_numpy( 
-000652a0: 7469 6d65 5f73 6572 6965 735b 2e2e 2e2c  time_series[...,
-000652b0: 2076 6f6c 756d 6573 5f74 6f5f 6b65 6570   volumes_to_keep
-000652c0: 5d20 290a 0a20 2020 2072 6574 7572 6e20  ] )..    return 
-000652d0: 616e 7473 2e63 6f70 795f 696d 6167 655f  ants.copy_image_
-000652e0: 696e 666f 2820 7469 6d65 5f73 6572 6965  info( time_serie
-000652f0: 732c 2066 696c 7465 7265 645f 7469 6d65  s, filtered_time
-00065300: 5f73 6572 6965 7320 290a 0a64 6566 2072  _series )..def r
-00065310: 656d 6f76 655f 656c 656d 656e 7473 5f66  emove_elements_f
-00065320: 726f 6d5f 6c69 7374 286f 7269 6769 6e61  rom_list(origina
-00065330: 6c5f 6c69 7374 2c20 656c 656d 656e 7473  l_list, elements
-00065340: 5f74 6f5f 7265 6d6f 7665 293a 0a20 2020  _to_remove):.   
-00065350: 2022 2222 0a20 2020 2052 656d 6f76 6520   """.    Remove 
-00065360: 7370 6563 6966 6965 6420 656c 656d 656e  specified elemen
-00065370: 7473 2066 726f 6d20 6120 6c69 7374 2e0a  ts from a list..
-00065380: 0a20 2020 2050 6172 616d 6574 6572 733a  .    Parameters:
-00065390: 0a20 2020 206f 7269 6769 6e61 6c5f 6c69  .    original_li
-000653a0: 7374 2028 6c69 7374 293a 2054 6865 206f  st (list): The o
-000653b0: 7269 6769 6e61 6c20 6c69 7374 2066 726f  riginal list fro
-000653c0: 6d20 7768 6963 6820 656c 656d 656e 7473  m which elements
-000653d0: 2077 696c 6c20 6265 2072 656d 6f76 6564   will be removed
-000653e0: 2e0a 2020 2020 656c 656d 656e 7473 5f74  ..    elements_t
-000653f0: 6f5f 7265 6d6f 7665 2028 6c69 7374 293a  o_remove (list):
-00065400: 2041 206c 6973 7420 6f66 2065 6c65 6d65   A list of eleme
-00065410: 6e74 7320 7468 6174 206e 6565 6420 746f  nts that need to
-00065420: 2062 6520 7265 6d6f 7665 6420 6672 6f6d   be removed from
-00065430: 2074 6865 206f 7269 6769 6e61 6c20 6c69   the original li
-00065440: 7374 2e0a 0a20 2020 2052 6574 7572 6e73  st...    Returns
-00065450: 3a0a 2020 2020 6c69 7374 3a20 4120 6e65  :.    list: A ne
-00065460: 7720 6c69 7374 2077 6974 6820 7468 6520  w list with the 
-00065470: 7370 6563 6966 6965 6420 656c 656d 656e  specified elemen
-00065480: 7473 2072 656d 6f76 6564 2e0a 2020 2020  ts removed..    
-00065490: 2222 220a 2020 2020 7265 7475 726e 205b  """.    return [
-000654a0: 656c 656d 656e 7420 666f 7220 656c 656d  element for elem
-000654b0: 656e 7420 696e 206f 7269 6769 6e61 6c5f  ent in original_
-000654c0: 6c69 7374 2069 6620 656c 656d 656e 7420  list if element 
-000654d0: 6e6f 7420 696e 2065 6c65 6d65 6e74 735f  not in elements_
-000654e0: 746f 5f72 656d 6f76 655d 0a0a 0a64 6566  to_remove]...def
-000654f0: 2069 6d70 7574 655f 7469 6d65 7365 7269   impute_timeseri
-00065500: 6573 2874 696d 655f 7365 7269 6573 2c20  es(time_series, 
-00065510: 766f 6c75 6d65 735f 746f 5f69 6d70 7574  volumes_to_imput
-00065520: 652c 206d 6574 686f 643d 276c 696e 6561  e, method='linea
-00065530: 7227 2c20 7665 7262 6f73 653d 4661 6c73  r', verbose=Fals
-00065540: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
-00065550: 496d 7075 7465 2073 7065 6369 6669 6564  Impute specified
-00065560: 2076 6f6c 756d 6573 2066 726f 6d20 6120   volumes from a 
-00065570: 7469 6d65 2073 6572 6965 7320 7769 7468  time series with
-00065580: 2069 6e74 6572 706f 6c61 7465 6420 7661   interpolated va
-00065590: 6c75 6573 2e0a 0a20 2020 203a 7061 7261  lues...    :para
-000655a0: 6d20 7469 6d65 5f73 6572 6965 733a 2041  m time_series: A
-000655b0: 4e54 7349 6d61 6765 2072 6570 7265 7365  NTsImage represe
-000655c0: 6e74 696e 6720 7468 6520 7469 6d65 2073  nting the time s
-000655d0: 6572 6965 7320 2834 4420 696d 6167 6529  eries (4D image)
-000655e0: 2e0a 2020 2020 3a70 6172 616d 2076 6f6c  ..    :param vol
-000655f0: 756d 6573 5f74 6f5f 696d 7075 7465 3a20  umes_to_impute: 
-00065600: 4c69 7374 206f 6620 766f 6c75 6d65 2069  List of volume i
-00065610: 6e64 6963 6573 2074 6f20 696d 7075 7465  ndices to impute
-00065620: 2e0a 2020 2020 3a70 6172 616d 206d 6574  ..    :param met
-00065630: 686f 643a 2049 6e74 6572 706f 6c61 7469  hod: Interpolati
-00065640: 6f6e 206d 6574 686f 6420 2827 6c69 6e65  on method ('line
-00065650: 6172 2720 6f72 206f 7468 6572 206d 6574  ar' or other met
-00065660: 686f 6473 2069 6620 696d 706c 656d 656e  hods if implemen
-00065670: 7465 6429 2e0a 2020 2020 3a70 6172 616d  ted)..    :param
-00065680: 2076 6572 626f 7365 3a20 626f 6f6c 6561   verbose: boolea
-00065690: 6e0a 2020 2020 3a72 6574 7572 6e3a 2041  n.    :return: A
-000656a0: 4e54 7349 6d61 6765 2077 6974 6820 7370  NTsImage with sp
-000656b0: 6563 6966 6965 6420 766f 6c75 6d65 7320  ecified volumes 
-000656c0: 696d 7075 7465 642e 0a20 2020 2022 2222  imputed..    """
-000656d0: 0a20 2020 2069 6620 6e6f 7420 6973 696e  .    if not isin
-000656e0: 7374 616e 6365 2874 696d 655f 7365 7269  stance(time_seri
-000656f0: 6573 2c20 616e 7473 2e41 4e54 7349 6d61  es, ants.ANTsIma
-00065700: 6765 293a 0a20 2020 2020 2020 2072 6169  ge):.        rai
-00065710: 7365 2056 616c 7565 4572 726f 7228 2274  se ValueError("t
-00065720: 696d 655f 7365 7269 6573 206d 7573 7420  ime_series must 
-00065730: 6265 2061 6e20 414e 5473 496d 6167 652e  be an ANTsImage.
-00065740: 2229 0a0a 2020 2020 6966 2074 696d 655f  ")..    if time_
-00065750: 7365 7269 6573 2e64 696d 656e 7369 6f6e  series.dimension
-00065760: 2021 3d20 343a 0a20 2020 2020 2020 2072   != 4:.        r
-00065770: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00065780: 2274 696d 655f 7365 7269 6573 206d 7573  "time_series mus
-00065790: 7420 6265 2061 2034 4420 696d 6167 652e  t be a 4D image.
-000657a0: 2229 0a0a 2020 2020 2320 436f 6e76 6572  ")..    # Conver
-000657b0: 7420 7469 6d65 5f73 6572 6965 7320 746f  t time_series to
-000657c0: 206e 756d 7079 2066 6f72 206d 616e 6970   numpy for manip
-000657d0: 756c 6174 696f 6e0a 2020 2020 7469 6d65  ulation.    time
-000657e0: 5f73 6572 6965 735f 6e70 203d 2074 696d  _series_np = tim
-000657f0: 655f 7365 7269 6573 2e6e 756d 7079 2829  e_series.numpy()
-00065800: 0a20 2020 2074 6f74 616c 5f76 6f6c 756d  .    total_volum
-00065810: 6573 203d 2074 696d 655f 7365 7269 6573  es = time_series
-00065820: 5f6e 702e 7368 6170 655b 335d 0a0a 2020  _np.shape[3]..  
-00065830: 2020 2320 4372 6561 7465 2061 2063 6f6d    # Create a com
-00065840: 706c 656d 656e 7420 6c69 7374 206f 6620  plement list of 
-00065850: 766f 6c75 6d65 7320 6e6f 7420 746f 2069  volumes not to i
-00065860: 6d70 7574 650a 2020 2020 766f 6c75 6d65  mpute.    volume
-00065870: 735f 6e6f 745f 746f 5f69 6d70 7574 6520  s_not_to_impute 
-00065880: 3d20 5b69 2066 6f72 2069 2069 6e20 7261  = [i for i in ra
-00065890: 6e67 6528 746f 7461 6c5f 766f 6c75 6d65  nge(total_volume
-000658a0: 7329 2069 6620 6920 6e6f 7420 696e 2076  s) if i not in v
-000658b0: 6f6c 756d 6573 5f74 6f5f 696d 7075 7465  olumes_to_impute
-000658c0: 5d0a 0a20 2020 2023 2044 6566 696e 6520  ]..    # Define 
-000658d0: 7468 6520 6c6f 7765 7220 616e 6420 7570  the lower and up
-000658e0: 7065 7220 626f 756e 6473 0a20 2020 206d  per bounds.    m
-000658f0: 696e 5f76 616c 6964 5f69 6e64 6578 203d  in_valid_index =
-00065900: 206d 696e 2876 6f6c 756d 6573 5f6e 6f74   min(volumes_not
-00065910: 5f74 6f5f 696d 7075 7465 290a 2020 2020  _to_impute).    
-00065920: 6d61 785f 7661 6c69 645f 696e 6465 7820  max_valid_index 
-00065930: 3d20 6d61 7828 766f 6c75 6d65 735f 6e6f  = max(volumes_no
-00065940: 745f 746f 5f69 6d70 7574 6529 0a0a 2020  t_to_impute)..  
-00065950: 2020 666f 7220 766f 6c5f 6964 7820 696e    for vol_idx in
-00065960: 2076 6f6c 756d 6573 5f74 6f5f 696d 7075   volumes_to_impu
-00065970: 7465 3a0a 2020 2020 2020 2020 2320 456e  te:.        # En
-00065980: 7375 7265 2074 6865 2076 6f6c 756d 6520  sure the volume 
-00065990: 696e 6465 7820 6973 2077 6974 6869 6e20  index is within 
-000659a0: 7468 6520 7661 6c69 6420 7261 6e67 650a  the valid range.
-000659b0: 2020 2020 2020 2020 6966 2076 6f6c 5f69          if vol_i
-000659c0: 6478 203c 2030 206f 7220 766f 6c5f 6964  dx < 0 or vol_id
-000659d0: 7820 3e3d 2074 6f74 616c 5f76 6f6c 756d  x >= total_volum
-000659e0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-000659f0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00065a00: 2866 2256 6f6c 756d 6520 696e 6465 7820  (f"Volume index 
-00065a10: 7b76 6f6c 5f69 6478 7d20 6973 206f 7574  {vol_idx} is out
-00065a20: 206f 6620 626f 756e 6473 2e22 290a 0a20   of bounds.").. 
-00065a30: 2020 2020 2020 2023 2046 696e 6420 7468         # Find th
-00065a40: 6520 6e65 6172 6573 7420 7661 6c69 6420  e nearest valid 
-00065a50: 6c6f 7765 7220 696e 6465 7820 7769 7468  lower index with
-00065a60: 696e 2074 6865 2062 6f75 6e64 730a 2020  in the bounds.  
-00065a70: 2020 2020 2020 6c6f 7765 725f 6361 6e64        lower_cand
-00065a80: 6964 6174 6573 203d 205b 7620 666f 7220  idates = [v for 
-00065a90: 7620 696e 2076 6f6c 756d 6573 5f6e 6f74  v in volumes_not
-00065aa0: 5f74 6f5f 696d 7075 7465 2069 6620 7620  _to_impute if v 
-00065ab0: 3c3d 2076 6f6c 5f69 6478 5d0a 2020 2020  <= vol_idx].    
-00065ac0: 2020 2020 6c6f 7765 725f 6964 7820 3d20      lower_idx = 
-00065ad0: 6d61 7828 6c6f 7765 725f 6361 6e64 6964  max(lower_candid
-00065ae0: 6174 6573 2920 6966 206c 6f77 6572 5f63  ates) if lower_c
-00065af0: 616e 6469 6461 7465 7320 656c 7365 206d  andidates else m
-00065b00: 696e 5f76 616c 6964 5f69 6e64 6578 0a0a  in_valid_index..
-00065b10: 2020 2020 2020 2020 2320 4669 6e64 2074          # Find t
-00065b20: 6865 206e 6561 7265 7374 2076 616c 6964  he nearest valid
-00065b30: 2075 7070 6572 2069 6e64 6578 2077 6974   upper index wit
-00065b40: 6869 6e20 7468 6520 626f 756e 6473 0a20  hin the bounds. 
-00065b50: 2020 2020 2020 2075 7070 6572 5f63 616e         upper_can
-00065b60: 6469 6461 7465 7320 3d20 5b76 2066 6f72  didates = [v for
-00065b70: 2076 2069 6e20 766f 6c75 6d65 735f 6e6f   v in volumes_no
-00065b80: 745f 746f 5f69 6d70 7574 6520 6966 2076  t_to_impute if v
-00065b90: 203e 3d20 766f 6c5f 6964 785d 0a20 2020   >= vol_idx].   
-00065ba0: 2020 2020 2075 7070 6572 5f69 6478 203d       upper_idx =
-00065bb0: 206d 696e 2875 7070 6572 5f63 616e 6469   min(upper_candi
-00065bc0: 6461 7465 7329 2069 6620 7570 7065 725f  dates) if upper_
-00065bd0: 6361 6e64 6964 6174 6573 2065 6c73 6520  candidates else 
-00065be0: 6d61 785f 7661 6c69 645f 696e 6465 780a  max_valid_index.
-00065bf0: 0a20 2020 2020 2020 2069 6620 7665 7262  .        if verb
-00065c00: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-00065c10: 2070 7269 6e74 2866 2249 6d70 7574 696e   print(f"Imputin
-00065c20: 6720 766f 6c75 6d65 207b 766f 6c5f 6964  g volume {vol_id
-00065c30: 787d 2075 7369 6e67 2069 6e64 6963 6573  x} using indices
-00065c40: 207b 6c6f 7765 725f 6964 787d 2061 6e64   {lower_idx} and
-00065c50: 207b 7570 7065 725f 6964 787d 2229 0a0a   {upper_idx}")..
-00065c60: 2020 2020 2020 2020 6966 206d 6574 686f          if metho
-00065c70: 6420 3d3d 2027 6c69 6e65 6172 273a 0a20  d == 'linear':. 
-00065c80: 2020 2020 2020 2020 2020 2023 204c 696e             # Lin
-00065c90: 6561 7220 696e 7465 7270 6f6c 6174 696f  ear interpolatio
-00065ca0: 6e20 6265 7477 6565 6e20 7468 6520 7477  n between the tw
-00065cb0: 6f20 6e65 6172 6573 7420 766f 6c75 6d65  o nearest volume
-00065cc0: 730a 2020 2020 2020 2020 2020 2020 6c6f  s.            lo
-00065cd0: 7765 725f 766f 6c75 6d65 203d 2074 696d  wer_volume = tim
-00065ce0: 655f 7365 7269 6573 5f6e 705b 2e2e 2e2c  e_series_np[...,
-00065cf0: 206c 6f77 6572 5f69 6478 5d0a 2020 2020   lower_idx].    
-00065d00: 2020 2020 2020 2020 7570 7065 725f 766f          upper_vo
-00065d10: 6c75 6d65 203d 2074 696d 655f 7365 7269  lume = time_seri
-00065d20: 6573 5f6e 705b 2e2e 2e2c 2075 7070 6572  es_np[..., upper
-00065d30: 5f69 6478 5d0a 2020 2020 2020 2020 2020  _idx].          
-00065d40: 2020 696e 7465 7270 6f6c 6174 6564 5f76    interpolated_v
-00065d50: 6f6c 756d 6520 3d20 286c 6f77 6572 5f76  olume = (lower_v
-00065d60: 6f6c 756d 6520 2b20 7570 7065 725f 766f  olume + upper_vo
-00065d70: 6c75 6d65 2920 2f20 320a 2020 2020 2020  lume) / 2.      
-00065d80: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00065d90: 2020 2020 2320 506c 6163 6568 6f6c 6465      # Placeholde
-00065da0: 7220 666f 7220 6f74 6865 7220 696e 7465  r for other inte
-00065db0: 7270 6f6c 6174 696f 6e20 6d65 7468 6f64  rpolation method
-00065dc0: 730a 2020 2020 2020 2020 2020 2020 7261  s.            ra
-00065dd0: 6973 6520 4e6f 7449 6d70 6c65 6d65 6e74  ise NotImplement
-00065de0: 6564 4572 726f 7228 2243 7572 7265 6e74  edError("Current
-00065df0: 6c79 2c20 6f6e 6c79 206c 696e 6561 7220  ly, only linear 
-00065e00: 696e 7465 7270 6f6c 6174 696f 6e20 6973  interpolation is
-00065e10: 2069 6d70 6c65 6d65 6e74 6564 2e22 290a   implemented.").
-00065e20: 0a20 2020 2020 2020 2023 2052 6570 6c61  .        # Repla
-00065e30: 6365 2074 6865 2073 7065 6369 6669 6564  ce the specified
-00065e40: 2076 6f6c 756d 6520 7769 7468 2074 6865   volume with the
-00065e50: 2069 6e74 6572 706f 6c61 7465 6420 766f   interpolated vo
-00065e60: 6c75 6d65 0a20 2020 2020 2020 2074 696d  lume.        tim
-00065e70: 655f 7365 7269 6573 5f6e 705b 2e2e 2e2c  e_series_np[...,
-00065e80: 2076 6f6c 5f69 6478 5d20 3d20 696e 7465   vol_idx] = inte
-00065e90: 7270 6f6c 6174 6564 5f76 6f6c 756d 650a  rpolated_volume.
-00065ea0: 0a20 2020 2023 2043 6f6e 7665 7274 2074  .    # Convert t
-00065eb0: 6865 206e 756d 7079 2061 7272 6179 2062  he numpy array b
-00065ec0: 6163 6b20 746f 2041 4e54 7349 6d61 6765  ack to ANTsImage
-00065ed0: 0a20 2020 2069 6d70 7574 6564 5f74 696d  .    imputed_tim
-00065ee0: 655f 7365 7269 6573 203d 2061 6e74 732e  e_series = ants.
-00065ef0: 6672 6f6d 5f6e 756d 7079 2874 696d 655f  from_numpy(time_
-00065f00: 7365 7269 6573 5f6e 7029 0a20 2020 2069  series_np).    i
-00065f10: 6d70 7574 6564 5f74 696d 655f 7365 7269  mputed_time_seri
-00065f20: 6573 203d 2061 6e74 732e 636f 7079 5f69  es = ants.copy_i
-00065f30: 6d61 6765 5f69 6e66 6f28 7469 6d65 5f73  mage_info(time_s
-00065f40: 6572 6965 732c 2069 6d70 7574 6564 5f74  eries, imputed_t
-00065f50: 696d 655f 7365 7269 6573 290a 0a20 2020  ime_series)..   
-00065f60: 2072 6574 7572 6e20 696d 7075 7465 645f   return imputed_
-00065f70: 7469 6d65 5f73 6572 6965 730a 0a64 6566  time_series..def
-00065f80: 2069 6d70 7574 655f 6477 6928 2064 7769   impute_dwi( dwi
-00065f90: 2c20 7468 7265 7368 6f6c 6420 3d20 302e  , threshold = 0.
-00065fa0: 3230 2c20 696d 7075 7465 6230 3d46 616c  20, imputeb0=Fal
-00065fb0: 7365 2c20 6d61 736b 3d4e 6f6e 652c 2076  se, mask=None, v
-00065fc0: 6572 626f 7365 3d46 616c 7365 2029 3a0a  erbose=False ):.
-00065fd0: 2020 2020 2222 220a 2020 2020 4964 656e      """.    Iden
-00065fe0: 7469 6679 2062 6164 2076 6f6c 756d 6573  tify bad volumes
-00065ff0: 2069 6e20 6120 6477 6920 616e 6420 696d   in a dwi and im
-00066000: 7075 7465 2074 6865 6d20 6675 6c6c 7920  pute them fully 
-00066010: 6175 746f 6d61 7469 6361 6c6c 792e 0a0a  automatically...
-00066020: 2020 2020 3a70 6172 616d 2064 7769 3a20      :param dwi: 
-00066030: 414e 5473 496d 6167 6520 7265 7072 6573  ANTsImage repres
-00066040: 656e 7469 6e67 2074 6865 2074 696d 6520  enting the time 
-00066050: 7365 7269 6573 2028 3444 2069 6d61 6765  series (4D image
-00066060: 292e 0a20 2020 203a 7061 7261 6d20 7468  )..    :param th
-00066070: 7265 7368 6f6c 643a 2074 6872 6573 686f  reshold: thresho
-00066080: 6c64 2028 302c 3129 2066 6f72 206f 7574  ld (0,1) for out
-00066090: 6c69 6572 6e65 7373 2028 6c6f 7765 7220  lierness (lower 
-000660a0: 6d65 616e 7320 696d 7075 7465 206d 6f72  means impute mor
-000660b0: 6520 6461 7461 290a 2020 2020 3a70 6172  e data).    :par
-000660c0: 616d 2069 6d70 7574 6562 303a 2062 6f6f  am imputeb0: boo
-000660d0: 6c65 616e 2077 696c 6c20 696d 7075 7465  lean will impute
-000660e0: 2074 6865 2062 3020 7769 7468 2064 7769   the b0 with dwi
-000660f0: 2069 6620 5472 7565 0a20 2020 203a 7061   if True.    :pa
-00066100: 7261 6d20 6d61 736b 3a20 7265 7374 7269  ram mask: restri
-00066110: 6374 7320 746f 2061 2072 6567 696f 6e20  cts to a region 
-00066120: 6f66 2069 6e74 6572 6573 740a 2020 2020  of interest.    
-00066130: 3a70 6172 616d 2076 6572 626f 7365 3a20  :param verbose: 
-00066140: 626f 6f6c 6561 6e0a 2020 2020 3a72 6574  boolean.    :ret
-00066150: 7572 6e3a 2041 4e54 7349 6d61 6765 2061  urn: ANTsImage a
-00066160: 7574 6f6d 6174 6963 616c 6c79 2069 6d70  utomatically imp
-00066170: 7574 6564 2e0a 2020 2020 2222 220a 2020  uted..    """.  
-00066180: 2020 6c69 7374 3120 3d20 7365 676d 656e    list1 = segmen
-00066190: 745f 7469 6d65 7365 7269 6573 5f62 795f  t_timeseries_by_
-000661a0: 6d65 616e 7661 6c75 6528 2064 7769 2029  meanvalue( dwi )
-000661b0: 5b27 6869 6768 6572 6d65 616e 7327 5d0a  ['highermeans'].
-000661c0: 2020 2020 6966 2069 6d70 7574 6562 303a      if imputeb0:
-000661d0: 0a20 2020 2020 2020 2064 7769 6220 3d20  .        dwib = 
-000661e0: 696d 7075 7465 5f74 696d 6573 6572 6965  impute_timeserie
-000661f0: 7328 2064 7769 2c20 6c69 7374 3120 2920  s( dwi, list1 ) 
-00066200: 2320 666f 6375 7320 6f6e 2074 6865 2064  # focus on the d
-00066210: 7769 202d 206e 6f74 2074 6865 2062 300a  wi - not the b0.
-00066220: 2020 2020 2020 2020 6c6f 6f70 6564 2c20          looped, 
-00066230: 6c69 7374 3220 3d20 6c6f 6f70 5f74 696d  list2 = loop_tim
-00066240: 6573 6572 6965 735f 6365 6e73 6f72 696e  eseries_censorin
-00066250: 6728 2064 7769 622c 2074 6872 6573 686f  g( dwib, thresho
-00066260: 6c64 2c20 6d61 736b 2029 0a20 2020 2065  ld, mask ).    e
-00066270: 6c73 653a 0a20 2020 2020 2020 206c 6f6f  lse:.        loo
-00066280: 7065 642c 206c 6973 7432 203d 206c 6f6f  ped, list2 = loo
-00066290: 705f 7469 6d65 7365 7269 6573 5f63 656e  p_timeseries_cen
-000662a0: 736f 7269 6e67 2820 6477 692c 2074 6872  soring( dwi, thr
-000662b0: 6573 686f 6c64 2c20 6d61 736b 2029 0a20  eshold, mask ). 
-000662c0: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
-000662d0: 2020 2020 2020 2070 7269 6e74 2820 6c69         print( li
-000662e0: 7374 3120 290a 2020 2020 2020 2020 7072  st1 ).        pr
-000662f0: 696e 7428 206c 6973 7432 2029 0a20 2020  int( list2 ).   
-00066300: 2063 6f6d 706c 656d 656e 7420 3d20 7265   complement = re
-00066310: 6d6f 7665 5f65 6c65 6d65 6e74 735f 6672  move_elements_fr
-00066320: 6f6d 5f6c 6973 7428 206c 6973 7432 2c20  om_list( list2, 
-00066330: 6c69 7374 3120 290a 2020 2020 6966 2076  list1 ).    if v
-00066340: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-00066350: 7072 696e 7428 2022 496d 7075 7469 6e67  print( "Imputing
-00066360: 3a22 290a 2020 2020 2020 2020 7072 696e  :").        prin
-00066370: 7428 2063 6f6d 706c 656d 656e 7420 290a  t( complement ).
-00066380: 2020 2020 6966 206c 656e 2820 636f 6d70      if len( comp
-00066390: 6c65 6d65 6e74 2029 203d 3d20 303a 0a20  lement ) == 0:. 
-000663a0: 2020 2020 2020 2072 6574 7572 6e20 6477         return dw
-000663b0: 690a 2020 2020 7265 7475 726e 2069 6d70  i.    return imp
-000663c0: 7574 655f 7469 6d65 7365 7269 6573 2820  ute_timeseries( 
-000663d0: 6477 692c 2063 6f6d 706c 656d 656e 7420  dwi, complement 
-000663e0: 290a 0a64 6566 2063 656e 736f 725f 6477  )..def censor_dw
-000663f0: 6928 2064 7769 2c20 6276 616c 2c20 6276  i( dwi, bval, bv
-00066400: 6563 2c20 7468 7265 7368 6f6c 6420 3d20  ec, threshold = 
-00066410: 302e 3230 2c20 696d 7075 7465 6230 3d46  0.20, imputeb0=F
-00066420: 616c 7365 2c20 6d61 736b 3d4e 6f6e 652c  alse, mask=None,
-00066430: 2076 6572 626f 7365 3d46 616c 7365 2029   verbose=False )
-00066440: 3a0a 2020 2020 2222 220a 2020 2020 4964  :.    """.    Id
-00066450: 656e 7469 6679 2062 6164 2076 6f6c 756d  entify bad volum
-00066460: 6573 2069 6e20 6120 6477 6920 616e 6420  es in a dwi and 
-00066470: 696d 7075 7465 2074 6865 6d20 6675 6c6c  impute them full
-00066480: 7920 6175 746f 6d61 7469 6361 6c6c 792e  y automatically.
-00066490: 0a0a 2020 2020 3a70 6172 616d 2064 7769  ..    :param dwi
-000664a0: 3a20 414e 5473 496d 6167 6520 7265 7072  : ANTsImage repr
-000664b0: 6573 656e 7469 6e67 2074 6865 2074 696d  esenting the tim
-000664c0: 6520 7365 7269 6573 2028 3444 2069 6d61  e series (4D ima
-000664d0: 6765 292e 0a20 2020 203a 7061 7261 6d20  ge)..    :param 
-000664e0: 6276 616c 3a20 6276 616c 2061 7272 6179  bval: bval array
-000664f0: 0a20 2020 203a 7061 7261 6d20 6276 6563  .    :param bvec
-00066500: 3a20 6276 6563 2061 7272 6179 0a20 2020  : bvec array.   
-00066510: 203a 7061 7261 6d20 7468 7265 7368 6f6c   :param threshol
-00066520: 643a 2074 6872 6573 686f 6c64 2028 302c  d: threshold (0,
-00066530: 3129 2066 6f72 206f 7574 6c69 6572 6e65  1) for outlierne
-00066540: 7373 2028 6c6f 7765 7220 6d65 616e 7320  ss (lower means 
-00066550: 696d 7075 7465 206d 6f72 6520 6461 7461  impute more data
-00066560: 290a 2020 2020 3a70 6172 616d 2069 6d70  ).    :param imp
-00066570: 7574 6562 303a 2062 6f6f 6c65 616e 2077  uteb0: boolean w
-00066580: 696c 6c20 696d 7075 7465 2074 6865 2062  ill impute the b
-00066590: 3020 7769 7468 2064 7769 2069 6620 5472  0 with dwi if Tr
-000665a0: 7565 0a20 2020 203a 7061 7261 6d20 6d61  ue.    :param ma
-000665b0: 736b 3a20 7265 7374 7269 6374 7320 746f  sk: restricts to
-000665c0: 2061 2072 6567 696f 6e20 6f66 2069 6e74   a region of int
-000665d0: 6572 6573 740a 2020 2020 3a70 6172 616d  erest.    :param
-000665e0: 2076 6572 626f 7365 3a20 626f 6f6c 6561   verbose: boolea
-000665f0: 6e0a 2020 2020 3a72 6574 7572 6e3a 2041  n.    :return: A
-00066600: 4e54 7349 6d61 6765 2061 7574 6f6d 6174  NTsImage automat
-00066610: 6963 616c 6c79 2069 6d70 7574 6564 2e0a  ically imputed..
-00066620: 2020 2020 2222 220a 2020 2020 6c69 7374      """.    list
-00066630: 3120 3d20 7365 676d 656e 745f 7469 6d65  1 = segment_time
-00066640: 7365 7269 6573 5f62 795f 6d65 616e 7661  series_by_meanva
-00066650: 6c75 6528 2064 7769 2029 5b27 6869 6768  lue( dwi )['high
-00066660: 6572 6d65 616e 7327 5d0a 2020 2020 6966  ermeans'].    if
-00066670: 2069 6d70 7574 6562 303a 0a20 2020 2020   imputeb0:.     
-00066680: 2020 2064 7769 6220 3d20 696d 7075 7465     dwib = impute
-00066690: 5f74 696d 6573 6572 6965 7328 2064 7769  _timeseries( dwi
-000666a0: 2c20 6c69 7374 3120 2920 2320 666f 6375  , list1 ) # focu
-000666b0: 7320 6f6e 2074 6865 2064 7769 202d 206e  s on the dwi - n
-000666c0: 6f74 2074 6865 2062 300a 2020 2020 2020  ot the b0.      
-000666d0: 2020 6c6f 6f70 6564 2c20 6c69 7374 3220    looped, list2 
-000666e0: 3d20 6c6f 6f70 5f74 696d 6573 6572 6965  = loop_timeserie
-000666f0: 735f 6365 6e73 6f72 696e 6728 2064 7769  s_censoring( dwi
-00066700: 622c 2074 6872 6573 686f 6c64 2c20 6d61  b, threshold, ma
-00066710: 736b 2029 0a20 2020 2065 6c73 653a 0a20  sk ).    else:. 
-00066720: 2020 2020 2020 206c 6f6f 7065 642c 206c         looped, l
-00066730: 6973 7432 203d 206c 6f6f 705f 7469 6d65  ist2 = loop_time
-00066740: 7365 7269 6573 5f63 656e 736f 7269 6e67  series_censoring
-00066750: 2820 6477 692c 2074 6872 6573 686f 6c64  ( dwi, threshold
-00066760: 2c20 6d61 736b 2029 0a20 2020 2069 6620  , mask ).    if 
-00066770: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-00066780: 2070 7269 6e74 2820 6c69 7374 3120 290a   print( list1 ).
-00066790: 2020 2020 2020 2020 7072 696e 7428 206c          print( l
-000667a0: 6973 7432 2029 0a20 2020 2063 6f6d 706c  ist2 ).    compl
-000667b0: 656d 656e 7420 3d20 7265 6d6f 7665 5f65  ement = remove_e
-000667c0: 6c65 6d65 6e74 735f 6672 6f6d 5f6c 6973  lements_from_lis
-000667d0: 7428 206c 6973 7432 2c20 6c69 7374 3120  t( list2, list1 
-000667e0: 290a 2020 2020 6966 2076 6572 626f 7365  ).    if verbose
-000667f0: 3a0a 2020 2020 2020 2020 7072 696e 7428  :.        print(
-00066800: 2022 6365 6e73 6f72 696e 673a 2229 0a20   "censoring:"). 
-00066810: 2020 2020 2020 2070 7269 6e74 2820 636f         print( co
-00066820: 6d70 6c65 6d65 6e74 2029 0a20 2020 2069  mplement ).    i
-00066830: 6620 6c65 6e28 2063 6f6d 706c 656d 656e  f len( complemen
-00066840: 7420 2920 3d3d 2030 3a0a 2020 2020 2020  t ) == 0:.      
-00066850: 2020 7265 7475 726e 2064 7769 2c20 6276    return dwi, bv
-00066860: 616c 2c20 6276 6563 0a20 2020 2072 6574  al, bvec.    ret
-00066870: 7572 6e20 7265 6d6f 7665 5f76 6f6c 756d  urn remove_volum
-00066880: 6573 5f66 726f 6d5f 7469 6d65 7365 7269  es_from_timeseri
-00066890: 6573 2820 6477 692c 2063 6f6d 706c 656d  es( dwi, complem
-000668a0: 656e 7420 292c 2072 656d 6f76 655f 656c  ent ), remove_el
-000668b0: 656d 656e 7473 5f66 726f 6d5f 6e75 6d70  ements_from_nump
-000668c0: 795f 6172 7261 7928 2062 7661 6c2c 2063  y_array( bval, c
-000668d0: 6f6d 706c 656d 656e 7420 292c 2072 656d  omplement ), rem
-000668e0: 6f76 655f 656c 656d 656e 7473 5f66 726f  ove_elements_fro
-000668f0: 6d5f 6e75 6d70 795f 6172 7261 7928 2062  m_numpy_array( b
-00066900: 7665 632c 2063 6f6d 706c 656d 656e 7420  vec, complement 
-00066910: 290a 0a0a 6465 6620 666c 6174 7465 6e5f  )...def flatten_
-00066920: 7469 6d65 5f73 6572 6965 7328 7469 6d65  time_series(time
-00066930: 5f73 6572 6965 7329 3a0a 2020 2020 2222  _series):.    ""
-00066940: 220a 2020 2020 466c 6174 7465 6e20 6120  ".    Flatten a 
-00066950: 3444 2074 696d 6520 7365 7269 6573 2069  4D time series i
-00066960: 6e74 6f20 6120 3244 2061 7272 6179 2e0a  nto a 2D array..
-00066970: 2020 2020 0a20 2020 203a 7061 7261 6d20      .    :param 
-00066980: 7469 6d65 5f73 6572 6965 733a 2041 2034  time_series: A 4
-00066990: 4420 6e75 6d70 7920 6172 7261 7920 7768  D numpy array wh
-000669a0: 6572 6520 7468 6520 6c61 7374 2064 696d  ere the last dim
-000669b0: 656e 7369 6f6e 2069 7320 7469 6d65 2e0a  ension is time..
-000669c0: 2020 2020 3a72 6574 7572 6e3a 2041 2032      :return: A 2
-000669d0: 4420 6e75 6d70 7920 6172 7261 7920 7768  D numpy array wh
-000669e0: 6572 6520 6561 6368 2072 6f77 2069 7320  ere each row is 
-000669f0: 6120 666c 6174 7465 6e65 6420 766f 6c75  a flattened volu
-00066a00: 6d65 2e0a 2020 2020 2222 220a 2020 2020  me..    """.    
-00066a10: 6e5f 766f 6c75 6d65 7320 3d20 7469 6d65  n_volumes = time
-00066a20: 5f73 6572 6965 732e 7368 6170 655b 335d  _series.shape[3]
-00066a30: 0a20 2020 2072 6574 7572 6e20 7469 6d65  .    return time
-00066a40: 5f73 6572 6965 732e 7265 7368 6170 6528  _series.reshape(
-00066a50: 2d31 2c20 6e5f 766f 6c75 6d65 7329 2e54  -1, n_volumes).T
-00066a60: 0a0a 6465 6620 6361 6c63 756c 6174 655f  ..def calculate_
-00066a70: 6c6f 6f70 5f73 636f 7265 7328 666c 6174  loop_scores(flat
-00066a80: 7465 6e65 645f 7365 7269 6573 2c20 6e5f  tened_series, n_
-00066a90: 6e65 6967 6862 6f72 733d 3230 293a 0a20  neighbors=20):. 
-00066aa0: 2020 2022 2222 0a20 2020 2043 616c 6375     """.    Calcu
-00066ab0: 6c61 7465 204c 6f63 616c 204f 7574 6c69  late Local Outli
-00066ac0: 6572 2050 726f 6261 6269 6c69 7469 6573  er Probabilities
-00066ad0: 2066 6f72 2065 6163 6820 766f 6c75 6d65   for each volume
-00066ae0: 2e0a 2020 2020 0a20 2020 203a 7061 7261  ..    .    :para
-00066af0: 6d20 666c 6174 7465 6e65 645f 7365 7269  m flattened_seri
-00066b00: 6573 3a20 4120 3244 206e 756d 7079 2061  es: A 2D numpy a
-00066b10: 7272 6179 2066 726f 6d20 666c 6174 7465  rray from flatte
-00066b20: 6e5f 7469 6d65 5f73 6572 6965 732e 0a20  n_time_series.. 
-00066b30: 2020 203a 7061 7261 6d20 6e5f 6e65 6967     :param n_neig
-00066b40: 6862 6f72 733a 204e 756d 6265 7220 6f66  hbors: Number of
-00066b50: 206e 6569 6768 626f 7273 2074 6f20 7573   neighbors to us
-00066b60: 6520 666f 7220 6361 6c63 756c 6174 696e  e for calculatin
-00066b70: 6720 4c4f 4620 7363 6f72 6573 2e0a 2020  g LOF scores..  
-00066b80: 2020 3a72 6574 7572 6e3a 2041 6e20 6172    :return: An ar
-00066b90: 7261 7920 6f66 204c 6f4f 5020 7363 6f72  ray of LoOP scor
-00066ba0: 6573 2e0a 2020 2020 2222 220a 2020 2020  es..    """.    
-00066bb0: 6672 6f6d 2050 794e 6f6d 616c 7920 696d  from PyNomaly im
-00066bc0: 706f 7274 206c 6f6f 700a 2020 2020 6672  port loop.    fr
-00066bd0: 6f6d 2073 6b6c 6561 726e 2e6e 6569 6768  om sklearn.neigh
-00066be0: 626f 7273 2069 6d70 6f72 7420 4e65 6172  bors import Near
-00066bf0: 6573 744e 6569 6768 626f 7273 0a20 2020  estNeighbors.   
-00066c00: 2066 726f 6d20 736b 6c65 6172 6e2e 7072   from sklearn.pr
-00066c10: 6570 726f 6365 7373 696e 6720 696d 706f  eprocessing impo
-00066c20: 7274 2053 7461 6e64 6172 6453 6361 6c65  rt StandardScale
-00066c30: 720a 2020 2020 2320 7265 706c 6163 6520  r.    # replace 
-00066c40: 6e61 6e73 2077 6974 6820 7a65 726f 0a20  nans with zero. 
-00066c50: 2020 2066 6c61 7474 656e 6564 5f73 6572     flattened_ser
-00066c60: 6965 733d 6e70 2e6e 616e 5f74 6f5f 6e75  ies=np.nan_to_nu
-00066c70: 6d28 666c 6174 7465 6e65 645f 7365 7269  m(flattened_seri
-00066c80: 6573 2c20 6e61 6e3d 3029 0a20 2020 2073  es, nan=0).    s
-00066c90: 6361 6c65 7220 3d20 5374 616e 6461 7264  caler = Standard
-00066ca0: 5363 616c 6572 2829 0a20 2020 2073 6361  Scaler().    sca
-00066cb0: 6c65 722e 6669 7428 666c 6174 7465 6e65  ler.fit(flattene
-00066cc0: 645f 7365 7269 6573 290a 2020 2020 6461  d_series).    da
-00066cd0: 7461 203d 2073 6361 6c65 722e 7472 616e  ta = scaler.tran
-00066ce0: 7366 6f72 6d28 666c 6174 7465 6e65 645f  sform(flattened_
-00066cf0: 7365 7269 6573 290a 2020 2020 6461 7461  series).    data
-00066d00: 3d6e 702e 6e61 6e5f 746f 5f6e 756d 2864  =np.nan_to_num(d
-00066d10: 6174 612c 206e 616e 3d30 290a 2020 2020  ata, nan=0).    
-00066d20: 6966 206e 5f6e 6569 6768 626f 7273 203e  if n_neighbors >
-00066d30: 2069 6e74 2866 6c61 7474 656e 6564 5f73   int(flattened_s
-00066d40: 6572 6965 732e 7368 6170 655b 305d 2f32  eries.shape[0]/2
-00066d50: 2e30 293a 0a20 2020 2020 2020 206e 5f6e  .0):.        n_n
-00066d60: 6569 6768 626f 7273 203d 2069 6e74 2866  eighbors = int(f
-00066d70: 6c61 7474 656e 6564 5f73 6572 6965 732e  lattened_series.
-00066d80: 7368 6170 655b 305d 2f32 2e30 290a 2020  shape[0]/2.0).  
-00066d90: 2020 6e65 6967 6820 3d20 4e65 6172 6573    neigh = Neares
-00066da0: 744e 6569 6768 626f 7273 286e 5f6e 6569  tNeighbors(n_nei
-00066db0: 6768 626f 7273 3d6e 5f6e 6569 6768 626f  ghbors=n_neighbo
-00066dc0: 7273 2c20 6d65 7472 6963 3d27 6d69 6e6b  rs, metric='mink
-00066dd0: 6f77 736b 6927 290a 2020 2020 6e65 6967  owski').    neig
-00066de0: 682e 6669 7428 6461 7461 290a 2020 2020  h.fit(data).    
-00066df0: 642c 2069 6478 203d 206e 6569 6768 2e6b  d, idx = neigh.k
-00066e00: 6e65 6967 6862 6f72 7328 6461 7461 2c20  neighbors(data, 
-00066e10: 7265 7475 726e 5f64 6973 7461 6e63 653d  return_distance=
-00066e20: 5472 7565 290a 2020 2020 6d20 3d20 6c6f  True).    m = lo
-00066e30: 6f70 2e4c 6f63 616c 4f75 746c 6965 7250  op.LocalOutlierP
-00066e40: 726f 6261 6269 6c69 7479 2864 6973 7461  robability(dista
-00066e50: 6e63 655f 6d61 7472 6978 3d64 2c20 6e65  nce_matrix=d, ne
-00066e60: 6967 6862 6f72 5f6d 6174 7269 783d 6964  ighbor_matrix=id
-00066e70: 782c 206e 5f6e 6569 6768 626f 7273 3d6e  x, n_neighbors=n
-00066e80: 5f6e 6569 6768 626f 7273 292e 6669 7428  _neighbors).fit(
-00066e90: 290a 2020 2020 7265 7475 726e 206d 2e6c  ).    return m.l
-00066ea0: 6f63 616c 5f6f 7574 6c69 6572 5f70 726f  ocal_outlier_pro
-00066eb0: 6261 6269 6c69 7469 6573 5b3a 5d0a 0a64  babilities[:]..d
-00066ec0: 6566 2073 636f 7265 5f66 6d72 695f 6365  ef score_fmri_ce
-00066ed0: 6e73 6f72 696e 6728 6362 6674 732c 2063  nsoring(cbfts, c
-00066ee0: 7366 5f73 6567 2c20 676d 5f73 6567 2c20  sf_seg, gm_seg, 
-00066ef0: 776d 5f73 6567 2029 3a0a 2020 2020 2222  wm_seg ):.    ""
-00066f00: 220a 2020 2020 5072 6f63 6573 7320 4342  ".    Process CB
-00066f10: 4620 7469 6d65 2073 6572 6965 7320 746f  F time series to
-00066f20: 2072 656d 6f76 6520 6869 6768 2d6c 6576   remove high-lev
-00066f30: 6572 6167 6520 706f 696e 7473 2e0a 2020  erage points..  
-00066f40: 2020 4465 7269 7665 6420 6672 6f6d 2074    Derived from t
-00066f50: 6865 2053 434f 5245 2061 6c67 6f72 6974  he SCORE algorit
-00066f60: 686d 2062 7920 5375 6469 7074 6f20 446f  hm by Sudipto Do
-00066f70: 6c75 6920 6574 2e20 616c 2e0a 0a20 2020  lui et. al...   
-00066f80: 2050 6172 616d 6574 6572 733a 0a20 2020   Parameters:.   
-00066f90: 2063 6266 7473 2028 414e 5473 496d 6167   cbfts (ANTsImag
-00066fa0: 6529 3a20 3444 2041 4e54 7349 6d61 6765  e): 4D ANTsImage
-00066fb0: 206f 6620 4342 4620 7469 6d65 2073 6572   of CBF time ser
-00066fc0: 6965 732e 0a20 2020 2063 7366 5f73 6567  ies..    csf_seg
-00066fd0: 2028 414e 5473 496d 6167 6529 3a20 4353   (ANTsImage): CS
-00066fe0: 4620 6269 6e61 7279 206d 6170 2e0a 2020  F binary map..  
-00066ff0: 2020 676d 5f73 6567 2028 414e 5473 496d    gm_seg (ANTsIm
-00067000: 6167 6529 3a20 4772 6179 206d 6174 7465  age): Gray matte
-00067010: 7220 6269 6e61 7279 206d 6170 2e0a 2020  r binary map..  
-00067020: 2020 776d 5f73 6567 2028 414e 5473 496d    wm_seg (ANTsIm
-00067030: 6167 6529 3a20 574d 2062 696e 6172 7920  age): WM binary 
-00067040: 6d61 702e 0a0a 2020 2020 5265 7475 726e  map...    Return
-00067050: 733a 0a20 2020 2041 4e54 7349 6d61 6765  s:.    ANTsImage
-00067060: 3a20 5072 6f63 6573 7365 6420 4342 4620  : Processed CBF 
-00067070: 7469 6d65 2073 6572 6965 732e 0a20 2020  time series..   
-00067080: 206e 6461 7272 6179 3a20 496e 6465 7820   ndarray: Index 
-00067090: 6f66 2072 656d 6f76 6564 2076 6f6c 756d  of removed volum
-000670a0: 6573 2e0a 2020 2020 2222 220a 2020 2020  es..    """.    
-000670b0: 0a20 2020 206e 5f67 6d5f 766f 7865 6c73  .    n_gm_voxels
-000670c0: 203d 206e 702e 7375 6d28 676d 5f73 6567   = np.sum(gm_seg
-000670d0: 2e6e 756d 7079 2829 2920 2d20 310a 2020  .numpy()) - 1.  
-000670e0: 2020 6e5f 776d 5f76 6f78 656c 7320 3d20    n_wm_voxels = 
-000670f0: 6e70 2e73 756d 2877 6d5f 7365 672e 6e75  np.sum(wm_seg.nu
-00067100: 6d70 7928 2929 202d 2031 0a20 2020 206e  mpy()) - 1.    n
-00067110: 5f63 7366 5f76 6f78 656c 7320 3d20 6e70  _csf_voxels = np
-00067120: 2e73 756d 2863 7366 5f73 6567 2e6e 756d  .sum(csf_seg.num
-00067130: 7079 2829 2920 2d20 310a 2020 2020 6d61  py()) - 1.    ma
-00067140: 736b 3169 6d67 203d 2067 6d5f 7365 6720  sk1img = gm_seg 
-00067150: 2b20 776d 5f73 6567 202b 2063 7366 5f73  + wm_seg + csf_s
-00067160: 6567 0a20 2020 206d 6173 6b31 203d 2028  eg.    mask1 = (
-00067170: 6d61 736b 3169 6d67 3d3d 3129 2e6e 756d  mask1img==1).num
-00067180: 7079 2829 0a20 2020 200a 2020 2020 6362  py().    .    cb
-00067190: 6674 735f 6e70 203d 2063 6266 7473 2e6e  fts_np = cbfts.n
-000671a0: 756d 7079 2829 0a20 2020 2067 6d62 6f6f  umpy().    gmboo
-000671b0: 6c20 3d20 2867 6d5f 7365 673d 3d31 292e  l = (gm_seg==1).
-000671c0: 6e75 6d70 7928 290a 2020 2020 6373 6662  numpy().    csfb
-000671d0: 6f6f 6c20 3d20 2863 7366 5f73 6567 3d3d  ool = (csf_seg==
-000671e0: 3129 2e6e 756d 7079 2829 0a20 2020 2077  1).numpy().    w
-000671f0: 6d62 6f6f 6c20 3d20 2877 6d5f 7365 673d  mbool = (wm_seg=
-00067200: 3d31 292e 6e75 6d70 7928 290a 2020 2020  =1).numpy().    
-00067210: 676d 5f63 6266 5f74 7320 3d20 616e 7473  gm_cbf_ts = ants
-00067220: 2e74 696d 6573 6572 6965 735f 746f 5f6d  .timeseries_to_m
-00067230: 6174 7269 7828 2063 6266 7473 2c20 676d  atrix( cbfts, gm
-00067240: 5f73 6567 2029 0a20 2020 2067 6d5f 6362  _seg ).    gm_cb
-00067250: 665f 7473 203d 206e 702e 7371 7565 657a  f_ts = np.squeez
-00067260: 6528 6e70 2e6d 6561 6e28 676d 5f63 6266  e(np.mean(gm_cbf
-00067270: 5f74 732c 2061 7869 733d 3129 290a 2020  _ts, axis=1)).  
-00067280: 2020 0a20 2020 206d 6564 6961 6e5f 676d    .    median_gm
-00067290: 5f63 6266 203d 206e 702e 6d65 6469 616e  _cbf = np.median
-000672a0: 2867 6d5f 6362 665f 7473 290a 2020 2020  (gm_cbf_ts).    
-000672b0: 6d61 645f 676d 5f63 6266 203d 206e 702e  mad_gm_cbf = np.
-000672c0: 6d65 6469 616e 286e 702e 6162 7328 676d  median(np.abs(gm
-000672d0: 5f63 6266 5f74 7320 2d20 6d65 6469 616e  _cbf_ts - median
-000672e0: 5f67 6d5f 6362 6629 2920 2f20 302e 3637  _gm_cbf)) / 0.67
-000672f0: 350a 2020 2020 696e 6478 203d 206e 702e  5.    indx = np.
-00067300: 6162 7328 676d 5f63 6266 5f74 7320 2d20  abs(gm_cbf_ts - 
-00067310: 6d65 6469 616e 5f67 6d5f 6362 6629 203e  median_gm_cbf) >
-00067320: 2028 322e 3520 2a20 6d61 645f 676d 5f63   (2.5 * mad_gm_c
-00067330: 6266 290a 2020 2020 0a20 2020 2023 2074  bf).    .    # t
-00067340: 6865 2073 7061 7469 616c 206d 6561 6e0a  he spatial mean.
-00067350: 2020 2020 7370 6174 6d65 616e 6e70 203d      spatmeannp =
-00067360: 206e 702e 6d65 616e 2863 6266 7473 5f6e   np.mean(cbfts_n
-00067370: 705b 3a2c 203a 2c20 3a2c 207e 696e 6478  p[:, :, :, ~indx
-00067380: 5d2c 2061 7869 733d 3329 0a20 2020 2073  ], axis=3).    s
-00067390: 7061 746d 6561 6e20 3d20 616e 7473 2e66  patmean = ants.f
-000673a0: 726f 6d5f 6e75 6d70 7928 2073 7061 746d  rom_numpy( spatm
-000673b0: 6561 6e6e 7020 290a 2020 2020 5620 3d20  eannp ).    V = 
-000673c0: 280a 2020 2020 2020 2020 6e5f 676d 5f76  (.        n_gm_v
-000673d0: 6f78 656c 7320 2a20 6e70 2e76 6172 2873  oxels * np.var(s
-000673e0: 7061 746d 6561 6e6e 705b 676d 626f 6f6c  patmeannp[gmbool
-000673f0: 5d29 0a20 2020 2020 2020 202b 206e 5f77  ]).        + n_w
-00067400: 6d5f 766f 7865 6c73 202a 206e 702e 7661  m_voxels * np.va
-00067410: 7228 7370 6174 6d65 616e 6e70 5b77 6d62  r(spatmeannp[wmb
-00067420: 6f6f 6c5d 290a 2020 2020 2020 2020 2b20  ool]).        + 
-00067430: 6e5f 6373 665f 766f 7865 6c73 202a 206e  n_csf_voxels * n
-00067440: 702e 7661 7228 7370 6174 6d65 616e 6e70  p.var(spatmeannp
-00067450: 5b63 7366 626f 6f6c 5d29 0a20 2020 2029  [csfbool]).    )
-00067460: 0a20 2020 2056 3120 3d20 6d61 7468 2e69  .    V1 = math.i
-00067470: 6e66 0a20 2020 2063 743d 300a 2020 2020  nf.    ct=0.    
-00067480: 7768 696c 6520 5620 3c20 5631 3a0a 2020  while V < V1:.  
-00067490: 2020 2020 2020 6374 3d63 742b 310a 2020        ct=ct+1.  
-000674a0: 2020 2020 2020 5631 203d 2056 0a20 2020        V1 = V.   
-000674b0: 2020 2020 2043 4320 3d20 6e70 2e7a 6572       CC = np.zer
-000674c0: 6f73 2863 6266 7473 5f6e 702e 7368 6170  os(cbfts_np.shap
-000674d0: 655b 335d 290a 2020 2020 2020 2020 666f  e[3]).        fo
-000674e0: 7220 7320 696e 2072 616e 6765 2863 6266  r s in range(cbf
-000674f0: 7473 5f6e 702e 7368 6170 655b 335d 293a  ts_np.shape[3]):
-00067500: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00067510: 696e 6478 5b73 5d3a 0a20 2020 2020 2020  indx[s]:.       
-00067520: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-00067530: 650a 2020 2020 2020 2020 2020 2020 746d  e.            tm
-00067540: 7031 203d 2061 6e74 732e 6672 6f6d 5f6e  p1 = ants.from_n
-00067550: 756d 7079 2820 6362 6674 735f 6e70 5b3a  umpy( cbfts_np[:
-00067560: 2c20 3a2c 203a 2c20 735d 2029 0a20 2020  , :, :, s] ).   
-00067570: 2020 2020 2020 2020 2043 435b 735d 203d           CC[s] =
-00067580: 2061 6e74 732e 696d 6167 655f 7369 6d69   ants.image_simi
-00067590: 6c61 7269 7479 2820 7370 6174 6d65 616e  larity( spatmean
-000675a0: 2c20 746d 7031 2c20 6d65 7472 6963 5f74  , tmp1, metric_t
-000675b0: 7970 653d 2743 6f72 7265 6c61 7469 6f6e  ype='Correlation
-000675c0: 272c 2066 6978 6564 5f6d 6173 6b3d 6d61  ', fixed_mask=ma
-000675d0: 736b 3169 6d67 2029 0a20 2020 2020 2020  sk1img ).       
-000675e0: 2069 6e78 203d 206e 702e 6172 676d 696e   inx = np.argmin
-000675f0: 2843 4329 0a20 2020 2020 2020 2069 6e64  (CC).        ind
-00067600: 785b 696e 785d 203d 2054 7275 650a 2020  x[inx] = True.  
-00067610: 2020 2020 2020 7370 6174 6d65 616e 6e70        spatmeannp
-00067620: 203d 206e 702e 6d65 616e 2863 6266 7473   = np.mean(cbfts
-00067630: 5f6e 705b 3a2c 203a 2c20 3a2c 207e 696e  _np[:, :, :, ~in
-00067640: 6478 5d2c 2061 7869 733d 3329 0a20 2020  dx], axis=3).   
-00067650: 2020 2020 2073 7061 746d 6561 6e20 3d20       spatmean = 
-00067660: 616e 7473 2e66 726f 6d5f 6e75 6d70 7928  ants.from_numpy(
-00067670: 2073 7061 746d 6561 6e6e 7020 290a 2020   spatmeannp ).  
-00067680: 2020 2020 2020 5620 3d20 280a 2020 2020        V = (.    
-00067690: 2020 2020 2020 6e5f 676d 5f76 6f78 656c        n_gm_voxel
-000676a0: 7320 2a20 6e70 2e76 6172 2873 7061 746d  s * np.var(spatm
-000676b0: 6561 6e6e 705b 676d 626f 6f6c 5d29 202b  eannp[gmbool]) +
-000676c0: 200a 2020 2020 2020 2020 2020 6e5f 776d   .          n_wm
-000676d0: 5f76 6f78 656c 7320 2a20 6e70 2e76 6172  _voxels * np.var
-000676e0: 2873 7061 746d 6561 6e6e 705b 776d 626f  (spatmeannp[wmbo
-000676f0: 6f6c 5d29 202b 200a 2020 2020 2020 2020  ol]) + .        
-00067700: 2020 6e5f 6373 665f 766f 7865 6c73 202a    n_csf_voxels *
-00067710: 206e 702e 7661 7228 7370 6174 6d65 616e   np.var(spatmean
-00067720: 6e70 5b63 7366 626f 6f6c 5d29 0a20 2020  np[csfbool]).   
-00067730: 2020 2020 2029 0a20 2020 2063 6266 7473       ).    cbfts
-00067740: 5f72 6563 6f6e 203d 2063 6266 7473 5f6e  _recon = cbfts_n
-00067750: 705b 3a2c 203a 2c20 3a2c 207e 696e 6478  p[:, :, :, ~indx
-00067760: 5d0a 2020 2020 6362 6674 735f 7265 636f  ].    cbfts_reco
-00067770: 6e20 3d20 6e70 2e6e 616e 5f74 6f5f 6e75  n = np.nan_to_nu
-00067780: 6d28 6362 6674 735f 7265 636f 6e29 0a20  m(cbfts_recon). 
-00067790: 2020 2063 6266 7473 5f72 6563 6f6e 5f61     cbfts_recon_a
-000677a0: 6e74 7320 3d20 616e 7473 2e66 726f 6d5f  nts = ants.from_
-000677b0: 6e75 6d70 7928 6362 6674 735f 7265 636f  numpy(cbfts_reco
-000677c0: 6e29 0a20 2020 2063 6266 7473 5f72 6563  n).    cbfts_rec
-000677d0: 6f6e 5f61 6e74 7320 3d20 616e 7473 2e63  on_ants = ants.c
-000677e0: 6f70 795f 696d 6167 655f 696e 666f 2863  opy_image_info(c
-000677f0: 6266 7473 2c20 6362 6674 735f 7265 636f  bfts, cbfts_reco
-00067800: 6e5f 616e 7473 290a 2020 2020 7265 7475  n_ants).    retu
-00067810: 726e 2063 6266 7473 5f72 6563 6f6e 5f61  rn cbfts_recon_a
-00067820: 6e74 732c 2069 6e64 780a 0a64 6566 206c  nts, indx..def l
-00067830: 6f6f 705f 7469 6d65 7365 7269 6573 5f63  oop_timeseries_c
-00067840: 656e 736f 7269 6e67 2878 2c20 7468 7265  ensoring(x, thre
-00067850: 7368 6f6c 643d 302e 352c 206d 6173 6b3d  shold=0.5, mask=
-00067860: 4e6f 6e65 2c20 7665 7262 6f73 653d 4661  None, verbose=Fa
-00067870: 6c73 6529 3a0a 2020 2020 2222 220a 2020  lse):.    """.  
-00067880: 2020 4365 6e73 6f72 2068 6967 6820 6c65    Censor high le
-00067890: 7665 7261 6765 2076 6f6c 756d 6573 2066  verage volumes f
-000678a0: 726f 6d20 6120 7469 6d65 2073 6572 6965  rom a time serie
-000678b0: 7320 7573 696e 6720 4c6f 6361 6c20 4f75  s using Local Ou
-000678c0: 746c 6965 7220 5072 6f62 6162 696c 6974  tlier Probabilit
-000678d0: 6965 7320 284c 6f4f 5029 2e0a 0a20 2020  ies (LoOP)...   
-000678e0: 2050 6172 616d 6574 6572 733a 0a20 2020   Parameters:.   
-000678f0: 2078 2028 414e 5473 496d 6167 6529 3a20   x (ANTsImage): 
-00067900: 4120 3444 2074 696d 6520 7365 7269 6573  A 4D time series
-00067910: 2069 6d61 6765 2e0a 2020 2020 7468 7265   image..    thre
-00067920: 7368 6f6c 6420 2866 6c6f 6174 293a 2054  shold (float): T
-00067930: 6872 6573 686f 6c64 2066 6f72 2064 6574  hreshold for det
-00067940: 6572 6d69 6e69 6e67 2068 6967 6820 6c65  ermining high le
-00067950: 7665 7261 6765 2076 6f6c 756d 6573 2062  verage volumes b
-00067960: 6173 6564 206f 6e20 4c6f 4f50 2073 636f  ased on LoOP sco
-00067970: 7265 732e 0a20 2020 206d 6173 6b20 2861  res..    mask (a
-00067980: 6e74 7349 6d61 6765 293a 2072 6573 7472  ntsImage): restr
-00067990: 6963 7473 2074 6f20 6120 524f 490a 2020  icts to a ROI.  
-000679a0: 2020 7665 7262 6f73 6520 2862 6f6f 6c29    verbose (bool)
-000679b0: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
-000679c0: 2020 2074 7570 6c65 3a20 4120 7475 706c     tuple: A tupl
-000679d0: 6520 636f 6e74 6169 6e69 6e67 2074 6865  e containing the
-000679e0: 2063 656e 736f 7265 6420 7469 6d65 2073   censored time s
-000679f0: 6572 6965 7320 2841 4e54 7349 6d61 6765  eries (ANTsImage
-00067a00: 2920 616e 6420 7468 6520 696e 6469 6365  ) and the indice
-00067a10: 7320 6f66 2074 6865 2068 6967 6820 6c65  s of the high le
-00067a20: 7665 7261 6765 2076 6f6c 756d 6573 2e0a  verage volumes..
-00067a30: 2020 2020 2222 220a 2020 2020 696d 706f      """.    impo
-00067a40: 7274 2077 6172 6e69 6e67 730a 2020 2020  rt warnings.    
-00067a50: 6966 2078 2e73 6861 7065 5b33 5d20 3c20  if x.shape[3] < 
-00067a60: 3230 3a20 2320 6a75 7374 2061 2067 7565  20: # just a gue
-00067a70: 7373 2061 7420 7768 6174 2077 6520 6e65  ss at what we ne
-00067a80: 6564 2068 6572 6520 2e2e 2e0a 2020 2020  ed here ....    
-00067a90: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
-00067aa0: 6e28 2257 6172 6e69 6e67 3a20 7468 6520  n("Warning: the 
-00067ab0: 7469 6d65 2064 696d 656e 7369 6f6e 2069  time dimension i
-00067ac0: 7320 3c20 3230 202d 2074 6f6f 2066 6577  s < 20 - too few
-00067ad0: 2073 616d 706c 6573 2066 6f72 206c 6f6f   samples for loo
-00067ae0: 702e 206a 7573 7420 7265 7475 726e 2074  p. just return t
-00067af0: 6865 206f 7269 6769 6e61 6c20 6461 7461  he original data
-00067b00: 2e22 290a 2020 2020 2020 2020 7265 7475  .").        retu
-00067b10: 726e 2078 2c20 5b5d 0a20 2020 2069 6620  rn x, [].    if 
-00067b20: 6d61 736b 2069 7320 4e6f 6e65 3a0a 2020  mask is None:.  
-00067b30: 2020 2020 2020 666c 6174 7465 6e65 645f        flattened_
-00067b40: 7365 7269 6573 203d 2066 6c61 7474 656e  series = flatten
-00067b50: 5f74 696d 655f 7365 7269 6573 2878 2e6e  _time_series(x.n
-00067b60: 756d 7079 2829 290a 2020 2020 656c 7365  umpy()).    else
-00067b70: 3a0a 2020 2020 2020 2020 666c 6174 7465  :.        flatte
-00067b80: 6e65 645f 7365 7269 6573 203d 2061 6e74  ned_series = ant
-00067b90: 732e 7469 6d65 7365 7269 6573 5f74 6f5f  s.timeseries_to_
-00067ba0: 6d61 7472 6978 2820 782c 206d 6173 6b20  matrix( x, mask 
-00067bb0: 290a 2020 2020 6c6f 6f70 5f73 636f 7265  ).    loop_score
-00067bc0: 7320 3d20 6361 6c63 756c 6174 655f 6c6f  s = calculate_lo
-00067bd0: 6f70 5f73 636f 7265 7328 666c 6174 7465  op_scores(flatte
-00067be0: 6e65 645f 7365 7269 6573 290a 2020 2020  ned_series).    
-00067bf0: 6869 6768 5f6c 6576 6572 6167 655f 766f  high_leverage_vo
-00067c00: 6c75 6d65 7320 3d20 6e70 2e77 6865 7265  lumes = np.where
-00067c10: 286c 6f6f 705f 7363 6f72 6573 203e 2074  (loop_scores > t
-00067c20: 6872 6573 686f 6c64 295b 305d 0a20 2020  hreshold)[0].   
-00067c30: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
-00067c40: 2020 2020 2070 7269 6e74 2822 4c4f 4f50       print("LOOP
-00067c50: 2048 6967 6820 4c65 7665 7261 6765 2056   High Leverage V
-00067c60: 6f6c 756d 6573 3a22 2c20 6869 6768 5f6c  olumes:", high_l
-00067c70: 6576 6572 6167 655f 766f 6c75 6d65 7329  everage_volumes)
-00067c80: 0a20 2020 206e 6577 5f61 736c 203d 2072  .    new_asl = r
-00067c90: 656d 6f76 655f 766f 6c75 6d65 735f 6672  emove_volumes_fr
-00067ca0: 6f6d 5f74 696d 6573 6572 6965 7328 782c  om_timeseries(x,
-00067cb0: 2068 6967 685f 6c65 7665 7261 6765 5f76   high_leverage_v
-00067cc0: 6f6c 756d 6573 290a 2020 2020 7265 7475  olumes).    retu
-00067cd0: 726e 206e 6577 5f61 736c 2c20 6869 6768  rn new_asl, high
-00067ce0: 5f6c 6576 6572 6167 655f 766f 6c75 6d65  _leverage_volume
-00067cf0: 730a 0a0a 6465 6620 6e6f 7665 6c74 795f  s...def novelty_
-00067d00: 6465 7465 6374 696f 6e5f 6565 2864 665f  detection_ee(df_
-00067d10: 7472 6169 6e2c 2064 665f 7465 7374 2c20  train, df_test, 
-00067d20: 636f 6e74 616d 696e 6174 696f 6e3d 302e  contamination=0.
-00067d30: 3035 293a 0a20 2020 2022 2222 0a20 2020  05):.    """.   
-00067d40: 2054 6869 7320 6675 6e63 7469 6f6e 2070   This function p
-00067d50: 6572 666f 726d 7320 6e6f 7665 6c74 7920  erforms novelty 
-00067d60: 6465 7465 6374 696f 6e20 7573 696e 6720  detection using 
-00067d70: 456c 6c69 7074 6963 2045 6e76 656c 6f70  Elliptic Envelop
-00067d80: 652e 0a0a 2020 2020 5061 7261 6d65 7465  e...    Paramete
-00067d90: 7273 3a0a 0a20 2020 202d 2064 665f 7472  rs:..    - df_tr
-00067da0: 6169 6e20 2870 616e 6461 7320 6461 7461  ain (pandas data
-00067db0: 6672 616d 6529 3a20 7472 6169 6e69 6e67  frame): training
-00067dc0: 2064 6174 6120 7573 6564 2074 6f20 6669   data used to fi
-00067dd0: 7420 7468 6520 6d6f 6465 6c0a 0a20 2020  t the model..   
-00067de0: 202d 2064 665f 7465 7374 2028 7061 6e64   - df_test (pand
-00067df0: 6173 2064 6174 6166 7261 6d65 293a 2074  as dataframe): t
-00067e00: 6573 7420 6461 7461 2075 7365 6420 746f  est data used to
-00067e10: 2070 7265 6469 6374 206e 6f76 656c 7469   predict novelti
-00067e20: 6573 0a0a 2020 2020 2d20 636f 6e74 616d  es..    - contam
-00067e30: 696e 6174 696f 6e20 2866 6c6f 6174 293a  ination (float):
-00067e40: 2070 6172 616d 6574 6572 2063 6f6e 7472   parameter contr
-00067e50: 6f6c 6c69 6e67 2074 6865 2070 726f 706f  olling the propo
-00067e60: 7274 696f 6e20 6f66 206f 7574 6c69 6572  rtion of outlier
-00067e70: 7320 696e 2074 6865 2064 6174 6120 2864  s in the data (d
-00067e80: 6566 6175 6c74 3a20 302e 3035 290a 0a20  efault: 0.05).. 
-00067e90: 2020 2052 6574 7572 6e73 3a0a 0a20 2020     Returns:..   
-00067ea0: 2070 7265 6469 6374 696f 6e73 2028 7061   predictions (pa
-00067eb0: 6e64 6173 2073 6572 6965 7329 3a20 7072  ndas series): pr
-00067ec0: 6564 6963 7465 6420 6c61 6265 6c73 2066  edicted labels f
-00067ed0: 6f72 2074 6865 2074 6573 7420 6461 7461  or the test data
-00067ee0: 2028 3120 666f 7220 6e6f 7665 6c74 6965   (1 for noveltie
-00067ef0: 732c 2030 2066 6f72 2069 6e6c 6965 7273  s, 0 for inliers
-00067f00: 290a 2020 2020 2222 220a 2020 2020 696d  ).    """.    im
-00067f10: 706f 7274 2070 616e 6461 7320 6173 2070  port pandas as p
-00067f20: 640a 2020 2020 6672 6f6d 2073 6b6c 6561  d.    from sklea
-00067f30: 726e 2e63 6f76 6172 6961 6e63 6520 696d  rn.covariance im
-00067f40: 706f 7274 2045 6c6c 6970 7469 6345 6e76  port EllipticEnv
-00067f50: 656c 6f70 650a 2020 2020 2320 4669 7420  elope.    # Fit 
-00067f60: 7468 6520 6d6f 6465 6c20 6f6e 2074 6865  the model on the
-00067f70: 2074 7261 696e 696e 6720 6461 7461 0a20   training data. 
-00067f80: 2020 2063 6c66 203d 2045 6c6c 6970 7469     clf = Ellipti
-00067f90: 6345 6e76 656c 6f70 6528 636f 6e74 616d  cEnvelope(contam
-00067fa0: 696e 6174 696f 6e3d 636f 6e74 616d 696e  ination=contamin
-00067fb0: 6174 696f 6e2c 7375 7070 6f72 745f 6672  ation,support_fr
-00067fc0: 6163 7469 6f6e 3d31 290a 2020 2020 6466  action=1).    df
-00067fd0: 5f74 7261 696e 5b20 6466 5f74 7261 696e  _train[ df_train
-00067fe0: 203d 3d20 6d61 7468 2e69 6e66 205d 203d   == math.inf ] =
-00067ff0: 2030 0a20 2020 2064 665f 7465 7374 5b20   0.    df_test[ 
-00068000: 6466 5f74 6573 7420 3d3d 206d 6174 682e  df_test == math.
-00068010: 696e 6620 5d20 3d20 300a 2020 2020 6672  inf ] = 0.    fr
-00068020: 6f6d 2073 6b6c 6561 726e 2e70 7265 7072  om sklearn.prepr
-00068030: 6f63 6573 7369 6e67 2069 6d70 6f72 7420  ocessing import 
-00068040: 5374 616e 6461 7264 5363 616c 6572 0a20  StandardScaler. 
-00068050: 2020 2073 6361 6c65 7220 3d20 5374 616e     scaler = Stan
-00068060: 6461 7264 5363 616c 6572 2829 0a20 2020  dardScaler().   
-00068070: 2073 6361 6c65 722e 6669 7428 6466 5f74   scaler.fit(df_t
-00068080: 7261 696e 290a 2020 2020 636c 662e 6669  rain).    clf.fi
-00068090: 7428 7363 616c 6572 2e74 7261 6e73 666f  t(scaler.transfo
-000680a0: 726d 2864 665f 7472 6169 6e29 290a 2020  rm(df_train)).  
-000680b0: 2020 7072 6564 6963 7469 6f6e 7320 3d20    predictions = 
-000680c0: 636c 662e 7072 6564 6963 7428 7363 616c  clf.predict(scal
-000680d0: 6572 2e74 7261 6e73 666f 726d 2864 665f  er.transform(df_
-000680e0: 7465 7374 2929 0a20 2020 2070 7265 6469  test)).    predi
-000680f0: 6374 696f 6e73 5b70 7265 6469 6374 696f  ctions[predictio
-00068100: 6e73 3d3d 315d 3d30 0a20 2020 2070 7265  ns==1]=0.    pre
-00068110: 6469 6374 696f 6e73 5b70 7265 6469 6374  dictions[predict
-00068120: 696f 6e73 3d3d 2d31 5d3d 310a 2020 2020  ions==-1]=1.    
-00068130: 6966 2073 7472 2874 7970 6528 6466 5f74  if str(type(df_t
-00068140: 7261 696e 2929 3d3d 223c 636c 6173 7320  rain))=="<class 
-00068150: 2770 616e 6461 732e 636f 7265 2e66 7261  'pandas.core.fra
-00068160: 6d65 2e44 6174 6146 7261 6d65 273e 223a  me.DataFrame'>":
-00068170: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00068180: 7064 2e53 6572 6965 7328 7072 6564 6963  pd.Series(predic
-00068190: 7469 6f6e 732c 2069 6e64 6578 3d64 665f  tions, index=df_
-000681a0: 7465 7374 2e69 6e64 6578 290a 2020 2020  test.index).    
-000681b0: 656c 7365 3a0a 2020 2020 2020 2020 7265  else:.        re
-000681c0: 7475 726e 2070 642e 5365 7269 6573 2870  turn pd.Series(p
-000681d0: 7265 6469 6374 696f 6e73 290a 0a0a 0a64  redictions)....d
-000681e0: 6566 206e 6f76 656c 7479 5f64 6574 6563  ef novelty_detec
-000681f0: 7469 6f6e 5f73 766d 2864 665f 7472 6169  tion_svm(df_trai
-00068200: 6e2c 2064 665f 7465 7374 2c20 6e75 3d30  n, df_test, nu=0
-00068210: 2e30 352c 206b 6572 6e65 6c3d 2772 6266  .05, kernel='rbf
-00068220: 2729 3a0a 2020 2020 2222 220a 2020 2020  '):.    """.    
-00068230: 5468 6973 2066 756e 6374 696f 6e20 7065  This function pe
-00068240: 7266 6f72 6d73 206e 6f76 656c 7479 2064  rforms novelty d
-00068250: 6574 6563 7469 6f6e 2075 7369 6e67 204f  etection using O
-00068260: 6e65 2d43 6c61 7373 2053 564d 2e0a 0a20  ne-Class SVM... 
-00068270: 2020 2050 6172 616d 6574 6572 733a 0a0a     Parameters:..
-00068280: 2020 2020 2d20 6466 5f74 7261 696e 2028      - df_train (
-00068290: 7061 6e64 6173 2064 6174 6166 7261 6d65  pandas dataframe
-000682a0: 293a 2074 7261 696e 696e 6720 6461 7461  ): training data
-000682b0: 2075 7365 6420 746f 2066 6974 2074 6865   used to fit the
-000682c0: 206d 6f64 656c 0a0a 2020 2020 2d20 6466   model..    - df
-000682d0: 5f74 6573 7420 2870 616e 6461 7320 6461  _test (pandas da
-000682e0: 7461 6672 616d 6529 3a20 7465 7374 2064  taframe): test d
-000682f0: 6174 6120 7573 6564 2074 6f20 7072 6564  ata used to pred
-00068300: 6963 7420 6e6f 7665 6c74 6965 730a 0a20  ict novelties.. 
-00068310: 2020 202d 206e 7520 2866 6c6f 6174 293a     - nu (float):
-00068320: 2070 6172 616d 6574 6572 2063 6f6e 7472   parameter contr
-00068330: 6f6c 6c69 6e67 2074 6865 2066 7261 6374  olling the fract
-00068340: 696f 6e20 6f66 2074 7261 696e 696e 6720  ion of training 
-00068350: 6572 726f 7273 2061 6e64 2074 6865 2066  errors and the f
-00068360: 7261 6374 696f 6e20 6f66 2073 7570 706f  raction of suppo
-00068370: 7274 2076 6563 746f 7273 2028 6465 6661  rt vectors (defa
-00068380: 756c 743a 2030 2e30 3529 0a0a 2020 2020  ult: 0.05)..    
-00068390: 2d20 6b65 726e 656c 2028 7374 7229 3a20  - kernel (str): 
-000683a0: 6b65 726e 656c 2074 7970 6520 7573 6564  kernel type used
-000683b0: 2069 6e20 7468 6520 5356 4d20 616c 676f   in the SVM algo
-000683c0: 7269 7468 6d20 2864 6566 6175 6c74 3a20  rithm (default: 
-000683d0: 2772 6266 2729 0a0a 2020 2020 5265 7475  'rbf')..    Retu
-000683e0: 726e 733a 0a0a 2020 2020 7072 6564 6963  rns:..    predic
-000683f0: 7469 6f6e 7320 2870 616e 6461 7320 7365  tions (pandas se
-00068400: 7269 6573 293a 2070 7265 6469 6374 6564  ries): predicted
-00068410: 206c 6162 656c 7320 666f 7220 7468 6520   labels for the 
-00068420: 7465 7374 2064 6174 6120 2831 2066 6f72  test data (1 for
-00068430: 206e 6f76 656c 7469 6573 2c20 3020 666f   novelties, 0 fo
-00068440: 7220 696e 6c69 6572 7329 0a20 2020 2022  r inliers).    "
-00068450: 2222 0a20 2020 2066 726f 6d20 736b 6c65  "".    from skle
-00068460: 6172 6e2e 7376 6d20 696d 706f 7274 204f  arn.svm import O
-00068470: 6e65 436c 6173 7353 564d 0a20 2020 2023  neClassSVM.    #
-00068480: 2046 6974 2074 6865 206d 6f64 656c 206f   Fit the model o
-00068490: 6e20 7468 6520 7472 6169 6e69 6e67 2064  n the training d
-000684a0: 6174 610a 2020 2020 6466 5f74 7261 696e  ata.    df_train
-000684b0: 5b20 6466 5f74 7261 696e 203d 3d20 6d61  [ df_train == ma
-000684c0: 7468 2e69 6e66 205d 203d 2030 0a20 2020  th.inf ] = 0.   
-000684d0: 2064 665f 7465 7374 5b20 6466 5f74 6573   df_test[ df_tes
-000684e0: 7420 3d3d 206d 6174 682e 696e 6620 5d20  t == math.inf ] 
-000684f0: 3d20 300a 2020 2020 636c 6620 3d20 4f6e  = 0.    clf = On
-00068500: 6543 6c61 7373 5356 4d28 6e75 3d6e 752c  eClassSVM(nu=nu,
-00068510: 206b 6572 6e65 6c3d 6b65 726e 656c 290a   kernel=kernel).
-00068520: 2020 2020 6672 6f6d 2073 6b6c 6561 726e      from sklearn
-00068530: 2e70 7265 7072 6f63 6573 7369 6e67 2069  .preprocessing i
-00068540: 6d70 6f72 7420 5374 616e 6461 7264 5363  mport StandardSc
-00068550: 616c 6572 0a20 2020 2073 6361 6c65 7220  aler.    scaler 
-00068560: 3d20 5374 616e 6461 7264 5363 616c 6572  = StandardScaler
-00068570: 2829 0a20 2020 2073 6361 6c65 722e 6669  ().    scaler.fi
-00068580: 7428 6466 5f74 7261 696e 290a 2020 2020  t(df_train).    
-00068590: 636c 662e 6669 7428 7363 616c 6572 2e74  clf.fit(scaler.t
-000685a0: 7261 6e73 666f 726d 2864 665f 7472 6169  ransform(df_trai
-000685b0: 6e29 290a 2020 2020 7072 6564 6963 7469  n)).    predicti
-000685c0: 6f6e 7320 3d20 636c 662e 7072 6564 6963  ons = clf.predic
-000685d0: 7428 7363 616c 6572 2e74 7261 6e73 666f  t(scaler.transfo
-000685e0: 726d 2864 665f 7465 7374 2929 0a20 2020  rm(df_test)).   
-000685f0: 2070 7265 6469 6374 696f 6e73 5b70 7265   predictions[pre
-00068600: 6469 6374 696f 6e73 3d3d 315d 3d30 0a20  dictions==1]=0. 
-00068610: 2020 2070 7265 6469 6374 696f 6e73 5b70     predictions[p
-00068620: 7265 6469 6374 696f 6e73 3d3d 2d31 5d3d  redictions==-1]=
-00068630: 310a 2020 2020 6966 2073 7472 2874 7970  1.    if str(typ
-00068640: 6528 6466 5f74 7261 696e 2929 3d3d 223c  e(df_train))=="<
-00068650: 636c 6173 7320 2770 616e 6461 732e 636f  class 'pandas.co
-00068660: 7265 2e66 7261 6d65 2e44 6174 6146 7261  re.frame.DataFra
-00068670: 6d65 273e 223a 0a20 2020 2020 2020 2072  me'>":.        r
-00068680: 6574 7572 6e20 7064 2e53 6572 6965 7328  eturn pd.Series(
-00068690: 7072 6564 6963 7469 6f6e 732c 2069 6e64  predictions, ind
-000686a0: 6578 3d64 665f 7465 7374 2e69 6e64 6578  ex=df_test.index
-000686b0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-000686c0: 2020 2020 7265 7475 726e 2070 642e 5365      return pd.Se
-000686d0: 7269 6573 2870 7265 6469 6374 696f 6e73  ries(predictions
-000686e0: 290a 0a0a 0a64 6566 206e 6f76 656c 7479  )....def novelty
-000686f0: 5f64 6574 6563 7469 6f6e 5f6c 6f66 2864  _detection_lof(d
-00068700: 665f 7472 6169 6e2c 2064 665f 7465 7374  f_train, df_test
-00068710: 2c20 6e5f 6e65 6967 6862 6f72 733d 3230  , n_neighbors=20
-00068720: 293a 0a20 2020 2022 2222 0a20 2020 2054  ):.    """.    T
-00068730: 6869 7320 6675 6e63 7469 6f6e 2070 6572  his function per
-00068740: 666f 726d 7320 6e6f 7665 6c74 7920 6465  forms novelty de
-00068750: 7465 6374 696f 6e20 7573 696e 6720 4c6f  tection using Lo
-00068760: 6361 6c20 4f75 746c 6965 7220 4661 6374  cal Outlier Fact
-00068770: 6f72 2028 4c4f 4629 2e0a 0a20 2020 2050  or (LOF)...    P
-00068780: 6172 616d 6574 6572 733a 0a0a 2020 2020  arameters:..    
-00068790: 2d20 6466 5f74 7261 696e 2028 7061 6e64  - df_train (pand
-000687a0: 6173 2064 6174 6166 7261 6d65 293a 2074  as dataframe): t
-000687b0: 7261 696e 696e 6720 6461 7461 2075 7365  raining data use
-000687c0: 6420 746f 2066 6974 2074 6865 206d 6f64  d to fit the mod
-000687d0: 656c 0a0a 2020 2020 2d20 6466 5f74 6573  el..    - df_tes
-000687e0: 7420 2870 616e 6461 7320 6461 7461 6672  t (pandas datafr
-000687f0: 616d 6529 3a20 7465 7374 2064 6174 6120  ame): test data 
-00068800: 7573 6564 2074 6f20 7072 6564 6963 7420  used to predict 
-00068810: 6e6f 7665 6c74 6965 730a 0a20 2020 202d  novelties..    -
-00068820: 206e 5f6e 6569 6768 626f 7273 2028 696e   n_neighbors (in
-00068830: 7429 3a20 6e75 6d62 6572 206f 6620 6e65  t): number of ne
-00068840: 6967 6862 6f72 7320 7573 6564 2074 6f20  ighbors used to 
-00068850: 636f 6d70 7574 6520 7468 6520 4c4f 4620  compute the LOF 
-00068860: 2864 6566 6175 6c74 3a20 3230 290a 0a20  (default: 20).. 
-00068870: 2020 2052 6574 7572 6e73 3a0a 0a20 2020     Returns:..   
-00068880: 202d 2070 7265 6469 6374 696f 6e73 2028   - predictions (
-00068890: 7061 6e64 6173 2073 6572 6965 7329 3a20  pandas series): 
-000688a0: 7072 6564 6963 7465 6420 6c61 6265 6c73  predicted labels
-000688b0: 2066 6f72 2074 6865 2074 6573 7420 6461   for the test da
-000688c0: 7461 2028 3120 666f 7220 6e6f 7665 6c74  ta (1 for novelt
-000688d0: 6965 732c 2030 2066 6f72 2069 6e6c 6965  ies, 0 for inlie
-000688e0: 7273 290a 0a20 2020 2022 2222 0a20 2020  rs)..    """.   
-000688f0: 2066 726f 6d20 736b 6c65 6172 6e2e 6e65   from sklearn.ne
-00068900: 6967 6862 6f72 7320 696d 706f 7274 204c  ighbors import L
-00068910: 6f63 616c 4f75 746c 6965 7246 6163 746f  ocalOutlierFacto
-00068920: 720a 2020 2020 2320 4669 7420 7468 6520  r.    # Fit the 
-00068930: 6d6f 6465 6c20 6f6e 2074 6865 2074 7261  model on the tra
-00068940: 696e 696e 6720 6461 7461 0a20 2020 2064  ining data.    d
-00068950: 665f 7472 6169 6e5b 2064 665f 7472 6169  f_train[ df_trai
-00068960: 6e20 3d3d 206d 6174 682e 696e 6620 5d20  n == math.inf ] 
-00068970: 3d20 300a 2020 2020 6466 5f74 6573 745b  = 0.    df_test[
-00068980: 2064 665f 7465 7374 203d 3d20 6d61 7468   df_test == math
-00068990: 2e69 6e66 205d 203d 2030 0a20 2020 2063  .inf ] = 0.    c
-000689a0: 6c66 203d 204c 6f63 616c 4f75 746c 6965  lf = LocalOutlie
-000689b0: 7246 6163 746f 7228 6e5f 6e65 6967 6862  rFactor(n_neighb
-000689c0: 6f72 733d 6e5f 6e65 6967 6862 6f72 732c  ors=n_neighbors,
-000689d0: 2061 6c67 6f72 6974 686d 3d27 6175 746f   algorithm='auto
-000689e0: 272c 636f 6e74 616d 696e 6174 696f 6e3d  ',contamination=
-000689f0: 2761 7574 6f27 2c20 6e6f 7665 6c74 793d  'auto', novelty=
-00068a00: 5472 7565 290a 2020 2020 6672 6f6d 2073  True).    from s
-00068a10: 6b6c 6561 726e 2e70 7265 7072 6f63 6573  klearn.preproces
-00068a20: 7369 6e67 2069 6d70 6f72 7420 5374 616e  sing import Stan
-00068a30: 6461 7264 5363 616c 6572 0a20 2020 2073  dardScaler.    s
-00068a40: 6361 6c65 7220 3d20 5374 616e 6461 7264  caler = Standard
-00068a50: 5363 616c 6572 2829 0a20 2020 2073 6361  Scaler().    sca
-00068a60: 6c65 722e 6669 7428 6466 5f74 7261 696e  ler.fit(df_train
-00068a70: 290a 2020 2020 636c 662e 6669 7428 7363  ).    clf.fit(sc
-00068a80: 616c 6572 2e74 7261 6e73 666f 726d 2864  aler.transform(d
-00068a90: 665f 7472 6169 6e29 290a 2020 2020 7072  f_train)).    pr
-00068aa0: 6564 6963 7469 6f6e 7320 3d20 636c 662e  edictions = clf.
-00068ab0: 7072 6564 6963 7428 7363 616c 6572 2e74  predict(scaler.t
-00068ac0: 7261 6e73 666f 726d 2864 665f 7465 7374  ransform(df_test
-00068ad0: 2929 0a20 2020 2070 7265 6469 6374 696f  )).    predictio
-00068ae0: 6e73 5b70 7265 6469 6374 696f 6e73 3d3d  ns[predictions==
-00068af0: 315d 3d30 0a20 2020 2070 7265 6469 6374  1]=0.    predict
-00068b00: 696f 6e73 5b70 7265 6469 6374 696f 6e73  ions[predictions
-00068b10: 3d3d 2d31 5d3d 310a 2020 2020 6966 2073  ==-1]=1.    if s
-00068b20: 7472 2874 7970 6528 6466 5f74 7261 696e  tr(type(df_train
-00068b30: 2929 3d3d 223c 636c 6173 7320 2770 616e  ))=="<class 'pan
-00068b40: 6461 732e 636f 7265 2e66 7261 6d65 2e44  das.core.frame.D
-00068b50: 6174 6146 7261 6d65 273e 223a 0a20 2020  ataFrame'>":.   
-00068b60: 2020 2020 2072 6574 7572 6e20 7064 2e53       return pd.S
-00068b70: 6572 6965 7328 7072 6564 6963 7469 6f6e  eries(prediction
-00068b80: 732c 2069 6e64 6578 3d64 665f 7465 7374  s, index=df_test
-00068b90: 2e69 6e64 6578 290a 2020 2020 656c 7365  .index).    else
-00068ba0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00068bb0: 2070 642e 5365 7269 6573 2870 7265 6469   pd.Series(predi
-00068bc0: 6374 696f 6e73 290a 0a0a 6465 6620 6e6f  ctions)...def no
-00068bd0: 7665 6c74 795f 6465 7465 6374 696f 6e5f  velty_detection_
-00068be0: 6c6f 6f70 2864 665f 7472 6169 6e2c 2064  loop(df_train, d
-00068bf0: 665f 7465 7374 2c20 6e5f 6e65 6967 6862  f_test, n_neighb
-00068c00: 6f72 733d 3230 2c20 6469 7374 616e 6365  ors=20, distance
-00068c10: 5f6d 6574 7269 633d 276d 696e 6b6f 7773  _metric='minkows
-00068c20: 6b69 2729 3a0a 2020 2020 2222 220a 2020  ki'):.    """.  
-00068c30: 2020 5468 6973 2066 756e 6374 696f 6e20    This function 
-00068c40: 7065 7266 6f72 6d73 206e 6f76 656c 7479  performs novelty
-00068c50: 2064 6574 6563 7469 6f6e 2075 7369 6e67   detection using
-00068c60: 204c 6f63 616c 204f 7574 6c69 6572 2046   Local Outlier F
-00068c70: 6163 746f 7220 284c 4f46 292e 0a0a 2020  actor (LOF)...  
-00068c80: 2020 5061 7261 6d65 7465 7273 3a0a 0a20    Parameters:.. 
-00068c90: 2020 202d 2064 665f 7472 6169 6e20 2870     - df_train (p
-00068ca0: 616e 6461 7320 6461 7461 6672 616d 6529  andas dataframe)
-00068cb0: 3a20 7472 6169 6e69 6e67 2064 6174 6120  : training data 
-00068cc0: 7573 6564 2074 6f20 6669 7420 7468 6520  used to fit the 
-00068cd0: 6d6f 6465 6c0a 0a20 2020 202d 2064 665f  model..    - df_
-00068ce0: 7465 7374 2028 7061 6e64 6173 2064 6174  test (pandas dat
-00068cf0: 6166 7261 6d65 293a 2074 6573 7420 6461  aframe): test da
-00068d00: 7461 2075 7365 6420 746f 2070 7265 6469  ta used to predi
-00068d10: 6374 206e 6f76 656c 7469 6573 0a0a 2020  ct novelties..  
-00068d20: 2020 2d20 6e5f 6e65 6967 6862 6f72 7320    - n_neighbors 
-00068d30: 2869 6e74 293a 206e 756d 6265 7220 6f66  (int): number of
-00068d40: 206e 6569 6768 626f 7273 2075 7365 6420   neighbors used 
-00068d50: 746f 2063 6f6d 7075 7465 2074 6865 204c  to compute the L
-00068d60: 4f4f 5020 2864 6566 6175 6c74 3a20 3230  OOP (default: 20
-00068d70: 290a 0a20 2020 202d 2064 6973 7461 6e63  )..    - distanc
-00068d80: 655f 6d65 7472 6963 203a 2064 6566 6175  e_metric : defau
-00068d90: 6c74 206d 696e 6b6f 7773 6b69 0a0a 2020  lt minkowski..  
-00068da0: 2020 5265 7475 726e 733a 0a0a 2020 2020    Returns:..    
-00068db0: 2d20 7072 6564 6963 7469 6f6e 7320 2870  - predictions (p
-00068dc0: 616e 6461 7320 7365 7269 6573 293a 2070  andas series): p
-00068dd0: 7265 6469 6374 6564 206c 6162 656c 7320  redicted labels 
-00068de0: 666f 7220 7468 6520 7465 7374 2064 6174  for the test dat
-00068df0: 6120 2831 2066 6f72 206e 6f76 656c 7469  a (1 for novelti
-00068e00: 6573 2c20 3020 666f 7220 696e 6c69 6572  es, 0 for inlier
-00068e10: 7329 0a0a 2020 2020 2222 220a 2020 2020  s)..    """.    
-00068e20: 6672 6f6d 2050 794e 6f6d 616c 7920 696d  from PyNomaly im
-00068e30: 706f 7274 206c 6f6f 700a 2020 2020 6672  port loop.    fr
-00068e40: 6f6d 2073 6b6c 6561 726e 2e6e 6569 6768  om sklearn.neigh
-00068e50: 626f 7273 2069 6d70 6f72 7420 4e65 6172  bors import Near
-00068e60: 6573 744e 6569 6768 626f 7273 0a20 2020  estNeighbors.   
-00068e70: 2066 726f 6d20 736b 6c65 6172 6e2e 7072   from sklearn.pr
-00068e80: 6570 726f 6365 7373 696e 6720 696d 706f  eprocessing impo
-00068e90: 7274 2053 7461 6e64 6172 6453 6361 6c65  rt StandardScale
-00068ea0: 720a 2020 2020 7363 616c 6572 203d 2053  r.    scaler = S
-00068eb0: 7461 6e64 6172 6453 6361 6c65 7228 290a  tandardScaler().
-00068ec0: 2020 2020 7363 616c 6572 2e66 6974 2864      scaler.fit(d
-00068ed0: 665f 7472 6169 6e29 0a20 2020 2064 6174  f_train).    dat
-00068ee0: 6120 3d20 6e70 2e76 7374 6163 6b28 205b  a = np.vstack( [
-00068ef0: 7363 616c 6572 2e74 7261 6e73 666f 726d  scaler.transform
-00068f00: 2864 665f 7465 7374 292c 7363 616c 6572  (df_test),scaler
-00068f10: 2e74 7261 6e73 666f 726d 2864 665f 7472  .transform(df_tr
-00068f20: 6169 6e29 5d29 0a20 2020 206e 6569 6768  ain)]).    neigh
-00068f30: 203d 204e 6561 7265 7374 4e65 6967 6862   = NearestNeighb
-00068f40: 6f72 7328 6e5f 6e65 6967 6862 6f72 733d  ors(n_neighbors=
-00068f50: 6e5f 6e65 6967 6862 6f72 732c 206d 6574  n_neighbors, met
-00068f60: 7269 633d 6469 7374 616e 6365 5f6d 6574  ric=distance_met
-00068f70: 7269 6329 0a20 2020 206e 6569 6768 2e66  ric).    neigh.f
-00068f80: 6974 2864 6174 6129 0a20 2020 2064 2c20  it(data).    d, 
-00068f90: 6964 7820 3d20 6e65 6967 682e 6b6e 6569  idx = neigh.knei
-00068fa0: 6768 626f 7273 2864 6174 612c 2072 6574  ghbors(data, ret
-00068fb0: 7572 6e5f 6469 7374 616e 6365 3d54 7275  urn_distance=Tru
-00068fc0: 6529 0a20 2020 206d 203d 206c 6f6f 702e  e).    m = loop.
-00068fd0: 4c6f 6361 6c4f 7574 6c69 6572 5072 6f62  LocalOutlierProb
-00068fe0: 6162 696c 6974 7928 6469 7374 616e 6365  ability(distance
-00068ff0: 5f6d 6174 7269 783d 642c 206e 6569 6768  _matrix=d, neigh
-00069000: 626f 725f 6d61 7472 6978 3d69 6478 2c20  bor_matrix=idx, 
-00069010: 6e5f 6e65 6967 6862 6f72 733d 6e5f 6e65  n_neighbors=n_ne
-00069020: 6967 6862 6f72 7329 2e66 6974 2829 0a20  ighbors).fit(). 
-00069030: 2020 2072 6574 7572 6e20 6d2e 6c6f 6361     return m.loca
-00069040: 6c5f 6f75 746c 6965 725f 7072 6f62 6162  l_outlier_probab
-00069050: 696c 6974 6965 735b 7261 6e67 6528 6466  ilities[range(df
-00069060: 5f74 6573 742e 7368 6170 655b 305d 295d  _test.shape[0])]
-00069070: 0a0a 0a0a 6465 6620 6e6f 7665 6c74 795f  ....def novelty_
-00069080: 6465 7465 6374 696f 6e5f 7175 616e 7469  detection_quanti
-00069090: 6c65 2864 665f 7472 6169 6e2c 2064 665f  le(df_train, df_
-000690a0: 7465 7374 293a 0a20 2020 2022 2222 0a20  test):.    """. 
-000690b0: 2020 2054 6869 7320 6675 6e63 7469 6f6e     This function
-000690c0: 2070 6572 666f 726d 7320 6e6f 7665 6c74   performs novelt
-000690d0: 7920 6465 7465 6374 696f 6e20 7573 696e  y detection usin
-000690e0: 6720 7175 616e 7469 6c65 7320 666f 7220  g quantiles for 
-000690f0: 6561 6368 2063 6f6c 756d 6e2e 0a0a 2020  each column...  
-00069100: 2020 5061 7261 6d65 7465 7273 3a0a 0a20    Parameters:.. 
-00069110: 2020 202d 2064 665f 7472 6169 6e20 2870     - df_train (p
-00069120: 616e 6461 7320 6461 7461 6672 616d 6529  andas dataframe)
-00069130: 3a20 7472 6169 6e69 6e67 2064 6174 6120  : training data 
-00069140: 7573 6564 2074 6f20 6669 7420 7468 6520  used to fit the 
-00069150: 6d6f 6465 6c0a 0a20 2020 202d 2064 665f  model..    - df_
-00069160: 7465 7374 2028 7061 6e64 6173 2064 6174  test (pandas dat
-00069170: 6166 7261 6d65 293a 2074 6573 7420 6461  aframe): test da
-00069180: 7461 2075 7365 6420 746f 2070 7265 6469  ta used to predi
-00069190: 6374 206e 6f76 656c 7469 6573 0a0a 2020  ct novelties..  
-000691a0: 2020 5265 7475 726e 733a 0a0a 2020 2020    Returns:..    
-000691b0: 2d20 7175 616e 7469 6c65 7320 666f 7220  - quantiles for 
-000691c0: 7468 6520 7465 7374 2073 616d 706c 6520  the test sample 
-000691d0: 6174 2065 6163 6820 636f 6c75 6d6e 2077  at each column w
-000691e0: 6865 7265 2076 616c 7565 7320 7261 6e67  here values rang
-000691f0: 6520 696e 205b 302c 315d 0a20 2020 2020  e in [0,1].     
-00069200: 2020 2061 6e64 2068 6967 6865 7220 7661     and higher va
-00069210: 6c75 6573 206d 6561 6e20 7468 6520 636f  lues mean the co
-00069220: 6c75 6d6e 2069 7320 636c 6f73 6572 2074  lumn is closer t
-00069230: 6f20 7468 6520 6564 6765 206f 6620 7468  o the edge of th
-00069240: 6520 6469 7374 7269 6275 7469 6f6e 0a0a  e distribution..
-00069250: 2020 2020 2222 220a 2020 2020 6d79 7173      """.    myqs
-00069260: 203d 2064 665f 7465 7374 2e63 6f70 7928   = df_test.copy(
-00069270: 290a 2020 2020 6e20 3d20 6466 5f74 7261  ).    n = df_tra
-00069280: 696e 2e73 6861 7065 5b30 5d0a 2020 2020  in.shape[0].    
-00069290: 6466 5f74 7261 696e 6b65 7973 203d 2064  df_trainkeys = d
-000692a0: 665f 7472 6169 6e2e 6b65 7973 2829 0a20  f_train.keys(). 
-000692b0: 2020 2066 6f72 206b 2069 6e20 7261 6e67     for k in rang
-000692c0: 6528 2064 665f 7472 6169 6e2e 7368 6170  e( df_train.shap
-000692d0: 655b 315d 2029 3a0a 2020 2020 2020 2020  e[1] ):.        
-000692e0: 6d79 6b65 7920 3d20 6466 5f74 7261 696e  mykey = df_train
-000692f0: 6b65 7973 5b6b 5d0a 2020 2020 2020 2020  keys[k].        
-00069300: 7465 6d70 203d 2028 6d79 7173 5b6d 796b  temp = (myqs[myk
-00069310: 6579 5d5b 305d 203e 2020 6466 5f74 7261  ey][0] >  df_tra
-00069320: 696e 5b6d 796b 6579 5d29 2e73 756d 2829  in[mykey]).sum()
-00069330: 202f 206e 0a20 2020 2020 2020 206d 7971   / n.        myq
-00069340: 735b 6d79 6b65 795d 203d 2061 6273 2820  s[mykey] = abs( 
-00069350: 7465 6d70 202d 2030 2e35 2029 202f 2030  temp - 0.5 ) / 0
-00069360: 2e35 0a20 2020 2072 6574 7572 6e20 6d79  .5.    return my
-00069370: 7173 0a0a 6465 6620 6272 6169 6e6d 6170  qs..def brainmap
-00069380: 5f66 6967 7572 6528 7374 6174 6973 7469  _figure(statisti
-00069390: 6361 6c5f 6466 2c20 6461 7461 5f64 6963  cal_df, data_dic
-000693a0: 7469 6f6e 6172 795f 7061 7468 2c20 6f75  tionary_path, ou
-000693b0: 7470 7574 5f70 7265 6669 782c 2062 7261  tput_prefix, bra
-000693c0: 696e 5f69 6d61 6765 2c20 6f76 6572 6c61  in_image, overla
-000693d0: 795f 636d 6170 3d27 6277 7227 2c20 6e73  y_cmap='bwr', ns
-000693e0: 6c69 6365 733d 3231 2c20 6e63 6f6c 3d37  lices=21, ncol=7
-000693f0: 2c20 6564 6765 5f69 6d61 6765 5f64 696c  , edge_image_dil
-00069400: 6174 696f 6e20 3d20 302c 2062 6c61 636b  ation = 0, black
-00069410: 5f62 673d 5472 7565 2c20 6178 6573 203d  _bg=True, axes =
-00069420: 205b 302c 312c 325d 2c20 6669 7865 645f   [0,1,2], fixed_
-00069430: 6f76 6572 6c61 795f 7261 6e67 653d 4e6f  overlay_range=No
-00069440: 6e65 2c20 6372 6f70 3d35 2c20 7665 7262  ne, crop=5, verb
-00069450: 6f73 653d 4661 6c73 6520 293a 0a20 2020  ose=False ):.   
-00069460: 2022 2222 0a20 2020 2043 7265 6174 6520   """.    Create 
-00069470: 6669 6775 7265 7320 6261 7365 6420 6f6e  figures based on
-00069480: 2073 7461 7469 7374 6963 616c 2064 6174   statistical dat
-00069490: 6120 616e 6420 616e 2075 6e64 6572 6c79  a and an underly
-000694a0: 696e 6720 6272 6169 6e20 696d 6167 652e  ing brain image.
-000694b0: 0a0a 2020 2020 4173 7375 6d65 7320 626f  ..    Assumes bo
-000694c0: 7468 207e 2f2e 616e 7473 7079 7431 7720  th ~/.antspyt1w 
-000694d0: 616e 6420 7e2f 2e61 6e74 7370 796d 6d20  and ~/.antspymm 
-000694e0: 6461 7461 2069 7320 6176 6169 6c61 626c  data is availabl
-000694f0: 650a 0a20 2020 2050 6172 616d 6574 6572  e..    Parameter
-00069500: 733a 0a20 2020 202d 2073 7461 7469 7374  s:.    - statist
-00069510: 6963 616c 5f64 6620 2870 616e 6461 7320  ical_df (pandas 
-00069520: 6461 7461 6672 616d 6529 3a20 7769 7468  dataframe): with
-00069530: 2032 2063 6f6c 756d 6e73 206e 616d 6564   2 columns named
-00069540: 2061 6e61 7420 616e 6420 7661 6c75 6573   anat and values
-00069550: 0a20 2020 2020 2020 2074 6865 2061 6e61  .        the ana
-00069560: 7420 636f 6c75 6d6e 2073 686f 756c 6420  t column should 
-00069570: 6861 7665 206e 616d 6573 2074 6861 7420  have names that 
-00069580: 6d65 6574 202a 7061 7274 6961 6c20 6d61  meet *partial ma
-00069590: 7463 6869 6e67 2a20 6372 6974 6572 696f  tching* criterio
-000695a0: 6e20 0a20 2020 2020 2020 2077 6974 6820  n .        with 
-000695b0: 7265 7370 6563 7420 746f 2072 6567 696f  respect to regio
-000695c0: 6e73 2074 6861 7420 6172 6520 6d65 6173  ns that are meas
-000695d0: 7572 6564 2069 6e20 616e 7473 7079 6d6d  ured in antspymm
-000695e0: 2e20 2020 7661 6c75 6520 7769 6c6c 2062  .   value will b
-000695f0: 6520 0a20 2020 2020 2020 2074 6865 2076  e .        the v
-00069600: 616c 7565 2074 6f20 6265 2064 6973 706c  alue to be displ
-00069610: 6179 6564 2e20 2020 6966 2074 776f 2065  ayed.   if two e
-00069620: 7861 6d70 6c65 7320 6f66 2061 2067 6976  xamples of a giv
-00069630: 656e 2072 6567 696f 6e20 6578 6973 7420  en region exist 
-00069640: 696e 200a 2020 2020 2020 2020 7374 6174  in .        stat
-00069650: 6973 7469 6361 6c5f 6466 2c20 7468 656e  istical_df, then
-00069660: 2074 6865 206c 6172 6765 7374 2061 6273   the largest abs
-00069670: 6f6c 7574 6520 7661 6c75 6520 7769 6c6c  olute value will
-00069680: 2062 6520 7461 6b65 6e20 666f 7220 6469   be taken for di
-00069690: 7370 6c61 792e 0a20 2020 202d 2064 6174  splay..    - dat
-000696a0: 615f 6469 6374 696f 6e61 7279 5f70 6174  a_dictionary_pat
-000696b0: 6820 2873 7472 293a 2050 6174 6820 746f  h (str): Path to
-000696c0: 2074 6865 2064 6174 6120 6469 6374 696f   the data dictio
-000696d0: 6e61 7279 2043 5356 2066 696c 652e 0a20  nary CSV file.. 
-000696e0: 2020 202d 206f 7574 7075 745f 7072 6566     - output_pref
-000696f0: 6978 2028 7374 7229 3a20 5072 6566 6978  ix (str): Prefix
-00069700: 2066 6f72 2074 6865 206f 7574 7075 7420   for the output 
-00069710: 6669 6775 7265 2066 696c 656e 616d 6573  figure filenames
-00069720: 2e0a 2020 2020 2d20 6272 6169 6e5f 696d  ..    - brain_im
-00069730: 6167 6520 2861 6e74 7349 6d61 6765 293a  age (antsImage):
-00069740: 2074 6865 2062 7261 696e 2069 6d61 6765   the brain image
-00069750: 206f 6e20 7768 6963 6820 7265 7375 6c74   on which result
-00069760: 7320 7769 6c6c 206f 7665 726c 6179 2e0a  s will overlay..
-00069770: 2020 2020 2d20 6f76 6572 6c61 795f 636d      - overlay_cm
-00069780: 6170 2028 7374 7229 3a20 7365 6520 6d61  ap (str): see ma
-00069790: 7470 6c6f 746c 6962 0a20 2020 202d 206e  tplotlib.    - n
-000697a0: 736c 6963 6573 2028 696e 7429 3a20 6e75  slices (int): nu
-000697b0: 6d62 6572 206f 6620 736c 6963 6573 2074  mber of slices t
-000697c0: 6f20 7368 6f77 0a20 2020 202d 206e 636f  o show.    - nco
-000697d0: 6c20 2869 6e74 293a 206e 756d 6265 7220  l (int): number 
-000697e0: 6f66 2063 6f6c 756d 6e73 2074 6f20 7368  of columns to sh
-000697f0: 6f77 0a20 2020 202d 2065 6467 655f 696d  ow.    - edge_im
-00069800: 6167 655f 6469 6c61 7469 6f6e 2028 696e  age_dilation (in
-00069810: 7429 3a20 696e 7465 6765 7220 6772 6561  t): integer grea
-00069820: 7465 7220 7468 616e 206f 7220 6571 7561  ter than or equa
-00069830: 6c20 746f 207a 6572 6f0a 2020 2020 2d20  l to zero.    - 
-00069840: 626c 6163 6b5f 6267 2028 626f 6f6c 293a  black_bg (bool):
-00069850: 2062 6f6f 6c65 616e 0a20 2020 202d 2061   boolean.    - a
-00069860: 7865 7320 286c 6973 7429 3a20 696e 7465  xes (list): inte
-00069870: 6765 7220 6c69 7374 2074 7970 6963 616c  ger list typical
-00069880: 6c79 205b 302c 312c 325d 2073 6167 6974  ly [0,1,2] sagit
-00069890: 7461 6c20 636f 726f 6e61 6c20 6178 6961  tal coronal axia
-000698a0: 6c0a 2020 2020 2d20 6669 7865 645f 6f76  l.    - fixed_ov
-000698b0: 6572 6c61 795f 7261 6e67 6520 286c 6973  erlay_range (lis
-000698c0: 7429 3a20 7363 616c 6172 2070 6169 7220  t): scalar pair 
-000698d0: 7769 6c6c 2074 7279 2074 6f20 6b65 6570  will try to keep
-000698e0: 2061 2063 6f6e 7374 616e 7420 6362 6172   a constant cbar
-000698f0: 2061 6e64 2077 696c 6c20 7472 756e 6361   and will trunca
-00069900: 7465 2074 6865 206f 7665 726c 6179 2061  te the overlay a
-00069910: 7420 7468 6573 6520 6d69 6e2f 6d61 7820  t these min/max 
-00069920: 7661 6c75 6573 0a20 2020 202d 2063 726f  values.    - cro
-00069930: 7020 2869 6e74 293a 2063 726f 7073 2074  p (int): crops t
-00069940: 6865 2069 6d61 6765 2074 6f20 6469 7370  he image to disp
-00069950: 6c61 7920 6279 2074 6865 2065 7874 656e  lay by the exten
-00069960: 7420 6f66 2074 6865 206f 7665 726c 6179  t of the overlay
-00069970: 3b20 6c61 7267 6572 2076 616c 7565 7320  ; larger values 
-00069980: 6469 6c61 7465 2074 6865 206d 6173 6b73  dilate the masks
-00069990: 206d 6f72 652e 0a20 2020 202d 2076 6572   more..    - ver
-000699a0: 626f 7365 2028 626f 6f6c 293a 2062 6f6f  bose (bool): boo
-000699b0: 6c65 616e 0a0a 2020 2020 5265 7475 726e  lean..    Return
-000699c0: 733a 0a20 2020 2061 6e20 696d 6167 6520  s:.    an image 
-000699d0: 7769 7468 2076 616c 7565 7320 6d61 7070  with values mapp
-000699e0: 6564 2074 6f20 7468 6520 6173 736f 6369  ed to the associ
-000699f0: 6174 6564 2072 6567 696f 6e73 0a20 2020  ated regions.   
-00069a00: 2022 2222 0a20 2020 2069 6d70 6f72 7420   """.    import 
-00069a10: 7265 0a0a 2020 2020 2320 5265 6164 2074  re..    # Read t
-00069a20: 6865 2073 7461 7469 7374 6963 616c 2066  he statistical f
-00069a30: 696c 650a 2020 2020 7a7a 203d 2073 7461  ile.    zz = sta
-00069a40: 7469 7374 6963 616c 5f64 6620 0a20 2020  tistical_df .   
-00069a50: 200a 2020 2020 2320 5265 6164 2074 6865   .    # Read the
-00069a60: 2064 6174 6120 6469 6374 696f 6e61 7279   data dictionary
-00069a70: 2066 726f 6d20 6120 4353 5620 6669 6c65   from a CSV file
-00069a80: 0a20 2020 206d 7964 6963 7420 3d20 7064  .    mydict = pd
-00069a90: 2e72 6561 645f 6373 7628 6461 7461 5f64  .read_csv(data_d
-00069aa0: 6963 7469 6f6e 6172 795f 7061 7468 290a  ictionary_path).
-00069ab0: 2020 2020 6d79 6469 6374 203d 206d 7964      mydict = myd
-00069ac0: 6963 745b 7e6d 7964 6963 745b 274d 6561  ict[~mydict['Mea
-00069ad0: 7375 7265 6d65 6e74 275d 2e73 7472 2e63  surement'].str.c
-00069ae0: 6f6e 7461 696e 7328 2274 7261 6374 6f67  ontains("tractog
-00069af0: 7261 7068 792d 6261 7365 6420 636f 6e6e  raphy-based conn
-00069b00: 6563 7469 7669 7479 222c 206e 613d 4661  ectivity", na=Fa
-00069b10: 6c73 6529 5d0a 0a20 2020 2073 7461 7469  lse)]..    stati
-00069b20: 7374 6963 616c 5f64 665b 2761 6e61 7427  stical_df['anat'
-00069b30: 5d20 3d20 7374 6174 6973 7469 6361 6c5f  ] = statistical_
-00069b40: 6466 5b27 616e 6174 275d 2e73 7472 2e72  df['anat'].str.r
-00069b50: 6570 6c61 6365 2822 5f22 2c20 222e 222c  eplace("_", ".",
-00069b60: 2072 6567 6578 3d54 7275 6529 0a0a 2020   regex=True)..  
-00069b70: 2020 2320 4c6f 6164 2069 6d61 6765 2061    # Load image a
-00069b80: 6e64 2070 726f 6365 7373 2069 740a 2020  nd process it.  
-00069b90: 2020 6564 6765 696d 6720 3d20 616e 7473    edgeimg = ants
-00069ba0: 2e69 4d61 7468 2862 7261 696e 5f69 6d61  .iMath(brain_ima
-00069bb0: 6765 2c22 4e6f 726d 616c 697a 6522 290a  ge,"Normalize").
-00069bc0: 2020 2020 6966 2065 6467 655f 696d 6167      if edge_imag
-00069bd0: 655f 6469 6c61 7469 6f6e 203e 2030 3a0a  e_dilation > 0:.
-00069be0: 2020 2020 2020 2020 6564 6765 696d 6720          edgeimg 
-00069bf0: 3d20 616e 7473 2e69 4d61 7468 2820 6564  = ants.iMath( ed
-00069c00: 6765 696d 672c 2022 4d44 222c 2065 6467  geimg, "MD", edg
-00069c10: 655f 696d 6167 655f 6469 6c61 7469 6f6e  e_image_dilation
-00069c20: 290a 0a20 2020 2023 2044 6566 696e 6520  )..    # Define 
-00069c30: 6c69 7374 7320 616e 6420 6461 7461 2066  lists and data f
-00069c40: 7261 6d65 730a 2020 2020 706f 7374 6669  rames.    postfi
-00069c50: 7820 3d20 5b27 6266 272c 2027 6369 7431  x = ['bf', 'cit1
-00069c60: 3638 6c61 6227 2c20 276d 746c 272c 2027  68lab', 'mtl', '
-00069c70: 6365 7265 6265 6c6c 756d 272c 2027 646b  cerebellum', 'dk
-00069c80: 745f 636f 7274 6578 272c 2762 7261 696e  t_cortex','brain
-00069c90: 7374 656d 272c 274a 4855 5f77 6d27 2c27  stem','JHU_wm','
-00069ca0: 7965 6f27 5d0a 2020 2020 6174 6c61 7320  yeo'].    atlas 
-00069cb0: 3d20 5b27 4246 272c 2027 4349 5431 3638  = ['BF', 'CIT168
-00069cc0: 272c 2027 4d54 4c27 2c20 2754 7573 7469  ', 'MTL', 'Tusti
-00069cd0: 736f 6e43 6f62 7261 272c 2027 6465 7369  sonCobra', 'desi
-00069ce0: 6b61 6e2d 6b69 6c6c 6961 6e79 2d74 6f75  kan-killiany-tou
-00069cf0: 7276 696c 6c65 272c 2762 7261 696e 7374  rville','brainst
-00069d00: 656d 272c 274a 4855 5f77 6d27 2c27 7965  em','JHU_wm','ye
-00069d10: 6f27 5d0a 2020 2020 706f 7374 6465 7363  o'].    postdesc
-00069d20: 203d 205b 276e 626d 3343 4831 3327 2c20   = ['nbm3CH13', 
-00069d30: 2743 4954 3136 385f 5265 696e 665f 4c65  'CIT168_Reinf_Le
-00069d40: 6172 6e5f 7631 5f6c 6162 656c 5f64 6573  arn_v1_label_des
-00069d50: 6372 6970 7469 6f6e 735f 7061 6427 2c20  criptions_pad', 
-00069d60: 276d 746c 5f64 6573 6372 6970 7469 6f6e  'mtl_description
-00069d70: 272c 2027 6365 7265 6265 6c6c 756d 272c  ', 'cerebellum',
-00069d80: 2027 646b 7427 2c27 4349 5431 3638 5f54   'dkt','CIT168_T
-00069d90: 3177 5f37 3030 756d 5f70 6164 5f61 646e  1w_700um_pad_adn
-00069da0: 695f 6272 6169 6e73 7465 6d27 2c27 4641  i_brainstem','FA
-00069db0: 5f4a 4855 5f6c 6162 656c 735f 6564 6974  _JHU_labels_edit
-00069dc0: 6564 272c 2770 706d 695f 7465 6d70 6c61  ed','ppmi_templa
-00069dd0: 7465 5f35 3030 5061 7263 656c 735f 5965  te_500Parcels_Ye
-00069de0: 6f32 3031 315f 3137 4e65 7477 6f72 6b73  o2011_17Networks
-00069df0: 5f32 3032 335f 686f 6d6f 746f 7069 6327  _2023_homotopic'
-00069e00: 5d0a 2020 2020 7374 6174 6466 203d 2070  ].    statdf = p
-00069e10: 642e 4461 7461 4672 616d 6528 7b27 696d  d.DataFrame({'im
-00069e20: 6727 3a20 706f 7374 6669 782c 2027 6174  g': postfix, 'at
-00069e30: 6c61 7327 3a20 6174 6c61 732c 2027 6373  las': atlas, 'cs
-00069e40: 7664 6573 6372 6970 7427 3a20 706f 7374  vdescript': post
-00069e50: 6465 7363 7d29 0a20 2020 2074 656d 706c  desc}).    templ
-00069e60: 6174 6570 7265 6669 7820 3d20 277e 2f2e  ateprefix = '~/.
-00069e70: 616e 7473 7079 6d6d 2f50 504d 495f 7465  antspymm/PPMI_te
-00069e80: 6d70 6c61 7465 305f 270a 2020 2020 2320  mplate0_'.    # 
-00069e90: 4974 6572 6174 6520 7468 726f 7567 6820  Iterate through 
-00069ea0: 636f 6c75 6d6e 7320 616e 6420 6372 6561  columns and crea
-00069eb0: 7465 2066 6967 7572 6573 0a20 2020 2063  te figures.    c
-00069ec0: 6f6c 3276 697a 203d 2027 7661 6c75 6573  ol2viz = 'values
-00069ed0: 270a 2020 2020 6966 2054 7275 653a 0a20  '.    if True:. 
-00069ee0: 2020 2020 2020 2061 6e61 7474 6f73 686f         anattosho
-00069ef0: 7720 3d20 7a7a 5b27 616e 6174 275d 2e75  w = zz['anat'].u
-00069f00: 6e69 7175 6528 290a 2020 2020 2020 2020  nique().        
-00069f10: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-00069f20: 2020 2020 2020 2020 7072 696e 7428 636f          print(co
-00069f30: 6c32 7669 7a29 0a20 2020 2020 2020 2020  l2viz).         
-00069f40: 2020 2070 7269 6e74 2861 6e61 7474 6f73     print(anattos
-00069f50: 686f 7729 0a20 2020 2020 2020 2023 2052  how).        # R
-00069f60: 6573 7420 6f66 2079 6f75 7220 636f 6465  est of your code
-00069f70: 2066 6f72 2066 6967 7572 6520 6372 6561   for figure crea
-00069f80: 7469 6f6e 2067 6f65 7320 6865 7265 2e2e  tion goes here..
-00069f90: 2e0a 2020 2020 2020 2020 6164 6465 6d20  ..        addem 
-00069fa0: 3d20 6564 6765 696d 6720 2a20 300a 2020  = edgeimg * 0.  
-00069fb0: 2020 2020 2020 666f 7220 6b20 696e 2072        for k in r
-00069fc0: 616e 6765 286c 656e 2861 6e61 7474 6f73  ange(len(anattos
-00069fd0: 686f 7729 293a 0a20 2020 2020 2020 2020  how)):.         
-00069fe0: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
-00069ff0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0006a000: 7269 6e74 2873 7472 286b 2920 2b20 2022  rint(str(k) +  "
-0006a010: 2022 202b 2061 6e61 7474 6f73 686f 775b   " + anattoshow[
-0006a020: 6b5d 2020 290a 2020 2020 2020 2020 2020  k]  ).          
-0006a030: 2020 6d79 7375 6220 3d20 7a7a 5b7a 7a5b    mysub = zz[zz[
-0006a040: 2761 6e61 7427 5d2e 7374 722e 636f 6e74  'anat'].str.cont
-0006a050: 6169 6e73 2861 6e61 7474 6f73 686f 775b  ains(anattoshow[
-0006a060: 6b5d 295d 0a20 2020 2020 2020 2020 2020  k])].           
-0006a070: 2061 6e61 7473 6561 723d 7265 2e73 7562   anatsear=re.sub
-0006a080: 2822 6474 692e 6661 222c 2222 2c61 6e61  ("dti.fa","",ana
-0006a090: 7474 6f73 686f 775b 6b5d 290a 2020 2020  ttoshow[k]).    
-0006a0a0: 2020 2020 2020 2020 616e 6174 7365 6172          anatsear
-0006a0b0: 3d72 652e 7375 6228 2263 6266 2e22 2c22  =re.sub("cbf.","
-0006a0c0: 222c 616e 6174 7365 6172 290a 2020 2020  ",anatsear).    
-0006a0d0: 2020 2020 2020 2020 616e 6174 7365 6172          anatsear
-0006a0e0: 3d72 652e 7375 6228 2274 312e 766f 6c61  =re.sub("t1.vola
-0006a0f0: 7379 6d22 2c22 222c 616e 6174 7365 6172  sym","",anatsear
-0006a100: 290a 2020 2020 2020 2020 2020 2020 616e  ).            an
-0006a110: 6174 7365 6172 3d72 652e 7375 6228 2274  atsear=re.sub("t
-0006a120: 312e 7468 6b61 7379 6d22 2c22 222c 616e  1.thkasym","",an
-0006a130: 6174 7365 6172 290a 2020 2020 2020 2020  atsear).        
-0006a140: 2020 2020 616e 6174 7365 6172 3d72 652e      anatsear=re.
-0006a150: 7375 6228 2274 312e 6172 6561 6173 796d  sub("t1.areaasym
-0006a160: 222c 2222 2c61 6e61 7473 6561 7229 0a20  ","",anatsear). 
-0006a170: 2020 2020 2020 2020 2020 2061 6e61 7473             anats
-0006a180: 6561 723d 7265 2e73 7562 2822 7431 2e76  ear=re.sub("t1.v
-0006a190: 6f6c 2e22 2c22 222c 616e 6174 7365 6172  ol.","",anatsear
-0006a1a0: 290a 2020 2020 2020 2020 2020 2020 616e  ).            an
-0006a1b0: 6174 7365 6172 3d72 652e 7375 6228 2274  atsear=re.sub("t
-0006a1c0: 312e 7468 6b2e 222c 2222 2c61 6e61 7473  1.thk.","",anats
-0006a1d0: 6561 7229 0a20 2020 2020 2020 2020 2020  ear).           
-0006a1e0: 2061 6e61 7473 6561 723d 7265 2e73 7562   anatsear=re.sub
-0006a1f0: 2822 7431 2e61 7265 612e 222c 2222 2c61  ("t1.area.","",a
-0006a200: 6e61 7473 6561 7229 0a20 2020 2020 2020  natsear).       
-0006a210: 2020 2020 2061 6e61 7473 6561 723d 7265       anatsear=re
-0006a220: 2e73 7562 2822 6173 796d 6470 2e22 2c22  .sub("asymdp.","
-0006a230: 222c 616e 6174 7365 6172 290a 2020 2020  ",anatsear).    
-0006a240: 2020 2020 2020 2020 616e 6174 7365 6172          anatsear
-0006a250: 3d72 652e 7375 6228 2261 7379 6d2e 222c  =re.sub("asym.",
-0006a260: 2222 2c61 6e61 7473 6561 7229 0a20 2020  "",anatsear).   
-0006a270: 2020 2020 2020 2020 2061 6e61 7473 6561           anatsea
-0006a280: 723d 7265 2e73 7562 2822 6474 692e 6d64  r=re.sub("dti.md
-0006a290: 2e22 2c22 222c 616e 6174 7365 6172 290a  .","",anatsear).
-0006a2a0: 2020 2020 2020 2020 2020 2020 616e 6174              anat
-0006a2b0: 7365 6172 3d72 652e 7375 6228 2264 7469  sear=re.sub("dti
-0006a2c0: 2e66 612e 222c 2222 2c61 6e61 7473 6561  .fa.","",anatsea
-0006a2d0: 7229 0a20 2020 2020 2020 2020 2020 2061  r).            a
-0006a2e0: 6e61 7473 6561 723d 7265 2e73 7562 2822  natsear=re.sub("
-0006a2f0: 6474 692e 6d64 222c 2222 2c61 6e61 7473  dti.md","",anats
-0006a300: 6561 7229 0a20 2020 2020 2020 2020 2020  ear).           
-0006a310: 2061 6e61 7473 6561 723d 7265 2e73 7562   anatsear=re.sub
-0006a320: 2822 6474 692e 6d65 616e 2e6d 642e 222c  ("dti.mean.md.",
-0006a330: 2222 2c61 6e61 7473 6561 7229 0a20 2020  "",anatsear).   
-0006a340: 2020 2020 2020 2020 2061 6e61 7473 6561           anatsea
-0006a350: 723d 7265 2e73 7562 2822 6474 692e 6d65  r=re.sub("dti.me
-0006a360: 616e 2e66 612e 222c 2222 2c61 6e61 7473  an.fa.","",anats
-0006a370: 6561 7229 0a20 2020 2020 2020 2020 2020  ear).           
-0006a380: 2061 6e61 7473 6561 723d 7265 2e73 7562   anatsear=re.sub
-0006a390: 2822 6c72 6176 6722 2c22 222c 616e 6174  ("lravg","",anat
-0006a3a0: 7365 6172 290a 2020 2020 2020 2020 2020  sear).          
-0006a3b0: 2020 6174 6c61 7373 6561 7263 6820 3d20    atlassearch = 
-0006a3c0: 6d79 6469 6374 5b27 7469 6479 6e61 6d65  mydict['tidyname
-0006a3d0: 7327 5d2e 7374 722e 636f 6e74 6169 6e73  s'].str.contains
-0006a3e0: 2861 6e61 7473 6561 7229 0a20 2020 2020  (anatsear).     
-0006a3f0: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
-0006a400: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0006a410: 2020 2070 7269 6e74 2820 2220 616e 6174     print( " anat
-0006a420: 7365 6172 2022 202b 2061 6e61 7473 6561  sear " + anatsea
-0006a430: 7220 2b20 2220 6174 6c61 7373 6561 7263  r + " atlassearc
-0006a440: 6820 2220 290a 2020 2020 2020 2020 2020  h " ).          
-0006a450: 2020 6966 2061 746c 6173 7365 6172 6368    if atlassearch
-0006a460: 2e73 756d 2829 203e 2030 3a0a 2020 2020  .sum() > 0:.    
-0006a470: 2020 2020 2020 2020 2020 2020 7768 6963              whic
-0006a480: 6861 746c 6173 203d 206d 7964 6963 745b  hatlas = mydict[
-0006a490: 6174 6c61 7373 6561 7263 685d 5b27 4174  atlassearch]['At
-0006a4a0: 6c61 7327 5d2e 696c 6f63 5b30 5d0a 2020  las'].iloc[0].  
-0006a4b0: 2020 2020 2020 2020 2020 2020 2020 6f67                og
-0006a4c0: 6c61 6265 6c6e 616d 6520 3d20 6d79 6469  labelname = mydi
-0006a4d0: 6374 5b61 746c 6173 7365 6172 6368 5d5b  ct[atlassearch][
-0006a4e0: 274c 6162 656c 275d 2e69 6c6f 635b 305d  'Label'].iloc[0]
-0006a4f0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0006a500: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0006a510: 2020 2070 7269 6e74 2861 6e61 7473 6561     print(anatsea
-0006a520: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-0006a530: 2020 206f 676c 6162 656c 6e61 6d65 3d27     oglabelname='
-0006a540: 756e 6b6e 6f77 6e27 0a20 2020 2020 2020  unknown'.       
-0006a550: 2020 2020 2020 2020 2077 6869 6368 6174           whichat
-0006a560: 6c61 733d 4e6f 6e65 0a20 2020 2020 2020  las=None.       
-0006a570: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-0006a580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006a590: 2070 7269 6e74 2822 6f67 6c61 6265 6c6e   print("oglabeln
-0006a5a0: 616d 6520 2220 2b20 6f67 6c61 6265 6c6e  ame " + oglabeln
-0006a5b0: 616d 6520 2b20 2220 7768 6963 6861 746c  ame + " whichatl
-0006a5c0: 6173 2022 202b 2073 7472 2877 6869 6368  as " + str(which
-0006a5d0: 6174 6c61 7329 2029 0a20 2020 2020 2020  atlas) ).       
-0006a5e0: 2020 2020 2076 616c 7332 7669 7a20 3d20       vals2viz = 
-0006a5f0: 6d79 7375 625b 636f 6c32 7669 7a5d 2e61  mysub[col2viz].a
-0006a600: 6767 285b 276d 696e 272c 2027 6d61 7827  gg(['min', 'max'
-0006a610: 5d29 0a20 2020 2020 2020 2020 2020 2076  ]).            v
-0006a620: 616c 7332 7669 7a20 3d20 7661 6c73 3276  als2viz = vals2v
-0006a630: 697a 5b61 6273 2876 616c 7332 7669 7a29  iz[abs(vals2viz)
-0006a640: 2e69 6478 6d61 7828 295d 0a20 2020 2020  .idxmax()].     
-0006a650: 2020 2020 2020 206d 7965 7874 203d 204e         myext = N
-0006a660: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-0006a670: 6966 2027 646b 7463 6f72 7465 7827 2069  if 'dktcortex' i
-0006a680: 6e20 616e 6174 746f 7368 6f77 5b6b 5d20  n anattoshow[k] 
-0006a690: 6f72 2077 6869 6368 6174 6c61 7320 3d3d  or whichatlas ==
-0006a6a0: 2027 6465 7369 6b61 6e2d 6b69 6c6c 6961   'desikan-killia
-0006a6b0: 6e79 2d74 6f75 7276 696c 6c65 2720 6f72  ny-tourville' or
-0006a6c0: 2027 6474 6b72 6567 696f 6e73 2720 696e   'dtkregions' in
-0006a6d0: 2061 6e61 7474 6f73 686f 775b 6b5d 3a0a   anattoshow[k]:.
-0006a6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a6f0: 6d79 6578 7420 3d20 2764 6b74 5f63 6f72  myext = 'dkt_cor
-0006a700: 7465 7827 0a20 2020 2020 2020 2020 2020  tex'.           
-0006a710: 2065 6c69 6620 2763 6974 3136 3827 2069   elif 'cit168' i
-0006a720: 6e20 616e 6174 746f 7368 6f77 5b6b 5d20  n anattoshow[k] 
-0006a730: 6f72 2077 6869 6368 6174 6c61 7320 3d3d  or whichatlas ==
-0006a740: 2027 4349 5431 3638 273a 0a20 2020 2020   'CIT168':.     
-0006a750: 2020 2020 2020 2020 2020 206d 7965 7874             myext
-0006a760: 203d 2027 6369 7431 3638 6c61 6227 0a20   = 'cit168lab'. 
-0006a770: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0006a780: 276d 746c 2720 696e 2061 6e61 7474 6f73  'mtl' in anattos
-0006a790: 686f 775b 6b5d 3a0a 2020 2020 2020 2020  how[k]:.        
-0006a7a0: 2020 2020 2020 2020 6d79 6578 7420 3d20          myext = 
-0006a7b0: 276d 746c 270a 2020 2020 2020 2020 2020  'mtl'.          
-0006a7c0: 2020 2020 2020 6f67 6c61 6265 6c6e 616d        oglabelnam
-0006a7d0: 653d 7265 2e73 7562 2827 6d74 6c27 2c20  e=re.sub('mtl', 
-0006a7e0: 2727 2c61 6e61 7473 6561 7229 0a20 2020  '',anatsear).   
-0006a7f0: 2020 2020 2020 2020 2065 6c69 6620 2763           elif 'c
-0006a800: 6572 6562 656c 6c75 6d27 2069 6e20 616e  erebellum' in an
-0006a810: 6174 746f 7368 6f77 5b6b 5d3a 0a20 2020  attoshow[k]:.   
-0006a820: 2020 2020 2020 2020 2020 2020 206d 7965               mye
-0006a830: 7874 203d 2027 6365 7265 6265 6c6c 756d  xt = 'cerebellum
-0006a840: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0006a850: 2020 6f67 6c61 6265 6c6e 616d 653d 7265    oglabelname=re
-0006a860: 2e73 7562 2827 6365 7265 6265 6c6c 756d  .sub('cerebellum
-0006a870: 272c 2027 272c 616e 6174 7365 6172 290a  ', '',anatsear).
-0006a880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a890: 2320 6f67 6c61 6265 6c6e 616d 653d 6f67  # oglabelname=og
-0006a8a0: 6c61 6265 6c6e 616d 655b 323a 5d0a 2020  labelname[2:].  
-0006a8b0: 2020 2020 2020 2020 2020 656c 6966 2027            elif '
-0006a8c0: 6272 6169 6e73 7465 6d27 2069 6e20 616e  brainstem' in an
-0006a8d0: 6174 746f 7368 6f77 5b6b 5d3a 0a20 2020  attoshow[k]:.   
-0006a8e0: 2020 2020 2020 2020 2020 2020 206d 7965               mye
-0006a8f0: 7874 203d 2027 6272 6169 6e73 7465 6d27  xt = 'brainstem'
-0006a900: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-0006a910: 6620 616e 7928 6974 656d 2069 6e20 616e  f any(item in an
-0006a920: 6174 746f 7368 6f77 5b6b 5d20 666f 7220  attoshow[k] for 
-0006a930: 6974 656d 2069 6e20 5b27 6e62 6d27 2c20  item in ['nbm', 
-0006a940: 2762 6627 5d29 3a0a 2020 2020 2020 2020  'bf']):.        
-0006a950: 2020 2020 2020 2020 6d79 6578 7420 3d20          myext = 
-0006a960: 2762 6627 0a20 2020 2020 2020 2020 2020  'bf'.           
-0006a970: 2020 2020 206f 676c 6162 656c 6e61 6d65       oglabelname
-0006a980: 3d72 652e 7375 6228 7227 5c2e 272c 2027  =re.sub(r'\.', '
-0006a990: 5f27 2c61 6e61 7473 6561 7229 0a20 2020  _',anatsear).   
-0006a9a0: 2020 2020 2020 2020 2065 6c69 6620 7768           elif wh
-0006a9b0: 6963 6861 746c 6173 203d 3d20 276a 6f68  ichatlas == 'joh
-0006a9c0: 6e73 2068 6f70 6b69 6e73 2077 6869 7465  ns hopkins white
-0006a9d0: 206d 6174 7465 7227 3a0a 2020 2020 2020   matter':.      
-0006a9e0: 2020 2020 2020 2020 2020 6d79 6578 7420            myext 
-0006a9f0: 3d20 274a 4855 5f77 6d27 0a20 2020 2020  = 'JHU_wm'.     
-0006aa00: 2020 2020 2020 2065 6c69 6620 7768 6963         elif whic
-0006aa10: 6861 746c 6173 203d 3d20 2764 6573 696b  hatlas == 'desik
-0006aa20: 616e 2d6b 696c 6c69 616e 792d 746f 7572  an-killiany-tour
-0006aa30: 7669 6c6c 6527 3a0a 2020 2020 2020 2020  ville':.        
-0006aa40: 2020 2020 2020 2020 6d79 6578 7420 3d20          myext = 
-0006aa50: 2764 6b74 5f63 6f72 7465 7827 0a20 2020  'dkt_cortex'.   
-0006aa60: 2020 2020 2020 2020 2065 6c69 6620 7768           elif wh
-0006aa70: 6963 6861 746c 6173 203d 3d20 2743 4954  ichatlas == 'CIT
-0006aa80: 3136 3827 3a0a 2020 2020 2020 2020 2020  168':.          
-0006aa90: 2020 2020 2020 6d79 6578 7420 3d20 2763        myext = 'c
-0006aaa0: 6974 3136 386c 6162 270a 2020 2020 2020  it168lab'.      
-0006aab0: 2020 2020 2020 656c 6966 2077 6869 6368        elif which
-0006aac0: 6174 6c61 7320 3d3d 2027 4246 273a 0a20  atlas == 'BF':. 
-0006aad0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0006aae0: 7965 7874 203d 2027 6266 270a 2020 2020  yext = 'bf'.    
-0006aaf0: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
-0006ab00: 6265 6c6e 616d 653d 7265 2e73 7562 2827  belname=re.sub('
-0006ab10: 6266 272c 2027 272c 6f67 6c61 6265 6c6e  bf', '',oglabeln
-0006ab20: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-0006ab30: 2065 6c69 6620 7768 6963 6861 746c 6173   elif whichatlas
-0006ab40: 203d 3d20 2779 656f 5f68 6f6d 6f74 6f70   == 'yeo_homotop
-0006ab50: 6963 273a 0a20 2020 2020 2020 2020 2020  ic':.           
-0006ab60: 2020 2020 206d 7965 7874 203d 2027 7965       myext = 'ye
-0006ab70: 6f27 0a20 2020 2020 2020 2020 2020 2069  o'.            i
-0006ab80: 6620 6d79 6578 7420 6973 204e 6f6e 6520  f myext is None 
-0006ab90: 616e 6420 7665 7262 6f73 653a 0a20 2020  and verbose:.   
-0006aba0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0006abb0: 7768 6963 6861 746c 6173 2069 7320 4e6f  whichatlas is No
-0006abc0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0006abd0: 2020 2020 2020 2020 7768 6963 6861 746c          whichatl
-0006abe0: 6173 3d27 4e6f 6e65 270a 2020 2020 2020  as='None'.      
-0006abf0: 2020 2020 2020 2020 2020 6966 2061 6e61            if ana
-0006ac00: 7474 6f73 686f 775b 6b5d 2069 7320 4e6f  ttoshow[k] is No
-0006ac10: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0006ac20: 2020 2020 2020 2020 616e 6174 746f 7368          anattosh
-0006ac30: 6f77 5b6b 5d3d 274e 6f6e 6527 0a20 2020  ow[k]='None'.   
-0006ac40: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0006ac50: 6e74 2820 224d 5945 5854 2022 202b 2061  nt( "MYEXT " + a
-0006ac60: 6e61 7474 6f73 686f 775b 6b5d 202b 2027  nattoshow[k] + '
-0006ac70: 2075 6e66 6f75 6e64 2027 202b 2077 6869   unfound ' + whi
-0006ac80: 6368 6174 6c61 7320 290a 2020 2020 2020  chatlas ).      
-0006ac90: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0006aca0: 2020 2020 2020 2020 2020 2020 6966 2076              if v
-0006acb0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-0006acc0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0006acd0: 7428 2022 4d59 4558 5420 2220 2b20 6d79  t( "MYEXT " + my
-0006ace0: 6578 7420 290a 0a20 2020 2020 2020 2020  ext )..         
-0006acf0: 2020 2069 6620 6d79 6578 7420 3d3d 2027     if myext == '
-0006ad00: 6369 7431 3638 6c61 6227 3a0a 2020 2020  cit168lab':.    
-0006ad10: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
-0006ad20: 6265 6c6e 616d 653d 7265 2e73 7562 2822  belname=re.sub("
-0006ad30: 6369 7431 3638 222c 2222 2c6f 676c 6162  cit168","",oglab
-0006ad40: 656c 6e61 6d65 290a 2020 2020 2020 2020  elname).        
-0006ad50: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-0006ad60: 2066 6f72 206a 2069 6e20 706f 7374 6669   for j in postfi
-0006ad70: 783a 0a20 2020 2020 2020 2020 2020 2020  x:.             
-0006ad80: 2020 2069 6620 6a20 3d3d 2022 646b 745f     if j == "dkt_
-0006ad90: 636f 7274 6578 223a 0a20 2020 2020 2020  cortex":.       
-0006ada0: 2020 2020 2020 2020 2020 2020 206a 203d               j =
-0006adb0: 2027 646b 7463 6f72 7465 7827 0a20 2020   'dktcortex'.   
-0006adc0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0006add0: 6a20 3d3d 2022 6465 6570 5f63 6974 3136  j == "deep_cit16
-0006ade0: 386c 6162 223a 0a20 2020 2020 2020 2020  8lab":.         
-0006adf0: 2020 2020 2020 2020 2020 206a 203d 2027             j = '
-0006ae00: 6465 6570 5f63 6974 3136 3827 0a20 2020  deep_cit168'.   
-0006ae10: 2020 2020 2020 2020 2020 2020 2061 6e61               ana
-0006ae20: 7474 6f73 686f 775b 6b5d 203d 2061 6e61  ttoshow[k] = ana
-0006ae30: 7474 6f73 686f 775b 6b5d 2e72 6570 6c61  ttoshow[k].repla
-0006ae40: 6365 286a 2c20 2222 290a 2020 2020 2020  ce(j, "").      
-0006ae50: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-0006ae60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0006ae70: 2020 7072 696e 7428 2061 6e61 7474 6f73    print( anattos
-0006ae80: 686f 775b 6b5d 202b 2022 2022 202b 2073  how[k] + " " + s
-0006ae90: 7472 2820 7661 6c73 3276 697a 2029 2029  tr( vals2viz ) )
-0006aea0: 0a20 2020 2020 2020 2020 2020 206d 7961  .            mya
-0006aeb0: 746c 6173 203d 2061 746c 6173 5b70 6f73  tlas = atlas[pos
-0006aec0: 7466 6978 2e69 6e64 6578 286d 7965 7874  tfix.index(myext
-0006aed0: 295d 0a20 2020 2020 2020 2020 2020 2063  )].            c
-0006aee0: 6f72 7265 6374 6465 7363 7269 7074 203d  orrectdescript =
-0006aef0: 2070 6f73 7464 6573 635b 706f 7374 6669   postdesc[postfi
-0006af00: 782e 696e 6465 7828 6d79 6578 7429 5d0a  x.index(myext)].
-0006af10: 2020 2020 2020 2020 2020 2020 6c6f 6366              locf
-0006af20: 696c 656e 616d 6520 3d20 2074 656d 706c  ilename =  templ
-0006af30: 6174 6570 7265 6669 7820 2b20 6d79 6578  ateprefix + myex
-0006af40: 7420 2b20 272e 6e69 692e 677a 270a 2020  t + '.nii.gz'.  
-0006af50: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
-0006af60: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-0006af70: 2020 2020 2020 7072 696e 7428 206c 6f63        print( loc
-0006af80: 6669 6c65 6e61 6d65 2029 0a20 2020 2020  filename ).     
-0006af90: 2020 2020 2020 2069 6620 6d79 6578 7420         if myext 
-0006afa0: 3d3d 2027 7965 6f27 3a0a 2020 2020 2020  == 'yeo':.      
-0006afb0: 2020 2020 2020 2020 2020 6f67 6c61 6265            oglabe
-0006afc0: 6c6e 616d 653d 6f67 6c61 6265 6c6e 616d  lname=oglabelnam
-0006afd0: 652e 6c6f 7765 7228 290a 2020 2020 2020  e.lower().      
-0006afe0: 2020 2020 2020 2020 2020 6f67 6c61 6265            oglabe
-0006aff0: 6c6e 616d 653d 7265 2e73 7562 2822 7273  lname=re.sub("rs
-0006b000: 666d 7269 5f66 636e 7870 726f 3132 325f  fmri_fcnxpro122_
-0006b010: 222c 2222 2c6f 676c 6162 656c 6e61 6d65  ","",oglabelname
-0006b020: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0006b030: 2020 6f67 6c61 6265 6c6e 616d 653d 7265    oglabelname=re
-0006b040: 2e73 7562 2822 7273 666d 7269 5f66 636e  .sub("rsfmri_fcn
-0006b050: 7870 726f 3132 395f 222c 2222 2c6f 676c  xpro129_","",ogl
-0006b060: 6162 656c 6e61 6d65 290a 2020 2020 2020  abelname).      
-0006b070: 2020 2020 2020 2020 2020 6f67 6c61 6265            oglabe
-0006b080: 6c6e 616d 653d 7265 2e73 7562 2822 7273  lname=re.sub("rs
-0006b090: 666d 7269 5f66 636e 7870 726f 3133 345f  fmri_fcnxpro134_
-0006b0a0: 222c 2222 2c6f 676c 6162 656c 6e61 6d65  ","",oglabelname
-0006b0b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0006b0c0: 2020 6c6f 6366 696c 656e 616d 6520 3d20    locfilename = 
-0006b0d0: 227e 2f2e 616e 7473 7079 6d6d 2f70 706d  "~/.antspymm/ppm
-0006b0e0: 695f 7465 6d70 6c61 7465 5f35 3030 5061  i_template_500Pa
-0006b0f0: 7263 656c 735f 5965 6f32 3031 315f 3137  rcels_Yeo2011_17
-0006b100: 4e65 7477 6f72 6b73 5f32 3032 335f 686f  Networks_2023_ho
-0006b110: 6d6f 746f 7069 632e 6e69 692e 677a 220a  motopic.nii.gz".
-0006b120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b130: 6174 6c61 7344 6573 6372 6970 7420 3d20  atlasDescript = 
-0006b140: 7064 2e72 6561 645f 6373 7628 6622 7e2f  pd.read_csv(f"~/
-0006b150: 2e61 6e74 7370 796d 6d2f 7b63 6f72 7265  .antspymm/{corre
-0006b160: 6374 6465 7363 7269 7074 7d2e 6373 7622  ctdescript}.csv"
-0006b170: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0006b180: 2020 6174 6c61 7344 6573 6372 6970 742e    atlasDescript.
-0006b190: 7265 6e61 6d65 2863 6f6c 756d 6e73 3d7b  rename(columns={
-0006b1a0: 2753 7973 7465 6d4e 616d 6527 3a20 2744  'SystemName': 'D
-0006b1b0: 6573 6372 6970 7469 6f6e 277d 2c20 696e  escription'}, in
-0006b1c0: 706c 6163 653d 5472 7565 290a 2020 2020  place=True).    
-0006b1d0: 2020 2020 2020 2020 2020 2020 6174 6c61              atla
-0006b1e0: 7344 6573 6372 6970 742e 7265 6e61 6d65  sDescript.rename
-0006b1f0: 2863 6f6c 756d 6e73 3d7b 2752 4f49 273a  (columns={'ROI':
-0006b200: 2027 4c61 6265 6c27 7d2c 2069 6e70 6c61   'Label'}, inpla
-0006b210: 6365 3d54 7275 6529 0a20 2020 2020 2020  ce=True).       
-0006b220: 2020 2020 2020 2020 2061 746c 6173 4465           atlasDe
-0006b230: 7363 7269 7074 5b27 4465 7363 7269 7074  script['Descript
-0006b240: 696f 6e27 5d20 3d20 6174 6c61 7344 6573  ion'] = atlasDes
-0006b250: 6372 6970 745b 2744 6573 6372 6970 7469  cript['Descripti
-0006b260: 6f6e 275d 2e73 7472 2e6c 6f77 6572 2829  on'].str.lower()
-0006b270: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0006b280: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0006b290: 2020 2061 746c 6173 4465 7363 7269 7074     atlasDescript
-0006b2a0: 203d 2070 642e 7265 6164 5f63 7376 2866   = pd.read_csv(f
-0006b2b0: 227e 2f2e 616e 7473 7079 7431 772f 7b63  "~/.antspyt1w/{c
-0006b2c0: 6f72 7265 6374 6465 7363 7269 7074 7d2e  orrectdescript}.
-0006b2d0: 6373 7622 290a 2020 2020 2020 2020 2020  csv").          
-0006b2e0: 2020 2020 2020 6174 6c61 7344 6573 6372        atlasDescr
-0006b2f0: 6970 745b 2744 6573 6372 6970 7469 6f6e  ipt['Description
-0006b300: 275d 203d 2061 746c 6173 4465 7363 7269  '] = atlasDescri
-0006b310: 7074 5b27 4465 7363 7269 7074 696f 6e27  pt['Description'
-0006b320: 5d2e 7374 722e 6c6f 7765 7228 290a 2020  ].str.lower().  
-0006b330: 2020 2020 2020 2020 2020 2020 2020 6174                at
-0006b340: 6c61 7344 6573 6372 6970 745b 2744 6573  lasDescript['Des
-0006b350: 6372 6970 7469 6f6e 275d 203d 2061 746c  cription'] = atl
-0006b360: 6173 4465 7363 7269 7074 5b27 4465 7363  asDescript['Desc
-0006b370: 7269 7074 696f 6e27 5d2e 7374 722e 7265  ription'].str.re
-0006b380: 706c 6163 6528 2220 222c 2022 5f22 290a  place(" ", "_").
-0006b390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b3a0: 6174 6c61 7344 6573 6372 6970 745b 2744  atlasDescript['D
-0006b3b0: 6573 6372 6970 7469 6f6e 275d 203d 2061  escription'] = a
-0006b3c0: 746c 6173 4465 7363 7269 7074 5b27 4465  tlasDescript['De
-0006b3d0: 7363 7269 7074 696f 6e27 5d2e 7374 722e  scription'].str.
-0006b3e0: 7265 706c 6163 6528 225f 6c65 6674 5f22  replace("_left_"
-0006b3f0: 2c20 225f 2229 0a20 2020 2020 2020 2020  , "_").         
-0006b400: 2020 2020 2020 2061 746c 6173 4465 7363         atlasDesc
-0006b410: 7269 7074 5b27 4465 7363 7269 7074 696f  ript['Descriptio
-0006b420: 6e27 5d20 3d20 6174 6c61 7344 6573 6372  n'] = atlasDescr
-0006b430: 6970 745b 2744 6573 6372 6970 7469 6f6e  ipt['Description
-0006b440: 275d 2e73 7472 2e72 6570 6c61 6365 2822  '].str.replace("
-0006b450: 5f72 6967 6874 5f22 2c20 225f 2229 0a20  _right_", "_"). 
-0006b460: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0006b470: 746c 6173 4465 7363 7269 7074 5b27 4465  tlasDescript['De
-0006b480: 7363 7269 7074 696f 6e27 5d20 3d20 6174  scription'] = at
-0006b490: 6c61 7344 6573 6372 6970 745b 2744 6573  lasDescript['Des
-0006b4a0: 6372 6970 7469 6f6e 275d 2e73 7472 2e72  cription'].str.r
-0006b4b0: 6570 6c61 6365 2822 5f6c 6566 7422 2c20  eplace("_left", 
-0006b4c0: 2222 290a 2020 2020 2020 2020 2020 2020  "").            
-0006b4d0: 2020 2020 6174 6c61 7344 6573 6372 6970      atlasDescrip
-0006b4e0: 745b 2744 6573 6372 6970 7469 6f6e 275d  t['Description']
-0006b4f0: 203d 2061 746c 6173 4465 7363 7269 7074   = atlasDescript
-0006b500: 5b27 4465 7363 7269 7074 696f 6e27 5d2e  ['Description'].
-0006b510: 7374 722e 7265 706c 6163 6528 225f 7269  str.replace("_ri
-0006b520: 6768 7422 2c20 2222 290a 2020 2020 2020  ght", "").      
-0006b530: 2020 2020 2020 2020 2020 6174 6c61 7344            atlasD
-0006b540: 6573 6372 6970 745b 2744 6573 6372 6970  escript['Descrip
-0006b550: 7469 6f6e 275d 203d 2061 746c 6173 4465  tion'] = atlasDe
-0006b560: 7363 7269 7074 5b27 4465 7363 7269 7074  script['Descript
-0006b570: 696f 6e27 5d2e 7374 722e 7265 706c 6163  ion'].str.replac
-0006b580: 6528 226c 6566 745f 222c 2022 2229 0a20  e("left_", ""). 
-0006b590: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0006b5a0: 746c 6173 4465 7363 7269 7074 5b27 4465  tlasDescript['De
-0006b5b0: 7363 7269 7074 696f 6e27 5d20 3d20 6174  scription'] = at
-0006b5c0: 6c61 7344 6573 6372 6970 745b 2744 6573  lasDescript['Des
-0006b5d0: 6372 6970 7469 6f6e 275d 2e73 7472 2e72  cription'].str.r
-0006b5e0: 6570 6c61 6365 2822 7269 6768 745f 222c  eplace("right_",
-0006b5f0: 2022 2229 0a20 2020 2020 2020 2020 2020   "").           
-0006b600: 2020 2020 2061 746c 6173 4465 7363 7269       atlasDescri
-0006b610: 7074 5b27 4465 7363 7269 7074 696f 6e27  pt['Description'
-0006b620: 5d20 3d20 6174 6c61 7344 6573 6372 6970  ] = atlasDescrip
-0006b630: 745b 2744 6573 6372 6970 7469 6f6e 275d  t['Description']
-0006b640: 2e73 7472 2e72 6570 6c61 6365 2822 2f22  .str.replace("/"
-0006b650: 2c22 2e22 290a 2020 2020 2020 2020 2020  ,".").          
-0006b660: 2020 2020 2020 6966 206d 7965 7874 203d        if myext =
-0006b670: 3d20 274a 4855 5f77 6d27 3a0a 2020 2020  = 'JHU_wm':.    
-0006b680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b690: 6174 6c61 7344 6573 6372 6970 745b 2744  atlasDescript['D
-0006b6a0: 6573 6372 6970 7469 6f6e 275d 203d 2061  escription'] = a
-0006b6b0: 746c 6173 4465 7363 7269 7074 5b27 4465  tlasDescript['De
-0006b6c0: 7363 7269 7074 696f 6e27 5d2e 7374 722e  scription'].str.
-0006b6d0: 7265 706c 6163 6528 2266 612d 222c 2022  replace("fa-", "
-0006b6e0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-0006b6f0: 2020 2020 2020 2061 746c 6173 4465 7363         atlasDesc
-0006b700: 7269 7074 5b27 4465 7363 7269 7074 696f  ript['Descriptio
-0006b710: 6e27 5d20 3d20 6174 6c61 7344 6573 6372  n'] = atlasDescr
-0006b720: 6970 745b 2744 6573 6372 6970 7469 6f6e  ipt['Description
-0006b730: 275d 2e73 7472 2e72 6570 6c61 6365 2822  '].str.replace("
-0006b740: 2d6c 6566 742d 222c 2022 2229 0a20 2020  -left-", "").   
-0006b750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b760: 2061 746c 6173 4465 7363 7269 7074 5b27   atlasDescript['
-0006b770: 4465 7363 7269 7074 696f 6e27 5d20 3d20  Description'] = 
-0006b780: 6174 6c61 7344 6573 6372 6970 745b 2744  atlasDescript['D
-0006b790: 6573 6372 6970 7469 6f6e 275d 2e73 7472  escription'].str
-0006b7a0: 2e72 6570 6c61 6365 2822 2d72 6967 6874  .replace("-right
-0006b7b0: 2d22 2c20 2222 290a 2020 2020 2020 2020  -", "").        
-0006b7c0: 2020 2020 2020 2020 6966 206d 7965 7874          if myext
-0006b7d0: 203d 3d20 2763 6572 6562 656c 6c75 6d27   == 'cerebellum'
-0006b7e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0006b7f0: 2020 2020 2020 6174 6c61 7344 6573 6372        atlasDescr
-0006b800: 6970 745b 2744 6573 6372 6970 7469 6f6e  ipt['Description
-0006b810: 275d 203d 2061 746c 6173 4465 7363 7269  '] = atlasDescri
-0006b820: 7074 5b27 4465 7363 7269 7074 696f 6e27  pt['Description'
-0006b830: 5d2e 7374 722e 7265 706c 6163 6528 226c  ].str.replace("l
-0006b840: 5f22 2c20 2222 290a 2020 2020 2020 2020  _", "").        
-0006b850: 2020 2020 2020 2020 2020 2020 6174 6c61              atla
-0006b860: 7344 6573 6372 6970 745b 2744 6573 6372  sDescript['Descr
-0006b870: 6970 7469 6f6e 275d 203d 2061 746c 6173  iption'] = atlas
-0006b880: 4465 7363 7269 7074 5b27 4465 7363 7269  Descript['Descri
-0006b890: 7074 696f 6e27 5d2e 7374 722e 7265 706c  ption'].str.repl
-0006b8a0: 6163 6528 2272 5f22 2c20 2222 290a 0a20  ace("r_", "").. 
-0006b8b0: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
-0006b8c0: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
-0006b8d0: 2020 2020 2020 2070 7269 6e74 2820 6174         print( at
-0006b8e0: 6c61 7344 6573 6372 6970 7420 290a 2020  lasDescript ).  
-0006b8f0: 2020 2020 2020 2020 2020 6f67 6c61 6265            oglabe
-0006b900: 6c6e 616d 6520 3d20 6f67 6c61 6265 6c6e  lname = oglabeln
-0006b910: 616d 652e 6c6f 7765 7228 290a 2020 2020  ame.lower().    
-0006b920: 2020 2020 2020 2020 6f67 6c61 6265 6c6e          oglabeln
-0006b930: 616d 6520 3d20 7265 2e73 7562 2822 2022  ame = re.sub(" "
-0006b940: 2c20 225f 222c 6f67 6c61 6265 6c6e 616d  , "_",oglabelnam
-0006b950: 6529 0a20 2020 2020 2020 2020 2020 206f  e).            o
-0006b960: 676c 6162 656c 6e61 6d65 203d 2072 652e  glabelname = re.
-0006b970: 7375 6228 225f 6c65 6674 5f22 2c20 225f  sub("_left_", "_
-0006b980: 222c 6f67 6c61 6265 6c6e 616d 6529 0a20  ",oglabelname). 
-0006b990: 2020 2020 2020 2020 2020 206f 676c 6162             oglab
-0006b9a0: 656c 6e61 6d65 203d 2072 652e 7375 6228  elname = re.sub(
-0006b9b0: 225f 7269 6768 745f 222c 2022 5f22 2c6f  "_right_", "_",o
-0006b9c0: 676c 6162 656c 6e61 6d65 290a 2020 2020  glabelname).    
-0006b9d0: 2020 2020 2020 2020 6f67 6c61 6265 6c6e          oglabeln
-0006b9e0: 616d 6520 3d20 7265 2e73 7562 2822 5f6c  ame = re.sub("_l
-0006b9f0: 6566 7422 2c20 2222 2c6f 676c 6162 656c  eft", "",oglabel
-0006ba00: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
-0006ba10: 2020 6f67 6c61 6265 6c6e 616d 6520 3d20    oglabelname = 
-0006ba20: 7265 2e73 7562 2822 5f72 6967 6874 222c  re.sub("_right",
-0006ba30: 2022 222c 6f67 6c61 6265 6c6e 616d 6529   "",oglabelname)
-0006ba40: 0a20 2020 2020 2020 2020 2020 206f 676c  .            ogl
-0006ba50: 6162 656c 6e61 6d65 203d 2072 652e 7375  abelname = re.su
-0006ba60: 6228 2274 3168 6965 725f 766f 6c5f 222c  b("t1hier_vol_",
-0006ba70: 2022 222c 6f67 6c61 6265 6c6e 616d 6529   "",oglabelname)
-0006ba80: 0a20 2020 2020 2020 2020 2020 206f 676c  .            ogl
-0006ba90: 6162 656c 6e61 6d65 203d 2072 652e 7375  abelname = re.su
-0006baa0: 6228 2274 3168 6965 725f 6172 6561 5f22  b("t1hier_area_"
-0006bab0: 2c20 2222 2c6f 676c 6162 656c 6e61 6d65  , "",oglabelname
-0006bac0: 290a 2020 2020 2020 2020 2020 2020 6f67  ).            og
-0006bad0: 6c61 6265 6c6e 616d 6520 3d20 7265 2e73  labelname = re.s
-0006bae0: 7562 2822 7431 6869 6572 5f74 686b 5f22  ub("t1hier_thk_"
-0006baf0: 2c20 2222 2c6f 676c 6162 656c 6e61 6d65  , "",oglabelname
-0006bb00: 290a 2020 2020 2020 2020 2020 2020 6f67  ).            og
-0006bb10: 6c61 6265 6c6e 616d 6520 3d20 7265 2e73  labelname = re.s
-0006bb20: 7562 2822 646b 7472 6567 696f 6e73 222c  ub("dktregions",
-0006bb30: 2022 222c 6f67 6c61 6265 6c6e 616d 6529   "",oglabelname)
-0006bb40: 0a20 2020 2020 2020 2020 2020 206f 676c  .            ogl
-0006bb50: 6162 656c 6e61 6d65 203d 2072 652e 7375  abelname = re.su
-0006bb60: 6228 2264 6b74 636f 7274 6578 222c 2022  b("dktcortex", "
-0006bb70: 222c 6f67 6c61 6265 6c6e 616d 6529 0a20  ",oglabelname). 
-0006bb80: 2020 2020 2020 2020 2020 2069 6620 6d79             if my
-0006bb90: 6578 7420 3d3d 2027 4a48 555f 776d 273a  ext == 'JHU_wm':
-0006bba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006bbb0: 206f 676c 6162 656c 6e61 6d65 203d 2072   oglabelname = r
-0006bbc0: 652e 7375 6228 2264 7469 5f6d 6561 6e5f  e.sub("dti_mean_
-0006bbd0: 6661 2e22 2c20 2222 2c6f 676c 6162 656c  fa.", "",oglabel
-0006bbe0: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
-0006bbf0: 2020 2020 2020 6f67 6c61 6265 6c6e 616d        oglabelnam
-0006bc00: 6520 3d20 7265 2e73 7562 2822 6474 695f  e = re.sub("dti_
-0006bc10: 6d65 616e 5f6d 642e 222c 2022 222c 6f67  mean_md.", "",og
-0006bc20: 6c61 6265 6c6e 616d 6529 0a20 2020 2020  labelname).     
-0006bc30: 2020 2020 2020 2020 2020 206f 676c 6162             oglab
-0006bc40: 656c 6e61 6d65 203d 2072 652e 7375 6228  elname = re.sub(
-0006bc50: 222e 6c65 6674 2e22 2c20 2222 2c6f 676c  ".left.", "",ogl
-0006bc60: 6162 656c 6e61 6d65 290a 2020 2020 2020  abelname).      
-0006bc70: 2020 2020 2020 2020 2020 6f67 6c61 6265            oglabe
-0006bc80: 6c6e 616d 6520 3d20 7265 2e73 7562 2822  lname = re.sub("
-0006bc90: 2e72 6967 6874 2e22 2c20 2222 2c6f 676c  .right.", "",ogl
-0006bca0: 6162 656c 6e61 6d65 290a 2020 2020 2020  abelname).      
-0006bcb0: 2020 2020 2020 2020 2020 6f67 6c61 6265            oglabe
-0006bcc0: 6c6e 616d 6520 3d20 7265 2e73 7562 2822  lname = re.sub("
-0006bcd0: 2e6c 7261 7667 2e22 2c20 2222 2c6f 676c  .lravg.", "",ogl
-0006bce0: 6162 656c 6e61 6d65 290a 2020 2020 2020  abelname).      
-0006bcf0: 2020 2020 2020 2020 2020 6f67 6c61 6265            oglabe
-0006bd00: 6c6e 616d 6520 3d20 7265 2e73 7562 2822  lname = re.sub("
-0006bd10: 2e61 7379 6d2e 222c 2022 222c 6f67 6c61  .asym.", "",ogla
-0006bd20: 6265 6c6e 616d 6529 0a0a 2020 2020 2020  belname)..      
-0006bd30: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-0006bd40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0006bd50: 2020 7072 696e 7428 226f 676c 6162 656c    print("oglabel
-0006bd60: 6e61 6d65 2022 202b 206f 676c 6162 656c  name " + oglabel
-0006bd70: 6e61 6d65 2029 0a0a 2020 2020 2020 2020  name )..        
-0006bd80: 2020 2020 6966 206d 7965 7874 203d 3d20      if myext == 
-0006bd90: 2763 6572 6562 656c 6c75 6d27 3a0a 2020  'cerebellum':.  
-0006bda0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0006bdb0: 206e 6f74 2061 746c 6173 4465 7363 7269   not atlasDescri
-0006bdc0: 7074 2e65 6d70 7479 2061 6e64 2027 4465  pt.empty and 'De
-0006bdd0: 7363 7269 7074 696f 6e27 2069 6e20 6174  scription' in at
-0006bde0: 6c61 7344 6573 6372 6970 742e 636f 6c75  lasDescript.colu
-0006bdf0: 6d6e 733a 0a20 2020 2020 2020 2020 2020  mns:.           
-0006be00: 2020 2020 2020 2020 2061 746c 6173 4465           atlasDe
-0006be10: 7363 7269 7074 5b27 4465 7363 7269 7074  script['Descript
-0006be20: 696f 6e27 5d20 3d20 6174 6c61 7344 6573  ion'] = atlasDes
-0006be30: 6372 6970 745b 2744 6573 6372 6970 7469  cript['Descripti
-0006be40: 6f6e 275d 2e73 7472 2e72 6570 6c61 6365  on'].str.replace
-0006be50: 2822 6c5f 222c 2022 2229 0a20 2020 2020  ("l_", "").     
-0006be60: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0006be70: 746c 6173 4465 7363 7269 7074 5b27 4465  tlasDescript['De
-0006be80: 7363 7269 7074 696f 6e27 5d20 3d20 6174  scription'] = at
-0006be90: 6c61 7344 6573 6372 6970 745b 2744 6573  lasDescript['Des
-0006bea0: 6372 6970 7469 6f6e 275d 2e73 7472 2e72  cription'].str.r
-0006beb0: 6570 6c61 6365 2822 725f 222c 2022 2229  eplace("r_", "")
-0006bec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006bed0: 2020 2020 206f 676c 6162 656c 6e61 6d65       oglabelname
-0006bee0: 3d72 652e 7375 6228 2272 6176 6722 2c22  =re.sub("ravg","
-0006bef0: 222c 6f67 6c61 6265 6c6e 616d 6529 0a20  ",oglabelname). 
-0006bf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006bf10: 2020 206f 676c 6162 656c 6e61 6d65 3d72     oglabelname=r
-0006bf20: 652e 7375 6228 226c 6176 6722 2c22 222c  e.sub("lavg","",
-0006bf30: 6f67 6c61 6265 6c6e 616d 6529 0a20 2020  oglabelname).   
-0006bf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006bf50: 2077 6869 6368 696e 6465 7820 3d20 6174   whichindex = at
-0006bf60: 6c61 7344 6573 6372 6970 742e 696e 6465  lasDescript.inde
-0006bf70: 785b 6174 6c61 7344 6573 6372 6970 745b  x[atlasDescript[
-0006bf80: 2744 6573 6372 6970 7469 6f6e 275d 203d  'Description'] =
-0006bf90: 3d20 6f67 6c61 6265 6c6e 616d 655d 2e76  = oglabelname].v
-0006bfa0: 616c 7565 735b 305d 0a20 2020 2020 2020  alues[0].       
-0006bfb0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0006bfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006bfd0: 2020 2069 6620 6174 6c61 7344 6573 6372     if atlasDescr
-0006bfe0: 6970 742e 656d 7074 793a 0a20 2020 2020  ipt.empty:.     
-0006bff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c000: 2020 2070 7269 6e74 2822 5468 6520 4461     print("The Da
-0006c010: 7461 4672 616d 6520 2761 746c 6173 4465  taFrame 'atlasDe
-0006c020: 7363 7269 7074 2720 6973 2065 6d70 7479  script' is empty
-0006c030: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
-0006c040: 2020 2020 2020 2020 6966 2027 4465 7363          if 'Desc
-0006c050: 7269 7074 696f 6e27 206e 6f74 2069 6e20  ription' not in 
-0006c060: 6174 6c61 7344 6573 6372 6970 742e 636f  atlasDescript.co
-0006c070: 6c75 6d6e 733a 0a20 2020 2020 2020 2020  lumns:.         
-0006c080: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0006c090: 7269 6e74 2822 5468 6520 636f 6c75 6d6e  rint("The column
-0006c0a0: 2027 4465 7363 7269 7074 696f 6e27 2064   'Description' d
-0006c0b0: 6f65 7320 6e6f 7420 6578 6973 7420 696e  oes not exist in
-0006c0c0: 2027 6174 6c61 7344 6573 6372 6970 7427   'atlasDescript'
-0006c0d0: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
-0006c0e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0006c0f0: 2020 2020 2020 7768 6963 6869 6e64 6578        whichindex
-0006c100: 203d 2061 746c 6173 4465 7363 7269 7074   = atlasDescript
-0006c110: 2e69 6e64 6578 5b61 746c 6173 4465 7363  .index[atlasDesc
-0006c120: 7269 7074 5b27 4465 7363 7269 7074 696f  ript['Descriptio
-0006c130: 6e27 5d2e 7374 722e 636f 6e74 6169 6e73  n'].str.contains
-0006c140: 286f 676c 6162 656c 6e61 6d65 295d 0a0a  (oglabelname)]..
-0006c150: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-0006c160: 7970 6528 7768 6963 6869 6e64 6578 2920  ype(whichindex) 
-0006c170: 6973 206e 702e 696e 7436 343a 0a20 2020  is np.int64:.   
-0006c180: 2020 2020 2020 2020 2020 2020 206c 6162               lab
-0006c190: 656c 6e75 6d73 203d 2061 746c 6173 4465  elnums = atlasDe
-0006c1a0: 7363 7269 7074 2e6c 6f63 5b77 6869 6368  script.loc[which
-0006c1b0: 696e 6465 782c 2027 4c61 6265 6c27 5d0a  index, 'Label'].
-0006c1c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0006c1d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0006c1e0: 2020 6c61 6265 6c6e 756d 7320 3d20 6c69    labelnums = li
-0006c1f0: 7374 2861 746c 6173 4465 7363 7269 7074  st(atlasDescript
-0006c200: 2e6c 6f63 5b77 6869 6368 696e 6465 782c  .loc[whichindex,
-0006c210: 2027 4c61 6265 6c27 5d29 0a0a 2020 2020   'Label'])..    
-0006c220: 2020 2020 2020 2020 6966 206d 7965 7874          if myext
-0006c230: 203d 3d20 2779 656f 273a 0a20 2020 2020   == 'yeo':.     
-0006c240: 2020 2020 2020 2020 2020 2070 6172 7473             parts
-0006c250: 203d 2072 652e 6669 6e64 616c 6c28 7227   = re.findall(r'
-0006c260: 5c44 2b27 2c20 6f67 6c61 6265 6c6e 616d  \D+', oglabelnam
-0006c270: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-0006c280: 2020 206f 676c 6162 656c 6e61 6d65 203d     oglabelname =
-0006c290: 205b 7061 7274 2e72 6570 6c61 6365 2827   [part.replace('
-0006c2a0: 5f27 2c20 2727 2920 666f 7220 7061 7274  _', '') for part
-0006c2b0: 2069 6e20 7061 7274 7320 6966 2070 6172   in parts if par
-0006c2c0: 742e 7265 706c 6163 6528 275f 272c 2027  t.replace('_', '
-0006c2d0: 2729 5d0a 2020 2020 2020 2020 2020 2020  ')].            
-0006c2e0: 2020 2020 6669 6c74 6572 6564 5f64 6620      filtered_df 
-0006c2f0: 3d20 6174 6c61 7344 6573 6372 6970 745b  = atlasDescript[
-0006c300: 6174 6c61 7344 6573 6372 6970 745b 2744  atlasDescript['D
-0006c310: 6573 6372 6970 7469 6f6e 275d 2e69 7369  escription'].isi
-0006c320: 6e28 6f67 6c61 6265 6c6e 616d 6529 5d0a  n(oglabelname)].
-0006c330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c340: 6c61 6265 6c6e 756d 7320 3d20 6669 6c74  labelnums = filt
-0006c350: 6572 6564 5f64 665b 274c 6162 656c 275d  ered_df['Label']
-0006c360: 2e74 6f6c 6973 7428 290a 0a20 2020 2020  .tolist()..     
-0006c370: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
-0006c380: 696e 7374 616e 6365 286c 6162 656c 6e75  instance(labelnu
-0006c390: 6d73 2c20 6c69 7374 293a 0a20 2020 2020  ms, list):.     
-0006c3a0: 2020 2020 2020 2020 2020 206c 6162 656c             label
-0006c3b0: 6e75 6d73 3d5b 6c61 6265 6c6e 756d 735d  nums=[labelnums]
-0006c3c0: 0a20 2020 2020 2020 2020 2020 2061 6464  .            add
-0006c3d0: 656d 6973 7a65 726f 203d 2061 6e74 732e  emiszero = ants.
-0006c3e0: 7468 7265 7368 6f6c 645f 696d 6167 6528  threshold_image(
-0006c3f0: 6164 6465 6d2c 2030 2c20 3029 0a20 2020  addem, 0, 0).   
-0006c400: 2020 2020 2020 2020 2074 656d 7020 3d20           temp = 
-0006c410: 616e 7473 2e69 6d61 6765 5f72 6561 6428  ants.image_read(
-0006c420: 6c6f 6366 696c 656e 616d 6529 0a20 2020  locfilename).   
-0006c430: 2020 2020 2020 2020 2074 656d 7020 3d20           temp = 
-0006c440: 616e 7473 2e6d 6173 6b5f 696d 6167 6528  ants.mask_image(
-0006c450: 7465 6d70 2c20 7465 6d70 2c20 6c65 7665  temp, temp, leve
-0006c460: 6c3d 6c61 6265 6c6e 756d 732c 2062 696e  l=labelnums, bin
-0006c470: 6172 697a 653d 5472 7565 290a 2020 2020  arize=True).    
-0006c480: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-0006c490: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0006c4a0: 2020 2020 7072 696e 7428 2244 4542 5547      print("DEBUG
-0006c4b0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-0006c4c0: 2020 2070 7269 6e74 2820 2074 656d 702e     print(  temp.
-0006c4d0: 7375 6d28 2920 2920 0a20 2020 2020 2020  sum() ) .       
-0006c4e0: 2020 2020 2020 2020 2070 7269 6e74 2820           print( 
-0006c4f0: 6c61 6265 6c6e 756d 7320 290a 2020 2020  labelnums ).    
-0006c500: 2020 2020 2020 2020 7465 6d70 5b74 656d          temp[tem
-0006c510: 7020 3d3d 2031 5d20 3d20 2876 616c 7332  p == 1] = (vals2
-0006c520: 7669 7a29 0a20 2020 2020 2020 2020 2020  viz).           
-0006c530: 2074 656d 705b 6164 6465 6d69 737a 6572   temp[addemiszer
-0006c540: 6f20 3d3d 2030 5d20 3d20 300a 2020 2020  o == 0] = 0.    
-0006c550: 2020 2020 2020 2020 6164 6465 6d20 3d20          addem = 
-0006c560: 6164 6465 6d20 2b20 7465 6d70 0a0a 2020  addem + temp..  
-0006c570: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-0006c580: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-0006c590: 696e 7428 2744 6f6e 6520 4164 6469 6e67  int('Done Adding
-0006c5a0: 2729 0a20 2020 2020 2020 2066 6f72 2061  ').        for a
-0006c5b0: 7878 2069 6e20 6178 6573 3a0a 2020 2020  xx in axes:.    
-0006c5c0: 2020 2020 2020 2020 6669 6766 6e3d 6f75          figfn=ou
-0006c5d0: 7470 7574 5f70 7265 6669 782b 6622 6669  tput_prefix+f"fi
-0006c5e0: 677b 636f 6c32 7669 7a7d 6178 7b61 7878  g{col2viz}ax{axx
-0006c5f0: 7d5f 7079 2e6a 7067 220a 2020 2020 2020  }_py.jpg".      
-0006c600: 2020 2020 2020 6966 2063 726f 7020 3e20        if crop > 
-0006c610: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-0006c620: 2020 2063 6d61 736b 203d 2061 6e74 732e     cmask = ants.
-0006c630: 7468 7265 7368 6f6c 645f 696d 6167 6528  threshold_image(
-0006c640: 2061 6464 656d 2c31 652d 352c 2031 6539   addem,1e-5, 1e9
-0006c650: 2029 2e69 4d61 7468 2822 4d44 222c 6372   ).iMath("MD",cr
-0006c660: 6f70 2920 2b20 616e 7473 2e74 6872 6573  op) + ants.thres
-0006c670: 686f 6c64 5f69 6d61 6765 2820 6164 6465  hold_image( adde
-0006c680: 6d2c 2d31 6539 2c20 2d31 652d 3520 292e  m,-1e9, -1e-5 ).
-0006c690: 694d 6174 6828 224d 4422 2c63 726f 7029  iMath("MD",crop)
-0006c6a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006c6b0: 2061 6464 656d 4320 3d20 616e 7473 2e63   addemC = ants.c
-0006c6c0: 726f 705f 696d 6167 6528 2061 6464 656d  rop_image( addem
-0006c6d0: 2c20 636d 6173 6b20 290a 2020 2020 2020  , cmask ).      
-0006c6e0: 2020 2020 2020 2020 2020 6564 6765 696d            edgeim
-0006c6f0: 6743 203d 2061 6e74 732e 6372 6f70 5f69  gC = ants.crop_i
-0006c700: 6d61 6765 2820 6564 6765 696d 672c 2063  mage( edgeimg, c
-0006c710: 6d61 736b 2029 0a20 2020 2020 2020 2020  mask ).         
-0006c720: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0006c730: 2020 2020 2020 2020 2061 6464 656d 4320           addemC 
-0006c740: 3d20 6164 6465 6d0a 2020 2020 2020 2020  = addem.        
-0006c750: 2020 2020 2020 2020 6564 6765 696d 6743          edgeimgC
-0006c760: 203d 2065 6467 6569 6d67 0a20 2020 2020   = edgeimg.     
-0006c770: 2020 2020 2020 2069 6620 6669 7865 645f         if fixed_
-0006c780: 6f76 6572 6c61 795f 7261 6e67 6520 6973  overlay_range is
-0006c790: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0006c7a0: 2020 2020 2020 2020 2020 2061 6464 656d             addem
-0006c7b0: 435b 303a 332c 303a 332c 303a 335d 3d66  C[0:3,0:3,0:3]=f
-0006c7c0: 6978 6564 5f6f 7665 726c 6179 5f72 616e  ixed_overlay_ran
-0006c7d0: 6765 5b30 5d0a 2020 2020 2020 2020 2020  ge[0].          
-0006c7e0: 2020 2020 2020 6164 6465 6d43 5b34 3a37        addemC[4:7
-0006c7f0: 2c34 3a37 2c34 3a37 5d3d 6669 7865 645f  ,4:7,4:7]=fixed_
-0006c800: 6f76 6572 6c61 795f 7261 6e67 655b 315d  overlay_range[1]
-0006c810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006c820: 2061 6464 656d 435b 2061 6464 656d 4320   addemC[ addemC 
-0006c830: 3c3d 2066 6978 6564 5f6f 7665 726c 6179  <= fixed_overlay
-0006c840: 5f72 616e 6765 5b30 5d20 5d20 3d20 3020  _range[0] ] = 0 
-0006c850: 2320 6669 7865 645f 6f76 6572 6c61 795f  # fixed_overlay_
-0006c860: 7261 6e67 655b 305d 0a20 2020 2020 2020  range[0].       
-0006c870: 2020 2020 2020 2020 2061 6464 656d 435b           addemC[
-0006c880: 2061 6464 656d 4320 3e3d 2066 6978 6564   addemC >= fixed
-0006c890: 5f6f 7665 726c 6179 5f72 616e 6765 5b31  _overlay_range[1
-0006c8a0: 5d20 5d20 3d20 6669 7865 645f 6f76 6572  ] ] = fixed_over
-0006c8b0: 6c61 795f 7261 6e67 655b 315d 0a20 2020  lay_range[1].   
-0006c8c0: 2020 2020 2020 2020 2061 6e74 732e 706c           ants.pl
-0006c8d0: 6f74 2865 6467 6569 6d67 432c 2061 6464  ot(edgeimgC, add
-0006c8e0: 656d 432c 2061 7869 733d 6178 782c 206e  emC, axis=axx, n
-0006c8f0: 736c 6963 6573 3d6e 736c 6963 6573 2c20  slices=nslices, 
-0006c900: 6e63 6f6c 3d6e 636f 6c2c 2020 2020 2020  ncol=ncol,      
-0006c910: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-0006c920: 2020 6f76 6572 6c61 795f 636d 6170 3d6f    overlay_cmap=o
-0006c930: 7665 726c 6179 5f63 6d61 702c 2072 6573  verlay_cmap, res
-0006c940: 616d 706c 653d 4661 6c73 652c 206f 7665  ample=False, ove
-0006c950: 726c 6179 5f61 6c70 6861 3d31 2e30 2c0a  rlay_alpha=1.0,.
-0006c960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c970: 6669 6c65 6e61 6d65 3d66 6967 666e 2c20  filename=figfn, 
-0006c980: 6362 6172 3d61 7878 3d3d 6178 6573 5b30  cbar=axx==axes[0
-0006c990: 5d2c 2063 726f 703d 5472 7565 2c20 626c  ], crop=True, bl
-0006c9a0: 6163 6b5f 6267 3d62 6c61 636b 5f62 6720  ack_bg=black_bg 
-0006c9b0: 290a 2020 2020 2020 2020 6966 2076 6572  ).        if ver
-0006c9c0: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-0006c9d0: 2020 7072 696e 7428 6622 7b63 6f6c 3276    print(f"{col2v
-0006c9e0: 697a 7d20 646f 6e65 2229 0a20 2020 2069  iz} done").    i
-0006c9f0: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-0006ca00: 2020 2070 7269 6e74 2822 444f 4e45 2062     print("DONE b
-0006ca10: 7261 696e 206d 6170 2066 6967 7572 6573  rain map figures
-0006ca20: 2229 0a20 2020 2072 6574 7572 6e20 6164  ").    return ad
-0006ca30: 6465 6d0a 0a64 6566 2066 696c 7465 725f  dem..def filter_
-0006ca40: 6466 2869 6e64 662c 206d 7970 7265 6669  df(indf, myprefi
-0006ca50: 7829 3a0a 2020 2020 2222 220a 2020 2020  x):.    """.    
-0006ca60: 5072 6f63 6573 7320 616e 6420 6669 6c74  Process and filt
-0006ca70: 6572 2061 2070 616e 6461 7320 4461 7461  er a pandas Data
-0006ca80: 4672 616d 652c 2072 656d 6f76 696e 6720  Frame, removing 
-0006ca90: 6365 7274 6169 6e20 636f 6c75 6d6e 732c  certain columns,
-0006caa0: 200a 2020 2020 6669 6c74 6572 696e 6720   .    filtering 
-0006cab0: 6261 7365 6420 6f6e 2064 6174 6120 7479  based on data ty
-0006cac0: 7065 732c 2063 6f6d 7075 7469 6e67 2074  pes, computing t
-0006cad0: 6865 206d 6561 6e20 6f66 206e 756d 6572  he mean of numer
-0006cae0: 6963 2063 6f6c 756d 6e73 2c20 0a20 2020  ic columns, .   
-0006caf0: 2061 6e64 2061 6464 696e 6720 6120 7072   and adding a pr
-0006cb00: 6566 6978 2074 6f20 636f 6c75 6d6e 206e  efix to column n
-0006cb10: 616d 6573 2e0a 0a20 2020 2050 6172 616d  ames...    Param
-0006cb20: 6574 6572 733a 0a20 2020 2069 6e64 6620  eters:.    indf 
-0006cb30: 2870 616e 6461 732e 4461 7461 4672 616d  (pandas.DataFram
-0006cb40: 6529 3a20 5468 6520 696e 7075 7420 4461  e): The input Da
-0006cb50: 7461 4672 616d 6520 746f 2062 6520 7072  taFrame to be pr
-0006cb60: 6f63 6573 7365 642e 0a20 2020 206d 7970  ocessed..    myp
-0006cb70: 7265 6669 7820 2873 7472 293a 2041 2073  refix (str): A s
-0006cb80: 7472 696e 6720 7072 6566 6978 2074 6f20  tring prefix to 
-0006cb90: 6265 2061 6464 6564 2074 6f20 7468 6520  be added to the 
-0006cba0: 636f 6c75 6d6e 206e 616d 6573 200a 2020  column names .  
-0006cbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cbc0: 2020 6f66 2074 6865 2070 726f 6365 7373    of the process
-0006cbd0: 6564 2044 6174 6146 7261 6d65 2e0a 0a20  ed DataFrame... 
-0006cbe0: 2020 2053 7465 7073 3a0a 2020 2020 312e     Steps:.    1.
-0006cbf0: 2052 656d 6f76 6573 2063 6f6c 756d 6e73   Removes columns
-0006cc00: 2077 6974 6820 6e61 6d65 7320 636f 6e74   with names cont
-0006cc10: 6169 6e69 6e67 2027 556e 6e61 6d65 6427  aining 'Unnamed'
-0006cc20: 2e0a 2020 2020 322e 2049 6620 7468 6520  ..    2. If the 
-0006cc30: 4461 7461 4672 616d 6520 6861 7320 6e6f  DataFrame has no
-0006cc40: 2072 6f77 732c 2069 7420 7265 7475 726e   rows, it return
-0006cc50: 7320 7468 6520 656d 7074 7920 4461 7461  s the empty Data
-0006cc60: 4672 616d 652e 0a20 2020 2033 2e20 4669  Frame..    3. Fi
-0006cc70: 6c74 6572 7320 6f75 7420 636f 6c75 6d6e  lters out column
-0006cc80: 7320 6261 7365 6420 6f6e 2074 6865 2074  s based on the t
-0006cc90: 7970 6520 6f66 2074 6865 2066 6972 7374  ype of the first
-0006cca0: 2065 6c65 6d65 6e74 2c20 0a20 2020 2020   element, .     
-0006ccb0: 2020 6b65 6570 696e 6720 7468 6f73 6520    keeping those 
-0006ccc0: 7468 6174 2061 7265 206f 6620 7479 7065  that are of type
-0006ccd0: 2060 6f62 6a65 6374 602c 2060 696e 7460   `object`, `int`
-0006cce0: 2c20 6f72 2060 666c 6f61 7460 2e0a 2020  , or `float`..  
-0006ccf0: 2020 342e 2052 656d 6f76 6573 2063 6f6c    4. Removes col
-0006cd00: 756d 6e73 2074 6861 7420 6172 6520 6f66  umns that are of
-0006cd10: 2060 6f62 6a65 6374 6020 6474 7970 652e   `object` dtype.
-0006cd20: 0a20 2020 2035 2e20 4361 6c63 756c 6174  .    5. Calculat
-0006cd30: 6573 2074 6865 206d 6561 6e20 6f66 2074  es the mean of t
-0006cd40: 6865 2072 656d 6169 6e69 6e67 2063 6f6c  he remaining col
-0006cd50: 756d 6e73 2c20 736b 6970 7069 6e67 204e  umns, skipping N
-0006cd60: 614e 2076 616c 7565 732e 0a20 2020 2036  aN values..    6
-0006cd70: 2e20 4164 6473 2074 6865 2073 7065 6369  . Adds the speci
-0006cd80: 6669 6564 2060 6d79 7072 6566 6978 6020  fied `myprefix` 
-0006cd90: 746f 2074 6865 2063 6f6c 756d 6e20 6e61  to the column na
-0006cda0: 6d65 732e 0a0a 2020 2020 5265 7475 726e  mes...    Return
-0006cdb0: 733a 0a20 2020 2070 616e 6461 732e 4461  s:.    pandas.Da
-0006cdc0: 7461 4672 616d 653a 2041 2074 7261 6e73  taFrame: A trans
-0006cdd0: 666f 726d 6564 2044 6174 6146 7261 6d65  formed DataFrame
-0006cde0: 2077 6974 6820 6120 7369 6e67 6c65 2072   with a single r
-0006cdf0: 6f77 2063 6f6e 7461 696e 696e 6720 0a20  ow containing . 
-0006ce00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ce10: 2020 2020 2074 6865 206d 6561 6e20 7661       the mean va
-0006ce20: 6c75 6573 206f 6620 7468 6520 6669 6c74  lues of the filt
-0006ce30: 6572 6564 2063 6f6c 756d 6e73 2c20 616e  ered columns, an
-0006ce40: 6420 7769 7468 200a 2020 2020 2020 2020  d with .        
-0006ce50: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0006ce60: 6c75 6d6e 206e 616d 6573 2070 7265 6669  lumn names prefi
-0006ce70: 7865 6420 6173 2073 7065 6369 6669 6564  xed as specified
-0006ce80: 2e0a 2020 2020 2222 220a 2020 2020 696e  ..    """.    in
-0006ce90: 6466 203d 2069 6e64 662e 6c6f 635b 3a2c  df = indf.loc[:,
-0006cea0: 207e 696e 6466 2e63 6f6c 756d 6e73 2e73   ~indf.columns.s
-0006ceb0: 7472 2e63 6f6e 7461 696e 7328 2755 6e6e  tr.contains('Unn
-0006cec0: 616d 6564 2a27 2c20 6e61 3d46 616c 7365  amed*', na=False
-0006ced0: 2c20 7265 6765 783d 5472 7565 295d 0a20  , regex=True)]. 
-0006cee0: 2020 2069 6620 696e 6466 2e73 6861 7065     if indf.shape
-0006cef0: 5b30 5d20 3d3d 2030 3a0a 2020 2020 2020  [0] == 0:.      
-0006cf00: 2020 7265 7475 726e 2069 6e64 660a 2020    return indf.  
-0006cf10: 2020 6e75 6d73 203d 205b 6973 696e 7374    nums = [isinst
-0006cf20: 616e 6365 2869 6e64 665b 636f 6c5d 2e69  ance(indf[col].i
-0006cf30: 6c6f 635b 305d 2c20 286f 626a 6563 742c  loc[0], (object,
-0006cf40: 2069 6e74 2c20 666c 6f61 7429 2920 666f   int, float)) fo
-0006cf50: 7220 636f 6c20 696e 2069 6e64 662e 636f  r col in indf.co
-0006cf60: 6c75 6d6e 735d 0a20 2020 2069 6e64 6620  lumns].    indf 
-0006cf70: 3d20 696e 6466 2e6c 6f63 5b3a 2c20 6e75  = indf.loc[:, nu
-0006cf80: 6d73 5d0a 2020 2020 696e 6466 203d 2069  ms].    indf = i
-0006cf90: 6e64 662e 6c6f 635b 3a2c 2069 6e64 662e  ndf.loc[:, indf.
-0006cfa0: 6474 7970 6573 2021 3d20 276f 626a 6563  dtypes != 'objec
-0006cfb0: 7427 5d0a 2020 2020 696e 6466 203d 2070  t'].    indf = p
-0006cfc0: 642e 4461 7461 4672 616d 6528 696e 6466  d.DataFrame(indf
-0006cfd0: 2e6d 6561 6e28 6178 6973 3d30 2c20 736b  .mean(axis=0, sk
-0006cfe0: 6970 6e61 3d54 7275 6529 292e 540a 2020  ipna=True)).T.  
-0006cff0: 2020 696e 6466 203d 2069 6e64 662e 6164    indf = indf.ad
-0006d000: 645f 7072 6566 6978 286d 7970 7265 6669  d_prefix(myprefi
-0006d010: 7829 0a20 2020 2072 6574 7572 6e20 696e  x).    return in
-0006d020: 6466 0a0a 0a64 6566 2061 6767 7265 6761  df...def aggrega
-0006d030: 7465 5f61 6e74 7370 796d 6d5f 7265 7375  te_antspymm_resu
-0006d040: 6c74 7328 696e 7075 745f 6373 762c 2073  lts(input_csv, s
-0006d050: 7562 6a65 6374 5f63 6f6c 3d27 7375 626a  ubject_col='subj
-0006d060: 6563 7449 4427 2c20 6461 7465 5f63 6f6c  ectID', date_col
-0006d070: 3d27 6461 7465 272c 2069 6d61 6765 5f63  ='date', image_c
-0006d080: 6f6c 3d27 696d 6167 6549 4427 2c20 6461  ol='imageID', da
-0006d090: 7465 5f63 6f6c 756d 6e3d 2773 6573 2d31  te_column='ses-1
-0006d0a0: 272c 2062 6173 655f 7061 7468 3d22 2e2f  ', base_path="./
-0006d0b0: 5072 6f63 6573 7365 642f 414e 5473 4578  Processed/ANTsEx
-0006d0c0: 7041 7274 2f22 2c20 6869 6572 7661 7269  pArt/", hiervari
-0006d0d0: 6162 6c65 3d27 5431 7748 6965 7261 7263  able='T1wHierarc
-0006d0e0: 6869 6361 6c27 2c20 7661 6c69 645f 6d6f  hical', valid_mo
-0006d0f0: 6461 6c69 7469 6573 3d4e 6f6e 652c 2076  dalities=None, v
-0006d100: 6572 626f 7365 3d46 616c 7365 2029 3a0a  erbose=False ):.
-0006d110: 2020 2020 2222 220a 2020 2020 4167 6772      """.    Aggr
-0006d120: 6567 6174 6520 414e 5473 5079 4d4d 2072  egate ANTsPyMM r
-0006d130: 6573 756c 7473 2066 726f 6d20 7468 6520  esults from the 
-0006d140: 7370 6563 6966 6965 6420 4353 5620 6669  specified CSV fi
-0006d150: 6c65 2061 6e64 2073 6176 6520 7468 6520  le and save the 
-0006d160: 6167 6772 6567 6174 6564 2072 6573 756c  aggregated resul
-0006d170: 7473 2074 6f20 6120 6e65 7720 4353 5620  ts to a new CSV 
-0006d180: 6669 6c65 2e0a 0a20 2020 2050 6172 616d  file...    Param
-0006d190: 6574 6572 733a 0a20 2020 202d 2069 6e70  eters:.    - inp
-0006d1a0: 7574 5f63 7376 2028 7374 7229 3a20 4669  ut_csv (str): Fi
-0006d1b0: 6c65 2070 6174 6820 6f66 2074 6865 2069  le path of the i
-0006d1c0: 6e70 7574 2043 5356 2066 696c 6520 636f  nput CSV file co
-0006d1d0: 6e74 6169 6e69 6e67 2041 4e54 7350 794d  ntaining ANTsPyM
-0006d1e0: 4d20 5143 2072 6573 756c 7473 2061 7665  M QC results ave
-0006d1f0: 7261 6765 6420 616e 6420 7769 7468 206f  raged and with o
-0006d200: 7574 6c69 6572 206d 6561 7375 7265 6d65  utlier measureme
-0006d210: 6e74 732e 0a20 2020 202d 2073 7562 6a65  nts..    - subje
-0006d220: 6374 5f63 6f6c 2028 7374 7229 3a20 4e61  ct_col (str): Na
-0006d230: 6d65 206f 6620 7468 6520 636f 6c75 6d6e  me of the column
-0006d240: 2074 6f20 7374 6f72 6520 7375 626a 6563   to store subjec
-0006d250: 7420 4944 732e 0a20 2020 202d 2064 6174  t IDs..    - dat
-0006d260: 655f 636f 6c20 2873 7472 293a 204e 616d  e_col (str): Nam
-0006d270: 6520 6f66 2074 6865 2063 6f6c 756d 6e20  e of the column 
-0006d280: 746f 2073 746f 7265 2064 6174 6520 696e  to store date in
-0006d290: 666f 726d 6174 696f 6e2e 0a20 2020 202d  formation..    -
-0006d2a0: 2069 6d61 6765 5f63 6f6c 2028 7374 7229   image_col (str)
-0006d2b0: 3a20 4e61 6d65 206f 6620 7468 6520 636f  : Name of the co
-0006d2c0: 6c75 6d6e 2074 6f20 7374 6f72 6520 696d  lumn to store im
-0006d2d0: 6167 6520 4944 732e 0a20 2020 202d 2064  age IDs..    - d
-0006d2e0: 6174 655f 636f 6c75 6d6e 2028 7374 7229  ate_column (str)
-0006d2f0: 3a20 4e61 6d65 206f 6620 7468 6520 636f  : Name of the co
-0006d300: 6c75 6d6e 2072 6570 7265 7365 6e74 696e  lumn representin
-0006d310: 6720 7468 6520 6461 7465 2069 6e66 6f72  g the date infor
-0006d320: 6d61 7469 6f6e 2e0a 2020 2020 2d20 6261  mation..    - ba
-0006d330: 7365 5f70 6174 6820 2873 7472 293a 2042  se_path (str): B
-0006d340: 6173 6520 7061 7468 2066 6f72 2073 6561  ase path for sea
-0006d350: 7263 6820 7061 7468 732e 2044 6566 6175  rch paths. Defau
-0006d360: 6c74 7320 746f 2022 2e2f 5072 6f63 6573  lts to "./Proces
-0006d370: 7365 642f 414e 5473 4578 7041 7274 2f22  sed/ANTsExpArt/"
-0006d380: 2e0a 2020 2020 2d20 6869 6572 7661 7269  ..    - hiervari
-0006d390: 6162 6c65 2028 7374 7229 203a 2074 6865  able (str) : the
-0006d3a0: 2073 7472 696e 6720 7661 7269 6162 6c65   string variable
-0006d3b0: 2064 656e 6f74 696e 6720 7468 6520 4869   denoting the Hi
-0006d3c0: 6572 6172 6368 6963 616c 206f 7574 7075  erarchical outpu
-0006d3d0: 740a 2020 2020 2d20 7661 6c69 645f 6d6f  t.    - valid_mo
-0006d3e0: 6461 6c69 7469 6573 2028 7374 7220 6172  dalities (str ar
-0006d3f0: 7261 7929 203a 2069 6465 6e74 6966 6965  ray) : identifie
-0006d400: 7320 666f 7220 6561 6368 206d 6f64 616c  s for each modal
-0006d410: 6974 793b 2069 6620 4e6f 6e65 2077 696c  ity; if None wil
-0006d420: 6c20 6265 2072 6570 6c61 6365 6420 6279  l be replaced by
-0006d430: 2067 6574 5f76 616c 6964 5f6d 6f64 616c   get_valid_modal
-0006d440: 6974 6965 7328 6c6f 6e67 3d54 7275 6529  ities(long=True)
-0006d450: 0a20 2020 202d 2076 6572 626f 7365 203a  .    - verbose :
-0006d460: 2062 6f6f 6c65 616e 0a0a 2020 2020 4e6f   boolean..    No
-0006d470: 7465 3a0a 2020 2020 5468 6973 2066 756e  te:.    This fun
-0006d480: 6374 696f 6e20 6973 2074 6573 7465 6420  ction is tested 
-0006d490: 756e 6465 7220 6c69 6d69 7465 6420 6369  under limited ci
-0006d4a0: 7263 756d 7374 616e 6365 732e 2055 7365  rcumstances. Use
-0006d4b0: 2077 6974 6820 6361 7574 696f 6e2e 0a0a   with caution...
-0006d4c0: 2020 2020 4578 616d 706c 6520 7573 6167      Example usag
-0006d4d0: 653a 0a20 2020 2061 6767 5f64 6620 3d20  e:.    agg_df = 
-0006d4e0: 6167 6772 6567 6174 655f 616e 7473 7079  aggregate_antspy
-0006d4f0: 6d6d 5f72 6573 756c 7473 2822 7163 6466  mm_results("qcdf
-0006d500: 616f 6c2e 6373 7622 2c20 7375 626a 6563  aol.csv", subjec
-0006d510: 745f 636f 6c3d 2773 7562 6a65 6374 4944  t_col='subjectID
-0006d520: 272c 2064 6174 655f 636f 6c3d 2764 6174  ', date_col='dat
-0006d530: 6527 2c20 696d 6167 655f 636f 6c3d 2769  e', image_col='i
-0006d540: 6d61 6765 4944 272c 2064 6174 655f 636f  mageID', date_co
-0006d550: 6c75 6d6e 3d27 7365 732d 3127 2c20 6261  lumn='ses-1', ba
-0006d560: 7365 5f70 6174 683d 222e 2f59 6f75 722f  se_path="./Your/
-0006d570: 4375 7374 6f6d 2f50 6174 682f 2229 0a0a  Custom/Path/")..
-0006d580: 2020 2020 4175 7468 6f72 3a0a 2020 2020      Author:.    
-0006d590: 4176 616e 7473 2061 6e64 2043 6861 7447  Avants and ChatG
-0006d5a0: 5054 0a20 2020 2022 2222 0a20 2020 2069  PT.    """.    i
-0006d5b0: 6d70 6f72 7420 7061 6e64 6173 2061 7320  mport pandas as 
-0006d5c0: 7064 0a20 2020 2069 6d70 6f72 7420 6e75  pd.    import nu
-0006d5d0: 6d70 7920 6173 206e 700a 2020 2020 6672  mpy as np.    fr
-0006d5e0: 6f6d 2067 6c6f 6220 696d 706f 7274 2067  om glob import g
-0006d5f0: 6c6f 620a 0a20 2020 2064 6566 206d 7972  lob..    def myr
-0006d600: 6561 645f 6373 7628 782c 2063 6e6d 7329  ead_csv(x, cnms)
-0006d610: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-0006d620: 2020 2020 2020 5265 6164 7320 6120 4353        Reads a CS
-0006d630: 5620 6669 6c65 2061 6e64 2072 6574 7572  V file and retur
-0006d640: 6e73 2061 2044 6174 6146 7261 6d65 2065  ns a DataFrame e
-0006d650: 7863 6c75 6469 6e67 2073 7065 6369 6669  xcluding specifi
-0006d660: 6564 2063 6f6c 756d 6e73 2e0a 0a20 2020  ed columns...   
-0006d670: 2020 2020 2050 6172 616d 6574 6572 733a       Parameters:
-0006d680: 0a20 2020 2020 2020 202d 2078 2028 7374  .        - x (st
-0006d690: 7229 3a20 4669 6c65 2070 6174 6820 6f66  r): File path of
-0006d6a0: 2074 6865 2069 6e70 7574 2043 5356 2066   the input CSV f
-0006d6b0: 696c 6520 6465 7363 7269 6269 6e67 2074  ile describing t
-0006d6c0: 6865 2062 6c69 6e64 2051 4320 6f75 7470  he blind QC outp
-0006d6d0: 7574 0a20 2020 2020 2020 202d 2063 6e6d  ut.        - cnm
-0006d6e0: 7320 286c 6973 7429 3a20 4c69 7374 206f  s (list): List o
-0006d6f0: 6620 636f 6c75 6d6e 206e 616d 6573 2074  f column names t
-0006d700: 6f20 6578 636c 7564 6520 6672 6f6d 2074  o exclude from t
-0006d710: 6865 2044 6174 6146 7261 6d65 2e0a 0a20  he DataFrame... 
-0006d720: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
-0006d730: 2020 2020 2020 2020 7064 2e44 6174 6146          pd.DataF
-0006d740: 7261 6d65 3a20 4461 7461 4672 616d 6520  rame: DataFrame 
-0006d750: 7769 7468 2073 7065 6369 6669 6564 2063  with specified c
-0006d760: 6f6c 756d 6e73 2065 7863 6c75 6465 642e  olumns excluded.
-0006d770: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0006d780: 2020 2020 2064 6620 3d20 7064 2e72 6561       df = pd.rea
-0006d790: 645f 6373 7628 7829 0a20 2020 2020 2020  d_csv(x).       
-0006d7a0: 2072 6574 7572 6e20 6466 2e6c 6f63 5b3a   return df.loc[:
-0006d7b0: 2c20 7e64 662e 636f 6c75 6d6e 732e 6973  , ~df.columns.is
-0006d7c0: 696e 2863 6e6d 7329 5d0a 0a20 2020 2069  in(cnms)]..    i
-0006d7d0: 6d70 6f72 7420 7761 726e 696e 6773 0a20  mport warnings. 
-0006d7e0: 2020 2023 2057 6172 6e69 6e67 206d 6573     # Warning mes
-0006d7f0: 7361 6765 2066 6f72 2075 6e74 6573 7465  sage for unteste
-0006d800: 6420 6675 6e63 7469 6f6e 0a20 2020 2077  d function.    w
-0006d810: 6172 6e69 6e67 732e 7761 726e 2822 5761  arnings.warn("Wa
-0006d820: 726e 696e 673a 2054 6869 7320 6675 6e63  rning: This func
-0006d830: 7469 6f6e 2069 7320 6e6f 7420 7765 6c6c  tion is not well
-0006d840: 2074 6573 7465 642e 2055 7365 2077 6974   tested. Use wit
-0006d850: 6820 6361 7574 696f 6e2e 2229 0a0a 2020  h caution.")..  
-0006d860: 2020 6966 2076 616c 6964 5f6d 6f64 616c    if valid_modal
-0006d870: 6974 6965 7320 6973 204e 6f6e 653a 0a20  ities is None:. 
-0006d880: 2020 2020 2020 2076 616c 6964 5f6d 6f64         valid_mod
-0006d890: 616c 6974 6965 7320 3d20 6765 745f 7661  alities = get_va
-0006d8a0: 6c69 645f 6d6f 6461 6c69 7469 6573 2827  lid_modalities('
-0006d8b0: 6c6f 6e67 2729 0a0a 2020 2020 2320 5265  long')..    # Re
-0006d8c0: 6164 2074 6865 2069 6e70 7574 2043 5356  ad the input CSV
-0006d8d0: 2066 696c 650a 2020 2020 6466 203d 2070   file.    df = p
-0006d8e0: 642e 7265 6164 5f63 7376 2869 6e70 7574  d.read_csv(input
-0006d8f0: 5f63 7376 290a 0a20 2020 2023 2046 696c  _csv)..    # Fil
-0006d900: 7465 7220 726f 7773 2077 6865 7265 206d  ter rows where m
-0006d910: 6f64 616c 6974 7920 6973 2027 5431 7727  odality is 'T1w'
-0006d920: 0a20 2020 2064 6620 3d20 6466 5b64 665b  .    df = df[df[
-0006d930: 276d 6f64 616c 6974 7927 5d20 3d3d 2027  'modality'] == '
-0006d940: 5431 7727 5d0a 2020 2020 6261 646e 616d  T1w'].    badnam
-0006d950: 6573 203d 2067 6574 5f6e 616d 6573 5f66  es = get_names_f
-0006d960: 726f 6d5f 6461 7461 5f66 7261 6d65 2820  rom_data_frame( 
-0006d970: 5b27 556e 6e61 6d65 6427 5d2c 2064 6620  ['Unnamed'], df 
-0006d980: 290a 2020 2020 6466 3d64 662e 6472 6f70  ).    df=df.drop
-0006d990: 2862 6164 6e61 6d65 732c 2061 7869 733d  (badnames, axis=
-0006d9a0: 3129 0a0a 2020 2020 2320 4164 6420 6e65  1)..    # Add ne
-0006d9b0: 7720 636f 6c75 6d6e 7320 666f 7220 7375  w columns for su
-0006d9c0: 626a 6563 7420 4944 2c20 6461 7465 2c20  bject ID, date, 
-0006d9d0: 616e 6420 696d 6167 6520 4944 0a20 2020  and image ID.   
-0006d9e0: 2064 665b 7375 626a 6563 745f 636f 6c5d   df[subject_col]
-0006d9f0: 203d 206e 702e 6e61 6e0a 2020 2020 6466   = np.nan.    df
-0006da00: 5b64 6174 655f 636f 6c5d 203d 2064 6174  [date_col] = dat
-0006da10: 655f 636f 6c75 6d6e 0a20 2020 2064 665b  e_column.    df[
-0006da20: 696d 6167 655f 636f 6c5d 203d 206e 702e  image_col] = np.
-0006da30: 6e61 6e0a 2020 2020 6466 203d 2064 662e  nan.    df = df.
-0006da40: 6173 7479 7065 287b 7375 626a 6563 745f  astype({subject_
-0006da50: 636f 6c3a 2073 7472 2c20 6461 7465 5f63  col: str, date_c
-0006da60: 6f6c 3a20 7374 722c 2069 6d61 6765 5f63  ol: str, image_c
-0006da70: 6f6c 3a20 7374 7220 7d29 0a0a 2320 2020  ol: str })..#   
-0006da80: 2069 6620 7665 7262 6f73 653a 0a23 2020   if verbose:.#  
-0006da90: 2020 2020 2020 7072 696e 7428 2064 662e        print( df.
-0006daa0: 7368 6170 6520 290a 2320 2020 2020 2020  shape ).#       
-0006dab0: 2070 7269 6e74 2820 6466 2e64 7479 7065   print( df.dtype
-0006dac0: 7320 290a 0a20 2020 2023 2070 7265 6669  s )..    # prefi
-0006dad0: 6c74 6572 2064 6620 666f 7220 6461 7461  lter df for data
-0006dae0: 2074 6861 7420 6578 6973 7473 0a20 2020   that exists.   
-0006daf0: 206b 6565 7020 3d20 6e70 2e74 696c 6528   keep = np.tile(
-0006db00: 2046 616c 7365 2c20 6466 2e73 6861 7065   False, df.shape
-0006db10: 5b30 5d20 290a 2020 2020 666f 7220 7820  [0] ).    for x 
-0006db20: 696e 2072 616e 6765 2864 662e 7368 6170  in range(df.shap
-0006db30: 655b 305d 293a 0a20 2020 2020 2020 2074  e[0]):.        t
-0006db40: 656d 7020 3d20 6466 5b27 6669 6c65 6e61  emp = df['filena
-0006db50: 6d65 275d 2e69 6c6f 635b 785d 2e73 706c  me'].iloc[x].spl
-0006db60: 6974 2822 5f22 290a 2020 2020 2020 2020  it("_").        
-0006db70: 2320 4765 6e65 7261 6c69 7a65 6420 7365  # Generalized se
-0006db80: 6172 6368 2070 6174 6873 0a20 2020 2020  arch paths.     
-0006db90: 2020 2070 6174 685f 7465 6d70 6c61 7465     path_template
-0006dba0: 203d 2066 227b 6261 7365 5f70 6174 687d   = f"{base_path}
-0006dbb0: 7b74 656d 705b 305d 7d2f 7b64 6174 655f  {temp[0]}/{date_
-0006dbc0: 636f 6c75 6d6e 7d2f 2a2f 2a2f 2a22 0a20  column}/*/*/*". 
-0006dbd0: 2020 2020 2020 2068 6965 7266 6e20 3d20         hierfn = 
-0006dbe0: 736f 7274 6564 2867 6c6f 6228 2070 6174  sorted(glob( pat
-0006dbf0: 685f 7465 6d70 6c61 7465 202b 2022 2d22  h_template + "-"
-0006dc00: 202b 2068 6965 7276 6172 6961 626c 6520   + hiervariable 
-0006dc10: 2b20 222d 2a77 6964 652e 6373 7622 2029  + "-*wide.csv" )
-0006dc20: 2029 0a20 2020 2020 2020 2069 6620 6c65   ).        if le
-0006dc30: 6e28 2068 6965 7266 6e20 2920 3e20 303a  n( hierfn ) > 0:
-0006dc40: 0a20 2020 2020 2020 2020 2020 206b 6565  .            kee
-0006dc50: 705b 785d 3d54 7275 650a 0a20 2020 200a  p[x]=True..    .
-0006dc60: 2020 2020 6466 3d64 665b 6b65 6570 5d0a      df=df[keep].
-0006dc70: 2020 2020 0a20 2020 2069 6620 7665 7262      .    if verb
-0006dc80: 6f73 653a 0a20 2020 2020 2020 2070 7269  ose:.        pri
-0006dc90: 6e74 2820 226f 7269 6769 6e61 6c20 696e  nt( "original in
-0006dca0: 7075 7420 6861 6420 7368 6170 6520 2220  put had shape " 
-0006dcb0: 2b20 7374 7228 2064 662e 7368 6170 655b  + str( df.shape[
-0006dcc0: 305d 2029 202b 2022 2028 5431 206f 6e6c  0] ) + " (T1 onl
-0006dcd0: 7929 2061 6e64 2077 6520 6669 6e64 2022  y) and we find "
-0006dce0: 202b 2073 7472 2820 286b 6565 7029 2e73   + str( (keep).s
-0006dcf0: 756d 2829 2029 202b 2022 2077 6974 6820  um() ) + " with 
-0006dd00: 6869 6572 6172 6368 6963 616c 206f 7574  hierarchical out
-0006dd10: 7075 7420 6465 6669 6e65 6420 6279 2076  put defined by v
-0006dd20: 6172 6961 626c 653a 2022 202b 2068 6965  ariable: " + hie
-0006dd30: 7276 6172 6961 626c 6520 290a 2020 2020  rvariable ).    
-0006dd40: 2020 2020 7072 696e 7428 2064 662e 7368      print( df.sh
-0006dd50: 6170 6520 290a 0a20 2020 206d 7963 7420  ape )..    myct 
-0006dd60: 3d20 300a 2020 2020 666f 7220 7820 696e  = 0.    for x in
-0006dd70: 2072 616e 6765 2820 6466 2e73 6861 7065   range( df.shape
-0006dd80: 5b30 5d29 3a0a 2020 2020 2020 2020 6966  [0]):.        if
-0006dd90: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-0006dda0: 2020 2020 2020 7072 696e 7428 6622 7b78        print(f"{x
-0006ddb0: 7d2e 2e2e 2229 0a20 2020 2020 2020 206c  }...").        l
-0006ddc0: 6f63 696e 6420 3d20 6466 2e69 6e64 6578  ocind = df.index
-0006ddd0: 5b78 5d0a 2020 2020 2020 2020 7465 6d70  [x].        temp
-0006dde0: 203d 2064 665b 2766 696c 656e 616d 6527   = df['filename'
-0006ddf0: 5d2e 696c 6f63 5b78 5d2e 7370 6c69 7428  ].iloc[x].split(
-0006de00: 225f 2229 0a20 2020 2020 2020 2069 6620  "_").        if 
-0006de10: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-0006de20: 2020 2020 2070 7269 6e74 2820 7465 6d70       print( temp
-0006de30: 2029 0a20 2020 2020 2020 2064 665b 7375   ).        df[su
-0006de40: 626a 6563 745f 636f 6c5d 2e69 6c6f 635b  bject_col].iloc[
-0006de50: 785d 3d74 656d 705b 305d 0a20 2020 2020  x]=temp[0].     
-0006de60: 2020 2064 665b 6461 7465 5f63 6f6c 5d2e     df[date_col].
-0006de70: 696c 6f63 5b78 5d3d 6461 7465 5f63 6f6c  iloc[x]=date_col
-0006de80: 756d 6e0a 2020 2020 2020 2020 6466 5b69  umn.        df[i
-0006de90: 6d61 6765 5f63 6f6c 5d2e 696c 6f63 5b78  mage_col].iloc[x
-0006dea0: 5d3d 7465 6d70 5b31 5d0a 0a20 2020 2020  ]=temp[1]..     
-0006deb0: 2020 2023 2047 656e 6572 616c 697a 6564     # Generalized
-0006dec0: 2073 6561 7263 6820 7061 7468 730a 2020   search paths.  
-0006ded0: 2020 2020 2020 7061 7468 5f74 656d 706c        path_templ
-0006dee0: 6174 6520 3d20 6622 7b62 6173 655f 7061  ate = f"{base_pa
-0006def0: 7468 7d7b 7465 6d70 5b30 5d7d 2f7b 6461  th}{temp[0]}/{da
-0006df00: 7465 5f63 6f6c 756d 6e7d 2f2a 2f2a 2f2a  te_column}/*/*/*
-0006df10: 220a 2020 2020 2020 2020 6966 2076 6572  ".        if ver
-0006df20: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-0006df30: 2020 7072 696e 7428 7061 7468 5f74 656d    print(path_tem
-0006df40: 706c 6174 6529 0a20 2020 2020 2020 2068  plate).        h
-0006df50: 6965 7266 6e20 3d20 736f 7274 6564 2867  ierfn = sorted(g
-0006df60: 6c6f 6228 2070 6174 685f 7465 6d70 6c61  lob( path_templa
-0006df70: 7465 202b 2022 2d22 202b 2068 6965 7276  te + "-" + hierv
-0006df80: 6172 6961 626c 6520 2b20 222d 2a77 6964  ariable + "-*wid
-0006df90: 652e 6373 7622 2029 2029 0a20 2020 2020  e.csv" ) ).     
-0006dfa0: 2020 2069 6620 6c65 6e28 2068 6965 7266     if len( hierf
-0006dfb0: 6e20 2920 3e20 303a 0a20 2020 2020 2020  n ) > 0:.       
-0006dfc0: 2020 2020 2068 6466 3d74 3164 663d 6474       hdf=t1df=dt
-0006dfd0: 6466 3d72 7364 663d 7065 7266 6466 3d6e  df=rsdf=perfdf=n
-0006dfe0: 6d64 663d 666c 6169 7264 663d 4e6f 6e65  mdf=flairdf=None
-0006dff0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0006e000: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-0006e010: 2020 2020 2020 2020 2070 7269 6e74 2868           print(h
-0006e020: 6965 7266 6e29 0a20 2020 2020 2020 2020  ierfn).         
-0006e030: 2020 2068 6466 203d 2070 642e 7265 6164     hdf = pd.read
-0006e040: 5f63 7376 2868 6965 7266 6e5b 305d 290a  _csv(hierfn[0]).
-0006e050: 2020 2020 2020 2020 2020 2020 6261 646e              badn
-0006e060: 616d 6573 203d 2067 6574 5f6e 616d 6573  ames = get_names
-0006e070: 5f66 726f 6d5f 6461 7461 5f66 7261 6d65  _from_data_frame
-0006e080: 2820 5b27 556e 6e61 6d65 6427 5d2c 2068  ( ['Unnamed'], h
-0006e090: 6466 2029 0a20 2020 2020 2020 2020 2020  df ).           
-0006e0a0: 2068 6466 3d68 6466 2e64 726f 7028 6261   hdf=hdf.drop(ba
-0006e0b0: 646e 616d 6573 2c20 6178 6973 3d31 290a  dnames, axis=1).
-0006e0c0: 2020 2020 2020 2020 2020 2020 6e75 6d73              nums
-0006e0d0: 203d 205b 6973 696e 7374 616e 6365 2868   = [isinstance(h
-0006e0e0: 6466 5b63 6f6c 5d2e 696c 6f63 5b30 5d2c  df[col].iloc[0],
-0006e0f0: 2028 696e 742c 2066 6c6f 6174 2929 2066   (int, float)) f
-0006e100: 6f72 2063 6f6c 2069 6e20 6864 662e 636f  or col in hdf.co
-0006e110: 6c75 6d6e 735d 0a20 2020 2020 2020 2020  lumns].         
-0006e120: 2020 2063 6f72 656e 616d 6573 203d 206c     corenames = l
-0006e130: 6973 7428 6e70 2e61 7272 6179 2868 6466  ist(np.array(hdf
-0006e140: 2e63 6f6c 756d 6e73 295b 6e75 6d73 5d29  .columns)[nums])
-0006e150: 0a20 2020 2020 2020 2020 2020 2068 6466  .            hdf
-0006e160: 2e6c 6f63 5b3a 2c20 6e75 6d73 5d20 3d20  .loc[:, nums] = 
-0006e170: 6864 662e 6c6f 635b 3a2c 206e 756d 735d  hdf.loc[:, nums]
-0006e180: 2e61 6464 5f70 7265 6669 7828 2254 3148  .add_prefix("T1H
-0006e190: 6965 725f 2229 0a20 2020 2020 2020 2020  ier_").         
-0006e1a0: 2020 206d 7963 7420 3d20 6d79 6374 202b     myct = myct +
-0006e1b0: 2031 0a20 2020 2020 2020 2020 2020 2064   1.            d
-0006e1c0: 666c 6973 7420 3d20 5b68 6466 5d0a 0a20  flist = [hdf].. 
-0006e1d0: 2020 2020 2020 2020 2020 2066 6f72 206d             for m
-0006e1e0: 796d 6f64 2069 6e20 7661 6c69 645f 6d6f  ymod in valid_mo
-0006e1f0: 6461 6c69 7469 6573 3a0a 2020 2020 2020  dalities:.      
-0006e200: 2020 2020 2020 2020 2020 7431 7766 6e20            t1wfn 
-0006e210: 3d20 736f 7274 6564 2867 6c6f 6228 2070  = sorted(glob( p
-0006e220: 6174 685f 7465 6d70 6c61 7465 2b20 222d  ath_template+ "-
-0006e230: 2220 2b20 6d79 6d6f 6420 2b20 222d 2a77  " + mymod + "-*w
-0006e240: 6964 652e 6373 7622 2029 2029 0a20 2020  ide.csv" ) ).   
-0006e250: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0006e260: 6c65 6e28 2074 3177 666e 2029 203e 2030  len( t1wfn ) > 0
-0006e270: 203a 0a20 2020 2020 2020 2020 2020 2020   :.             
-0006e280: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
-0006e290: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0006e2a0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0006e2b0: 2874 3177 666e 290a 2020 2020 2020 2020  (t1wfn).        
-0006e2c0: 2020 2020 2020 2020 2020 2020 7431 6466              t1df
-0006e2d0: 203d 206d 7972 6561 645f 6373 7628 7431   = myread_csv(t1
-0006e2e0: 7766 6e5b 305d 2c20 636f 7265 6e61 6d65  wfn[0], corename
-0006e2f0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-0006e300: 2020 2020 2020 2074 3164 6620 3d20 6669         t1df = fi
-0006e310: 6c74 6572 5f64 6628 2074 3164 662c 206d  lter_df( t1df, m
-0006e320: 796d 6f64 2b27 5f27 290a 2020 2020 2020  ymod+'_').      
-0006e330: 2020 2020 2020 2020 2020 2020 2020 6466                df
-0006e340: 6c69 7374 203d 2064 666c 6973 7420 2b20  list = dflist + 
-0006e350: 5b74 3164 665d 0a20 2020 2020 2020 2020  [t1df].         
-0006e360: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0006e370: 2020 2020 6864 6620 3d20 7064 2e63 6f6e      hdf = pd.con
-0006e380: 6361 7428 2064 666c 6973 742c 2061 7869  cat( dflist, axi
-0006e390: 733d 312c 2069 676e 6f72 655f 696e 6465  s=1, ignore_inde
-0006e3a0: 783d 4661 6c73 6520 290a 2020 2020 2020  x=False ).      
-0006e3b0: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-0006e3c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0006e3d0: 2020 7072 696e 7428 2064 662e 6c6f 635b    print( df.loc[
-0006e3e0: 6c6f 6369 6e64 2c27 6669 6c65 6e61 6d65  locind,'filename
-0006e3f0: 275d 2029 0a20 2020 2020 2020 2020 2020  '] ).           
-0006e400: 2069 6620 6d79 6374 203d 3d20 313a 0a20   if myct == 1:. 
-0006e410: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0006e420: 7562 6466 203d 2064 662e 696c 6f63 5b5b  ubdf = df.iloc[[
-0006e430: 785d 5d0a 2020 2020 2020 2020 2020 2020  x]].            
-0006e440: 2020 2020 6864 662e 696e 6465 7820 3d20      hdf.index = 
-0006e450: 7375 6264 662e 696e 6465 782e 636f 7079  subdf.index.copy
-0006e460: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-0006e470: 2020 2064 6620 3d20 7064 2e63 6f6e 6361     df = pd.conca
-0006e480: 7428 205b 6466 2c68 6466 5d2c 2061 7869  t( [df,hdf], axi
-0006e490: 733d 312c 2069 676e 6f72 655f 696e 6465  s=1, ignore_inde
-0006e4a0: 783d 4661 6c73 6520 290a 2020 2020 2020  x=False ).      
-0006e4b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0006e4c0: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
-0006e4d0: 636f 6c73 203d 206c 6973 7428 7365 7428  cols = list(set(
-0006e4e0: 6864 662e 636f 6c75 6d6e 7329 2e69 6e74  hdf.columns).int
-0006e4f0: 6572 7365 6374 696f 6e28 6466 2e63 6f6c  ersection(df.col
-0006e500: 756d 6e73 2929 0a20 2020 2020 2020 2020  umns)).         
-0006e510: 2020 2020 2020 2064 662e 6c6f 635b 6c6f         df.loc[lo
-0006e520: 6369 6e64 2c20 636f 6d6d 636f 6c73 5d20  cind, commcols] 
-0006e530: 3d20 6864 662e 6c6f 635b 302c 2063 6f6d  = hdf.loc[0, com
-0006e540: 6d63 6f6c 735d 0a20 2020 2062 6164 6e61  mcols].    badna
-0006e550: 6d65 7320 3d20 6765 745f 6e61 6d65 735f  mes = get_names_
-0006e560: 6672 6f6d 5f64 6174 615f 6672 616d 6528  from_data_frame(
-0006e570: 205b 2755 6e6e 616d 6564 275d 2c20 6466   ['Unnamed'], df
-0006e580: 2029 0a20 2020 2064 663d 6466 2e64 726f   ).    df=df.dro
-0006e590: 7028 6261 646e 616d 6573 2c20 6178 6973  p(badnames, axis
-0006e5a0: 3d31 290a 2020 2020 7265 7475 726e 2820  =1).    return( 
-0006e5b0: 6466 2029 0a0a 6465 6620 6669 6e64 5f6d  df )..def find_m
-0006e5c0: 6f73 745f 7265 6365 6e74 5f66 696c 6528  ost_recent_file(
-0006e5d0: 6669 6c65 5f6c 6973 7429 3a0a 2020 2020  file_list):.    
-0006e5e0: 2222 220a 2020 2020 4669 6e64 7320 616e  """.    Finds an
-0006e5f0: 6420 7265 7475 726e 7320 7468 6520 6d6f  d returns the mo
-0006e600: 7374 2072 6563 656e 746c 7920 6d6f 6469  st recently modi
-0006e610: 6669 6564 2066 696c 6520 6672 6f6d 2061  fied file from a
-0006e620: 206c 6973 7420 6f66 2066 696c 6520 7061   list of file pa
-0006e630: 7468 732e 0a20 2020 200a 2020 2020 5061  ths..    .    Pa
-0006e640: 7261 6d65 7465 7273 3a0a 2020 2020 2d20  rameters:.    - 
-0006e650: 6669 6c65 5f6c 6973 743a 2041 206c 6973  file_list: A lis
-0006e660: 7420 6f66 2073 7472 696e 6773 2c20 7768  t of strings, wh
-0006e670: 6572 6520 6561 6368 2073 7472 696e 6720  ere each string 
-0006e680: 6973 2061 2070 6174 6820 746f 2061 2066  is a path to a f
-0006e690: 696c 652e 0a20 2020 200a 2020 2020 5265  ile..    .    Re
-0006e6a0: 7475 726e 733a 0a20 2020 202d 2054 6865  turns:.    - The
-0006e6b0: 2070 6174 6820 746f 2074 6865 206d 6f73   path to the mos
-0006e6c0: 7420 7265 6365 6e74 6c79 206d 6f64 6966  t recently modif
-0006e6d0: 6965 6420 6669 6c65 2069 6e20 7468 6520  ied file in the 
-0006e6e0: 6c69 7374 2c20 6f72 204e 6f6e 6520 6966  list, or None if
-0006e6f0: 2074 6865 206c 6973 7420 6973 2065 6d70   the list is emp
-0006e700: 7479 206f 7220 636f 6e74 6169 6e73 206e  ty or contains n
-0006e710: 6f20 7661 6c69 6420 6669 6c65 732e 0a20  o valid files.. 
-0006e720: 2020 2022 2222 0a20 2020 2023 2046 696c     """.    # Fil
-0006e730: 7465 7220 6f75 7420 6974 656d 7320 7468  ter out items th
-0006e740: 6174 2061 7265 206e 6f74 2066 696c 6573  at are not files
-0006e750: 206f 7220 646f 206e 6f74 2065 7869 7374   or do not exist
-0006e760: 0a20 2020 2076 616c 6964 5f66 696c 6573  .    valid_files
-0006e770: 203d 205b 6620 666f 7220 6620 696e 2066   = [f for f in f
-0006e780: 696c 655f 6c69 7374 2069 6620 6f73 2e70  ile_list if os.p
-0006e790: 6174 682e 6973 6669 6c65 2866 295d 0a20  ath.isfile(f)]. 
-0006e7a0: 2020 200a 2020 2020 2320 4368 6563 6b20     .    # Check 
-0006e7b0: 6966 2074 6865 2066 696c 7465 7265 6420  if the filtered 
-0006e7c0: 6c69 7374 2069 7320 6e6f 7420 656d 7074  list is not empt
-0006e7d0: 790a 2020 2020 6966 2076 616c 6964 5f66  y.    if valid_f
-0006e7e0: 696c 6573 3a0a 2020 2020 2020 2020 2320  iles:.        # 
-0006e7f0: 4669 6e64 2074 6865 2066 696c 6520 7769  Find the file wi
-0006e800: 7468 2074 6865 206c 6174 6573 7420 6d6f  th the latest mo
-0006e810: 6469 6669 6361 7469 6f6e 2074 696d 650a  dification time.
-0006e820: 2020 2020 2020 2020 6d6f 7374 5f72 6563          most_rec
-0006e830: 656e 745f 6669 6c65 203d 206d 6178 2876  ent_file = max(v
-0006e840: 616c 6964 5f66 696c 6573 2c20 6b65 793d  alid_files, key=
-0006e850: 6f73 2e70 6174 682e 6765 746d 7469 6d65  os.path.getmtime
-0006e860: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-0006e870: 205b 6d6f 7374 5f72 6563 656e 745f 6669   [most_recent_fi
-0006e880: 6c65 5d0a 2020 2020 656c 7365 3a0a 2020  le].    else:.  
-0006e890: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-0006e8a0: 650a 2020 2020 0a64 6566 2061 6767 7265  e.    .def aggre
-0006e8b0: 6761 7465 5f61 6e74 7370 796d 6d5f 7265  gate_antspymm_re
-0006e8c0: 7375 6c74 735f 7364 6628 0a20 2020 2073  sults_sdf(.    s
-0006e8d0: 7475 6479 5f64 662c 200a 2020 2020 7072  tudy_df, .    pr
-0006e8e0: 6f6a 6563 745f 636f 6c3d 2770 726f 6a65  oject_col='proje
-0006e8f0: 6374 4944 272c 0a20 2020 2073 7562 6a65  ctID',.    subje
-0006e900: 6374 5f63 6f6c 3d27 7375 626a 6563 7449  ct_col='subjectI
-0006e910: 4427 2c20 0a20 2020 2064 6174 655f 636f  D', .    date_co
-0006e920: 6c3d 2764 6174 6527 2c20 0a20 2020 2069  l='date', .    i
-0006e930: 6d61 6765 5f63 6f6c 3d27 696d 6167 6549  mage_col='imageI
-0006e940: 4427 2c20 0a20 2020 2062 6173 655f 7061  D', .    base_pa
-0006e950: 7468 3d22 2e2f 222c 200a 2020 2020 6869  th="./", .    hi
-0006e960: 6572 7661 7269 6162 6c65 3d27 5431 7748  ervariable='T1wH
-0006e970: 6965 7261 7263 6869 6361 6c27 2c20 0a20  ierarchical', . 
-0006e980: 2020 2073 706c 6974 7365 703d 272d 272c     splitsep='-',
-0006e990: 0a20 2020 2069 6473 6570 3d27 2d27 2c0a  .    idsep='-',.
-0006e9a0: 2020 2020 7769 6c64 5f63 6172 645f 6d6f      wild_card_mo
-0006e9b0: 6461 6c69 7479 5f69 643d 4661 6c73 652c  dality_id=False,
-0006e9c0: 0a20 2020 2073 6563 6f6e 645f 7370 6c69  .    second_spli
-0006e9d0: 743d 4661 6c73 652c 0a20 2020 2076 6572  t=False,.    ver
-0006e9e0: 626f 7365 3d46 616c 7365 2029 3a0a 2020  bose=False ):.  
-0006e9f0: 2020 2222 220a 2020 2020 4167 6772 6567    """.    Aggreg
-0006ea00: 6174 6520 414e 5473 5079 4d4d 2072 6573  ate ANTsPyMM res
-0006ea10: 756c 7473 2066 726f 6d20 7468 6520 7370  ults from the sp
-0006ea20: 6563 6966 6965 6420 7374 7564 7920 6461  ecified study da
-0006ea30: 7461 2066 7261 6d65 2061 6e64 2073 746f  ta frame and sto
-0006ea40: 7265 2074 6865 2061 6767 7265 6761 7465  re the aggregate
-0006ea50: 6420 7265 7375 6c74 7320 696e 2061 206e  d results in a n
-0006ea60: 6577 2064 6174 6120 6672 616d 652e 2020  ew data frame.  
-0006ea70: 5468 6973 2061 7373 756d 6573 2064 6174  This assumes dat
-0006ea80: 6120 6973 206f 7267 616e 697a 6564 206f  a is organized o
-0006ea90: 6e20 6469 736b 200a 2020 2020 6173 2066  n disk .    as f
-0006eaa0: 6f6c 6c6f 7773 3a20 2072 6f6f 7464 6972  ollows:  rootdir
-0006eab0: 2f70 726f 6a65 6374 4944 2f73 7562 6a65  /projectID/subje
-0006eac0: 6374 4944 2f64 6174 652f 6f75 7470 7574  ctID/date/output
-0006ead0: 6964 2f69 6d61 6765 6964 2f20 7768 6572  id/imageid/ wher
-0006eae0: 6520 0a20 2020 206f 7574 7075 7469 6420  e .    outputid 
-0006eaf0: 6973 206d 6f64 616c 6974 792d 7370 6563  is modality-spec
-0006eb00: 6966 6963 2061 6e64 2063 7265 6174 6564  ific and created
-0006eb10: 2062 7920 414e 5473 5079 4d4d 2070 726f   by ANTsPyMM pro
-0006eb20: 6365 7373 696e 672e 0a0a 2020 2020 5061  cessing...    Pa
-0006eb30: 7261 6d65 7465 7273 3a0a 2020 2020 2d20  rameters:.    - 
-0006eb40: 7374 7564 795f 6466 2028 7061 6e64 6173  study_df (pandas
-0006eb50: 2064 6629 3a20 7061 6e64 6173 2064 6174   df): pandas dat
-0006eb60: 6120 6672 616d 652c 206f 7574 7075 7420  a frame, output 
-0006eb70: 6f66 2067 656e 6572 6174 655f 6d6d 5f64  of generate_mm_d
-0006eb80: 6174 6166 7261 6d65 2e0a 2020 2020 2d20  ataframe..    - 
-0006eb90: 7072 6f6a 6563 745f 636f 6c20 2873 7472  project_col (str
-0006eba0: 293a 204e 616d 6520 6f66 2074 6865 2063  ): Name of the c
-0006ebb0: 6f6c 756d 6e20 7468 6174 2073 746f 7265  olumn that store
-0006ebc0: 7320 7468 6520 7072 6f6a 6563 7420 4944  s the project ID
-0006ebd0: 0a20 2020 202d 2073 7562 6a65 6374 5f63  .    - subject_c
-0006ebe0: 6f6c 2028 7374 7229 3a20 4e61 6d65 206f  ol (str): Name o
-0006ebf0: 6620 7468 6520 636f 6c75 6d6e 2074 6f20  f the column to 
-0006ec00: 7374 6f72 6520 7375 626a 6563 7420 4944  store subject ID
-0006ec10: 732e 0a20 2020 202d 2064 6174 655f 636f  s..    - date_co
-0006ec20: 6c20 2873 7472 293a 204e 616d 6520 6f66  l (str): Name of
-0006ec30: 2074 6865 2063 6f6c 756d 6e20 746f 2073   the column to s
-0006ec40: 746f 7265 2064 6174 6520 696e 666f 726d  tore date inform
-0006ec50: 6174 696f 6e2e 0a20 2020 202d 2069 6d61  ation..    - ima
-0006ec60: 6765 5f63 6f6c 2028 7374 7229 3a20 4e61  ge_col (str): Na
-0006ec70: 6d65 206f 6620 7468 6520 636f 6c75 6d6e  me of the column
-0006ec80: 2074 6f20 7374 6f72 6520 696d 6167 6520   to store image 
-0006ec90: 4944 732e 0a20 2020 202d 2062 6173 655f  IDs..    - base_
-0006eca0: 7061 7468 2028 7374 7229 3a20 4261 7365  path (str): Base
-0006ecb0: 2070 6174 6820 666f 7220 7365 6172 6368   path for search
-0006ecc0: 696e 6720 666f 7220 7072 6f63 6573 7369  ing for processi
-0006ecd0: 6e67 206f 7574 7075 7473 206f 6620 414e  ng outputs of AN
-0006ece0: 5473 5079 4d4d 2e0a 2020 2020 2d20 6869  TsPyMM..    - hi
-0006ecf0: 6572 7661 7269 6162 6c65 2028 7374 7229  ervariable (str)
-0006ed00: 203a 2074 6865 2073 7472 696e 6720 7661   : the string va
-0006ed10: 7269 6162 6c65 2064 656e 6f74 696e 6720  riable denoting 
-0006ed20: 7468 6520 4869 6572 6172 6368 6963 616c  the Hierarchical
-0006ed30: 206f 7574 7075 740a 2020 2020 2d20 7370   output.    - sp
-0006ed40: 6c69 7473 6570 2028 7374 7229 3a20 2074  litsep (str):  t
-0006ed50: 6865 2073 6570 6172 6174 6f72 2075 7365  he separator use
-0006ed60: 6420 746f 2073 706c 6974 2074 6865 2066  d to split the f
-0006ed70: 696c 656e 616d 650a 2020 2020 2d20 6964  ilename.    - id
-0006ed80: 7365 7020 2873 7472 293a 2074 6865 2073  sep (str): the s
-0006ed90: 6570 6172 6174 6f72 2075 7365 6420 746f  eparator used to
-0006eda0: 2070 6172 7469 7469 6f6e 2073 7562 6a65   partition subje
-0006edb0: 6374 6964 2064 6174 6520 616e 6420 696d  ctid date and im
-0006edc0: 6167 6569 6420 0a20 2020 2020 2020 2066  ageid .        f
-0006edd0: 6f72 2065 7861 6d70 6c65 2c20 6966 2069  or example, if i
-0006ede0: 6473 6570 2069 7320 2d20 7468 656e 2077  dsep is - then w
-0006edf0: 6520 6861 7665 2073 7562 6a65 6374 6964  e have subjectid
-0006ee00: 2d64 6174 652d 696d 6167 6569 640a 2020  -date-imageid.  
-0006ee10: 2020 2d20 7769 6c64 5f63 6172 645f 6d6f    - wild_card_mo
-0006ee20: 6461 6c69 7479 5f69 6420 2862 6f6f 6c29  dality_id (bool)
-0006ee30: 3a20 6b65 6570 2069 6620 4661 6c73 6520  : keep if False 
-0006ee40: 666f 7220 7361 6665 7220 6578 6563 7574  for safer execut
-0006ee50: 696f 6e0a 2020 2020 2d20 7365 636f 6e64  ion.    - second
-0006ee60: 5f73 706c 6974 2028 626f 6f6c 293a 2074  _split (bool): t
-0006ee70: 6869 7320 6973 2061 2068 6163 6b20 7468  his is a hack th
-0006ee80: 6174 2077 696c 6c20 7370 6c69 7420 7468  at will split th
-0006ee90: 6520 696d 6167 6549 4420 6279 202e 2061  e imageID by . a
-0006eea0: 6e64 206b 6565 7020 7468 6520 6669 7273  nd keep the firs
-0006eeb0: 7420 7061 7274 206f 6620 7468 6520 7370  t part of the sp
-0006eec0: 6c69 743b 206d 6179 2062 6520 6e65 6564  lit; may be need
-0006eed0: 6564 2077 6865 6e20 7468 6520 696e 7075  ed when the inpu
-0006eee0: 7420 6669 6c65 6e61 6d65 7320 636f 6e74  t filenames cont
-0006eef0: 6169 6e20 2e0a 2020 2020 2d20 7665 7262  ain ..    - verb
-0006ef00: 6f73 6520 3a20 626f 6f6c 6561 6e0a 0a20  ose : boolean.. 
-0006ef10: 2020 204e 6f74 653a 0a20 2020 2054 6869     Note:.    Thi
-0006ef20: 7320 6675 6e63 7469 6f6e 2069 7320 7465  s function is te
-0006ef30: 7374 6564 2075 6e64 6572 206c 696d 6974  sted under limit
-0006ef40: 6564 2063 6972 6375 6d73 7461 6e63 6573  ed circumstances
-0006ef50: 2e20 5573 6520 7769 7468 2063 6175 7469  . Use with cauti
-0006ef60: 6f6e 2e0a 2020 2020 4f6e 6520 7061 7274  on..    One part
-0006ef70: 6963 756c 6172 2067 6f74 6368 6120 6973  icular gotcha is
-0006ef80: 2069 6620 7468 6520 696d 6167 6549 4420   if the imageID 
-0006ef90: 6973 2073 746f 7265 6420 6173 2061 206e  is stored as a n
-0006efa0: 756d 6572 6963 2076 616c 7565 2069 6e20  umeric value in 
-0006efb0: 7468 6520 6461 7461 6672 616d 6520 0a20  the dataframe . 
-0006efc0: 2020 2062 7574 2069 7320 6d65 616e 7420     but is meant 
-0006efd0: 746f 2062 6520 6120 7374 7269 6e67 2e20  to be a string. 
-0006efe0: 2045 2e67 2e20 2730 3030 2720 2873 7472   E.g. '000' (str
-0006eff0: 696e 6729 2077 6f75 6c64 2062 6520 696e  ing) would be in
-0006f000: 7465 7270 7265 7465 6420 6173 2030 2069  terpreted as 0 i
-0006f010: 6e20 7468 6520 0a20 2020 2066 696c 6520  n the .    file 
-0006f020: 6e61 6d65 2067 6c6f 622e 2020 5468 6973  name glob.  This
-0006f030: 2077 6f75 6c64 206d 6973 7320 7468 6520   would miss the 
-0006f040: 6578 7461 6e74 2028 6f6e 2064 6973 6b29  extant (on disk)
-0006f050: 2063 7376 2e0a 0a20 2020 2045 7861 6d70   csv...    Examp
-0006f060: 6c65 2075 7361 6765 3a0a 2020 2020 6167  le usage:.    ag
-0006f070: 675f 6466 203d 2061 6767 7265 6761 7465  g_df = aggregate
-0006f080: 5f61 6e74 7370 796d 6d5f 7265 7375 6c74  _antspymm_result
-0006f090: 735f 7364 6628 2073 7475 6479 6466 2c20  s_sdf( studydf, 
-0006f0a0: 7375 626a 6563 745f 636f 6c3d 2773 7562  subject_col='sub
-0006f0b0: 6a65 6374 4944 272c 2064 6174 655f 636f  jectID', date_co
-0006f0c0: 6c3d 2764 6174 6527 2c20 696d 6167 655f  l='date', image_
-0006f0d0: 636f 6c3d 2769 6d61 6765 4944 272c 2062  col='imageID', b
-0006f0e0: 6173 655f 7061 7468 3d22 2e2f 596f 7572  ase_path="./Your
-0006f0f0: 2f43 7573 746f 6d2f 5061 7468 2f22 290a  /Custom/Path/").
-0006f100: 0a20 2020 2041 7574 686f 723a 0a20 2020  .    Author:.   
-0006f110: 2041 7661 6e74 7320 616e 6420 4368 6174   Avants and Chat
-0006f120: 4750 540a 2020 2020 2222 220a 2020 2020  GPT.    """.    
-0006f130: 696d 706f 7274 2070 616e 6461 7320 6173  import pandas as
-0006f140: 2070 640a 2020 2020 696d 706f 7274 206e   pd.    import n
-0006f150: 756d 7079 2061 7320 6e70 0a20 2020 2066  umpy as np.    f
-0006f160: 726f 6d20 676c 6f62 2069 6d70 6f72 7420  rom glob import 
-0006f170: 676c 6f62 0a0a 2020 2020 6465 6620 7072  glob..    def pr
-0006f180: 6f67 7265 7373 5f72 6570 6f72 7465 7228  ogress_reporter(
-0006f190: 6375 7272 656e 745f 7374 6570 2c20 746f  current_step, to
-0006f1a0: 7461 6c5f 7374 6570 732c 2077 6964 7468  tal_steps, width
-0006f1b0: 3d35 3029 3a0a 2020 2020 2020 2020 2320  =50):.        # 
-0006f1c0: 4361 6c63 756c 6174 6520 7468 6520 7072  Calculate the pr
-0006f1d0: 6f70 6f72 7469 6f6e 206f 6620 7072 6f67  oportion of prog
-0006f1e0: 7265 7373 0a20 2020 2020 2020 2070 726f  ress.        pro
-0006f1f0: 6772 6573 7320 3d20 6375 7272 656e 745f  gress = current_
-0006f200: 7374 6570 202f 2074 6f74 616c 5f73 7465  step / total_ste
-0006f210: 7073 0a20 2020 2020 2020 2023 2043 616c  ps.        # Cal
-0006f220: 6375 6c61 7465 2074 6865 206e 756d 6265  culate the numbe
-0006f230: 7220 6f66 2027 6669 6c6c 6564 2720 6368  r of 'filled' ch
-0006f240: 6172 6163 7465 7273 2069 6e20 7468 6520  aracters in the 
-0006f250: 7072 6f67 7265 7373 2062 6172 0a20 2020  progress bar.   
-0006f260: 2020 2020 2066 696c 6c65 645f 6c65 6e67       filled_leng
-0006f270: 7468 203d 2069 6e74 2877 6964 7468 202a  th = int(width *
-0006f280: 2070 726f 6772 6573 7329 0a20 2020 2020   progress).     
-0006f290: 2020 2023 2043 7265 6174 6520 7468 6520     # Create the 
-0006f2a0: 7072 6f67 7265 7373 2062 6172 2073 7472  progress bar str
-0006f2b0: 696e 670a 2020 2020 2020 2020 6261 7220  ing.        bar 
-0006f2c0: 3d20 27e2 9688 2720 2a20 6669 6c6c 6564  = '...' * filled
-0006f2d0: 5f6c 656e 6774 6820 2b20 272d 2720 2a20  _length + '-' * 
-0006f2e0: 2877 6964 7468 202d 2066 696c 6c65 645f  (width - filled_
-0006f2f0: 6c65 6e67 7468 290a 2020 2020 2020 2020  length).        
-0006f300: 2320 5072 696e 7420 7468 6520 7072 6f67  # Print the prog
-0006f310: 7265 7373 2062 6172 2077 6974 6820 7065  ress bar with pe
-0006f320: 7263 656e 7461 6765 0a20 2020 2020 2020  rcentage.       
-0006f330: 2070 7269 6e74 2866 275c 7250 726f 6772   print(f'\rProgr
-0006f340: 6573 733a 207c 7b62 6172 7d7c 207b 696e  ess: |{bar}| {in
-0006f350: 7428 3130 3020 2a20 7072 6f67 7265 7373  t(100 * progress
-0006f360: 297d 2527 2c20 656e 643d 275c 7227 290a  )}%', end='\r').
-0006f370: 2020 2020 2020 2020 2320 5072 696e 7420          # Print 
-0006f380: 6120 6e65 7720 6c69 6e65 2077 6865 6e20  a new line when 
-0006f390: 7468 6520 7072 6f67 7265 7373 2069 7320  the progress is 
-0006f3a0: 636f 6d70 6c65 7465 0a20 2020 2020 2020  complete.       
-0006f3b0: 2069 6620 6375 7272 656e 745f 7374 6570   if current_step
-0006f3c0: 203d 3d20 746f 7461 6c5f 7374 6570 733a   == total_steps:
-0006f3d0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-0006f3e0: 6e74 2829 0a0a 2020 2020 6465 6620 6d79  nt()..    def my
-0006f3f0: 7265 6164 5f63 7376 2878 2c20 636e 6d73  read_csv(x, cnms
-0006f400: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-0006f410: 2020 2020 2020 2052 6561 6473 2061 2043         Reads a C
-0006f420: 5356 2066 696c 6520 616e 6420 7265 7475  SV file and retu
-0006f430: 726e 7320 6120 4461 7461 4672 616d 6520  rns a DataFrame 
-0006f440: 6578 636c 7564 696e 6720 7370 6563 6966  excluding specif
-0006f450: 6965 6420 636f 6c75 6d6e 732e 0a0a 2020  ied columns...  
-0006f460: 2020 2020 2020 5061 7261 6d65 7465 7273        Parameters
-0006f470: 3a0a 2020 2020 2020 2020 2d20 7820 2873  :.        - x (s
-0006f480: 7472 293a 2046 696c 6520 7061 7468 206f  tr): File path o
-0006f490: 6620 7468 6520 696e 7075 7420 4353 5620  f the input CSV 
-0006f4a0: 6669 6c65 2064 6573 6372 6962 696e 6720  file describing 
-0006f4b0: 7468 6520 626c 696e 6420 5143 206f 7574  the blind QC out
-0006f4c0: 7075 740a 2020 2020 2020 2020 2d20 636e  put.        - cn
-0006f4d0: 6d73 2028 6c69 7374 293a 204c 6973 7420  ms (list): List 
-0006f4e0: 6f66 2063 6f6c 756d 6e20 6e61 6d65 7320  of column names 
-0006f4f0: 746f 2065 7863 6c75 6465 2066 726f 6d20  to exclude from 
-0006f500: 7468 6520 4461 7461 4672 616d 652e 0a0a  the DataFrame...
-0006f510: 2020 2020 2020 2020 5265 7475 726e 733a          Returns:
-0006f520: 0a20 2020 2020 2020 2070 642e 4461 7461  .        pd.Data
-0006f530: 4672 616d 653a 2044 6174 6146 7261 6d65  Frame: DataFrame
-0006f540: 2077 6974 6820 7370 6563 6966 6965 6420   with specified 
-0006f550: 636f 6c75 6d6e 7320 6578 636c 7564 6564  columns excluded
-0006f560: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-0006f570: 2020 2020 2020 6466 203d 2070 642e 7265        df = pd.re
-0006f580: 6164 5f63 7376 2878 290a 2020 2020 2020  ad_csv(x).      
-0006f590: 2020 7265 7475 726e 2064 662e 6c6f 635b    return df.loc[
-0006f5a0: 3a2c 207e 6466 2e63 6f6c 756d 6e73 2e69  :, ~df.columns.i
-0006f5b0: 7369 6e28 636e 6d73 295d 0a0a 2020 2020  sin(cnms)]..    
-0006f5c0: 696d 706f 7274 2077 6172 6e69 6e67 730a  import warnings.
-0006f5d0: 2020 2020 2320 5761 726e 696e 6720 6d65      # Warning me
-0006f5e0: 7373 6167 6520 666f 7220 756e 7465 7374  ssage for untest
-0006f5f0: 6564 2066 756e 6374 696f 6e0a 2020 2020  ed function.    
-0006f600: 7761 726e 696e 6773 2e77 6172 6e28 2257  warnings.warn("W
-0006f610: 6172 6e69 6e67 3a20 5468 6973 2066 756e  arning: This fun
-0006f620: 6374 696f 6e20 6973 206e 6f74 2077 656c  ction is not wel
-0006f630: 6c20 7465 7374 6564 2e20 5573 6520 7769  l tested. Use wi
-0006f640: 7468 2063 6175 7469 6f6e 2e22 290a 0a20  th caution.").. 
-0006f650: 2020 2076 6d6f 6464 6963 7420 3d20 7b7d     vmoddict = {}
-0006f660: 0a20 2020 2023 2041 6464 206b 6579 2d76  .    # Add key-v
-0006f670: 616c 7565 2070 6169 7273 0a20 2020 2076  alue pairs.    v
-0006f680: 6d6f 6464 6963 745b 2769 6d61 6765 4944  moddict['imageID
-0006f690: 275d 203d 2027 5431 7727 0a20 2020 2076  '] = 'T1w'.    v
-0006f6a0: 6d6f 6464 6963 745b 2766 6c61 6972 6964  moddict['flairid
-0006f6b0: 275d 203d 2027 5432 466c 6169 7227 0a20  '] = 'T2Flair'. 
-0006f6c0: 2020 2076 6d6f 6464 6963 745b 2770 6572     vmoddict['per
-0006f6d0: 6669 6427 5d20 3d20 2770 6572 6627 0a20  fid'] = 'perf'. 
-0006f6e0: 2020 2076 6d6f 6464 6963 745b 2772 7366     vmoddict['rsf
-0006f6f0: 6964 3127 5d20 3d20 2772 7366 4d52 4927  id1'] = 'rsfMRI'
-0006f700: 0a23 2020 2020 766d 6f64 6469 6374 5b27  .#    vmoddict['
-0006f710: 7273 6669 6432 275d 203d 2027 7273 664d  rsfid2'] = 'rsfM
-0006f720: 5249 270a 2020 2020 766d 6f64 6469 6374  RI'.    vmoddict
-0006f730: 5b27 6474 6964 3127 5d20 3d20 2744 5449  ['dtid1'] = 'DTI
-0006f740: 270a 2320 2020 2076 6d6f 6464 6963 745b  '.#    vmoddict[
-0006f750: 2764 7469 6432 275d 203d 2027 4454 4927  'dtid2'] = 'DTI'
-0006f760: 0a20 2020 2076 6d6f 6464 6963 745b 276e  .    vmoddict['n
-0006f770: 6d69 6431 275d 203d 2027 4e4d 3244 4d54  mid1'] = 'NM2DMT
-0006f780: 270a 2320 2020 2076 6d6f 6464 6963 745b  '.#    vmoddict[
-0006f790: 276e 6d69 6432 275d 203d 2027 4e4d 3244  'nmid2'] = 'NM2D
-0006f7a0: 4d54 270a 0a20 2020 2023 2046 696c 7465  MT'..    # Filte
-0006f7b0: 7220 726f 7773 2077 6865 7265 206d 6f64  r rows where mod
-0006f7c0: 616c 6974 7920 6973 2027 5431 7727 0a20  ality is 'T1w'. 
-0006f7d0: 2020 2064 6620 3d20 7374 7564 795f 6466     df = study_df
-0006f7e0: 5b20 7374 7564 795f 6466 5b27 6d6f 6461  [ study_df['moda
-0006f7f0: 6c69 7479 275d 203d 3d20 2754 3177 275d  lity'] == 'T1w']
-0006f800: 0a20 2020 2062 6164 6e61 6d65 7320 3d20  .    badnames = 
-0006f810: 6765 745f 6e61 6d65 735f 6672 6f6d 5f64  get_names_from_d
-0006f820: 6174 615f 6672 616d 6528 205b 2755 6e6e  ata_frame( ['Unn
-0006f830: 616d 6564 275d 2c20 6466 2029 0a20 2020  amed'], df ).   
-0006f840: 2064 663d 6466 2e64 726f 7028 6261 646e   df=df.drop(badn
-0006f850: 616d 6573 2c20 6178 6973 3d31 290a 2020  ames, axis=1).  
-0006f860: 2020 2320 7072 6566 696c 7465 7220 6466    # prefilter df
-0006f870: 2066 6f72 2064 6174 6120 7468 6174 2065   for data that e
-0006f880: 7869 7374 730a 2020 2020 6b65 6570 203d  xists.    keep =
-0006f890: 206e 702e 7469 6c65 2820 4661 6c73 652c   np.tile( False,
-0006f8a0: 2064 662e 7368 6170 655b 305d 2029 0a20   df.shape[0] ). 
-0006f8b0: 2020 2066 6f72 2078 2069 6e20 7261 6e67     for x in rang
-0006f8c0: 6528 6466 2e73 6861 7065 5b30 5d29 3a0a  e(df.shape[0]):.
-0006f8d0: 2020 2020 2020 2020 6d79 666e 203d 206f          myfn = o
-0006f8e0: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
-0006f8f0: 2064 665b 2766 696c 656e 616d 6527 5d2e   df['filename'].
-0006f900: 696c 6f63 5b78 5d20 290a 2020 2020 2020  iloc[x] ).      
-0006f910: 2020 7465 6d70 203d 206d 7966 6e2e 7370    temp = myfn.sp
-0006f920: 6c69 7428 2073 706c 6974 7365 7020 290a  lit( splitsep ).
-0006f930: 2020 2020 2020 2020 2320 4765 6e65 7261          # Genera
-0006f940: 6c69 7a65 6420 7365 6172 6368 2070 6174  lized search pat
-0006f950: 6873 0a20 2020 2020 2020 2073 6964 3020  hs.        sid0 
-0006f960: 3d20 7374 7228 2074 656d 705b 315d 2029  = str( temp[1] )
-0006f970: 0a20 2020 2020 2020 2073 6964 203d 2073  .        sid = s
-0006f980: 7472 2820 6466 5b73 7562 6a65 6374 5f63  tr( df[subject_c
-0006f990: 6f6c 5d2e 696c 6f63 5b78 5d20 290a 2020  ol].iloc[x] ).  
-0006f9a0: 2020 2020 2020 6966 2073 6964 3020 213d        if sid0 !=
-0006f9b0: 2073 6964 3a0a 2020 2020 2020 2020 2020   sid:.          
-0006f9c0: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
-0006f9d0: 224f 5554 4552 3a20 7468 6520 6964 2064  "OUTER: the id d
-0006f9e0: 6572 6976 6564 2066 726f 6d20 7468 6520  erived from the 
-0006f9f0: 6669 6c65 6e61 6d65 2022 202b 2073 6964  filename " + sid
-0006fa00: 3020 2b20 2220 646f 6573 206e 6f74 206d  0 + " does not m
-0006fa10: 6174 6368 2074 6865 2069 6420 7374 6f72  atch the id stor
-0006fa20: 6564 2069 6e20 7468 6520 6461 7461 2066  ed in the data f
-0006fa30: 7261 6d65 2022 202b 2073 6964 2029 0a20  rame " + sid ). 
-0006fa40: 2020 2020 2020 2020 2020 2077 6172 6e69             warni
-0006fa50: 6e67 732e 7761 726e 2820 2266 696c 656e  ngs.warn( "filen
-0006fa60: 616d 6520 6973 203a 2022 202b 2020 6d79  ame is : " +  my
-0006fa70: 666e 2029 0a20 2020 2020 2020 2020 2020  fn ).           
-0006fa80: 2077 6172 6e69 6e67 732e 7761 726e 2820   warnings.warn( 
-0006fa90: 2273 6964 2069 7320 3a20 2220 2b20 7369  "sid is : " + si
-0006faa0: 6420 290a 2020 2020 2020 2020 2020 2020  d ).            
-0006fab0: 7761 726e 696e 6773 2e77 6172 6e28 2022  warnings.warn( "
-0006fac0: 7820 6973 203a 2022 202b 2073 7472 2878  x is : " + str(x
-0006fad0: 2920 290a 2020 2020 2020 2020 6d79 7072  ) ).        mypr
-0006fae0: 6f6a 203d 2073 7472 2864 665b 7072 6f6a  oj = str(df[proj
-0006faf0: 6563 745f 636f 6c5d 2e69 6c6f 635b 785d  ect_col].iloc[x]
-0006fb00: 290a 2020 2020 2020 2020 6d79 6461 7465  ).        mydate
-0006fb10: 203d 2073 7472 2864 665b 6461 7465 5f63   = str(df[date_c
-0006fb20: 6f6c 5d2e 696c 6f63 5b78 5d29 0a20 2020  ol].iloc[x]).   
-0006fb30: 2020 2020 206d 7969 6420 3d20 7374 7228       myid = str(
-0006fb40: 6466 5b69 6d61 6765 5f63 6f6c 5d2e 696c  df[image_col].il
-0006fb50: 6f63 5b78 5d29 0a20 2020 2020 2020 2069  oc[x]).        i
-0006fb60: 6620 7365 636f 6e64 5f73 706c 6974 3a0a  f second_split:.
-0006fb70: 2020 2020 2020 2020 2020 2020 6d79 6964              myid
-0006fb80: 203d 206d 7969 642e 7370 6c69 7428 222e   = myid.split(".
-0006fb90: 2229 5b30 5d0a 2020 2020 2020 2020 7061  ")[0].        pa
-0006fba0: 7468 5f74 656d 706c 6174 6520 3d20 6261  th_template = ba
-0006fbb0: 7365 5f70 6174 6820 2b20 222f 2220 2b20  se_path + "/" + 
-0006fbc0: 6d79 7072 6f6a 202b 2020 222f 2220 2b20  myproj +  "/" + 
-0006fbd0: 7369 6420 2b20 222f 2220 2b20 6d79 6461  sid + "/" + myda
-0006fbe0: 7465 202b 2027 2f27 202b 2068 6965 7276  te + '/' + hierv
-0006fbf0: 6172 6961 626c 6520 2b20 272f 2720 2b20  ariable + '/' + 
-0006fc00: 7374 7228 6d79 6964 2920 2b20 222f 220a  str(myid) + "/".
-0006fc10: 2020 2020 2020 2020 6869 6572 666e 203d          hierfn =
-0006fc20: 2073 6f72 7465 6428 676c 6f62 2820 7061   sorted(glob( pa
-0006fc30: 7468 5f74 656d 706c 6174 6520 2b20 222a  th_template + "*
-0006fc40: 2220 2b20 6869 6572 7661 7269 6162 6c65  " + hiervariable
-0006fc50: 202b 2022 2a77 6964 652e 6373 7622 2029   + "*wide.csv" )
-0006fc60: 2029 0a20 2020 2020 2020 2069 6620 6c65   ).        if le
-0006fc70: 6e28 2068 6965 7266 6e20 2920 3d3d 2030  n( hierfn ) == 0
-0006fc80: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-0006fc90: 696e 7428 2068 6965 7266 6e20 290a 2020  int( hierfn ).  
-0006fca0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0006fcb0: 2070 6174 685f 7465 6d70 6c61 7465 2029   path_template )
-0006fcc0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-0006fcd0: 6e74 2820 6d79 7072 6f6a 2029 0a20 2020  nt( myproj ).   
-0006fce0: 2020 2020 2020 2020 2070 7269 6e74 2820           print( 
-0006fcf0: 7369 6420 290a 2020 2020 2020 2020 2020  sid ).          
-0006fd00: 2020 7072 696e 7428 206d 7964 6174 6520    print( mydate 
-0006fd10: 2920 0a20 2020 2020 2020 2020 2020 2070  ) .            p
-0006fd20: 7269 6e74 2820 6d79 6964 2029 0a20 2020  rint( myid ).   
-0006fd30: 2020 2020 2069 6620 6c65 6e28 2068 6965       if len( hie
-0006fd40: 7266 6e20 2920 3e20 303a 0a20 2020 2020  rfn ) > 0:.     
-0006fd50: 2020 2020 2020 206b 6565 705b 785d 3d54         keep[x]=T
-0006fd60: 7275 650a 0a20 2020 2023 2064 663d 6466  rue..    # df=df
-0006fd70: 5b6b 6565 705d 0a20 2020 2069 6620 6466  [keep].    if df
-0006fd80: 2e73 6861 7065 5b30 5d20 3d3d 2030 3a0a  .shape[0] == 0:.
-0006fd90: 2020 2020 2020 2020 7761 726e 696e 6773          warnings
-0006fda0: 2e77 6172 6e28 2269 6e70 7574 2064 6174  .warn("input dat
-0006fdb0: 6120 6672 616d 6520 7368 6170 6520 6973  a frame shape is
-0006fdc0: 2066 696c 7465 7265 6420 646f 776e 2074   filtered down t
-0006fdd0: 6f20 7a65 726f 2229 0a20 2020 2020 2020  o zero").       
-0006fde0: 2072 6574 7572 6e20 6466 0a0a 2020 2020   return df..    
-0006fdf0: 6966 206e 6f74 2064 662e 696e 6465 782e  if not df.index.
-0006fe00: 6973 5f75 6e69 7175 653a 0a20 2020 2020  is_unique:.     
-0006fe10: 2020 2077 6172 6e69 6e67 732e 7761 726e     warnings.warn
-0006fe20: 2822 6461 7461 2066 7261 6d65 2064 6f65  ("data frame doe
-0006fe30: 7320 6e6f 7420 6861 7665 2075 6e69 7175  s not have uniqu
-0006fe40: 6520 696e 6469 6365 732e 2020 7765 2074  e indices.  we t
-0006fe50: 6865 7265 666f 7265 2072 6573 6574 2074  herefore reset t
-0006fe60: 6865 2069 6e64 6578 2074 6f20 616c 6c6f  he index to allo
-0006fe70: 7720 7468 6520 6675 6e63 7469 6f6e 2074  w the function t
-0006fe80: 6f20 636f 6e74 696e 7565 206f 6e2e 2220  o continue on." 
-0006fe90: 290a 2020 2020 2020 2020 6466 203d 2064  ).        df = d
-0006fea0: 662e 7265 7365 745f 696e 6465 7828 290a  f.reset_index().
-0006feb0: 0a20 2020 200a 2020 2020 6966 2076 6572  .    .    if ver
-0006fec0: 626f 7365 3a0a 2020 2020 2020 2020 7072  bose:.        pr
-0006fed0: 696e 7428 2022 6f72 6967 696e 616c 2069  int( "original i
-0006fee0: 6e70 7574 2068 6164 2073 6861 7065 2022  nput had shape "
-0006fef0: 202b 2073 7472 2820 6466 2e73 6861 7065   + str( df.shape
-0006ff00: 5b30 5d20 2920 2b20 2220 2854 3120 6f6e  [0] ) + " (T1 on
-0006ff10: 6c79 2920 616e 6420 7765 2066 696e 6420  ly) and we find 
-0006ff20: 2220 2b20 7374 7228 2028 6b65 6570 292e  " + str( (keep).
-0006ff30: 7375 6d28 2920 2920 2b20 2220 7769 7468  sum() ) + " with
-0006ff40: 2068 6965 7261 7263 6869 6361 6c20 6f75   hierarchical ou
-0006ff50: 7470 7574 2064 6566 696e 6564 2062 7920  tput defined by 
-0006ff60: 7661 7269 6162 6c65 3a20 2220 2b20 6869  variable: " + hi
-0006ff70: 6572 7661 7269 6162 6c65 2029 0a20 2020  ervariable ).   
-0006ff80: 2020 2020 2070 7269 6e74 2820 6466 2e73       print( df.s
-0006ff90: 6861 7065 2029 0a0a 2020 2020 6466 6f75  hape )..    dfou
-0006ffa0: 7420 3d20 7064 2e44 6174 6146 7261 6d65  t = pd.DataFrame
-0006ffb0: 2829 0a20 2020 206d 7963 7420 3d20 300a  ().    myct = 0.
-0006ffc0: 2020 2020 666f 7220 7820 696e 2072 616e      for x in ran
-0006ffd0: 6765 2820 6466 2e73 6861 7065 5b30 5d29  ge( df.shape[0])
-0006ffe0: 3a0a 2020 2020 2020 2020 6966 2076 6572  :.        if ver
-0006fff0: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-00070000: 2020 7072 696e 7428 225c 6e5c 6e2d 2d2d    print("\n\n---
-00070010: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00070020: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00070030: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2229  --------------")
-00070040: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00070050: 6e74 2866 227b 787d 2e2e 2e22 290a 2020  nt(f"{x}...").  
-00070060: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00070070: 2020 2020 2020 2020 7072 6f67 7265 7373          progress
-00070080: 5f72 6570 6f72 7465 7228 782c 2064 662e  _reporter(x, df.
-00070090: 7368 6170 655b 305d 2c20 7769 6474 683d  shape[0], width=
-000700a0: 3530 3029 0a20 2020 2020 2020 206c 6f63  500).        loc
-000700b0: 696e 6420 3d20 6466 2e69 6e64 6578 5b78  ind = df.index[x
-000700c0: 5d0a 2020 2020 2020 2020 6d79 666e 203d  ].        myfn =
-000700d0: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
-000700e0: 6528 2064 665b 2766 696c 656e 616d 6527  e( df['filename'
-000700f0: 5d2e 696c 6f63 5b78 5d20 290a 2020 2020  ].iloc[x] ).    
-00070100: 2020 2020 7369 6420 3d20 7374 7228 2064      sid = str( d
-00070110: 665b 7375 626a 6563 745f 636f 6c5d 2e69  f[subject_col].i
-00070120: 6c6f 635b 785d 2029 0a20 2020 2020 2020  loc[x] ).       
-00070130: 2074 656d 7042 203d 206d 7966 6e2e 7370   tempB = myfn.sp
-00070140: 6c69 7428 2073 706c 6974 7365 7020 290a  lit( splitsep ).
-00070150: 2020 2020 2020 2020 7369 6430 203d 2073          sid0 = s
-00070160: 7472 2874 656d 7042 5b31 5d29 0a20 2020  tr(tempB[1]).   
-00070170: 2020 2020 2069 6620 7369 6430 2021 3d20       if sid0 != 
-00070180: 7369 6420 616e 6420 7665 7262 6f73 653a  sid and verbose:
-00070190: 0a20 2020 2020 2020 2020 2020 2077 6172  .            war
-000701a0: 6e69 6e67 732e 7761 726e 2822 494e 4e45  nings.warn("INNE
-000701b0: 523a 2074 6865 2069 6420 6465 7269 7665  R: the id derive
-000701c0: 6420 6672 6f6d 2074 6865 2066 696c 656e  d from the filen
-000701d0: 616d 6520 2220 2b20 7374 7228 7369 6429  ame " + str(sid)
-000701e0: 202b 2022 2064 6f65 7320 6e6f 7420 6d61   + " does not ma
-000701f0: 7463 6820 7468 6520 6964 2073 746f 7265  tch the id store
-00070200: 6420 696e 2074 6865 2064 6174 6120 6672  d in the data fr
-00070210: 616d 6520 2220 2b20 7374 7228 7369 6430  ame " + str(sid0
-00070220: 2920 290a 2020 2020 2020 2020 2020 2020  ) ).            
-00070230: 7761 726e 696e 6773 2e77 6172 6e28 2022  warnings.warn( "
-00070240: 6669 6c65 6e61 6d65 2069 7320 3a20 2220  filename is : " 
-00070250: 2b20 2073 7472 286d 7966 6e29 2029 0a20  +  str(myfn) ). 
-00070260: 2020 2020 2020 2020 2020 2077 6172 6e69             warni
-00070270: 6e67 732e 7761 726e 2820 2273 6964 2069  ngs.warn( "sid i
-00070280: 7320 3a20 2220 2b20 7374 7228 7369 6429  s : " + str(sid)
-00070290: 2029 0a20 2020 2020 2020 2020 2020 2077   ).            w
-000702a0: 6172 6e69 6e67 732e 7761 726e 2820 2278  arnings.warn( "x
-000702b0: 2069 7320 3a20 2220 2b20 7374 7228 7829   is : " + str(x)
-000702c0: 2029 0a20 2020 2020 2020 2020 2020 2077   ).            w
-000702d0: 6172 6e69 6e67 732e 7761 726e 2820 2269  arnings.warn( "i
-000702e0: 6e64 6578 2069 7320 3a20 2220 2b20 7374  ndex is : " + st
-000702f0: 7228 6c6f 6369 6e64 2920 290a 2020 2020  r(locind) ).    
-00070300: 2020 2020 6d79 7072 6f6a 203d 2073 7472      myproj = str
-00070310: 2864 665b 7072 6f6a 6563 745f 636f 6c5d  (df[project_col]
-00070320: 2e69 6c6f 635b 785d 290a 2020 2020 2020  .iloc[x]).      
-00070330: 2020 6d79 6461 7465 203d 2073 7472 2864    mydate = str(d
-00070340: 665b 6461 7465 5f63 6f6c 5d2e 696c 6f63  f[date_col].iloc
-00070350: 5b78 5d29 0a20 2020 2020 2020 206d 7969  [x]).        myi
-00070360: 6420 3d20 7374 7228 6466 5b69 6d61 6765  d = str(df[image
-00070370: 5f63 6f6c 5d2e 696c 6f63 5b78 5d29 0a20  _col].iloc[x]). 
-00070380: 2020 2020 2020 2069 6620 7365 636f 6e64         if second
-00070390: 5f73 706c 6974 3a0a 2020 2020 2020 2020  _split:.        
-000703a0: 2020 2020 6d79 6964 203d 206d 7969 642e      myid = myid.
-000703b0: 7370 6c69 7428 222e 2229 5b30 5d0a 2020  split(".")[0].  
-000703c0: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-000703d0: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-000703e0: 696e 7428 206d 7966 6e20 290a 2020 2020  int( myfn ).    
-000703f0: 2020 2020 2020 2020 7072 696e 7428 2074          print( t
-00070400: 656d 7020 290a 2020 2020 2020 2020 2020  emp ).          
-00070410: 2020 7072 696e 7428 2022 6964 2022 202b    print( "id " +
-00070420: 2073 6964 2020 290a 2020 2020 2020 2020   sid  ).        
-00070430: 7061 7468 5f74 656d 706c 6174 6520 3d20  path_template = 
-00070440: 6261 7365 5f70 6174 6820 2b20 222f 2220  base_path + "/" 
-00070450: 2b20 6d79 7072 6f6a 202b 2020 222f 2220  + myproj +  "/" 
-00070460: 2b20 7369 6420 2b20 222f 2220 2b20 6d79  + sid + "/" + my
-00070470: 6461 7465 202b 2027 2f27 202b 2068 6965  date + '/' + hie
-00070480: 7276 6172 6961 626c 6520 2b20 272f 2720  rvariable + '/' 
-00070490: 2b20 7374 7228 6d79 6964 2920 2b20 222f  + str(myid) + "/
-000704a0: 220a 2020 2020 2020 2020 7365 6172 6368  ".        search
-000704b0: 6869 6572 203d 2070 6174 685f 7465 6d70  hier = path_temp
-000704c0: 6c61 7465 202b 2022 2a22 202b 2068 6965  late + "*" + hie
-000704d0: 7276 6172 6961 626c 6520 2b20 222a 7769  rvariable + "*wi
-000704e0: 6465 2e63 7376 220a 2020 2020 2020 2020  de.csv".        
-000704f0: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-00070500: 2020 2020 2020 2020 7072 696e 7428 2073          print( s
-00070510: 6561 7263 6868 6965 7220 290a 2020 2020  earchhier ).    
-00070520: 2020 2020 6869 6572 666e 203d 2073 6f72      hierfn = sor
-00070530: 7465 6428 2067 6c6f 6228 2073 6561 7263  ted( glob( searc
-00070540: 6868 6965 7220 2920 290a 2020 2020 2020  hhier ) ).      
-00070550: 2020 6966 206c 656e 2820 6869 6572 666e    if len( hierfn
-00070560: 2029 203e 2031 3a0a 2020 2020 2020 2020   ) > 1:.        
-00070570: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-00070580: 7272 6f72 2822 7468 6572 6520 6172 6520  rror("there are 
-00070590: 2220 2b20 7374 7228 206c 656e 2820 6869  " + str( len( hi
-000705a0: 6572 666e 2029 2029 202b 2022 206e 756d  erfn ) ) + " num
-000705b0: 6265 7220 6f66 2068 6965 7220 666e 7320  ber of hier fns 
-000705c0: 7769 7468 2073 6561 7263 6820 7061 7468  with search path
-000705d0: 2022 202b 2073 6561 7263 6868 6965 7220   " + searchhier 
-000705e0: 290a 2020 2020 2020 2020 6966 206c 656e  ).        if len
-000705f0: 2820 6869 6572 666e 2029 203d 3d20 313a  ( hierfn ) == 1:
-00070600: 0a20 2020 2020 2020 2020 2020 2068 6466  .            hdf
-00070610: 3d74 3164 663d 6474 6466 3d72 7364 663d  =t1df=dtdf=rsdf=
-00070620: 7065 7266 6466 3d6e 6d64 663d 666c 6169  perfdf=nmdf=flai
-00070630: 7264 663d 4e6f 6e65 0a20 2020 2020 2020  rdf=None.       
-00070640: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-00070650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00070660: 2070 7269 6e74 2868 6965 7266 6e29 0a20   print(hierfn). 
-00070670: 2020 2020 2020 2020 2020 2068 6466 203d             hdf =
-00070680: 2070 642e 7265 6164 5f63 7376 2868 6965   pd.read_csv(hie
-00070690: 7266 6e5b 305d 290a 2020 2020 2020 2020  rfn[0]).        
-000706a0: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
-000706b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000706c0: 7072 696e 7428 2068 6466 5b27 766f 6c5f  print( hdf['vol_
-000706d0: 6865 6d69 7370 6865 7265 5f6c 6566 7468  hemisphere_lefth
-000706e0: 656d 6973 7068 6572 6573 275d 2029 0a20  emispheres'] ). 
-000706f0: 2020 2020 2020 2020 2020 2062 6164 6e61             badna
-00070700: 6d65 7320 3d20 6765 745f 6e61 6d65 735f  mes = get_names_
-00070710: 6672 6f6d 5f64 6174 615f 6672 616d 6528  from_data_frame(
-00070720: 205b 2755 6e6e 616d 6564 275d 2c20 6864   ['Unnamed'], hd
-00070730: 6620 290a 2020 2020 2020 2020 2020 2020  f ).            
-00070740: 6864 663d 6864 662e 6472 6f70 2862 6164  hdf=hdf.drop(bad
-00070750: 6e61 6d65 732c 2061 7869 733d 3129 0a20  names, axis=1). 
-00070760: 2020 2020 2020 2020 2020 206e 756d 7320             nums 
-00070770: 3d20 5b69 7369 6e73 7461 6e63 6528 6864  = [isinstance(hd
-00070780: 665b 636f 6c5d 2e69 6c6f 635b 305d 2c20  f[col].iloc[0], 
-00070790: 2869 6e74 2c20 666c 6f61 7429 2920 666f  (int, float)) fo
-000707a0: 7220 636f 6c20 696e 2068 6466 2e63 6f6c  r col in hdf.col
-000707b0: 756d 6e73 5d0a 2020 2020 2020 2020 2020  umns].          
-000707c0: 2020 636f 7265 6e61 6d65 7320 3d20 6c69    corenames = li
-000707d0: 7374 286e 702e 6172 7261 7928 6864 662e  st(np.array(hdf.
-000707e0: 636f 6c75 6d6e 7329 5b6e 756d 735d 290a  columns)[nums]).
-000707f0: 2020 2020 2020 2020 2020 2020 2320 6864              # hd
-00070800: 662e 6c6f 635b 3a2c 206e 756d 735d 203d  f.loc[:, nums] =
-00070810: 2068 6466 2e6c 6f63 5b3a 2c20 6e75 6d73   hdf.loc[:, nums
-00070820: 5d2e 6164 645f 7072 6566 6978 2822 5431  ].add_prefix("T1
-00070830: 4869 6572 5f22 290a 2020 2020 2020 2020  Hier_").        
-00070840: 2020 2020 6864 6620 3d20 6864 662e 6164      hdf = hdf.ad
-00070850: 645f 7072 6566 6978 2822 5431 4869 6572  d_prefix("T1Hier
-00070860: 5f22 290a 2020 2020 2020 2020 2020 2020  _").            
-00070870: 6d79 6374 203d 206d 7963 7420 2b20 310a  myct = myct + 1.
-00070880: 2020 2020 2020 2020 2020 2020 6466 6c69              dfli
-00070890: 7374 203d 205b 6864 665d 0a0a 2020 2020  st = [hdf]..    
-000708a0: 2020 2020 2020 2020 666f 7220 6d79 6d6f          for mymo
-000708b0: 6420 696e 2076 6d6f 6464 6963 742e 6b65  d in vmoddict.ke
-000708c0: 7973 2829 3a0a 2020 2020 2020 2020 2020  ys():.          
-000708d0: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-000708e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000708f0: 2020 2020 2020 7072 696e 7428 225c 6e5c        print("\n\
-00070900: 6e2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  n***************
-00070910: 2a2a 2a2a 2a2a 2a2a 2a2a 2022 202b 206d  ********** " + m
-00070920: 796d 6f64 202b 2022 202a 2a2a 2a2a 2a2a  ymod + " *******
-00070930: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ****************
-00070940: 2a2a 2229 0a20 2020 2020 2020 2020 2020  **").           
-00070950: 2020 2020 206d 6f64 616c 6974 7963 6c61       modalitycla
-00070960: 7373 203d 2076 6d6f 6464 6963 745b 206d  ss = vmoddict[ m
-00070970: 796d 6f64 205d 0a20 2020 2020 2020 2020  ymod ].         
-00070980: 2020 2020 2020 2069 6620 7769 6c64 5f63         if wild_c
-00070990: 6172 645f 6d6f 6461 6c69 7479 5f69 643a  ard_modality_id:
-000709a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000709b0: 2020 2020 206d 796d 6f64 6964 203d 2027       mymodid = '
-000709c0: 2a27 0a20 2020 2020 2020 2020 2020 2020  *'.             
-000709d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000709e0: 2020 2020 2020 2020 2020 2020 206d 796d               mym
-000709f0: 6f64 6964 203d 2073 7472 2820 6466 5b6d  odid = str( df[m
-00070a00: 796d 6f64 5d2e 696c 6f63 5b78 5d20 290a  ymod].iloc[x] ).
-00070a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070a20: 2020 2020 6966 206d 796d 6f64 6964 2e6c      if mymodid.l
-00070a30: 6f77 6572 2829 2021 3d20 226e 616e 2220  ower() != "nan" 
-00070a40: 616e 6420 6d79 6d6f 6469 642e 6c6f 7765  and mymodid.lowe
-00070a50: 7228 2920 213d 2022 6e61 223a 0a20 2020  r() != "na":.   
-00070a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070a70: 2020 2020 206d 796d 6f64 6964 203d 206f       mymodid = o
-00070a80: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
-00070a90: 206d 796d 6f64 6964 2029 0a20 2020 2020   mymodid ).     
-00070aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070ab0: 2020 206d 796d 6f64 6964 203d 206f 732e     mymodid = os.
-00070ac0: 7061 7468 2e73 706c 6974 6578 7428 206d  path.splitext( m
-00070ad0: 796d 6f64 6964 2029 5b30 5d0a 2020 2020  ymodid )[0].    
-00070ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070af0: 2020 2020 6d79 6d6f 6469 6420 3d20 6f73      mymodid = os
-00070b00: 2e70 6174 682e 7370 6c69 7465 7874 2820  .path.splitext( 
-00070b10: 6d79 6d6f 6469 6420 295b 305d 0a20 2020  mymodid )[0].   
-00070b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070b30: 2020 2020 2074 656d 7020 3d20 6d79 6d6f       temp = mymo
-00070b40: 6469 642e 7370 6c69 7428 2069 6473 6570  did.split( idsep
-00070b50: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00070b60: 2020 2020 2020 2020 2020 206d 796d 6f64             mymod
-00070b70: 6964 203d 2074 656d 705b 206c 656e 2820  id = temp[ len( 
-00070b80: 7465 6d70 2029 2d31 205d 0a20 2020 2020  temp )-1 ].     
-00070b90: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00070ba0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00070bb0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00070bc0: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-00070bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070be0: 2020 2020 2070 7269 6e74 2822 6d69 7373       print("miss
-00070bf0: 696e 6722 290a 2020 2020 2020 2020 2020  ing").          
-00070c00: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00070c10: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
-00070c20: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
-00070c30: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00070c40: 2020 2020 2020 2070 7269 6e74 2820 226d         print( "m
-00070c50: 6f64 616c 6974 7920 6964 2069 7320 2220  odality id is " 
-00070c60: 2b20 6d79 6d6f 6469 6420 2b20 2220 666f  + mymodid + " fo
-00070c70: 7220 6d6f 6461 6c69 7479 2022 202b 206d  r modality " + m
-00070c80: 6f64 616c 6974 7963 6c61 7373 202b 2027  odalityclass + '
-00070c90: 206d 6f64 616c 6974 7920 7370 6563 6966   modality specif
-00070ca0: 6963 2073 7562 6a20 2720 2b20 7369 6420  ic subj ' + sid 
-00070cb0: 2b20 2720 6d6f 6461 6c69 7479 2073 7065  + ' modality spe
-00070cc0: 6369 6669 6320 6964 2069 7320 2720 2b20  cific id is ' + 
-00070cd0: 6d79 6964 202b 2022 2069 7473 2064 6174  myid + " its dat
-00070ce0: 6520 2220 2b20 206d 7964 6174 6520 290a  e " +  mydate ).
-00070cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070d00: 6d6f 6461 6c69 7479 636c 6173 7373 6561  modalityclasssea
-00070d10: 7263 6820 3d20 6d6f 6461 6c69 7479 636c  rch = modalitycl
-00070d20: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
-00070d30: 2020 2020 6966 206d 6f64 616c 6974 7963      if modalityc
-00070d40: 6c61 7373 2069 6e20 5b27 7273 664d 5249  lass in ['rsfMRI
-00070d50: 272c 2744 5449 275d 3a0a 2020 2020 2020  ','DTI']:.      
-00070d60: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-00070d70: 6461 6c69 7479 636c 6173 7373 6561 7263  dalityclasssearc
-00070d80: 683d 6d6f 6461 6c69 7479 636c 6173 732b  h=modalityclass+
-00070d90: 222a 220a 2020 2020 2020 2020 2020 2020  "*".            
-00070da0: 2020 2020 7061 7468 5f74 656d 706c 6174      path_templat
-00070db0: 655f 6d20 3d20 6261 7365 5f70 6174 6820  e_m = base_path 
-00070dc0: 2b20 222f 2220 2b20 6d79 7072 6f6a 202b  + "/" + myproj +
-00070dd0: 2020 222f 2220 2b20 7369 6420 2b20 222f    "/" + sid + "/
-00070de0: 2220 2b20 6d79 6461 7465 202b 2027 2f27  " + mydate + '/'
-00070df0: 202b 206d 6f64 616c 6974 7963 6c61 7373   + modalityclass
-00070e00: 7365 6172 6368 202b 2027 2f27 202b 206d  search + '/' + m
-00070e10: 796d 6f64 6964 202b 2022 2f22 0a20 2020  ymodid + "/".   
-00070e20: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-00070e30: 7365 6172 6368 203d 2070 6174 685f 7465  search = path_te
-00070e40: 6d70 6c61 7465 5f6d 202b 2022 2a22 202b  mplate_m + "*" +
-00070e50: 206d 6f64 616c 6974 7963 6c61 7373 7365   modalityclassse
-00070e60: 6172 6368 202b 2022 2a77 6964 652e 6373  arch + "*wide.cs
-00070e70: 7622 0a20 2020 2020 2020 2020 2020 2020  v".             
-00070e80: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
-00070e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070ea0: 2020 2070 7269 6e74 2820 6d6f 6473 6561     print( modsea
-00070eb0: 7263 6820 290a 2020 2020 2020 2020 2020  rch ).          
-00070ec0: 2020 2020 2020 7431 7766 6e20 3d20 736f        t1wfn = so
-00070ed0: 7274 6564 2820 676c 6f62 2820 6d6f 6473  rted( glob( mods
-00070ee0: 6561 7263 6820 2920 290a 2020 2020 2020  earch ) ).      
-00070ef0: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-00070f00: 2820 7431 7766 6e20 2920 3e20 313a 0a20  ( t1wfn ) > 1:. 
-00070f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070f20: 2020 206e 6c61 7267 6520 3d20 6c65 6e28     nlarge = len(
-00070f30: 7431 7766 6e29 0a20 2020 2020 2020 2020  t1wfn).         
-00070f40: 2020 2020 2020 2020 2020 2074 3177 666e             t1wfn
-00070f50: 203d 2066 696e 645f 6d6f 7374 5f72 6563   = find_most_rec
-00070f60: 656e 745f 6669 6c65 2820 7431 7766 6e20  ent_file( t1wfn 
-00070f70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00070f80: 2020 2020 2020 7761 726e 696e 6773 2e77        warnings.w
-00070f90: 6172 6e28 2274 6865 7265 2061 7265 2022  arn("there are "
-00070fa0: 202b 2073 7472 2820 6e6c 6172 6765 2029   + str( nlarge )
-00070fb0: 202b 2022 206e 756d 6265 7220 6f66 2077   + " number of w
-00070fc0: 6964 6520 666e 7320 7769 7468 2073 6561  ide fns with sea
-00070fd0: 7263 6820 7061 7468 2022 202b 206d 6f64  rch path " + mod
-00070fe0: 7365 6172 6368 202b 2022 2077 6520 7461  search + " we ta
-00070ff0: 6b65 2074 6865 206d 6f73 7420 7265 6365  ke the most rece
-00071000: 6e74 206f 6620 7468 6573 6520 2220 2b20  nt of these " + 
-00071010: 7431 7766 6e5b 305d 2029 0a20 2020 2020  t1wfn[0] ).     
-00071020: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-00071030: 6e28 2074 3177 666e 2029 203d 3d20 313a  n( t1wfn ) == 1:
-00071040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00071050: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-00071060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00071070: 2020 2020 2020 2020 2070 7269 6e74 2874           print(t
-00071080: 3177 666e 290a 2020 2020 2020 2020 2020  1wfn).          
-00071090: 2020 2020 2020 2020 2020 7431 6466 203d            t1df =
-000710a0: 206d 7972 6561 645f 6373 7628 7431 7766   myread_csv(t1wf
-000710b0: 6e5b 305d 2c20 636f 7265 6e61 6d65 7329  n[0], corenames)
-000710c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000710d0: 2020 2020 2074 3164 6620 3d20 6669 6c74       t1df = filt
-000710e0: 6572 5f64 6628 2074 3164 662c 206d 6f64  er_df( t1df, mod
-000710f0: 616c 6974 7963 6c61 7373 2b27 5f27 290a  alityclass+'_').
-00071100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00071110: 2020 2020 6466 6c69 7374 203d 2064 666c      dflist = dfl
-00071120: 6973 7420 2b20 5b74 3164 665d 0a20 2020  ist + [t1df].   
-00071130: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00071140: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00071150: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
-00071160: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00071170: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00071180: 2820 2220 6361 6e6e 6f74 2066 696e 6420  ( " cannot find 
-00071190: 2220 2b20 6d6f 6473 6561 7263 6820 290a  " + modsearch ).
-000711a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000711b0: 0a20 2020 2020 2020 2020 2020 2068 6466  .            hdf
-000711c0: 203d 2070 642e 636f 6e63 6174 2820 6466   = pd.concat( df
-000711d0: 6c69 7374 2c20 6178 6973 3d31 2c20 6967  list, axis=1, ig
-000711e0: 6e6f 7265 5f69 6e64 6578 3d46 616c 7365  nore_index=False
-000711f0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00071200: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-00071210: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00071220: 2022 636f 756e 743a 2022 202b 2073 7472   "count: " + str
-00071230: 2820 6d79 6374 2029 2029 0a20 2020 2020  ( myct ) ).     
-00071240: 2020 2020 2020 2073 7562 6466 203d 2064         subdf = d
-00071250: 662e 696c 6f63 5b5b 785d 5d0a 2020 2020  f.iloc[[x]].    
-00071260: 2020 2020 2020 2020 6864 662e 696e 6465          hdf.inde
-00071270: 7820 3d20 7375 6264 662e 696e 6465 782e  x = subdf.index.
-00071280: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
-00071290: 2020 2073 7562 6466 203d 2070 642e 636f     subdf = pd.co
-000712a0: 6e63 6174 2820 5b73 7562 6466 2c68 6466  ncat( [subdf,hdf
-000712b0: 5d2c 2061 7869 733d 312c 2069 676e 6f72  ], axis=1, ignor
-000712c0: 655f 696e 6465 783d 4661 6c73 6529 0a20  e_index=False). 
-000712d0: 2020 2020 2020 2020 2020 2064 666f 7574             dfout
-000712e0: 203d 2070 642e 636f 6e63 6174 2820 5b64   = pd.concat( [d
-000712f0: 666f 7574 2c73 7562 6466 5d2c 2061 7869  fout,subdf], axi
-00071300: 733d 302c 2069 676e 6f72 655f 696e 6465  s=0, ignore_inde
-00071310: 783d 4661 6c73 6520 290a 0a20 2020 2069  x=False )..    i
-00071320: 6620 6466 6f75 742e 7368 6170 655b 305d  f dfout.shape[0]
-00071330: 203e 2030 3a0a 2020 2020 2020 2020 6261   > 0:.        ba
-00071340: 646e 616d 6573 203d 2067 6574 5f6e 616d  dnames = get_nam
-00071350: 6573 5f66 726f 6d5f 6461 7461 5f66 7261  es_from_data_fra
-00071360: 6d65 2820 5b27 556e 6e61 6d65 6427 5d2c  me( ['Unnamed'],
-00071370: 2064 666f 7574 2029 0a20 2020 2020 2020   dfout ).       
-00071380: 2064 666f 7574 3d64 666f 7574 2e64 726f   dfout=dfout.dro
-00071390: 7028 6261 646e 616d 6573 2c20 6178 6973  p(badnames, axis
-000713a0: 3d31 290a 2020 2020 7265 7475 726e 2064  =1).    return d
-000713b0: 666f 7574 0a0a 6465 6620 656e 616e 7469  fout..def enanti
-000713c0: 6f6d 6f72 7068 6963 5f66 696c 6c69 6e67  omorphic_filling
-000713d0: 5f77 6974 686f 7574 5f6d 6173 6b28 2069  _without_mask( i
-000713e0: 6d61 6765 2c20 6178 6973 3d30 2c20 696e  mage, axis=0, in
-000713f0: 7465 6e73 6974 793d 276c 6f77 2720 293a  tensity='low' ):
-00071400: 0a20 2020 2022 2222 0a20 2020 2050 6572  .    """.    Per
-00071410: 666f 726d 2061 6e20 656e 616e 7469 6f6d  form an enantiom
-00071420: 6f72 7068 6963 206c 6573 696f 6e20 6669  orphic lesion fi
-00071430: 6c6c 696e 6720 6f6e 2061 6e20 696d 6167  lling on an imag
-00071440: 6520 7769 7468 6f75 7420 6120 6c65 7369  e without a lesi
-00071450: 6f6e 206d 6173 6b2e 0a0a 2020 2020 4172  on mask...    Ar
-00071460: 6773 3a0a 2020 2020 696d 6167 6520 2861  gs:.    image (a
-00071470: 6e74 7349 6d61 6765 293a 2054 6865 2061  ntsImage): The a
-00071480: 6e74 7320 696d 6167 6520 746f 2066 6c69  nts image to fli
-00071490: 7020 616e 6420 6669 6c6c 0a20 2020 2061  p and fill.    a
-000714a0: 7869 7320 2820 696e 7420 293a 2074 6865  xis ( int ): the
-000714b0: 2061 7869 7320 616c 6f6e 6720 7768 6963   axis along whic
-000714c0: 6820 746f 2072 6566 6c65 6374 2074 6865  h to reflect the
-000714d0: 2069 6d61 6765 0a20 2020 2069 6e74 656e   image.    inten
-000714e0: 7369 7479 2028 2073 7472 2029 203a 206c  sity ( str ) : l
-000714f0: 6f77 206f 7220 6869 6768 0a0a 2020 2020  ow or high..    
-00071500: 5265 7475 726e 733a 0a20 2020 2061 6e74  Returns:.    ant
-00071510: 732e 414e 5473 496d 6167 653a 2054 6865  s.ANTsImage: The
-00071520: 2069 6d61 6765 2061 6674 6572 2065 6e61   image after ena
-00071530: 6e74 696f 6d6f 7270 6869 6320 6669 6c6c  ntiomorphic fill
-00071540: 696e 672e 0a20 2020 2022 2222 0a20 2020  ing..    """.   
-00071550: 2069 6d61 6765 6e20 3d20 616e 7473 2e69   imagen = ants.i
-00071560: 4d61 7468 2820 696d 6167 652c 2027 4e6f  Math( image, 'No
-00071570: 726d 616c 697a 6527 2029 0a20 2020 2069  rmalize' ).    i
-00071580: 6d61 6765 6e20 3d20 616e 7473 2e69 4d61  magen = ants.iMa
-00071590: 7468 2820 696d 6167 656e 2c20 2254 7275  th( imagen, "Tru
-000715a0: 6e63 6174 6549 6e74 656e 7369 7479 222c  ncateIntensity",
-000715b0: 2031 652d 362c 2030 2e39 3820 290a 2020   1e-6, 0.98 ).  
-000715c0: 2020 696d 6167 656e 203d 2061 6e74 732e    imagen = ants.
-000715d0: 694d 6174 6828 2069 6d61 6765 6e2c 2027  iMath( imagen, '
-000715e0: 4e6f 726d 616c 697a 6527 2029 0a20 2020  Normalize' ).   
-000715f0: 2023 2043 7265 6174 6520 6120 6d69 7272   # Create a mirr
-00071600: 6f72 2069 6d61 6765 2028 666c 6970 7069  or image (flippi
-00071610: 6e67 206c 6566 7420 616e 6420 7269 6768  ng left and righ
-00071620: 7429 0a20 2020 206d 6972 726f 725f 696d  t).    mirror_im
-00071630: 6167 6520 3d20 616e 7473 2e72 6566 6c65  age = ants.refle
-00071640: 6374 5f69 6d61 6765 2869 6d61 6765 6e2c  ct_image(imagen,
-00071650: 2061 7869 733d 302c 2074 783d 2753 794e   axis=0, tx='SyN
-00071660: 2720 295b 2777 6172 7065 646d 6f76 6f75  ' )['warpedmovou
-00071670: 7427 5d0a 0a20 2020 2023 2043 7265 6174  t']..    # Creat
-00071680: 6520 6120 7379 6d6d 6574 7269 6320 7665  e a symmetric ve
-00071690: 7273 696f 6e20 6f66 2074 6865 2069 6d61  rsion of the ima
-000716a0: 6765 2062 7920 6176 6572 6167 696e 6720  ge by averaging 
-000716b0: 7468 6520 6f72 6967 696e 616c 2061 6e64  the original and
-000716c0: 2074 6865 206d 6972 726f 7220 696d 6167   the mirror imag
-000716d0: 650a 2020 2020 7379 6d6d 6574 7269 635f  e.    symmetric_
-000716e0: 696d 6167 6520 3d20 696d 6167 656e 202a  image = imagen *
-000716f0: 2030 2e35 202b 206d 6972 726f 725f 696d   0.5 + mirror_im
-00071700: 6167 6520 2a20 302e 350a 0a20 2020 2023  age * 0.5..    #
-00071710: 2049 6465 6e74 6966 7920 706f 7465 6e74   Identify potent
-00071720: 6961 6c20 6c65 7369 6f6e 2061 7265 6173  ial lesion areas
-00071730: 2062 7920 6669 6e64 696e 6720 6469 6666   by finding diff
-00071740: 6572 656e 6365 7320 6265 7477 6565 6e20  erences between 
-00071750: 7468 6520 6f72 6967 696e 616c 2061 6e64  the original and
-00071760: 2073 796d 6d65 7472 6963 2069 6d61 6765   symmetric image
-00071770: 0a20 2020 2064 6966 6665 7265 6e63 655f  .    difference_
-00071780: 696d 6167 6520 3d20 696d 6167 6520 2d20  image = image - 
-00071790: 7379 6d6d 6574 7269 635f 696d 6167 650a  symmetric_image.
-000717a0: 2020 2020 6469 6666 7365 6720 3d20 616e      diffseg = an
-000717b0: 7473 2e74 6872 6573 686f 6c64 5f69 6d61  ts.threshold_ima
-000717c0: 6765 2864 6966 6665 7265 6e63 655f 696d  ge(difference_im
-000717d0: 6167 652c 2022 4f74 7375 222c 2033 2029  age, "Otsu", 3 )
-000717e0: 0a20 2020 2069 6620 696e 7465 6e73 6974  .    if intensit
-000717f0: 7920 3d3d 2027 6c6f 7727 3a0a 2020 2020  y == 'low':.    
-00071800: 2020 2020 6c69 6b65 6c79 5f6c 6573 696f      likely_lesio
-00071810: 6e20 3d20 616e 7473 2e74 6872 6573 686f  n = ants.thresho
-00071820: 6c64 5f69 6d61 6765 2820 6469 6666 7365  ld_image( diffse
-00071830: 672c 2031 2c20 2031 290a 2020 2020 656c  g, 1,  1).    el
-00071840: 7365 3a0a 2020 2020 2020 2020 6c69 6b65  se:.        like
-00071850: 6c79 5f6c 6573 696f 6e20 3d20 616e 7473  ly_lesion = ants
-00071860: 2e74 6872 6573 686f 6c64 5f69 6d61 6765  .threshold_image
-00071870: 2820 6469 6666 7365 672c 2033 2c20 2033  ( diffseg, 3,  3
-00071880: 290a 2020 2020 6c69 6b65 6c79 5f6c 6573  ).    likely_les
-00071890: 696f 6e20 3d20 616e 7473 2e73 6d6f 6f74  ion = ants.smoot
-000718a0: 685f 696d 6167 6528 206c 696b 656c 795f  h_image( likely_
-000718b0: 6c65 7369 6f6e 2c20 332e 3020 292e 694d  lesion, 3.0 ).iM
-000718c0: 6174 6828 224e 6f72 6d61 6c69 7a65 2229  ath("Normalize")
-000718d0: 0a20 2020 206c 6573 696f 6e6e 6567 203d  .    lesionneg =
-000718e0: 2028 2069 6d61 6765 6e2a 302b 312e 3020   ( imagen*0+1.0 
-000718f0: 2920 2d20 6c69 6b65 6c79 5f6c 6573 696f  ) - likely_lesio
-00071900: 6e0a 2020 2020 6669 6c6c 6564 5f69 6d61  n.    filled_ima
-00071910: 6765 203d 2061 6e74 732e 696d 6167 655f  ge = ants.image_
-00071920: 636c 6f6e 6528 696d 6167 656e 2920 2020  clone(imagen)   
-00071930: 200a 2020 2020 6669 6c6c 6564 5f69 6d61   .    filled_ima
-00071940: 6765 203d 2069 6d61 6765 6e20 2a20 6c65  ge = imagen * le
-00071950: 7369 6f6e 6e65 6720 2b20 6d69 7272 6f72  sionneg + mirror
-00071960: 5f69 6d61 6765 202a 206c 696b 656c 795f  _image * likely_
-00071970: 6c65 7369 6f6e 0a0a 2020 2020 7265 7475  lesion..    retu
-00071980: 726e 2066 696c 6c65 645f 696d 6167 652c  rn filled_image,
-00071990: 2064 6966 6673 6567 0a0a 0a0a 6465 6620   diffseg....def 
-000719a0: 6669 6c74 6572 5f69 6d61 6765 5f66 696c  filter_image_fil
-000719b0: 6573 2869 6d61 6765 5f70 6174 6873 2c20  es(image_paths, 
-000719c0: 6372 6974 6572 6961 3d27 6c61 7267 6573  criteria='larges
-000719d0: 7427 293a 0a20 2020 2022 2222 0a20 2020  t'):.    """.   
-000719e0: 2046 696c 7465 7273 2061 206c 6973 7420   Filters a list 
-000719f0: 6f66 2069 6d61 6765 2066 696c 6520 7061  of image file pa
-00071a00: 7468 7320 6261 7365 6420 6f6e 2073 7065  ths based on spe
-00071a10: 6369 6669 6564 2063 7269 7465 7269 6120  cified criteria 
-00071a20: 616e 6420 7265 7475 726e 7320 0a20 2020  and returns .   
-00071a30: 2074 6865 2070 6174 6820 6f66 2074 6865   the path of the
-00071a40: 2069 6d61 6765 2074 6861 7420 6265 7374   image that best
-00071a50: 206d 6174 6368 6573 2074 6861 7420 6372   matches that cr
-00071a60: 6974 6572 6961 2028 736d 616c 6c65 7374  iteria (smallest
-00071a70: 2c20 6c61 7267 6573 742c 206f 7220 6272  , largest, or br
-00071a80: 6967 6874 6573 7429 2e0a 0a20 2020 2041  ightest)...    A
-00071a90: 7267 733a 0a20 2020 2069 6d61 6765 5f70  rgs:.    image_p
-00071aa0: 6174 6873 2028 6c69 7374 293a 2041 206c  aths (list): A l
-00071ab0: 6973 7420 6f66 2066 696c 6520 7061 7468  ist of file path
-00071ac0: 7320 746f 2074 6865 2069 6d61 6765 732e  s to the images.
-00071ad0: 0a20 2020 2063 7269 7465 7269 6120 2873  .    criteria (s
-00071ae0: 7472 293a 2043 7269 7465 7269 6120 666f  tr): Criteria fo
-00071af0: 7220 7365 6c65 6374 696e 6720 7468 6520  r selecting the 
-00071b00: 696d 6167 6520 2827 736d 616c 6c65 7374  image ('smallest
-00071b10: 272c 2027 6c61 7267 6573 7427 2c20 2762  ', 'largest', 'b
-00071b20: 7269 6768 7465 7374 2729 2e0a 0a20 2020  rightest')...   
-00071b30: 2052 6574 7572 6e73 3a0a 2020 2020 7374   Returns:.    st
-00071b40: 723a 2054 6865 2066 696c 6520 7061 7468  r: The file path
-00071b50: 206f 6620 7468 6520 7365 6c65 6374 6564   of the selected
-00071b60: 2069 6d61 6765 2c20 6f72 204e 6f6e 6520   image, or None 
-00071b70: 6966 206e 6f20 7661 6c69 6420 696d 6167  if no valid imag
-00071b80: 6573 2061 7265 2066 6f75 6e64 2e0a 2020  es are found..  
-00071b90: 2020 2222 220a 2020 2020 696d 706f 7274    """.    import
-00071ba0: 206e 756d 7079 2061 7320 6e70 0a20 2020   numpy as np.   
-00071bb0: 2069 6620 6e6f 7420 696d 6167 655f 7061   if not image_pa
-00071bc0: 7468 733a 0a20 2020 2020 2020 2072 6574  ths:.        ret
-00071bd0: 7572 6e20 4e6f 6e65 0a0a 2020 2020 7365  urn None..    se
-00071be0: 6c65 6374 6564 5f69 6d61 6765 5f70 6174  lected_image_pat
-00071bf0: 6820 3d20 4e6f 6e65 0a20 2020 2069 6620  h = None.    if 
-00071c00: 6372 6974 6572 6961 203d 3d20 2773 6d61  criteria == 'sma
-00071c10: 6c6c 6573 7427 206f 7220 6372 6974 6572  llest' or criter
-00071c20: 6961 203d 3d20 276c 6172 6765 7374 273a  ia == 'largest':
-00071c30: 0a20 2020 2020 2020 2065 7874 7265 6d65  .        extreme
-00071c40: 5f76 6f6c 756d 6520 3d20 4e6f 6e65 0a0a  _volume = None..
-00071c50: 2020 2020 2020 2020 666f 7220 7061 7468          for path
-00071c60: 2069 6e20 696d 6167 655f 7061 7468 733a   in image_paths:
-00071c70: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-00071c80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00071c90: 2020 696d 6167 6520 3d20 616e 7473 2e69    image = ants.i
-00071ca0: 6d61 6765 5f72 6561 6428 7061 7468 290a  mage_read(path).
-00071cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00071cc0: 766f 6c75 6d65 203d 206e 702e 7072 6f64  volume = np.prod
-00071cd0: 2869 6d61 6765 2e73 6861 7065 290a 0a20  (image.shape).. 
-00071ce0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00071cf0: 6620 6372 6974 6572 6961 203d 3d20 276c  f criteria == 'l
-00071d00: 6172 6765 7374 273a 0a20 2020 2020 2020  argest':.       
-00071d10: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00071d20: 6578 7472 656d 655f 766f 6c75 6d65 2069  extreme_volume i
-00071d30: 7320 4e6f 6e65 206f 7220 766f 6c75 6d65  s None or volume
-00071d40: 203e 2065 7874 7265 6d65 5f76 6f6c 756d   > extreme_volum
-00071d50: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00071d60: 2020 2020 2020 2020 2020 2065 7874 7265             extre
-00071d70: 6d65 5f76 6f6c 756d 6520 3d20 766f 6c75  me_volume = volu
-00071d80: 6d65 0a20 2020 2020 2020 2020 2020 2020  me.             
-00071d90: 2020 2020 2020 2020 2020 2073 656c 6563             selec
-00071da0: 7465 645f 696d 6167 655f 7061 7468 203d  ted_image_path =
-00071db0: 2070 6174 680a 2020 2020 2020 2020 2020   path.          
-00071dc0: 2020 2020 2020 656c 6966 2063 7269 7465        elif crite
-00071dd0: 7269 6120 3d3d 2027 736d 616c 6c65 7374  ria == 'smallest
-00071de0: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
-00071df0: 2020 2020 2020 2069 6620 6578 7472 656d         if extrem
-00071e00: 655f 766f 6c75 6d65 2069 7320 4e6f 6e65  e_volume is None
-00071e10: 206f 7220 766f 6c75 6d65 203c 2065 7874   or volume < ext
-00071e20: 7265 6d65 5f76 6f6c 756d 653a 0a20 2020  reme_volume:.   
-00071e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00071e40: 2020 2020 2065 7874 7265 6d65 5f76 6f6c       extreme_vol
-00071e50: 756d 6520 3d20 766f 6c75 6d65 0a20 2020  ume = volume.   
-00071e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00071e70: 2020 2020 2073 656c 6563 7465 645f 696d       selected_im
-00071e80: 6167 655f 7061 7468 203d 2070 6174 680a  age_path = path.
-00071e90: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-00071ea0: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-00071eb0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00071ec0: 2020 2020 7072 696e 7428 6622 4572 726f      print(f"Erro
-00071ed0: 7220 7072 6f63 6573 7369 6e67 2069 6d61  r processing ima
-00071ee0: 6765 207b 7061 7468 7d3a 207b 657d 2229  ge {path}: {e}")
-00071ef0: 0a0a 2020 2020 656c 6966 2063 7269 7465  ..    elif crite
-00071f00: 7269 6120 3d3d 2027 6272 6967 6874 6573  ria == 'brightes
-00071f10: 7427 3a0a 2020 2020 2020 2020 6d61 785f  t':.        max_
-00071f20: 6272 6967 6874 6e65 7373 203d 204e 6f6e  brightness = Non
-00071f30: 650a 0a20 2020 2020 2020 2066 6f72 2070  e..        for p
-00071f40: 6174 6820 696e 2069 6d61 6765 5f70 6174  ath in image_pat
-00071f50: 6873 3a0a 2020 2020 2020 2020 2020 2020  hs:.            
-00071f60: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00071f70: 2020 2020 2069 6d61 6765 203d 2061 6e74       image = ant
-00071f80: 732e 696d 6167 655f 7265 6164 2870 6174  s.image_read(pat
-00071f90: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-00071fa0: 2020 2062 7269 6768 746e 6573 7320 3d20     brightness = 
-00071fb0: 6e70 2e6d 6561 6e28 696d 6167 652e 6e75  np.mean(image.nu
-00071fc0: 6d70 7928 2929 0a0a 2020 2020 2020 2020  mpy())..        
-00071fd0: 2020 2020 2020 2020 6966 206d 6178 5f62          if max_b
-00071fe0: 7269 6768 746e 6573 7320 6973 204e 6f6e  rightness is Non
-00071ff0: 6520 6f72 2062 7269 6768 746e 6573 7320  e or brightness 
-00072000: 3e20 6d61 785f 6272 6967 6874 6e65 7373  > max_brightness
-00072010: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00072020: 2020 2020 2020 6d61 785f 6272 6967 6874        max_bright
-00072030: 6e65 7373 203d 2062 7269 6768 746e 6573  ness = brightnes
-00072040: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00072050: 2020 2020 2020 7365 6c65 6374 6564 5f69        selected_i
-00072060: 6d61 6765 5f70 6174 6820 3d20 7061 7468  mage_path = path
-00072070: 0a0a 2020 2020 2020 2020 2020 2020 6578  ..            ex
-00072080: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
-00072090: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-000720a0: 2020 2020 2070 7269 6e74 2866 2245 7272       print(f"Err
-000720b0: 6f72 2070 726f 6365 7373 696e 6720 696d  or processing im
-000720c0: 6167 6520 7b70 6174 687d 3a20 7b65 7d22  age {path}: {e}"
-000720d0: 290a 0a20 2020 2065 6c73 653a 0a20 2020  )..    else:.   
-000720e0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-000720f0: 4572 726f 7228 2243 7269 7465 7269 6120  Error("Criteria 
-00072100: 6d75 7374 2062 6520 2773 6d61 6c6c 6573  must be 'smalles
-00072110: 7427 2c20 276c 6172 6765 7374 272c 206f  t', 'largest', o
-00072120: 7220 2762 7269 6768 7465 7374 272e 2229  r 'brightest'.")
-00072130: 0a0a 2020 2020 7265 7475 726e 2073 656c  ..    return sel
-00072140: 6563 7465 645f 696d 6167 655f 7061 7468  ected_image_path
-00072150: 0a0a 0a0a 6465 6620 6d6d 5f6d 6174 6368  ....def mm_match
-00072160: 5f62 795f 7163 5f73 636f 7269 6e67 2864  _by_qc_scoring(d
-00072170: 665f 612c 2064 665f 622c 206d 6174 6368  f_a, df_b, match
-00072180: 5f63 6f6c 756d 6e2c 2063 7269 7465 7269  _column, criteri
-00072190: 612c 2070 7265 6669 783d 276d 6174 6368  a, prefix='match
-000721a0: 6564 5f27 2c20 6578 636c 7564 655f 636f  ed_', exclude_co
-000721b0: 6c75 6d6e 733d 4e6f 6e65 293a 0a20 2020  lumns=None):.   
-000721c0: 2022 2222 0a20 2020 204d 6174 6368 2065   """.    Match e
-000721d0: 6163 6820 726f 7720 696e 2064 665f 6120  ach row in df_a 
-000721e0: 746f 2061 2072 6f77 2069 6e20 6466 5f62  to a row in df_b
-000721f0: 2062 6173 6564 206f 6e20 6120 6d61 7463   based on a matc
-00072200: 6869 6e67 2063 6f6c 756d 6e20 616e 6420  hing column and 
-00072210: 6372 6974 6572 6961 2066 6f72 2073 656c  criteria for sel
-00072220: 6563 7469 6e67 2074 6865 2062 6573 7420  ecting the best 
-00072230: 6d61 7463 682c 0a20 2020 2077 6974 6820  match,.    with 
-00072240: 6f70 7469 6f6e 7320 746f 2070 7265 6669  options to prefi
-00072250: 7820 636f 6c75 6d6e 206e 616d 6573 2066  x column names f
-00072260: 726f 6d20 6466 5f62 2061 6e64 2065 7863  rom df_b and exc
-00072270: 6c75 6465 2063 6572 7461 696e 2063 6f6c  lude certain col
-00072280: 756d 6e73 2066 726f 6d20 7468 6520 6669  umns from the fi
-00072290: 6e61 6c20 6f75 7470 7574 2e20 4164 6469  nal output. Addi
-000722a0: 7469 6f6e 616c 6c79 2c0a 2020 2020 7265  tionally,.    re
-000722b0: 7475 726e 7320 6120 4461 7461 4672 616d  turns a DataFram
-000722c0: 6520 636f 6e74 6169 6e69 6e67 2072 6f77  e containing row
-000722d0: 7320 6672 6f6d 2064 665f 6220 7468 6174  s from df_b that
-000722e0: 2077 6572 6520 6e6f 7420 6d61 7463 6865   were not matche
-000722f0: 6420 746f 2061 6e79 2072 6f77 2069 6e20  d to any row in 
-00072300: 6466 5f61 2e0a 0a20 2020 2050 6172 616d  df_a...    Param
-00072310: 6574 6572 733a 0a20 2020 202d 2064 665f  eters:.    - df_
-00072320: 613a 2044 6174 6146 7261 6d65 2041 2e0a  a: DataFrame A..
-00072330: 2020 2020 2d20 6466 5f62 3a20 4461 7461      - df_b: Data
-00072340: 4672 616d 6520 422e 0a20 2020 202d 206d  Frame B..    - m
-00072350: 6174 6368 5f63 6f6c 756d 6e3a 2054 6865  atch_column: The
-00072360: 2063 6f6c 756d 6e20 6e61 6d65 206f 6e20   column name on 
-00072370: 7768 6963 6820 726f 7773 2073 686f 756c  which rows shoul
-00072380: 6420 6d61 7463 6820 6265 7477 6565 6e20  d match between 
-00072390: 4461 7461 4672 616d 6520 4120 616e 6420  DataFrame A and 
-000723a0: 422e 0a20 2020 202d 2063 7269 7465 7269  B..    - criteri
-000723b0: 613a 2041 2064 6963 7469 6f6e 6172 7920  a: A dictionary 
-000723c0: 7768 6572 6520 6b65 7973 2061 7265 2063  where keys are c
-000723d0: 6f6c 756d 6e20 6e61 6d65 7320 616e 6420  olumn names and 
-000723e0: 7661 6c75 6573 2061 7265 2027 6d69 6e27  values are 'min'
-000723f0: 206f 7220 276d 6178 272c 2069 6e64 6963   or 'max', indic
-00072400: 6174 696e 6720 7768 6574 6865 720a 2020  ating whether.  
-00072410: 2020 2020 2020 2020 2020 2020 2020 7468                th
-00072420: 6520 636f 6c75 6d6e 2073 686f 756c 6420  e column should 
-00072430: 6265 206d 696e 696d 697a 6564 206f 7220  be minimized or 
-00072440: 6d61 7869 6d69 7a65 6420 666f 7220 7468  maximized for th
-00072450: 6520 6265 7374 206d 6174 6368 2e0a 2020  e best match..  
-00072460: 2020 2d20 7072 6566 6978 3a20 4120 7374    - prefix: A st
-00072470: 7269 6e67 2070 7265 6669 7820 746f 2061  ring prefix to a
-00072480: 6464 2074 6f20 636f 6c75 6d6e 206e 616d  dd to column nam
-00072490: 6573 2066 726f 6d20 6466 5f62 2069 6e20  es from df_b in 
-000724a0: 7468 6520 6669 6e61 6c20 6f75 7470 7574  the final output
-000724b0: 2074 6f20 6176 6f69 6420 6475 706c 6963   to avoid duplic
-000724c0: 6174 696f 6e2e 0a20 2020 202d 2065 7863  ation..    - exc
-000724d0: 6c75 6465 5f63 6f6c 756d 6e73 3a20 4120  lude_columns: A 
-000724e0: 6c69 7374 206f 6620 636f 6c75 6d6e 206e  list of column n
-000724f0: 616d 6573 2066 726f 6d20 6466 5f62 2074  ames from df_b t
-00072500: 6f20 6578 636c 7564 6520 6672 6f6d 2074  o exclude from t
-00072510: 6865 2066 696e 616c 206f 7574 7075 742e  he final output.
-00072520: 0a20 2020 200a 2020 2020 5265 7475 726e  .    .    Return
-00072530: 733a 0a20 2020 202d 2041 2074 7570 6c65  s:.    - A tuple
-00072540: 206f 6620 7477 6f20 4461 7461 4672 616d   of two DataFram
-00072550: 6573 3a20 0a20 2020 2020 2020 2031 2e20  es: .        1. 
-00072560: 4120 6e65 7720 4461 7461 4672 616d 6520  A new DataFrame 
-00072570: 636f 6d62 696e 696e 6720 6466 5f61 2077  combining df_a w
-00072580: 6974 6820 6d61 7463 6865 6420 726f 7773  ith matched rows
-00072590: 2066 726f 6d20 6466 5f62 2e0a 2020 2020   from df_b..    
-000725a0: 2020 2020 322e 2041 2044 6174 6146 7261      2. A DataFra
-000725b0: 6d65 2063 6f6e 7461 696e 696e 6720 726f  me containing ro
-000725c0: 7773 2066 726f 6d20 6466 5f62 2074 6861  ws from df_b tha
-000725d0: 7420 7765 7265 206e 6f74 206d 6174 6368  t were not match
-000725e0: 6564 2074 6f20 6466 5f61 2e0a 2020 2020  ed to df_a..    
-000725f0: 2222 220a 2020 2020 6672 6f6d 2073 6369  """.    from sci
-00072600: 7079 2e73 7461 7473 2069 6d70 6f72 7420  py.stats import 
-00072610: 7a73 636f 7265 0a20 2020 2064 665f 6120  zscore.    df_a 
-00072620: 3d20 6466 5f61 2e6c 6f63 5b3a 2c20 7e64  = df_a.loc[:, ~d
-00072630: 665f 612e 636f 6c75 6d6e 732e 7374 722e  f_a.columns.str.
-00072640: 7374 6172 7473 7769 7468 2827 556e 6e61  startswith('Unna
-00072650: 6d65 643a 2729 5d2e 636f 7079 2829 0a20  med:')].copy(). 
-00072660: 2020 2069 6620 6466 5f62 2069 7320 6e6f     if df_b is no
-00072670: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00072680: 6466 5f62 203d 2064 665f 622e 6c6f 635b  df_b = df_b.loc[
-00072690: 3a2c 207e 6466 5f62 2e63 6f6c 756d 6e73  :, ~df_b.columns
-000726a0: 2e73 7472 2e73 7461 7274 7377 6974 6828  .str.startswith(
-000726b0: 2755 6e6e 616d 6564 3a27 295d 2e63 6f70  'Unnamed:')].cop
-000726c0: 7928 290a 2020 2020 656c 7365 3a0a 2020  y().    else:.  
-000726d0: 2020 2020 2020 7265 7475 726e 2064 665f        return df_
-000726e0: 612c 2070 642e 4461 7461 4672 616d 6528  a, pd.DataFrame(
-000726f0: 290a 2020 2020 0a20 2020 2023 204e 6f72  ).    .    # Nor
-00072700: 6d61 6c69 7a65 2064 665f 6220 6261 7365  malize df_b base
-00072710: 6420 6f6e 2063 7269 7465 7269 610a 2020  d on criteria.  
-00072720: 2020 666f 7220 636f 6c2c 2063 7269 7420    for col, crit 
-00072730: 696e 2063 7269 7465 7269 612e 6974 656d  in criteria.item
-00072740: 7328 293a 0a20 2020 2020 2020 2069 6620  s():.        if 
-00072750: 6372 6974 203d 3d20 276d 6178 273a 0a20  crit == 'max':. 
-00072760: 2020 2020 2020 2020 2020 2064 665f 622e             df_b.
-00072770: 6c6f 635b 6466 5f62 2e69 6e64 6578 2c20  loc[df_b.index, 
-00072780: 6627 7363 6f72 655f 7b63 6f6c 7d27 5d20  f'score_{col}'] 
-00072790: 3d20 7a73 636f 7265 282d 6466 5f62 5b63  = zscore(-df_b[c
-000727a0: 6f6c 5d29 0a20 2020 2020 2020 2065 6c69  ol]).        eli
-000727b0: 6620 6372 6974 203d 3d20 276d 696e 273a  f crit == 'min':
-000727c0: 0a20 2020 2020 2020 2020 2020 2064 665f  .            df_
-000727d0: 622e 6c6f 635b 6466 5f62 2e69 6e64 6578  b.loc[df_b.index
-000727e0: 2c20 6627 7363 6f72 655f 7b63 6f6c 7d27  , f'score_{col}'
-000727f0: 5d20 3d20 7a73 636f 7265 2864 665f 625b  ] = zscore(df_b[
-00072800: 636f 6c5d 290a 0a20 2020 2023 2043 616c  col])..    # Cal
-00072810: 6375 6c61 7465 2027 6265 7374 5f73 636f  culate 'best_sco
-00072820: 7265 2720 6279 2073 756d 6d69 6e67 2061  re' by summing a
-00072830: 6c6c 2073 636f 7265 2063 6f6c 756d 6e73  ll score columns
-00072840: 0a20 2020 2073 636f 7265 5f63 6f6c 756d  .    score_colum
-00072850: 6e73 203d 205b 6627 7363 6f72 655f 7b63  ns = [f'score_{c
-00072860: 6f6c 7d27 2066 6f72 2063 6f6c 2069 6e20  ol}' for col in 
-00072870: 6372 6974 6572 6961 2e6b 6579 7328 295d  criteria.keys()]
-00072880: 0a20 2020 2064 665f 625b 2762 6573 745f  .    df_b['best_
-00072890: 7363 6f72 6527 5d20 3d20 6466 5f62 5b73  score'] = df_b[s
-000728a0: 636f 7265 5f63 6f6c 756d 6e73 5d2e 7375  core_columns].su
-000728b0: 6d28 6178 6973 3d31 290a 0a20 2020 206d  m(axis=1)..    m
-000728c0: 6174 6368 6564 5f69 6e64 6963 6573 203d  atched_indices =
-000728d0: 205b 5d20 2023 2054 7261 636b 2069 6e64   []  # Track ind
-000728e0: 6963 6573 206f 6620 6d61 7463 6865 6420  ices of matched 
-000728f0: 726f 7773 2069 6e20 6466 5f62 0a0a 2020  rows in df_b..  
-00072900: 2020 2320 4d61 7463 6820 726f 7773 0a20    # Match rows. 
-00072910: 2020 206d 6174 6368 6564 5f72 6f77 7320     matched_rows 
-00072920: 3d20 5b5d 0a20 2020 2066 6f72 205f 2c20  = [].    for _, 
-00072930: 726f 775f 6120 696e 2064 665f 612e 6974  row_a in df_a.it
-00072940: 6572 726f 7773 2829 3a0a 2020 2020 2020  errows():.      
-00072950: 2020 6d61 7463 6865 7320 3d20 6466 5f62    matches = df_b
-00072960: 5b64 665f 625b 6d61 7463 685f 636f 6c75  [df_b[match_colu
-00072970: 6d6e 5d20 3d3d 2072 6f77 5f61 5b6d 6174  mn] == row_a[mat
-00072980: 6368 5f63 6f6c 756d 6e5d 5d0a 2020 2020  ch_column]].    
-00072990: 2020 2020 6966 206e 6f74 206d 6174 6368      if not match
-000729a0: 6573 2e65 6d70 7479 3a0a 2020 2020 2020  es.empty:.      
-000729b0: 2020 2020 2020 6265 7374 5f69 6478 203d        best_idx =
-000729c0: 206d 6174 6368 6573 5b27 6265 7374 5f73   matches['best_s
-000729d0: 636f 7265 275d 2e69 6478 6d69 6e28 290a  core'].idxmin().
-000729e0: 2020 2020 2020 2020 2020 2020 6265 7374              best
-000729f0: 5f6d 6174 6368 203d 206d 6174 6368 6573  _match = matches
-00072a00: 2e6c 6f63 5b62 6573 745f 6964 785d 0a20  .loc[best_idx]. 
-00072a10: 2020 2020 2020 2020 2020 206d 6174 6368             match
-00072a20: 6564 5f69 6e64 6963 6573 2e61 7070 656e  ed_indices.appen
-00072a30: 6428 6265 7374 5f69 6478 2920 2023 2054  d(best_idx)  # T
-00072a40: 7261 636b 2074 6869 7320 696e 6465 7820  rack this index 
-00072a50: 6173 206d 6174 6368 6564 0a20 2020 2020  as matched.     
-00072a60: 2020 2020 2020 206d 6174 6368 6564 5f72         matched_r
-00072a70: 6f77 732e 6170 7065 6e64 2862 6573 745f  ows.append(best_
-00072a80: 6d61 7463 6829 0a20 2020 2020 2020 2065  match).        e
-00072a90: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00072aa0: 206d 6174 6368 6564 5f72 6f77 732e 6170   matched_rows.ap
-00072ab0: 7065 6e64 2870 642e 5365 7269 6573 2864  pend(pd.Series(d
-00072ac0: 7479 7065 3d27 666c 6f61 7436 3427 2929  type='float64'))
-00072ad0: 0a0a 2020 2020 2320 4372 6561 7465 2061  ..    # Create a
-00072ae0: 2044 6174 6146 7261 6d65 2066 726f 6d20   DataFrame from 
-00072af0: 6d61 7463 6865 6420 726f 7773 0a20 2020  matched rows.   
-00072b00: 2064 665f 6d61 7463 6865 6420 3d20 7064   df_matched = pd
-00072b10: 2e44 6174 6146 7261 6d65 286d 6174 6368  .DataFrame(match
-00072b20: 6564 5f72 6f77 7329 2e72 6573 6574 5f69  ed_rows).reset_i
-00072b30: 6e64 6578 2864 726f 703d 5472 7565 290a  ndex(drop=True).
-00072b40: 2020 2020 0a20 2020 2023 2045 7863 6c75      .    # Exclu
-00072b50: 6465 2073 7065 6369 6669 6564 2063 6f6c  de specified col
-00072b60: 756d 6e73 2061 6e64 2061 6464 2070 7265  umns and add pre
-00072b70: 6669 780a 2020 2020 6966 2065 7863 6c75  fix.    if exclu
-00072b80: 6465 5f63 6f6c 756d 6e73 2069 7320 6e6f  de_columns is no
-00072b90: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00072ba0: 6466 5f6d 6174 6368 6564 203d 2064 665f  df_matched = df_
-00072bb0: 6d61 7463 6865 642e 6472 6f70 2863 6f6c  matched.drop(col
-00072bc0: 756d 6e73 3d65 7863 6c75 6465 5f63 6f6c  umns=exclude_col
-00072bd0: 756d 6e73 2c20 6572 726f 7273 3d27 6967  umns, errors='ig
-00072be0: 6e6f 7265 2729 0a20 2020 2064 665f 6d61  nore').    df_ma
-00072bf0: 7463 6865 6420 3d20 6466 5f6d 6174 6368  tched = df_match
-00072c00: 6564 2e72 656e 616d 6528 636f 6c75 6d6e  ed.rename(column
-00072c10: 733d 6c61 6d62 6461 2078 3a20 6622 7b70  s=lambda x: f"{p
-00072c20: 7265 6669 787d 7b78 7d22 2069 6620 7820  refix}{x}" if x 
-00072c30: 213d 206d 6174 6368 5f63 6f6c 756d 6e20  != match_column 
-00072c40: 616e 6420 7820 696e 2064 665f 6d61 7463  and x in df_matc
-00072c50: 6865 642e 636f 6c75 6d6e 7320 656c 7365  hed.columns else
-00072c60: 2078 290a 0a20 2020 2023 2043 6f6d 6269   x)..    # Combi
-00072c70: 6e65 2064 665f 6120 7769 7468 206d 6174  ne df_a with mat
-00072c80: 6368 6564 2072 6f77 7320 6672 6f6d 2064  ched rows from d
-00072c90: 665f 620a 2020 2020 7265 7375 6c74 5f64  f_b.    result_d
-00072ca0: 6620 3d20 7064 2e63 6f6e 6361 7428 5b64  f = pd.concat([d
-00072cb0: 665f 612e 7265 7365 745f 696e 6465 7828  f_a.reset_index(
-00072cc0: 6472 6f70 3d54 7275 6529 2c20 6466 5f6d  drop=True), df_m
-00072cd0: 6174 6368 6564 5d2c 2061 7869 733d 3129  atched], axis=1)
-00072ce0: 0a20 2020 200a 2020 2020 2320 4578 7472  .    .    # Extr
-00072cf0: 6163 7420 756e 6d61 7463 6865 6420 726f  act unmatched ro
-00072d00: 7773 2066 726f 6d20 6466 5f62 0a20 2020  ws from df_b.   
-00072d10: 2075 6e6d 6174 6368 6564 5f64 665f 6220   unmatched_df_b 
-00072d20: 3d20 6466 5f62 2e64 726f 7028 696e 6465  = df_b.drop(inde
-00072d30: 783d 6d61 7463 6865 645f 696e 6469 6365  x=matched_indice
-00072d40: 7329 2e72 6573 6574 5f69 6e64 6578 2864  s).reset_index(d
-00072d50: 726f 703d 5472 7565 290a 0a20 2020 2072  rop=True)..    r
-00072d60: 6574 7572 6e20 7265 7375 6c74 5f64 662c  eturn result_df,
-00072d70: 2075 6e6d 6174 6368 6564 5f64 665f 620a   unmatched_df_b.
-00072d80: 0a0a 6465 6620 6669 785f 4c52 5f52 4c5f  ..def fix_LR_RL_
-00072d90: 7374 7566 6628 6466 2c20 636f 6c31 2c20  stuff(df, col1, 
-00072da0: 636f 6c32 2c20 7369 7a65 5f63 6f6c 312c  col2, size_col1,
-00072db0: 2073 697a 655f 636f 6c32 2c20 6964 312c   size_col2, id1,
-00072dc0: 2069 6432 2029 3a0a 2020 2020 6466 5f63   id2 ):.    df_c
-00072dd0: 6f70 7920 3d20 6466 2e63 6f70 7928 290a  opy = df.copy().
-00072de0: 2020 2020 2320 456e 7375 7265 2063 6f6c      # Ensure col
-00072df0: 756d 6e73 2063 6f6e 7461 696e 2073 7472  umns contain str
-00072e00: 696e 6773 2066 6f72 2073 7562 7374 7269  ings for substri
-00072e10: 6e67 2063 6865 636b 730a 2020 2020 6466  ng checks.    df
-00072e20: 5f63 6f70 795b 636f 6c31 5d20 3d20 6466  _copy[col1] = df
-00072e30: 5f63 6f70 795b 636f 6c31 5d2e 6173 7479  _copy[col1].asty
-00072e40: 7065 2873 7472 290a 2020 2020 6466 5f63  pe(str).    df_c
-00072e50: 6f70 795b 636f 6c32 5d20 3d20 6466 5f63  opy[col2] = df_c
-00072e60: 6f70 795b 636f 6c32 5d2e 6173 7479 7065  opy[col2].astype
-00072e70: 2873 7472 290a 2020 2020 6466 5f63 6f70  (str).    df_cop
-00072e80: 795b 6964 315d 203d 2064 665f 636f 7079  y[id1] = df_copy
-00072e90: 5b69 6431 5d2e 6173 7479 7065 2873 7472  [id1].astype(str
-00072ea0: 290a 2020 2020 6466 5f63 6f70 795b 6964  ).    df_copy[id
-00072eb0: 325d 203d 2064 665f 636f 7079 5b69 6432  2] = df_copy[id2
-00072ec0: 5d2e 6173 7479 7065 2873 7472 290a 2020  ].astype(str).  
-00072ed0: 2020 0a20 2020 2066 6f72 2069 6e64 6578    .    for index
-00072ee0: 2c20 726f 7720 696e 2064 665f 636f 7079  , row in df_copy
-00072ef0: 2e69 7465 7272 6f77 7328 293a 0a20 2020  .iterrows():.   
-00072f00: 2020 2020 2063 6f6c 315f 7661 6c20 3d20       col1_val = 
-00072f10: 726f 775b 636f 6c31 5d0a 2020 2020 2020  row[col1].      
-00072f20: 2020 636f 6c32 5f76 616c 203d 2072 6f77    col2_val = row
-00072f30: 5b63 6f6c 325d 0a20 2020 2020 2020 2073  [col2].        s
-00072f40: 697a 6531 203d 2072 6f77 5b73 697a 655f  ize1 = row[size_
-00072f50: 636f 6c31 5d0a 2020 2020 2020 2020 7369  col1].        si
-00072f60: 7a65 3220 3d20 726f 775b 7369 7a65 5f63  ze2 = row[size_c
-00072f70: 6f6c 325d 0a20 2020 2020 2020 200a 2020  ol2].        .  
-00072f80: 2020 2020 2020 2320 4368 6563 6b20 666f        # Check fo
-00072f90: 7220 2752 4c27 206f 7220 274c 5227 2069  r 'RL' or 'LR' i
-00072fa0: 6e20 6561 6368 2063 6f6c 756d 6e20 616e  n each column an
-00072fb0: 6420 636f 6d70 6172 6520 7369 7a65 730a  d compare sizes.
-00072fc0: 2020 2020 2020 2020 6966 2028 2752 4c27          if ('RL'
-00072fd0: 2069 6e20 636f 6c31 5f76 616c 206f 7220   in col1_val or 
-00072fe0: 274c 5227 2069 6e20 636f 6c31 5f76 616c  'LR' in col1_val
-00072ff0: 2920 616e 6420 2827 524c 2720 696e 2063  ) and ('RL' in c
-00073000: 6f6c 325f 7661 6c20 6f72 2027 4c52 2720  ol2_val or 'LR' 
-00073010: 696e 2063 6f6c 325f 7661 6c29 3a0a 2020  in col2_val):.  
-00073020: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-00073030: 7565 0a20 2020 2020 2020 2065 6c69 6620  ue.        elif 
-00073040: 2752 4c27 206e 6f74 2069 6e20 636f 6c31  'RL' not in col1
-00073050: 5f76 616c 2061 6e64 2027 4c52 2720 6e6f  _val and 'LR' no
-00073060: 7420 696e 2063 6f6c 315f 7661 6c20 616e  t in col1_val an
-00073070: 6420 2752 4c27 206e 6f74 2069 6e20 636f  d 'RL' not in co
-00073080: 6c32 5f76 616c 2061 6e64 2027 4c52 2720  l2_val and 'LR' 
-00073090: 6e6f 7420 696e 2063 6f6c 325f 7661 6c3a  not in col2_val:
-000730a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000730b0: 7369 7a65 3120 3c20 7369 7a65 323a 0a20  size1 < size2:. 
-000730c0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000730d0: 665f 636f 7079 2e61 745b 696e 6465 782c  f_copy.at[index,
-000730e0: 2063 6f6c 315d 203d 2064 665f 636f 7079   col1] = df_copy
-000730f0: 2e61 745b 696e 6465 782c 2063 6f6c 325d  .at[index, col2]
-00073100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00073110: 2064 665f 636f 7079 2e61 745b 696e 6465   df_copy.at[inde
-00073120: 782c 2073 697a 655f 636f 6c31 5d20 3d20  x, size_col1] = 
-00073130: 6466 5f63 6f70 792e 6174 5b69 6e64 6578  df_copy.at[index
-00073140: 2c20 7369 7a65 5f63 6f6c 325d 0a20 2020  , size_col2].   
-00073150: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00073160: 636f 7079 2e61 745b 696e 6465 782c 2069  copy.at[index, i
-00073170: 6431 5d20 3d20 6466 5f63 6f70 792e 6174  d1] = df_copy.at
-00073180: 5b69 6e64 6578 2c20 6964 325d 0a20 2020  [index, id2].   
-00073190: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-000731a0: 636f 7079 2e61 745b 696e 6465 782c 2073  copy.at[index, s
-000731b0: 697a 655f 636f 6c32 5d20 3d20 300a 2020  ize_col2] = 0.  
-000731c0: 2020 2020 2020 2020 2020 2020 2020 6466                df
-000731d0: 5f63 6f70 792e 6174 5b69 6e64 6578 2c20  _copy.at[index, 
-000731e0: 636f 6c32 5d20 3d20 4e6f 6e65 0a20 2020  col2] = None.   
-000731f0: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00073200: 636f 7079 2e61 745b 696e 6465 782c 2069  copy.at[index, i
-00073210: 6432 5d20 3d20 4e6f 6e65 0a20 2020 2020  d2] = None.     
-00073220: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00073230: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00073240: 636f 7079 2e61 745b 696e 6465 782c 2063  copy.at[index, c
-00073250: 6f6c 325d 203d 204e 6f6e 650a 2020 2020  ol2] = None.    
-00073260: 2020 2020 2020 2020 2020 2020 6466 5f63              df_c
-00073270: 6f70 792e 6174 5b69 6e64 6578 2c20 7369  opy.at[index, si
-00073280: 7a65 5f63 6f6c 325d 203d 2030 0a20 2020  ze_col2] = 0.   
-00073290: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-000732a0: 636f 7079 2e61 745b 696e 6465 782c 2069  copy.at[index, i
-000732b0: 6432 5d20 3d20 4e6f 6e65 0a20 2020 2020  d2] = None.     
-000732c0: 2020 2065 6c69 6620 2752 4c27 2069 6e20     elif 'RL' in 
-000732d0: 636f 6c31 5f76 616c 206f 7220 274c 5227  col1_val or 'LR'
-000732e0: 2069 6e20 636f 6c31 5f76 616c 3a0a 2020   in col1_val:.  
-000732f0: 2020 2020 2020 2020 2020 6966 2073 697a            if siz
-00073300: 6531 203c 2073 697a 6532 3a0a 2020 2020  e1 < size2:.    
-00073310: 2020 2020 2020 2020 2020 2020 6466 5f63              df_c
-00073320: 6f70 792e 6174 5b69 6e64 6578 2c20 636f  opy.at[index, co
-00073330: 6c31 5d20 3d20 6466 5f63 6f70 792e 6174  l1] = df_copy.at
-00073340: 5b69 6e64 6578 2c20 636f 6c32 5d0a 2020  [index, col2].  
-00073350: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00073360: 5f63 6f70 792e 6174 5b69 6e64 6578 2c20  _copy.at[index, 
-00073370: 6964 315d 203d 2064 665f 636f 7079 2e61  id1] = df_copy.a
-00073380: 745b 696e 6465 782c 2069 6432 5d0a 2020  t[index, id2].  
-00073390: 2020 2020 2020 2020 2020 2020 2020 6466                df
-000733a0: 5f63 6f70 792e 6174 5b69 6e64 6578 2c20  _copy.at[index, 
-000733b0: 7369 7a65 5f63 6f6c 315d 203d 2064 665f  size_col1] = df_
-000733c0: 636f 7079 2e61 745b 696e 6465 782c 2073  copy.at[index, s
-000733d0: 697a 655f 636f 6c32 5d0a 2020 2020 2020  ize_col2].      
-000733e0: 2020 2020 2020 2020 2020 6466 5f63 6f70            df_cop
-000733f0: 792e 6174 5b69 6e64 6578 2c20 7369 7a65  y.at[index, size
-00073400: 5f63 6f6c 325d 203d 2030 0a20 2020 2020  _col2] = 0.     
-00073410: 2020 2020 2020 2020 2020 2064 665f 636f             df_co
-00073420: 7079 2e61 745b 696e 6465 782c 2063 6f6c  py.at[index, col
-00073430: 325d 203d 204e 6f6e 650a 2020 2020 2020  2] = None.      
-00073440: 2020 2020 2020 2020 2020 6466 5f63 6f70            df_cop
-00073450: 792e 6174 5b69 6e64 6578 2c20 6964 325d  y.at[index, id2]
-00073460: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00073470: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00073480: 2020 2020 2020 2020 2020 6466 5f63 6f70            df_cop
-00073490: 792e 6174 5b69 6e64 6578 2c20 636f 6c32  y.at[index, col2
-000734a0: 5d20 3d20 4e6f 6e65 0a20 2020 2020 2020  ] = None.       
-000734b0: 2020 2020 2020 2020 2064 665f 636f 7079           df_copy
-000734c0: 2e61 745b 696e 6465 782c 2069 6432 5d20  .at[index, id2] 
-000734d0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-000734e0: 2020 2020 2020 2064 665f 636f 7079 2e61         df_copy.a
-000734f0: 745b 696e 6465 782c 2073 697a 655f 636f  t[index, size_co
-00073500: 6c32 5d20 3d20 300a 2020 2020 2020 2020  l2] = 0.        
-00073510: 656c 6966 2027 524c 2720 696e 2063 6f6c  elif 'RL' in col
-00073520: 325f 7661 6c20 6f72 2027 4c52 2720 696e  2_val or 'LR' in
-00073530: 2063 6f6c 325f 7661 6c3a 0a20 2020 2020   col2_val:.     
-00073540: 2020 2020 2020 2069 6620 7369 7a65 3220         if size2 
-00073550: 3c20 7369 7a65 313a 0a20 2020 2020 2020  < size1:.       
-00073560: 2020 2020 2020 2020 2064 665f 636f 7079           df_copy
-00073570: 2e61 745b 696e 6465 782c 2069 6432 5d20  .at[index, id2] 
-00073580: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-00073590: 2020 2020 2020 2064 665f 636f 7079 2e61         df_copy.a
-000735a0: 745b 696e 6465 782c 2063 6f6c 325d 203d  t[index, col2] =
-000735b0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-000735c0: 2020 2020 2020 6466 5f63 6f70 792e 6174        df_copy.at
-000735d0: 5b69 6e64 6578 2c20 7369 7a65 5f63 6f6c  [index, size_col
-000735e0: 325d 203d 2030 0a20 2020 2020 2020 2020  2] = 0.         
-000735f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00073600: 2020 2020 2020 2020 2064 665f 636f 7079           df_copy
-00073610: 2e61 745b 696e 6465 782c 2063 6f6c 315d  .at[index, col1]
-00073620: 203d 2064 665f 636f 7079 2e61 745b 696e   = df_copy.at[in
-00073630: 6465 782c 2063 6f6c 325d 0a20 2020 2020  dex, col2].     
-00073640: 2020 2020 2020 2020 2020 2064 665f 636f             df_co
-00073650: 7079 2e61 745b 696e 6465 782c 2069 6431  py.at[index, id1
-00073660: 5d20 3d20 6466 5f63 6f70 792e 6174 5b69  ] = df_copy.at[i
-00073670: 6e64 6578 2c20 6964 325d 0a20 2020 2020  ndex, id2].     
-00073680: 2020 2020 2020 2020 2020 2064 665f 636f             df_co
-00073690: 7079 2e61 745b 696e 6465 782c 2073 697a  py.at[index, siz
-000736a0: 655f 636f 6c31 5d20 3d20 6466 5f63 6f70  e_col1] = df_cop
-000736b0: 792e 6174 5b69 6e64 6578 2c20 7369 7a65  y.at[index, size
-000736c0: 5f63 6f6c 325d 0a20 2020 2020 2020 2020  _col2].         
-000736d0: 2020 2020 2020 2064 665f 636f 7079 2e61         df_copy.a
-000736e0: 745b 696e 6465 782c 2073 697a 655f 636f  t[index, size_co
-000736f0: 6c32 5d20 3d20 300a 2020 2020 2020 2020  l2] = 0.        
-00073700: 2020 2020 2020 2020 6466 5f63 6f70 792e          df_copy.
-00073710: 6174 5b69 6e64 6578 2c20 636f 6c32 5d20  at[index, col2] 
-00073720: 3d20 4e6f 6e65 2020 2020 0a20 2020 2020  = None    .     
-00073730: 2020 2020 2020 2020 2020 2064 665f 636f             df_co
-00073740: 7079 2e61 745b 696e 6465 782c 2069 6432  py.at[index, id2
-00073750: 5d20 3d20 4e6f 6e65 2020 2020 0a20 2020  ] = None    .   
-00073760: 2072 6574 7572 6e20 6466 5f63 6f70 790a   return df_copy.
-00073770: 0a0a 6465 6620 7265 6e61 6d65 6974 2864  ..def renameit(d
-00073780: 662c 206f 6c64 5f63 6f6c 5f6e 616d 652c  f, old_col_name,
-00073790: 206e 6577 5f63 6f6c 5f6e 616d 6529 3a0a   new_col_name):.
-000737a0: 2020 2020 2222 220a 2020 2020 5265 6e61      """.    Rena
-000737b0: 6d65 7320 6120 636f 6c75 6d6e 2069 6e20  mes a column in 
-000737c0: 6120 7061 6e64 6173 2044 6174 6146 7261  a pandas DataFra
-000737d0: 6d65 2069 6e20 706c 6163 652e 2052 6169  me in place. Rai
-000737e0: 7365 7320 616e 2065 7272 6f72 2069 6620  ses an error if 
-000737f0: 7468 6520 7370 6563 6966 6965 6420 6f6c  the specified ol
-00073800: 6420 636f 6c75 6d6e 206e 616d 6520 646f  d column name do
-00073810: 6573 206e 6f74 2065 7869 7374 2e0a 0a20  es not exist... 
-00073820: 2020 2050 6172 616d 6574 6572 733a 0a20     Parameters:. 
-00073830: 2020 202d 2064 663a 2070 616e 6461 732e     - df: pandas.
-00073840: 4461 7461 4672 616d 650a 2020 2020 2020  DataFrame.      
-00073850: 2020 5468 6520 4461 7461 4672 616d 6520    The DataFrame 
-00073860: 696e 2077 6869 6368 2074 6865 2063 6f6c  in which the col
-00073870: 756d 6e20 6973 2074 6f20 6265 2072 656e  umn is to be ren
-00073880: 616d 6564 2e0a 2020 2020 2d20 6f6c 645f  amed..    - old_
-00073890: 636f 6c5f 6e61 6d65 3a20 7374 720a 2020  col_name: str.  
-000738a0: 2020 2020 2020 5468 6520 6375 7272 656e        The curren
-000738b0: 7420 6e61 6d65 206f 6620 7468 6520 636f  t name of the co
-000738c0: 6c75 6d6e 2074 6f20 6265 2072 656e 616d  lumn to be renam
-000738d0: 6564 2e0a 2020 2020 2d20 6e65 775f 636f  ed..    - new_co
-000738e0: 6c5f 6e61 6d65 3a20 7374 720a 2020 2020  l_name: str.    
-000738f0: 2020 2020 5468 6520 6e65 7720 6e61 6d65      The new name
-00073900: 2066 6f72 2074 6865 2063 6f6c 756d 6e2e   for the column.
-00073910: 0a20 2020 200a 2020 2020 5261 6973 6573  .    .    Raises
-00073920: 3a0a 2020 2020 2d20 5661 6c75 6545 7272  :.    - ValueErr
-00073930: 6f72 3a20 4966 2074 6865 206f 6c64 2063  or: If the old c
-00073940: 6f6c 756d 6e20 6e61 6d65 2064 6f65 7320  olumn name does 
-00073950: 6e6f 7420 6578 6973 7420 696e 2074 6865  not exist in the
-00073960: 2044 6174 6146 7261 6d65 2e0a 2020 2020   DataFrame..    
-00073970: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-00073980: 2020 4e6f 6e65 0a20 2020 2022 2222 0a20    None.    """. 
-00073990: 2020 2069 6d70 6f72 7420 7761 726e 696e     import warnin
-000739a0: 6773 0a20 2020 2023 2043 6865 636b 2069  gs.    # Check i
-000739b0: 6620 7468 6520 6f6c 6420 636f 6c75 6d6e  f the old column
-000739c0: 206e 616d 6520 6578 6973 7473 2069 6e20   name exists in 
-000739d0: 7468 6520 4461 7461 4672 616d 650a 2020  the DataFrame.  
-000739e0: 2020 6966 206f 6c64 5f63 6f6c 5f6e 616d    if old_col_nam
-000739f0: 6520 6e6f 7420 696e 2064 662e 636f 6c75  e not in df.colu
-00073a00: 6d6e 733a 0a20 2020 2020 2020 2077 6172  mns:.        war
-00073a10: 6e69 6e67 732e 7761 726e 2866 2254 6865  nings.warn(f"The
-00073a20: 2063 6f6c 756d 6e20 277b 6f6c 645f 636f   column '{old_co
-00073a30: 6c5f 6e61 6d65 7d27 2064 6f65 7320 6e6f  l_name}' does no
-00073a40: 7420 6578 6973 7420 696e 2074 6865 2044  t exist in the D
-00073a50: 6174 6146 7261 6d65 2e22 290a 2020 2020  ataFrame.").    
-00073a60: 2020 2020 7265 7475 726e 0a20 2020 200a      return.    .
-00073a70: 2020 2020 2320 5072 6f63 6565 6420 7769      # Proceed wi
-00073a80: 7468 2072 656e 616d 696e 6720 7468 6520  th renaming the 
-00073a90: 636f 6c75 6d6e 2069 6620 6974 2065 7869  column if it exi
-00073aa0: 7374 730a 2020 2020 6466 2e72 656e 616d  sts.    df.renam
-00073ab0: 6528 636f 6c75 6d6e 733d 7b6f 6c64 5f63  e(columns={old_c
-00073ac0: 6f6c 5f6e 616d 653a 206e 6577 5f63 6f6c  ol_name: new_col
-00073ad0: 5f6e 616d 657d 2c20 696e 706c 6163 653d  _name}, inplace=
-00073ae0: 5472 7565 290a 0a0a 6465 6620 6d6d 5f6d  True)...def mm_m
-00073af0: 6174 6368 5f62 795f 7163 5f73 636f 7269  atch_by_qc_scori
-00073b00: 6e67 5f61 6c6c 2820 7163 5f64 6174 6166  ng_all( qc_dataf
-00073b10: 7261 6d65 2c20 6669 785f 4c52 524c 3d54  rame, fix_LRRL=T
-00073b20: 7275 652c 2076 6572 626f 7365 3d54 7275  rue, verbose=Tru
-00073b30: 6520 293a 0a20 2020 2022 2222 0a20 2020  e ):.    """.   
-00073b40: 2050 726f 6365 7373 6573 2061 2071 7561   Processes a qua
-00073b50: 6c69 7479 2063 6f6e 7472 6f6c 2028 5143  lity control (QC
-00073b60: 2920 4461 7461 4672 616d 6520 746f 2070  ) DataFrame to p
-00073b70: 6572 666f 726d 206d 6f64 616c 6974 792d  erform modality-
-00073b80: 7370 6563 6966 6963 206d 6174 6368 696e  specific matchin
-00073b90: 6720 616e 6420 6669 6c74 6572 696e 6720  g and filtering 
-00073ba0: 6261 7365 640a 2020 2020 6f6e 2070 7265  based.    on pre
-00073bb0: 6465 6669 6e65 6420 6372 6974 6572 6961  defined criteria
-00073bc0: 2c20 6f70 7469 6d69 7a69 6e67 2066 6f72  , optimizing for
-00073bd0: 206d 696e 696d 616c 206f 7574 6c69 6572   minimal outlier
-00073be0: 7320 616e 6420 6e6f 6973 652c 2061 6e64  s and noise, and
-00073bf0: 206d 6178 696d 616c 2073 6967 6e61 6c2d   maximal signal-
-00073c00: 746f 2d6e 6f69 7365 2072 6174 696f 2028  to-noise ratio (
-00073c10: 534e 5229 2c0a 2020 2020 6578 7065 6374  SNR),.    expect
-00073c20: 6564 2076 616c 7565 206f 6620 7261 6e64  ed value of rand
-00073c30: 6f6d 6e65 7373 2028 4556 5229 2c20 616e  omness (EVR), an
-00073c40: 6420 6469 6d65 6e73 696f 6e61 6c69 7479  d dimensionality
-00073c50: 2074 696d 6520 2864 696d 7429 2e0a 0a20   time (dimt)... 
-00073c60: 2020 2054 6869 7320 6675 6e63 7469 6f6e     This function
-00073c70: 2069 7465 7261 7469 7665 6c79 206d 6174   iteratively mat
-00073c80: 6368 6573 2064 6174 6166 7261 6d65 7320  ches dataframes 
-00073c90: 6465 7269 7665 6420 6672 6f6d 2074 6865  derived from the
-00073ca0: 2051 4320 6461 7461 6672 616d 6520 666f   QC dataframe fo
-00073cb0: 7220 6469 6666 6572 656e 7420 696d 6167  r different imag
-00073cc0: 696e 6720 6d6f 6461 6c69 7469 6573 2c0a  ing modalities,.
-00073cd0: 2020 2020 6170 706c 7969 6e67 2061 2073      applying a s
-00073ce0: 6572 6965 7320 6f66 2066 696c 7465 7273  eries of filters
-00073cf0: 2074 6f20 7365 6c65 6374 2074 6865 2062   to select the b
-00073d00: 6573 7420 6d61 7463 6865 7320 6261 7365  est matches base
-00073d10: 6420 6f6e 2074 6865 2051 4320 6d65 7472  d on the QC metr
-00073d20: 6963 732e 204d 6174 6368 6573 2061 7265  ics. Matches are
-00073d30: 206d 6164 6520 7769 7468 0a20 2020 2063   made with.    c
-00073d40: 6f6e 7369 6465 7261 7469 6f6e 2074 6f20  onsideration to 
-00073d50: 6d69 6e69 6d69 7a65 206f 7574 6c69 6572  minimize outlier
-00073d60: 206c 6f6f 7020 616e 6420 6e6f 6973 652c   loop and noise,
-00073d70: 2077 6869 6c65 206d 6178 696d 697a 696e   while maximizin
-00073d80: 6720 534e 522c 2045 5652 2c20 616e 6420  g SNR, EVR, and 
-00073d90: 6469 6d74 2066 6f72 2065 6163 6820 6d6f  dimt for each mo
-00073da0: 6461 6c69 7479 2e0a 0a20 2020 2050 6172  dality...    Par
-00073db0: 616d 6574 6572 733a 0a20 2020 202d 2d2d  ameters:.    ---
-00073dc0: 2d2d 2d2d 2d2d 2d0a 2020 2020 7163 5f64  -------.    qc_d
-00073dd0: 6174 6166 7261 6d65 203a 2070 616e 6461  ataframe : panda
-00073de0: 732e 4461 7461 4672 616d 650a 2020 2020  s.DataFrame.    
-00073df0: 2020 2020 5468 6520 4461 7461 4672 616d      The DataFram
-00073e00: 6520 636f 6e74 6169 6e69 6e67 2051 4320  e containing QC 
-00073e10: 6d65 7472 6963 7320 666f 7220 6469 6666  metrics for diff
-00073e20: 6572 656e 7420 6d6f 6461 6c69 7469 6573  erent modalities
-00073e30: 2061 6e64 2069 6d61 6769 6e67 2064 6174   and imaging dat
-00073e40: 612e 0a20 2020 2066 6978 5f4c 5252 4c20  a..    fix_LRRL 
-00073e50: 3a20 626f 6f6c 2c20 6f70 7469 6f6e 616c  : bool, optional
-00073e60: 0a0a 2020 2020 7665 7262 6f73 6520 3a20  ..    verbose : 
-00073e70: 626f 6f6c 2c20 6f70 7469 6f6e 616c 0a20  bool, optional. 
-00073e80: 2020 2020 2020 2049 6620 5472 7565 2c20         If True, 
-00073e90: 7072 696e 7473 2074 6865 2070 726f 6772  prints the progr
-00073ea0: 6573 7320 616e 6420 7468 6520 7368 6170  ess and the shap
-00073eb0: 6520 6f66 2074 6865 2044 6174 6146 7261  e of the DataFra
-00073ec0: 6d65 2062 6569 6e67 2070 726f 6365 7373  me being process
-00073ed0: 6564 2069 6e20 6561 6368 2073 7465 702e  ed in each step.
-00073ee0: 0a0a 2020 2020 5072 6f63 6573 733a 0a20  ..    Process:. 
-00073ef0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2031     -------.    1
-00073f00: 2e20 5374 616e 6461 7264 697a 6573 206d  . Standardizes m
-00073f10: 6f64 616c 6974 6965 7320 6279 206d 6572  odalities by mer
-00073f20: 6769 6e67 2044 5449 2d72 656c 6174 6564  ging DTI-related
-00073f30: 2065 6e74 7269 6573 2e0a 2020 2020 322e   entries..    2.
-00073f40: 2043 6f6e 7665 7274 7320 7370 6563 6966   Converts specif
-00073f50: 6963 2063 6f6c 756d 6e73 2074 6f20 6170  ic columns to ap
-00073f60: 7072 6f70 7269 6174 6520 6461 7461 2074  propriate data t
-00073f70: 7970 6573 2066 6f72 2070 726f 6365 7373  ypes for process
-00073f80: 696e 672e 0a20 2020 2033 2e20 5065 7266  ing..    3. Perf
-00073f90: 6f72 6d73 206d 6f64 616c 6974 792d 7370  orms modality-sp
-00073fa0: 6563 6966 6963 206d 6174 6368 696e 6720  ecific matching 
-00073fb0: 616e 6420 6669 6c74 6572 696e 6720 6261  and filtering ba
-00073fc0: 7365 6420 6f6e 2074 6865 206f 7574 6c69  sed on the outli
-00073fd0: 6572 2063 6f6c 756d 6e20 616e 6420 6372  er column and cr
-00073fe0: 6974 6572 6961 2066 6f72 2065 6163 6820  iteria for each 
-00073ff0: 6d6f 6461 6c69 7479 2e0a 2020 2020 342e  modality..    4.
-00074000: 2049 7465 7261 7469 7665 6c79 2070 726f   Iteratively pro
-00074010: 6365 7373 6573 2075 6e6d 6174 6368 6564  cesses unmatched
-00074020: 2064 6174 6120 666f 7220 7072 6564 6566   data for predef
-00074030: 696e 6564 206d 6f64 616c 6974 6965 7320  ined modalities 
-00074040: 7769 7468 2073 7065 6369 6669 6320 7072  with specific pr
-00074050: 6566 6978 6573 2074 6f20 6669 6e64 2066  efixes to find f
-00074060: 7572 7468 6572 206d 6174 6368 6573 2e0a  urther matches..
-00074070: 2020 2020 0a20 2020 2052 6574 7572 6e73      .    Returns
-00074080: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  :.    -------.  
-00074090: 2020 7061 6e64 6173 2e44 6174 6146 7261    pandas.DataFra
-000740a0: 6d65 0a20 2020 2020 2020 2054 6865 206d  me.        The m
-000740b0: 6174 6368 6564 2061 6e64 2066 696c 7465  atched and filte
-000740c0: 7265 6420 4461 7461 4672 616d 6520 6166  red DataFrame af
-000740d0: 7465 7220 6170 706c 7969 6e67 2061 6c6c  ter applying all
-000740e0: 2051 4320 7363 6f72 696e 6720 616e 6420   QC scoring and 
-000740f0: 6d61 7463 6869 6e67 206f 7065 7261 7469  matching operati
-00074100: 6f6e 7320 6163 726f 7373 2073 7065 6369  ons across speci
-00074110: 6669 6564 206d 6f64 616c 6974 6965 732e  fied modalities.
-00074120: 0a0a 2020 2020 2222 220a 2020 2020 7163  ..    """.    qc
-00074130: 5f64 6174 6166 7261 6d65 5b27 6d6f 6461  _dataframe['moda
-00074140: 6c69 7479 275d 203d 2071 635f 6461 7461  lity'] = qc_data
-00074150: 6672 616d 655b 276d 6f64 616c 6974 7927  frame['modality'
-00074160: 5d2e 7265 706c 6163 6528 5b27 4454 4964  ].replace(['DTId
-00074170: 7769 272c 2027 4454 4962 3027 5d2c 2027  wi', 'DTIb0'], '
-00074180: 4454 4927 2c20 7265 6765 783d 5472 7565  DTI', regex=True
-00074190: 290a 2020 2020 7163 5f64 6174 6166 7261  ).    qc_datafra
-000741a0: 6d65 5b27 6669 6c65 6e61 6d65 275d 3d71  me['filename']=q
-000741b0: 635f 6461 7461 6672 616d 655b 2766 696c  c_dataframe['fil
-000741c0: 656e 616d 6527 5d2e 6173 7479 7065 2873  ename'].astype(s
-000741d0: 7472 290a 2020 2020 7163 5f64 6174 6166  tr).    qc_dataf
-000741e0: 7261 6d65 5b27 6f6c 5f6c 6f6f 7027 5d3d  rame['ol_loop']=
-000741f0: 7163 5f64 6174 6166 7261 6d65 5b27 6f6c  qc_dataframe['ol
-00074200: 5f6c 6f6f 7027 5d2e 6173 7479 7065 2866  _loop'].astype(f
-00074210: 6c6f 6174 290a 2020 2020 7163 5f64 6174  loat).    qc_dat
-00074220: 6166 7261 6d65 5b27 6f6c 5f6c 6f66 275d  aframe['ol_lof']
-00074230: 3d71 635f 6461 7461 6672 616d 655b 276f  =qc_dataframe['o
-00074240: 6c5f 6c6f 6627 5d2e 6173 7479 7065 2866  l_lof'].astype(f
-00074250: 6c6f 6174 290a 2020 2020 7163 5f64 6174  loat).    qc_dat
-00074260: 6166 7261 6d65 5b27 6f6c 5f6c 6f66 5f64  aframe['ol_lof_d
-00074270: 6563 6973 696f 6e27 5d3d 7163 5f64 6174  ecision']=qc_dat
-00074280: 6166 7261 6d65 5b27 6f6c 5f6c 6f66 5f64  aframe['ol_lof_d
-00074290: 6563 6973 696f 6e27 5d2e 6173 7479 7065  ecision'].astype
-000742a0: 2866 6c6f 6174 290a 2020 2020 6f75 746c  (float).    outl
-000742b0: 6965 725f 636f 6c75 6d6e 3d27 6f6c 5f6c  ier_column='ol_l
-000742c0: 6f6f 7027 0a20 2020 206d 6d64 6630 203d  oop'.    mmdf0 =
-000742d0: 2062 6573 745f 6d6d 6d28 2071 635f 6461   best_mmm( qc_da
-000742e0: 7461 6672 616d 652c 2027 5431 7727 2c20  taframe, 'T1w', 
-000742f0: 6f75 746c 6965 725f 636f 6c75 6d6e 3d6f  outlier_column=o
-00074300: 7574 6c69 6572 5f63 6f6c 756d 6e20 295b  utlier_column )[
-00074310: 2766 696c 7427 5d0a 2020 2020 666c 6466  'filt'].    fldf
-00074320: 203d 2062 6573 745f 6d6d 6d28 2071 635f   = best_mmm( qc_
-00074330: 6461 7461 6672 616d 652c 2027 5432 466c  dataframe, 'T2Fl
-00074340: 6169 7227 2c20 6f75 746c 6965 725f 636f  air', outlier_co
-00074350: 6c75 6d6e 3d6f 7574 6c69 6572 5f63 6f6c  lumn=outlier_col
-00074360: 756d 6e20 295b 2766 696c 7427 5d0a 2020  umn )['filt'].  
-00074370: 2020 6e6d 6466 203d 2062 6573 745f 6d6d    nmdf = best_mm
-00074380: 6d28 2071 635f 6461 7461 6672 616d 652c  m( qc_dataframe,
-00074390: 2027 4e4d 3244 4d54 272c 206f 7574 6c69   'NM2DMT', outli
-000743a0: 6572 5f63 6f6c 756d 6e3d 6f75 746c 6965  er_column=outlie
-000743b0: 725f 636f 6c75 6d6e 2029 5b27 6669 6c74  r_column )['filt
-000743c0: 275d 0a20 2020 2072 7364 6620 3d20 6265  '].    rsdf = be
-000743d0: 7374 5f6d 6d6d 2820 7163 5f64 6174 6166  st_mmm( qc_dataf
-000743e0: 7261 6d65 2c20 2772 7366 4d52 4927 2c20  rame, 'rsfMRI', 
-000743f0: 6f75 746c 6965 725f 636f 6c75 6d6e 3d6f  outlier_column=o
-00074400: 7574 6c69 6572 5f63 6f6c 756d 6e20 295b  utlier_column )[
-00074410: 2766 696c 7427 5d0a 2020 2020 6474 6466  'filt'].    dtdf
-00074420: 203d 2062 6573 745f 6d6d 6d28 2071 635f   = best_mmm( qc_
-00074430: 6461 7461 6672 616d 652c 2027 4454 4927  dataframe, 'DTI'
-00074440: 2c20 6f75 746c 6965 725f 636f 6c75 6d6e  , outlier_column
-00074450: 3d6f 7574 6c69 6572 5f63 6f6c 756d 6e20  =outlier_column 
-00074460: 295b 2766 696c 7427 5d0a 0a20 2020 2063  )['filt']..    c
-00074470: 7269 7465 7269 6120 3d20 7b27 6f6c 5f6c  riteria = {'ol_l
-00074480: 6f6f 7027 3a20 276d 696e 272c 2027 6e6f  oop': 'min', 'no
-00074490: 6973 6527 3a20 276d 696e 272c 2027 736e  ise': 'min', 'sn
-000744a0: 7227 3a20 276d 6178 272c 2027 4556 5227  r': 'max', 'EVR'
-000744b0: 3a20 276d 6178 272c 2027 7265 666c 6563  : 'max', 'reflec
-000744c0: 7469 6f6e 5f65 7272 273a 276d 696e 277d  tion_err':'min'}
-000744d0: 0a20 2020 2078 636c 203d 205b 2027 6d72  .    xcl = [ 'mr
-000744e0: 696d 6667 272c 2027 6d72 696d 6f64 656c  imfg', 'mrimodel
-000744f0: 272c 276d 7269 4d61 676e 6574 6963 4669  ','mriMagneticFi
-00074500: 656c 6453 7472 656e 6774 6827 2c20 2764  eldStrength', 'd
-00074510: 7469 5f66 6169 6c65 6427 2c20 2772 7366  ti_failed', 'rsf
-00074520: 5f66 6169 6c65 6427 2c20 2773 7562 6a65  _failed', 'subje
-00074530: 6374 4944 272c 2027 6461 7465 272c 2027  ctID', 'date', '
-00074540: 7375 626a 6563 7449 4464 6174 6527 2c27  subjectIDdate','
-00074550: 7265 7065 6174 275d 0a20 2020 2023 2041  repeat'].    # A
-00074560: 7373 756d 696e 6720 6466 5f61 2061 6e64  ssuming df_a and
-00074570: 2064 665f 6220 6172 6520 616c 7265 6164   df_b are alread
-00074580: 7920 6c6f 6164 6564 0a20 2020 206d 6d64  y loaded.    mmd
-00074590: 662c 2075 6e64 6666 6c20 3d20 6d6d 5f6d  f, undffl = mm_m
-000745a0: 6174 6368 5f62 795f 7163 5f73 636f 7269  atch_by_qc_scori
-000745b0: 6e67 286d 6d64 6630 2c20 666c 6466 2c20  ng(mmdf0, fldf, 
-000745c0: 2773 7562 6a65 6374 4944 6461 7465 272c  'subjectIDdate',
-000745d0: 2063 7269 7465 7269 612c 200a 2020 2020   criteria, .    
-000745e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000745f0: 2020 2020 7072 6566 6978 3d27 5432 466c      prefix='T2Fl
-00074600: 6169 725f 272c 2065 7863 6c75 6465 5f63  air_', exclude_c
-00074610: 6f6c 756d 6e73 3d78 636c 2029 0a0a 2020  olumns=xcl )..  
-00074620: 2020 7072 6566 6978 6573 203d 205b 274e    prefixes = ['N
-00074630: 4d31 5f27 2c20 274e 4d32 5f27 2c20 274e  M1_', 'NM2_', 'N
-00074640: 4d33 5f27 2c20 274e 4d34 5f27 2c20 274e  M3_', 'NM4_', 'N
-00074650: 4d35 5f27 2c20 274e 4d36 5f27 5d20 200a  M5_', 'NM6_']  .
-00074660: 2020 2020 756e 6466 6d6f 6420 3d20 6e6d      undfmod = nm
-00074670: 6466 2020 2320 496e 6974 6961 6c69 7a65  df  # Initialize
-00074680: 2027 756e 6466 6d6f 6427 2077 6974 6820   'undfmod' with 
-00074690: 276e 6d64 6627 2066 6f72 2074 6865 2066  'nmdf' for the f
-000746a0: 6972 7374 2069 7465 7261 7469 6f6e 0a20  irst iteration. 
-000746b0: 2020 2069 6620 756e 6466 6d6f 6420 6973     if undfmod is
-000746c0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-000746d0: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
-000746e0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-000746f0: 2827 7374 6172 7420 4e4d 2729 0a20 2020  ('start NM').   
-00074700: 2020 2020 2020 2020 2070 7269 6e74 2820           print( 
-00074710: 756e 6466 6d6f 642e 7368 6170 6520 290a  undfmod.shape ).
-00074720: 2020 2020 2020 2020 666f 7220 7072 6566          for pref
-00074730: 6978 2069 6e20 7072 6566 6978 6573 3a0a  ix in prefixes:.
-00074740: 2020 2020 2020 2020 2020 2020 6966 2075              if u
-00074750: 6e64 666d 6f64 2e73 6861 7065 5b30 5d20  ndfmod.shape[0] 
-00074760: 3e20 3530 3a0a 2020 2020 2020 2020 2020  > 50:.          
-00074770: 2020 2020 2020 6d6d 6466 2c20 756e 6466        mmdf, undf
-00074780: 6d6f 6420 3d20 6d6d 5f6d 6174 6368 5f62  mod = mm_match_b
-00074790: 795f 7163 5f73 636f 7269 6e67 286d 6d64  y_qc_scoring(mmd
-000747a0: 662c 2075 6e64 666d 6f64 2c20 2773 7562  f, undfmod, 'sub
-000747b0: 6a65 6374 4944 6461 7465 272c 2063 7269  jectIDdate', cri
-000747c0: 7465 7269 612c 2070 7265 6669 783d 7072  teria, prefix=pr
-000747d0: 6566 6978 2c20 6578 636c 7564 655f 636f  efix, exclude_co
-000747e0: 6c75 6d6e 733d 7863 6c29 0a20 2020 2020  lumns=xcl).     
-000747f0: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
-00074800: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
-00074810: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00074820: 2820 7072 6566 6978 2029 0a20 2020 2020  ( prefix ).     
-00074830: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00074840: 7269 6e74 2820 756e 6466 6d6f 642e 7368  rint( undfmod.sh
-00074850: 6170 6520 290a 0a20 2020 2063 7269 7465  ape )..    crite
-00074860: 7269 6120 3d20 7b27 6f6c 5f6c 6f6f 7027  ria = {'ol_loop'
-00074870: 3a20 276d 696e 272c 2027 6e6f 6973 6527  : 'min', 'noise'
-00074880: 3a20 276d 696e 272c 2027 736e 7227 3a20  : 'min', 'snr': 
-00074890: 276d 6178 272c 2027 4556 5227 3a20 276d  'max', 'EVR': 'm
-000748a0: 6178 272c 2027 6469 6d74 273a 276d 6178  ax', 'dimt':'max
-000748b0: 277d 0a20 2020 2023 2068 6967 6865 7220  '}.    # higher 
-000748c0: 6276 616c 7565 7320 6c65 6164 2074 6f20  bvalues lead to 
-000748d0: 6d6f 7265 206e 6f69 7365 202e 2e2e 0a20  more noise .... 
-000748e0: 2020 2063 7269 7465 7269 6120 3d20 7b27     criteria = {'
-000748f0: 6f6c 5f6c 6f6f 7027 3a20 276d 696e 272c  ol_loop': 'min',
-00074900: 2027 6e6f 6973 6527 3a20 276d 696e 272c   'noise': 'min',
-00074910: 2020 2764 7469 5f62 7661 6c75 654d 6178    'dti_bvalueMax
-00074920: 273a 276d 696e 272c 2020 2764 696d 7427  ':'min',  'dimt'
-00074930: 3a27 6d61 7827 7d0a 2020 2020 7072 6566  :'max'}.    pref
-00074940: 6978 6573 203d 205b 2744 5449 315f 272c  ixes = ['DTI1_',
-00074950: 2027 4454 4932 5f27 2c20 2744 5449 335f   'DTI2_', 'DTI3_
-00074960: 275d 2020 2320 4c69 7374 206f 6620 7072  ']  # List of pr
-00074970: 6566 6978 6573 2066 6f72 2065 6163 6820  efixes for each 
-00074980: 6d61 7463 6869 6e67 2069 7465 7261 7469  matching iterati
-00074990: 6f6e 0a20 2020 2075 6e64 666d 6f64 203d  on.    undfmod =
-000749a0: 2064 7464 660a 2020 2020 6966 2076 6572   dtdf.    if ver
-000749b0: 626f 7365 3a0a 2020 2020 2020 2020 7072  bose:.        pr
-000749c0: 696e 7428 2773 7461 7274 2044 5427 290a  int('start DT').
-000749d0: 2020 2020 2020 2020 7072 696e 7428 2075          print( u
-000749e0: 6e64 666d 6f64 2e73 6861 7065 2029 0a20  ndfmod.shape ). 
-000749f0: 2020 2066 6f72 2070 7265 6669 7820 696e     for prefix in
-00074a00: 2070 7265 6669 7865 733a 0a20 2020 2020   prefixes:.     
-00074a10: 2020 2069 6620 756e 6466 6d6f 642e 7368     if undfmod.sh
-00074a20: 6170 655b 305d 203e 2035 303a 0a20 2020  ape[0] > 50:.   
-00074a30: 2020 2020 2020 2020 206d 6d64 662c 2075           mmdf, u
-00074a40: 6e64 666d 6f64 203d 206d 6d5f 6d61 7463  ndfmod = mm_matc
-00074a50: 685f 6279 5f71 635f 7363 6f72 696e 6728  h_by_qc_scoring(
-00074a60: 6d6d 6466 2c20 756e 6466 6d6f 642c 2027  mmdf, undfmod, '
-00074a70: 7375 626a 6563 7449 4464 6174 6527 2c20  subjectIDdate', 
-00074a80: 6372 6974 6572 6961 2c20 7072 6566 6978  criteria, prefix
-00074a90: 3d70 7265 6669 782c 2065 7863 6c75 6465  =prefix, exclude
-00074aa0: 5f63 6f6c 756d 6e73 3d78 636c 290a 2020  _columns=xcl).  
-00074ab0: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
-00074ac0: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-00074ad0: 2020 2020 2020 7072 696e 7428 2070 7265        print( pre
-00074ae0: 6669 7820 290a 2020 2020 2020 2020 2020  fix ).          
-00074af0: 2020 2020 2020 7072 696e 7428 2075 6e64        print( und
-00074b00: 666d 6f64 2e73 6861 7065 2029 0a0a 2020  fmod.shape )..  
-00074b10: 2020 7072 6566 6978 6573 203d 205b 2772    prefixes = ['r
-00074b20: 7366 315f 272c 2027 7273 6632 5f27 2c20  sf1_', 'rsf2_', 
-00074b30: 2772 7366 335f 275d 2020 2320 4c69 7374  'rsf3_']  # List
-00074b40: 206f 6620 7072 6566 6978 6573 2066 6f72   of prefixes for
-00074b50: 2065 6163 6820 6d61 7463 6869 6e67 2069   each matching i
-00074b60: 7465 7261 7469 6f6e 0a20 2020 2075 6e64  teration.    und
-00074b70: 666d 6f64 203d 2072 7364 6620 2023 2049  fmod = rsdf  # I
-00074b80: 6e69 7469 616c 697a 6520 2775 6e64 666d  nitialize 'undfm
-00074b90: 6f64 2720 7769 7468 2027 6e6d 6466 2720  od' with 'nmdf' 
-00074ba0: 666f 7220 7468 6520 6669 7273 7420 6974  for the first it
-00074bb0: 6572 6174 696f 6e0a 2020 2020 6966 2076  eration.    if v
-00074bc0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-00074bd0: 7072 696e 7428 2773 7461 7274 2072 7366  print('start rsf
-00074be0: 2729 0a20 2020 2020 2020 2070 7269 6e74  ').        print
-00074bf0: 2820 756e 6466 6d6f 642e 7368 6170 6520  ( undfmod.shape 
-00074c00: 290a 2020 2020 666f 7220 7072 6566 6978  ).    for prefix
-00074c10: 2069 6e20 7072 6566 6978 6573 3a0a 2020   in prefixes:.  
-00074c20: 2020 2020 2020 6966 2075 6e64 666d 6f64        if undfmod
-00074c30: 2e73 6861 7065 5b30 5d20 3e20 3530 3a0a  .shape[0] > 50:.
-00074c40: 2020 2020 2020 2020 2020 2020 6d6d 6466              mmdf
-00074c50: 2c20 756e 6466 6d6f 6420 3d20 6d6d 5f6d  , undfmod = mm_m
-00074c60: 6174 6368 5f62 795f 7163 5f73 636f 7269  atch_by_qc_scori
-00074c70: 6e67 286d 6d64 662c 2075 6e64 666d 6f64  ng(mmdf, undfmod
-00074c80: 2c20 2773 7562 6a65 6374 4944 6461 7465  , 'subjectIDdate
-00074c90: 272c 2063 7269 7465 7269 612c 2070 7265  ', criteria, pre
-00074ca0: 6669 783d 7072 6566 6978 2c20 6578 636c  fix=prefix, excl
-00074cb0: 7564 655f 636f 6c75 6d6e 733d 7863 6c29  ude_columns=xcl)
-00074cc0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00074cd0: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-00074ce0: 2020 2020 2020 2020 2070 7269 6e74 2820           print( 
-00074cf0: 7072 6566 6978 2029 0a20 2020 2020 2020  prefix ).       
-00074d00: 2020 2020 2020 2020 2070 7269 6e74 2820           print( 
-00074d10: 756e 6466 6d6f 642e 7368 6170 6520 290a  undfmod.shape ).
-00074d20: 2020 2020 0a20 2020 2069 6620 6669 785f      .    if fix_
-00074d30: 4c52 524c 3a0a 2020 2020 2020 2020 2320  LRRL:.        # 
-00074d40: 2020 2020 2020 206d 6d64 663d 6669 785f         mmdf=fix_
-00074d50: 4c52 5f52 4c5f 7374 7566 6628 206d 6d64  LR_RL_stuff( mmd
-00074d60: 662c 2027 4454 4931 5f66 696c 656e 616d  f, 'DTI1_filenam
-00074d70: 6527 2c20 2744 5449 325f 6669 6c65 6e61  e', 'DTI2_filena
-00074d80: 6d65 272c 2027 4454 4931 5f64 696d 7427  me', 'DTI1_dimt'
-00074d90: 2c20 2744 5449 325f 6469 6d74 2729 0a20  , 'DTI2_dimt'). 
-00074da0: 2020 2020 2020 206d 6d64 663d 6669 785f         mmdf=fix_
-00074db0: 4c52 5f52 4c5f 7374 7566 6628 206d 6d64  LR_RL_stuff( mmd
-00074dc0: 662c 2027 7273 6631 5f66 696c 656e 616d  f, 'rsf1_filenam
-00074dd0: 6527 2c20 2772 7366 325f 6669 6c65 6e61  e', 'rsf2_filena
-00074de0: 6d65 272c 2027 7273 6631 5f64 696d 7427  me', 'rsf1_dimt'
-00074df0: 2c20 2772 7366 325f 6469 6d74 272c 2027  , 'rsf2_dimt', '
-00074e00: 7273 6631 5f69 6d61 6765 4944 272c 2027  rsf1_imageID', '
-00074e10: 7273 6632 5f69 6d61 6765 4944 2720 2029  rsf2_imageID'  )
-00074e20: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00074e30: 2020 2069 6d70 6f72 7420 7761 726e 696e     import warnin
-00074e40: 6773 0a20 2020 2020 2020 2077 6172 6e69  gs.        warni
-00074e50: 6e67 732e 7761 726e 2822 4649 584d 453a  ngs.warn("FIXME:
-00074e60: 2073 686f 756c 6420 6669 7820 4c52 2061   should fix LR a
-00074e70: 6e64 2052 4c20 7369 7475 6174 696f 6e20  nd RL situation 
-00074e80: 666f 7220 7468 6520 4454 4920 616e 6420  for the DTI and 
-00074e90: 7273 664d 5249 2229 0a0a 2020 2020 2320  rsfMRI")..    # 
-00074ea0: 6e6f 7720 646f 2074 6865 206e 6563 6573  now do the neces
-00074eb0: 7361 7279 2072 6570 6c61 6365 6d65 6e74  sary replacement
-00074ec0: 730a 2020 2020 0a20 2020 2072 656e 616d  s.    .    renam
-00074ed0: 6569 7428 206d 6d64 662c 2027 7065 7266  eit( mmdf, 'perf
-00074ee0: 5f69 6d61 6765 4944 272c 2027 7065 7266  _imageID', 'perf
-00074ef0: 6964 2720 290a 2020 2020 7265 6e61 6d65  id' ).    rename
-00074f00: 6974 2820 6d6d 6466 2c20 2770 6572 665f  it( mmdf, 'perf_
-00074f10: 6669 6c65 6e61 6d65 272c 2027 7065 7266  filename', 'perf
-00074f20: 666e 2720 290a 2020 2020 7265 6e61 6d65  fn' ).    rename
-00074f30: 6974 2820 6d6d 6466 2c20 2754 3246 6c61  it( mmdf, 'T2Fla
-00074f40: 6972 5f69 6d61 6765 4944 272c 2027 666c  ir_imageID', 'fl
-00074f50: 6169 7269 6427 2029 0a20 2020 2072 656e  airid' ).    ren
-00074f60: 616d 6569 7428 206d 6d64 662c 2027 5432  ameit( mmdf, 'T2
-00074f70: 466c 6169 725f 6669 6c65 6e61 6d65 272c  Flair_filename',
-00074f80: 2027 666c 6169 7266 6e27 2029 0a20 2020   'flairfn' ).   
-00074f90: 2072 656e 616d 6569 7428 206d 6d64 662c   renameit( mmdf,
-00074fa0: 2027 7273 6631 5f69 6d61 6765 4944 272c   'rsf1_imageID',
-00074fb0: 2027 7273 6669 6431 2720 290a 2020 2020   'rsfid1' ).    
-00074fc0: 7265 6e61 6d65 6974 2820 6d6d 6466 2c20  renameit( mmdf, 
-00074fd0: 2772 7366 325f 696d 6167 6549 4427 2c20  'rsf2_imageID', 
-00074fe0: 2772 7366 6964 3227 2029 0a20 2020 2072  'rsfid2' ).    r
-00074ff0: 656e 616d 6569 7428 206d 6d64 662c 2027  enameit( mmdf, '
-00075000: 7273 6631 5f66 696c 656e 616d 6527 2c20  rsf1_filename', 
-00075010: 2772 7366 666e 3127 2029 0a20 2020 2072  'rsffn1' ).    r
-00075020: 656e 616d 6569 7428 206d 6d64 662c 2027  enameit( mmdf, '
-00075030: 7273 6632 5f66 696c 656e 616d 6527 2c20  rsf2_filename', 
-00075040: 2772 7366 666e 3227 2029 0a20 2020 2072  'rsffn2' ).    r
-00075050: 656e 616d 6569 7428 206d 6d64 662c 2027  enameit( mmdf, '
-00075060: 4454 4931 5f69 6d61 6765 4944 272c 2027  DTI1_imageID', '
-00075070: 6474 6964 3127 2029 0a20 2020 2072 656e  dtid1' ).    ren
-00075080: 616d 6569 7428 206d 6d64 662c 2027 4454  ameit( mmdf, 'DT
-00075090: 4932 5f69 6d61 6765 4944 272c 2027 6474  I2_imageID', 'dt
-000750a0: 6964 3227 2029 0a20 2020 2072 656e 616d  id2' ).    renam
-000750b0: 6569 7428 206d 6d64 662c 2027 4454 4933  eit( mmdf, 'DTI3
-000750c0: 5f69 6d61 6765 4944 272c 2027 6474 6964  _imageID', 'dtid
-000750d0: 3327 2029 0a20 2020 2072 656e 616d 6569  3' ).    renamei
-000750e0: 7428 206d 6d64 662c 2027 4454 4931 5f66  t( mmdf, 'DTI1_f
-000750f0: 696c 656e 616d 6527 2c20 2764 7466 6e31  ilename', 'dtfn1
-00075100: 2720 290a 2020 2020 7265 6e61 6d65 6974  ' ).    renameit
-00075110: 2820 6d6d 6466 2c20 2744 5449 325f 6669  ( mmdf, 'DTI2_fi
-00075120: 6c65 6e61 6d65 272c 2027 6474 666e 3227  lename', 'dtfn2'
-00075130: 2029 0a20 2020 2072 656e 616d 6569 7428   ).    renameit(
-00075140: 206d 6d64 662c 2027 4454 4933 5f66 696c   mmdf, 'DTI3_fil
-00075150: 656e 616d 6527 2c20 2764 7466 6e33 2720  ename', 'dtfn3' 
-00075160: 290a 2020 2020 666f 7220 7820 696e 2072  ).    for x in r
-00075170: 616e 6765 2831 2c36 293a 0a20 2020 2020  ange(1,6):.     
-00075180: 2020 2074 656d 7030 3d22 4e4d 222b 7374     temp0="NM"+st
-00075190: 7228 7829 2b22 5f69 6d61 6765 4944 220a  r(x)+"_imageID".
-000751a0: 2020 2020 2020 2020 7465 6d70 313d 226e          temp1="n
-000751b0: 6d69 6422 2b73 7472 2878 290a 2020 2020  mid"+str(x).    
-000751c0: 2020 2020 7265 6e61 6d65 6974 2820 6d6d      renameit( mm
-000751d0: 6466 2c20 7465 6d70 302c 2074 656d 7031  df, temp0, temp1
-000751e0: 2029 0a20 2020 2020 2020 2074 656d 7030   ).        temp0
-000751f0: 3d22 4e4d 222b 7374 7228 7829 2b22 5f66  ="NM"+str(x)+"_f
-00075200: 696c 656e 616d 6522 0a20 2020 2020 2020  ilename".       
-00075210: 2074 656d 7031 3d22 6e6d 666e 222b 7374   temp1="nmfn"+st
-00075220: 7228 7829 0a20 2020 2020 2020 2072 656e  r(x).        ren
-00075230: 616d 6569 7428 206d 6d64 662c 2074 656d  ameit( mmdf, tem
-00075240: 7030 2c20 7465 6d70 3120 290a 2020 2020  p0, temp1 ).    
-00075250: 7265 7475 726e 206d 6d64 660a            return mmdf.
+0005c9c0: 2020 6a6d 6d2e 696c 6f63 5b6b 5d5b 6474    jmm.iloc[k][dt
+0005c9d0: 305b 313a 5d5d 203d 2076 320a 2020 2020  0[1:]] = v2.    
+0005c9e0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+0005c9f0: 206c 656e 286d 796e 6e61 2920 3e20 313a   len(mynna) > 1:
+0005ca00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005ca10: 2020 2020 2069 6620 6c65 6e28 7632 2920       if len(v2) 
+0005ca20: 3e20 6469 6167 6e6f 7374 6963 5f6e 3a0a  > diagnostic_n:.
+0005ca30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ca40: 2020 2020 2020 2020 7631 6478 3d76 315b          v1dx=v1[
+0005ca50: 303a 6469 6167 6e6f 7374 6963 5f6e 5d0a  0:diagnostic_n].
+0005ca60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ca70: 2020 2020 2020 2020 7632 6478 3d76 325b          v2dx=v2[
+0005ca80: 303a 6469 6167 6e6f 7374 6963 5f6e 5d0a  0:diagnostic_n].
+0005ca90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005caa0: 2020 2020 656c 7365 203a 0a20 2020 2020      else :.     
+0005cab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cac0: 2020 2076 3164 783d 7631 0a20 2020 2020     v1dx=v1.     
+0005cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cae0: 2020 2076 3264 783d 7632 0a20 2020 2020     v2dx=v2.     
+0005caf0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+0005cb00: 6f69 6e44 6961 676e 6f73 7469 6373 4c6f  oinDiagnosticsLo
+0005cb10: 6320 3d20 7064 2e44 6174 6146 7261 6d65  c = pd.DataFrame
+0005cb20: 2820 636f 6c75 6d6e 7320 3d20 6478 636f  ( columns = dxco
+0005cb30: 6c73 2c20 696e 6465 783d 7261 6e67 6528  ls, index=range(
+0005cb40: 3129 2029 0a20 2020 2020 2020 2020 2020  1) ).           
+0005cb50: 2020 2020 2020 2020 206d 7963 6f72 7220           mycorr 
+0005cb60: 3d20 6e70 2e63 6f72 7263 6f65 6628 2076  = np.corrcoef( v
+0005cb70: 3164 782e 7661 6c75 6573 2c20 7632 6478  1dx.values, v2dx
+0005cb80: 2e76 616c 7565 7320 295b 302c 315d 0a20  .values )[0,1]. 
+0005cb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cba0: 2020 206d 7965 7272 3d6e 702e 7371 7274     myerr=np.sqrt
+0005cbb0: 286e 702e 6d65 616e 2828 7631 6478 2e76  (np.mean((v1dx.v
+0005cbc0: 616c 7565 7320 2d20 7632 6478 2e76 616c  alues - v2dx.val
+0005cbd0: 7565 7329 2a2a 3229 290a 2020 2020 2020  ues)**2)).      
+0005cbe0: 2020 2020 2020 2020 2020 2020 2020 6a6f                jo
+0005cbf0: 696e 4469 6167 6e6f 7374 6963 734c 6f63  inDiagnosticsLoc
+0005cc00: 2e69 6c6f 635b 305d 203d 205b 6a6d 6d2e  .iloc[0] = [jmm.
+0005cc10: 6c6f 635b 6b2c 2775 5f68 6965 725f 6964  loc[k,'u_hier_id
+0005cc20: 275d 2c6d 6174 682e 6e61 6e2c 2772 7366  '],math.nan,'rsf
+0005cc30: 4d52 4927 2c27 636f 6c61 7667 272c 6d79  MRI','colavg',my
+0005cc40: 636f 7272 2c6d 7965 7272 5d0a 2020 2020  corr,myerr].    
+0005cc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cc60: 6966 206d 7963 6f72 7220 3e20 636f 7272  if mycorr > corr
+0005cc70: 5f74 6872 6573 683a 0a20 2020 2020 2020  _thresh:.       
+0005cc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cc90: 206a 6d6d 2e6c 6f63 5b6b 2c20 6474 305b   jmm.loc[k, dt0[
+0005cca0: 313a 5d5d 203d 2076 312e 7661 6c75 6573  1:]] = v1.values
+0005ccb0: 2a30 2e35 202b 2076 322e 7661 6c75 6573  *0.5 + v2.values
+0005ccc0: 2a30 2e35 0a20 2020 2020 2020 2020 2020  *0.5.           
+0005ccd0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0005cce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ccf0: 2020 2020 2020 206a 6d6d 2e6c 6f63 5b6b         jmm.loc[k
+0005cd00: 2c20 6474 305b 313a 5d5d 203d 206e 616e  , dt0[1:]] = nan
+0005cd10: 4c69 7374 202a 206c 656e 2876 3129 0a20  List * len(v1). 
+0005cd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cd30: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
+0005cd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cd50: 2020 2020 2020 2070 7269 6e74 2820 6a6f         print( jo
+0005cd60: 696e 4469 6167 6e6f 7374 6963 734c 6f63  inDiagnosticsLoc
+0005cd70: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0005cd80: 2020 2020 2020 206a 6f69 6e44 6961 676e         joinDiagn
+0005cd90: 6f73 7469 6373 203d 2070 642e 636f 6e63  ostics = pd.conc
+0005cda0: 6174 2820 5b6a 6f69 6e44 6961 676e 6f73  at( [joinDiagnos
+0005cdb0: 7469 6373 2c20 6a6f 696e 4469 6167 6e6f  tics, joinDiagno
+0005cdc0: 7374 6963 734c 6f63 5d2c 2061 7869 733d  sticsLoc], axis=
+0005cdd0: 302c 2069 676e 6f72 655f 696e 6465 783d  0, ignore_index=
+0005cde0: 4661 6c73 6520 290a 0a20 2020 2069 6620  False )..    if 
+0005cdf0: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+0005ce00: 2070 7269 6e74 2822 646f 2044 5449 2229   print("do DTI")
+0005ce10: 0a20 2020 2023 2068 6572 6520 2d20 7765  .    # here - we
+0005ce20: 2066 6972 7374 2068 6176 6520 746f 2061   first have to a
+0005ce30: 7665 7261 6765 2077 6974 6869 6e20 6561  verage within ea
+0005ce40: 6368 2072 6f77 0a20 2020 2064 7430 203d  ch row.    dt0 =
+0005ce50: 2067 6574 5f6e 616d 6573 5f66 726f 6d5f   get_names_from_
+0005ce60: 6461 7461 5f66 7261 6d65 285b 2244 5449  data_frame(["DTI
+0005ce70: 225d 2c20 6a6d 6d2c 2065 7863 6c75 7369  "], jmm, exclusi
+0005ce80: 6f6e 733d 5b22 556e 6e61 6d65 6422 2c20  ons=["Unnamed", 
+0005ce90: 2244 5449 5f4c 5222 2c20 2244 5449 5f52  "DTI_LR", "DTI_R
+0005cea0: 4c22 5d29 0a20 2020 2064 7431 203d 2067  L"]).    dt1 = g
+0005ceb0: 6574 5f6e 616d 6573 5f66 726f 6d5f 6461  et_names_from_da
+0005cec0: 7461 5f66 7261 6d65 285b 2244 5449 5f4c  ta_frame(["DTI_L
+0005ced0: 5222 5d2c 206a 6d6d 2c20 6578 636c 7573  R"], jmm, exclus
+0005cee0: 696f 6e73 3d5b 2255 6e6e 616d 6564 225d  ions=["Unnamed"]
+0005cef0: 290a 2020 2020 6474 3220 3d20 6765 745f  ).    dt2 = get_
+0005cf00: 6e61 6d65 735f 6672 6f6d 5f64 6174 615f  names_from_data_
+0005cf10: 6672 616d 6528 205b 2244 5449 5f52 4c22  frame( ["DTI_RL"
+0005cf20: 5d2c 206a 6d6d 2c20 6578 636c 7573 696f  ], jmm, exclusio
+0005cf30: 6e73 3d5b 2255 6e6e 616d 6564 225d 290a  ns=["Unnamed"]).
+0005cf40: 2020 2020 666c 6964 203d 2064 7430 5b30      flid = dt0[0
+0005cf50: 5d0a 2020 2020 7772 6f77 7320 3d20 5b5d  ].    wrows = []
+0005cf60: 0a20 2020 2066 6f72 2069 2069 6e20 7261  .    for i in ra
+0005cf70: 6e67 6528 6a6d 6d2e 7368 6170 655b 305d  nge(jmm.shape[0]
+0005cf80: 293a 0a20 2020 2020 2020 2069 6620 6e6f  ):.        if no
+0005cf90: 7420 7064 2e69 736e 6128 6a6d 6d5b 6474  t pd.isna(jmm[dt
+0005cfa0: 305b 315d 5d5b 695d 2920 6f72 206e 6f74  0[1]][i]) or not
+0005cfb0: 2070 642e 6973 6e61 286a 6d6d 5b64 7431   pd.isna(jmm[dt1
+0005cfc0: 5b31 5d5d 5b69 5d29 206f 7220 6e6f 7420  [1]][i]) or not 
+0005cfd0: 7064 2e69 736e 6128 6a6d 6d5b 6474 325b  pd.isna(jmm[dt2[
+0005cfe0: 315d 5d5b 695d 293a 0a20 2020 2020 2020  1]][i]):.       
+0005cff0: 2020 2020 2077 726f 7773 2e61 7070 656e       wrows.appen
+0005d000: 6428 6929 0a20 2020 2066 6f72 206b 2069  d(i).    for k i
+0005d010: 6e20 7772 6f77 733a 0a20 2020 2020 2020  n wrows:.       
+0005d020: 2076 3120 3d20 6a6d 6d2e 6c6f 635b 6b2c   v1 = jmm.loc[k,
+0005d030: 2064 7430 5b31 3a5d 5d2e 6173 7479 7065   dt0[1:]].astype
+0005d040: 2866 6c6f 6174 290a 2020 2020 2020 2020  (float).        
+0005d050: 7632 203d 206a 6d6d 2e6c 6f63 5b6b 2c20  v2 = jmm.loc[k, 
+0005d060: 6474 315b 313a 5d5d 2e61 7374 7970 6528  dt1[1:]].astype(
+0005d070: 666c 6f61 7429 0a20 2020 2020 2020 2076  float).        v
+0005d080: 3320 3d20 6a6d 6d2e 6c6f 635b 6b2c 2064  3 = jmm.loc[k, d
+0005d090: 7432 5b31 3a5d 5d2e 6173 7479 7065 2866  t2[1:]].astype(f
+0005d0a0: 6c6f 6174 290a 2020 2020 2020 2020 6368  loat).        ch
+0005d0b0: 6563 6b63 6f6c 203d 2064 7430 5b35 5d0a  eckcol = dt0[5].
+0005d0c0: 2020 2020 2020 2020 6966 206e 6f74 206e          if not n
+0005d0d0: 702e 6973 6e61 6e28 7631 5b63 6865 636b  p.isnan(v1[check
+0005d0e0: 636f 6c5d 293a 0a20 2020 2020 2020 2020  col]):.         
+0005d0f0: 2020 2069 6620 7631 5b63 6865 636b 636f     if v1[checkco
+0005d100: 6c5d 203c 2030 2e32 353a 0a20 2020 2020  l] < 0.25:.     
+0005d110: 2020 2020 2020 2020 2020 2076 312e 7265             v1.re
+0005d120: 706c 6163 6528 6e70 2e6e 616e 2c20 696e  place(np.nan, in
+0005d130: 706c 6163 653d 5472 7565 290a 2020 2020  place=True).    
+0005d140: 2020 2020 6368 6563 6b63 6f6c 203d 2064      checkcol = d
+0005d150: 7431 5b35 5d0a 2020 2020 2020 2020 6966  t1[5].        if
+0005d160: 206e 6f74 206e 702e 6973 6e61 6e28 7632   not np.isnan(v2
+0005d170: 5b63 6865 636b 636f 6c5d 293a 0a20 2020  [checkcol]):.   
+0005d180: 2020 2020 2020 2020 2069 6620 7632 5b63           if v2[c
+0005d190: 6865 636b 636f 6c5d 203c 2030 2e32 353a  heckcol] < 0.25:
+0005d1a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005d1b0: 2076 322e 7265 706c 6163 6528 6e70 2e6e   v2.replace(np.n
+0005d1c0: 616e 2c20 696e 706c 6163 653d 5472 7565  an, inplace=True
+0005d1d0: 290a 2020 2020 2020 2020 6368 6563 6b63  ).        checkc
+0005d1e0: 6f6c 203d 2064 7432 5b35 5d0a 2020 2020  ol = dt2[5].    
+0005d1f0: 2020 2020 6966 206e 6f74 206e 702e 6973      if not np.is
+0005d200: 6e61 6e28 7633 5b63 6865 636b 636f 6c5d  nan(v3[checkcol]
+0005d210: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+0005d220: 6620 7633 5b63 6865 636b 636f 6c5d 203c  f v3[checkcol] <
+0005d230: 2030 2e32 353a 0a20 2020 2020 2020 2020   0.25:.         
+0005d240: 2020 2020 2020 2076 332e 7265 706c 6163         v3.replac
+0005d250: 6528 6e70 2e6e 616e 2c20 696e 706c 6163  e(np.nan, inplac
+0005d260: 653d 5472 7565 290a 2020 2020 2020 2020  e=True).        
+0005d270: 7676 6563 203d 205b 7631 5b30 5d2c 2076  vvec = [v1[0], v
+0005d280: 325b 305d 2c20 7633 5b30 5d5d 0a20 2020  2[0], v3[0]].   
+0005d290: 2020 2020 2069 6620 616e 7928 7e6e 702e       if any(~np.
+0005d2a0: 6973 6e61 6e28 7676 6563 2929 3a0a 2020  isnan(vvec)):.  
+0005d2b0: 2020 2020 2020 2020 2020 6d79 6e6e 6120            mynna 
+0005d2c0: 3d20 5b69 2066 6f72 2069 2c20 7820 696e  = [i for i, x in
+0005d2d0: 2065 6e75 6d65 7261 7465 2876 7665 6329   enumerate(vvec)
+0005d2e0: 2069 6620 7e6e 702e 6973 6e61 6e28 7829   if ~np.isnan(x)
+0005d2f0: 5d0a 2020 2020 2020 2020 2020 2020 6a6d  ].            jm
+0005d300: 6d2e 6c6f 635b 6b2c 2064 7430 5b30 5d5d  m.loc[k, dt0[0]]
+0005d310: 203d 2027 4454 4927 0a20 2020 2020 2020   = 'DTI'.       
+0005d320: 2020 2020 2069 6620 6c65 6e28 6d79 6e6e       if len(mynn
+0005d330: 6129 203d 3d20 313a 0a20 2020 2020 2020  a) == 1:.       
+0005d340: 2020 2020 2020 2020 2069 6620 6d79 6e6e           if mynn
+0005d350: 615b 305d 203d 3d20 303a 0a20 2020 2020  a[0] == 0:.     
+0005d360: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+0005d370: 6d6d 2e6c 6f63 5b6b 2c20 6474 305b 313a  mm.loc[k, dt0[1:
+0005d380: 5d5d 203d 2076 310a 2020 2020 2020 2020  ]] = v1.        
+0005d390: 2020 2020 2020 2020 6966 206d 796e 6e61          if mynna
+0005d3a0: 5b30 5d20 3d3d 2031 3a0a 2020 2020 2020  [0] == 1:.      
+0005d3b0: 2020 2020 2020 2020 2020 2020 2020 6a6d                jm
+0005d3c0: 6d2e 6c6f 635b 6b2c 2064 7430 5b31 3a5d  m.loc[k, dt0[1:]
+0005d3d0: 5d20 3d20 7632 0a20 2020 2020 2020 2020  ] = v2.         
+0005d3e0: 2020 2020 2020 2069 6620 6d79 6e6e 615b         if mynna[
+0005d3f0: 305d 203d 3d20 323a 0a20 2020 2020 2020  0] == 2:.       
+0005d400: 2020 2020 2020 2020 2020 2020 206a 6d6d               jmm
+0005d410: 2e6c 6f63 5b6b 2c20 6474 305b 313a 5d5d  .loc[k, dt0[1:]]
+0005d420: 203d 2076 330a 2020 2020 2020 2020 2020   = v3.          
+0005d430: 2020 656c 6966 206c 656e 286d 796e 6e61    elif len(mynna
+0005d440: 2920 3e20 313a 0a20 2020 2020 2020 2020  ) > 1:.         
+0005d450: 2020 2020 2020 2069 6620 6d79 6e6e 615b         if mynna[
+0005d460: 305d 203d 3d20 303a 0a20 2020 2020 2020  0] == 0:.       
+0005d470: 2020 2020 2020 2020 2020 2020 206a 6d6d               jmm
+0005d480: 2e6c 6f63 5b6b 2c20 6474 305b 313a 5d5d  .loc[k, dt0[1:]]
+0005d490: 203d 2076 310a 2020 2020 2020 2020 2020   = v1.          
+0005d4a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0005d4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005d4c0: 6a6f 696e 4469 6167 6e6f 7374 6963 734c  joinDiagnosticsL
+0005d4d0: 6f63 203d 2070 642e 4461 7461 4672 616d  oc = pd.DataFram
+0005d4e0: 6528 2063 6f6c 756d 6e73 203d 2064 7863  e( columns = dxc
+0005d4f0: 6f6c 732c 2069 6e64 6578 3d72 616e 6765  ols, index=range
+0005d500: 2831 2920 290a 2020 2020 2020 2020 2020  (1) ).          
+0005d510: 2020 2020 2020 2020 2020 6d79 636f 7272            mycorr
+0005d520: 203d 206e 702e 636f 7272 636f 6566 2820   = np.corrcoef( 
+0005d530: 7632 5b30 3a64 6961 676e 6f73 7469 635f  v2[0:diagnostic_
+0005d540: 6e5d 2e76 616c 7565 732c 2076 335b 303a  n].values, v3[0:
+0005d550: 6469 6167 6e6f 7374 6963 5f6e 5d2e 7661  diagnostic_n].va
+0005d560: 6c75 6573 2029 5b30 2c31 5d0a 2020 2020  lues )[0,1].    
+0005d570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005d580: 6d79 6572 723d 6e70 2e73 7172 7428 6e70  myerr=np.sqrt(np
+0005d590: 2e6d 6561 6e28 2876 325b 303a 6469 6167  .mean((v2[0:diag
+0005d5a0: 6e6f 7374 6963 5f6e 5d2e 7661 6c75 6573  nostic_n].values
+0005d5b0: 202d 2076 335b 303a 6469 6167 6e6f 7374   - v3[0:diagnost
+0005d5c0: 6963 5f6e 5d2e 7661 6c75 6573 292a 2a32  ic_n].values)**2
+0005d5d0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+0005d5e0: 2020 2020 2020 206a 6f69 6e44 6961 676e         joinDiagn
+0005d5f0: 6f73 7469 6373 4c6f 632e 696c 6f63 5b30  osticsLoc.iloc[0
+0005d600: 5d20 3d20 5b6a 6d6d 2e6c 6f63 5b6b 2c27  ] = [jmm.loc[k,'
+0005d610: 755f 6869 6572 5f69 6427 5d2c 6d61 7468  u_hier_id'],math
+0005d620: 2e6e 616e 2c27 4454 4927 2c27 636f 6c61  .nan,'DTI','cola
+0005d630: 7667 272c 6d79 636f 7272 2c6d 7965 7272  vg',mycorr,myerr
+0005d640: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0005d650: 2020 2020 2020 6966 206d 7963 6f72 7220        if mycorr 
+0005d660: 3e20 636f 7272 5f74 6872 6573 683a 0a20  > corr_thresh:. 
+0005d670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005d680: 2020 2020 2020 206a 6d6d 2e6c 6f63 5b6b         jmm.loc[k
+0005d690: 2c20 6474 305b 313a 5d5d 203d 2076 322e  , dt0[1:]] = v2.
+0005d6a0: 7661 6c75 6573 2a30 2e35 202b 2076 332e  values*0.5 + v3.
+0005d6b0: 7661 6c75 6573 2a30 2e35 0a20 2020 2020  values*0.5.     
+0005d6c0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0005d6d0: 6c73 653a 2023 0a20 2020 2020 2020 2020  lse: #.         
+0005d6e0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+0005d6f0: 6d6d 2e6c 6f63 5b6b 2c20 6474 305b 313a  mm.loc[k, dt0[1:
+0005d700: 5d5d 203d 206e 616e 4c69 7374 202a 206c  ]] = nanList * l
+0005d710: 656e 2820 6474 305b 313a 5d20 290a 2020  en( dt0[1:] ).  
+0005d720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005d730: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+0005d740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005d750: 2020 2020 2020 7072 696e 7428 206a 6f69        print( joi
+0005d760: 6e44 6961 676e 6f73 7469 6373 4c6f 6320  nDiagnosticsLoc 
+0005d770: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0005d780: 2020 2020 2020 6a6f 696e 4469 6167 6e6f        joinDiagno
+0005d790: 7374 6963 7320 3d20 7064 2e63 6f6e 6361  stics = pd.conca
+0005d7a0: 7428 205b 6a6f 696e 4469 6167 6e6f 7374  t( [joinDiagnost
+0005d7b0: 6963 732c 206a 6f69 6e44 6961 676e 6f73  ics, joinDiagnos
+0005d7c0: 7469 6373 4c6f 635d 2c20 6178 6973 3d30  ticsLoc], axis=0
+0005d7d0: 2c20 6967 6e6f 7265 5f69 6e64 6578 3d46  , ignore_index=F
+0005d7e0: 616c 7365 2029 0a0a 0a20 2020 2023 2066  alse )...    # f
+0005d7f0: 6972 7374 2074 6173 6b20 2d20 736f 7274  irst task - sort
+0005d800: 2062 7920 755f 6869 6572 5f69 640a 2020   by u_hier_id.  
+0005d810: 2020 6a6d 6d20 3d20 6a6d 6d2e 736f 7274    jmm = jmm.sort
+0005d820: 5f76 616c 7565 7328 2022 755f 6869 6572  _values( "u_hier
+0005d830: 5f69 6422 2029 0a20 2020 2023 2067 6574  _id" ).    # get
+0005d840: 2072 6964 206f 6620 6a75 6e6b 2063 6f6c   rid of junk col
+0005d850: 756d 6e73 0a20 2020 2062 6164 6e61 6d65  umns.    badname
+0005d860: 7320 3d20 6765 745f 6e61 6d65 735f 6672  s = get_names_fr
+0005d870: 6f6d 5f64 6174 615f 6672 616d 6528 205b  om_data_frame( [
+0005d880: 2755 6e6e 616d 6564 275d 2c20 6a6d 6d20  'Unnamed'], jmm 
+0005d890: 290a 2020 2020 6a6d 6d3d 6a6d 6d2e 6472  ).    jmm=jmm.dr
+0005d8a0: 6f70 2862 6164 6e61 6d65 732c 2061 7869  op(badnames, axi
+0005d8b0: 733d 3129 0a20 2020 206a 6d6d 3d6a 6d6d  s=1).    jmm=jmm
+0005d8c0: 2e73 6574 5f69 6e64 6578 2822 755f 6869  .set_index("u_hi
+0005d8d0: 6572 5f69 6422 2c64 726f 703d 4661 6c73  er_id",drop=Fals
+0005d8e0: 6529 0a20 2020 2023 2032 6e64 202d 2067  e).    # 2nd - g
+0005d8f0: 6574 2072 6964 206f 6620 6475 706c 6963  et rid of duplic
+0005d900: 6174 6564 2075 5f68 6965 725f 6964 0a20  ated u_hier_id. 
+0005d910: 2020 206a 6d6d 556e 6971 203d 206a 6d6d     jmmUniq = jmm
+0005d920: 2e64 726f 705f 6475 706c 6963 6174 6573  .drop_duplicates
+0005d930: 2820 7375 6273 6574 3d22 755f 6869 6572  ( subset="u_hier
+0005d940: 5f69 6422 2029 2023 2066 6173 7420 616e  _id" ) # fast an
+0005d950: 6420 6561 7379 0a20 2020 2023 2066 6f72  d easy.    # for
+0005d960: 2065 6163 6820 6d6f 6461 6c69 7479 2c20   each modality, 
+0005d970: 636f 756e 7420 7768 6963 6820 6964 7320  count which ids 
+0005d980: 6861 7665 206d 6f72 6520 7468 616e 206f  have more than o
+0005d990: 6e65 0a20 2020 206d 6f64 5f6e 616d 6573  ne.    mod_names
+0005d9a0: 203d 2067 6574 5f76 616c 6964 5f6d 6f64   = get_valid_mod
+0005d9b0: 616c 6974 6965 7328 290a 2020 2020 666f  alities().    fo
+0005d9c0: 7220 6d6f 645f 6e61 6d65 2069 6e20 6d6f  r mod_name in mo
+0005d9d0: 645f 6e61 6d65 733a 0a20 2020 2020 2020  d_names:.       
+0005d9e0: 2066 6c5f 6e61 6d65 7320 3d20 6765 745f   fl_names = get_
+0005d9f0: 6e61 6d65 735f 6672 6f6d 5f64 6174 615f  names_from_data_
+0005da00: 6672 616d 6528 5b6d 6f64 5f6e 616d 655d  frame([mod_name]
+0005da10: 2c20 6a6d 6d2c 0a20 2020 2020 2020 2020  , jmm,.         
+0005da20: 2020 2065 7863 6c75 7369 6f6e 733d 5b27     exclusions=['
+0005da30: 556e 6e61 6d65 6427 2c22 4454 495f 4c52  Unnamed',"DTI_LR
+0005da40: 222c 2244 5449 5f52 4c22 2c22 7273 664d  ","DTI_RL","rsfM
+0005da50: 5249 5f52 4c22 2c22 7273 664d 5249 5f4c  RI_RL","rsfMRI_L
+0005da60: 5222 5d29 0a20 2020 2020 2020 2069 6620  R"]).        if 
+0005da70: 6c65 6e28 2066 6c5f 6e61 6d65 7320 2920  len( fl_names ) 
+0005da80: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
+0005da90: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+0005daa0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0005dab0: 6e74 286d 6f64 5f6e 616d 6529 0a20 2020  nt(mod_name).   
+0005dac0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0005dad0: 6e74 2866 6c5f 6e61 6d65 7329 0a20 2020  nt(fl_names).   
+0005dae0: 2020 2020 2020 2020 2066 6c5f 6964 203d           fl_id =
+0005daf0: 2066 6c5f 6e61 6d65 735b 305d 0a20 2020   fl_names[0].   
+0005db00: 2020 2020 2020 2020 206e 5f6e 616d 6573           n_names
+0005db10: 203d 206c 656e 2866 6c5f 6e61 6d65 7329   = len(fl_names)
+0005db20: 0a20 2020 2020 2020 2020 2020 206c 6f63  .            loc
+0005db30: 7665 6320 3d20 6a6d 6d5b 666c 5f6e 616d  vec = jmm[fl_nam
+0005db40: 6573 5b6e 5f6e 616d 6573 2d31 5d5d 2e61  es[n_names-1]].a
+0005db50: 7374 7970 6528 666c 6f61 7429 0a20 2020  stype(float).   
+0005db60: 2020 2020 2020 2020 2062 6f6f 6c76 6563           boolvec
+0005db70: 3d7e 7064 2e69 736e 6128 6c6f 6376 6563  =~pd.isna(locvec
+0005db80: 290a 2020 2020 2020 2020 2020 2020 6a6d  ).            jm
+0005db90: 6d73 7562 203d 206a 6d6d 5b62 6f6f 6c76  msub = jmm[boolv
+0005dba0: 6563 5d5b 205b 2775 5f68 6965 725f 6964  ec][ ['u_hier_id
+0005dbb0: 275d 2b66 6c5f 6e61 6d65 735d 0a20 2020  ']+fl_names].   
+0005dbc0: 2020 2020 2020 2020 206d 795f 7462 6c20           my_tbl 
+0005dbd0: 3d20 436f 756e 7465 7228 6a6d 6d73 7562  = Counter(jmmsub
+0005dbe0: 5b27 755f 6869 6572 5f69 6427 5d29 0a20  ['u_hier_id']). 
+0005dbf0: 2020 2020 2020 2020 2020 2067 746f 6176             gtoav
+0005dc00: 6720 3d20 5b6e 616d 6520 666f 7220 6e61  g = [name for na
+0005dc10: 6d65 2069 6e20 6d79 5f74 626c 2e6b 6579  me in my_tbl.key
+0005dc20: 7328 2920 6966 206d 795f 7462 6c5b 6e61  s() if my_tbl[na
+0005dc30: 6d65 5d20 3d3d 2031 5d0a 2020 2020 2020  me] == 1].      
+0005dc40: 2020 2020 2020 6774 6f61 7667 4731 203d        gtoavgG1 =
+0005dc50: 205b 6e61 6d65 2066 6f72 206e 616d 6520   [name for name 
+0005dc60: 696e 206d 795f 7462 6c2e 6b65 7973 2829  in my_tbl.keys()
+0005dc70: 2069 6620 6d79 5f74 626c 5b6e 616d 655d   if my_tbl[name]
+0005dc80: 203e 2031 5d0a 2020 2020 2020 2020 2020   > 1].          
+0005dc90: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+0005dca0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0005dcb0: 696e 7428 224a 6f69 6e20 3122 290a 2020  int("Join 1").  
+0005dcc0: 2020 2020 2020 2020 2020 6a6d 6d73 7562            jmmsub
+0005dcd0: 3120 3d20 6a6d 6d73 7562 2e6c 6f63 5b6a  1 = jmmsub.loc[j
+0005dce0: 6d6d 7375 625b 2775 5f68 6965 725f 6964  mmsub['u_hier_id
+0005dcf0: 275d 2e69 7369 6e28 6774 6f61 7667 295d  '].isin(gtoavg)]
+0005dd00: 5b5b 2775 5f68 6965 725f 6964 275d 2b66  [['u_hier_id']+f
+0005dd10: 6c5f 6e61 6d65 735d 0a20 2020 2020 2020  l_names].       
+0005dd20: 2020 2020 2066 6f72 2075 2069 6e20 6774       for u in gt
+0005dd30: 6f61 7667 3a0a 2020 2020 2020 2020 2020  oavg:.          
+0005dd40: 2020 2020 2020 6a6d 6d55 6e69 712e 6c6f        jmmUniq.lo
+0005dd50: 635b 755d 5b66 6c5f 6e61 6d65 735b 313a  c[u][fl_names[1:
+0005dd60: 5d5d 203d 206a 6d6d 7375 6231 2e6c 6f63  ]] = jmmsub1.loc
+0005dd70: 5b75 5d5b 666c 5f6e 616d 6573 5b31 3a5d  [u][fl_names[1:]
+0005dd80: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
+0005dd90: 2076 6572 626f 7365 2061 6e64 206c 656e   verbose and len
+0005dda0: 2867 746f 6176 6747 3129 203e 2031 3a0a  (gtoavgG1) > 1:.
+0005ddb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ddc0: 7072 696e 7428 224a 6f69 6e20 3e31 2229  print("Join >1")
+0005ddd0: 0a20 2020 2020 2020 2020 2020 206a 6d6d  .            jmm
+0005dde0: 7375 6247 3120 3d20 6a6d 6d73 7562 2e6c  subG1 = jmmsub.l
+0005ddf0: 6f63 5b6a 6d6d 7375 625b 2775 5f68 6965  oc[jmmsub['u_hie
+0005de00: 725f 6964 275d 2e69 7369 6e28 6774 6f61  r_id'].isin(gtoa
+0005de10: 7667 4731 295d 5b5b 2775 5f68 6965 725f  vgG1)][['u_hier_
+0005de20: 6964 275d 2b66 6c5f 6e61 6d65 735d 0a20  id']+fl_names]. 
+0005de30: 2020 2020 2020 2020 2020 2066 6f72 2075             for u
+0005de40: 2069 6e20 6774 6f61 7667 4731 3a0a 2020   in gtoavgG1:.  
+0005de50: 2020 2020 2020 2020 2020 2020 2020 7465                te
+0005de60: 6d70 203d 206a 6d6d 7375 6247 312e 6c6f  mp = jmmsubG1.lo
+0005de70: 635b 755d 5b20 5b27 755f 6869 6572 5f69  c[u][ ['u_hier_i
+0005de80: 6427 5d2b 666c 5f6e 616d 6573 205d 0a20  d']+fl_names ]. 
+0005de90: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0005dea0: 726f 706e 616d 6573 203d 2067 6574 5f6e  ropnames = get_n
+0005deb0: 616d 6573 5f66 726f 6d5f 6461 7461 5f66  ames_from_data_f
+0005dec0: 7261 6d65 2820 5b27 4d4d 2e49 4427 5d2c  rame( ['MM.ID'],
+0005ded0: 2074 656d 7020 290a 2020 2020 2020 2020   temp ).        
+0005dee0: 2020 2020 2020 2020 7465 6d70 5665 6320          tempVec 
+0005def0: 3d20 7465 6d70 2e64 726f 7028 636f 6c75  = temp.drop(colu
+0005df00: 6d6e 733d 6472 6f70 6e61 6d65 7329 0a20  mns=dropnames). 
+0005df10: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+0005df20: 6f69 6e44 6961 676e 6f73 7469 6373 4c6f  oinDiagnosticsLo
+0005df30: 6320 3d20 7064 2e44 6174 6146 7261 6d65  c = pd.DataFrame
+0005df40: 2820 636f 6c75 6d6e 7320 3d20 6478 636f  ( columns = dxco
+0005df50: 6c73 2c20 696e 6465 783d 7261 6e67 6528  ls, index=range(
+0005df60: 3129 2029 0a20 2020 2020 2020 2020 2020  1) ).           
+0005df70: 2020 2020 2069 6431 3d74 656d 705b 666c       id1=temp[fl
+0005df80: 5f69 645d 2e69 6c6f 635b 305d 0a20 2020  _id].iloc[0].   
+0005df90: 2020 2020 2020 2020 2020 2020 2069 6432               id2
+0005dfa0: 3d74 656d 705b 666c 5f69 645d 2e69 6c6f  =temp[fl_id].ilo
+0005dfb0: 635b 315d 0a20 2020 2020 2020 2020 2020  c[1].           
+0005dfc0: 2020 2020 2076 313d 7465 6d70 5665 632e       v1=tempVec.
+0005dfd0: 696c 6f63 5b30 5d5b 313a 5d2e 6173 7479  iloc[0][1:].asty
+0005dfe0: 7065 2866 6c6f 6174 292e 746f 5f6e 756d  pe(float).to_num
+0005dff0: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
+0005e000: 2020 2020 2076 323d 7465 6d70 5665 632e       v2=tempVec.
+0005e010: 696c 6f63 5b31 5d5b 313a 5d2e 6173 7479  iloc[1][1:].asty
+0005e020: 7065 2866 6c6f 6174 292e 746f 5f6e 756d  pe(float).to_num
+0005e030: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
+0005e040: 2020 2020 2069 6620 6c65 6e28 7632 2920       if len(v2) 
+0005e050: 3e20 6469 6167 6e6f 7374 6963 5f6e 3a0a  > diagnostic_n:.
+0005e060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e070: 2020 2020 7631 3d76 315b 303a 6469 6167      v1=v1[0:diag
+0005e080: 6e6f 7374 6963 5f6e 5d0a 2020 2020 2020  nostic_n].      
+0005e090: 2020 2020 2020 2020 2020 2020 2020 7632                v2
+0005e0a0: 3d76 325b 303a 6469 6167 6e6f 7374 6963  =v2[0:diagnostic
+0005e0b0: 5f6e 5d0a 2020 2020 2020 2020 2020 2020  _n].            
+0005e0c0: 2020 2020 6d79 636f 7272 203d 206e 702e      mycorr = np.
+0005e0d0: 636f 7272 636f 6566 2820 7631 2c20 7632  corrcoef( v1, v2
+0005e0e0: 2029 5b30 2c31 5d0a 2020 2020 2020 2020   )[0,1].        
+0005e0f0: 2020 2020 2020 2020 2320 6d79 636f 7272          # mycorr
+0005e100: 3d74 656d 7061 7272 5b6e 702e 7472 6975  =temparr[np.triu
+0005e110: 5f69 6e64 6963 6573 5f66 726f 6d28 7465  _indices_from(te
+0005e120: 6d70 6172 722c 206b 3d31 295d 2e6d 6561  mparr, k=1)].mea
+0005e130: 6e28 290a 2020 2020 2020 2020 2020 2020  n().            
+0005e140: 2020 2020 6d79 6572 723d 6e70 2e73 7172      myerr=np.sqr
+0005e150: 7428 6e70 2e6d 6561 6e28 2876 3120 2d20  t(np.mean((v1 - 
+0005e160: 7632 292a 2a32 2929 0a20 2020 2020 2020  v2)**2)).       
+0005e170: 2020 2020 2020 2020 206a 6f69 6e44 6961           joinDia
+0005e180: 676e 6f73 7469 6373 4c6f 632e 696c 6f63  gnosticsLoc.iloc
+0005e190: 5b30 5d20 3d20 5b69 6431 2c69 6432 2c6d  [0] = [id1,id2,m
+0005e1a0: 6f64 5f6e 616d 652c 2772 6f77 6176 6727  od_name,'rowavg'
+0005e1b0: 2c6d 7963 6f72 722c 6d79 6572 725d 0a20  ,mycorr,myerr]. 
+0005e1c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0005e1d0: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+0005e1e0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0005e1f0: 7269 6e74 2820 6a6f 696e 4469 6167 6e6f  rint( joinDiagno
+0005e200: 7374 6963 734c 6f63 2029 0a20 2020 2020  sticsLoc ).     
+0005e210: 2020 2020 2020 2020 2020 2074 656d 7020             temp 
+0005e220: 3d20 6a6d 6d73 7562 4731 2e6c 6f63 5b75  = jmmsubG1.loc[u
+0005e230: 5d5b 666c 5f6e 616d 6573 5b31 3a5d 5d2e  ][fl_names[1:]].
+0005e240: 6173 7479 7065 2866 6c6f 6174 290a 2020  astype(float).  
+0005e250: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0005e260: 206d 7963 6f72 7220 3e20 636f 7272 5f74   mycorr > corr_t
+0005e270: 6872 6573 6820 6f72 206c 656e 2820 7631  hresh or len( v1
+0005e280: 2029 203c 2031 303a 0a20 2020 2020 2020   ) < 10:.       
+0005e290: 2020 2020 2020 2020 2020 2020 206a 6d6d               jmm
+0005e2a0: 556e 6971 2e6c 6f63 5b75 5d5b 666c 5f6e  Uniq.loc[u][fl_n
+0005e2b0: 616d 6573 5b31 3a5d 5d20 3d20 7465 6d70  ames[1:]] = temp
+0005e2c0: 2e6d 6561 6e28 6178 6973 3d30 290a 2020  .mean(axis=0).  
+0005e2d0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0005e2e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0005e2f0: 2020 2020 2020 2020 6a6d 6d55 6e69 712e          jmmUniq.
+0005e300: 6c6f 635b 755d 5b66 6c5f 6e61 6d65 735b  loc[u][fl_names[
+0005e310: 313a 5d5d 203d 206e 616e 4c69 7374 202a  1:]] = nanList *
+0005e320: 2074 656d 702e 7368 6170 655b 315d 0a20   temp.shape[1]. 
+0005e330: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+0005e340: 6f69 6e44 6961 676e 6f73 7469 6373 203d  oinDiagnostics =
+0005e350: 2070 642e 636f 6e63 6174 2820 5b6a 6f69   pd.concat( [joi
+0005e360: 6e44 6961 676e 6f73 7469 6373 2c20 6a6f  nDiagnostics, jo
+0005e370: 696e 4469 6167 6e6f 7374 6963 734c 6f63  inDiagnosticsLoc
+0005e380: 5d2c 200a 2020 2020 2020 2020 2020 2020  ], .            
+0005e390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e3b0: 6178 6973 3d30 2c20 6967 6e6f 7265 5f69  axis=0, ignore_i
+0005e3c0: 6e64 6578 3d46 616c 7365 2029 0a0a 2020  ndex=False )..  
+0005e3d0: 2020 7265 7475 726e 206a 6d6d 556e 6971    return jmmUniq
+0005e3e0: 2c20 6a6d 6d2c 206a 6f69 6e44 6961 676e  , jmm, joinDiagn
+0005e3f0: 6f73 7469 6373 0a0a 0a0a 6465 6620 7175  ostics....def qu
+0005e400: 6963 6b5f 7669 7a5f 6d6d 5f6e 7267 280a  ick_viz_mm_nrg(.
+0005e410: 2020 2020 736f 7572 6365 6469 722c 2023      sourcedir, #
+0005e420: 2072 6f6f 7420 666f 6c64 6572 0a20 2020   root folder.   
+0005e430: 2070 726f 6a65 6374 6964 2c20 2320 7072   projectid, # pr
+0005e440: 6f6a 6563 7420 6e61 6d65 0a20 2020 2073  oject name.    s
+0005e450: 6964 202c 2023 2073 7562 6a65 6374 2075  id , # subject u
+0005e460: 6e69 7175 6520 6964 0a20 2020 2064 7469  nique id.    dti
+0005e470: 642c 2023 2064 6174 650a 2020 2020 6578  d, # date.    ex
+0005e480: 7472 6163 745f 6272 6169 6e3d 5472 7565  tract_brain=True
+0005e490: 2c0a 2020 2020 736c 6963 655f 6661 6374  ,.    slice_fact
+0005e4a0: 6f72 203d 2030 2e35 352c 0a20 2020 2073  or = 0.55,.    s
+0005e4b0: 686f 775f 6974 203d 204e 6f6e 652c 2023  how_it = None, #
+0005e4c0: 206f 7574 7075 7420 7061 7468 0a20 2020   output path.   
+0005e4d0: 2076 6572 626f 7365 203d 2054 7275 650a   verbose = True.
+0005e4e0: 293a 0a20 2020 2022 2222 0a20 2020 2054  ):.    """.    T
+0005e4f0: 6869 7320 6675 6e63 7469 6f6e 2063 7265  his function cre
+0005e500: 6174 6573 2076 6973 7561 6c69 7a61 7469  ates visualizati
+0005e510: 6f6e 7320 6f66 2062 7261 696e 2069 6d61  ons of brain ima
+0005e520: 6765 7320 666f 7220 6120 7370 6563 6966  ges for a specif
+0005e530: 6963 2073 7562 6a65 6374 2069 6e20 6120  ic subject in a 
+0005e540: 7072 6f6a 6563 7420 7573 696e 6720 414e  project using AN
+0005e550: 5473 5079 2e0a 0a20 2020 2041 7267 733a  TsPy...    Args:
+0005e560: 0a0a 2020 2020 736f 7572 6365 6469 7220  ..    sourcedir 
+0005e570: 2873 7472 293a 2052 6f6f 7420 666f 6c64  (str): Root fold
+0005e580: 6572 2e0a 2020 2020 0a20 2020 2070 726f  er..    .    pro
+0005e590: 6a65 6374 6964 2028 7374 7229 3a20 5072  jectid (str): Pr
+0005e5a0: 6f6a 6563 7420 6e61 6d65 2e0a 2020 2020  oject name..    
+0005e5b0: 0a20 2020 2073 6964 2028 7374 7229 3a20  .    sid (str): 
+0005e5c0: 5375 626a 6563 7420 756e 6971 7565 2069  Subject unique i
+0005e5d0: 642e 0a20 2020 200a 2020 2020 6474 6964  d..    .    dtid
+0005e5e0: 2028 7374 7229 3a20 4461 7465 2e0a 2020   (str): Date..  
+0005e5f0: 2020 0a20 2020 2065 7874 7261 6374 5f62    .    extract_b
+0005e600: 7261 696e 2028 626f 6f6c 293a 2049 6620  rain (bool): If 
+0005e610: 5472 7565 2c20 7468 6520 6675 6e63 7469  True, the functi
+0005e620: 6f6e 2065 7874 7261 6374 7320 7468 6520  on extracts the 
+0005e630: 6272 6169 6e20 6672 6f6d 2074 6865 2054  brain from the T
+0005e640: 3177 2069 6d61 6765 2e20 4465 6661 756c  1w image. Defaul
+0005e650: 7420 6973 2054 7275 652e 0a20 2020 200a  t is True..    .
+0005e660: 2020 2020 736c 6963 655f 6661 6374 6f72      slice_factor
+0005e670: 2028 666c 6f61 7429 3a20 5468 6520 736c   (float): The sl
+0005e680: 6963 6520 746f 2062 6520 7669 7375 616c  ice to be visual
+0005e690: 697a 6564 2069 7320 6465 7465 726d 696e  ized is determin
+0005e6a0: 6564 2062 7920 6d75 6c74 6970 6c79 696e  ed by multiplyin
+0005e6b0: 6720 7468 6520 696d 6167 6520 7369 7a65  g the image size
+0005e6c0: 2062 7920 7468 6973 2066 6163 746f 722e   by this factor.
+0005e6d0: 2044 6566 6175 6c74 2069 7320 302e 3535   Default is 0.55
+0005e6e0: 2e0a 2020 2020 0a20 2020 2073 686f 775f  ..    .    show_
+0005e6f0: 6974 2028 7374 7229 3a20 4f75 7470 7574  it (str): Output
+0005e700: 2070 6174 682e 2049 6620 6e6f 7420 4e6f   path. If not No
+0005e710: 6e65 2c20 7468 6520 7669 7375 616c 697a  ne, the visualiz
+0005e720: 6174 696f 6e73 2077 696c 6c20 6265 2073  ations will be s
+0005e730: 6176 6564 2061 7420 7468 6973 206c 6f63  aved at this loc
+0005e740: 6174 696f 6e2e 2044 6566 6175 6c74 2069  ation. Default i
+0005e750: 7320 4e6f 6e65 2e0a 2020 2020 0a20 2020  s None..    .   
+0005e760: 2076 6572 626f 7365 2028 626f 6f6c 293a   verbose (bool):
+0005e770: 2049 6620 5472 7565 2c20 696e 666f 726d   If True, inform
+0005e780: 6174 696f 6e20 7769 6c6c 2062 6520 7072  ation will be pr
+0005e790: 696e 7465 6420 7768 696c 6520 7275 6e6e  inted while runn
+0005e7a0: 696e 6720 7468 6520 6675 6e63 7469 6f6e  ing the function
+0005e7b0: 2e20 4465 6661 756c 7420 6973 2054 7275  . Default is Tru
+0005e7c0: 652e 0a0a 2020 2020 5265 7475 726e 733a  e...    Returns:
+0005e7d0: 0a20 2020 2076 697a 6c69 7374 2028 6c69  .    vizlist (li
+0005e7e0: 7374 293a 204c 6973 7420 6f66 2069 6d61  st): List of ima
+0005e7f0: 6765 2076 6973 7561 6c69 7a61 7469 6f6e  ge visualization
+0005e800: 732e 0a0a 2020 2020 2222 220a 2020 2020  s...    """.    
+0005e810: 6969 643d 272a 270a 2020 2020 696d 706f  iid='*'.    impo
+0005e820: 7274 2067 6c6f 6220 6173 2067 6c6f 620a  rt glob as glob.
+0005e830: 2020 2020 6672 6f6d 206f 732e 7061 7468      from os.path
+0005e840: 2069 6d70 6f72 7420 6578 6973 7473 0a20   import exists. 
+0005e850: 2020 2069 6d70 6f72 7420 616e 7473 0a20     import ants. 
+0005e860: 2020 2065 785f 7061 7468 203d 206f 732e     ex_path = os.
+0005e870: 7061 7468 2e65 7870 616e 6475 7365 7228  path.expanduser(
+0005e880: 2022 7e2f 2e61 6e74 7370 7974 3177 2f22   "~/.antspyt1w/"
+0005e890: 2029 0a20 2020 2065 785f 7061 7468 6d6d   ).    ex_pathmm
+0005e8a0: 203d 206f 732e 7061 7468 2e65 7870 616e   = os.path.expan
+0005e8b0: 6475 7365 7228 2022 7e2f 2e61 6e74 7370  duser( "~/.antsp
+0005e8c0: 796d 6d2f 2220 290a 2020 2020 7465 6d70  ymm/" ).    temp
+0005e8d0: 6c61 7465 666e 203d 2065 785f 7061 7468  latefn = ex_path
+0005e8e0: 202b 2027 4349 5431 3638 5f54 3177 5f37   + 'CIT168_T1w_7
+0005e8f0: 3030 756d 5f70 6164 5f61 646e 692e 6e69  00um_pad_adni.ni
+0005e900: 692e 677a 270a 2020 2020 6966 206e 6f74  i.gz'.    if not
+0005e910: 2065 7869 7374 7328 2074 656d 706c 6174   exists( templat
+0005e920: 6566 6e20 293a 0a20 2020 2020 2020 2070  efn ):.        p
+0005e930: 7269 6e74 2820 222a 2a6d 6973 7369 6e67  rint( "**missing
+0005e940: 2066 696c 6573 2a2a 203d 3e20 6361 6c6c   files** => call
+0005e950: 2067 6574 5f64 6174 6120 6672 6f6d 206c   get_data from l
+0005e960: 6174 6573 7420 616e 7473 7079 7431 7720  atest antspyt1w 
+0005e970: 616e 6420 616e 7473 7079 6d6d 2e22 2029  and antspymm." )
+0005e980: 0a20 2020 2020 2020 2061 6e74 7370 7974  .        antspyt
+0005e990: 3177 2e67 6574 5f64 6174 6128 2066 6f72  1w.get_data( for
+0005e9a0: 6365 5f64 6f77 6e6c 6f61 643d 5472 7565  ce_download=True
+0005e9b0: 2029 0a20 2020 2020 2020 2067 6574 5f64   ).        get_d
+0005e9c0: 6174 6128 2066 6f72 6365 5f64 6f77 6e6c  ata( force_downl
+0005e9d0: 6f61 643d 5472 7565 2029 0a20 2020 2074  oad=True ).    t
+0005e9e0: 656d 7020 3d20 736f 7572 6365 6469 722e  emp = sourcedir.
+0005e9f0: 7370 6c69 7428 2022 2f22 2029 0a20 2020  split( "/" ).   
+0005ea00: 2073 706c 6974 436f 756e 7420 3d20 6c65   splitCount = le
+0005ea10: 6e28 2074 656d 7020 290a 2020 2020 7465  n( temp ).    te
+0005ea20: 6d70 6c61 7465 203d 206d 6d5f 7265 6164  mplate = mm_read
+0005ea30: 2820 7465 6d70 6c61 7465 666e 2029 2023  ( templatefn ) #
+0005ea40: 2052 6561 6420 696e 2074 656d 706c 6174   Read in templat
+0005ea50: 650a 2020 2020 7375 626a 6563 7472 6f6f  e.    subjectroo
+0005ea60: 7470 6174 6820 3d20 6f73 2e70 6174 682e  tpath = os.path.
+0005ea70: 6a6f 696e 2873 6f75 7263 6564 6972 2c20  join(sourcedir, 
+0005ea80: 7072 6f6a 6563 7469 642c 2073 6964 2c20  projectid, sid, 
+0005ea90: 6474 6964 290a 2020 2020 6d79 696d 6773  dtid).    myimgs
+0005eaa0: 496e 7075 7420 3d20 676c 6f62 2e67 6c6f  Input = glob.glo
+0005eab0: 6228 2073 7562 6a65 6374 726f 6f74 7061  b( subjectrootpa
+0005eac0: 7468 2b22 2f2a 2220 290a 2020 2020 6d79  th+"/*" ).    my
+0005ead0: 696d 6773 496e 7075 742e 736f 7274 2820  imgsInput.sort( 
+0005eae0: 290a 2020 2020 6966 2076 6572 626f 7365  ).    if verbose
+0005eaf0: 3a0a 2020 2020 2020 2020 7072 696e 7428  :.        print(
+0005eb00: 206d 7969 6d67 7349 6e70 7574 2029 0a20   myimgsInput ). 
+0005eb10: 2020 2074 315f 7365 6172 6368 5f70 6174     t1_search_pat
+0005eb20: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
+0005eb30: 2873 7562 6a65 6374 726f 6f74 7061 7468  (subjectrootpath
+0005eb40: 2c20 2254 3177 222c 2022 2a22 2c20 222a  , "T1w", "*", "*
+0005eb50: 6e69 692e 677a 2229 0a20 2020 2069 6620  nii.gz").    if 
+0005eb60: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+0005eb70: 2070 7269 6e74 2866 2274 3120 7365 6172   print(f"t1 sear
+0005eb80: 6368 2070 6174 683a 207b 7431 5f73 6561  ch path: {t1_sea
+0005eb90: 7263 685f 7061 7468 7d22 290a 2020 2020  rch_path}").    
+0005eba0: 7431 666e 203d 2067 6c6f 622e 676c 6f62  t1fn = glob.glob
+0005ebb0: 2874 315f 7365 6172 6368 5f70 6174 6829  (t1_search_path)
+0005ebc0: 0a20 2020 2074 3166 6e2e 736f 7274 2829  .    t1fn.sort()
+0005ebd0: 0a20 2020 2069 6620 6c65 6e28 2074 3166  .    if len( t1f
+0005ebe0: 6e20 2920 3c20 313a 0a20 2020 2020 2020  n ) < 1:.       
+0005ebf0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+0005ec00: 7228 2771 7569 636b 5f76 697a 5f6d 6d5f  r('quick_viz_mm_
+0005ec10: 6e72 6720 6361 6e6e 6f74 2066 696e 6420  nrg cannot find 
+0005ec20: 7468 6520 5431 7720 4020 2720 2b20 7375  the T1w @ ' + su
+0005ec30: 626a 6563 7472 6f6f 7470 6174 6820 290a  bjectrootpath ).
+0005ec40: 2020 2020 7431 666e 203d 2074 3166 6e5b      t1fn = t1fn[
+0005ec50: 305d 0a20 2020 2074 3120 3d20 6d6d 5f72  0].    t1 = mm_r
+0005ec60: 6561 6428 2074 3166 6e20 290a 2020 2020  ead( t1fn ).    
+0005ec70: 6e69 6d61 6765 7320 3d20 6c65 6e28 6d79  nimages = len(my
+0005ec80: 696d 6773 496e 7075 7429 0a20 2020 2076  imgsInput).    v
+0005ec90: 697a 6c69 7374 3d5b 5d0a 2020 2020 6966  izlist=[].    if
+0005eca0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+0005ecb0: 2020 7072 696e 7428 2020 2220 7765 2068    print(  " we h
+0005ecc0: 6176 6520 3a20 2220 2b20 7374 7228 6e69  ave : " + str(ni
+0005ecd0: 6d61 6765 7329 202b 2022 206d 6f64 616c  mages) + " modal
+0005ece0: 6974 6965 732e 2020 7769 6c6c 2076 6973  ities.  will vis
+0005ecf0: 7561 6c69 7a65 2054 3120 4e4d 2072 7366  ualize T1 NM rsf
+0005ed00: 4d52 4920 4454 4942 3020 4454 4944 5749  MRI DTIB0 DTIDWI
+0005ed10: 2046 4c41 4952 2229 0a20 2020 2023 206e   FLAIR").    # n
+0005ed20: 7267 5f6d 6f64 616c 6974 795f 6c69 7374  rg_modality_list
+0005ed30: 203d 205b 2254 3177 222c 2022 4e4d 3244   = ["T1w", "NM2D
+0005ed40: 4d54 222c 2022 7273 664d 5249 222c 2272  MT", "rsfMRI","r
+0005ed50: 7366 4d52 495f 4c52 222c 2272 7366 4d52  sfMRI_LR","rsfMR
+0005ed60: 495f 524c 222c 2244 5449 222c 2244 5449  I_RL","DTI","DTI
+0005ed70: 5f4c 5222 2c20 2254 3246 6c61 6972 2220  _LR", "T2Flair" 
+0005ed80: 5d2c 0a20 2020 206e 7267 5f6d 6f64 616c  ],.    nrg_modal
+0005ed90: 6974 795f 6c69 7374 203d 205b 2027 5431  ity_list = [ 'T1
+0005eda0: 7727 2c20 274e 4d32 444d 5427 2c20 2772  w', 'NM2DMT', 'r
+0005edb0: 7366 4d52 4927 2c20 2744 5749 3127 2c20  sfMRI', 'DWI1', 
+0005edc0: 2744 5749 3227 2c20 2754 3246 6c61 6972  'DWI2', 'T2Flair
+0005edd0: 2720 5d0a 2020 2020 666f 7220 6e72 674e  ' ].    for nrgN
+0005ede0: 756d 2069 6e20 5b30 2c31 2c32 2c33 2c34  um in [0,1,2,3,4
+0005edf0: 2c35 5d3a 0a20 2020 2020 2020 206f 7665  ,5]:.        ove
+0005ee00: 726d 6f64 5820 3d20 6e72 675f 6d6f 6461  rmodX = nrg_moda
+0005ee10: 6c69 7479 5f6c 6973 745b 6e72 674e 756d  lity_list[nrgNum
+0005ee20: 5d0a 2020 2020 2020 2020 6966 206f 7665  ].        if ove
+0005ee30: 726d 6f64 5820 3d3d 2027 5431 7727 3a0a  rmodX == 'T1w':.
+0005ee40: 2020 2020 2020 2020 2020 2020 6d6f 645f              mod_
+0005ee50: 7365 6172 6368 5f70 6174 6820 3d20 6f73  search_path = os
+0005ee60: 2e70 6174 682e 6a6f 696e 2873 7562 6a65  .path.join(subje
+0005ee70: 6374 726f 6f74 7061 7468 2c20 6f76 6572  ctrootpath, over
+0005ee80: 6d6f 6458 2c20 6969 642c 2022 2a6e 6969  modX, iid, "*nii
+0005ee90: 2e67 7a22 290a 2020 2020 2020 2020 2020  .gz").          
+0005eea0: 2020 6d79 696d 6773 7220 3d20 676c 6f62    myimgsr = glob
+0005eeb0: 2e67 6c6f 6228 6d6f 645f 7365 6172 6368  .glob(mod_search
+0005eec0: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
+0005eed0: 2020 2069 6620 6c65 6e28 206d 7969 6d67     if len( myimg
+0005eee0: 7372 2029 203d 3d20 303a 0a20 2020 2020  sr ) == 0:.     
+0005eef0: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
+0005ef00: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
+0005ef10: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0005ef20: 2822 4e6f 2074 3120 696d 6167 6573 3a20  ("No t1 images: 
+0005ef30: 2220 2b20 7369 6420 2b20 6474 6964 2029  " + sid + dtid )
+0005ef40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005ef50: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
+0005ef60: 2020 2020 2020 2020 206d 7969 6d67 7372           myimgsr
+0005ef70: 2e73 6f72 7428 290a 2020 2020 2020 2020  .sort().        
+0005ef80: 2020 2020 6d79 696d 6773 723d 6d79 696d      myimgsr=myim
+0005ef90: 6773 725b 305d 0a20 2020 2020 2020 2020  gsr[0].         
+0005efa0: 2020 2076 696d 673d 616e 7473 2e69 6d61     vimg=ants.ima
+0005efb0: 6765 5f72 6561 6428 206d 7969 6d67 7372  ge_read( myimgsr
+0005efc0: 2029 0a20 2020 2020 2020 2065 6c69 6620   ).        elif 
+0005efd0: 6f76 6572 6d6f 6458 203d 3d20 2744 5749  overmodX == 'DWI
+0005efe0: 3127 3a0a 2020 2020 2020 2020 2020 2020  1':.            
+0005eff0: 6d6f 645f 7365 6172 6368 5f70 6174 6820  mod_search_path 
+0005f000: 3d20 6f73 2e70 6174 682e 6a6f 696e 2873  = os.path.join(s
+0005f010: 7562 6a65 6374 726f 6f74 7061 7468 2c20  ubjectrootpath, 
+0005f020: 2744 5449 2a27 2c20 222a 222c 2022 2a6e  'DTI*', "*", "*n
+0005f030: 6969 2e67 7a22 290a 2020 2020 2020 2020  ii.gz").        
+0005f040: 2020 2020 6d79 696d 6773 7220 3d20 676c      myimgsr = gl
+0005f050: 6f62 2e67 6c6f 6228 6d6f 645f 7365 6172  ob.glob(mod_sear
+0005f060: 6368 5f70 6174 6829 0a20 2020 2020 2020  ch_path).       
+0005f070: 2020 2020 2069 6620 6c65 6e28 206d 7969       if len( myi
+0005f080: 6d67 7372 2029 203e 2030 3a0a 2020 2020  mgsr ) > 0:.    
+0005f090: 2020 2020 2020 2020 2020 2020 6d79 696d              myim
+0005f0a0: 6773 722e 736f 7274 2829 0a20 2020 2020  gsr.sort().     
+0005f0b0: 2020 2020 2020 2020 2020 206d 7969 6d67             myimg
+0005f0c0: 7372 3d6d 7969 6d67 7372 5b30 5d0a 2020  sr=myimgsr[0].  
+0005f0d0: 2020 2020 2020 2020 2020 2020 2020 7669                vi
+0005f0e0: 6d67 3d61 6e74 732e 696d 6167 655f 7265  mg=ants.image_re
+0005f0f0: 6164 2820 6d79 696d 6773 7220 290a 2020  ad( myimgsr ).  
+0005f100: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0005f110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f120: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+0005f130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f140: 7072 696e 7428 224e 6f20 2220 2b20 6f76  print("No " + ov
+0005f150: 6572 6d6f 6458 290a 2020 2020 2020 2020  ermodX).        
+0005f160: 2020 2020 2020 2020 7669 6d67 203d 206e          vimg = n
+0005f170: 6f69 7a69 6d67 0a20 2020 2020 2020 2065  oizimg.        e
+0005f180: 6c69 6620 6f76 6572 6d6f 6458 203d 3d20  lif overmodX == 
+0005f190: 2744 5749 3227 3a0a 2020 2020 2020 2020  'DWI2':.        
+0005f1a0: 2020 2020 6d6f 645f 7365 6172 6368 5f70      mod_search_p
+0005f1b0: 6174 6820 3d20 6f73 2e70 6174 682e 6a6f  ath = os.path.jo
+0005f1c0: 696e 2873 7562 6a65 6374 726f 6f74 7061  in(subjectrootpa
+0005f1d0: 7468 2c20 2744 5449 2a27 2c20 222a 222c  th, 'DTI*', "*",
+0005f1e0: 2022 2a6e 6969 2e67 7a22 290a 2020 2020   "*nii.gz").    
+0005f1f0: 2020 2020 2020 2020 6d79 696d 6773 7220          myimgsr 
+0005f200: 3d20 676c 6f62 2e67 6c6f 6228 6d6f 645f  = glob.glob(mod_
+0005f210: 7365 6172 6368 5f70 6174 6829 0a20 2020  search_path).   
+0005f220: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+0005f230: 206d 7969 6d67 7372 2029 203e 2030 3a0a   myimgsr ) > 0:.
+0005f240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f250: 6d79 696d 6773 722e 736f 7274 2829 0a20  myimgsr.sort(). 
+0005f260: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0005f270: 7969 6d67 7372 3d6d 7969 6d67 7372 5b6c  yimgsr=myimgsr[l
+0005f280: 656e 286d 7969 6d67 7372 292d 315d 0a20  en(myimgsr)-1]. 
+0005f290: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+0005f2a0: 696d 673d 616e 7473 2e69 6d61 6765 5f72  img=ants.image_r
+0005f2b0: 6561 6428 206d 7969 6d67 7372 2029 0a20  ead( myimgsr ). 
+0005f2c0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0005f2d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005f2e0: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+0005f2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f300: 2070 7269 6e74 2822 4e6f 2022 202b 206f   print("No " + o
+0005f310: 7665 726d 6f64 5829 0a20 2020 2020 2020  vermodX).       
+0005f320: 2020 2020 2020 2020 2076 696d 6720 3d20           vimg = 
+0005f330: 6e6f 697a 696d 670a 2020 2020 2020 2020  noizimg.        
+0005f340: 656c 6966 206f 7665 726d 6f64 5820 3d3d  elif overmodX ==
+0005f350: 2027 4e4d 3244 4d54 273a 0a20 2020 2020   'NM2DMT':.     
+0005f360: 2020 2020 2020 206d 6f64 5f73 6561 7263         mod_searc
+0005f370: 685f 7061 7468 203d 206f 732e 7061 7468  h_path = os.path
+0005f380: 2e6a 6f69 6e28 7375 626a 6563 7472 6f6f  .join(subjectroo
+0005f390: 7470 6174 682c 206f 7665 726d 6f64 582c  tpath, overmodX,
+0005f3a0: 2022 2a22 2c20 222a 6e69 692e 677a 2229   "*", "*nii.gz")
+0005f3b0: 0a20 2020 2020 2020 2020 2020 206d 7969  .            myi
+0005f3c0: 6d67 7372 203d 2067 6c6f 622e 676c 6f62  mgsr = glob.glob
+0005f3d0: 286d 6f64 5f73 6561 7263 685f 7061 7468  (mod_search_path
+0005f3e0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0005f3f0: 206c 656e 2820 6d79 696d 6773 7220 2920   len( myimgsr ) 
+0005f400: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
+0005f410: 2020 2020 206d 7969 6d67 7372 2e73 6f72       myimgsr.sor
+0005f420: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+0005f430: 2020 2020 6d79 696d 6773 7230 3d6d 7969      myimgsr0=myi
+0005f440: 6d67 7372 5b30 5d0a 2020 2020 2020 2020  mgsr[0].        
+0005f450: 2020 2020 2020 2020 7669 6d67 3d61 6e74          vimg=ant
+0005f460: 732e 696d 6167 655f 7265 6164 2820 6d79  s.image_read( my
+0005f470: 696d 6773 7230 2029 0a20 2020 2020 2020  imgsr0 ).       
+0005f480: 2020 2020 2020 2020 2066 6f72 206b 2069           for k i
+0005f490: 6e20 7261 6e67 6528 312c 6c65 6e28 6d79  n range(1,len(my
+0005f4a0: 696d 6773 7229 293a 0a20 2020 2020 2020  imgsr)):.       
+0005f4b0: 2020 2020 2020 2020 2020 2020 2074 656d               tem
+0005f4c0: 7020 3d20 616e 7473 2e69 6d61 6765 5f72  p = ants.image_r
+0005f4d0: 6561 6428 206d 7969 6d67 7372 5b6b 5d29  ead( myimgsr[k])
+0005f4e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005f4f0: 2020 2020 2076 696d 673d 7669 6d67 2b61       vimg=vimg+a
+0005f500: 6e74 732e 7265 7361 6d70 6c65 5f69 6d61  nts.resample_ima
+0005f510: 6765 5f74 6f5f 7461 7267 6574 2874 656d  ge_to_target(tem
+0005f520: 702c 7669 6d67 290a 2020 2020 2020 2020  p,vimg).        
+0005f530: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0005f540: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+0005f550: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+0005f560: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0005f570: 224e 6f20 2220 2b20 6f76 6572 6d6f 6458  "No " + overmodX
+0005f580: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0005f590: 2020 7669 6d67 203d 206e 6f69 7a69 6d67    vimg = noizimg
+0005f5a0: 0a20 2020 2020 2020 2065 6c69 6620 6f76  .        elif ov
+0005f5b0: 6572 6d6f 6458 203d 3d20 2772 7366 4d52  ermodX == 'rsfMR
+0005f5c0: 4927 3a0a 2020 2020 2020 2020 2020 2020  I':.            
+0005f5d0: 6d6f 645f 7365 6172 6368 5f70 6174 6820  mod_search_path 
+0005f5e0: 3d20 6f73 2e70 6174 682e 6a6f 696e 2873  = os.path.join(s
+0005f5f0: 7562 6a65 6374 726f 6f74 7061 7468 2c20  ubjectrootpath, 
+0005f600: 2772 7366 4d52 492a 272c 2022 2a22 2c20  'rsfMRI*', "*", 
+0005f610: 222a 6e69 692e 677a 2229 0a20 2020 2020  "*nii.gz").     
+0005f620: 2020 2020 2020 206d 7969 6d67 7372 203d         myimgsr =
+0005f630: 2067 6c6f 622e 676c 6f62 286d 6f64 5f73   glob.glob(mod_s
+0005f640: 6561 7263 685f 7061 7468 290a 2020 2020  earch_path).    
+0005f650: 2020 2020 2020 2020 6966 206c 656e 2820          if len( 
+0005f660: 6d79 696d 6773 7220 2920 3e20 303a 0a20  myimgsr ) > 0:. 
+0005f670: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0005f680: 7969 6d67 7372 2e73 6f72 7428 290a 2020  yimgsr.sort().  
+0005f690: 2020 2020 2020 2020 2020 2020 2020 6d79                my
+0005f6a0: 696d 6773 723d 6d79 696d 6773 725b 305d  imgsr=myimgsr[0]
+0005f6b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005f6c0: 2076 696d 673d 6d6d 5f72 6561 645f 746f   vimg=mm_read_to
+0005f6d0: 5f33 6428 206d 7969 6d67 7372 2029 0a20  _3d( myimgsr ). 
+0005f6e0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0005f6f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005f700: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+0005f710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f720: 2070 7269 6e74 2822 4e6f 2022 202b 206f   print("No " + o
+0005f730: 7665 726d 6f64 5829 0a20 2020 2020 2020  vermodX).       
+0005f740: 2020 2020 2020 2020 2076 696d 6720 3d20           vimg = 
+0005f750: 6e6f 697a 696d 670a 2020 2020 2020 2020  noizimg.        
+0005f760: 656c 7365 203a 0a20 2020 2020 2020 2020  else :.         
+0005f770: 2020 206d 6f64 5f73 6561 7263 685f 7061     mod_search_pa
+0005f780: 7468 203d 206f 732e 7061 7468 2e6a 6f69  th = os.path.joi
+0005f790: 6e28 7375 626a 6563 7472 6f6f 7470 6174  n(subjectrootpat
+0005f7a0: 682c 206f 7665 726d 6f64 582c 2022 2a22  h, overmodX, "*"
+0005f7b0: 2c20 222a 6e69 692e 677a 2229 0a20 2020  , "*nii.gz").   
+0005f7c0: 2020 2020 2020 2020 206d 7969 6d67 7372           myimgsr
+0005f7d0: 203d 2067 6c6f 622e 676c 6f62 286d 6f64   = glob.glob(mod
+0005f7e0: 5f73 6561 7263 685f 7061 7468 290a 2020  _search_path).  
+0005f7f0: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+0005f800: 2820 6d79 696d 6773 7220 2920 3e20 303a  ( myimgsr ) > 0:
+0005f810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005f820: 206d 7969 6d67 7372 2e73 6f72 7428 290a   myimgsr.sort().
+0005f830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f840: 6d79 696d 6773 723d 6d79 696d 6773 725b  myimgsr=myimgsr[
+0005f850: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
+0005f860: 2020 2076 696d 673d 616e 7473 2e69 6d61     vimg=ants.ima
+0005f870: 6765 5f72 6561 6428 206d 7969 6d67 7372  ge_read( myimgsr
+0005f880: 2029 0a20 2020 2020 2020 2020 2020 2065   ).            e
+0005f890: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0005f8a0: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
+0005f8b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005f8c0: 2020 2020 2070 7269 6e74 2822 4e6f 2022       print("No "
+0005f8d0: 202b 206f 7665 726d 6f64 5829 0a20 2020   + overmodX).   
+0005f8e0: 2020 2020 2020 2020 2020 2020 2076 696d               vim
+0005f8f0: 6720 3d20 6e6f 697a 696d 670a 2020 2020  g = noizimg.    
+0005f900: 2020 2020 6966 2054 7275 653a 0a20 2020      if True:.   
+0005f910: 2020 2020 2020 2020 2069 6620 6578 7472           if extr
+0005f920: 6163 745f 6272 6169 6e20 616e 6420 6f76  act_brain and ov
+0005f930: 6572 6d6f 6458 203d 3d20 2754 3177 273a  ermodX == 'T1w':
+0005f940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005f950: 2076 696d 6720 3d20 7669 6d67 202a 2061   vimg = vimg * a
+0005f960: 6e74 7370 7974 3177 2e62 7261 696e 5f65  ntspyt1w.brain_e
+0005f970: 7874 7261 6374 696f 6e28 7669 6d67 290a  xtraction(vimg).
+0005f980: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+0005f990: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+0005f9a0: 2020 2020 2020 2020 7072 696e 7428 6622          print(f"
+0005f9b0: 6d6f 6461 6c69 7479 2073 6561 7263 6820  modality search 
+0005f9c0: 7061 7468 3a20 7b6d 7969 6d67 7372 7d22  path: {myimgsr}"
+0005f9d0: 202b 2022 206e 756d 3a20 2220 2b20 7374   + " num: " + st
+0005f9e0: 7228 6e72 674e 756d 2929 0a20 2020 2020  r(nrgNum)).     
+0005f9f0: 2020 2020 2020 2069 6620 6c65 6e28 2076         if len( v
+0005fa00: 696d 672e 7368 6170 6520 2920 3d3d 2034  img.shape ) == 4
+0005fa10: 2061 6e64 2028 206f 7665 726d 6f64 5820   and ( overmodX 
+0005fa20: 3d3d 2022 4457 4932 2220 2029 3a0a 2020  == "DWI2"  ):.  
+0005fa30: 2020 2020 2020 2020 2020 2020 2020 7474                tt
+0005fa40: 6230 2c20 7474 6477 3d67 6574 5f61 7665  b0, ttdw=get_ave
+0005fa50: 7261 6765 5f64 7769 5f62 3028 7669 6d67  rage_dwi_b0(vimg
+0005fa60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0005fa70: 2020 7669 6d67 203d 2074 7464 770a 2020    vimg = ttdw.  
+0005fa80: 2020 2020 2020 2020 2020 656c 6966 206c            elif l
+0005fa90: 656e 2820 7669 6d67 2e73 6861 7065 2029  en( vimg.shape )
+0005faa0: 203d 3d20 3420 616e 6420 6f76 6572 6d6f   == 4 and overmo
+0005fab0: 6458 203d 3d20 2244 5749 3122 3a0a 2020  dX == "DWI1":.  
+0005fac0: 2020 2020 2020 2020 2020 2020 2020 7474                tt
+0005fad0: 6230 2c20 7474 6477 3d67 6574 5f61 7665  b0, ttdw=get_ave
+0005fae0: 7261 6765 5f64 7769 5f62 3028 7669 6d67  rage_dwi_b0(vimg
+0005faf0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0005fb00: 2020 7669 6d67 203d 2074 7462 300a 2020    vimg = ttb0.  
+0005fb10: 2020 2020 2020 2020 2020 656c 6966 206c            elif l
+0005fb20: 656e 2820 7669 6d67 2e73 6861 7065 2029  en( vimg.shape )
+0005fb30: 203d 3d20 3420 3a0a 2020 2020 2020 2020   == 4 :.        
+0005fb40: 2020 2020 2020 2020 7669 6d67 3d61 6e74          vimg=ant
+0005fb50: 732e 6765 745f 6176 6572 6167 655f 6f66  s.get_average_of
+0005fb60: 5f74 696d 6573 6572 6965 7328 7669 6d67  _timeseries(vimg
+0005fb70: 290a 2020 2020 2020 2020 2020 2020 6d73  ).            ms
+0005fb80: 6b3d 616e 7473 2e67 6574 5f6d 6173 6b28  k=ants.get_mask(
+0005fb90: 7669 6d67 290a 2020 2020 2020 2020 2020  vimg).          
+0005fba0: 2020 7669 6d67 3d61 6e74 732e 6372 6f70    vimg=ants.crop
+0005fbb0: 5f69 6d61 6765 2876 696d 672c 6d73 6b29  _image(vimg,msk)
+0005fbc0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0005fbd0: 6f76 6572 6d6f 6458 203d 3d20 2754 3177  overmodX == 'T1w
+0005fbe0: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+0005fbf0: 2020 2072 6566 696d 673d 616e 7473 2e69     refimg=ants.i
+0005fc00: 6d61 6765 5f63 6c6f 6e65 2820 7669 6d67  mage_clone( vimg
+0005fc10: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0005fc20: 2020 206e 6f69 7a69 6d67 203d 2061 6e74     noizimg = ant
+0005fc30: 732e 6164 645f 6e6f 6973 655f 746f 5f69  s.add_noise_to_i
+0005fc40: 6d61 6765 2820 7265 6669 6d67 2a30 2c20  mage( refimg*0, 
+0005fc50: 2761 6464 6974 6976 6567 6175 7373 6961  'additivegaussia
+0005fc60: 6e27 2c20 5b31 3030 2c31 5d20 290a 2020  n', [100,1] ).  
+0005fc70: 2020 2020 2020 2020 2020 2020 2020 7669                vi
+0005fc80: 7a6c 6973 742e 6170 7065 6e64 2820 7669  zlist.append( vi
+0005fc90: 6d67 2029 0a20 2020 2020 2020 2020 2020  mg ).           
+0005fca0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0005fcb0: 2020 2020 2020 2076 696d 6720 3d20 616e         vimg = an
+0005fcc0: 7473 2e72 6573 616d 706c 655f 696d 6167  ts.resample_imag
+0005fcd0: 655f 746f 5f74 6172 6765 7428 2076 696d  e_to_target( vim
+0005fce0: 672c 2072 6566 696d 6720 290a 2020 2020  g, refimg ).    
+0005fcf0: 2020 2020 2020 2020 2020 2020 7669 6d67              vimg
+0005fd00: 203d 2061 6e74 732e 694d 6174 6828 2076   = ants.iMath( v
+0005fd10: 696d 672c 2027 5472 756e 6361 7465 496e  img, 'TruncateIn
+0005fd20: 7465 6e73 6974 7927 2c30 2e30 312c 302e  tensity',0.01,0.
+0005fd30: 3938 290a 2020 2020 2020 2020 2020 2020  98).            
+0005fd40: 2020 2020 7669 7a6c 6973 742e 6170 7065      vizlist.appe
+0005fd50: 6e64 2820 616e 7473 2e69 4d61 7468 2820  nd( ants.iMath( 
+0005fd60: 7669 6d67 2c20 274e 6f72 6d61 6c69 7a65  vimg, 'Normalize
+0005fd70: 2720 2920 2a20 3235 3520 290a 0a20 2020  ' ) * 255 )..   
+0005fd80: 206c 6973 746c 656e 203d 206c 656e 2820   listlen = len( 
+0005fd90: 7669 7a6c 6973 7420 290a 2020 2020 7669  vizlist ).    vi
+0005fda0: 7a6c 6973 7420 3d20 6e70 2e61 7361 7272  zlist = np.asarr
+0005fdb0: 6179 2820 7669 7a6c 6973 7420 290a 2020  ay( vizlist ).  
+0005fdc0: 2020 6966 2073 686f 775f 6974 2069 7320    if show_it is 
+0005fdd0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0005fde0: 2020 6669 6c65 6e61 6d65 6f75 743d 4e6f    filenameout=No
+0005fdf0: 6e65 0a20 2020 2020 2020 2069 6620 7665  ne.        if ve
+0005fe00: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
+0005fe10: 2020 2070 7269 6e74 2820 7368 6f77 5f69     print( show_i
+0005fe20: 7420 290a 2020 2020 2020 2020 666f 7220  t ).        for 
+0005fe30: 6120 696e 205b 302c 312c 325d 3a0a 2020  a in [0,1,2]:.  
+0005fe40: 2020 2020 2020 2020 2020 6e3d 696e 7428            n=int(
+0005fe50: 6e70 2e72 6f75 6e64 2820 7265 6669 6d67  np.round( refimg
+0005fe60: 2e73 6861 7065 5b61 5d20 2a20 736c 6963  .shape[a] * slic
+0005fe70: 655f 6661 6374 6f72 2029 290a 2020 2020  e_factor )).    
+0005fe80: 2020 2020 2020 2020 736c 6963 6573 3d6e          slices=n
+0005fe90: 702e 7265 7065 6174 2820 696e 7428 6e29  p.repeat( int(n)
+0005fea0: 2c20 6c69 7374 6c65 6e20 2029 0a20 2020  , listlen  ).   
+0005feb0: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+0005fec0: 7374 616e 6365 2873 686f 775f 6974 2c73  stance(show_it,s
+0005fed0: 7472 293a 0a20 2020 2020 2020 2020 2020  tr):.           
+0005fee0: 2020 2020 2066 696c 656e 616d 656f 7574       filenameout
+0005fef0: 3d73 686f 775f 6974 2b27 5f61 7827 2b73  =show_it+'_ax'+s
+0005ff00: 7472 2869 6e74 2861 2929 2b27 5f73 6c27  tr(int(a))+'_sl'
+0005ff10: 2b73 7472 286e 292b 272e 706e 6727 0a20  +str(n)+'.png'. 
+0005ff20: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0005ff30: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+0005ff40: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0005ff50: 7269 6e74 2820 6669 6c65 6e61 6d65 6f75  rint( filenameou
+0005ff60: 7420 290a 2020 2020 2020 2020 2020 2020  t ).            
+0005ff70: 616e 7473 2e70 6c6f 745f 6772 6964 2876  ants.plot_grid(v
+0005ff80: 697a 6c69 7374 2e72 6573 6861 7065 2832  izlist.reshape(2
+0005ff90: 2c33 292c 2073 6c69 6365 732e 7265 7368  ,3), slices.resh
+0005ffa0: 6170 6528 322c 3329 2c20 7469 746c 653d  ape(2,3), title=
+0005ffb0: 274d 4d20 5375 626a 6563 7420 2720 2b20  'MM Subject ' + 
+0005ffc0: 7369 6420 2b20 2720 2720 2b20 6474 6964  sid + ' ' + dtid
+0005ffd0: 2c20 7266 6163 6563 6f6c 6f72 3d27 7768  , rfacecolor='wh
+0005ffe0: 6974 6527 2c20 6178 6573 3d61 2c20 6669  ite', axes=a, fi
+0005fff0: 6c65 6e61 6d65 3d66 696c 656e 616d 656f  lename=filenameo
+00060000: 7574 2029 0a20 2020 2069 6620 7665 7262  ut ).    if verb
+00060010: 6f73 653a 0a20 2020 2020 2020 2070 7269  ose:.        pri
+00060020: 6e74 2822 7669 7a20 636f 6d70 6c65 7465  nt("viz complete
+00060030: 2e22 290a 2020 2020 7265 7475 726e 2076  .").    return v
+00060040: 697a 6c69 7374 0a0a 0a64 6566 2062 6c69  izlist...def bli
+00060050: 6e64 5f69 6d61 6765 5f61 7373 6573 736d  nd_image_assessm
+00060060: 656e 7428 0a20 2020 2069 6d61 6765 2c0a  ent(.    image,.
+00060070: 2020 2020 7669 7a5f 6669 6c65 6e61 6d65      viz_filename
+00060080: 3d4e 6f6e 652c 0a20 2020 2074 6974 6c65  =None,.    title
+00060090: 3d46 616c 7365 2c0a 2020 2020 7075 6c6c  =False,.    pull
+000600a0: 5f72 616e 6b3d 4661 6c73 652c 0a20 2020  _rank=False,.   
+000600b0: 2072 6573 616d 706c 653d 4e6f 6e65 2c0a   resample=None,.
+000600c0: 2020 2020 6e5f 746f 5f73 6b69 7020 3d20      n_to_skip = 
+000600d0: 3130 2c0a 2020 2020 7665 7262 6f73 653d  10,.    verbose=
+000600e0: 4661 6c73 650a 293a 0a20 2020 2022 2222  False.):.    """
+000600f0: 0a20 2020 2071 7569 636b 2062 6c69 6e64  .    quick blind
+00060100: 2069 6d61 6765 2061 7373 6573 736d 656e   image assessmen
+00060110: 7420 616e 6420 7472 6970 6c61 6e61 7220  t and triplanar 
+00060120: 7669 7375 616c 697a 6174 696f 6e20 6f66  visualization of
+00060130: 2061 6e20 696d 6167 6520 2e2e 2e20 3444   an image ... 4D
+00060140: 2069 6e70 7574 2077 696c 6c20 6265 2076   input will be v
+00060150: 6973 7561 6c69 7a65 6420 616e 6420 6173  isualized and as
+00060160: 7365 7373 6564 2069 6e20 3344 2e20 2070  sessed in 3D.  p
+00060170: 726f 6475 6365 7320 6120 706e 6720 616e  roduces a png an
+00060180: 6420 6373 7620 7768 6572 6520 6373 7620  d csv where csv 
+00060190: 636f 6e74 6169 6e73 3a0a 0a20 2020 202a  contains:..    *
+000601a0: 2072 6566 6c65 6374 696f 6e20 6572 726f   reflection erro
+000601b0: 7220 2820 6573 7469 6d61 7465 7320 6173  r ( estimates as
+000601c0: 796d 6d65 7472 7920 290a 0a20 2020 202a  ymmetry )..    *
+000601d0: 2062 7269 7371 2028 2062 6c69 6e64 2071   brisq ( blind q
+000601e0: 7561 6c69 7479 2061 7373 6573 736d 656e  uality assessmen
+000601f0: 7420 290a 0a20 2020 202a 2070 6174 6368  t )..    * patch
+00060200: 2065 6967 656e 7661 6c75 6520 7261 7469   eigenvalue rati
+00060210: 6f20 2820 626c 696e 6420 7175 616c 6974  o ( blind qualit
+00060220: 7920 6173 7365 7373 6d65 6e74 2029 0a0a  y assessment )..
+00060230: 2020 2020 2a20 5053 4e52 2061 6e64 2053      * PSNR and S
+00060240: 5349 4d20 7673 2061 2073 6d6f 6f74 6865  SIM vs a smoothe
+00060250: 6420 7265 6665 7265 6e63 6520 2834 4420  d reference (4D 
+00060260: 6f72 2033 4420 6170 7072 6f70 7269 6174  or 3D appropriat
+00060270: 6529 0a0a 2020 2020 2a20 6d61 736b 2076  e)..    * mask v
+00060280: 6f6c 756d 6520 2820 6573 7469 6d61 7465  olume ( estimate
+00060290: 7320 666f 7265 6772 6f75 6e64 206f 626a  s foreground obj
+000602a0: 6563 7420 7369 7a65 2029 0a0a 2020 2020  ect size )..    
+000602b0: 2a20 7370 6163 696e 670a 0a20 2020 202a  * spacing..    *
+000602c0: 2064 696d 656e 7369 6f6e 2061 6674 6572   dimension after
+000602d0: 2063 726f 7070 696e 6720 6279 206d 6173   cropping by mas
+000602e0: 6b0a 0a20 2020 2069 6d61 6765 203a 2063  k..    image : c
+000602f0: 6861 7261 6374 6572 206f 7220 696d 6167  haracter or imag
+00060300: 6520 6f62 6a65 6374 2075 7375 616c 6c79  e object usually
+00060310: 2061 206e 6966 7469 2069 6d61 6765 0a0a   a nifti image..
+00060320: 2020 2020 7669 7a5f 6669 6c65 6e61 6d65      viz_filename
+00060330: 203a 2063 6861 7261 6374 6572 2066 6f72   : character for
+00060340: 2061 2070 6e67 206f 7574 7075 7420 696d   a png output im
+00060350: 6167 650a 0a20 2020 2074 6974 6c65 203a  age..    title :
+00060360: 2064 6973 706c 6179 2061 2073 756d 6d61   display a summa
+00060370: 7279 2074 6974 6c65 206f 6e20 7468 6520  ry title on the 
+00060380: 706e 670a 0a20 2020 2070 756c 6c5f 7261  png..    pull_ra
+00060390: 6e6b 203a 2062 6f6f 6c65 616e 0a0a 2020  nk : boolean..  
+000603a0: 2020 7265 7361 6d70 6c65 203a 204e 6f6e    resample : Non
+000603b0: 652c 206e 756d 6572 6963 206d 6178 206f  e, numeric max o
+000603c0: 7220 6d69 6e2c 2072 6573 616d 706c 6573  r min, resamples
+000603d0: 2069 6d61 6765 2074 6f20 6973 6f74 726f   image to isotro
+000603e0: 7079 0a0a 2020 2020 6e5f 746f 5f73 6b69  py..    n_to_ski
+000603f0: 7020 3a20 3130 2062 7920 6465 6661 756c  p : 10 by defaul
+00060400: 743b 2073 616d 706c 6573 2074 696d 6520  t; samples time 
+00060410: 7365 7269 6573 2065 7665 7279 206e 5f74  series every n_t
+00060420: 6f5f 736b 6970 2076 6f6c 756d 650a 0a20  o_skip volume.. 
+00060430: 2020 2076 6572 626f 7365 203a 2062 6f6f     verbose : boo
+00060440: 6c65 616e 0a0a 2020 2020 2222 220a 2020  lean..    """.  
+00060450: 2020 696d 706f 7274 2067 6c6f 6220 6173    import glob as
+00060460: 2067 6c6f 620a 2020 2020 6672 6f6d 206f   glob.    from o
+00060470: 732e 7061 7468 2069 6d70 6f72 7420 6578  s.path import ex
+00060480: 6973 7473 0a20 2020 2069 6d70 6f72 7420  ists.    import 
+00060490: 616e 7473 0a20 2020 2069 6d70 6f72 7420  ants.    import 
+000604a0: 6d61 7470 6c6f 746c 6962 2e70 7970 6c6f  matplotlib.pyplo
+000604b0: 7420 6173 2070 6c74 0a20 2020 2066 726f  t as plt.    fro
+000604c0: 6d20 5049 4c20 696d 706f 7274 2049 6d61  m PIL import Ima
+000604d0: 6765 0a20 2020 2066 726f 6d20 7061 7468  ge.    from path
+000604e0: 6c69 6220 696d 706f 7274 2050 6174 680a  lib import Path.
+000604f0: 2020 2020 696d 706f 7274 206a 736f 6e0a      import json.
+00060500: 2020 2020 696d 706f 7274 2072 650a 2020      import re.  
+00060510: 2020 6672 6f6d 2064 6970 792e 696f 2e67    from dipy.io.g
+00060520: 7261 6469 656e 7473 2069 6d70 6f72 7420  radients import 
+00060530: 7265 6164 5f62 7661 6c73 5f62 7665 6373  read_bvals_bvecs
+00060540: 0a20 2020 206d 7973 7465 6d3d 2727 0a20  .    mystem=''. 
+00060550: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00060560: 2869 6d61 6765 2c6c 6973 7429 3a0a 2020  (image,list):.  
+00060570: 2020 2020 2020 6973 6669 6c65 6e61 6d65        isfilename
+00060580: 3d69 7369 6e73 7461 6e63 6528 2069 6d61  =isinstance( ima
+00060590: 6765 5b30 5d2c 2073 7472 290a 2020 2020  ge[0], str).    
+000605a0: 2020 2020 696d 6167 6520 3d20 696d 6167      image = imag
+000605b0: 655b 305d 0a20 2020 2065 6c73 653a 0a20  e[0].    else:. 
+000605c0: 2020 2020 2020 2069 7366 696c 656e 616d         isfilenam
+000605d0: 653d 6973 696e 7374 616e 6365 2820 696d  e=isinstance( im
+000605e0: 6167 652c 2073 7472 290a 2020 2020 6f75  age, str).    ou
+000605f0: 7464 6620 3d20 7064 2e44 6174 6146 7261  tdf = pd.DataFra
+00060600: 6d65 2829 0a20 2020 206d 796d 6574 6120  me().    mymeta 
+00060610: 3d20 4e6f 6e65 0a20 2020 204d 6167 6e65  = None.    Magne
+00060620: 7469 6346 6965 6c64 5374 7265 6e67 7468  ticFieldStrength
+00060630: 203d 204e 6f6e 650a 2020 2020 696d 6167   = None.    imag
+00060640: 655f 6669 6c65 6e61 6d65 3d27 270a 2020  e_filename=''.  
+00060650: 2020 6966 2069 7366 696c 656e 616d 653a    if isfilename:
+00060660: 0a20 2020 2020 2020 2069 6d61 6765 5f66  .        image_f
+00060670: 696c 656e 616d 6520 3d20 696d 6167 650a  ilename = image.
+00060680: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00060690: 7461 6e63 6528 696d 6167 652c 6c69 7374  tance(image,list
+000606a0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+000606b0: 6d61 6765 5f66 696c 656e 616d 653d 696d  mage_filename=im
+000606c0: 6167 655b 305d 0a20 2020 2020 2020 206a  age[0].        j
+000606d0: 736f 6e5f 6e61 6d65 203d 2072 652e 7375  son_name = re.su
+000606e0: 6228 222e 6e69 692e 677a 222c 222e 6a73  b(".nii.gz",".js
+000606f0: 6f6e 222c 696d 6167 655f 6669 6c65 6e61  on",image_filena
+00060700: 6d65 290a 2020 2020 2020 2020 6966 2065  me).        if e
+00060710: 7869 7374 7328 206a 736f 6e5f 6e61 6d65  xists( json_name
+00060720: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+00060730: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00060740: 2020 2020 2077 6974 6820 6f70 656e 286a       with open(j
+00060750: 736f 6e5f 6e61 6d65 2c20 2772 2729 2061  son_name, 'r') a
+00060760: 7320 6663 635f 6669 6c65 3a0a 2020 2020  s fcc_file:.    
+00060770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060780: 6d79 6d65 7461 203d 206a 736f 6e2e 6c6f  mymeta = json.lo
+00060790: 6164 2866 6363 5f66 696c 6529 0a20 2020  ad(fcc_file).   
+000607a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000607b0: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+000607c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000607d0: 2020 2020 2070 7269 6e74 286a 736f 6e2e       print(json.
+000607e0: 6475 6d70 7328 6d79 6d65 7461 2c20 696e  dumps(mymeta, in
+000607f0: 6465 6e74 3d34 2929 0a20 2020 2020 2020  dent=4)).       
+00060800: 2020 2020 2020 2020 2020 2020 2066 6363               fcc
+00060810: 5f66 696c 652e 636c 6f73 6528 290a 2020  _file.close().  
+00060820: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00060830: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00060840: 2020 7061 7373 0a20 2020 2020 2020 206d    pass.        m
+00060850: 7973 7465 6d3d 5061 7468 2820 696d 6167  ystem=Path( imag
+00060860: 6520 292e 7374 656d 0a20 2020 2020 2020  e ).stem.       
+00060870: 206d 7973 7465 6d3d 5061 7468 2820 6d79   mystem=Path( my
+00060880: 7374 656d 2029 2e73 7465 6d0a 2020 2020  stem ).stem.    
+00060890: 2020 2020 696d 6167 655f 7265 6665 7265      image_refere
+000608a0: 6e63 6520 3d20 616e 7473 2e69 6d61 6765  nce = ants.image
+000608b0: 5f72 6561 6428 2069 6d61 6765 2029 0a20  _read( image ). 
+000608c0: 2020 2020 2020 2069 6d61 6765 203d 2061         image = a
+000608d0: 6e74 732e 696d 6167 655f 7265 6164 2820  nts.image_read( 
+000608e0: 696d 6167 6520 290a 2020 2020 656c 7365  image ).    else
+000608f0: 3a0a 2020 2020 2020 2020 696d 6167 655f  :.        image_
+00060900: 7265 6665 7265 6e63 6520 3d20 616e 7473  reference = ants
+00060910: 2e69 6d61 6765 5f63 6c6f 6e65 2820 696d  .image_clone( im
+00060920: 6167 6520 290a 2020 2020 6e74 696d 6570  age ).    ntimep
+00060930: 6f69 6e74 7320 3d20 310a 2020 2020 6276  oints = 1.    bv
+00060940: 616c 7565 4d61 783d 4e6f 6e65 0a20 2020  alueMax=None.   
+00060950: 2062 7665 636e 6f72 6d3d 4e6f 6e65 0a20   bvecnorm=None. 
+00060960: 2020 2069 6620 696d 6167 655f 7265 6665     if image_refe
+00060970: 7265 6e63 652e 6469 6d65 6e73 696f 6e20  rence.dimension 
+00060980: 3d3d 2034 3a0a 2020 2020 2020 2020 6e74  == 4:.        nt
+00060990: 696d 6570 6f69 6e74 7320 3d20 696d 6167  imepoints = imag
+000609a0: 655f 7265 6665 7265 6e63 652e 7368 6170  e_reference.shap
+000609b0: 655b 335d 0a20 2020 2020 2020 2069 6620  e[3].        if 
+000609c0: 2244 5449 2220 696e 2069 6d61 6765 5f66  "DTI" in image_f
+000609d0: 696c 656e 616d 653a 0a20 2020 2020 2020  ilename:.       
+000609e0: 2020 2020 206d 7954 5373 6567 203d 2073       myTSseg = s
+000609f0: 6567 6d65 6e74 5f74 696d 6573 6572 6965  egment_timeserie
+00060a00: 735f 6279 5f6d 6561 6e76 616c 7565 2820  s_by_meanvalue( 
+00060a10: 696d 6167 655f 7265 6665 7265 6e63 6520  image_reference 
+00060a20: 290a 2020 2020 2020 2020 2020 2020 696d  ).            im
+00060a30: 6167 655f 6230 2c20 696d 6167 655f 6477  age_b0, image_dw
+00060a40: 6920 3d20 6765 745f 6176 6572 6167 655f  i = get_average_
+00060a50: 6477 695f 6230 2820 696d 6167 655f 7265  dwi_b0( image_re
+00060a60: 6665 7265 6e63 652c 2066 6173 743d 5472  ference, fast=Tr
+00060a70: 7565 2029 0a20 2020 2020 2020 2020 2020  ue ).           
+00060a80: 2069 6d61 6765 5f62 3020 3d20 616e 7473   image_b0 = ants
+00060a90: 2e69 4d61 7468 2820 696d 6167 655f 6230  .iMath( image_b0
+00060aa0: 2c20 274e 6f72 6d61 6c69 7a65 2720 290a  , 'Normalize' ).
+00060ab0: 2020 2020 2020 2020 2020 2020 696d 6167              imag
+00060ac0: 655f 6477 6920 3d20 616e 7473 2e69 4d61  e_dwi = ants.iMa
+00060ad0: 7468 2820 696d 6167 655f 6477 692c 2027  th( image_dwi, '
+00060ae0: 4e6f 726d 616c 697a 6527 2029 0a20 2020  Normalize' ).   
+00060af0: 2020 2020 2020 2020 2062 7661 6c5f 6e61           bval_na
+00060b00: 6d65 203d 2072 652e 7375 6228 222e 6e69  me = re.sub(".ni
+00060b10: 692e 677a 222c 222e 6276 616c 222c 696d  i.gz",".bval",im
+00060b20: 6167 655f 6669 6c65 6e61 6d65 290a 2020  age_filename).  
+00060b30: 2020 2020 2020 2020 2020 6276 6563 5f6e            bvec_n
+00060b40: 616d 6520 3d20 7265 2e73 7562 2822 2e6e  ame = re.sub(".n
+00060b50: 6969 2e67 7a22 2c22 2e62 7665 6322 2c69  ii.gz",".bvec",i
+00060b60: 6d61 6765 5f66 696c 656e 616d 6529 0a20  mage_filename). 
+00060b70: 2020 2020 2020 2020 2020 2069 6620 6578             if ex
+00060b80: 6973 7473 2820 6276 616c 5f6e 616d 6520  ists( bval_name 
+00060b90: 2920 616e 6420 6578 6973 7473 2820 6276  ) and exists( bv
+00060ba0: 6563 5f6e 616d 6520 293a 0a20 2020 2020  ec_name ):.     
+00060bb0: 2020 2020 2020 2020 2020 2062 7661 6c73             bvals
+00060bc0: 2c20 6276 6563 7320 3d20 7265 6164 5f62  , bvecs = read_b
+00060bd0: 7661 6c73 5f62 7665 6373 2820 6276 616c  vals_bvecs( bval
+00060be0: 5f6e 616d 6520 2c20 6276 6563 5f6e 616d  _name , bvec_nam
+00060bf0: 6520 2029 0a20 2020 2020 2020 2020 2020  e  ).           
+00060c00: 2020 2020 2062 7661 6c75 654d 6178 203d       bvalueMax =
+00060c10: 2062 7661 6c73 2e6d 6178 2829 0a20 2020   bvals.max().   
+00060c20: 2020 2020 2020 2020 2020 2020 2062 7665               bve
+00060c30: 636e 6f72 6d20 3d20 6e70 2e6c 696e 616c  cnorm = np.linal
+00060c40: 672e 6e6f 726d 2862 7665 6373 2c61 7869  g.norm(bvecs,axi
+00060c50: 733d 3129 2e72 6573 6861 7065 2820 6276  s=1).reshape( bv
+00060c60: 6563 732e 7368 6170 655b 305d 2c31 2029  ecs.shape[0],1 )
+00060c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00060c80: 2062 7665 636e 6f72 6d20 3d20 6276 6563   bvecnorm = bvec
+00060c90: 6e6f 726d 2e6d 6178 2829 0a20 2020 2020  norm.max().     
+00060ca0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00060cb0: 2020 2020 2069 6d61 6765 5f62 3020 3d20       image_b0 = 
+00060cc0: 616e 7473 2e67 6574 5f61 7665 7261 6765  ants.get_average
+00060cd0: 5f6f 665f 7469 6d65 7365 7269 6573 2820  _of_timeseries( 
+00060ce0: 696d 6167 655f 7265 6665 7265 6e63 6520  image_reference 
+00060cf0: 292e 694d 6174 6828 224e 6f72 6d61 6c69  ).iMath("Normali
+00060d00: 7a65 2229 0a20 2020 2065 6c73 653a 0a20  ze").    else:. 
+00060d10: 2020 2020 2020 2069 6d61 6765 5f63 6f6d         image_com
+00060d20: 7061 7265 203d 2061 6e74 732e 736d 6f6f  pare = ants.smoo
+00060d30: 7468 5f69 6d61 6765 2820 696d 6167 655f  th_image( image_
+00060d40: 7265 6665 7265 6e63 652c 2033 2c20 7369  reference, 3, si
+00060d50: 676d 615f 696e 5f70 6879 7369 6361 6c5f  gma_in_physical_
+00060d60: 636f 6f72 6469 6e61 7465 733d 4661 6c73  coordinates=Fals
+00060d70: 6520 290a 2020 2020 666f 7220 6a6a 6a20  e ).    for jjj 
+00060d80: 696e 2072 616e 6765 2830 2c6e 7469 6d65  in range(0,ntime
+00060d90: 706f 696e 7473 2c6e 5f74 6f5f 736b 6970  points,n_to_skip
+00060da0: 293a 0a20 2020 2020 2020 206d 6f64 616c  ):.        modal
+00060db0: 6974 793d 2775 6e6b 6e6f 776e 270a 2020  ity='unknown'.  
+00060dc0: 2020 2020 2020 6966 2022 7273 664d 5249        if "rsfMRI
+00060dd0: 2220 696e 2069 6d61 6765 5f66 696c 656e  " in image_filen
+00060de0: 616d 653a 0a20 2020 2020 2020 2020 2020  ame:.           
+00060df0: 206d 6f64 616c 6974 793d 2772 7366 4d52   modality='rsfMR
+00060e00: 4927 0a20 2020 2020 2020 2065 6c69 6620  I'.        elif 
+00060e10: 2254 3177 2220 696e 2069 6d61 6765 5f66  "T1w" in image_f
+00060e20: 696c 656e 616d 653a 0a20 2020 2020 2020  ilename:.       
+00060e30: 2020 2020 206d 6f64 616c 6974 793d 2754       modality='T
+00060e40: 3177 270a 2020 2020 2020 2020 656c 6966  1w'.        elif
+00060e50: 2022 5432 466c 6169 7222 2069 6e20 696d   "T2Flair" in im
+00060e60: 6167 655f 6669 6c65 6e61 6d65 3a0a 2020  age_filename:.  
+00060e70: 2020 2020 2020 2020 2020 6d6f 6461 6c69            modali
+00060e80: 7479 3d27 5432 466c 6169 7227 0a20 2020  ty='T2Flair'.   
+00060e90: 2020 2020 2065 6c69 6620 224e 4d32 444d       elif "NM2DM
+00060ea0: 5422 2069 6e20 696d 6167 655f 6669 6c65  T" in image_file
+00060eb0: 6e61 6d65 3a0a 2020 2020 2020 2020 2020  name:.          
+00060ec0: 2020 6d6f 6461 6c69 7479 3d27 4e4d 3244    modality='NM2D
+00060ed0: 4d54 270a 2020 2020 2020 2020 6966 2069  MT'.        if i
+00060ee0: 6d61 6765 5f72 6566 6572 656e 6365 2e64  mage_reference.d
+00060ef0: 696d 656e 7369 6f6e 203d 3d20 343a 0a20  imension == 4:. 
+00060f00: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+00060f10: 203d 2061 6e74 732e 736c 6963 655f 696d   = ants.slice_im
+00060f20: 6167 6528 2069 6d61 6765 5f72 6566 6572  age( image_refer
+00060f30: 656e 6365 2c20 6964 783d 696e 7428 6a6a  ence, idx=int(jj
+00060f40: 6a29 2c20 6178 6973 3d33 2029 0a20 2020  j), axis=3 ).   
+00060f50: 2020 2020 2020 2020 2069 6620 2244 5449           if "DTI
+00060f60: 2220 696e 2069 6d61 6765 5f66 696c 656e  " in image_filen
+00060f70: 616d 653a 0a20 2020 2020 2020 2020 2020  ame:.           
+00060f80: 2020 2020 2069 6620 6a6a 6a20 696e 206d       if jjj in m
+00060f90: 7954 5373 6567 5b27 6869 6768 6572 6d65  yTSseg['higherme
+00060fa0: 616e 7327 5d3a 0a20 2020 2020 2020 2020  ans']:.         
+00060fb0: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+00060fc0: 5f63 6f6d 7061 7265 203d 2061 6e74 732e  _compare = ants.
+00060fd0: 696d 6167 655f 636c 6f6e 6528 2069 6d61  image_clone( ima
+00060fe0: 6765 5f62 3020 290a 2020 2020 2020 2020  ge_b0 ).        
+00060ff0: 2020 2020 2020 2020 2020 2020 6d6f 6461              moda
+00061000: 6c69 7479 3d27 4454 4962 3027 0a20 2020  lity='DTIb0'.   
+00061010: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00061020: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00061030: 2020 2020 2020 2069 6d61 6765 5f63 6f6d         image_com
+00061040: 7061 7265 203d 2061 6e74 732e 696d 6167  pare = ants.imag
+00061050: 655f 636c 6f6e 6528 2069 6d61 6765 5f64  e_clone( image_d
+00061060: 7769 2029 0a20 2020 2020 2020 2020 2020  wi ).           
+00061070: 2020 2020 2020 2020 206d 6f64 616c 6974           modalit
+00061080: 793d 2744 5449 6477 6927 0a20 2020 2020  y='DTIdwi'.     
+00061090: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000610a0: 2020 2020 2020 2020 2020 2020 2069 6d61               ima
+000610b0: 6765 5f63 6f6d 7061 7265 203d 2061 6e74  ge_compare = ant
+000610c0: 732e 696d 6167 655f 636c 6f6e 6528 2069  s.image_clone( i
+000610d0: 6d61 6765 5f62 3020 290a 2020 2020 2020  mage_b0 ).      
+000610e0: 2020 2320 696d 6167 6520 3d20 616e 7473    # image = ants
+000610f0: 2e69 4d61 7468 2820 696d 6167 652c 2027  .iMath( image, '
+00061100: 5472 756e 6361 7465 496e 7465 6e73 6974  TruncateIntensit
+00061110: 7927 2c30 2e30 312c 302e 3939 3529 0a20  y',0.01,0.995). 
+00061120: 2020 2020 2020 206d 696e 7370 6320 3d20         minspc = 
+00061130: 6e70 2e6d 696e 2861 6e74 732e 6765 745f  np.min(ants.get_
+00061140: 7370 6163 696e 6728 696d 6167 6529 290a  spacing(image)).
+00061150: 2020 2020 2020 2020 6d61 7873 7063 203d          maxspc =
+00061160: 206e 702e 6d61 7828 616e 7473 2e67 6574   np.max(ants.get
+00061170: 5f73 7061 6369 6e67 2869 6d61 6765 2929  _spacing(image))
+00061180: 0a20 2020 2020 2020 2069 6620 7265 7361  .        if resa
+00061190: 6d70 6c65 2069 7320 6e6f 7420 4e6f 6e65  mple is not None
+000611a0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+000611b0: 2072 6573 616d 706c 6520 3d3d 2027 6d69   resample == 'mi
+000611c0: 6e27 3a0a 2020 2020 2020 2020 2020 2020  n':.            
+000611d0: 2020 2020 6966 206d 696e 7370 6320 3c20      if minspc < 
+000611e0: 3165 2d31 323a 0a20 2020 2020 2020 2020  1e-12:.         
+000611f0: 2020 2020 2020 2020 2020 206d 696e 7370             minsp
+00061200: 6320 3d20 6e70 2e6d 6178 2861 6e74 732e  c = np.max(ants.
+00061210: 6765 745f 7370 6163 696e 6728 696d 6167  get_spacing(imag
+00061220: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
+00061230: 2020 2020 6e65 7773 7063 203d 206e 702e      newspc = np.
+00061240: 7265 7065 6174 2820 6d69 6e73 7063 2c20  repeat( minspc, 
+00061250: 3320 290a 2020 2020 2020 2020 2020 2020  3 ).            
+00061260: 656c 6966 2072 6573 616d 706c 6520 3d3d  elif resample ==
+00061270: 2027 6d61 7827 3a0a 2020 2020 2020 2020   'max':.        
+00061280: 2020 2020 2020 2020 6e65 7773 7063 203d          newspc =
+00061290: 206e 702e 7265 7065 6174 2820 6d61 7873   np.repeat( maxs
+000612a0: 7063 2c20 3320 290a 2020 2020 2020 2020  pc, 3 ).        
+000612b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000612c0: 2020 2020 2020 2020 2020 6e65 7773 7063            newspc
+000612d0: 203d 206e 702e 7265 7065 6174 2820 7265   = np.repeat( re
+000612e0: 7361 6d70 6c65 2c20 3320 290a 2020 2020  sample, 3 ).    
+000612f0: 2020 2020 2020 2020 696d 6167 6520 3d20          image = 
+00061300: 616e 7473 2e72 6573 616d 706c 655f 696d  ants.resample_im
+00061310: 6167 6528 2069 6d61 6765 2c20 6e65 7773  age( image, news
+00061320: 7063 2029 0a20 2020 2020 2020 2020 2020  pc ).           
+00061330: 2069 6d61 6765 5f63 6f6d 7061 7265 203d   image_compare =
+00061340: 2061 6e74 732e 7265 7361 6d70 6c65 5f69   ants.resample_i
+00061350: 6d61 6765 2820 696d 6167 655f 636f 6d70  mage( image_comp
+00061360: 6172 652c 206e 6577 7370 6320 290a 2020  are, newspc ).  
+00061370: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00061380: 2020 2020 2020 2020 2320 6368 6563 6b20          # check 
+00061390: 666f 7220 7370 6320 636c 6f73 6520 746f  for spc close to
+000613a0: 207a 6572 6f0a 2020 2020 2020 2020 2020   zero.          
+000613b0: 2020 7370 6320 3d20 6c69 7374 2861 6e74    spc = list(ant
+000613c0: 732e 6765 745f 7370 6163 696e 6728 696d  s.get_spacing(im
+000613d0: 6167 6529 290a 2020 2020 2020 2020 2020  age)).          
+000613e0: 2020 666f 7220 7370 636b 2069 6e20 7261    for spck in ra
+000613f0: 6e67 6528 6c65 6e28 7370 6329 293a 0a20  nge(len(spc)):. 
+00061400: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00061410: 6620 7370 635b 7370 636b 5d20 3c20 3165  f spc[spck] < 1e
+00061420: 2d31 323a 0a20 2020 2020 2020 2020 2020  -12:.           
+00061430: 2020 2020 2020 2020 2073 7063 5b73 7063           spc[spc
+00061440: 6b5d 3d31 0a20 2020 2020 2020 2020 2020  k]=1.           
+00061450: 2061 6e74 732e 7365 745f 7370 6163 696e   ants.set_spacin
+00061460: 6728 2069 6d61 6765 2c20 7370 6320 290a  g( image, spc ).
+00061470: 2020 2020 2020 2020 2020 2020 616e 7473              ants
+00061480: 2e73 6574 5f73 7061 6369 6e67 2820 696d  .set_spacing( im
+00061490: 6167 655f 636f 6d70 6172 652c 2073 7063  age_compare, spc
+000614a0: 2029 0a20 2020 2020 2020 2023 2069 6620   ).        # if 
+000614b0: 224e 4d32 444d 5422 2069 6e20 696d 6167  "NM2DMT" in imag
+000614c0: 655f 6669 6c65 6e61 6d65 206f 7220 2246  e_filename or "F
+000614d0: 4958 4d45 2220 696e 2069 6d61 6765 5f66  IXME" in image_f
+000614e0: 696c 656e 616d 6520 6f72 2022 5350 4543  ilename or "SPEC
+000614f0: 5422 2069 6e20 696d 6167 655f 6669 6c65  T" in image_file
+00061500: 6e61 6d65 206f 7220 2255 4e4b 4e4f 574e  name or "UNKNOWN
+00061510: 2220 696e 2069 6d61 6765 5f66 696c 656e  " in image_filen
+00061520: 616d 653a 0a20 2020 2020 2020 206d 696e  ame:.        min
+00061530: 7370 6320 3d20 6e70 2e6d 696e 2861 6e74  spc = np.min(ant
+00061540: 732e 6765 745f 7370 6163 696e 6728 696d  s.get_spacing(im
+00061550: 6167 6529 290a 2020 2020 2020 2020 6d61  age)).        ma
+00061560: 7873 7063 203d 206e 702e 6d61 7828 616e  xspc = np.max(an
+00061570: 7473 2e67 6574 5f73 7061 6369 6e67 2869  ts.get_spacing(i
+00061580: 6d61 6765 2929 0a20 2020 2020 2020 206d  mage)).        m
+00061590: 736b 203d 2061 6e74 732e 7468 7265 7368  sk = ants.thresh
+000615a0: 6f6c 645f 696d 6167 6528 2061 6e74 732e  old_image( ants.
+000615b0: 694d 6174 6828 696d 6167 652c 274e 6f72  iMath(image,'Nor
+000615c0: 6d61 6c69 7a65 2729 2c20 302e 3135 2c20  malize'), 0.15, 
+000615d0: 312e 3020 290a 2020 2020 2020 2020 2320  1.0 ).        # 
+000615e0: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
+000615f0: 2020 206d 736b 203d 2061 6e74 732e 6765     msk = ants.ge
+00061600: 745f 6d61 736b 2820 696d 6167 6520 290a  t_mask( image ).
+00061610: 2020 2020 2020 2020 6d73 6b20 3d20 616e          msk = an
+00061620: 7473 2e6d 6f72 7068 6f6c 6f67 7928 6d73  ts.morphology(ms
+00061630: 6b2c 2022 636c 6f73 6522 2c20 3320 290a  k, "close", 3 ).
+00061640: 2020 2020 2020 2020 6267 6d73 6b20 3d20          bgmsk = 
+00061650: 6d73 6b2a 302b 312d 6d73 6b0a 2020 2020  msk*0+1-msk.    
+00061660: 2020 2020 6d73 6b64 696c 203d 2061 6e74      mskdil = ant
+00061670: 732e 694d 6174 6828 6d73 6b2c 2022 4d44  s.iMath(msk, "MD
+00061680: 222c 2034 2029 0a20 2020 2020 2020 2023  ", 4 ).        #
+00061690: 2061 6e74 732e 706c 6f74 5f6f 7274 686f   ants.plot_ortho
+000616a0: 2820 696d 6167 652c 206d 736b 2c20 6372  ( image, msk, cr
+000616b0: 6f70 3d46 616c 7365 2029 0a20 2020 2020  op=False ).     
+000616c0: 2020 206e 766f 7820 3d20 696e 7428 206d     nvox = int( m
+000616d0: 736b 2e73 756d 2829 2029 0a20 2020 2020  sk.sum() ).     
+000616e0: 2020 2073 7063 203d 2061 6e74 732e 6765     spc = ants.ge
+000616f0: 745f 7370 6163 696e 6728 2069 6d61 6765  t_spacing( image
+00061700: 2029 0a20 2020 2020 2020 206f 7267 203d   ).        org =
+00061710: 2061 6e74 732e 6765 745f 6f72 6967 696e   ants.get_origin
+00061720: 2820 696d 6167 6520 290a 2020 2020 2020  ( image ).      
+00061730: 2020 6966 2028 206e 766f 7820 3e20 3020    if ( nvox > 0 
+00061740: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+00061750: 6d61 6765 203d 2061 6e74 732e 6372 6f70  mage = ants.crop
+00061760: 5f69 6d61 6765 2820 696d 6167 652c 206d  _image( image, m
+00061770: 736b 6469 6c20 292e 694d 6174 6828 224e  skdil ).iMath("N
+00061780: 6f72 6d61 6c69 7a65 2229 0a20 2020 2020  ormalize").     
+00061790: 2020 2020 2020 206d 736b 203d 2061 6e74         msk = ant
+000617a0: 732e 6372 6f70 5f69 6d61 6765 2820 6d73  s.crop_image( ms
+000617b0: 6b2c 206d 736b 6469 6c20 292e 694d 6174  k, mskdil ).iMat
+000617c0: 6828 224e 6f72 6d61 6c69 7a65 2229 0a20  h("Normalize"). 
+000617d0: 2020 2020 2020 2020 2020 2062 676d 736b             bgmsk
+000617e0: 203d 2061 6e74 732e 6372 6f70 5f69 6d61   = ants.crop_ima
+000617f0: 6765 2820 6267 6d73 6b2c 206d 736b 6469  ge( bgmsk, mskdi
+00061800: 6c20 292e 694d 6174 6828 224e 6f72 6d61  l ).iMath("Norma
+00061810: 6c69 7a65 2229 0a20 2020 2020 2020 2020  lize").         
+00061820: 2020 2069 6d61 6765 5f63 6f6d 7061 7265     image_compare
+00061830: 203d 2061 6e74 732e 6372 6f70 5f69 6d61   = ants.crop_ima
+00061840: 6765 2820 696d 6167 655f 636f 6d70 6172  ge( image_compar
+00061850: 652c 206d 736b 6469 6c20 292e 694d 6174  e, mskdil ).iMat
+00061860: 6828 224e 6f72 6d61 6c69 7a65 2229 2020  h("Normalize")  
+00061870: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+00061880: 2020 2020 2020 6e70 6174 6368 203d 2069        npatch = i
+00061890: 6e74 2820 6e70 2e72 6f75 6e64 2820 2030  nt( np.round(  0
+000618a0: 2e31 202a 206e 766f 7820 2920 290a 2020  .1 * nvox ) ).  
+000618b0: 2020 2020 2020 2020 2020 6e70 6174 6368            npatch
+000618c0: 203d 206e 702e 6d69 6e28 2020 5b35 3132   = np.min(  [512
+000618d0: 2c6e 7061 7463 6820 5d20 290a 2020 2020  ,npatch ] ).    
+000618e0: 2020 2020 2020 2020 7061 7463 685f 7368          patch_sh
+000618f0: 6170 6520 3d20 5b5d 0a20 2020 2020 2020  ape = [].       
+00061900: 2020 2020 2066 6f72 206b 2069 6e20 7261       for k in ra
+00061910: 6e67 6528 2033 2029 3a0a 2020 2020 2020  nge( 3 ):.      
+00061920: 2020 2020 2020 2020 2020 7020 3d20 696e            p = in
+00061930: 7428 2033 322e 3020 2f20 616e 7473 2e67  t( 32.0 / ants.g
+00061940: 6574 5f73 7061 6369 6e67 2820 696d 6167  et_spacing( imag
+00061950: 6520 2029 5b6b 5d20 290a 2020 2020 2020  e  )[k] ).      
+00061960: 2020 2020 2020 2020 2020 6966 2070 203e            if p >
+00061970: 2069 6e74 2820 6e70 2e72 6f75 6e64 2820   int( np.round( 
+00061980: 696d 6167 652e 7368 6170 655b 6b5d 202a  image.shape[k] *
+00061990: 2030 2e35 2029 2029 3a0a 2020 2020 2020   0.5 ) ):.      
+000619a0: 2020 2020 2020 2020 2020 2020 2020 7020                p 
+000619b0: 3d20 696e 7428 206e 702e 726f 756e 6428  = int( np.round(
+000619c0: 2069 6d61 6765 2e73 6861 7065 5b6b 5d20   image.shape[k] 
+000619d0: 2a20 302e 3520 2920 290a 2020 2020 2020  * 0.5 ) ).      
+000619e0: 2020 2020 2020 2020 2020 7061 7463 685f            patch_
+000619f0: 7368 6170 652e 6170 7065 6e64 2820 7020  shape.append( p 
+00061a00: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00061a10: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+00061a20: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00061a30: 696d 6167 6529 0a20 2020 2020 2020 2020  image).         
+00061a40: 2020 2020 2020 2070 7269 6e74 2820 7061         print( pa
+00061a50: 7463 685f 7368 6170 6520 290a 2020 2020  tch_shape ).    
+00061a60: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00061a70: 7428 206e 7061 7463 6820 290a 2020 2020  t( npatch ).    
+00061a80: 2020 2020 2020 2020 6d79 6576 7220 3d20          myevr = 
+00061a90: 6d61 7468 2e6e 616e 2023 2064 6f6e 7420  math.nan # dont 
+00061aa0: 7761 6e74 2074 6f20 6661 696c 2069 6620  want to fail if 
+00061ab0: 736f 6d65 7468 696e 6720 6f64 6420 6861  something odd ha
+00061ac0: 7070 656e 7320 696e 2070 6174 6368 2065  ppens in patch e
+00061ad0: 7874 7261 6374 696f 6e0a 2020 2020 2020  xtraction.      
+00061ae0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00061af0: 2020 2020 2020 2020 2020 206d 7965 7672             myevr
+00061b00: 203d 2061 6e74 7370 7974 3177 2e70 6174   = antspyt1w.pat
+00061b10: 6368 5f65 6967 656e 7661 6c75 655f 7261  ch_eigenvalue_ra
+00061b20: 7469 6f28 2069 6d61 6765 2c20 6e70 6174  tio( image, npat
+00061b30: 6368 2c20 7061 7463 685f 7368 6170 652c  ch, patch_shape,
+00061b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00061b50: 2020 2020 2065 7664 6570 7468 203d 2030       evdepth = 0
+00061b60: 2e39 2c20 6d61 736b 3d6d 736b 2029 0a20  .9, mask=msk ). 
+00061b70: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00061b80: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00061b90: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
+00061ba0: 2020 2020 6966 2070 756c 6c5f 7261 6e6b      if pull_rank
+00061bb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00061bc0: 2020 696d 6167 6520 3d20 616e 7473 2e72    image = ants.r
+00061bd0: 616e 6b5f 696e 7465 6e73 6974 7928 696d  ank_intensity(im
+00061be0: 6167 6529 0a20 2020 2020 2020 2020 2020  age).           
+00061bf0: 2069 6d61 6765 7265 666c 6563 7420 3d20   imagereflect = 
+00061c00: 616e 7473 2e72 6566 6c65 6374 5f69 6d61  ants.reflect_ima
+00061c10: 6765 2869 6d61 6765 2c20 6178 6973 3d30  ge(image, axis=0
+00061c20: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+00061c30: 796d 5f65 7272 203d 2028 2069 6d61 6765  ym_err = ( image
+00061c40: 202d 2069 6d61 6765 7265 666c 6563 7420   - imagereflect 
+00061c50: 292e 6162 7328 292e 6d65 616e 2829 0a20  ).abs().mean(). 
+00061c60: 2020 2020 2020 2020 2020 2023 2065 7374             # est
+00061c70: 696d 6174 6520 6e6f 6973 6520 6279 2063  imate noise by c
+00061c80: 656e 7465 7220 6372 6f70 7069 6e67 2c20  enter cropping, 
+00061c90: 6465 6e6f 697a 696e 6720 616e 6420 7461  denoizing and ta
+00061ca0: 6b69 6e67 206d 6167 6e69 7475 6465 206f  king magnitude o
+00061cb0: 6620 6469 6666 6572 656e 6365 0a20 2020  f difference.   
+00061cc0: 2020 2020 2020 2020 206e 6f63 726f 703d           nocrop=
+00061cd0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+00061ce0: 2020 6966 2069 6d61 6765 2e64 696d 656e    if image.dimen
+00061cf0: 7369 6f6e 203d 3d20 333a 0a20 2020 2020  sion == 3:.     
+00061d00: 2020 2020 2020 2020 2020 2069 6620 696d             if im
+00061d10: 6167 652e 7368 6170 655b 325d 203d 3d20  age.shape[2] == 
+00061d20: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+00061d30: 2020 2020 2020 206e 6f63 726f 703d 5472         nocrop=Tr
+00061d40: 7565 2020 2020 2020 2020 0a20 2020 2020  ue        .     
+00061d50: 2020 2020 2020 2069 6620 6d61 7873 7063         if maxspc
+00061d60: 2f6d 696e 7370 6320 3e20 3130 3a0a 2020  /minspc > 10:.  
+00061d70: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+00061d80: 6372 6f70 3d54 7275 650a 2020 2020 2020  crop=True.      
+00061d90: 2020 2020 2020 6966 206e 6f63 726f 703a        if nocrop:
+00061da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00061db0: 206d 7963 6320 3d20 616e 7473 2e69 6d61   mycc = ants.ima
+00061dc0: 6765 5f63 6c6f 6e65 2820 696d 6167 6520  ge_clone( image 
+00061dd0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00061de0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00061df0: 2020 2020 6d79 6363 203d 2061 6e74 7370      mycc = antsp
+00061e00: 7974 3177 2e73 7065 6369 616c 5f63 726f  yt1w.special_cro
+00061e10: 7028 2069 6d61 6765 2c0a 2020 2020 2020  p( image,.      
+00061e20: 2020 2020 2020 2020 2020 2020 2020 616e                an
+00061e30: 7473 2e67 6574 5f63 656e 7465 725f 6f66  ts.get_center_of
+00061e40: 5f6d 6173 7328 206d 736b 202a 3020 2b20  _mass( msk *0 + 
+00061e50: 3120 292c 2070 6174 6368 5f73 6861 7065  1 ), patch_shape
+00061e60: 2029 0a20 2020 2020 2020 2020 2020 206d   ).            m
+00061e70: 7963 6364 203d 2061 6e74 732e 6465 6e6f  yccd = ants.deno
+00061e80: 6973 655f 696d 6167 6528 206d 7963 632c  ise_image( mycc,
+00061e90: 2070 3d32 2c72 3d32 2c6e 6f69 7365 5f6d   p=2,r=2,noise_m
+00061ea0: 6f64 656c 3d27 4761 7573 7369 616e 2720  odel='Gaussian' 
+00061eb0: 290a 2020 2020 2020 2020 2020 2020 6e6f  ).            no
+00061ec0: 697a 6c65 7665 6c20 3d20 2820 6d79 6363  izlevel = ( mycc
+00061ed0: 202d 206d 7963 6364 2029 2e61 6273 2829   - myccd ).abs()
+00061ee0: 2e6d 6561 6e28 290a 2020 2020 2320 2020  .mean().    #   
+00061ef0: 2020 2020 2061 6e74 732e 706c 6f74 5f6f       ants.plot_o
+00061f00: 7274 686f 2820 696d 6167 652c 2063 726f  rtho( image, cro
+00061f10: 703d 4661 6c73 652c 2066 696c 656e 616d  p=False, filenam
+00061f20: 653d 7669 7a5f 6669 6c65 6e61 6d65 2c20  e=viz_filename, 
+00061f30: 666c 6174 3d54 7275 652c 2078 797a 5f6c  flat=True, xyz_l
+00061f40: 696e 6573 3d46 616c 7365 2c20 6f72 6965  ines=False, orie
+00061f50: 6e74 5f6c 6162 656c 733d 4661 6c73 652c  nt_labels=False,
+00061f60: 2078 797a 5f70 6164 3d30 2029 0a20 2020   xyz_pad=0 ).   
+00061f70: 2023 2020 2020 2020 2020 6672 6f6d 2062   #        from b
+00061f80: 7269 7371 7565 2069 6d70 6f72 7420 4252  risque import BR
+00061f90: 4953 5155 450a 2020 2020 2320 2020 2020  ISQUE.    #     
+00061fa0: 2020 206f 626a 203d 2042 5249 5351 5545     obj = BRISQUE
+00061fb0: 2875 726c 3d46 616c 7365 290a 2020 2020  (url=False).    
+00061fc0: 2320 2020 2020 2020 206d 7962 7269 7371  #        mybrisq
+00061fd0: 203d 206f 626a 2e73 636f 7265 2820 6e70   = obj.score( np
+00061fe0: 2e61 7272 6179 2820 496d 6167 652e 6f70  .array( Image.op
+00061ff0: 656e 2820 7669 7a5f 6669 6c65 6e61 6d65  en( viz_filename
+00062000: 2029 2920 290a 2020 2020 2020 2020 2020   )) ).          
+00062010: 2020 6d73 6b5f 766f 6c20 3d20 6d73 6b2e    msk_vol = msk.
+00062020: 7375 6d28 2920 2a20 6e70 2e70 726f 6428  sum() * np.prod(
+00062030: 2073 7063 2029 0a20 2020 2020 2020 2020   spc ).         
+00062040: 2020 2062 6773 7464 203d 2069 6d61 6765     bgstd = image
+00062050: 5b20 6267 6d73 6b20 3d3d 2031 205d 2e73  [ bgmsk == 1 ].s
+00062060: 7464 2829 0a20 2020 2020 2020 2020 2020  td().           
+00062070: 2066 676d 6561 6e20 3d20 696d 6167 655b   fgmean = image[
+00062080: 206d 736b 203d 3d20 3120 5d2e 6d65 616e   msk == 1 ].mean
+00062090: 2829 0a20 2020 2020 2020 2020 2020 2062  ().            b
+000620a0: 676d 6561 6e20 3d20 696d 6167 655b 2062  gmean = image[ b
+000620b0: 676d 736b 203d 3d20 3120 5d2e 6d65 616e  gmsk == 1 ].mean
+000620c0: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
+000620d0: 6e72 7265 6620 3d20 6667 6d65 616e 202f  nrref = fgmean /
+000620e0: 2062 6773 7464 0a20 2020 2020 2020 2020   bgstd.         
+000620f0: 2020 2063 6e72 7265 6620 3d20 2820 6667     cnrref = ( fg
+00062100: 6d65 616e 202d 2062 676d 6561 6e20 2920  mean - bgmean ) 
+00062110: 2f20 6267 7374 640a 2020 2020 2020 2020  / bgstd.        
+00062120: 2020 2020 7073 6e72 7265 6620 3d20 616e      psnrref = an
+00062130: 7473 7079 6e65 742e 7073 6e72 2820 2069  tspynet.psnr(  i
+00062140: 6d61 6765 5f63 6f6d 7061 7265 2c20 696d  mage_compare, im
+00062150: 6167 6520 2029 0a20 2020 2020 2020 2020  age  ).         
+00062160: 2020 2073 7369 6d72 6566 203d 2061 6e74     ssimref = ant
+00062170: 7370 796e 6574 2e73 7369 6d28 2020 696d  spynet.ssim(  im
+00062180: 6167 655f 636f 6d70 6172 652c 2069 6d61  age_compare, ima
+00062190: 6765 2020 290a 2020 2020 2020 2020 2020  ge  ).          
+000621a0: 2020 6966 206e 6f63 726f 703a 0a20 2020    if nocrop:.   
+000621b0: 2020 2020 2020 2020 2020 2020 206d 796d               mym
+000621c0: 6920 3d20 6d61 7468 2e69 6e66 0a20 2020  i = math.inf.   
+000621d0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+000621e0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000621f0: 796d 6920 3d20 616e 7473 2e69 6d61 6765  ymi = ants.image
+00062200: 5f6d 7574 7561 6c5f 696e 666f 726d 6174  _mutual_informat
+00062210: 696f 6e28 2069 6d61 6765 5f63 6f6d 7061  ion( image_compa
+00062220: 7265 2c20 696d 6167 6520 290a 2020 2020  re, image ).    
+00062230: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00062240: 2020 2020 2020 6d73 6b5f 766f 6c20 3d20        msk_vol = 
+00062250: 300a 2020 2020 2020 2020 2020 2020 6d79  0.            my
+00062260: 6576 7220 3d20 6d79 6d69 203d 2073 7369  evr = mymi = ssi
+00062270: 6d72 6566 203d 2070 736e 7272 6566 203d  mref = psnrref =
+00062280: 2063 6e72 7265 6620 3d20 6173 796d 5f65   cnrref = asym_e
+00062290: 7272 203d 206e 6f69 7a6c 6576 656c 203d  rr = noizlevel =
+000622a0: 206d 6174 682e 6e61 6e0a 2020 2020 2020   math.nan.      
+000622b0: 2020 2020 2020 0a20 2020 2020 2020 206d        .        m
+000622c0: 7269 7365 7269 6573 3d4e 6f6e 650a 2020  riseries=None.  
+000622d0: 2020 2020 2020 6d72 696d 6667 3d4e 6f6e        mrimfg=Non
+000622e0: 650a 2020 2020 2020 2020 6d72 696d 6f64  e.        mrimod
+000622f0: 656c 3d4e 6f6e 650a 2020 2020 2020 2020  el=None.        
+00062300: 6d72 6953 4152 3d4e 6f6e 650a 2020 2020  mriSAR=None.    
+00062310: 2020 2020 4261 6e64 7769 6474 6850 6572      BandwidthPer
+00062320: 5069 7865 6c50 6861 7365 456e 636f 6465  PixelPhaseEncode
+00062330: 3d4e 6f6e 650a 2020 2020 2020 2020 5069  =None.        Pi
+00062340: 7865 6c42 616e 6477 6964 7468 3d4e 6f6e  xelBandwidth=Non
+00062350: 650a 2020 2020 2020 2020 6966 206d 796d  e.        if mym
+00062360: 6574 6120 6973 206e 6f74 204e 6f6e 653a  eta is not None:
+00062370: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
+00062380: 7269 7365 7269 6573 3d6d 796d 6574 615b  riseries=mymeta[
+00062390: 2727 5d0a 2020 2020 2020 2020 2020 2020  ''].            
+000623a0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+000623b0: 2020 2020 206d 7269 6d66 673d 6d79 6d65       mrimfg=myme
+000623c0: 7461 5b27 4d61 6e75 6661 6374 7572 6572  ta['Manufacturer
+000623d0: 275d 0a20 2020 2020 2020 2020 2020 2065  '].            e
+000623e0: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
+000623f0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
+00062400: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00062410: 2020 2020 2020 2020 2020 2020 206d 7269               mri
+00062420: 6d6f 6465 6c3d 6d79 6d65 7461 5b27 4d61  model=mymeta['Ma
+00062430: 6e75 6661 6374 7572 6572 734d 6f64 656c  nufacturersModel
+00062440: 4e61 6d65 275d 0a20 2020 2020 2020 2020  Name'].         
+00062450: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
+00062460: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+00062470: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00062480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00062490: 204d 6167 6e65 7469 6346 6965 6c64 5374   MagneticFieldSt
+000624a0: 7265 6e67 7468 3d6d 796d 6574 615b 274d  rength=mymeta['M
+000624b0: 6167 6e65 7469 6346 6965 6c64 5374 7265  agneticFieldStre
+000624c0: 6e67 7468 275d 0a20 2020 2020 2020 2020  ngth'].         
+000624d0: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
+000624e0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+000624f0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00062500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00062510: 2050 6978 656c 4261 6e64 7769 6474 683d   PixelBandwidth=
+00062520: 6d79 6d65 7461 5b27 5069 7865 6c42 616e  mymeta['PixelBan
+00062530: 6477 6964 7468 275d 0a20 2020 2020 2020  dwidth'].       
+00062540: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
+00062550: 2020 2020 2020 2020 2020 2020 2070 6173               pas
+00062560: 730a 2020 2020 2020 2020 2020 2020 7472  s.            tr
+00062570: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00062580: 2020 2042 616e 6477 6964 7468 5065 7250     BandwidthPerP
+00062590: 6978 656c 5068 6173 6545 6e63 6f64 653d  ixelPhaseEncode=
+000625a0: 6d79 6d65 7461 5b27 4261 6e64 7769 6474  mymeta['Bandwidt
+000625b0: 6850 6572 5069 7865 6c50 6861 7365 456e  hPerPixelPhaseEn
+000625c0: 636f 6465 275d 0a20 2020 2020 2020 2020  code'].         
+000625d0: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
+000625e0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+000625f0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00062600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00062610: 206d 7269 5341 523d 6d79 6d65 7461 5b27   mriSAR=mymeta['
+00062620: 5341 5227 5d0a 2020 2020 2020 2020 2020  SAR'].          
+00062630: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
+00062640: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+00062650: 2020 2020 2020 2074 746c 3d6d 7973 7465         ttl=myste
+00062660: 6d20 2b20 2720 270a 2020 2020 2020 2020  m + ' '.        
+00062670: 7474 6c3d 2727 0a20 2020 2020 2020 2074  ttl=''.        t
+00062680: 746c 3d74 746c 202b 2022 4e5a 3a20 2220  tl=ttl + "NZ: " 
+00062690: 2b20 227b 3a30 2e34 667d 222e 666f 726d  + "{:0.4f}".form
+000626a0: 6174 286e 6f69 7a6c 6576 656c 2920 2b20  at(noizlevel) + 
+000626b0: 2220 534e 523a 2022 202b 2022 7b3a 302e  " SNR: " + "{:0.
+000626c0: 3466 7d22 2e66 6f72 6d61 7428 736e 7272  4f}".format(snrr
+000626d0: 6566 2920 2b20 2220 434e 523a 2022 202b  ef) + " CNR: " +
+000626e0: 2022 7b3a 302e 3466 7d22 2e66 6f72 6d61   "{:0.4f}".forma
+000626f0: 7428 636e 7272 6566 2920 2b20 2220 5053  t(cnrref) + " PS
+00062700: 3a20 2220 2b20 227b 3a30 2e34 667d 222e  : " + "{:0.4f}".
+00062710: 666f 726d 6174 2870 736e 7272 6566 292b  format(psnrref)+
+00062720: 2022 2053 533a 2022 202b 2022 7b3a 302e   " SS: " + "{:0.
+00062730: 3466 7d22 2e66 6f72 6d61 7428 7373 696d  4f}".format(ssim
+00062740: 7265 6629 202b 2022 2045 5652 3a20 2220  ref) + " EVR: " 
+00062750: 2b20 227b 3a30 2e34 667d 222e 666f 726d  + "{:0.4f}".form
+00062760: 6174 286d 7965 7672 292b 2022 204d 493a  at(myevr)+ " MI:
+00062770: 2022 202b 2022 7b3a 302e 3466 7d22 2e66   " + "{:0.4f}".f
+00062780: 6f72 6d61 7428 6d79 6d69 290a 2020 2020  ormat(mymi).    
+00062790: 2020 2020 6966 2076 697a 5f66 696c 656e      if viz_filen
+000627a0: 616d 6520 6973 206e 6f74 204e 6f6e 6520  ame is not None 
+000627b0: 616e 6420 2820 6a6a 6a20 3d3d 2030 206f  and ( jjj == 0 o
+000627c0: 7220 286a 6a6a 2025 2033 3020 3d3d 2030  r (jjj % 30 == 0
+000627d0: 2920 2920 616e 6420 696d 6167 652e 7368  ) ) and image.sh
+000627e0: 6170 655b 325d 203c 2036 3835 3a0a 2020  ape[2] < 685:.  
+000627f0: 2020 2020 2020 2020 2020 7669 7a5f 6669            viz_fi
+00062800: 6c65 6e61 6d65 5f75 7365 203d 2072 652e  lename_use = re.
+00062810: 7375 6228 2022 2e70 6e67 222c 2022 5f73  sub( ".png", "_s
+00062820: 6c69 6365 222b 7374 7228 6a6a 6a29 2e7a  lice"+str(jjj).z
+00062830: 6669 6c6c 2834 292b 222e 706e 6722 2c20  fill(4)+".png", 
+00062840: 7669 7a5f 6669 6c65 6e61 6d65 2029 0a20  viz_filename ). 
+00062850: 2020 2020 2020 2020 2020 2061 6e74 732e             ants.
+00062860: 706c 6f74 5f6f 7274 686f 2820 696d 6167  plot_ortho( imag
+00062870: 652c 2063 726f 703d 4661 6c73 652c 2066  e, crop=False, f
+00062880: 696c 656e 616d 653d 7669 7a5f 6669 6c65  ilename=viz_file
+00062890: 6e61 6d65 5f75 7365 2c20 666c 6174 3d54  name_use, flat=T
+000628a0: 7275 652c 2078 797a 5f6c 696e 6573 3d46  rue, xyz_lines=F
+000628b0: 616c 7365 2c20 6f72 6965 6e74 5f6c 6162  alse, orient_lab
+000628c0: 656c 733d 4661 6c73 652c 2078 797a 5f70  els=False, xyz_p
+000628d0: 6164 3d30 2c20 2074 6974 6c65 3d74 746c  ad=0,  title=ttl
+000628e0: 2c20 7469 746c 6566 6f6e 7473 697a 653d  , titlefontsize=
+000628f0: 3132 2c20 7469 746c 655f 6479 3d2d 302e  12, title_dy=-0.
+00062900: 3032 2c74 6578 7466 6f6e 7463 6f6c 6f72  02,textfontcolor
+00062910: 3d27 7265 6427 2029 0a20 2020 2020 2020  ='red' ).       
+00062920: 2064 6620 3d20 7064 2e44 6174 6146 7261   df = pd.DataFra
+00062930: 6d65 285b 5b20 0a20 2020 2020 2020 2020  me([[ .         
+00062940: 2020 206d 7973 7465 6d2c 200a 2020 2020     mystem, .    
+00062950: 2020 2020 2020 2020 696d 6167 655f 7265          image_re
+00062960: 6665 7265 6e63 652e 6469 6d65 6e73 696f  ference.dimensio
+00062970: 6e2c 200a 2020 2020 2020 2020 2020 2020  n, .            
+00062980: 6e6f 697a 6c65 7665 6c2c 2073 6e72 7265  noizlevel, snrre
+00062990: 662c 2063 6e72 7265 662c 2070 736e 7272  f, cnrref, psnrr
+000629a0: 6566 2c20 7373 696d 7265 662c 206d 796d  ef, ssimref, mym
+000629b0: 692c 2061 7379 6d5f 6572 722c 206d 7965  i, asym_err, mye
+000629c0: 7672 2c20 6d73 6b5f 766f 6c2c 200a 2020  vr, msk_vol, .  
+000629d0: 2020 2020 2020 2020 2020 7370 635b 305d            spc[0]
+000629e0: 2c20 7370 635b 315d 2c20 7370 635b 325d  , spc[1], spc[2]
+000629f0: 2c6f 7267 5b30 5d2c 206f 7267 5b31 5d2c  ,org[0], org[1],
+00062a00: 206f 7267 5b32 5d2c 200a 2020 2020 2020   org[2], .      
+00062a10: 2020 2020 2020 696d 6167 652e 7368 6170        image.shap
+00062a20: 655b 305d 2c20 696d 6167 652e 7368 6170  e[0], image.shap
+00062a30: 655b 315d 2c20 696d 6167 652e 7368 6170  e[1], image.shap
+00062a40: 655b 325d 2c20 6e74 696d 6570 6f69 6e74  e[2], ntimepoint
+00062a50: 732c 200a 2020 2020 2020 2020 2020 2020  s, .            
+00062a60: 6a6a 6a2c 206d 6f64 616c 6974 792c 206d  jjj, modality, m
+00062a70: 7269 7365 7269 6573 2c20 6d72 696d 6667  riseries, mrimfg
+00062a80: 2c20 6d72 696d 6f64 656c 2c20 4d61 676e  , mrimodel, Magn
+00062a90: 6574 6963 4669 656c 6453 7472 656e 6774  eticFieldStrengt
+00062aa0: 682c 206d 7269 5341 522c 2050 6978 656c  h, mriSAR, Pixel
+00062ab0: 4261 6e64 7769 6474 682c 2042 616e 6477  Bandwidth, Bandw
+00062ac0: 6964 7468 5065 7250 6978 656c 5068 6173  idthPerPixelPhas
+00062ad0: 6545 6e63 6f64 652c 2062 7661 6c75 654d  eEncode, bvalueM
+00062ae0: 6178 2c20 6276 6563 6e6f 726d 205d 5d2c  ax, bvecnorm ]],
+00062af0: 200a 2020 2020 2020 2020 2020 2020 636f   .            co
+00062b00: 6c75 6d6e 733d 5b0a 2020 2020 2020 2020  lumns=[.        
+00062b10: 2020 2020 2020 2020 2766 696c 656e 616d          'filenam
+00062b20: 6527 2c20 0a20 2020 2020 2020 2020 2020  e', .           
+00062b30: 2020 2020 2027 6469 6d65 6e73 696f 6e61       'dimensiona
+00062b40: 6c69 7479 272c 0a20 2020 2020 2020 2020  lity',.         
+00062b50: 2020 2020 2020 2027 6e6f 6973 6527 2c20         'noise', 
+00062b60: 2773 6e72 272c 2027 636e 7227 2c20 2770  'snr', 'cnr', 'p
+00062b70: 736e 7227 2c20 2773 7369 6d27 2c20 276d  snr', 'ssim', 'm
+00062b80: 6927 2c20 2772 6566 6c65 6374 696f 6e5f  i', 'reflection_
+00062b90: 6572 7227 2c20 2745 5652 272c 2027 6d73  err', 'EVR', 'ms
+00062ba0: 6b5f 766f 6c27 2c20 2773 7063 3027 2c27  k_vol', 'spc0','
+00062bb0: 7370 6331 272c 2773 7063 3227 2c27 6f72  spc1','spc2','or
+00062bc0: 6730 272c 276f 7267 3127 2c27 6f72 6732  g0','org1','org2
+00062bd0: 272c 2764 696d 7827 2c27 6469 6d79 272c  ','dimx','dimy',
+00062be0: 2764 696d 7a27 2c27 6469 6d74 272c 2773  'dimz','dimt','s
+00062bf0: 6c69 6365 272c 276d 6f64 616c 6974 7927  lice','modality'
+00062c00: 2c20 276d 7269 7365 7269 6573 272c 2027  , 'mriseries', '
+00062c10: 6d72 696d 6667 272c 2027 6d72 696d 6f64  mrimfg', 'mrimod
+00062c20: 656c 272c 2027 6d72 694d 6167 6e65 7469  el', 'mriMagneti
+00062c30: 6346 6965 6c64 5374 7265 6e67 7468 272c  cFieldStrength',
+00062c40: 2027 6d72 6953 4152 272c 2027 6d72 6950   'mriSAR', 'mriP
+00062c50: 6978 656c 4261 6e64 7769 6474 6827 2c20  ixelBandwidth', 
+00062c60: 276d 7269 5069 7865 6c42 616e 6477 6964  'mriPixelBandwid
+00062c70: 7468 5045 272c 2027 6474 695f 6276 616c  thPE', 'dti_bval
+00062c80: 7565 4d61 7827 2c20 2764 7469 5f62 7665  ueMax', 'dti_bve
+00062c90: 636e 6f72 6d27 205d 290a 2020 2020 2020  cnorm' ]).      
+00062ca0: 2020 6f75 7464 6620 3d20 7064 2e63 6f6e    outdf = pd.con
+00062cb0: 6361 7428 205b 6f75 7464 662c 2064 6620  cat( [outdf, df 
+00062cc0: 5d2c 2061 7869 733d 302c 2069 676e 6f72  ], axis=0, ignor
+00062cd0: 655f 696e 6465 783d 4661 6c73 6520 290a  e_index=False ).
+00062ce0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+00062cf0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00062d00: 7072 696e 7428 206f 7574 6466 2029 0a20  print( outdf ). 
+00062d10: 2020 2069 6620 7669 7a5f 6669 6c65 6e61     if viz_filena
+00062d20: 6d65 2069 7320 6e6f 7420 4e6f 6e65 3a0a  me is not None:.
+00062d30: 2020 2020 2020 2020 6373 7666 6e20 3d20          csvfn = 
+00062d40: 7265 2e73 7562 2820 2270 6e67 222c 2022  re.sub( "png", "
+00062d50: 6373 7622 2c20 7669 7a5f 6669 6c65 6e61  csv", viz_filena
+00062d60: 6d65 2029 0a20 2020 2020 2020 206f 7574  me ).        out
+00062d70: 6466 2e74 6f5f 6373 7628 2063 7376 666e  df.to_csv( csvfn
+00062d80: 2029 0a20 2020 2072 6574 7572 6e20 6f75   ).    return ou
+00062d90: 7464 660a 0a64 6566 2072 656d 6f76 655f  tdf..def remove_
+00062da0: 756e 7761 6e74 6564 5f63 6f6c 756d 6e73  unwanted_columns
+00062db0: 2864 6629 3a0a 2020 2020 2320 4964 656e  (df):.    # Iden
+00062dc0: 7469 6679 2063 6f6c 756d 6e73 2074 6f20  tify columns to 
+00062dd0: 6472 6f70 3a20 7468 6f73 6520 6e61 6d65  drop: those name
+00062de0: 6420 2758 2720 6f72 2073 7461 7274 696e  d 'X' or startin
+00062df0: 6720 7769 7468 2027 556e 6e61 6d65 6427  g with 'Unnamed'
+00062e00: 0a20 2020 2063 6f6c 735f 746f 5f64 726f  .    cols_to_dro
+00062e10: 7020 3d20 5b63 6f6c 2066 6f72 2063 6f6c  p = [col for col
+00062e20: 2069 6e20 6466 2e63 6f6c 756d 6e73 2069   in df.columns i
+00062e30: 6620 636f 6c20 3d3d 2027 5827 206f 7220  f col == 'X' or 
+00062e40: 636f 6c2e 7374 6172 7473 7769 7468 2827  col.startswith('
+00062e50: 556e 6e61 6d65 6427 295d 0a20 2020 200a  Unnamed')].    .
+00062e60: 2020 2020 2320 4472 6f70 2074 6865 2069      # Drop the i
+00062e70: 6465 6e74 6966 6965 6420 636f 6c75 6d6e  dentified column
+00062e80: 7320 6672 6f6d 2074 6865 2044 6174 6146  s from the DataF
+00062e90: 7261 6d65 2c20 6966 2061 6e79 0a20 2020  rame, if any.   
+00062ea0: 2064 665f 636c 6561 6e65 6420 3d20 6466   df_cleaned = df
+00062eb0: 2e64 726f 7028 636f 6c75 6d6e 733d 636f  .drop(columns=co
+00062ec0: 6c73 5f74 6f5f 6472 6f70 2c20 6572 726f  ls_to_drop, erro
+00062ed0: 7273 3d27 6967 6e6f 7265 2729 0a20 2020  rs='ignore').   
+00062ee0: 200a 2020 2020 7265 7475 726e 2064 665f   .    return df_
+00062ef0: 636c 6561 6e65 640a 0a64 6566 2070 726f  cleaned..def pro
+00062f00: 6365 7373 5f64 6174 6166 7261 6d65 5f67  cess_dataframe_g
+00062f10: 656e 6572 616c 697a 6564 2864 662c 2067  eneralized(df, g
+00062f20: 726f 7570 5f62 795f 636f 6c75 6d6e 293a  roup_by_column):
+00062f30: 0a20 2020 2023 204d 616b 6520 7375 7265  .    # Make sure
+00062f40: 2074 6865 2067 726f 7570 5f62 795f 636f   the group_by_co
+00062f50: 6c75 6d6e 2069 7320 6578 636c 7564 6564  lumn is excluded
+00062f60: 2066 726f 6d20 626f 7468 206e 756d 6572   from both numer
+00062f70: 6963 2061 6e64 206f 7468 6572 2063 6f6c  ic and other col
+00062f80: 756d 6e73 2063 616c 6375 6c61 7469 6f6e  umns calculation
+00062f90: 730a 2020 2020 6e75 6d65 7269 635f 636f  s.    numeric_co
+00062fa0: 6c73 203d 2064 662e 7365 6c65 6374 5f64  ls = df.select_d
+00062fb0: 7479 7065 7328 696e 636c 7564 653d 276e  types(include='n
+00062fc0: 756d 6265 7227 292e 636f 6c75 6d6e 732e  umber').columns.
+00062fd0: 6469 6666 6572 656e 6365 285b 6772 6f75  difference([grou
+00062fe0: 705f 6279 5f63 6f6c 756d 6e5d 290a 2020  p_by_column]).  
+00062ff0: 2020 6f74 6865 725f 636f 6c73 203d 2064    other_cols = d
+00063000: 662e 636f 6c75 6d6e 732e 6469 6666 6572  f.columns.differ
+00063010: 656e 6365 286e 756d 6572 6963 5f63 6f6c  ence(numeric_col
+00063020: 7329 2e64 6966 6665 7265 6e63 6528 5b67  s).difference([g
+00063030: 726f 7570 5f62 795f 636f 6c75 6d6e 5d29  roup_by_column])
+00063040: 0a20 2020 200a 2020 2020 2320 4465 6669  .    .    # Defi
+00063050: 6e65 2061 6767 7265 6761 7469 6f6e 2066  ne aggregation f
+00063060: 756e 6374 696f 6e73 3a20 6d65 616e 2066  unctions: mean f
+00063070: 6f72 206e 756d 6572 6963 2063 6f6c 732c  or numeric cols,
+00063080: 206d 6f64 6520 666f 7220 6f74 6865 7220   mode for other 
+00063090: 636f 6c73 0a20 2020 2023 2055 7064 6174  cols.    # Updat
+000630a0: 6520 746f 2068 616e 646c 6520 656d 7074  e to handle empt
+000630b0: 7920 6d6f 6465 2072 6573 756c 7473 2073  y mode results s
+000630c0: 6166 656c 790a 2020 2020 6167 675f 6469  afely.    agg_di
+000630d0: 6374 203d 207b 636f 6c3a 2027 6d65 616e  ct = {col: 'mean
+000630e0: 2720 666f 7220 636f 6c20 696e 206e 756d  ' for col in num
+000630f0: 6572 6963 5f63 6f6c 737d 0a20 2020 2061  eric_cols}.    a
+00063100: 6767 5f64 6963 742e 7570 6461 7465 287b  gg_dict.update({
+00063110: 0a20 2020 2020 2020 2063 6f6c 3a20 6c61  .        col: la
+00063120: 6d62 6461 2078 3a20 7064 2e53 6572 6965  mbda x: pd.Serie
+00063130: 732e 6d6f 6465 2878 292e 696c 6f63 5b30  s.mode(x).iloc[0
+00063140: 5d20 6966 206e 6f74 2070 642e 5365 7269  ] if not pd.Seri
+00063150: 6573 2e6d 6f64 6528 7829 2e65 6d70 7479  es.mode(x).empty
+00063160: 2065 6c73 6520 4e6f 6e65 2066 6f72 2063   else None for c
+00063170: 6f6c 2069 6e20 6f74 6865 725f 636f 6c73  ol in other_cols
+00063180: 0a20 2020 207d 2920 2020 200a 2020 2020  .    })    .    
+00063190: 2320 4772 6f75 7020 6279 2074 6865 2073  # Group by the s
+000631a0: 7065 6369 6669 6564 2063 6f6c 756d 6e2c  pecified column,
+000631b0: 2061 7070 6c79 696e 6720 6469 6666 6572   applying differ
+000631c0: 656e 7420 6167 6772 6567 6174 696f 6e20  ent aggregation 
+000631d0: 6675 6e63 7469 6f6e 7320 746f 2064 6966  functions to dif
+000631e0: 6665 7265 6e74 2063 6f6c 756d 6e73 0a20  ferent columns. 
+000631f0: 2020 2070 726f 6365 7373 6564 5f64 6620     processed_df 
+00063200: 3d20 6466 2e67 726f 7570 6279 2867 726f  = df.groupby(gro
+00063210: 7570 5f62 795f 636f 6c75 6d6e 2c20 6173  up_by_column, as
+00063220: 5f69 6e64 6578 3d46 616c 7365 292e 6167  _index=False).ag
+00063230: 6728 6167 675f 6469 6374 290a 2020 2020  g(agg_dict).    
+00063240: 7265 7475 726e 2070 726f 6365 7373 6564  return processed
+00063250: 5f64 660a 0a64 6566 2061 7665 7261 6765  _df..def average
+00063260: 5f62 6c69 6e64 5f71 635f 6279 5f6d 6f64  _blind_qc_by_mod
+00063270: 616c 6974 7928 7163 5f66 756c 6c2c 7665  ality(qc_full,ve
+00063280: 7262 6f73 653d 4661 6c73 6529 3a0a 2020  rbose=False):.  
+00063290: 2020 2222 220a 2020 2020 4176 6572 6167    """.    Averag
+000632a0: 6573 2074 696d 6520 7365 7269 6573 2071  es time series q
+000632b0: 6320 7265 7375 6c74 7320 746f 2079 6965  c results to yie
+000632c0: 6c64 206f 6e65 2065 6e74 7279 2070 6572  ld one entry per
+000632d0: 2069 6d61 6765 2e20 7468 6973 2061 6c73   image. this als
+000632e0: 6f20 6669 6c74 6572 7320 746f 2022 6b6e  o filters to "kn
+000632f0: 6f77 6e22 2063 6f6c 756d 6e73 2e0a 0a20  own" columns... 
+00063300: 2020 2041 7267 733a 0a20 2020 2071 635f     Args:.    qc_
+00063310: 6675 6c6c 3a20 7061 6e64 6173 2064 6174  full: pandas dat
+00063320: 6166 7261 6d65 2063 6f6e 7461 696e 696e  aframe containin
+00063330: 6720 7468 6520 6675 6c6c 2071 6320 6461  g the full qc da
+00063340: 7461 2e0a 0a20 2020 2052 6574 7572 6e73  ta...    Returns
+00063350: 3a0a 2020 2020 7061 6e64 6173 2064 6174  :.    pandas dat
+00063360: 6166 7261 6d65 2063 6f6e 7461 696e 696e  aframe containin
+00063370: 6720 7468 6520 7072 6f63 6573 7365 6420  g the processed 
+00063380: 7163 2064 6174 612e 0a20 2020 2022 2222  qc data..    """
+00063390: 0a20 2020 2071 635f 6675 6c6c 203d 2072  .    qc_full = r
+000633a0: 656d 6f76 655f 756e 7761 6e74 6564 5f63  emove_unwanted_c
+000633b0: 6f6c 756d 6e73 2820 7163 5f66 756c 6c20  olumns( qc_full 
+000633c0: 290a 2020 2020 2320 4765 7420 756e 6971  ).    # Get uniq
+000633d0: 7565 206d 6f64 616c 6974 6965 730a 2020  ue modalities.  
+000633e0: 2020 6d6f 6461 6c69 7469 6573 203d 2071    modalities = q
+000633f0: 635f 6675 6c6c 5b27 6d6f 6461 6c69 7479  c_full['modality
+00063400: 275d 2e75 6e69 7175 6528 290a 2020 2020  '].unique().    
+00063410: 6d6f 6461 6c69 7469 6573 203d 206d 6f64  modalities = mod
+00063420: 616c 6974 6965 735b 6d6f 6461 6c69 7469  alities[modaliti
+00063430: 6573 2021 3d20 2775 6e6b 6e6f 776e 275d  es != 'unknown']
+00063440: 0a20 2020 2023 2047 6574 2075 6e69 7175  .    # Get uniqu
+00063450: 6520 6964 730a 2020 2020 7569 6420 3d20  e ids.    uid = 
+00063460: 7163 5f66 756c 6c5b 2766 696c 656e 616d  qc_full['filenam
+00063470: 6527 5d0a 2020 2020 746f 5f61 7665 7261  e'].    to_avera
+00063480: 6765 203d 2075 6964 2e75 6e69 7175 6528  ge = uid.unique(
+00063490: 290a 2020 2020 6d65 7461 203d 2070 642e  ).    meta = pd.
+000634a0: 4461 7461 4672 616d 6528 636f 6c75 6d6e  DataFrame(column
+000634b0: 733d 7163 5f66 756c 6c2e 636f 6c75 6d6e  s=qc_full.column
+000634c0: 7320 290a 2020 2020 2320 5072 6f63 6573  s ).    # Proces
+000634d0: 7320 6561 6368 2075 6e69 7175 6520 6964  s each unique id
+000634e0: 0a20 2020 206e 203d 206c 656e 2874 6f5f  .    n = len(to_
+000634f0: 6176 6572 6167 6529 0a20 2020 2066 6f72  average).    for
+00063500: 206b 2069 6e20 7261 6e67 6528 6e29 3a0a   k in range(n):.
+00063510: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+00063520: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00063530: 6966 206b 2025 2031 3030 203d 3d20 303a  if k % 100 == 0:
+00063540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00063550: 2070 726f 6767 6572 203d 2073 7472 2820   progger = str( 
+00063560: 6e70 2e72 6f75 6e64 2820 6b20 2f20 6e20  np.round( k / n 
+00063570: 2a20 3130 3020 2920 290a 2020 2020 2020  * 100 ) ).      
+00063580: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00063590: 2070 726f 6767 6572 2c20 656e 6420 3d22   progger, end ="
+000635a0: 2e2e 2e22 2c20 666c 7573 683d 5472 7565  ...", flush=True
+000635b0: 290a 2020 2020 2020 2020 6d31 7365 6c20  ).        m1sel 
+000635c0: 3d20 7569 6420 3d3d 2074 6f5f 6176 6572  = uid == to_aver
+000635d0: 6167 655b 6b5d 0a20 2020 2020 2020 2069  age[k].        i
+000635e0: 6620 7375 6d28 6d31 7365 6c29 203e 2031  f sum(m1sel) > 1
+000635f0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00063600: 4966 206d 6f72 6520 7468 616e 206f 6e65  If more than one
+00063610: 2065 6e74 7279 2066 6f72 2069 642c 2074   entry for id, t
+00063620: 616b 6520 7468 6520 6176 6572 6167 6520  ake the average 
+00063630: 6f66 2063 6f6e 7469 6e75 6f75 7320 636f  of continuous co
+00063640: 6c75 6d6e 732c 0a20 2020 2020 2020 2020  lumns,.         
+00063650: 2020 2023 206d 6178 696d 756d 206f 6620     # maximum of 
+00063660: 7468 6520 736c 6963 6520 636f 6c75 6d6e  the slice column
+00063670: 2c20 616e 6420 7468 6520 6669 7273 7420  , and the first 
+00063680: 656e 7472 7920 6f66 2074 6865 206f 7468  entry of the oth
+00063690: 6572 2063 6f6c 756d 6e73 0a20 2020 2020  er columns.     
+000636a0: 2020 2020 2020 206d 6673 7562 203d 2070         mfsub = p
+000636b0: 726f 6365 7373 5f64 6174 6166 7261 6d65  rocess_dataframe
+000636c0: 5f67 656e 6572 616c 697a 6564 2871 635f  _generalized(qc_
+000636d0: 6675 6c6c 5b6d 3173 656c 5d2c 2766 696c  full[m1sel],'fil
+000636e0: 656e 616d 6527 290a 2020 2020 2020 2020  ename').        
+000636f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00063700: 2020 6d66 7375 6220 3d20 7163 5f66 756c    mfsub = qc_ful
+00063710: 6c5b 6d31 7365 6c5d 0a20 2020 2020 2020  l[m1sel].       
+00063720: 206d 6574 612e 6c6f 635b 6b5d 203d 206d   meta.loc[k] = m
+00063730: 6673 7562 2e69 6c6f 635b 305d 0a20 2020  fsub.iloc[0].   
+00063740: 206d 6574 615b 276d 6f64 616c 6974 7927   meta['modality'
+00063750: 5d20 3d20 6d65 7461 5b27 6d6f 6461 6c69  ] = meta['modali
+00063760: 7479 275d 2e72 6570 6c61 6365 285b 2744  ty'].replace(['D
+00063770: 5449 6477 6927 2c20 2744 5449 6230 275d  TIdwi', 'DTIb0']
+00063780: 2c20 2744 5449 272c 2072 6567 6578 3d54  , 'DTI', regex=T
+00063790: 7275 6529 0a20 2020 2072 6574 7572 6e20  rue).    return 
+000637a0: 6d65 7461 0a0a 6465 6620 776d 6828 2066  meta..def wmh( f
+000637b0: 6c61 6972 2c20 7431 2c20 7431 7365 672c  lair, t1, t1seg,
+000637c0: 0a20 2020 206d 6d66 726f 6d63 6f6e 7665  .    mmfromconve
+000637d0: 7868 756c 6c20 3d20 332e 302c 0a20 2020  xhull = 3.0,.   
+000637e0: 2073 7472 6963 743d 5472 7565 2c0a 2020   strict=True,.  
+000637f0: 2020 7072 6f62 6162 696c 6974 795f 6d61    probability_ma
+00063800: 736b 3d4e 6f6e 652c 0a20 2020 2070 7269  sk=None,.    pri
+00063810: 6f72 5f70 726f 6261 6269 6c69 7479 3d4e  or_probability=N
+00063820: 6f6e 652c 0a20 2020 206d 6f64 656c 3d27  one,.    model='
+00063830: 7379 7375 272c 0a20 2020 2076 6572 626f  sysu',.    verbo
+00063840: 7365 3d46 616c 7365 2029 203a 0a20 2020  se=False ) :.   
+00063850: 2022 2222 0a20 2020 204f 7574 7075 7473   """.    Outputs
+00063860: 2074 6865 2057 4d48 2070 726f 6261 6269   the WMH probabi
+00063870: 6c69 7479 206d 6173 6b20 616e 6420 6120  lity mask and a 
+00063880: 7375 6d6d 6172 7920 7369 6e67 6c65 206d  summary single m
+00063890: 6561 7375 7265 6d65 6e74 0a0a 2020 2020  easurement..    
+000638a0: 4172 6775 6d65 6e74 730a 2020 2020 2d2d  Arguments.    --
+000638b0: 2d2d 2d2d 2d2d 2d0a 2020 2020 666c 6169  -------.    flai
+000638c0: 7220 3a20 414e 5473 496d 6167 650a 2020  r : ANTsImage.  
+000638d0: 2020 2020 2020 696e 7075 7420 332d 4420        input 3-D 
+000638e0: 464c 4149 5220 6272 6169 6e20 696d 6167  FLAIR brain imag
+000638f0: 6520 286e 6f74 2073 6b75 6c6c 2d73 7472  e (not skull-str
+00063900: 6970 7065 6429 2e0a 0a20 2020 2074 3120  ipped)...    t1 
+00063910: 3a20 414e 5473 496d 6167 650a 2020 2020  : ANTsImage.    
+00063920: 2020 2020 696e 7075 7420 332d 4420 5431      input 3-D T1
+00063930: 2062 7261 696e 2069 6d61 6765 2028 6e6f   brain image (no
+00063940: 7420 736b 756c 6c2d 7374 7269 7070 6564  t skull-stripped
+00063950: 292e 0a0a 2020 2020 7431 7365 6720 3a20  )...    t1seg : 
+00063960: 414e 5473 496d 6167 650a 2020 2020 2020  ANTsImage.      
+00063970: 2020 5431 2073 6567 6d65 6e74 6174 696f    T1 segmentatio
+00063980: 6e20 696d 6167 650a 0a20 2020 206d 6d66  n image..    mmf
+00063990: 726f 6d63 6f6e 7665 7868 756c 6c20 3a20  romconvexhull : 
+000639a0: 666c 6f61 740a 2020 2020 2020 2020 7265  float.        re
+000639b0: 7374 7269 6374 2057 4d48 2074 6f20 7265  strict WMH to re
+000639c0: 6769 6f6e 7320 7468 6174 2061 7265 2057  gions that are W
+000639d0: 4d20 6f72 206d 6d66 726f 6d63 6f6e 7665  M or mmfromconve
+000639e0: 7868 756c 6c20 6d6d 2061 7761 7920 6672  xhull mm away fr
+000639f0: 6f6d 2074 6865 0a20 2020 2020 2020 2063  om the.        c
+00063a00: 6f6e 7665 7820 6875 6c6c 206f 6620 7468  onvex hull of th
+00063a10: 6520 6365 7265 6272 756d 2e20 2020 7765  e cerebrum.   we
+00063a20: 2063 686f 6f73 6520 6120 6465 6661 756c   choose a defaul
+00063a30: 7420 7661 6c75 6520 6261 7365 6420 6f6e  t value based on
+00063a40: 0a20 2020 2020 2020 2046 6967 7572 6520  .        Figure 
+00063a50: 3420 6672 6f6d 3a0a 2020 2020 2020 2020  4 from:.        
+00063a60: 6874 7470 733a 2f2f 7777 772e 6e63 6269  https://www.ncbi
+00063a70: 2e6e 6c6d 2e6e 6968 2e67 6f76 2f70 6d63  .nlm.nih.gov/pmc
+00063a80: 2f61 7274 6963 6c65 732f 504d 4336 3234  /articles/PMC624
+00063a90: 3035 3739 2f70 6466 2f66 6e61 6769 2d31  0579/pdf/fnagi-1
+00063aa0: 302d 3030 3333 392e 7064 660a 0a20 2020  0-00339.pdf..   
+00063ab0: 2073 7472 6963 743a 2062 6f6f 6c65 616e   strict: boolean
+00063ac0: 202d 2069 6620 5472 7565 2c20 6f6e 6c79   - if True, only
+00063ad0: 2075 7365 2063 6f6e 7665 7820 6875 6c6c   use convex hull
+00063ae0: 2064 6973 7461 6e63 650a 0a20 2020 2070   distance..    p
+00063af0: 726f 6261 6269 6c69 7479 5f6d 6173 6b20  robability_mask 
+00063b00: 3a20 4e6f 6e65 202d 2075 7365 2074 6f20  : None - use to 
+00063b10: 636f 6d70 7574 6520 776d 6820 6a75 7374  compute wmh just
+00063b20: 206f 6e63 6520 2d20 7468 656e 2074 6869   once - then thi
+00063b30: 7320 6675 6e63 7469 6f6e 0a20 2020 2020  s function.     
+00063b40: 2020 206a 7573 7420 646f 6573 2072 6566     just does ref
+00063b50: 696e 656d 656e 7420 616e 6420 7375 6d6d  inement and summ
+00063b60: 6172 790a 0a20 2020 2070 7269 6f72 5f70  ary..    prior_p
+00063b70: 726f 6261 6269 6c69 7479 203a 206f 7074  robability : opt
+00063b80: 696f 6e61 6c20 7072 696f 7220 7072 6f62  ional prior prob
+00063b90: 6162 696c 6974 7920 696d 6167 6520 696e  ability image in
+00063ba0: 2073 7061 6365 206f 6620 7468 6520 696e   space of the in
+00063bb0: 7075 7420 7431 0a0a 2020 2020 6d6f 6465  put t1..    mode
+00063bc0: 6c20 3a20 6569 7468 6572 2073 7973 7520  l : either sysu 
+00063bd0: 6f72 2068 7970 6572 0a0a 2020 2020 7665  or hyper..    ve
+00063be0: 7262 6f73 6520 3a20 626f 6f6c 6561 6e0a  rbose : boolean.
+00063bf0: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
+00063c00: 202d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2057   ---------.    W
+00063c10: 4d48 2070 726f 6261 6269 6c69 7479 206d  MH probability m
+00063c20: 6170 2061 6e64 2061 2073 756d 6d61 7279  ap and a summary
+00063c30: 2073 696e 676c 6520 6d65 6173 7572 656d   single measurem
+00063c40: 656e 7420 7768 6963 6820 6973 2074 6865  ent which is the
+00063c50: 2073 756d 206f 6620 7468 6520 574d 4820   sum of the WMH 
+00063c60: 6d61 700a 0a20 2020 2022 2222 0a20 2020  map..    """.   
+00063c70: 2069 6d70 6f72 7420 6e75 6d70 7920 6173   import numpy as
+00063c80: 206e 700a 2020 2020 696d 706f 7274 206d   np.    import m
+00063c90: 6174 680a 2020 2020 7431 5f32 5f66 6c61  ath.    t1_2_fla
+00063ca0: 6972 5f72 6567 203d 2061 6e74 732e 7265  ir_reg = ants.re
+00063cb0: 6769 7374 7261 7469 6f6e 2866 6c61 6972  gistration(flair
+00063cc0: 2c20 7431 2c20 7479 7065 5f6f 665f 7472  , t1, type_of_tr
+00063cd0: 616e 7366 6f72 6d20 3d20 2752 6967 6964  ansform = 'Rigid
+00063ce0: 2729 2023 2052 6567 6973 7465 7220 5431  ') # Register T1
+00063cf0: 2074 6f20 466c 6169 720a 2020 2020 6966   to Flair.    if
+00063d00: 2070 726f 6261 6269 6c69 7479 5f6d 6173   probability_mas
+00063d10: 6b20 6973 204e 6f6e 6520 616e 6420 6d6f  k is None and mo
+00063d20: 6465 6c20 3d3d 2027 7379 7375 273a 0a20  del == 'sysu':. 
+00063d30: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+00063d40: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+00063d50: 7269 6e74 2827 7379 7375 2729 0a20 2020  rint('sysu').   
+00063d60: 2020 2020 2070 726f 6261 6269 6c69 7479       probability
+00063d70: 5f6d 6173 6b20 3d20 616e 7473 7079 6e65  _mask = antspyne
+00063d80: 742e 7379 7375 5f6d 6564 6961 5f77 6d68  t.sysu_media_wmh
+00063d90: 5f73 6567 6d65 6e74 6174 696f 6e28 2066  _segmentation( f
+00063da0: 6c61 6972 2029 0a20 2020 2065 6c69 6620  lair ).    elif 
+00063db0: 7072 6f62 6162 696c 6974 795f 6d61 736b  probability_mask
+00063dc0: 2069 7320 4e6f 6e65 2061 6e64 206d 6f64   is None and mod
+00063dd0: 656c 203d 3d20 2768 7970 6572 273a 0a20  el == 'hyper':. 
+00063de0: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+00063df0: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+00063e00: 7269 6e74 2827 6879 7065 7227 290a 2020  rint('hyper').  
+00063e10: 2020 2020 2020 7072 6f62 6162 696c 6974        probabilit
+00063e20: 795f 6d61 736b 203d 2061 6e74 7370 796e  y_mask = antspyn
+00063e30: 6574 2e68 7970 6572 6d61 7070 3372 5f73  et.hypermapp3r_s
+00063e40: 6567 6d65 6e74 6174 696f 6e28 2074 315f  egmentation( t1_
+00063e50: 325f 666c 6169 725f 7265 675b 2777 6172  2_flair_reg['war
+00063e60: 7065 646d 6f76 6f75 7427 5d2c 2066 6c61  pedmovout'], fla
+00063e70: 6972 2029 0a20 2020 2023 2074 315f 325f  ir ).    # t1_2_
+00063e80: 666c 6169 725f 7265 6720 3d20 7472 615f  flair_reg = tra_
+00063e90: 696e 6974 6961 6c69 7a65 7228 2066 6c61  initializer( fla
+00063ea0: 6972 2c20 7431 2c20 6e5f 7369 6d75 6c61  ir, t1, n_simula
+00063eb0: 7469 6f6e 733d 342c 206d 6178 5f72 6f74  tions=4, max_rot
+00063ec0: 6174 696f 6e3d 352c 2074 7261 6e73 666f  ation=5, transfo
+00063ed0: 726d 3d5b 2772 6967 6964 275d 2c20 7665  rm=['rigid'], ve
+00063ee0: 7262 6f73 653d 4661 6c73 6520 290a 2020  rbose=False ).  
+00063ef0: 2020 7072 696f 725f 7072 6f62 6162 696c    prior_probabil
+00063f00: 6974 795f 666c 6169 7220 3d20 4e6f 6e65  ity_flair = None
+00063f10: 0a20 2020 2069 6620 7072 696f 725f 7072  .    if prior_pr
+00063f20: 6f62 6162 696c 6974 7920 6973 206e 6f74  obability is not
+00063f30: 204e 6f6e 653a 0a20 2020 2020 2020 2070   None:.        p
+00063f40: 7269 6f72 5f70 726f 6261 6269 6c69 7479  rior_probability
+00063f50: 5f66 6c61 6972 203d 2061 6e74 732e 6170  _flair = ants.ap
+00063f60: 706c 795f 7472 616e 7366 6f72 6d73 2820  ply_transforms( 
+00063f70: 666c 6169 722c 2070 7269 6f72 5f70 726f  flair, prior_pro
+00063f80: 6261 6269 6c69 7479 2c0a 2020 2020 2020  bability,.      
+00063f90: 2020 2020 2020 7431 5f32 5f66 6c61 6972        t1_2_flair
+00063fa0: 5f72 6567 5b27 6677 6474 7261 6e73 666f  _reg['fwdtransfo
+00063fb0: 726d 7327 5d20 290a 2020 2020 776d 7365  rms'] ).    wmse
+00063fc0: 675f 6d61 736b 203d 2061 6e74 732e 7468  g_mask = ants.th
+00063fd0: 7265 7368 6f6c 645f 696d 6167 6528 2074  reshold_image( t
+00063fe0: 3173 6567 2c0a 2020 2020 2020 2020 6c6f  1seg,.        lo
+00063ff0: 775f 7468 7265 7368 203d 2033 2c20 6869  w_thresh = 3, hi
+00064000: 6768 5f74 6872 6573 6820 3d20 3329 2e69  gh_thresh = 3).i
+00064010: 4d61 7468 2822 4669 6c6c 486f 6c65 7322  Math("FillHoles"
+00064020: 290a 2020 2020 776d 7365 675f 6d61 736b  ).    wmseg_mask
+00064030: 5f75 7365 203d 2061 6e74 732e 696d 6167  _use = ants.imag
+00064040: 655f 636c 6f6e 6528 2077 6d73 6567 5f6d  e_clone( wmseg_m
+00064050: 6173 6b20 290a 2020 2020 6469 7374 6d61  ask ).    distma
+00064060: 736b 203d 204e 6f6e 650a 2020 2020 6966  sk = None.    if
+00064070: 206d 6d66 726f 6d63 6f6e 7665 7868 756c   mmfromconvexhul
+00064080: 6c20 3e20 303a 0a20 2020 2020 2020 2020  l > 0:.         
+00064090: 2020 2063 6f6e 7665 7868 756c 6c20 3d20     convexhull = 
+000640a0: 616e 7473 2e74 6872 6573 686f 6c64 5f69  ants.threshold_i
+000640b0: 6d61 6765 2820 7431 7365 672c 2031 2c20  mage( t1seg, 1, 
+000640c0: 3420 290a 2020 2020 2020 2020 2020 2020  4 ).            
+000640d0: 7370 6332 766f 7820 3d20 6e70 2e70 726f  spc2vox = np.pro
+000640e0: 6428 2061 6e74 732e 6765 745f 7370 6163  d( ants.get_spac
+000640f0: 696e 6728 2074 3173 6567 2029 2029 0a20  ing( t1seg ) ). 
+00064100: 2020 2020 2020 2020 2020 2076 6f78 6469             voxdi
+00064110: 7374 203d 2030 2e30 0a20 2020 2020 2020  st = 0.0.       
+00064120: 2020 2020 206d 7973 7063 203d 2061 6e74       myspc = ant
+00064130: 732e 6765 745f 7370 6163 696e 6728 2074  s.get_spacing( t
+00064140: 3173 6567 2029 0a20 2020 2020 2020 2020  1seg ).         
+00064150: 2020 2066 6f72 206b 2069 6e20 7261 6e67     for k in rang
+00064160: 6528 2074 3173 6567 2e64 696d 656e 7369  e( t1seg.dimensi
+00064170: 6f6e 2029 3a0a 2020 2020 2020 2020 2020  on ):.          
+00064180: 2020 2020 2020 766f 7864 6973 7420 3d20        voxdist = 
+00064190: 766f 7864 6973 7420 2b20 6d79 7370 635b  voxdist + myspc[
+000641a0: 6b5d 202a 206d 7973 7063 5b6b 5d0a 2020  k] * myspc[k].  
+000641b0: 2020 2020 2020 2020 2020 766f 7864 6973            voxdis
+000641c0: 7420 3d20 6d61 7468 2e73 7172 7428 2076  t = math.sqrt( v
+000641d0: 6f78 6469 7374 2029 0a20 2020 2020 2020  oxdist ).       
+000641e0: 2020 2020 206e 6d6f 7270 6820 3d20 726f       nmorph = ro
+000641f0: 756e 6428 2032 2e30 202f 2076 6f78 6469  und( 2.0 / voxdi
+00064200: 7374 2029 0a20 2020 2020 2020 2020 2020  st ).           
+00064210: 2063 6f6e 7665 7868 756c 6c20 3d20 616e   convexhull = an
+00064220: 7473 2e6d 6f72 7068 6f6c 6f67 7928 2063  ts.morphology( c
+00064230: 6f6e 7665 7868 756c 6c2c 2022 636c 6f73  onvexhull, "clos
+00064240: 6522 2c20 6e6d 6f72 7068 2029 2e69 4d61  e", nmorph ).iMa
+00064250: 7468 2822 4669 6c6c 486f 6c65 7322 290a  th("FillHoles").
+00064260: 2020 2020 2020 2020 2020 2020 6469 7374              dist
+00064270: 203d 2061 6e74 732e 694d 6174 6828 2063   = ants.iMath( c
+00064280: 6f6e 7665 7868 756c 6c2c 2022 4d61 7572  onvexhull, "Maur
+00064290: 6572 4469 7374 616e 6365 2220 2920 2a20  erDistance" ) * 
+000642a0: 2d31 2e30 0a20 2020 2020 2020 2020 2020  -1.0.           
+000642b0: 2064 6973 746d 6173 6b20 3d20 616e 7473   distmask = ants
+000642c0: 2e74 6872 6573 686f 6c64 5f69 6d61 6765  .threshold_image
+000642d0: 2820 6469 7374 2c20 6d6d 6672 6f6d 636f  ( dist, mmfromco
+000642e0: 6e76 6578 6875 6c6c 2c20 312e 6538 3020  nvexhull, 1.e80 
+000642f0: 290a 2020 2020 2020 2020 2020 2020 776d  ).            wm
+00064300: 7365 675f 6d61 736b 203d 2077 6d73 6567  seg_mask = wmseg
+00064310: 5f6d 6173 6b20 2b20 6469 7374 6d61 736b  _mask + distmask
+00064320: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00064330: 7374 7269 6374 3a0a 2020 2020 2020 2020  strict:.        
+00064340: 2020 2020 2020 2020 776d 7365 675f 6d61          wmseg_ma
+00064350: 736b 5f75 7365 203d 2061 6e74 732e 7468  sk_use = ants.th
+00064360: 7265 7368 6f6c 645f 696d 6167 6528 2077  reshold_image( w
+00064370: 6d73 6567 5f6d 6173 6b2c 2032 2c20 3220  mseg_mask, 2, 2 
+00064380: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00064390: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000643a0: 2020 2020 776d 7365 675f 6d61 736b 5f75      wmseg_mask_u
+000643b0: 7365 203d 2061 6e74 732e 7468 7265 7368  se = ants.thresh
+000643c0: 6f6c 645f 696d 6167 6528 2077 6d73 6567  old_image( wmseg
+000643d0: 5f6d 6173 6b2c 2031 2c20 3220 290a 2020  _mask, 1, 2 ).  
+000643e0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+000643f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00064400: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00064410: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00064420: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00064430: 0a20 2020 2077 6d73 6567 5f32 5f66 6c61  .    wmseg_2_fla
+00064440: 6972 203d 2061 6e74 732e 6170 706c 795f  ir = ants.apply_
+00064450: 7472 616e 7366 6f72 6d73 2866 6c61 6972  transforms(flair
+00064460: 2c20 776d 7365 675f 6d61 736b 5f75 7365  , wmseg_mask_use
+00064470: 2c0a 2020 2020 2020 2020 7472 616e 7366  ,.        transf
+00064480: 6f72 6d6c 6973 7420 3d20 7431 5f32 5f66  ormlist = t1_2_f
+00064490: 6c61 6972 5f72 6567 5b27 6677 6474 7261  lair_reg['fwdtra
+000644a0: 6e73 666f 726d 7327 5d2c 0a20 2020 2020  nsforms'],.     
+000644b0: 2020 2069 6e74 6572 706f 6c61 746f 7220     interpolator 
+000644c0: 3d20 276e 6561 7265 7374 4e65 6967 6862  = 'nearestNeighb
+000644d0: 6f72 2720 290a 2020 2020 7365 675f 325f  or' ).    seg_2_
+000644e0: 666c 6169 7220 3d20 616e 7473 2e61 7070  flair = ants.app
+000644f0: 6c79 5f74 7261 6e73 666f 726d 7328 666c  ly_transforms(fl
+00064500: 6169 722c 2074 3173 6567 2c0a 2020 2020  air, t1seg,.    
+00064510: 2020 2020 7472 616e 7366 6f72 6d6c 6973      transformlis
+00064520: 7420 3d20 7431 5f32 5f66 6c61 6972 5f72  t = t1_2_flair_r
+00064530: 6567 5b27 6677 6474 7261 6e73 666f 726d  eg['fwdtransform
+00064540: 7327 5d2c 0a20 2020 2020 2020 2069 6e74  s'],.        int
+00064550: 6572 706f 6c61 746f 7220 3d20 276e 6561  erpolator = 'nea
+00064560: 7265 7374 4e65 6967 6862 6f72 2720 290a  restNeighbor' ).
+00064570: 2020 2020 6373 666d 6173 6b20 3d20 616e      csfmask = an
+00064580: 7473 2e74 6872 6573 686f 6c64 5f69 6d61  ts.threshold_ima
+00064590: 6765 2873 6567 5f32 5f66 6c61 6972 2c31  ge(seg_2_flair,1
+000645a0: 2c31 290a 2020 2020 666c 6169 7273 6e72  ,1).    flairsnr
+000645b0: 203d 206d 6173 6b5f 736e 7228 2066 6c61   = mask_snr( fla
+000645c0: 6972 2c20 6373 666d 6173 6b2c 2077 6d73  ir, csfmask, wms
+000645d0: 6567 5f32 5f66 6c61 6972 2c20 6269 6173  eg_2_flair, bias
+000645e0: 5f63 6f72 7265 6374 203d 2046 616c 7365  _correct = False
+000645f0: 2029 0a20 2020 2070 726f 6261 6269 6c69   ).    probabili
+00064600: 7479 5f6d 6173 6b5f 574d 203d 2077 6d73  ty_mask_WM = wms
+00064610: 6567 5f32 5f66 6c61 6972 202a 2070 726f  eg_2_flair * pro
+00064620: 6261 6269 6c69 7479 5f6d 6173 6b20 2320  bability_mask # 
+00064630: 5265 6d6f 7665 2057 4d48 2073 6967 6e61  Remove WMH signa
+00064640: 6c20 6f75 7473 6964 6520 6f66 2057 4d0a  l outside of WM.
+00064650: 2020 2020 776d 685f 7375 6d20 3d20 6e70      wmh_sum = np
+00064660: 2e70 726f 6428 2061 6e74 732e 6765 745f  .prod( ants.get_
+00064670: 7370 6163 696e 6728 2066 6c61 6972 2029  spacing( flair )
+00064680: 2029 202a 2070 726f 6261 6269 6c69 7479   ) * probability
+00064690: 5f6d 6173 6b5f 574d 2e73 756d 2829 0a20  _mask_WM.sum(). 
+000646a0: 2020 2077 6d68 5f73 756d 5f70 7269 6f72     wmh_sum_prior
+000646b0: 203d 206d 6174 682e 6e61 6e0a 2020 2020   = math.nan.    
+000646c0: 7072 6f62 6162 696c 6974 795f 6d61 736b  probability_mask
+000646d0: 5f70 6f73 7465 7269 6f72 203d 204e 6f6e  _posterior = Non
+000646e0: 650a 2020 2020 6966 2070 7269 6f72 5f70  e.    if prior_p
+000646f0: 726f 6261 6269 6c69 7479 5f66 6c61 6972  robability_flair
+00064700: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00064710: 2020 2020 2020 7072 6f62 6162 696c 6974        probabilit
+00064720: 795f 6d61 736b 5f70 6f73 7465 7269 6f72  y_mask_posterior
+00064730: 203d 2070 7269 6f72 5f70 726f 6261 6269   = prior_probabi
+00064740: 6c69 7479 5f66 6c61 6972 202a 2070 726f  lity_flair * pro
+00064750: 6261 6269 6c69 7479 5f6d 6173 6b20 2320  bability_mask # 
+00064760: 7573 6520 7072 696f 720a 2020 2020 2020  use prior.      
+00064770: 2020 776d 685f 7375 6d5f 7072 696f 7220    wmh_sum_prior 
+00064780: 3d20 6e70 2e70 726f 6428 2061 6e74 732e  = np.prod( ants.
+00064790: 6765 745f 7370 6163 696e 6728 666c 6169  get_spacing(flai
+000647a0: 7229 2029 202a 2070 726f 6261 6269 6c69  r) ) * probabili
+000647b0: 7479 5f6d 6173 6b5f 706f 7374 6572 696f  ty_mask_posterio
+000647c0: 722e 7375 6d28 290a 2020 2020 6966 206d  r.sum().    if m
+000647d0: 6174 682e 6973 6e61 6e28 2077 6d68 5f73  ath.isnan( wmh_s
+000647e0: 756d 2029 3a0a 2020 2020 2020 2020 776d  um ):.        wm
+000647f0: 685f 7375 6d3d 300a 2020 2020 6966 206d  h_sum=0.    if m
+00064800: 6174 682e 6973 6e61 6e28 2077 6d68 5f73  ath.isnan( wmh_s
+00064810: 756d 5f70 7269 6f72 2029 3a0a 2020 2020  um_prior ):.    
+00064820: 2020 2020 776d 685f 7375 6d5f 7072 696f      wmh_sum_prio
+00064830: 723d 300a 2020 2020 666c 6169 725f 6576  r=0.    flair_ev
+00064840: 7220 3d20 616e 7473 7079 7431 772e 7061  r = antspyt1w.pa
+00064850: 7463 685f 6569 6765 6e76 616c 7565 5f72  tch_eigenvalue_r
+00064860: 6174 696f 2820 666c 6169 722c 2035 3132  atio( flair, 512
+00064870: 2c20 5b31 362c 3136 2c31 365d 2c20 6576  , [16,16,16], ev
+00064880: 6465 7074 6820 3d20 302e 392c 206d 6173  depth = 0.9, mas
+00064890: 6b3d 776d 7365 675f 325f 666c 6169 7220  k=wmseg_2_flair 
+000648a0: 290a 2020 2020 7265 7475 726e 7b0a 2020  ).    return{.  
+000648b0: 2020 2020 2020 2757 4d48 5f70 726f 6261        'WMH_proba
+000648c0: 6269 6c69 7479 5f6d 6170 5f72 6177 273a  bility_map_raw':
+000648d0: 2070 726f 6261 6269 6c69 7479 5f6d 6173   probability_mas
+000648e0: 6b2c 0a20 2020 2020 2020 2027 574d 485f  k,.        'WMH_
+000648f0: 7072 6f62 6162 696c 6974 795f 6d61 7027  probability_map'
+00064900: 203a 2070 726f 6261 6269 6c69 7479 5f6d   : probability_m
+00064910: 6173 6b5f 574d 2c0a 2020 2020 2020 2020  ask_WM,.        
+00064920: 2757 4d48 5f70 6f73 7465 7269 6f72 5f70  'WMH_posterior_p
+00064930: 726f 6261 6269 6c69 7479 5f6d 6170 2720  robability_map' 
+00064940: 3a20 7072 6f62 6162 696c 6974 795f 6d61  : probability_ma
+00064950: 736b 5f70 6f73 7465 7269 6f72 2c0a 2020  sk_posterior,.  
+00064960: 2020 2020 2020 2777 6d68 5f6d 6173 7327        'wmh_mass'
+00064970: 3a20 776d 685f 7375 6d2c 0a20 2020 2020  : wmh_sum,.     
+00064980: 2020 2027 776d 685f 6d61 7373 5f70 7269     'wmh_mass_pri
+00064990: 6f72 273a 2077 6d68 5f73 756d 5f70 7269  or': wmh_sum_pri
+000649a0: 6f72 2c0a 2020 2020 2020 2020 2777 6d68  or,.        'wmh
+000649b0: 5f65 7672 2720 3a20 666c 6169 725f 6576  _evr' : flair_ev
+000649c0: 722c 0a20 2020 2020 2020 2027 776d 685f  r,.        'wmh_
+000649d0: 534e 5227 203a 2066 6c61 6972 736e 722c  SNR' : flairsnr,
+000649e0: 0a20 2020 2020 2020 2027 636f 6e76 6578  .        'convex
+000649f0: 6875 6c6c 5f6d 6173 6b27 3a20 6469 7374  hull_mask': dist
+00064a00: 6d61 736b 207d 0a0a 0a64 6566 2072 6570  mask }...def rep
+00064a10: 6c61 6365 5f65 6c65 6d65 6e74 735f 696e  lace_elements_in
+00064a20: 5f6e 756d 7079 5f61 7272 6179 286f 7269  _numpy_array(ori
+00064a30: 6769 6e61 6c5f 6172 7261 792c 2069 6e64  ginal_array, ind
+00064a40: 6963 6573 5f74 6f5f 7265 706c 6163 652c  ices_to_replace,
+00064a50: 206e 6577 5f76 616c 7565 293a 0a20 2020   new_value):.   
+00064a60: 2022 2222 0a20 2020 2052 6570 6c61 6365   """.    Replace
+00064a70: 2073 7065 6369 6669 6564 2065 6c65 6d65   specified eleme
+00064a80: 6e74 7320 6f72 2072 6f77 7320 696e 2061  nts or rows in a
+00064a90: 206e 756d 7079 2061 7272 6179 2077 6974   numpy array wit
+00064aa0: 6820 6120 6e65 7720 7661 6c75 652e 0a0a  h a new value...
+00064ab0: 2020 2020 5061 7261 6d65 7465 7273 3a0a      Parameters:.
+00064ac0: 2020 2020 6f72 6967 696e 616c 5f61 7272      original_arr
+00064ad0: 6179 2028 6e75 6d70 792e 6e64 6172 7261  ay (numpy.ndarra
+00064ae0: 7929 3a20 4120 6e75 6d70 7920 6172 7261  y): A numpy arra
+00064af0: 7920 696e 2077 6869 6368 2065 6c65 6d65  y in which eleme
+00064b00: 6e74 7320 6f72 2072 6f77 7320 6172 6520  nts or rows are 
+00064b10: 746f 2062 6520 7265 706c 6163 6564 2e0a  to be replaced..
+00064b20: 2020 2020 696e 6469 6365 735f 746f 5f72      indices_to_r
+00064b30: 6570 6c61 6365 2028 6c69 7374 206f 7220  eplace (list or 
+00064b40: 6e75 6d70 792e 6e64 6172 7261 7929 3a20  numpy.ndarray): 
+00064b50: 496e 6469 6365 7320 6f66 2065 6c65 6d65  Indices of eleme
+00064b60: 6e74 7320 6f72 2072 6f77 7320 746f 2062  nts or rows to b
+00064b70: 6520 7265 706c 6163 6564 2e0a 2020 2020  e replaced..    
+00064b80: 6e65 775f 7661 6c75 653a 2054 6865 206e  new_value: The n
+00064b90: 6577 2076 616c 7565 2074 6f20 7265 706c  ew value to repl
+00064ba0: 6163 6520 7468 6520 7370 6563 6966 6965  ace the specifie
+00064bb0: 6420 656c 656d 656e 7473 206f 7220 726f  d elements or ro
+00064bc0: 7773 2e0a 0a20 2020 2052 6574 7572 6e73  ws...    Returns
+00064bd0: 3a0a 2020 2020 6e75 6d70 792e 6e64 6172  :.    numpy.ndar
+00064be0: 7261 793a 2041 206e 6577 206e 756d 7079  ray: A new numpy
+00064bf0: 2061 7272 6179 2077 6974 6820 7468 6520   array with the 
+00064c00: 7370 6563 6966 6965 6420 656c 656d 656e  specified elemen
+00064c10: 7473 206f 7220 726f 7773 2072 6570 6c61  ts or rows repla
+00064c20: 6365 642e 2049 6620 7468 6520 696e 7075  ced. If the inpu
+00064c30: 7420 6172 7261 7920 6973 204e 6f6e 652c  t array is None,
+00064c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00064c50: 2020 2020 7468 6520 6675 6e63 7469 6f6e      the function
+00064c60: 2072 6574 7572 6e73 204e 6f6e 652e 0a20   returns None.. 
+00064c70: 2020 2022 2222 0a0a 2020 2020 6966 206f     """..    if o
+00064c80: 7269 6769 6e61 6c5f 6172 7261 7920 6973  riginal_array is
+00064c90: 204e 6f6e 653a 0a20 2020 2020 2020 2072   None:.        r
+00064ca0: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
+00064cb0: 6d61 785f 696e 6465 7820 3d20 6f72 6967  max_index = orig
+00064cc0: 696e 616c 5f61 7272 6179 2e73 697a 6520  inal_array.size 
+00064cd0: 6966 206f 7269 6769 6e61 6c5f 6172 7261  if original_arra
+00064ce0: 792e 6e64 696d 203d 3d20 3120 656c 7365  y.ndim == 1 else
+00064cf0: 206f 7269 6769 6e61 6c5f 6172 7261 792e   original_array.
+00064d00: 7368 6170 655b 305d 0a0a 2020 2020 2320  shape[0]..    # 
+00064d10: 4669 6c74 6572 206f 7574 2069 6e76 616c  Filter out inval
+00064d20: 6964 2069 6e64 6963 6573 2061 6e64 2063  id indices and c
+00064d30: 6865 636b 2066 6f72 2061 6e79 206f 7574  heck for any out
+00064d40: 2d6f 662d 626f 756e 6473 2069 6e64 6963  -of-bounds indic
+00064d50: 6573 0a20 2020 2076 616c 6964 5f69 6e64  es.    valid_ind
+00064d60: 6963 6573 203d 205b 5d0a 2020 2020 666f  ices = [].    fo
+00064d70: 7220 6964 7820 696e 2069 6e64 6963 6573  r idx in indices
+00064d80: 5f74 6f5f 7265 706c 6163 653a 0a20 2020  _to_replace:.   
+00064d90: 2020 2020 2069 6620 6964 7820 3c20 6d61       if idx < ma
+00064da0: 785f 696e 6465 783a 0a20 2020 2020 2020  x_index:.       
+00064db0: 2020 2020 2076 616c 6964 5f69 6e64 6963       valid_indic
+00064dc0: 6573 2e61 7070 656e 6428 6964 7829 0a20  es.append(idx). 
+00064dd0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00064de0: 2020 2020 2020 2020 2077 6172 6e69 6e67           warning
+00064df0: 732e 7761 726e 2866 2257 6172 6e69 6e67  s.warn(f"Warning
+00064e00: 3a20 496e 6465 7820 7b69 6478 7d20 6973  : Index {idx} is
+00064e10: 206f 7574 206f 6620 626f 756e 6473 2061   out of bounds a
+00064e20: 6e64 2077 696c 6c20 6265 2069 676e 6f72  nd will be ignor
+00064e30: 6564 2e22 290a 0a20 2020 2069 6620 6f72  ed.")..    if or
+00064e40: 6967 696e 616c 5f61 7272 6179 2e6e 6469  iginal_array.ndi
+00064e50: 6d20 3d3d 2031 3a0a 2020 2020 2020 2020  m == 1:.        
+00064e60: 2320 5265 706c 6163 6520 656c 656d 656e  # Replace elemen
+00064e70: 7473 2069 6e20 6120 3144 2061 7272 6179  ts in a 1D array
+00064e80: 0a20 2020 2020 2020 206f 7269 6769 6e61  .        origina
+00064e90: 6c5f 6172 7261 795b 7661 6c69 645f 696e  l_array[valid_in
+00064ea0: 6469 6365 735d 203d 206e 6577 5f76 616c  dices] = new_val
+00064eb0: 7565 0a20 2020 2065 6c69 6620 6f72 6967  ue.    elif orig
+00064ec0: 696e 616c 5f61 7272 6179 2e6e 6469 6d20  inal_array.ndim 
+00064ed0: 3d3d 2032 3a0a 2020 2020 2020 2020 2320  == 2:.        # 
+00064ee0: 5265 706c 6163 6520 726f 7773 2069 6e20  Replace rows in 
+00064ef0: 6120 3244 2061 7272 6179 0a20 2020 2020  a 2D array.     
+00064f00: 2020 206f 7269 6769 6e61 6c5f 6172 7261     original_arra
+00064f10: 795b 7661 6c69 645f 696e 6469 6365 732c  y[valid_indices,
+00064f20: 203a 5d20 3d20 6e65 775f 7661 6c75 650a   :] = new_value.
+00064f30: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00064f40: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00064f50: 6f72 2822 6f72 6967 696e 616c 5f61 7272  or("original_arr
+00064f60: 6179 206d 7573 7420 6265 2065 6974 6865  ay must be eithe
+00064f70: 7220 3144 206f 7220 3244 2e22 290a 0a20  r 1D or 2D.").. 
+00064f80: 2020 2072 6574 7572 6e20 6f72 6967 696e     return origin
+00064f90: 616c 5f61 7272 6179 0a0a 0a0a 6465 6620  al_array....def 
+00064fa0: 7265 6d6f 7665 5f65 6c65 6d65 6e74 735f  remove_elements_
+00064fb0: 6672 6f6d 5f6e 756d 7079 5f61 7272 6179  from_numpy_array
+00064fc0: 286f 7269 6769 6e61 6c5f 6172 7261 792c  (original_array,
+00064fd0: 2069 6e64 6963 6573 5f74 6f5f 7265 6d6f   indices_to_remo
+00064fe0: 7665 293a 0a20 2020 2022 2222 0a20 2020  ve):.    """.   
+00064ff0: 2052 656d 6f76 6520 7370 6563 6966 6965   Remove specifie
+00065000: 6420 656c 656d 656e 7473 206f 7220 726f  d elements or ro
+00065010: 7773 2066 726f 6d20 6120 6e75 6d70 7920  ws from a numpy 
+00065020: 6172 7261 792e 0a0a 2020 2020 5061 7261  array...    Para
+00065030: 6d65 7465 7273 3a0a 2020 2020 6f72 6967  meters:.    orig
+00065040: 696e 616c 5f61 7272 6179 2028 6e75 6d70  inal_array (nump
+00065050: 792e 6e64 6172 7261 7929 3a20 4120 6e75  y.ndarray): A nu
+00065060: 6d70 7920 6172 7261 7920 6672 6f6d 2077  mpy array from w
+00065070: 6869 6368 2065 6c65 6d65 6e74 7320 6f72  hich elements or
+00065080: 2072 6f77 7320 6172 6520 746f 2062 6520   rows are to be 
+00065090: 7265 6d6f 7665 642e 0a20 2020 2069 6e64  removed..    ind
+000650a0: 6963 6573 5f74 6f5f 7265 6d6f 7665 2028  ices_to_remove (
+000650b0: 6c69 7374 206f 7220 6e75 6d70 792e 6e64  list or numpy.nd
+000650c0: 6172 7261 7929 3a20 496e 6469 6365 7320  array): Indices 
+000650d0: 6f66 2065 6c65 6d65 6e74 7320 6f72 2072  of elements or r
+000650e0: 6f77 7320 746f 2062 6520 7265 6d6f 7665  ows to be remove
+000650f0: 642e 0a0a 2020 2020 5265 7475 726e 733a  d...    Returns:
+00065100: 0a20 2020 206e 756d 7079 2e6e 6461 7272  .    numpy.ndarr
+00065110: 6179 3a20 4120 6e65 7720 6e75 6d70 7920  ay: A new numpy 
+00065120: 6172 7261 7920 7769 7468 2074 6865 2073  array with the s
+00065130: 7065 6369 6669 6564 2065 6c65 6d65 6e74  pecified element
+00065140: 7320 6f72 2072 6f77 7320 7265 6d6f 7665  s or rows remove
+00065150: 642e 2049 6620 7468 6520 696e 7075 7420  d. If the input 
+00065160: 6172 7261 7920 6973 204e 6f6e 652c 0a20  array is None,. 
+00065170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00065180: 2020 7468 6520 6675 6e63 7469 6f6e 2072    the function r
+00065190: 6574 7572 6e73 204e 6f6e 652e 0a20 2020  eturns None..   
+000651a0: 2022 2222 0a0a 2020 2020 6966 206f 7269   """..    if ori
+000651b0: 6769 6e61 6c5f 6172 7261 7920 6973 204e  ginal_array is N
+000651c0: 6f6e 653a 0a20 2020 2020 2020 2072 6574  one:.        ret
+000651d0: 7572 6e20 4e6f 6e65 0a0a 2020 2020 6966  urn None..    if
+000651e0: 206f 7269 6769 6e61 6c5f 6172 7261 792e   original_array.
+000651f0: 6e64 696d 203d 3d20 313a 0a20 2020 2020  ndim == 1:.     
+00065200: 2020 2023 2052 656d 6f76 6520 656c 656d     # Remove elem
+00065210: 656e 7473 2066 726f 6d20 6120 3144 2061  ents from a 1D a
+00065220: 7272 6179 0a20 2020 2020 2020 2072 6574  rray.        ret
+00065230: 7572 6e20 6e70 2e64 656c 6574 6528 6f72  urn np.delete(or
+00065240: 6967 696e 616c 5f61 7272 6179 2c20 696e  iginal_array, in
+00065250: 6469 6365 735f 746f 5f72 656d 6f76 6529  dices_to_remove)
+00065260: 0a20 2020 2065 6c69 6620 6f72 6967 696e  .    elif origin
+00065270: 616c 5f61 7272 6179 2e6e 6469 6d20 3d3d  al_array.ndim ==
+00065280: 2032 3a0a 2020 2020 2020 2020 2320 5265   2:.        # Re
+00065290: 6d6f 7665 2072 6f77 7320 6672 6f6d 2061  move rows from a
+000652a0: 2032 4420 6172 7261 790a 2020 2020 2020   2D array.      
+000652b0: 2020 7265 7475 726e 206e 702e 6465 6c65    return np.dele
+000652c0: 7465 286f 7269 6769 6e61 6c5f 6172 7261  te(original_arra
+000652d0: 792c 2069 6e64 6963 6573 5f74 6f5f 7265  y, indices_to_re
+000652e0: 6d6f 7665 2c20 6178 6973 3d30 290a 2020  move, axis=0).  
+000652f0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00065300: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00065310: 2822 6f72 6967 696e 616c 5f61 7272 6179  ("original_array
+00065320: 206d 7573 7420 6265 2065 6974 6865 7220   must be either 
+00065330: 3144 206f 7220 3244 2e22 290a 0a64 6566  1D or 2D.")..def
+00065340: 2072 656d 6f76 655f 766f 6c75 6d65 735f   remove_volumes_
+00065350: 6672 6f6d 5f74 696d 6573 6572 6965 7328  from_timeseries(
+00065360: 7469 6d65 5f73 6572 6965 732c 2076 6f6c  time_series, vol
+00065370: 756d 6573 5f74 6f5f 7265 6d6f 7665 293a  umes_to_remove):
+00065380: 0a20 2020 2022 2222 0a20 2020 2052 656d  .    """.    Rem
+00065390: 6f76 6520 7370 6563 6966 6965 6420 766f  ove specified vo
+000653a0: 6c75 6d65 7320 6672 6f6d 2061 2074 696d  lumes from a tim
+000653b0: 6520 7365 7269 6573 2e0a 0a20 2020 203a  e series...    :
+000653c0: 7061 7261 6d20 7469 6d65 5f73 6572 6965  param time_serie
+000653d0: 733a 2041 4e54 7349 6d61 6765 2072 6570  s: ANTsImage rep
+000653e0: 7265 7365 6e74 696e 6720 7468 6520 7469  resenting the ti
+000653f0: 6d65 2073 6572 6965 7320 2834 4420 696d  me series (4D im
+00065400: 6167 6529 2e0a 2020 2020 3a70 6172 616d  age)..    :param
+00065410: 2076 6f6c 756d 6573 5f74 6f5f 7265 6d6f   volumes_to_remo
+00065420: 7665 3a20 4c69 7374 206f 6620 766f 6c75  ve: List of volu
+00065430: 6d65 2069 6e64 6963 6573 2074 6f20 7265  me indices to re
+00065440: 6d6f 7665 2e0a 2020 2020 3a72 6574 7572  move..    :retur
+00065450: 6e3a 2041 4e54 7349 6d61 6765 2077 6974  n: ANTsImage wit
+00065460: 6820 7370 6563 6966 6965 6420 766f 6c75  h specified volu
+00065470: 6d65 7320 7265 6d6f 7665 642e 0a20 2020  mes removed..   
+00065480: 2022 2222 0a20 2020 2069 6620 6e6f 7420   """.    if not 
+00065490: 6973 696e 7374 616e 6365 2874 696d 655f  isinstance(time_
+000654a0: 7365 7269 6573 2c20 616e 7473 2e41 4e54  series, ants.ANT
+000654b0: 7349 6d61 6765 293a 0a20 2020 2020 2020  sImage):.       
+000654c0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+000654d0: 7228 2274 696d 655f 7365 7269 6573 206d  r("time_series m
+000654e0: 7573 7420 6265 2061 6e20 414e 5473 496d  ust be an ANTsIm
+000654f0: 6167 652e 2229 0a0a 2020 2020 6966 2074  age.")..    if t
+00065500: 696d 655f 7365 7269 6573 2e64 696d 656e  ime_series.dimen
+00065510: 7369 6f6e 2021 3d20 343a 0a20 2020 2020  sion != 4:.     
+00065520: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00065530: 726f 7228 2274 696d 655f 7365 7269 6573  ror("time_series
+00065540: 206d 7573 7420 6265 2061 2034 4420 696d   must be a 4D im
+00065550: 6167 652e 2229 0a0a 2020 2020 2320 4372  age.")..    # Cr
+00065560: 6561 7465 2061 2062 6f6f 6c65 616e 2069  eate a boolean i
+00065570: 6e64 6578 2066 6f72 2076 6f6c 756d 6573  ndex for volumes
+00065580: 2074 6f20 6b65 6570 0a20 2020 2076 6f6c   to keep.    vol
+00065590: 756d 6573 5f74 6f5f 6b65 6570 203d 205b  umes_to_keep = [
+000655a0: 6920 666f 7220 6920 696e 2072 616e 6765  i for i in range
+000655b0: 2874 696d 655f 7365 7269 6573 2e73 6861  (time_series.sha
+000655c0: 7065 5b33 5d29 2069 6620 6920 6e6f 7420  pe[3]) if i not 
+000655d0: 696e 2076 6f6c 756d 6573 5f74 6f5f 7265  in volumes_to_re
+000655e0: 6d6f 7665 5d0a 0a20 2020 2023 2053 656c  move]..    # Sel
+000655f0: 6563 7420 7468 6520 766f 6c75 6d65 7320  ect the volumes 
+00065600: 746f 206b 6565 700a 2020 2020 6669 6c74  to keep.    filt
+00065610: 6572 6564 5f74 696d 655f 7365 7269 6573  ered_time_series
+00065620: 203d 2061 6e74 732e 6672 6f6d 5f6e 756d   = ants.from_num
+00065630: 7079 2820 7469 6d65 5f73 6572 6965 735b  py( time_series[
+00065640: 2e2e 2e2c 2076 6f6c 756d 6573 5f74 6f5f  ..., volumes_to_
+00065650: 6b65 6570 5d20 290a 0a20 2020 2072 6574  keep] )..    ret
+00065660: 7572 6e20 616e 7473 2e63 6f70 795f 696d  urn ants.copy_im
+00065670: 6167 655f 696e 666f 2820 7469 6d65 5f73  age_info( time_s
+00065680: 6572 6965 732c 2066 696c 7465 7265 645f  eries, filtered_
+00065690: 7469 6d65 5f73 6572 6965 7320 290a 0a64  time_series )..d
+000656a0: 6566 2072 656d 6f76 655f 656c 656d 656e  ef remove_elemen
+000656b0: 7473 5f66 726f 6d5f 6c69 7374 286f 7269  ts_from_list(ori
+000656c0: 6769 6e61 6c5f 6c69 7374 2c20 656c 656d  ginal_list, elem
+000656d0: 656e 7473 5f74 6f5f 7265 6d6f 7665 293a  ents_to_remove):
+000656e0: 0a20 2020 2022 2222 0a20 2020 2052 656d  .    """.    Rem
+000656f0: 6f76 6520 7370 6563 6966 6965 6420 656c  ove specified el
+00065700: 656d 656e 7473 2066 726f 6d20 6120 6c69  ements from a li
+00065710: 7374 2e0a 0a20 2020 2050 6172 616d 6574  st...    Paramet
+00065720: 6572 733a 0a20 2020 206f 7269 6769 6e61  ers:.    origina
+00065730: 6c5f 6c69 7374 2028 6c69 7374 293a 2054  l_list (list): T
+00065740: 6865 206f 7269 6769 6e61 6c20 6c69 7374  he original list
+00065750: 2066 726f 6d20 7768 6963 6820 656c 656d   from which elem
+00065760: 656e 7473 2077 696c 6c20 6265 2072 656d  ents will be rem
+00065770: 6f76 6564 2e0a 2020 2020 656c 656d 656e  oved..    elemen
+00065780: 7473 5f74 6f5f 7265 6d6f 7665 2028 6c69  ts_to_remove (li
+00065790: 7374 293a 2041 206c 6973 7420 6f66 2065  st): A list of e
+000657a0: 6c65 6d65 6e74 7320 7468 6174 206e 6565  lements that nee
+000657b0: 6420 746f 2062 6520 7265 6d6f 7665 6420  d to be removed 
+000657c0: 6672 6f6d 2074 6865 206f 7269 6769 6e61  from the origina
+000657d0: 6c20 6c69 7374 2e0a 0a20 2020 2052 6574  l list...    Ret
+000657e0: 7572 6e73 3a0a 2020 2020 6c69 7374 3a20  urns:.    list: 
+000657f0: 4120 6e65 7720 6c69 7374 2077 6974 6820  A new list with 
+00065800: 7468 6520 7370 6563 6966 6965 6420 656c  the specified el
+00065810: 656d 656e 7473 2072 656d 6f76 6564 2e0a  ements removed..
+00065820: 2020 2020 2222 220a 2020 2020 7265 7475      """.    retu
+00065830: 726e 205b 656c 656d 656e 7420 666f 7220  rn [element for 
+00065840: 656c 656d 656e 7420 696e 206f 7269 6769  element in origi
+00065850: 6e61 6c5f 6c69 7374 2069 6620 656c 656d  nal_list if elem
+00065860: 656e 7420 6e6f 7420 696e 2065 6c65 6d65  ent not in eleme
+00065870: 6e74 735f 746f 5f72 656d 6f76 655d 0a0a  nts_to_remove]..
+00065880: 0a64 6566 2069 6d70 7574 655f 7469 6d65  .def impute_time
+00065890: 7365 7269 6573 2874 696d 655f 7365 7269  series(time_seri
+000658a0: 6573 2c20 766f 6c75 6d65 735f 746f 5f69  es, volumes_to_i
+000658b0: 6d70 7574 652c 206d 6574 686f 643d 276c  mpute, method='l
+000658c0: 696e 6561 7227 2c20 7665 7262 6f73 653d  inear', verbose=
+000658d0: 4661 6c73 6529 3a0a 2020 2020 2222 220a  False):.    """.
+000658e0: 2020 2020 496d 7075 7465 2073 7065 6369      Impute speci
+000658f0: 6669 6564 2076 6f6c 756d 6573 2066 726f  fied volumes fro
+00065900: 6d20 6120 7469 6d65 2073 6572 6965 7320  m a time series 
+00065910: 7769 7468 2069 6e74 6572 706f 6c61 7465  with interpolate
+00065920: 6420 7661 6c75 6573 2e0a 0a20 2020 203a  d values...    :
+00065930: 7061 7261 6d20 7469 6d65 5f73 6572 6965  param time_serie
+00065940: 733a 2041 4e54 7349 6d61 6765 2072 6570  s: ANTsImage rep
+00065950: 7265 7365 6e74 696e 6720 7468 6520 7469  resenting the ti
+00065960: 6d65 2073 6572 6965 7320 2834 4420 696d  me series (4D im
+00065970: 6167 6529 2e0a 2020 2020 3a70 6172 616d  age)..    :param
+00065980: 2076 6f6c 756d 6573 5f74 6f5f 696d 7075   volumes_to_impu
+00065990: 7465 3a20 4c69 7374 206f 6620 766f 6c75  te: List of volu
+000659a0: 6d65 2069 6e64 6963 6573 2074 6f20 696d  me indices to im
+000659b0: 7075 7465 2e0a 2020 2020 3a70 6172 616d  pute..    :param
+000659c0: 206d 6574 686f 643a 2049 6e74 6572 706f   method: Interpo
+000659d0: 6c61 7469 6f6e 206d 6574 686f 6420 2827  lation method ('
+000659e0: 6c69 6e65 6172 2720 6f72 206f 7468 6572  linear' or other
+000659f0: 206d 6574 686f 6473 2069 6620 696d 706c   methods if impl
+00065a00: 656d 656e 7465 6429 2e0a 2020 2020 3a70  emented)..    :p
+00065a10: 6172 616d 2076 6572 626f 7365 3a20 626f  aram verbose: bo
+00065a20: 6f6c 6561 6e0a 2020 2020 3a72 6574 7572  olean.    :retur
+00065a30: 6e3a 2041 4e54 7349 6d61 6765 2077 6974  n: ANTsImage wit
+00065a40: 6820 7370 6563 6966 6965 6420 766f 6c75  h specified volu
+00065a50: 6d65 7320 696d 7075 7465 642e 0a20 2020  mes imputed..   
+00065a60: 2022 2222 0a20 2020 2069 6620 6e6f 7420   """.    if not 
+00065a70: 6973 696e 7374 616e 6365 2874 696d 655f  isinstance(time_
+00065a80: 7365 7269 6573 2c20 616e 7473 2e41 4e54  series, ants.ANT
+00065a90: 7349 6d61 6765 293a 0a20 2020 2020 2020  sImage):.       
+00065aa0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00065ab0: 7228 2274 696d 655f 7365 7269 6573 206d  r("time_series m
+00065ac0: 7573 7420 6265 2061 6e20 414e 5473 496d  ust be an ANTsIm
+00065ad0: 6167 652e 2229 0a0a 2020 2020 6966 2074  age.")..    if t
+00065ae0: 696d 655f 7365 7269 6573 2e64 696d 656e  ime_series.dimen
+00065af0: 7369 6f6e 2021 3d20 343a 0a20 2020 2020  sion != 4:.     
+00065b00: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00065b10: 726f 7228 2274 696d 655f 7365 7269 6573  ror("time_series
+00065b20: 206d 7573 7420 6265 2061 2034 4420 696d   must be a 4D im
+00065b30: 6167 652e 2229 0a0a 2020 2020 2320 436f  age.")..    # Co
+00065b40: 6e76 6572 7420 7469 6d65 5f73 6572 6965  nvert time_serie
+00065b50: 7320 746f 206e 756d 7079 2066 6f72 206d  s to numpy for m
+00065b60: 616e 6970 756c 6174 696f 6e0a 2020 2020  anipulation.    
+00065b70: 7469 6d65 5f73 6572 6965 735f 6e70 203d  time_series_np =
+00065b80: 2074 696d 655f 7365 7269 6573 2e6e 756d   time_series.num
+00065b90: 7079 2829 0a20 2020 2074 6f74 616c 5f76  py().    total_v
+00065ba0: 6f6c 756d 6573 203d 2074 696d 655f 7365  olumes = time_se
+00065bb0: 7269 6573 5f6e 702e 7368 6170 655b 335d  ries_np.shape[3]
+00065bc0: 0a0a 2020 2020 2320 4372 6561 7465 2061  ..    # Create a
+00065bd0: 2063 6f6d 706c 656d 656e 7420 6c69 7374   complement list
+00065be0: 206f 6620 766f 6c75 6d65 7320 6e6f 7420   of volumes not 
+00065bf0: 746f 2069 6d70 7574 650a 2020 2020 766f  to impute.    vo
+00065c00: 6c75 6d65 735f 6e6f 745f 746f 5f69 6d70  lumes_not_to_imp
+00065c10: 7574 6520 3d20 5b69 2066 6f72 2069 2069  ute = [i for i i
+00065c20: 6e20 7261 6e67 6528 746f 7461 6c5f 766f  n range(total_vo
+00065c30: 6c75 6d65 7329 2069 6620 6920 6e6f 7420  lumes) if i not 
+00065c40: 696e 2076 6f6c 756d 6573 5f74 6f5f 696d  in volumes_to_im
+00065c50: 7075 7465 5d0a 0a20 2020 2023 2044 6566  pute]..    # Def
+00065c60: 696e 6520 7468 6520 6c6f 7765 7220 616e  ine the lower an
+00065c70: 6420 7570 7065 7220 626f 756e 6473 0a20  d upper bounds. 
+00065c80: 2020 206d 696e 5f76 616c 6964 5f69 6e64     min_valid_ind
+00065c90: 6578 203d 206d 696e 2876 6f6c 756d 6573  ex = min(volumes
+00065ca0: 5f6e 6f74 5f74 6f5f 696d 7075 7465 290a  _not_to_impute).
+00065cb0: 2020 2020 6d61 785f 7661 6c69 645f 696e      max_valid_in
+00065cc0: 6465 7820 3d20 6d61 7828 766f 6c75 6d65  dex = max(volume
+00065cd0: 735f 6e6f 745f 746f 5f69 6d70 7574 6529  s_not_to_impute)
+00065ce0: 0a0a 2020 2020 666f 7220 766f 6c5f 6964  ..    for vol_id
+00065cf0: 7820 696e 2076 6f6c 756d 6573 5f74 6f5f  x in volumes_to_
+00065d00: 696d 7075 7465 3a0a 2020 2020 2020 2020  impute:.        
+00065d10: 2320 456e 7375 7265 2074 6865 2076 6f6c  # Ensure the vol
+00065d20: 756d 6520 696e 6465 7820 6973 2077 6974  ume index is wit
+00065d30: 6869 6e20 7468 6520 7661 6c69 6420 7261  hin the valid ra
+00065d40: 6e67 650a 2020 2020 2020 2020 6966 2076  nge.        if v
+00065d50: 6f6c 5f69 6478 203c 2030 206f 7220 766f  ol_idx < 0 or vo
+00065d60: 6c5f 6964 7820 3e3d 2074 6f74 616c 5f76  l_idx >= total_v
+00065d70: 6f6c 756d 6573 3a0a 2020 2020 2020 2020  olumes:.        
+00065d80: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00065d90: 7272 6f72 2866 2256 6f6c 756d 6520 696e  rror(f"Volume in
+00065da0: 6465 7820 7b76 6f6c 5f69 6478 7d20 6973  dex {vol_idx} is
+00065db0: 206f 7574 206f 6620 626f 756e 6473 2e22   out of bounds."
+00065dc0: 290a 0a20 2020 2020 2020 2023 2046 696e  )..        # Fin
+00065dd0: 6420 7468 6520 6e65 6172 6573 7420 7661  d the nearest va
+00065de0: 6c69 6420 6c6f 7765 7220 696e 6465 7820  lid lower index 
+00065df0: 7769 7468 696e 2074 6865 2062 6f75 6e64  within the bound
+00065e00: 730a 2020 2020 2020 2020 6c6f 7765 725f  s.        lower_
+00065e10: 6361 6e64 6964 6174 6573 203d 205b 7620  candidates = [v 
+00065e20: 666f 7220 7620 696e 2076 6f6c 756d 6573  for v in volumes
+00065e30: 5f6e 6f74 5f74 6f5f 696d 7075 7465 2069  _not_to_impute i
+00065e40: 6620 7620 3c3d 2076 6f6c 5f69 6478 5d0a  f v <= vol_idx].
+00065e50: 2020 2020 2020 2020 6c6f 7765 725f 6964          lower_id
+00065e60: 7820 3d20 6d61 7828 6c6f 7765 725f 6361  x = max(lower_ca
+00065e70: 6e64 6964 6174 6573 2920 6966 206c 6f77  ndidates) if low
+00065e80: 6572 5f63 616e 6469 6461 7465 7320 656c  er_candidates el
+00065e90: 7365 206d 696e 5f76 616c 6964 5f69 6e64  se min_valid_ind
+00065ea0: 6578 0a0a 2020 2020 2020 2020 2320 4669  ex..        # Fi
+00065eb0: 6e64 2074 6865 206e 6561 7265 7374 2076  nd the nearest v
+00065ec0: 616c 6964 2075 7070 6572 2069 6e64 6578  alid upper index
+00065ed0: 2077 6974 6869 6e20 7468 6520 626f 756e   within the boun
+00065ee0: 6473 0a20 2020 2020 2020 2075 7070 6572  ds.        upper
+00065ef0: 5f63 616e 6469 6461 7465 7320 3d20 5b76  _candidates = [v
+00065f00: 2066 6f72 2076 2069 6e20 766f 6c75 6d65   for v in volume
+00065f10: 735f 6e6f 745f 746f 5f69 6d70 7574 6520  s_not_to_impute 
+00065f20: 6966 2076 203e 3d20 766f 6c5f 6964 785d  if v >= vol_idx]
+00065f30: 0a20 2020 2020 2020 2075 7070 6572 5f69  .        upper_i
+00065f40: 6478 203d 206d 696e 2875 7070 6572 5f63  dx = min(upper_c
+00065f50: 616e 6469 6461 7465 7329 2069 6620 7570  andidates) if up
+00065f60: 7065 725f 6361 6e64 6964 6174 6573 2065  per_candidates e
+00065f70: 6c73 6520 6d61 785f 7661 6c69 645f 696e  lse max_valid_in
+00065f80: 6465 780a 0a20 2020 2020 2020 2069 6620  dex..        if 
+00065f90: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+00065fa0: 2020 2020 2070 7269 6e74 2866 2249 6d70       print(f"Imp
+00065fb0: 7574 696e 6720 766f 6c75 6d65 207b 766f  uting volume {vo
+00065fc0: 6c5f 6964 787d 2075 7369 6e67 2069 6e64  l_idx} using ind
+00065fd0: 6963 6573 207b 6c6f 7765 725f 6964 787d  ices {lower_idx}
+00065fe0: 2061 6e64 207b 7570 7065 725f 6964 787d   and {upper_idx}
+00065ff0: 2229 0a0a 2020 2020 2020 2020 6966 206d  ")..        if m
+00066000: 6574 686f 6420 3d3d 2027 6c69 6e65 6172  ethod == 'linear
+00066010: 273a 0a20 2020 2020 2020 2020 2020 2023  ':.            #
+00066020: 204c 696e 6561 7220 696e 7465 7270 6f6c   Linear interpol
+00066030: 6174 696f 6e20 6265 7477 6565 6e20 7468  ation between th
+00066040: 6520 7477 6f20 6e65 6172 6573 7420 766f  e two nearest vo
+00066050: 6c75 6d65 730a 2020 2020 2020 2020 2020  lumes.          
+00066060: 2020 6c6f 7765 725f 766f 6c75 6d65 203d    lower_volume =
+00066070: 2074 696d 655f 7365 7269 6573 5f6e 705b   time_series_np[
+00066080: 2e2e 2e2c 206c 6f77 6572 5f69 6478 5d0a  ..., lower_idx].
+00066090: 2020 2020 2020 2020 2020 2020 7570 7065              uppe
+000660a0: 725f 766f 6c75 6d65 203d 2074 696d 655f  r_volume = time_
+000660b0: 7365 7269 6573 5f6e 705b 2e2e 2e2c 2075  series_np[..., u
+000660c0: 7070 6572 5f69 6478 5d0a 2020 2020 2020  pper_idx].      
+000660d0: 2020 2020 2020 696e 7465 7270 6f6c 6174        interpolat
+000660e0: 6564 5f76 6f6c 756d 6520 3d20 286c 6f77  ed_volume = (low
+000660f0: 6572 5f76 6f6c 756d 6520 2b20 7570 7065  er_volume + uppe
+00066100: 725f 766f 6c75 6d65 2920 2f20 320a 2020  r_volume) / 2.  
+00066110: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00066120: 2020 2020 2020 2020 2320 506c 6163 6568          # Placeh
+00066130: 6f6c 6465 7220 666f 7220 6f74 6865 7220  older for other 
+00066140: 696e 7465 7270 6f6c 6174 696f 6e20 6d65  interpolation me
+00066150: 7468 6f64 730a 2020 2020 2020 2020 2020  thods.          
+00066160: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
+00066170: 6d65 6e74 6564 4572 726f 7228 2243 7572  mentedError("Cur
+00066180: 7265 6e74 6c79 2c20 6f6e 6c79 206c 696e  rently, only lin
+00066190: 6561 7220 696e 7465 7270 6f6c 6174 696f  ear interpolatio
+000661a0: 6e20 6973 2069 6d70 6c65 6d65 6e74 6564  n is implemented
+000661b0: 2e22 290a 0a20 2020 2020 2020 2023 2052  .")..        # R
+000661c0: 6570 6c61 6365 2074 6865 2073 7065 6369  eplace the speci
+000661d0: 6669 6564 2076 6f6c 756d 6520 7769 7468  fied volume with
+000661e0: 2074 6865 2069 6e74 6572 706f 6c61 7465   the interpolate
+000661f0: 6420 766f 6c75 6d65 0a20 2020 2020 2020  d volume.       
+00066200: 2074 696d 655f 7365 7269 6573 5f6e 705b   time_series_np[
+00066210: 2e2e 2e2c 2076 6f6c 5f69 6478 5d20 3d20  ..., vol_idx] = 
+00066220: 696e 7465 7270 6f6c 6174 6564 5f76 6f6c  interpolated_vol
+00066230: 756d 650a 0a20 2020 2023 2043 6f6e 7665  ume..    # Conve
+00066240: 7274 2074 6865 206e 756d 7079 2061 7272  rt the numpy arr
+00066250: 6179 2062 6163 6b20 746f 2041 4e54 7349  ay back to ANTsI
+00066260: 6d61 6765 0a20 2020 2069 6d70 7574 6564  mage.    imputed
+00066270: 5f74 696d 655f 7365 7269 6573 203d 2061  _time_series = a
+00066280: 6e74 732e 6672 6f6d 5f6e 756d 7079 2874  nts.from_numpy(t
+00066290: 696d 655f 7365 7269 6573 5f6e 7029 0a20  ime_series_np). 
+000662a0: 2020 2069 6d70 7574 6564 5f74 696d 655f     imputed_time_
+000662b0: 7365 7269 6573 203d 2061 6e74 732e 636f  series = ants.co
+000662c0: 7079 5f69 6d61 6765 5f69 6e66 6f28 7469  py_image_info(ti
+000662d0: 6d65 5f73 6572 6965 732c 2069 6d70 7574  me_series, imput
+000662e0: 6564 5f74 696d 655f 7365 7269 6573 290a  ed_time_series).
+000662f0: 0a20 2020 2072 6574 7572 6e20 696d 7075  .    return impu
+00066300: 7465 645f 7469 6d65 5f73 6572 6965 730a  ted_time_series.
+00066310: 0a64 6566 2069 6d70 7574 655f 6477 6928  .def impute_dwi(
+00066320: 2064 7769 2c20 7468 7265 7368 6f6c 6420   dwi, threshold 
+00066330: 3d20 302e 3230 2c20 696d 7075 7465 6230  = 0.20, imputeb0
+00066340: 3d46 616c 7365 2c20 6d61 736b 3d4e 6f6e  =False, mask=Non
+00066350: 652c 2076 6572 626f 7365 3d46 616c 7365  e, verbose=False
+00066360: 2029 3a0a 2020 2020 2222 220a 2020 2020   ):.    """.    
+00066370: 4964 656e 7469 6679 2062 6164 2076 6f6c  Identify bad vol
+00066380: 756d 6573 2069 6e20 6120 6477 6920 616e  umes in a dwi an
+00066390: 6420 696d 7075 7465 2074 6865 6d20 6675  d impute them fu
+000663a0: 6c6c 7920 6175 746f 6d61 7469 6361 6c6c  lly automaticall
+000663b0: 792e 0a0a 2020 2020 3a70 6172 616d 2064  y...    :param d
+000663c0: 7769 3a20 414e 5473 496d 6167 6520 7265  wi: ANTsImage re
+000663d0: 7072 6573 656e 7469 6e67 2074 6865 2074  presenting the t
+000663e0: 696d 6520 7365 7269 6573 2028 3444 2069  ime series (4D i
+000663f0: 6d61 6765 292e 0a20 2020 203a 7061 7261  mage)..    :para
+00066400: 6d20 7468 7265 7368 6f6c 643a 2074 6872  m threshold: thr
+00066410: 6573 686f 6c64 2028 302c 3129 2066 6f72  eshold (0,1) for
+00066420: 206f 7574 6c69 6572 6e65 7373 2028 6c6f   outlierness (lo
+00066430: 7765 7220 6d65 616e 7320 696d 7075 7465  wer means impute
+00066440: 206d 6f72 6520 6461 7461 290a 2020 2020   more data).    
+00066450: 3a70 6172 616d 2069 6d70 7574 6562 303a  :param imputeb0:
+00066460: 2062 6f6f 6c65 616e 2077 696c 6c20 696d   boolean will im
+00066470: 7075 7465 2074 6865 2062 3020 7769 7468  pute the b0 with
+00066480: 2064 7769 2069 6620 5472 7565 0a20 2020   dwi if True.   
+00066490: 203a 7061 7261 6d20 6d61 736b 3a20 7265   :param mask: re
+000664a0: 7374 7269 6374 7320 746f 2061 2072 6567  stricts to a reg
+000664b0: 696f 6e20 6f66 2069 6e74 6572 6573 740a  ion of interest.
+000664c0: 2020 2020 3a70 6172 616d 2076 6572 626f      :param verbo
+000664d0: 7365 3a20 626f 6f6c 6561 6e0a 2020 2020  se: boolean.    
+000664e0: 3a72 6574 7572 6e3a 2041 4e54 7349 6d61  :return: ANTsIma
+000664f0: 6765 2061 7574 6f6d 6174 6963 616c 6c79  ge automatically
+00066500: 2069 6d70 7574 6564 2e0a 2020 2020 2222   imputed..    ""
+00066510: 220a 2020 2020 6c69 7374 3120 3d20 7365  ".    list1 = se
+00066520: 676d 656e 745f 7469 6d65 7365 7269 6573  gment_timeseries
+00066530: 5f62 795f 6d65 616e 7661 6c75 6528 2064  _by_meanvalue( d
+00066540: 7769 2029 5b27 6869 6768 6572 6d65 616e  wi )['highermean
+00066550: 7327 5d0a 2020 2020 6966 2069 6d70 7574  s'].    if imput
+00066560: 6562 303a 0a20 2020 2020 2020 2064 7769  eb0:.        dwi
+00066570: 6220 3d20 696d 7075 7465 5f74 696d 6573  b = impute_times
+00066580: 6572 6965 7328 2064 7769 2c20 6c69 7374  eries( dwi, list
+00066590: 3120 2920 2320 666f 6375 7320 6f6e 2074  1 ) # focus on t
+000665a0: 6865 2064 7769 202d 206e 6f74 2074 6865  he dwi - not the
+000665b0: 2062 300a 2020 2020 2020 2020 6c6f 6f70   b0.        loop
+000665c0: 6564 2c20 6c69 7374 3220 3d20 6c6f 6f70  ed, list2 = loop
+000665d0: 5f74 696d 6573 6572 6965 735f 6365 6e73  _timeseries_cens
+000665e0: 6f72 696e 6728 2064 7769 622c 2074 6872  oring( dwib, thr
+000665f0: 6573 686f 6c64 2c20 6d61 736b 2029 0a20  eshold, mask ). 
+00066600: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00066610: 206c 6f6f 7065 642c 206c 6973 7432 203d   looped, list2 =
+00066620: 206c 6f6f 705f 7469 6d65 7365 7269 6573   loop_timeseries
+00066630: 5f63 656e 736f 7269 6e67 2820 6477 692c  _censoring( dwi,
+00066640: 2074 6872 6573 686f 6c64 2c20 6d61 736b   threshold, mask
+00066650: 2029 0a20 2020 2069 6620 7665 7262 6f73   ).    if verbos
+00066660: 653a 0a20 2020 2020 2020 2070 7269 6e74  e:.        print
+00066670: 2820 6c69 7374 3120 290a 2020 2020 2020  ( list1 ).      
+00066680: 2020 7072 696e 7428 206c 6973 7432 2029    print( list2 )
+00066690: 0a20 2020 2063 6f6d 706c 656d 656e 7420  .    complement 
+000666a0: 3d20 7265 6d6f 7665 5f65 6c65 6d65 6e74  = remove_element
+000666b0: 735f 6672 6f6d 5f6c 6973 7428 206c 6973  s_from_list( lis
+000666c0: 7432 2c20 6c69 7374 3120 290a 2020 2020  t2, list1 ).    
+000666d0: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+000666e0: 2020 2020 7072 696e 7428 2022 496d 7075      print( "Impu
+000666f0: 7469 6e67 3a22 290a 2020 2020 2020 2020  ting:").        
+00066700: 7072 696e 7428 2063 6f6d 706c 656d 656e  print( complemen
+00066710: 7420 290a 2020 2020 6966 206c 656e 2820  t ).    if len( 
+00066720: 636f 6d70 6c65 6d65 6e74 2029 203d 3d20  complement ) == 
+00066730: 303a 0a20 2020 2020 2020 2072 6574 7572  0:.        retur
+00066740: 6e20 6477 690a 2020 2020 7265 7475 726e  n dwi.    return
+00066750: 2069 6d70 7574 655f 7469 6d65 7365 7269   impute_timeseri
+00066760: 6573 2820 6477 692c 2063 6f6d 706c 656d  es( dwi, complem
+00066770: 656e 7420 290a 0a64 6566 2063 656e 736f  ent )..def censo
+00066780: 725f 6477 6928 2064 7769 2c20 6276 616c  r_dwi( dwi, bval
+00066790: 2c20 6276 6563 2c20 7468 7265 7368 6f6c  , bvec, threshol
+000667a0: 6420 3d20 302e 3230 2c20 696d 7075 7465  d = 0.20, impute
+000667b0: 6230 3d46 616c 7365 2c20 6d61 736b 3d4e  b0=False, mask=N
+000667c0: 6f6e 652c 2076 6572 626f 7365 3d46 616c  one, verbose=Fal
+000667d0: 7365 2029 3a0a 2020 2020 2222 220a 2020  se ):.    """.  
+000667e0: 2020 4964 656e 7469 6679 2062 6164 2076    Identify bad v
+000667f0: 6f6c 756d 6573 2069 6e20 6120 6477 6920  olumes in a dwi 
+00066800: 616e 6420 696d 7075 7465 2074 6865 6d20  and impute them 
+00066810: 6675 6c6c 7920 6175 746f 6d61 7469 6361  fully automatica
+00066820: 6c6c 792e 0a0a 2020 2020 3a70 6172 616d  lly...    :param
+00066830: 2064 7769 3a20 414e 5473 496d 6167 6520   dwi: ANTsImage 
+00066840: 7265 7072 6573 656e 7469 6e67 2074 6865  representing the
+00066850: 2074 696d 6520 7365 7269 6573 2028 3444   time series (4D
+00066860: 2069 6d61 6765 292e 0a20 2020 203a 7061   image)..    :pa
+00066870: 7261 6d20 6276 616c 3a20 6276 616c 2061  ram bval: bval a
+00066880: 7272 6179 0a20 2020 203a 7061 7261 6d20  rray.    :param 
+00066890: 6276 6563 3a20 6276 6563 2061 7272 6179  bvec: bvec array
+000668a0: 0a20 2020 203a 7061 7261 6d20 7468 7265  .    :param thre
+000668b0: 7368 6f6c 643a 2074 6872 6573 686f 6c64  shold: threshold
+000668c0: 2028 302c 3129 2066 6f72 206f 7574 6c69   (0,1) for outli
+000668d0: 6572 6e65 7373 2028 6c6f 7765 7220 6d65  erness (lower me
+000668e0: 616e 7320 696d 7075 7465 206d 6f72 6520  ans impute more 
+000668f0: 6461 7461 290a 2020 2020 3a70 6172 616d  data).    :param
+00066900: 2069 6d70 7574 6562 303a 2062 6f6f 6c65   imputeb0: boole
+00066910: 616e 2077 696c 6c20 696d 7075 7465 2074  an will impute t
+00066920: 6865 2062 3020 7769 7468 2064 7769 2069  he b0 with dwi i
+00066930: 6620 5472 7565 0a20 2020 203a 7061 7261  f True.    :para
+00066940: 6d20 6d61 736b 3a20 7265 7374 7269 6374  m mask: restrict
+00066950: 7320 746f 2061 2072 6567 696f 6e20 6f66  s to a region of
+00066960: 2069 6e74 6572 6573 740a 2020 2020 3a70   interest.    :p
+00066970: 6172 616d 2076 6572 626f 7365 3a20 626f  aram verbose: bo
+00066980: 6f6c 6561 6e0a 2020 2020 3a72 6574 7572  olean.    :retur
+00066990: 6e3a 2041 4e54 7349 6d61 6765 2061 7574  n: ANTsImage aut
+000669a0: 6f6d 6174 6963 616c 6c79 2069 6d70 7574  omatically imput
+000669b0: 6564 2e0a 2020 2020 2222 220a 2020 2020  ed..    """.    
+000669c0: 6c69 7374 3120 3d20 7365 676d 656e 745f  list1 = segment_
+000669d0: 7469 6d65 7365 7269 6573 5f62 795f 6d65  timeseries_by_me
+000669e0: 616e 7661 6c75 6528 2064 7769 2029 5b27  anvalue( dwi )['
+000669f0: 6869 6768 6572 6d65 616e 7327 5d0a 2020  highermeans'].  
+00066a00: 2020 6966 2069 6d70 7574 6562 303a 0a20    if imputeb0:. 
+00066a10: 2020 2020 2020 2064 7769 6220 3d20 696d         dwib = im
+00066a20: 7075 7465 5f74 696d 6573 6572 6965 7328  pute_timeseries(
+00066a30: 2064 7769 2c20 6c69 7374 3120 2920 2320   dwi, list1 ) # 
+00066a40: 666f 6375 7320 6f6e 2074 6865 2064 7769  focus on the dwi
+00066a50: 202d 206e 6f74 2074 6865 2062 300a 2020   - not the b0.  
+00066a60: 2020 2020 2020 6c6f 6f70 6564 2c20 6c69        looped, li
+00066a70: 7374 3220 3d20 6c6f 6f70 5f74 696d 6573  st2 = loop_times
+00066a80: 6572 6965 735f 6365 6e73 6f72 696e 6728  eries_censoring(
+00066a90: 2064 7769 622c 2074 6872 6573 686f 6c64   dwib, threshold
+00066aa0: 2c20 6d61 736b 2029 0a20 2020 2065 6c73  , mask ).    els
+00066ab0: 653a 0a20 2020 2020 2020 206c 6f6f 7065  e:.        loope
+00066ac0: 642c 206c 6973 7432 203d 206c 6f6f 705f  d, list2 = loop_
+00066ad0: 7469 6d65 7365 7269 6573 5f63 656e 736f  timeseries_censo
+00066ae0: 7269 6e67 2820 6477 692c 2074 6872 6573  ring( dwi, thres
+00066af0: 686f 6c64 2c20 6d61 736b 2029 0a20 2020  hold, mask ).   
+00066b00: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+00066b10: 2020 2020 2070 7269 6e74 2820 6c69 7374       print( list
+00066b20: 3120 290a 2020 2020 2020 2020 7072 696e  1 ).        prin
+00066b30: 7428 206c 6973 7432 2029 0a20 2020 2063  t( list2 ).    c
+00066b40: 6f6d 706c 656d 656e 7420 3d20 7265 6d6f  omplement = remo
+00066b50: 7665 5f65 6c65 6d65 6e74 735f 6672 6f6d  ve_elements_from
+00066b60: 5f6c 6973 7428 206c 6973 7432 2c20 6c69  _list( list2, li
+00066b70: 7374 3120 290a 2020 2020 6966 2076 6572  st1 ).    if ver
+00066b80: 626f 7365 3a0a 2020 2020 2020 2020 7072  bose:.        pr
+00066b90: 696e 7428 2022 6365 6e73 6f72 696e 673a  int( "censoring:
+00066ba0: 2229 0a20 2020 2020 2020 2070 7269 6e74  ").        print
+00066bb0: 2820 636f 6d70 6c65 6d65 6e74 2029 0a20  ( complement ). 
+00066bc0: 2020 2069 6620 6c65 6e28 2063 6f6d 706c     if len( compl
+00066bd0: 656d 656e 7420 2920 3d3d 2030 3a0a 2020  ement ) == 0:.  
+00066be0: 2020 2020 2020 7265 7475 726e 2064 7769        return dwi
+00066bf0: 2c20 6276 616c 2c20 6276 6563 0a20 2020  , bval, bvec.   
+00066c00: 2072 6574 7572 6e20 7265 6d6f 7665 5f76   return remove_v
+00066c10: 6f6c 756d 6573 5f66 726f 6d5f 7469 6d65  olumes_from_time
+00066c20: 7365 7269 6573 2820 6477 692c 2063 6f6d  series( dwi, com
+00066c30: 706c 656d 656e 7420 292c 2072 656d 6f76  plement ), remov
+00066c40: 655f 656c 656d 656e 7473 5f66 726f 6d5f  e_elements_from_
+00066c50: 6e75 6d70 795f 6172 7261 7928 2062 7661  numpy_array( bva
+00066c60: 6c2c 2063 6f6d 706c 656d 656e 7420 292c  l, complement ),
+00066c70: 2072 656d 6f76 655f 656c 656d 656e 7473   remove_elements
+00066c80: 5f66 726f 6d5f 6e75 6d70 795f 6172 7261  _from_numpy_arra
+00066c90: 7928 2062 7665 632c 2063 6f6d 706c 656d  y( bvec, complem
+00066ca0: 656e 7420 290a 0a0a 6465 6620 666c 6174  ent )...def flat
+00066cb0: 7465 6e5f 7469 6d65 5f73 6572 6965 7328  ten_time_series(
+00066cc0: 7469 6d65 5f73 6572 6965 7329 3a0a 2020  time_series):.  
+00066cd0: 2020 2222 220a 2020 2020 466c 6174 7465    """.    Flatte
+00066ce0: 6e20 6120 3444 2074 696d 6520 7365 7269  n a 4D time seri
+00066cf0: 6573 2069 6e74 6f20 6120 3244 2061 7272  es into a 2D arr
+00066d00: 6179 2e0a 2020 2020 0a20 2020 203a 7061  ay..    .    :pa
+00066d10: 7261 6d20 7469 6d65 5f73 6572 6965 733a  ram time_series:
+00066d20: 2041 2034 4420 6e75 6d70 7920 6172 7261   A 4D numpy arra
+00066d30: 7920 7768 6572 6520 7468 6520 6c61 7374  y where the last
+00066d40: 2064 696d 656e 7369 6f6e 2069 7320 7469   dimension is ti
+00066d50: 6d65 2e0a 2020 2020 3a72 6574 7572 6e3a  me..    :return:
+00066d60: 2041 2032 4420 6e75 6d70 7920 6172 7261   A 2D numpy arra
+00066d70: 7920 7768 6572 6520 6561 6368 2072 6f77  y where each row
+00066d80: 2069 7320 6120 666c 6174 7465 6e65 6420   is a flattened 
+00066d90: 766f 6c75 6d65 2e0a 2020 2020 2222 220a  volume..    """.
+00066da0: 2020 2020 6e5f 766f 6c75 6d65 7320 3d20      n_volumes = 
+00066db0: 7469 6d65 5f73 6572 6965 732e 7368 6170  time_series.shap
+00066dc0: 655b 335d 0a20 2020 2072 6574 7572 6e20  e[3].    return 
+00066dd0: 7469 6d65 5f73 6572 6965 732e 7265 7368  time_series.resh
+00066de0: 6170 6528 2d31 2c20 6e5f 766f 6c75 6d65  ape(-1, n_volume
+00066df0: 7329 2e54 0a0a 6465 6620 6361 6c63 756c  s).T..def calcul
+00066e00: 6174 655f 6c6f 6f70 5f73 636f 7265 7328  ate_loop_scores(
+00066e10: 666c 6174 7465 6e65 645f 7365 7269 6573  flattened_series
+00066e20: 2c20 6e5f 6e65 6967 6862 6f72 733d 3230  , n_neighbors=20
+00066e30: 293a 0a20 2020 2022 2222 0a20 2020 2043  ):.    """.    C
+00066e40: 616c 6375 6c61 7465 204c 6f63 616c 204f  alculate Local O
+00066e50: 7574 6c69 6572 2050 726f 6261 6269 6c69  utlier Probabili
+00066e60: 7469 6573 2066 6f72 2065 6163 6820 766f  ties for each vo
+00066e70: 6c75 6d65 2e0a 2020 2020 0a20 2020 203a  lume..    .    :
+00066e80: 7061 7261 6d20 666c 6174 7465 6e65 645f  param flattened_
+00066e90: 7365 7269 6573 3a20 4120 3244 206e 756d  series: A 2D num
+00066ea0: 7079 2061 7272 6179 2066 726f 6d20 666c  py array from fl
+00066eb0: 6174 7465 6e5f 7469 6d65 5f73 6572 6965  atten_time_serie
+00066ec0: 732e 0a20 2020 203a 7061 7261 6d20 6e5f  s..    :param n_
+00066ed0: 6e65 6967 6862 6f72 733a 204e 756d 6265  neighbors: Numbe
+00066ee0: 7220 6f66 206e 6569 6768 626f 7273 2074  r of neighbors t
+00066ef0: 6f20 7573 6520 666f 7220 6361 6c63 756c  o use for calcul
+00066f00: 6174 696e 6720 4c4f 4620 7363 6f72 6573  ating LOF scores
+00066f10: 2e0a 2020 2020 3a72 6574 7572 6e3a 2041  ..    :return: A
+00066f20: 6e20 6172 7261 7920 6f66 204c 6f4f 5020  n array of LoOP 
+00066f30: 7363 6f72 6573 2e0a 2020 2020 2222 220a  scores..    """.
+00066f40: 2020 2020 6672 6f6d 2050 794e 6f6d 616c      from PyNomal
+00066f50: 7920 696d 706f 7274 206c 6f6f 700a 2020  y import loop.  
+00066f60: 2020 6672 6f6d 2073 6b6c 6561 726e 2e6e    from sklearn.n
+00066f70: 6569 6768 626f 7273 2069 6d70 6f72 7420  eighbors import 
+00066f80: 4e65 6172 6573 744e 6569 6768 626f 7273  NearestNeighbors
+00066f90: 0a20 2020 2066 726f 6d20 736b 6c65 6172  .    from sklear
+00066fa0: 6e2e 7072 6570 726f 6365 7373 696e 6720  n.preprocessing 
+00066fb0: 696d 706f 7274 2053 7461 6e64 6172 6453  import StandardS
+00066fc0: 6361 6c65 720a 2020 2020 2320 7265 706c  caler.    # repl
+00066fd0: 6163 6520 6e61 6e73 2077 6974 6820 7a65  ace nans with ze
+00066fe0: 726f 0a20 2020 2066 6c61 7474 656e 6564  ro.    flattened
+00066ff0: 5f73 6572 6965 733d 6e70 2e6e 616e 5f74  _series=np.nan_t
+00067000: 6f5f 6e75 6d28 666c 6174 7465 6e65 645f  o_num(flattened_
+00067010: 7365 7269 6573 2c20 6e61 6e3d 3029 0a20  series, nan=0). 
+00067020: 2020 2073 6361 6c65 7220 3d20 5374 616e     scaler = Stan
+00067030: 6461 7264 5363 616c 6572 2829 0a20 2020  dardScaler().   
+00067040: 2073 6361 6c65 722e 6669 7428 666c 6174   scaler.fit(flat
+00067050: 7465 6e65 645f 7365 7269 6573 290a 2020  tened_series).  
+00067060: 2020 6461 7461 203d 2073 6361 6c65 722e    data = scaler.
+00067070: 7472 616e 7366 6f72 6d28 666c 6174 7465  transform(flatte
+00067080: 6e65 645f 7365 7269 6573 290a 2020 2020  ned_series).    
+00067090: 6461 7461 3d6e 702e 6e61 6e5f 746f 5f6e  data=np.nan_to_n
+000670a0: 756d 2864 6174 612c 206e 616e 3d30 290a  um(data, nan=0).
+000670b0: 2020 2020 6966 206e 5f6e 6569 6768 626f      if n_neighbo
+000670c0: 7273 203e 2069 6e74 2866 6c61 7474 656e  rs > int(flatten
+000670d0: 6564 5f73 6572 6965 732e 7368 6170 655b  ed_series.shape[
+000670e0: 305d 2f32 2e30 293a 0a20 2020 2020 2020  0]/2.0):.       
+000670f0: 206e 5f6e 6569 6768 626f 7273 203d 2069   n_neighbors = i
+00067100: 6e74 2866 6c61 7474 656e 6564 5f73 6572  nt(flattened_ser
+00067110: 6965 732e 7368 6170 655b 305d 2f32 2e30  ies.shape[0]/2.0
+00067120: 290a 2020 2020 6e65 6967 6820 3d20 4e65  ).    neigh = Ne
+00067130: 6172 6573 744e 6569 6768 626f 7273 286e  arestNeighbors(n
+00067140: 5f6e 6569 6768 626f 7273 3d6e 5f6e 6569  _neighbors=n_nei
+00067150: 6768 626f 7273 2c20 6d65 7472 6963 3d27  ghbors, metric='
+00067160: 6d69 6e6b 6f77 736b 6927 290a 2020 2020  minkowski').    
+00067170: 6e65 6967 682e 6669 7428 6461 7461 290a  neigh.fit(data).
+00067180: 2020 2020 642c 2069 6478 203d 206e 6569      d, idx = nei
+00067190: 6768 2e6b 6e65 6967 6862 6f72 7328 6461  gh.kneighbors(da
+000671a0: 7461 2c20 7265 7475 726e 5f64 6973 7461  ta, return_dista
+000671b0: 6e63 653d 5472 7565 290a 2020 2020 6d20  nce=True).    m 
+000671c0: 3d20 6c6f 6f70 2e4c 6f63 616c 4f75 746c  = loop.LocalOutl
+000671d0: 6965 7250 726f 6261 6269 6c69 7479 2864  ierProbability(d
+000671e0: 6973 7461 6e63 655f 6d61 7472 6978 3d64  istance_matrix=d
+000671f0: 2c20 6e65 6967 6862 6f72 5f6d 6174 7269  , neighbor_matri
+00067200: 783d 6964 782c 206e 5f6e 6569 6768 626f  x=idx, n_neighbo
+00067210: 7273 3d6e 5f6e 6569 6768 626f 7273 292e  rs=n_neighbors).
+00067220: 6669 7428 290a 2020 2020 7265 7475 726e  fit().    return
+00067230: 206d 2e6c 6f63 616c 5f6f 7574 6c69 6572   m.local_outlier
+00067240: 5f70 726f 6261 6269 6c69 7469 6573 5b3a  _probabilities[:
+00067250: 5d0a 0a64 6566 2073 636f 7265 5f66 6d72  ]..def score_fmr
+00067260: 695f 6365 6e73 6f72 696e 6728 6362 6674  i_censoring(cbft
+00067270: 732c 2063 7366 5f73 6567 2c20 676d 5f73  s, csf_seg, gm_s
+00067280: 6567 2c20 776d 5f73 6567 2029 3a0a 2020  eg, wm_seg ):.  
+00067290: 2020 2222 220a 2020 2020 5072 6f63 6573    """.    Proces
+000672a0: 7320 4342 4620 7469 6d65 2073 6572 6965  s CBF time serie
+000672b0: 7320 746f 2072 656d 6f76 6520 6869 6768  s to remove high
+000672c0: 2d6c 6576 6572 6167 6520 706f 696e 7473  -leverage points
+000672d0: 2e0a 2020 2020 4465 7269 7665 6420 6672  ..    Derived fr
+000672e0: 6f6d 2074 6865 2053 434f 5245 2061 6c67  om the SCORE alg
+000672f0: 6f72 6974 686d 2062 7920 5375 6469 7074  orithm by Sudipt
+00067300: 6f20 446f 6c75 6920 6574 2e20 616c 2e0a  o Dolui et. al..
+00067310: 0a20 2020 2050 6172 616d 6574 6572 733a  .    Parameters:
+00067320: 0a20 2020 2063 6266 7473 2028 414e 5473  .    cbfts (ANTs
+00067330: 496d 6167 6529 3a20 3444 2041 4e54 7349  Image): 4D ANTsI
+00067340: 6d61 6765 206f 6620 4342 4620 7469 6d65  mage of CBF time
+00067350: 2073 6572 6965 732e 0a20 2020 2063 7366   series..    csf
+00067360: 5f73 6567 2028 414e 5473 496d 6167 6529  _seg (ANTsImage)
+00067370: 3a20 4353 4620 6269 6e61 7279 206d 6170  : CSF binary map
+00067380: 2e0a 2020 2020 676d 5f73 6567 2028 414e  ..    gm_seg (AN
+00067390: 5473 496d 6167 6529 3a20 4772 6179 206d  TsImage): Gray m
+000673a0: 6174 7465 7220 6269 6e61 7279 206d 6170  atter binary map
+000673b0: 2e0a 2020 2020 776d 5f73 6567 2028 414e  ..    wm_seg (AN
+000673c0: 5473 496d 6167 6529 3a20 574d 2062 696e  TsImage): WM bin
+000673d0: 6172 7920 6d61 702e 0a0a 2020 2020 5265  ary map...    Re
+000673e0: 7475 726e 733a 0a20 2020 2041 4e54 7349  turns:.    ANTsI
+000673f0: 6d61 6765 3a20 5072 6f63 6573 7365 6420  mage: Processed 
+00067400: 4342 4620 7469 6d65 2073 6572 6965 732e  CBF time series.
+00067410: 0a20 2020 206e 6461 7272 6179 3a20 496e  .    ndarray: In
+00067420: 6465 7820 6f66 2072 656d 6f76 6564 2076  dex of removed v
+00067430: 6f6c 756d 6573 2e0a 2020 2020 2222 220a  olumes..    """.
+00067440: 2020 2020 0a20 2020 206e 5f67 6d5f 766f      .    n_gm_vo
+00067450: 7865 6c73 203d 206e 702e 7375 6d28 676d  xels = np.sum(gm
+00067460: 5f73 6567 2e6e 756d 7079 2829 2920 2d20  _seg.numpy()) - 
+00067470: 310a 2020 2020 6e5f 776d 5f76 6f78 656c  1.    n_wm_voxel
+00067480: 7320 3d20 6e70 2e73 756d 2877 6d5f 7365  s = np.sum(wm_se
+00067490: 672e 6e75 6d70 7928 2929 202d 2031 0a20  g.numpy()) - 1. 
+000674a0: 2020 206e 5f63 7366 5f76 6f78 656c 7320     n_csf_voxels 
+000674b0: 3d20 6e70 2e73 756d 2863 7366 5f73 6567  = np.sum(csf_seg
+000674c0: 2e6e 756d 7079 2829 2920 2d20 310a 2020  .numpy()) - 1.  
+000674d0: 2020 6d61 736b 3169 6d67 203d 2067 6d5f    mask1img = gm_
+000674e0: 7365 6720 2b20 776d 5f73 6567 202b 2063  seg + wm_seg + c
+000674f0: 7366 5f73 6567 0a20 2020 206d 6173 6b31  sf_seg.    mask1
+00067500: 203d 2028 6d61 736b 3169 6d67 3d3d 3129   = (mask1img==1)
+00067510: 2e6e 756d 7079 2829 0a20 2020 200a 2020  .numpy().    .  
+00067520: 2020 6362 6674 735f 6e70 203d 2063 6266    cbfts_np = cbf
+00067530: 7473 2e6e 756d 7079 2829 0a20 2020 2067  ts.numpy().    g
+00067540: 6d62 6f6f 6c20 3d20 2867 6d5f 7365 673d  mbool = (gm_seg=
+00067550: 3d31 292e 6e75 6d70 7928 290a 2020 2020  =1).numpy().    
+00067560: 6373 6662 6f6f 6c20 3d20 2863 7366 5f73  csfbool = (csf_s
+00067570: 6567 3d3d 3129 2e6e 756d 7079 2829 0a20  eg==1).numpy(). 
+00067580: 2020 2077 6d62 6f6f 6c20 3d20 2877 6d5f     wmbool = (wm_
+00067590: 7365 673d 3d31 292e 6e75 6d70 7928 290a  seg==1).numpy().
+000675a0: 2020 2020 676d 5f63 6266 5f74 7320 3d20      gm_cbf_ts = 
+000675b0: 616e 7473 2e74 696d 6573 6572 6965 735f  ants.timeseries_
+000675c0: 746f 5f6d 6174 7269 7828 2063 6266 7473  to_matrix( cbfts
+000675d0: 2c20 676d 5f73 6567 2029 0a20 2020 2067  , gm_seg ).    g
+000675e0: 6d5f 6362 665f 7473 203d 206e 702e 7371  m_cbf_ts = np.sq
+000675f0: 7565 657a 6528 6e70 2e6d 6561 6e28 676d  ueeze(np.mean(gm
+00067600: 5f63 6266 5f74 732c 2061 7869 733d 3129  _cbf_ts, axis=1)
+00067610: 290a 2020 2020 0a20 2020 206d 6564 6961  ).    .    media
+00067620: 6e5f 676d 5f63 6266 203d 206e 702e 6d65  n_gm_cbf = np.me
+00067630: 6469 616e 2867 6d5f 6362 665f 7473 290a  dian(gm_cbf_ts).
+00067640: 2020 2020 6d61 645f 676d 5f63 6266 203d      mad_gm_cbf =
+00067650: 206e 702e 6d65 6469 616e 286e 702e 6162   np.median(np.ab
+00067660: 7328 676d 5f63 6266 5f74 7320 2d20 6d65  s(gm_cbf_ts - me
+00067670: 6469 616e 5f67 6d5f 6362 6629 2920 2f20  dian_gm_cbf)) / 
+00067680: 302e 3637 350a 2020 2020 696e 6478 203d  0.675.    indx =
+00067690: 206e 702e 6162 7328 676d 5f63 6266 5f74   np.abs(gm_cbf_t
+000676a0: 7320 2d20 6d65 6469 616e 5f67 6d5f 6362  s - median_gm_cb
+000676b0: 6629 203e 2028 322e 3520 2a20 6d61 645f  f) > (2.5 * mad_
+000676c0: 676d 5f63 6266 290a 2020 2020 0a20 2020  gm_cbf).    .   
+000676d0: 2023 2074 6865 2073 7061 7469 616c 206d   # the spatial m
+000676e0: 6561 6e0a 2020 2020 7370 6174 6d65 616e  ean.    spatmean
+000676f0: 6e70 203d 206e 702e 6d65 616e 2863 6266  np = np.mean(cbf
+00067700: 7473 5f6e 705b 3a2c 203a 2c20 3a2c 207e  ts_np[:, :, :, ~
+00067710: 696e 6478 5d2c 2061 7869 733d 3329 0a20  indx], axis=3). 
+00067720: 2020 2073 7061 746d 6561 6e20 3d20 616e     spatmean = an
+00067730: 7473 2e66 726f 6d5f 6e75 6d70 7928 2073  ts.from_numpy( s
+00067740: 7061 746d 6561 6e6e 7020 290a 2020 2020  patmeannp ).    
+00067750: 5620 3d20 280a 2020 2020 2020 2020 6e5f  V = (.        n_
+00067760: 676d 5f76 6f78 656c 7320 2a20 6e70 2e76  gm_voxels * np.v
+00067770: 6172 2873 7061 746d 6561 6e6e 705b 676d  ar(spatmeannp[gm
+00067780: 626f 6f6c 5d29 0a20 2020 2020 2020 202b  bool]).        +
+00067790: 206e 5f77 6d5f 766f 7865 6c73 202a 206e   n_wm_voxels * n
+000677a0: 702e 7661 7228 7370 6174 6d65 616e 6e70  p.var(spatmeannp
+000677b0: 5b77 6d62 6f6f 6c5d 290a 2020 2020 2020  [wmbool]).      
+000677c0: 2020 2b20 6e5f 6373 665f 766f 7865 6c73    + n_csf_voxels
+000677d0: 202a 206e 702e 7661 7228 7370 6174 6d65   * np.var(spatme
+000677e0: 616e 6e70 5b63 7366 626f 6f6c 5d29 0a20  annp[csfbool]). 
+000677f0: 2020 2029 0a20 2020 2056 3120 3d20 6d61     ).    V1 = ma
+00067800: 7468 2e69 6e66 0a20 2020 2063 743d 300a  th.inf.    ct=0.
+00067810: 2020 2020 7768 696c 6520 5620 3c20 5631      while V < V1
+00067820: 3a0a 2020 2020 2020 2020 6374 3d63 742b  :.        ct=ct+
+00067830: 310a 2020 2020 2020 2020 5631 203d 2056  1.        V1 = V
+00067840: 0a20 2020 2020 2020 2043 4320 3d20 6e70  .        CC = np
+00067850: 2e7a 6572 6f73 2863 6266 7473 5f6e 702e  .zeros(cbfts_np.
+00067860: 7368 6170 655b 335d 290a 2020 2020 2020  shape[3]).      
+00067870: 2020 666f 7220 7320 696e 2072 616e 6765    for s in range
+00067880: 2863 6266 7473 5f6e 702e 7368 6170 655b  (cbfts_np.shape[
+00067890: 335d 293a 0a20 2020 2020 2020 2020 2020  3]):.           
+000678a0: 2069 6620 696e 6478 5b73 5d3a 0a20 2020   if indx[s]:.   
+000678b0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+000678c0: 7469 6e75 650a 2020 2020 2020 2020 2020  tinue.          
+000678d0: 2020 746d 7031 203d 2061 6e74 732e 6672    tmp1 = ants.fr
+000678e0: 6f6d 5f6e 756d 7079 2820 6362 6674 735f  om_numpy( cbfts_
+000678f0: 6e70 5b3a 2c20 3a2c 203a 2c20 735d 2029  np[:, :, :, s] )
+00067900: 0a20 2020 2020 2020 2020 2020 2043 435b  .            CC[
+00067910: 735d 203d 2061 6e74 732e 696d 6167 655f  s] = ants.image_
+00067920: 7369 6d69 6c61 7269 7479 2820 7370 6174  similarity( spat
+00067930: 6d65 616e 2c20 746d 7031 2c20 6d65 7472  mean, tmp1, metr
+00067940: 6963 5f74 7970 653d 2743 6f72 7265 6c61  ic_type='Correla
+00067950: 7469 6f6e 272c 2066 6978 6564 5f6d 6173  tion', fixed_mas
+00067960: 6b3d 6d61 736b 3169 6d67 2029 0a20 2020  k=mask1img ).   
+00067970: 2020 2020 2069 6e78 203d 206e 702e 6172       inx = np.ar
+00067980: 676d 696e 2843 4329 0a20 2020 2020 2020  gmin(CC).       
+00067990: 2069 6e64 785b 696e 785d 203d 2054 7275   indx[inx] = Tru
+000679a0: 650a 2020 2020 2020 2020 7370 6174 6d65  e.        spatme
+000679b0: 616e 6e70 203d 206e 702e 6d65 616e 2863  annp = np.mean(c
+000679c0: 6266 7473 5f6e 705b 3a2c 203a 2c20 3a2c  bfts_np[:, :, :,
+000679d0: 207e 696e 6478 5d2c 2061 7869 733d 3329   ~indx], axis=3)
+000679e0: 0a20 2020 2020 2020 2073 7061 746d 6561  .        spatmea
+000679f0: 6e20 3d20 616e 7473 2e66 726f 6d5f 6e75  n = ants.from_nu
+00067a00: 6d70 7928 2073 7061 746d 6561 6e6e 7020  mpy( spatmeannp 
+00067a10: 290a 2020 2020 2020 2020 5620 3d20 280a  ).        V = (.
+00067a20: 2020 2020 2020 2020 2020 6e5f 676d 5f76            n_gm_v
+00067a30: 6f78 656c 7320 2a20 6e70 2e76 6172 2873  oxels * np.var(s
+00067a40: 7061 746d 6561 6e6e 705b 676d 626f 6f6c  patmeannp[gmbool
+00067a50: 5d29 202b 200a 2020 2020 2020 2020 2020  ]) + .          
+00067a60: 6e5f 776d 5f76 6f78 656c 7320 2a20 6e70  n_wm_voxels * np
+00067a70: 2e76 6172 2873 7061 746d 6561 6e6e 705b  .var(spatmeannp[
+00067a80: 776d 626f 6f6c 5d29 202b 200a 2020 2020  wmbool]) + .    
+00067a90: 2020 2020 2020 6e5f 6373 665f 766f 7865        n_csf_voxe
+00067aa0: 6c73 202a 206e 702e 7661 7228 7370 6174  ls * np.var(spat
+00067ab0: 6d65 616e 6e70 5b63 7366 626f 6f6c 5d29  meannp[csfbool])
+00067ac0: 0a20 2020 2020 2020 2029 0a20 2020 2063  .        ).    c
+00067ad0: 6266 7473 5f72 6563 6f6e 203d 2063 6266  bfts_recon = cbf
+00067ae0: 7473 5f6e 705b 3a2c 203a 2c20 3a2c 207e  ts_np[:, :, :, ~
+00067af0: 696e 6478 5d0a 2020 2020 6362 6674 735f  indx].    cbfts_
+00067b00: 7265 636f 6e20 3d20 6e70 2e6e 616e 5f74  recon = np.nan_t
+00067b10: 6f5f 6e75 6d28 6362 6674 735f 7265 636f  o_num(cbfts_reco
+00067b20: 6e29 0a20 2020 2063 6266 7473 5f72 6563  n).    cbfts_rec
+00067b30: 6f6e 5f61 6e74 7320 3d20 616e 7473 2e66  on_ants = ants.f
+00067b40: 726f 6d5f 6e75 6d70 7928 6362 6674 735f  rom_numpy(cbfts_
+00067b50: 7265 636f 6e29 0a20 2020 2063 6266 7473  recon).    cbfts
+00067b60: 5f72 6563 6f6e 5f61 6e74 7320 3d20 616e  _recon_ants = an
+00067b70: 7473 2e63 6f70 795f 696d 6167 655f 696e  ts.copy_image_in
+00067b80: 666f 2863 6266 7473 2c20 6362 6674 735f  fo(cbfts, cbfts_
+00067b90: 7265 636f 6e5f 616e 7473 290a 2020 2020  recon_ants).    
+00067ba0: 7265 7475 726e 2063 6266 7473 5f72 6563  return cbfts_rec
+00067bb0: 6f6e 5f61 6e74 732c 2069 6e64 780a 0a64  on_ants, indx..d
+00067bc0: 6566 206c 6f6f 705f 7469 6d65 7365 7269  ef loop_timeseri
+00067bd0: 6573 5f63 656e 736f 7269 6e67 2878 2c20  es_censoring(x, 
+00067be0: 7468 7265 7368 6f6c 643d 302e 352c 206d  threshold=0.5, m
+00067bf0: 6173 6b3d 4e6f 6e65 2c20 7665 7262 6f73  ask=None, verbos
+00067c00: 653d 4661 6c73 6529 3a0a 2020 2020 2222  e=False):.    ""
+00067c10: 220a 2020 2020 4365 6e73 6f72 2068 6967  ".    Censor hig
+00067c20: 6820 6c65 7665 7261 6765 2076 6f6c 756d  h leverage volum
+00067c30: 6573 2066 726f 6d20 6120 7469 6d65 2073  es from a time s
+00067c40: 6572 6965 7320 7573 696e 6720 4c6f 6361  eries using Loca
+00067c50: 6c20 4f75 746c 6965 7220 5072 6f62 6162  l Outlier Probab
+00067c60: 696c 6974 6965 7320 284c 6f4f 5029 2e0a  ilities (LoOP)..
+00067c70: 0a20 2020 2050 6172 616d 6574 6572 733a  .    Parameters:
+00067c80: 0a20 2020 2078 2028 414e 5473 496d 6167  .    x (ANTsImag
+00067c90: 6529 3a20 4120 3444 2074 696d 6520 7365  e): A 4D time se
+00067ca0: 7269 6573 2069 6d61 6765 2e0a 2020 2020  ries image..    
+00067cb0: 7468 7265 7368 6f6c 6420 2866 6c6f 6174  threshold (float
+00067cc0: 293a 2054 6872 6573 686f 6c64 2066 6f72  ): Threshold for
+00067cd0: 2064 6574 6572 6d69 6e69 6e67 2068 6967   determining hig
+00067ce0: 6820 6c65 7665 7261 6765 2076 6f6c 756d  h leverage volum
+00067cf0: 6573 2062 6173 6564 206f 6e20 4c6f 4f50  es based on LoOP
+00067d00: 2073 636f 7265 732e 0a20 2020 206d 6173   scores..    mas
+00067d10: 6b20 2861 6e74 7349 6d61 6765 293a 2072  k (antsImage): r
+00067d20: 6573 7472 6963 7473 2074 6f20 6120 524f  estricts to a RO
+00067d30: 490a 2020 2020 7665 7262 6f73 6520 2862  I.    verbose (b
+00067d40: 6f6f 6c29 0a0a 2020 2020 5265 7475 726e  ool)..    Return
+00067d50: 733a 0a20 2020 2074 7570 6c65 3a20 4120  s:.    tuple: A 
+00067d60: 7475 706c 6520 636f 6e74 6169 6e69 6e67  tuple containing
+00067d70: 2074 6865 2063 656e 736f 7265 6420 7469   the censored ti
+00067d80: 6d65 2073 6572 6965 7320 2841 4e54 7349  me series (ANTsI
+00067d90: 6d61 6765 2920 616e 6420 7468 6520 696e  mage) and the in
+00067da0: 6469 6365 7320 6f66 2074 6865 2068 6967  dices of the hig
+00067db0: 6820 6c65 7665 7261 6765 2076 6f6c 756d  h leverage volum
+00067dc0: 6573 2e0a 2020 2020 2222 220a 2020 2020  es..    """.    
+00067dd0: 696d 706f 7274 2077 6172 6e69 6e67 730a  import warnings.
+00067de0: 2020 2020 6966 2078 2e73 6861 7065 5b33      if x.shape[3
+00067df0: 5d20 3c20 3230 3a20 2320 6a75 7374 2061  ] < 20: # just a
+00067e00: 2067 7565 7373 2061 7420 7768 6174 2077   guess at what w
+00067e10: 6520 6e65 6564 2068 6572 6520 2e2e 2e0a  e need here ....
+00067e20: 2020 2020 2020 2020 7761 726e 696e 6773          warnings
+00067e30: 2e77 6172 6e28 2257 6172 6e69 6e67 3a20  .warn("Warning: 
+00067e40: 7468 6520 7469 6d65 2064 696d 656e 7369  the time dimensi
+00067e50: 6f6e 2069 7320 3c20 3230 202d 2074 6f6f  on is < 20 - too
+00067e60: 2066 6577 2073 616d 706c 6573 2066 6f72   few samples for
+00067e70: 206c 6f6f 702e 206a 7573 7420 7265 7475   loop. just retu
+00067e80: 726e 2074 6865 206f 7269 6769 6e61 6c20  rn the original 
+00067e90: 6461 7461 2e22 290a 2020 2020 2020 2020  data.").        
+00067ea0: 7265 7475 726e 2078 2c20 5b5d 0a20 2020  return x, [].   
+00067eb0: 2069 6620 6d61 736b 2069 7320 4e6f 6e65   if mask is None
+00067ec0: 3a0a 2020 2020 2020 2020 666c 6174 7465  :.        flatte
+00067ed0: 6e65 645f 7365 7269 6573 203d 2066 6c61  ned_series = fla
+00067ee0: 7474 656e 5f74 696d 655f 7365 7269 6573  tten_time_series
+00067ef0: 2878 2e6e 756d 7079 2829 290a 2020 2020  (x.numpy()).    
+00067f00: 656c 7365 3a0a 2020 2020 2020 2020 666c  else:.        fl
+00067f10: 6174 7465 6e65 645f 7365 7269 6573 203d  attened_series =
+00067f20: 2061 6e74 732e 7469 6d65 7365 7269 6573   ants.timeseries
+00067f30: 5f74 6f5f 6d61 7472 6978 2820 782c 206d  _to_matrix( x, m
+00067f40: 6173 6b20 290a 2020 2020 6c6f 6f70 5f73  ask ).    loop_s
+00067f50: 636f 7265 7320 3d20 6361 6c63 756c 6174  cores = calculat
+00067f60: 655f 6c6f 6f70 5f73 636f 7265 7328 666c  e_loop_scores(fl
+00067f70: 6174 7465 6e65 645f 7365 7269 6573 290a  attened_series).
+00067f80: 2020 2020 6869 6768 5f6c 6576 6572 6167      high_leverag
+00067f90: 655f 766f 6c75 6d65 7320 3d20 6e70 2e77  e_volumes = np.w
+00067fa0: 6865 7265 286c 6f6f 705f 7363 6f72 6573  here(loop_scores
+00067fb0: 203e 2074 6872 6573 686f 6c64 295b 305d   > threshold)[0]
+00067fc0: 0a20 2020 2069 6620 7665 7262 6f73 653a  .    if verbose:
+00067fd0: 0a20 2020 2020 2020 2070 7269 6e74 2822  .        print("
+00067fe0: 4c4f 4f50 2048 6967 6820 4c65 7665 7261  LOOP High Levera
+00067ff0: 6765 2056 6f6c 756d 6573 3a22 2c20 6869  ge Volumes:", hi
+00068000: 6768 5f6c 6576 6572 6167 655f 766f 6c75  gh_leverage_volu
+00068010: 6d65 7329 0a20 2020 206e 6577 5f61 736c  mes).    new_asl
+00068020: 203d 2072 656d 6f76 655f 766f 6c75 6d65   = remove_volume
+00068030: 735f 6672 6f6d 5f74 696d 6573 6572 6965  s_from_timeserie
+00068040: 7328 782c 2068 6967 685f 6c65 7665 7261  s(x, high_levera
+00068050: 6765 5f76 6f6c 756d 6573 290a 2020 2020  ge_volumes).    
+00068060: 7265 7475 726e 206e 6577 5f61 736c 2c20  return new_asl, 
+00068070: 6869 6768 5f6c 6576 6572 6167 655f 766f  high_leverage_vo
+00068080: 6c75 6d65 730a 0a0a 6465 6620 6e6f 7665  lumes...def nove
+00068090: 6c74 795f 6465 7465 6374 696f 6e5f 6565  lty_detection_ee
+000680a0: 2864 665f 7472 6169 6e2c 2064 665f 7465  (df_train, df_te
+000680b0: 7374 2c20 636f 6e74 616d 696e 6174 696f  st, contaminatio
+000680c0: 6e3d 302e 3035 293a 0a20 2020 2022 2222  n=0.05):.    """
+000680d0: 0a20 2020 2054 6869 7320 6675 6e63 7469  .    This functi
+000680e0: 6f6e 2070 6572 666f 726d 7320 6e6f 7665  on performs nove
+000680f0: 6c74 7920 6465 7465 6374 696f 6e20 7573  lty detection us
+00068100: 696e 6720 456c 6c69 7074 6963 2045 6e76  ing Elliptic Env
+00068110: 656c 6f70 652e 0a0a 2020 2020 5061 7261  elope...    Para
+00068120: 6d65 7465 7273 3a0a 0a20 2020 202d 2064  meters:..    - d
+00068130: 665f 7472 6169 6e20 2870 616e 6461 7320  f_train (pandas 
+00068140: 6461 7461 6672 616d 6529 3a20 7472 6169  dataframe): trai
+00068150: 6e69 6e67 2064 6174 6120 7573 6564 2074  ning data used t
+00068160: 6f20 6669 7420 7468 6520 6d6f 6465 6c0a  o fit the model.
+00068170: 0a20 2020 202d 2064 665f 7465 7374 2028  .    - df_test (
+00068180: 7061 6e64 6173 2064 6174 6166 7261 6d65  pandas dataframe
+00068190: 293a 2074 6573 7420 6461 7461 2075 7365  ): test data use
+000681a0: 6420 746f 2070 7265 6469 6374 206e 6f76  d to predict nov
+000681b0: 656c 7469 6573 0a0a 2020 2020 2d20 636f  elties..    - co
+000681c0: 6e74 616d 696e 6174 696f 6e20 2866 6c6f  ntamination (flo
+000681d0: 6174 293a 2070 6172 616d 6574 6572 2063  at): parameter c
+000681e0: 6f6e 7472 6f6c 6c69 6e67 2074 6865 2070  ontrolling the p
+000681f0: 726f 706f 7274 696f 6e20 6f66 206f 7574  roportion of out
+00068200: 6c69 6572 7320 696e 2074 6865 2064 6174  liers in the dat
+00068210: 6120 2864 6566 6175 6c74 3a20 302e 3035  a (default: 0.05
+00068220: 290a 0a20 2020 2052 6574 7572 6e73 3a0a  )..    Returns:.
+00068230: 0a20 2020 2070 7265 6469 6374 696f 6e73  .    predictions
+00068240: 2028 7061 6e64 6173 2073 6572 6965 7329   (pandas series)
+00068250: 3a20 7072 6564 6963 7465 6420 6c61 6265  : predicted labe
+00068260: 6c73 2066 6f72 2074 6865 2074 6573 7420  ls for the test 
+00068270: 6461 7461 2028 3120 666f 7220 6e6f 7665  data (1 for nove
+00068280: 6c74 6965 732c 2030 2066 6f72 2069 6e6c  lties, 0 for inl
+00068290: 6965 7273 290a 2020 2020 2222 220a 2020  iers).    """.  
+000682a0: 2020 696d 706f 7274 2070 616e 6461 7320    import pandas 
+000682b0: 6173 2070 640a 2020 2020 6672 6f6d 2073  as pd.    from s
+000682c0: 6b6c 6561 726e 2e63 6f76 6172 6961 6e63  klearn.covarianc
+000682d0: 6520 696d 706f 7274 2045 6c6c 6970 7469  e import Ellipti
+000682e0: 6345 6e76 656c 6f70 650a 2020 2020 2320  cEnvelope.    # 
+000682f0: 4669 7420 7468 6520 6d6f 6465 6c20 6f6e  Fit the model on
+00068300: 2074 6865 2074 7261 696e 696e 6720 6461   the training da
+00068310: 7461 0a20 2020 2063 6c66 203d 2045 6c6c  ta.    clf = Ell
+00068320: 6970 7469 6345 6e76 656c 6f70 6528 636f  ipticEnvelope(co
+00068330: 6e74 616d 696e 6174 696f 6e3d 636f 6e74  ntamination=cont
+00068340: 616d 696e 6174 696f 6e2c 7375 7070 6f72  amination,suppor
+00068350: 745f 6672 6163 7469 6f6e 3d31 290a 2020  t_fraction=1).  
+00068360: 2020 6466 5f74 7261 696e 5b20 6466 5f74    df_train[ df_t
+00068370: 7261 696e 203d 3d20 6d61 7468 2e69 6e66  rain == math.inf
+00068380: 205d 203d 2030 0a20 2020 2064 665f 7465   ] = 0.    df_te
+00068390: 7374 5b20 6466 5f74 6573 7420 3d3d 206d  st[ df_test == m
+000683a0: 6174 682e 696e 6620 5d20 3d20 300a 2020  ath.inf ] = 0.  
+000683b0: 2020 6672 6f6d 2073 6b6c 6561 726e 2e70    from sklearn.p
+000683c0: 7265 7072 6f63 6573 7369 6e67 2069 6d70  reprocessing imp
+000683d0: 6f72 7420 5374 616e 6461 7264 5363 616c  ort StandardScal
+000683e0: 6572 0a20 2020 2073 6361 6c65 7220 3d20  er.    scaler = 
+000683f0: 5374 616e 6461 7264 5363 616c 6572 2829  StandardScaler()
+00068400: 0a20 2020 2073 6361 6c65 722e 6669 7428  .    scaler.fit(
+00068410: 6466 5f74 7261 696e 290a 2020 2020 636c  df_train).    cl
+00068420: 662e 6669 7428 7363 616c 6572 2e74 7261  f.fit(scaler.tra
+00068430: 6e73 666f 726d 2864 665f 7472 6169 6e29  nsform(df_train)
+00068440: 290a 2020 2020 7072 6564 6963 7469 6f6e  ).    prediction
+00068450: 7320 3d20 636c 662e 7072 6564 6963 7428  s = clf.predict(
+00068460: 7363 616c 6572 2e74 7261 6e73 666f 726d  scaler.transform
+00068470: 2864 665f 7465 7374 2929 0a20 2020 2070  (df_test)).    p
+00068480: 7265 6469 6374 696f 6e73 5b70 7265 6469  redictions[predi
+00068490: 6374 696f 6e73 3d3d 315d 3d30 0a20 2020  ctions==1]=0.   
+000684a0: 2070 7265 6469 6374 696f 6e73 5b70 7265   predictions[pre
+000684b0: 6469 6374 696f 6e73 3d3d 2d31 5d3d 310a  dictions==-1]=1.
+000684c0: 2020 2020 6966 2073 7472 2874 7970 6528      if str(type(
+000684d0: 6466 5f74 7261 696e 2929 3d3d 223c 636c  df_train))=="<cl
+000684e0: 6173 7320 2770 616e 6461 732e 636f 7265  ass 'pandas.core
+000684f0: 2e66 7261 6d65 2e44 6174 6146 7261 6d65  .frame.DataFrame
+00068500: 273e 223a 0a20 2020 2020 2020 2072 6574  '>":.        ret
+00068510: 7572 6e20 7064 2e53 6572 6965 7328 7072  urn pd.Series(pr
+00068520: 6564 6963 7469 6f6e 732c 2069 6e64 6578  edictions, index
+00068530: 3d64 665f 7465 7374 2e69 6e64 6578 290a  =df_test.index).
+00068540: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00068550: 2020 7265 7475 726e 2070 642e 5365 7269    return pd.Seri
+00068560: 6573 2870 7265 6469 6374 696f 6e73 290a  es(predictions).
+00068570: 0a0a 0a64 6566 206e 6f76 656c 7479 5f64  ...def novelty_d
+00068580: 6574 6563 7469 6f6e 5f73 766d 2864 665f  etection_svm(df_
+00068590: 7472 6169 6e2c 2064 665f 7465 7374 2c20  train, df_test, 
+000685a0: 6e75 3d30 2e30 352c 206b 6572 6e65 6c3d  nu=0.05, kernel=
+000685b0: 2772 6266 2729 3a0a 2020 2020 2222 220a  'rbf'):.    """.
+000685c0: 2020 2020 5468 6973 2066 756e 6374 696f      This functio
+000685d0: 6e20 7065 7266 6f72 6d73 206e 6f76 656c  n performs novel
+000685e0: 7479 2064 6574 6563 7469 6f6e 2075 7369  ty detection usi
+000685f0: 6e67 204f 6e65 2d43 6c61 7373 2053 564d  ng One-Class SVM
+00068600: 2e0a 0a20 2020 2050 6172 616d 6574 6572  ...    Parameter
+00068610: 733a 0a0a 2020 2020 2d20 6466 5f74 7261  s:..    - df_tra
+00068620: 696e 2028 7061 6e64 6173 2064 6174 6166  in (pandas dataf
+00068630: 7261 6d65 293a 2074 7261 696e 696e 6720  rame): training 
+00068640: 6461 7461 2075 7365 6420 746f 2066 6974  data used to fit
+00068650: 2074 6865 206d 6f64 656c 0a0a 2020 2020   the model..    
+00068660: 2d20 6466 5f74 6573 7420 2870 616e 6461  - df_test (panda
+00068670: 7320 6461 7461 6672 616d 6529 3a20 7465  s dataframe): te
+00068680: 7374 2064 6174 6120 7573 6564 2074 6f20  st data used to 
+00068690: 7072 6564 6963 7420 6e6f 7665 6c74 6965  predict noveltie
+000686a0: 730a 0a20 2020 202d 206e 7520 2866 6c6f  s..    - nu (flo
+000686b0: 6174 293a 2070 6172 616d 6574 6572 2063  at): parameter c
+000686c0: 6f6e 7472 6f6c 6c69 6e67 2074 6865 2066  ontrolling the f
+000686d0: 7261 6374 696f 6e20 6f66 2074 7261 696e  raction of train
+000686e0: 696e 6720 6572 726f 7273 2061 6e64 2074  ing errors and t
+000686f0: 6865 2066 7261 6374 696f 6e20 6f66 2073  he fraction of s
+00068700: 7570 706f 7274 2076 6563 746f 7273 2028  upport vectors (
+00068710: 6465 6661 756c 743a 2030 2e30 3529 0a0a  default: 0.05)..
+00068720: 2020 2020 2d20 6b65 726e 656c 2028 7374      - kernel (st
+00068730: 7229 3a20 6b65 726e 656c 2074 7970 6520  r): kernel type 
+00068740: 7573 6564 2069 6e20 7468 6520 5356 4d20  used in the SVM 
+00068750: 616c 676f 7269 7468 6d20 2864 6566 6175  algorithm (defau
+00068760: 6c74 3a20 2772 6266 2729 0a0a 2020 2020  lt: 'rbf')..    
+00068770: 5265 7475 726e 733a 0a0a 2020 2020 7072  Returns:..    pr
+00068780: 6564 6963 7469 6f6e 7320 2870 616e 6461  edictions (panda
+00068790: 7320 7365 7269 6573 293a 2070 7265 6469  s series): predi
+000687a0: 6374 6564 206c 6162 656c 7320 666f 7220  cted labels for 
+000687b0: 7468 6520 7465 7374 2064 6174 6120 2831  the test data (1
+000687c0: 2066 6f72 206e 6f76 656c 7469 6573 2c20   for novelties, 
+000687d0: 3020 666f 7220 696e 6c69 6572 7329 0a20  0 for inliers). 
+000687e0: 2020 2022 2222 0a20 2020 2066 726f 6d20     """.    from 
+000687f0: 736b 6c65 6172 6e2e 7376 6d20 696d 706f  sklearn.svm impo
+00068800: 7274 204f 6e65 436c 6173 7353 564d 0a20  rt OneClassSVM. 
+00068810: 2020 2023 2046 6974 2074 6865 206d 6f64     # Fit the mod
+00068820: 656c 206f 6e20 7468 6520 7472 6169 6e69  el on the traini
+00068830: 6e67 2064 6174 610a 2020 2020 6466 5f74  ng data.    df_t
+00068840: 7261 696e 5b20 6466 5f74 7261 696e 203d  rain[ df_train =
+00068850: 3d20 6d61 7468 2e69 6e66 205d 203d 2030  = math.inf ] = 0
+00068860: 0a20 2020 2064 665f 7465 7374 5b20 6466  .    df_test[ df
+00068870: 5f74 6573 7420 3d3d 206d 6174 682e 696e  _test == math.in
+00068880: 6620 5d20 3d20 300a 2020 2020 636c 6620  f ] = 0.    clf 
+00068890: 3d20 4f6e 6543 6c61 7373 5356 4d28 6e75  = OneClassSVM(nu
+000688a0: 3d6e 752c 206b 6572 6e65 6c3d 6b65 726e  =nu, kernel=kern
+000688b0: 656c 290a 2020 2020 6672 6f6d 2073 6b6c  el).    from skl
+000688c0: 6561 726e 2e70 7265 7072 6f63 6573 7369  earn.preprocessi
+000688d0: 6e67 2069 6d70 6f72 7420 5374 616e 6461  ng import Standa
+000688e0: 7264 5363 616c 6572 0a20 2020 2073 6361  rdScaler.    sca
+000688f0: 6c65 7220 3d20 5374 616e 6461 7264 5363  ler = StandardSc
+00068900: 616c 6572 2829 0a20 2020 2073 6361 6c65  aler().    scale
+00068910: 722e 6669 7428 6466 5f74 7261 696e 290a  r.fit(df_train).
+00068920: 2020 2020 636c 662e 6669 7428 7363 616c      clf.fit(scal
+00068930: 6572 2e74 7261 6e73 666f 726d 2864 665f  er.transform(df_
+00068940: 7472 6169 6e29 290a 2020 2020 7072 6564  train)).    pred
+00068950: 6963 7469 6f6e 7320 3d20 636c 662e 7072  ictions = clf.pr
+00068960: 6564 6963 7428 7363 616c 6572 2e74 7261  edict(scaler.tra
+00068970: 6e73 666f 726d 2864 665f 7465 7374 2929  nsform(df_test))
+00068980: 0a20 2020 2070 7265 6469 6374 696f 6e73  .    predictions
+00068990: 5b70 7265 6469 6374 696f 6e73 3d3d 315d  [predictions==1]
+000689a0: 3d30 0a20 2020 2070 7265 6469 6374 696f  =0.    predictio
+000689b0: 6e73 5b70 7265 6469 6374 696f 6e73 3d3d  ns[predictions==
+000689c0: 2d31 5d3d 310a 2020 2020 6966 2073 7472  -1]=1.    if str
+000689d0: 2874 7970 6528 6466 5f74 7261 696e 2929  (type(df_train))
+000689e0: 3d3d 223c 636c 6173 7320 2770 616e 6461  =="<class 'panda
+000689f0: 732e 636f 7265 2e66 7261 6d65 2e44 6174  s.core.frame.Dat
+00068a00: 6146 7261 6d65 273e 223a 0a20 2020 2020  aFrame'>":.     
+00068a10: 2020 2072 6574 7572 6e20 7064 2e53 6572     return pd.Ser
+00068a20: 6965 7328 7072 6564 6963 7469 6f6e 732c  ies(predictions,
+00068a30: 2069 6e64 6578 3d64 665f 7465 7374 2e69   index=df_test.i
+00068a40: 6e64 6578 290a 2020 2020 656c 7365 3a0a  ndex).    else:.
+00068a50: 2020 2020 2020 2020 7265 7475 726e 2070          return p
+00068a60: 642e 5365 7269 6573 2870 7265 6469 6374  d.Series(predict
+00068a70: 696f 6e73 290a 0a0a 0a64 6566 206e 6f76  ions)....def nov
+00068a80: 656c 7479 5f64 6574 6563 7469 6f6e 5f6c  elty_detection_l
+00068a90: 6f66 2864 665f 7472 6169 6e2c 2064 665f  of(df_train, df_
+00068aa0: 7465 7374 2c20 6e5f 6e65 6967 6862 6f72  test, n_neighbor
+00068ab0: 733d 3230 293a 0a20 2020 2022 2222 0a20  s=20):.    """. 
+00068ac0: 2020 2054 6869 7320 6675 6e63 7469 6f6e     This function
+00068ad0: 2070 6572 666f 726d 7320 6e6f 7665 6c74   performs novelt
+00068ae0: 7920 6465 7465 6374 696f 6e20 7573 696e  y detection usin
+00068af0: 6720 4c6f 6361 6c20 4f75 746c 6965 7220  g Local Outlier 
+00068b00: 4661 6374 6f72 2028 4c4f 4629 2e0a 0a20  Factor (LOF)... 
+00068b10: 2020 2050 6172 616d 6574 6572 733a 0a0a     Parameters:..
+00068b20: 2020 2020 2d20 6466 5f74 7261 696e 2028      - df_train (
+00068b30: 7061 6e64 6173 2064 6174 6166 7261 6d65  pandas dataframe
+00068b40: 293a 2074 7261 696e 696e 6720 6461 7461  ): training data
+00068b50: 2075 7365 6420 746f 2066 6974 2074 6865   used to fit the
+00068b60: 206d 6f64 656c 0a0a 2020 2020 2d20 6466   model..    - df
+00068b70: 5f74 6573 7420 2870 616e 6461 7320 6461  _test (pandas da
+00068b80: 7461 6672 616d 6529 3a20 7465 7374 2064  taframe): test d
+00068b90: 6174 6120 7573 6564 2074 6f20 7072 6564  ata used to pred
+00068ba0: 6963 7420 6e6f 7665 6c74 6965 730a 0a20  ict novelties.. 
+00068bb0: 2020 202d 206e 5f6e 6569 6768 626f 7273     - n_neighbors
+00068bc0: 2028 696e 7429 3a20 6e75 6d62 6572 206f   (int): number o
+00068bd0: 6620 6e65 6967 6862 6f72 7320 7573 6564  f neighbors used
+00068be0: 2074 6f20 636f 6d70 7574 6520 7468 6520   to compute the 
+00068bf0: 4c4f 4620 2864 6566 6175 6c74 3a20 3230  LOF (default: 20
+00068c00: 290a 0a20 2020 2052 6574 7572 6e73 3a0a  )..    Returns:.
+00068c10: 0a20 2020 202d 2070 7265 6469 6374 696f  .    - predictio
+00068c20: 6e73 2028 7061 6e64 6173 2073 6572 6965  ns (pandas serie
+00068c30: 7329 3a20 7072 6564 6963 7465 6420 6c61  s): predicted la
+00068c40: 6265 6c73 2066 6f72 2074 6865 2074 6573  bels for the tes
+00068c50: 7420 6461 7461 2028 3120 666f 7220 6e6f  t data (1 for no
+00068c60: 7665 6c74 6965 732c 2030 2066 6f72 2069  velties, 0 for i
+00068c70: 6e6c 6965 7273 290a 0a20 2020 2022 2222  nliers)..    """
+00068c80: 0a20 2020 2066 726f 6d20 736b 6c65 6172  .    from sklear
+00068c90: 6e2e 6e65 6967 6862 6f72 7320 696d 706f  n.neighbors impo
+00068ca0: 7274 204c 6f63 616c 4f75 746c 6965 7246  rt LocalOutlierF
+00068cb0: 6163 746f 720a 2020 2020 2320 4669 7420  actor.    # Fit 
+00068cc0: 7468 6520 6d6f 6465 6c20 6f6e 2074 6865  the model on the
+00068cd0: 2074 7261 696e 696e 6720 6461 7461 0a20   training data. 
+00068ce0: 2020 2064 665f 7472 6169 6e5b 2064 665f     df_train[ df_
+00068cf0: 7472 6169 6e20 3d3d 206d 6174 682e 696e  train == math.in
+00068d00: 6620 5d20 3d20 300a 2020 2020 6466 5f74  f ] = 0.    df_t
+00068d10: 6573 745b 2064 665f 7465 7374 203d 3d20  est[ df_test == 
+00068d20: 6d61 7468 2e69 6e66 205d 203d 2030 0a20  math.inf ] = 0. 
+00068d30: 2020 2063 6c66 203d 204c 6f63 616c 4f75     clf = LocalOu
+00068d40: 746c 6965 7246 6163 746f 7228 6e5f 6e65  tlierFactor(n_ne
+00068d50: 6967 6862 6f72 733d 6e5f 6e65 6967 6862  ighbors=n_neighb
+00068d60: 6f72 732c 2061 6c67 6f72 6974 686d 3d27  ors, algorithm='
+00068d70: 6175 746f 272c 636f 6e74 616d 696e 6174  auto',contaminat
+00068d80: 696f 6e3d 2761 7574 6f27 2c20 6e6f 7665  ion='auto', nove
+00068d90: 6c74 793d 5472 7565 290a 2020 2020 6672  lty=True).    fr
+00068da0: 6f6d 2073 6b6c 6561 726e 2e70 7265 7072  om sklearn.prepr
+00068db0: 6f63 6573 7369 6e67 2069 6d70 6f72 7420  ocessing import 
+00068dc0: 5374 616e 6461 7264 5363 616c 6572 0a20  StandardScaler. 
+00068dd0: 2020 2073 6361 6c65 7220 3d20 5374 616e     scaler = Stan
+00068de0: 6461 7264 5363 616c 6572 2829 0a20 2020  dardScaler().   
+00068df0: 2073 6361 6c65 722e 6669 7428 6466 5f74   scaler.fit(df_t
+00068e00: 7261 696e 290a 2020 2020 636c 662e 6669  rain).    clf.fi
+00068e10: 7428 7363 616c 6572 2e74 7261 6e73 666f  t(scaler.transfo
+00068e20: 726d 2864 665f 7472 6169 6e29 290a 2020  rm(df_train)).  
+00068e30: 2020 7072 6564 6963 7469 6f6e 7320 3d20    predictions = 
+00068e40: 636c 662e 7072 6564 6963 7428 7363 616c  clf.predict(scal
+00068e50: 6572 2e74 7261 6e73 666f 726d 2864 665f  er.transform(df_
+00068e60: 7465 7374 2929 0a20 2020 2070 7265 6469  test)).    predi
+00068e70: 6374 696f 6e73 5b70 7265 6469 6374 696f  ctions[predictio
+00068e80: 6e73 3d3d 315d 3d30 0a20 2020 2070 7265  ns==1]=0.    pre
+00068e90: 6469 6374 696f 6e73 5b70 7265 6469 6374  dictions[predict
+00068ea0: 696f 6e73 3d3d 2d31 5d3d 310a 2020 2020  ions==-1]=1.    
+00068eb0: 6966 2073 7472 2874 7970 6528 6466 5f74  if str(type(df_t
+00068ec0: 7261 696e 2929 3d3d 223c 636c 6173 7320  rain))=="<class 
+00068ed0: 2770 616e 6461 732e 636f 7265 2e66 7261  'pandas.core.fra
+00068ee0: 6d65 2e44 6174 6146 7261 6d65 273e 223a  me.DataFrame'>":
+00068ef0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00068f00: 7064 2e53 6572 6965 7328 7072 6564 6963  pd.Series(predic
+00068f10: 7469 6f6e 732c 2069 6e64 6578 3d64 665f  tions, index=df_
+00068f20: 7465 7374 2e69 6e64 6578 290a 2020 2020  test.index).    
+00068f30: 656c 7365 3a0a 2020 2020 2020 2020 7265  else:.        re
+00068f40: 7475 726e 2070 642e 5365 7269 6573 2870  turn pd.Series(p
+00068f50: 7265 6469 6374 696f 6e73 290a 0a0a 6465  redictions)...de
+00068f60: 6620 6e6f 7665 6c74 795f 6465 7465 6374  f novelty_detect
+00068f70: 696f 6e5f 6c6f 6f70 2864 665f 7472 6169  ion_loop(df_trai
+00068f80: 6e2c 2064 665f 7465 7374 2c20 6e5f 6e65  n, df_test, n_ne
+00068f90: 6967 6862 6f72 733d 3230 2c20 6469 7374  ighbors=20, dist
+00068fa0: 616e 6365 5f6d 6574 7269 633d 276d 696e  ance_metric='min
+00068fb0: 6b6f 7773 6b69 2729 3a0a 2020 2020 2222  kowski'):.    ""
+00068fc0: 220a 2020 2020 5468 6973 2066 756e 6374  ".    This funct
+00068fd0: 696f 6e20 7065 7266 6f72 6d73 206e 6f76  ion performs nov
+00068fe0: 656c 7479 2064 6574 6563 7469 6f6e 2075  elty detection u
+00068ff0: 7369 6e67 204c 6f63 616c 204f 7574 6c69  sing Local Outli
+00069000: 6572 2046 6163 746f 7220 284c 4f46 292e  er Factor (LOF).
+00069010: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+00069020: 3a0a 0a20 2020 202d 2064 665f 7472 6169  :..    - df_trai
+00069030: 6e20 2870 616e 6461 7320 6461 7461 6672  n (pandas datafr
+00069040: 616d 6529 3a20 7472 6169 6e69 6e67 2064  ame): training d
+00069050: 6174 6120 7573 6564 2074 6f20 6669 7420  ata used to fit 
+00069060: 7468 6520 6d6f 6465 6c0a 0a20 2020 202d  the model..    -
+00069070: 2064 665f 7465 7374 2028 7061 6e64 6173   df_test (pandas
+00069080: 2064 6174 6166 7261 6d65 293a 2074 6573   dataframe): tes
+00069090: 7420 6461 7461 2075 7365 6420 746f 2070  t data used to p
+000690a0: 7265 6469 6374 206e 6f76 656c 7469 6573  redict novelties
+000690b0: 0a0a 2020 2020 2d20 6e5f 6e65 6967 6862  ..    - n_neighb
+000690c0: 6f72 7320 2869 6e74 293a 206e 756d 6265  ors (int): numbe
+000690d0: 7220 6f66 206e 6569 6768 626f 7273 2075  r of neighbors u
+000690e0: 7365 6420 746f 2063 6f6d 7075 7465 2074  sed to compute t
+000690f0: 6865 204c 4f4f 5020 2864 6566 6175 6c74  he LOOP (default
+00069100: 3a20 3230 290a 0a20 2020 202d 2064 6973  : 20)..    - dis
+00069110: 7461 6e63 655f 6d65 7472 6963 203a 2064  tance_metric : d
+00069120: 6566 6175 6c74 206d 696e 6b6f 7773 6b69  efault minkowski
+00069130: 0a0a 2020 2020 5265 7475 726e 733a 0a0a  ..    Returns:..
+00069140: 2020 2020 2d20 7072 6564 6963 7469 6f6e      - prediction
+00069150: 7320 2870 616e 6461 7320 7365 7269 6573  s (pandas series
+00069160: 293a 2070 7265 6469 6374 6564 206c 6162  ): predicted lab
+00069170: 656c 7320 666f 7220 7468 6520 7465 7374  els for the test
+00069180: 2064 6174 6120 2831 2066 6f72 206e 6f76   data (1 for nov
+00069190: 656c 7469 6573 2c20 3020 666f 7220 696e  elties, 0 for in
+000691a0: 6c69 6572 7329 0a0a 2020 2020 2222 220a  liers)..    """.
+000691b0: 2020 2020 6672 6f6d 2050 794e 6f6d 616c      from PyNomal
+000691c0: 7920 696d 706f 7274 206c 6f6f 700a 2020  y import loop.  
+000691d0: 2020 6672 6f6d 2073 6b6c 6561 726e 2e6e    from sklearn.n
+000691e0: 6569 6768 626f 7273 2069 6d70 6f72 7420  eighbors import 
+000691f0: 4e65 6172 6573 744e 6569 6768 626f 7273  NearestNeighbors
+00069200: 0a20 2020 2066 726f 6d20 736b 6c65 6172  .    from sklear
+00069210: 6e2e 7072 6570 726f 6365 7373 696e 6720  n.preprocessing 
+00069220: 696d 706f 7274 2053 7461 6e64 6172 6453  import StandardS
+00069230: 6361 6c65 720a 2020 2020 7363 616c 6572  caler.    scaler
+00069240: 203d 2053 7461 6e64 6172 6453 6361 6c65   = StandardScale
+00069250: 7228 290a 2020 2020 7363 616c 6572 2e66  r().    scaler.f
+00069260: 6974 2864 665f 7472 6169 6e29 0a20 2020  it(df_train).   
+00069270: 2064 6174 6120 3d20 6e70 2e76 7374 6163   data = np.vstac
+00069280: 6b28 205b 7363 616c 6572 2e74 7261 6e73  k( [scaler.trans
+00069290: 666f 726d 2864 665f 7465 7374 292c 7363  form(df_test),sc
+000692a0: 616c 6572 2e74 7261 6e73 666f 726d 2864  aler.transform(d
+000692b0: 665f 7472 6169 6e29 5d29 0a20 2020 206e  f_train)]).    n
+000692c0: 6569 6768 203d 204e 6561 7265 7374 4e65  eigh = NearestNe
+000692d0: 6967 6862 6f72 7328 6e5f 6e65 6967 6862  ighbors(n_neighb
+000692e0: 6f72 733d 6e5f 6e65 6967 6862 6f72 732c  ors=n_neighbors,
+000692f0: 206d 6574 7269 633d 6469 7374 616e 6365   metric=distance
+00069300: 5f6d 6574 7269 6329 0a20 2020 206e 6569  _metric).    nei
+00069310: 6768 2e66 6974 2864 6174 6129 0a20 2020  gh.fit(data).   
+00069320: 2064 2c20 6964 7820 3d20 6e65 6967 682e   d, idx = neigh.
+00069330: 6b6e 6569 6768 626f 7273 2864 6174 612c  kneighbors(data,
+00069340: 2072 6574 7572 6e5f 6469 7374 616e 6365   return_distance
+00069350: 3d54 7275 6529 0a20 2020 206d 203d 206c  =True).    m = l
+00069360: 6f6f 702e 4c6f 6361 6c4f 7574 6c69 6572  oop.LocalOutlier
+00069370: 5072 6f62 6162 696c 6974 7928 6469 7374  Probability(dist
+00069380: 616e 6365 5f6d 6174 7269 783d 642c 206e  ance_matrix=d, n
+00069390: 6569 6768 626f 725f 6d61 7472 6978 3d69  eighbor_matrix=i
+000693a0: 6478 2c20 6e5f 6e65 6967 6862 6f72 733d  dx, n_neighbors=
+000693b0: 6e5f 6e65 6967 6862 6f72 7329 2e66 6974  n_neighbors).fit
+000693c0: 2829 0a20 2020 2072 6574 7572 6e20 6d2e  ().    return m.
+000693d0: 6c6f 6361 6c5f 6f75 746c 6965 725f 7072  local_outlier_pr
+000693e0: 6f62 6162 696c 6974 6965 735b 7261 6e67  obabilities[rang
+000693f0: 6528 6466 5f74 6573 742e 7368 6170 655b  e(df_test.shape[
+00069400: 305d 295d 0a0a 0a0a 6465 6620 6e6f 7665  0])]....def nove
+00069410: 6c74 795f 6465 7465 6374 696f 6e5f 7175  lty_detection_qu
+00069420: 616e 7469 6c65 2864 665f 7472 6169 6e2c  antile(df_train,
+00069430: 2064 665f 7465 7374 293a 0a20 2020 2022   df_test):.    "
+00069440: 2222 0a20 2020 2054 6869 7320 6675 6e63  "".    This func
+00069450: 7469 6f6e 2070 6572 666f 726d 7320 6e6f  tion performs no
+00069460: 7665 6c74 7920 6465 7465 6374 696f 6e20  velty detection 
+00069470: 7573 696e 6720 7175 616e 7469 6c65 7320  using quantiles 
+00069480: 666f 7220 6561 6368 2063 6f6c 756d 6e2e  for each column.
+00069490: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+000694a0: 3a0a 0a20 2020 202d 2064 665f 7472 6169  :..    - df_trai
+000694b0: 6e20 2870 616e 6461 7320 6461 7461 6672  n (pandas datafr
+000694c0: 616d 6529 3a20 7472 6169 6e69 6e67 2064  ame): training d
+000694d0: 6174 6120 7573 6564 2074 6f20 6669 7420  ata used to fit 
+000694e0: 7468 6520 6d6f 6465 6c0a 0a20 2020 202d  the model..    -
+000694f0: 2064 665f 7465 7374 2028 7061 6e64 6173   df_test (pandas
+00069500: 2064 6174 6166 7261 6d65 293a 2074 6573   dataframe): tes
+00069510: 7420 6461 7461 2075 7365 6420 746f 2070  t data used to p
+00069520: 7265 6469 6374 206e 6f76 656c 7469 6573  redict novelties
+00069530: 0a0a 2020 2020 5265 7475 726e 733a 0a0a  ..    Returns:..
+00069540: 2020 2020 2d20 7175 616e 7469 6c65 7320      - quantiles 
+00069550: 666f 7220 7468 6520 7465 7374 2073 616d  for the test sam
+00069560: 706c 6520 6174 2065 6163 6820 636f 6c75  ple at each colu
+00069570: 6d6e 2077 6865 7265 2076 616c 7565 7320  mn where values 
+00069580: 7261 6e67 6520 696e 205b 302c 315d 0a20  range in [0,1]. 
+00069590: 2020 2020 2020 2061 6e64 2068 6967 6865         and highe
+000695a0: 7220 7661 6c75 6573 206d 6561 6e20 7468  r values mean th
+000695b0: 6520 636f 6c75 6d6e 2069 7320 636c 6f73  e column is clos
+000695c0: 6572 2074 6f20 7468 6520 6564 6765 206f  er to the edge o
+000695d0: 6620 7468 6520 6469 7374 7269 6275 7469  f the distributi
+000695e0: 6f6e 0a0a 2020 2020 2222 220a 2020 2020  on..    """.    
+000695f0: 6d79 7173 203d 2064 665f 7465 7374 2e63  myqs = df_test.c
+00069600: 6f70 7928 290a 2020 2020 6e20 3d20 6466  opy().    n = df
+00069610: 5f74 7261 696e 2e73 6861 7065 5b30 5d0a  _train.shape[0].
+00069620: 2020 2020 6466 5f74 7261 696e 6b65 7973      df_trainkeys
+00069630: 203d 2064 665f 7472 6169 6e2e 6b65 7973   = df_train.keys
+00069640: 2829 0a20 2020 2066 6f72 206b 2069 6e20  ().    for k in 
+00069650: 7261 6e67 6528 2064 665f 7472 6169 6e2e  range( df_train.
+00069660: 7368 6170 655b 315d 2029 3a0a 2020 2020  shape[1] ):.    
+00069670: 2020 2020 6d79 6b65 7920 3d20 6466 5f74      mykey = df_t
+00069680: 7261 696e 6b65 7973 5b6b 5d0a 2020 2020  rainkeys[k].    
+00069690: 2020 2020 7465 6d70 203d 2028 6d79 7173      temp = (myqs
+000696a0: 5b6d 796b 6579 5d5b 305d 203e 2020 6466  [mykey][0] >  df
+000696b0: 5f74 7261 696e 5b6d 796b 6579 5d29 2e73  _train[mykey]).s
+000696c0: 756d 2829 202f 206e 0a20 2020 2020 2020  um() / n.       
+000696d0: 206d 7971 735b 6d79 6b65 795d 203d 2061   myqs[mykey] = a
+000696e0: 6273 2820 7465 6d70 202d 2030 2e35 2029  bs( temp - 0.5 )
+000696f0: 202f 2030 2e35 0a20 2020 2072 6574 7572   / 0.5.    retur
+00069700: 6e20 6d79 7173 0a0a 6465 6620 6272 6169  n myqs..def brai
+00069710: 6e6d 6170 5f66 6967 7572 6528 7374 6174  nmap_figure(stat
+00069720: 6973 7469 6361 6c5f 6466 2c20 6461 7461  istical_df, data
+00069730: 5f64 6963 7469 6f6e 6172 795f 7061 7468  _dictionary_path
+00069740: 2c20 6f75 7470 7574 5f70 7265 6669 782c  , output_prefix,
+00069750: 2062 7261 696e 5f69 6d61 6765 2c20 6f76   brain_image, ov
+00069760: 6572 6c61 795f 636d 6170 3d27 6277 7227  erlay_cmap='bwr'
+00069770: 2c20 6e73 6c69 6365 733d 3231 2c20 6e63  , nslices=21, nc
+00069780: 6f6c 3d37 2c20 6564 6765 5f69 6d61 6765  ol=7, edge_image
+00069790: 5f64 696c 6174 696f 6e20 3d20 302c 2062  _dilation = 0, b
+000697a0: 6c61 636b 5f62 673d 5472 7565 2c20 6178  lack_bg=True, ax
+000697b0: 6573 203d 205b 302c 312c 325d 2c20 6669  es = [0,1,2], fi
+000697c0: 7865 645f 6f76 6572 6c61 795f 7261 6e67  xed_overlay_rang
+000697d0: 653d 4e6f 6e65 2c20 6372 6f70 3d35 2c20  e=None, crop=5, 
+000697e0: 7665 7262 6f73 653d 4661 6c73 6520 293a  verbose=False ):
+000697f0: 0a20 2020 2022 2222 0a20 2020 2043 7265  .    """.    Cre
+00069800: 6174 6520 6669 6775 7265 7320 6261 7365  ate figures base
+00069810: 6420 6f6e 2073 7461 7469 7374 6963 616c  d on statistical
+00069820: 2064 6174 6120 616e 6420 616e 2075 6e64   data and an und
+00069830: 6572 6c79 696e 6720 6272 6169 6e20 696d  erlying brain im
+00069840: 6167 652e 0a0a 2020 2020 4173 7375 6d65  age...    Assume
+00069850: 7320 626f 7468 207e 2f2e 616e 7473 7079  s both ~/.antspy
+00069860: 7431 7720 616e 6420 7e2f 2e61 6e74 7370  t1w and ~/.antsp
+00069870: 796d 6d20 6461 7461 2069 7320 6176 6169  ymm data is avai
+00069880: 6c61 626c 650a 0a20 2020 2050 6172 616d  lable..    Param
+00069890: 6574 6572 733a 0a20 2020 202d 2073 7461  eters:.    - sta
+000698a0: 7469 7374 6963 616c 5f64 6620 2870 616e  tistical_df (pan
+000698b0: 6461 7320 6461 7461 6672 616d 6529 3a20  das dataframe): 
+000698c0: 7769 7468 2032 2063 6f6c 756d 6e73 206e  with 2 columns n
+000698d0: 616d 6564 2061 6e61 7420 616e 6420 7661  amed anat and va
+000698e0: 6c75 6573 0a20 2020 2020 2020 2074 6865  lues.        the
+000698f0: 2061 6e61 7420 636f 6c75 6d6e 2073 686f   anat column sho
+00069900: 756c 6420 6861 7665 206e 616d 6573 2074  uld have names t
+00069910: 6861 7420 6d65 6574 202a 7061 7274 6961  hat meet *partia
+00069920: 6c20 6d61 7463 6869 6e67 2a20 6372 6974  l matching* crit
+00069930: 6572 696f 6e20 0a20 2020 2020 2020 2077  erion .        w
+00069940: 6974 6820 7265 7370 6563 7420 746f 2072  ith respect to r
+00069950: 6567 696f 6e73 2074 6861 7420 6172 6520  egions that are 
+00069960: 6d65 6173 7572 6564 2069 6e20 616e 7473  measured in ants
+00069970: 7079 6d6d 2e20 2020 7661 6c75 6520 7769  pymm.   value wi
+00069980: 6c6c 2062 6520 0a20 2020 2020 2020 2074  ll be .        t
+00069990: 6865 2076 616c 7565 2074 6f20 6265 2064  he value to be d
+000699a0: 6973 706c 6179 6564 2e20 2020 6966 2074  isplayed.   if t
+000699b0: 776f 2065 7861 6d70 6c65 7320 6f66 2061  wo examples of a
+000699c0: 2067 6976 656e 2072 6567 696f 6e20 6578   given region ex
+000699d0: 6973 7420 696e 200a 2020 2020 2020 2020  ist in .        
+000699e0: 7374 6174 6973 7469 6361 6c5f 6466 2c20  statistical_df, 
+000699f0: 7468 656e 2074 6865 206c 6172 6765 7374  then the largest
+00069a00: 2061 6273 6f6c 7574 6520 7661 6c75 6520   absolute value 
+00069a10: 7769 6c6c 2062 6520 7461 6b65 6e20 666f  will be taken fo
+00069a20: 7220 6469 7370 6c61 792e 0a20 2020 202d  r display..    -
+00069a30: 2064 6174 615f 6469 6374 696f 6e61 7279   data_dictionary
+00069a40: 5f70 6174 6820 2873 7472 293a 2050 6174  _path (str): Pat
+00069a50: 6820 746f 2074 6865 2064 6174 6120 6469  h to the data di
+00069a60: 6374 696f 6e61 7279 2043 5356 2066 696c  ctionary CSV fil
+00069a70: 652e 0a20 2020 202d 206f 7574 7075 745f  e..    - output_
+00069a80: 7072 6566 6978 2028 7374 7229 3a20 5072  prefix (str): Pr
+00069a90: 6566 6978 2066 6f72 2074 6865 206f 7574  efix for the out
+00069aa0: 7075 7420 6669 6775 7265 2066 696c 656e  put figure filen
+00069ab0: 616d 6573 2e0a 2020 2020 2d20 6272 6169  ames..    - brai
+00069ac0: 6e5f 696d 6167 6520 2861 6e74 7349 6d61  n_image (antsIma
+00069ad0: 6765 293a 2074 6865 2062 7261 696e 2069  ge): the brain i
+00069ae0: 6d61 6765 206f 6e20 7768 6963 6820 7265  mage on which re
+00069af0: 7375 6c74 7320 7769 6c6c 206f 7665 726c  sults will overl
+00069b00: 6179 2e0a 2020 2020 2d20 6f76 6572 6c61  ay..    - overla
+00069b10: 795f 636d 6170 2028 7374 7229 3a20 7365  y_cmap (str): se
+00069b20: 6520 6d61 7470 6c6f 746c 6962 0a20 2020  e matplotlib.   
+00069b30: 202d 206e 736c 6963 6573 2028 696e 7429   - nslices (int)
+00069b40: 3a20 6e75 6d62 6572 206f 6620 736c 6963  : number of slic
+00069b50: 6573 2074 6f20 7368 6f77 0a20 2020 202d  es to show.    -
+00069b60: 206e 636f 6c20 2869 6e74 293a 206e 756d   ncol (int): num
+00069b70: 6265 7220 6f66 2063 6f6c 756d 6e73 2074  ber of columns t
+00069b80: 6f20 7368 6f77 0a20 2020 202d 2065 6467  o show.    - edg
+00069b90: 655f 696d 6167 655f 6469 6c61 7469 6f6e  e_image_dilation
+00069ba0: 2028 696e 7429 3a20 696e 7465 6765 7220   (int): integer 
+00069bb0: 6772 6561 7465 7220 7468 616e 206f 7220  greater than or 
+00069bc0: 6571 7561 6c20 746f 207a 6572 6f0a 2020  equal to zero.  
+00069bd0: 2020 2d20 626c 6163 6b5f 6267 2028 626f    - black_bg (bo
+00069be0: 6f6c 293a 2062 6f6f 6c65 616e 0a20 2020  ol): boolean.   
+00069bf0: 202d 2061 7865 7320 286c 6973 7429 3a20   - axes (list): 
+00069c00: 696e 7465 6765 7220 6c69 7374 2074 7970  integer list typ
+00069c10: 6963 616c 6c79 205b 302c 312c 325d 2073  ically [0,1,2] s
+00069c20: 6167 6974 7461 6c20 636f 726f 6e61 6c20  agittal coronal 
+00069c30: 6178 6961 6c0a 2020 2020 2d20 6669 7865  axial.    - fixe
+00069c40: 645f 6f76 6572 6c61 795f 7261 6e67 6520  d_overlay_range 
+00069c50: 286c 6973 7429 3a20 7363 616c 6172 2070  (list): scalar p
+00069c60: 6169 7220 7769 6c6c 2074 7279 2074 6f20  air will try to 
+00069c70: 6b65 6570 2061 2063 6f6e 7374 616e 7420  keep a constant 
+00069c80: 6362 6172 2061 6e64 2077 696c 6c20 7472  cbar and will tr
+00069c90: 756e 6361 7465 2074 6865 206f 7665 726c  uncate the overl
+00069ca0: 6179 2061 7420 7468 6573 6520 6d69 6e2f  ay at these min/
+00069cb0: 6d61 7820 7661 6c75 6573 0a20 2020 202d  max values.    -
+00069cc0: 2063 726f 7020 2869 6e74 293a 2063 726f   crop (int): cro
+00069cd0: 7073 2074 6865 2069 6d61 6765 2074 6f20  ps the image to 
+00069ce0: 6469 7370 6c61 7920 6279 2074 6865 2065  display by the e
+00069cf0: 7874 656e 7420 6f66 2074 6865 206f 7665  xtent of the ove
+00069d00: 726c 6179 3b20 6c61 7267 6572 2076 616c  rlay; larger val
+00069d10: 7565 7320 6469 6c61 7465 2074 6865 206d  ues dilate the m
+00069d20: 6173 6b73 206d 6f72 652e 0a20 2020 202d  asks more..    -
+00069d30: 2076 6572 626f 7365 2028 626f 6f6c 293a   verbose (bool):
+00069d40: 2062 6f6f 6c65 616e 0a0a 2020 2020 5265   boolean..    Re
+00069d50: 7475 726e 733a 0a20 2020 2061 6e20 696d  turns:.    an im
+00069d60: 6167 6520 7769 7468 2076 616c 7565 7320  age with values 
+00069d70: 6d61 7070 6564 2074 6f20 7468 6520 6173  mapped to the as
+00069d80: 736f 6369 6174 6564 2072 6567 696f 6e73  sociated regions
+00069d90: 0a20 2020 2022 2222 0a20 2020 2069 6d70  .    """.    imp
+00069da0: 6f72 7420 7265 0a0a 2020 2020 2320 5265  ort re..    # Re
+00069db0: 6164 2074 6865 2073 7461 7469 7374 6963  ad the statistic
+00069dc0: 616c 2066 696c 650a 2020 2020 7a7a 203d  al file.    zz =
+00069dd0: 2073 7461 7469 7374 6963 616c 5f64 6620   statistical_df 
+00069de0: 0a20 2020 200a 2020 2020 2320 5265 6164  .    .    # Read
+00069df0: 2074 6865 2064 6174 6120 6469 6374 696f   the data dictio
+00069e00: 6e61 7279 2066 726f 6d20 6120 4353 5620  nary from a CSV 
+00069e10: 6669 6c65 0a20 2020 206d 7964 6963 7420  file.    mydict 
+00069e20: 3d20 7064 2e72 6561 645f 6373 7628 6461  = pd.read_csv(da
+00069e30: 7461 5f64 6963 7469 6f6e 6172 795f 7061  ta_dictionary_pa
+00069e40: 7468 290a 2020 2020 6d79 6469 6374 203d  th).    mydict =
+00069e50: 206d 7964 6963 745b 7e6d 7964 6963 745b   mydict[~mydict[
+00069e60: 274d 6561 7375 7265 6d65 6e74 275d 2e73  'Measurement'].s
+00069e70: 7472 2e63 6f6e 7461 696e 7328 2274 7261  tr.contains("tra
+00069e80: 6374 6f67 7261 7068 792d 6261 7365 6420  ctography-based 
+00069e90: 636f 6e6e 6563 7469 7669 7479 222c 206e  connectivity", n
+00069ea0: 613d 4661 6c73 6529 5d0a 0a20 2020 2073  a=False)]..    s
+00069eb0: 7461 7469 7374 6963 616c 5f64 665b 2761  tatistical_df['a
+00069ec0: 6e61 7427 5d20 3d20 7374 6174 6973 7469  nat'] = statisti
+00069ed0: 6361 6c5f 6466 5b27 616e 6174 275d 2e73  cal_df['anat'].s
+00069ee0: 7472 2e72 6570 6c61 6365 2822 5f22 2c20  tr.replace("_", 
+00069ef0: 222e 222c 2072 6567 6578 3d54 7275 6529  ".", regex=True)
+00069f00: 0a0a 2020 2020 2320 4c6f 6164 2069 6d61  ..    # Load ima
+00069f10: 6765 2061 6e64 2070 726f 6365 7373 2069  ge and process i
+00069f20: 740a 2020 2020 6564 6765 696d 6720 3d20  t.    edgeimg = 
+00069f30: 616e 7473 2e69 4d61 7468 2862 7261 696e  ants.iMath(brain
+00069f40: 5f69 6d61 6765 2c22 4e6f 726d 616c 697a  _image,"Normaliz
+00069f50: 6522 290a 2020 2020 6966 2065 6467 655f  e").    if edge_
+00069f60: 696d 6167 655f 6469 6c61 7469 6f6e 203e  image_dilation >
+00069f70: 2030 3a0a 2020 2020 2020 2020 6564 6765   0:.        edge
+00069f80: 696d 6720 3d20 616e 7473 2e69 4d61 7468  img = ants.iMath
+00069f90: 2820 6564 6765 696d 672c 2022 4d44 222c  ( edgeimg, "MD",
+00069fa0: 2065 6467 655f 696d 6167 655f 6469 6c61   edge_image_dila
+00069fb0: 7469 6f6e 290a 0a20 2020 2023 2044 6566  tion)..    # Def
+00069fc0: 696e 6520 6c69 7374 7320 616e 6420 6461  ine lists and da
+00069fd0: 7461 2066 7261 6d65 730a 2020 2020 706f  ta frames.    po
+00069fe0: 7374 6669 7820 3d20 5b27 6266 272c 2027  stfix = ['bf', '
+00069ff0: 6369 7431 3638 6c61 6227 2c20 276d 746c  cit168lab', 'mtl
+0006a000: 272c 2027 6365 7265 6265 6c6c 756d 272c  ', 'cerebellum',
+0006a010: 2027 646b 745f 636f 7274 6578 272c 2762   'dkt_cortex','b
+0006a020: 7261 696e 7374 656d 272c 274a 4855 5f77  rainstem','JHU_w
+0006a030: 6d27 2c27 7965 6f27 5d0a 2020 2020 6174  m','yeo'].    at
+0006a040: 6c61 7320 3d20 5b27 4246 272c 2027 4349  las = ['BF', 'CI
+0006a050: 5431 3638 272c 2027 4d54 4c27 2c20 2754  T168', 'MTL', 'T
+0006a060: 7573 7469 736f 6e43 6f62 7261 272c 2027  ustisonCobra', '
+0006a070: 6465 7369 6b61 6e2d 6b69 6c6c 6961 6e79  desikan-killiany
+0006a080: 2d74 6f75 7276 696c 6c65 272c 2762 7261  -tourville','bra
+0006a090: 696e 7374 656d 272c 274a 4855 5f77 6d27  instem','JHU_wm'
+0006a0a0: 2c27 7965 6f27 5d0a 2020 2020 706f 7374  ,'yeo'].    post
+0006a0b0: 6465 7363 203d 205b 276e 626d 3343 4831  desc = ['nbm3CH1
+0006a0c0: 3327 2c20 2743 4954 3136 385f 5265 696e  3', 'CIT168_Rein
+0006a0d0: 665f 4c65 6172 6e5f 7631 5f6c 6162 656c  f_Learn_v1_label
+0006a0e0: 5f64 6573 6372 6970 7469 6f6e 735f 7061  _descriptions_pa
+0006a0f0: 6427 2c20 276d 746c 5f64 6573 6372 6970  d', 'mtl_descrip
+0006a100: 7469 6f6e 272c 2027 6365 7265 6265 6c6c  tion', 'cerebell
+0006a110: 756d 272c 2027 646b 7427 2c27 4349 5431  um', 'dkt','CIT1
+0006a120: 3638 5f54 3177 5f37 3030 756d 5f70 6164  68_T1w_700um_pad
+0006a130: 5f61 646e 695f 6272 6169 6e73 7465 6d27  _adni_brainstem'
+0006a140: 2c27 4641 5f4a 4855 5f6c 6162 656c 735f  ,'FA_JHU_labels_
+0006a150: 6564 6974 6564 272c 2770 706d 695f 7465  edited','ppmi_te
+0006a160: 6d70 6c61 7465 5f35 3030 5061 7263 656c  mplate_500Parcel
+0006a170: 735f 5965 6f32 3031 315f 3137 4e65 7477  s_Yeo2011_17Netw
+0006a180: 6f72 6b73 5f32 3032 335f 686f 6d6f 746f  orks_2023_homoto
+0006a190: 7069 6327 5d0a 2020 2020 7374 6174 6466  pic'].    statdf
+0006a1a0: 203d 2070 642e 4461 7461 4672 616d 6528   = pd.DataFrame(
+0006a1b0: 7b27 696d 6727 3a20 706f 7374 6669 782c  {'img': postfix,
+0006a1c0: 2027 6174 6c61 7327 3a20 6174 6c61 732c   'atlas': atlas,
+0006a1d0: 2027 6373 7664 6573 6372 6970 7427 3a20   'csvdescript': 
+0006a1e0: 706f 7374 6465 7363 7d29 0a20 2020 2074  postdesc}).    t
+0006a1f0: 656d 706c 6174 6570 7265 6669 7820 3d20  emplateprefix = 
+0006a200: 277e 2f2e 616e 7473 7079 6d6d 2f50 504d  '~/.antspymm/PPM
+0006a210: 495f 7465 6d70 6c61 7465 305f 270a 2020  I_template0_'.  
+0006a220: 2020 2320 4974 6572 6174 6520 7468 726f    # Iterate thro
+0006a230: 7567 6820 636f 6c75 6d6e 7320 616e 6420  ugh columns and 
+0006a240: 6372 6561 7465 2066 6967 7572 6573 0a20  create figures. 
+0006a250: 2020 2063 6f6c 3276 697a 203d 2027 7661     col2viz = 'va
+0006a260: 6c75 6573 270a 2020 2020 6966 2054 7275  lues'.    if Tru
+0006a270: 653a 0a20 2020 2020 2020 2061 6e61 7474  e:.        anatt
+0006a280: 6f73 686f 7720 3d20 7a7a 5b27 616e 6174  oshow = zz['anat
+0006a290: 275d 2e75 6e69 7175 6528 290a 2020 2020  '].unique().    
+0006a2a0: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
+0006a2b0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0006a2c0: 7428 636f 6c32 7669 7a29 0a20 2020 2020  t(col2viz).     
+0006a2d0: 2020 2020 2020 2070 7269 6e74 2861 6e61         print(ana
+0006a2e0: 7474 6f73 686f 7729 0a20 2020 2020 2020  ttoshow).       
+0006a2f0: 2023 2052 6573 7420 6f66 2079 6f75 7220   # Rest of your 
+0006a300: 636f 6465 2066 6f72 2066 6967 7572 6520  code for figure 
+0006a310: 6372 6561 7469 6f6e 2067 6f65 7320 6865  creation goes he
+0006a320: 7265 2e2e 2e0a 2020 2020 2020 2020 6164  re....        ad
+0006a330: 6465 6d20 3d20 6564 6765 696d 6720 2a20  dem = edgeimg * 
+0006a340: 300a 2020 2020 2020 2020 666f 7220 6b20  0.        for k 
+0006a350: 696e 2072 616e 6765 286c 656e 2861 6e61  in range(len(ana
+0006a360: 7474 6f73 686f 7729 293a 0a20 2020 2020  ttoshow)):.     
+0006a370: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+0006a380: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0006a390: 2020 2070 7269 6e74 2873 7472 286b 2920     print(str(k) 
+0006a3a0: 2b20 2022 2022 202b 2061 6e61 7474 6f73  +  " " + anattos
+0006a3b0: 686f 775b 6b5d 2020 290a 2020 2020 2020  how[k]  ).      
+0006a3c0: 2020 2020 2020 6d79 7375 6220 3d20 7a7a        mysub = zz
+0006a3d0: 5b7a 7a5b 2761 6e61 7427 5d2e 7374 722e  [zz['anat'].str.
+0006a3e0: 636f 6e74 6169 6e73 2861 6e61 7474 6f73  contains(anattos
+0006a3f0: 686f 775b 6b5d 295d 0a20 2020 2020 2020  how[k])].       
+0006a400: 2020 2020 2061 6e61 7473 6561 723d 7265       anatsear=re
+0006a410: 2e73 7562 2822 6474 692e 6661 222c 2222  .sub("dti.fa",""
+0006a420: 2c61 6e61 7474 6f73 686f 775b 6b5d 290a  ,anattoshow[k]).
+0006a430: 2020 2020 2020 2020 2020 2020 616e 6174              anat
+0006a440: 7365 6172 3d72 652e 7375 6228 2263 6266  sear=re.sub("cbf
+0006a450: 2e22 2c22 222c 616e 6174 7365 6172 290a  .","",anatsear).
+0006a460: 2020 2020 2020 2020 2020 2020 616e 6174              anat
+0006a470: 7365 6172 3d72 652e 7375 6228 2274 312e  sear=re.sub("t1.
+0006a480: 766f 6c61 7379 6d22 2c22 222c 616e 6174  volasym","",anat
+0006a490: 7365 6172 290a 2020 2020 2020 2020 2020  sear).          
+0006a4a0: 2020 616e 6174 7365 6172 3d72 652e 7375    anatsear=re.su
+0006a4b0: 6228 2274 312e 7468 6b61 7379 6d22 2c22  b("t1.thkasym","
+0006a4c0: 222c 616e 6174 7365 6172 290a 2020 2020  ",anatsear).    
+0006a4d0: 2020 2020 2020 2020 616e 6174 7365 6172          anatsear
+0006a4e0: 3d72 652e 7375 6228 2274 312e 6172 6561  =re.sub("t1.area
+0006a4f0: 6173 796d 222c 2222 2c61 6e61 7473 6561  asym","",anatsea
+0006a500: 7229 0a20 2020 2020 2020 2020 2020 2061  r).            a
+0006a510: 6e61 7473 6561 723d 7265 2e73 7562 2822  natsear=re.sub("
+0006a520: 7431 2e76 6f6c 2e22 2c22 222c 616e 6174  t1.vol.","",anat
+0006a530: 7365 6172 290a 2020 2020 2020 2020 2020  sear).          
+0006a540: 2020 616e 6174 7365 6172 3d72 652e 7375    anatsear=re.su
+0006a550: 6228 2274 312e 7468 6b2e 222c 2222 2c61  b("t1.thk.","",a
+0006a560: 6e61 7473 6561 7229 0a20 2020 2020 2020  natsear).       
+0006a570: 2020 2020 2061 6e61 7473 6561 723d 7265       anatsear=re
+0006a580: 2e73 7562 2822 7431 2e61 7265 612e 222c  .sub("t1.area.",
+0006a590: 2222 2c61 6e61 7473 6561 7229 0a20 2020  "",anatsear).   
+0006a5a0: 2020 2020 2020 2020 2061 6e61 7473 6561           anatsea
+0006a5b0: 723d 7265 2e73 7562 2822 6173 796d 6470  r=re.sub("asymdp
+0006a5c0: 2e22 2c22 222c 616e 6174 7365 6172 290a  .","",anatsear).
+0006a5d0: 2020 2020 2020 2020 2020 2020 616e 6174              anat
+0006a5e0: 7365 6172 3d72 652e 7375 6228 2261 7379  sear=re.sub("asy
+0006a5f0: 6d2e 222c 2222 2c61 6e61 7473 6561 7229  m.","",anatsear)
+0006a600: 0a20 2020 2020 2020 2020 2020 2061 6e61  .            ana
+0006a610: 7473 6561 723d 7265 2e73 7562 2822 6474  tsear=re.sub("dt
+0006a620: 692e 6d64 2e22 2c22 222c 616e 6174 7365  i.md.","",anatse
+0006a630: 6172 290a 2020 2020 2020 2020 2020 2020  ar).            
+0006a640: 616e 6174 7365 6172 3d72 652e 7375 6228  anatsear=re.sub(
+0006a650: 2264 7469 2e66 612e 222c 2222 2c61 6e61  "dti.fa.","",ana
+0006a660: 7473 6561 7229 0a20 2020 2020 2020 2020  tsear).         
+0006a670: 2020 2061 6e61 7473 6561 723d 7265 2e73     anatsear=re.s
+0006a680: 7562 2822 6474 692e 6d64 222c 2222 2c61  ub("dti.md","",a
+0006a690: 6e61 7473 6561 7229 0a20 2020 2020 2020  natsear).       
+0006a6a0: 2020 2020 2061 6e61 7473 6561 723d 7265       anatsear=re
+0006a6b0: 2e73 7562 2822 6474 692e 6d65 616e 2e6d  .sub("dti.mean.m
+0006a6c0: 642e 222c 2222 2c61 6e61 7473 6561 7229  d.","",anatsear)
+0006a6d0: 0a20 2020 2020 2020 2020 2020 2061 6e61  .            ana
+0006a6e0: 7473 6561 723d 7265 2e73 7562 2822 6474  tsear=re.sub("dt
+0006a6f0: 692e 6d65 616e 2e66 612e 222c 2222 2c61  i.mean.fa.","",a
+0006a700: 6e61 7473 6561 7229 0a20 2020 2020 2020  natsear).       
+0006a710: 2020 2020 2061 6e61 7473 6561 723d 7265       anatsear=re
+0006a720: 2e73 7562 2822 6c72 6176 6722 2c22 222c  .sub("lravg","",
+0006a730: 616e 6174 7365 6172 290a 2020 2020 2020  anatsear).      
+0006a740: 2020 2020 2020 6174 6c61 7373 6561 7263        atlassearc
+0006a750: 6820 3d20 6d79 6469 6374 5b27 7469 6479  h = mydict['tidy
+0006a760: 6e61 6d65 7327 5d2e 7374 722e 636f 6e74  names'].str.cont
+0006a770: 6169 6e73 2861 6e61 7473 6561 7229 0a20  ains(anatsear). 
+0006a780: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
+0006a790: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
+0006a7a0: 2020 2020 2020 2070 7269 6e74 2820 2220         print( " 
+0006a7b0: 616e 6174 7365 6172 2022 202b 2061 6e61  anatsear " + ana
+0006a7c0: 7473 6561 7220 2b20 2220 6174 6c61 7373  tsear + " atlass
+0006a7d0: 6561 7263 6820 2220 290a 2020 2020 2020  earch " ).      
+0006a7e0: 2020 2020 2020 6966 2061 746c 6173 7365        if atlasse
+0006a7f0: 6172 6368 2e73 756d 2829 203e 2030 3a0a  arch.sum() > 0:.
+0006a800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a810: 7768 6963 6861 746c 6173 203d 206d 7964  whichatlas = myd
+0006a820: 6963 745b 6174 6c61 7373 6561 7263 685d  ict[atlassearch]
+0006a830: 5b27 4174 6c61 7327 5d2e 696c 6f63 5b30  ['Atlas'].iloc[0
+0006a840: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0006a850: 2020 6f67 6c61 6265 6c6e 616d 6520 3d20    oglabelname = 
+0006a860: 6d79 6469 6374 5b61 746c 6173 7365 6172  mydict[atlassear
+0006a870: 6368 5d5b 274c 6162 656c 275d 2e69 6c6f  ch]['Label'].ilo
+0006a880: 635b 305d 0a20 2020 2020 2020 2020 2020  c[0].           
+0006a890: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0006a8a0: 2020 2020 2020 2070 7269 6e74 2861 6e61         print(ana
+0006a8b0: 7473 6561 7229 0a20 2020 2020 2020 2020  tsear).         
+0006a8c0: 2020 2020 2020 206f 676c 6162 656c 6e61         oglabelna
+0006a8d0: 6d65 3d27 756e 6b6e 6f77 6e27 0a20 2020  me='unknown'.   
+0006a8e0: 2020 2020 2020 2020 2020 2020 2077 6869               whi
+0006a8f0: 6368 6174 6c61 733d 4e6f 6e65 0a20 2020  chatlas=None.   
+0006a900: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
+0006a910: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+0006a920: 2020 2020 2070 7269 6e74 2822 6f67 6c61       print("ogla
+0006a930: 6265 6c6e 616d 6520 2220 2b20 6f67 6c61  belname " + ogla
+0006a940: 6265 6c6e 616d 6520 2b20 2220 7768 6963  belname + " whic
+0006a950: 6861 746c 6173 2022 202b 2073 7472 2877  hatlas " + str(w
+0006a960: 6869 6368 6174 6c61 7329 2029 0a20 2020  hichatlas) ).   
+0006a970: 2020 2020 2020 2020 2076 616c 7332 7669           vals2vi
+0006a980: 7a20 3d20 6d79 7375 625b 636f 6c32 7669  z = mysub[col2vi
+0006a990: 7a5d 2e61 6767 285b 276d 696e 272c 2027  z].agg(['min', '
+0006a9a0: 6d61 7827 5d29 0a20 2020 2020 2020 2020  max']).         
+0006a9b0: 2020 2076 616c 7332 7669 7a20 3d20 7661     vals2viz = va
+0006a9c0: 6c73 3276 697a 5b61 6273 2876 616c 7332  ls2viz[abs(vals2
+0006a9d0: 7669 7a29 2e69 6478 6d61 7828 295d 0a20  viz).idxmax()]. 
+0006a9e0: 2020 2020 2020 2020 2020 206d 7965 7874             myext
+0006a9f0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+0006aa00: 2020 2020 6966 2027 646b 7463 6f72 7465      if 'dktcorte
+0006aa10: 7827 2069 6e20 616e 6174 746f 7368 6f77  x' in anattoshow
+0006aa20: 5b6b 5d20 6f72 2077 6869 6368 6174 6c61  [k] or whichatla
+0006aa30: 7320 3d3d 2027 6465 7369 6b61 6e2d 6b69  s == 'desikan-ki
+0006aa40: 6c6c 6961 6e79 2d74 6f75 7276 696c 6c65  lliany-tourville
+0006aa50: 2720 6f72 2027 6474 6b72 6567 696f 6e73  ' or 'dtkregions
+0006aa60: 2720 696e 2061 6e61 7474 6f73 686f 775b  ' in anattoshow[
+0006aa70: 6b5d 3a0a 2020 2020 2020 2020 2020 2020  k]:.            
+0006aa80: 2020 2020 6d79 6578 7420 3d20 2764 6b74      myext = 'dkt
+0006aa90: 5f63 6f72 7465 7827 0a20 2020 2020 2020  _cortex'.       
+0006aaa0: 2020 2020 2065 6c69 6620 2763 6974 3136       elif 'cit16
+0006aab0: 3827 2069 6e20 616e 6174 746f 7368 6f77  8' in anattoshow
+0006aac0: 5b6b 5d20 6f72 2077 6869 6368 6174 6c61  [k] or whichatla
+0006aad0: 7320 3d3d 2027 4349 5431 3638 273a 0a20  s == 'CIT168':. 
+0006aae0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0006aaf0: 7965 7874 203d 2027 6369 7431 3638 6c61  yext = 'cit168la
+0006ab00: 6227 0a20 2020 2020 2020 2020 2020 2065  b'.            e
+0006ab10: 6c69 6620 276d 746c 2720 696e 2061 6e61  lif 'mtl' in ana
+0006ab20: 7474 6f73 686f 775b 6b5d 3a0a 2020 2020  ttoshow[k]:.    
+0006ab30: 2020 2020 2020 2020 2020 2020 6d79 6578              myex
+0006ab40: 7420 3d20 276d 746c 270a 2020 2020 2020  t = 'mtl'.      
+0006ab50: 2020 2020 2020 2020 2020 6f67 6c61 6265            oglabe
+0006ab60: 6c6e 616d 653d 7265 2e73 7562 2827 6d74  lname=re.sub('mt
+0006ab70: 6c27 2c20 2727 2c61 6e61 7473 6561 7229  l', '',anatsear)
+0006ab80: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+0006ab90: 6620 2763 6572 6562 656c 6c75 6d27 2069  f 'cerebellum' i
+0006aba0: 6e20 616e 6174 746f 7368 6f77 5b6b 5d3a  n anattoshow[k]:
+0006abb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006abc0: 206d 7965 7874 203d 2027 6365 7265 6265   myext = 'cerebe
+0006abd0: 6c6c 756d 270a 2020 2020 2020 2020 2020  llum'.          
+0006abe0: 2020 2020 2020 6f67 6c61 6265 6c6e 616d        oglabelnam
+0006abf0: 653d 7265 2e73 7562 2827 6365 7265 6265  e=re.sub('cerebe
+0006ac00: 6c6c 756d 272c 2027 272c 616e 6174 7365  llum', '',anatse
+0006ac10: 6172 290a 2020 2020 2020 2020 2020 2020  ar).            
+0006ac20: 2020 2020 2320 6f67 6c61 6265 6c6e 616d      # oglabelnam
+0006ac30: 653d 6f67 6c61 6265 6c6e 616d 655b 323a  e=oglabelname[2:
+0006ac40: 5d0a 2020 2020 2020 2020 2020 2020 656c  ].            el
+0006ac50: 6966 2027 6272 6169 6e73 7465 6d27 2069  if 'brainstem' i
+0006ac60: 6e20 616e 6174 746f 7368 6f77 5b6b 5d3a  n anattoshow[k]:
+0006ac70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006ac80: 206d 7965 7874 203d 2027 6272 6169 6e73   myext = 'brains
+0006ac90: 7465 6d27 0a20 2020 2020 2020 2020 2020  tem'.           
+0006aca0: 2065 6c69 6620 616e 7928 6974 656d 2069   elif any(item i
+0006acb0: 6e20 616e 6174 746f 7368 6f77 5b6b 5d20  n anattoshow[k] 
+0006acc0: 666f 7220 6974 656d 2069 6e20 5b27 6e62  for item in ['nb
+0006acd0: 6d27 2c20 2762 6627 5d29 3a0a 2020 2020  m', 'bf']):.    
+0006ace0: 2020 2020 2020 2020 2020 2020 6d79 6578              myex
+0006acf0: 7420 3d20 2762 6627 0a20 2020 2020 2020  t = 'bf'.       
+0006ad00: 2020 2020 2020 2020 206f 676c 6162 656c           oglabel
+0006ad10: 6e61 6d65 3d72 652e 7375 6228 7227 5c2e  name=re.sub(r'\.
+0006ad20: 272c 2027 5f27 2c61 6e61 7473 6561 7229  ', '_',anatsear)
+0006ad30: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+0006ad40: 6620 7768 6963 6861 746c 6173 203d 3d20  f whichatlas == 
+0006ad50: 276a 6f68 6e73 2068 6f70 6b69 6e73 2077  'johns hopkins w
+0006ad60: 6869 7465 206d 6174 7465 7227 3a0a 2020  hite matter':.  
+0006ad70: 2020 2020 2020 2020 2020 2020 2020 6d79                my
+0006ad80: 6578 7420 3d20 274a 4855 5f77 6d27 0a20  ext = 'JHU_wm'. 
+0006ad90: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0006ada0: 7768 6963 6861 746c 6173 203d 3d20 2764  whichatlas == 'd
+0006adb0: 6573 696b 616e 2d6b 696c 6c69 616e 792d  esikan-killiany-
+0006adc0: 746f 7572 7669 6c6c 6527 3a0a 2020 2020  tourville':.    
+0006add0: 2020 2020 2020 2020 2020 2020 6d79 6578              myex
+0006ade0: 7420 3d20 2764 6b74 5f63 6f72 7465 7827  t = 'dkt_cortex'
+0006adf0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+0006ae00: 6620 7768 6963 6861 746c 6173 203d 3d20  f whichatlas == 
+0006ae10: 2743 4954 3136 3827 3a0a 2020 2020 2020  'CIT168':.      
+0006ae20: 2020 2020 2020 2020 2020 6d79 6578 7420            myext 
+0006ae30: 3d20 2763 6974 3136 386c 6162 270a 2020  = 'cit168lab'.  
+0006ae40: 2020 2020 2020 2020 2020 656c 6966 2077            elif w
+0006ae50: 6869 6368 6174 6c61 7320 3d3d 2027 4246  hichatlas == 'BF
+0006ae60: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+0006ae70: 2020 206d 7965 7874 203d 2027 6266 270a     myext = 'bf'.
+0006ae80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ae90: 6f67 6c61 6265 6c6e 616d 653d 7265 2e73  oglabelname=re.s
+0006aea0: 7562 2827 6266 272c 2027 272c 6f67 6c61  ub('bf', '',ogla
+0006aeb0: 6265 6c6e 616d 6529 0a20 2020 2020 2020  belname).       
+0006aec0: 2020 2020 2065 6c69 6620 7768 6963 6861       elif whicha
+0006aed0: 746c 6173 203d 3d20 2779 656f 5f68 6f6d  tlas == 'yeo_hom
+0006aee0: 6f74 6f70 6963 273a 0a20 2020 2020 2020  otopic':.       
+0006aef0: 2020 2020 2020 2020 206d 7965 7874 203d           myext =
+0006af00: 2027 7965 6f27 0a20 2020 2020 2020 2020   'yeo'.         
+0006af10: 2020 2069 6620 6d79 6578 7420 6973 204e     if myext is N
+0006af20: 6f6e 6520 616e 6420 7665 7262 6f73 653a  one and verbose:
+0006af30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006af40: 2069 6620 7768 6963 6861 746c 6173 2069   if whichatlas i
+0006af50: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0006af60: 2020 2020 2020 2020 2020 2020 7768 6963              whic
+0006af70: 6861 746c 6173 3d27 4e6f 6e65 270a 2020  hatlas='None'.  
+0006af80: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0006af90: 2061 6e61 7474 6f73 686f 775b 6b5d 2069   anattoshow[k] i
+0006afa0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0006afb0: 2020 2020 2020 2020 2020 2020 616e 6174              anat
+0006afc0: 746f 7368 6f77 5b6b 5d3d 274e 6f6e 6527  toshow[k]='None'
+0006afd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006afe0: 2070 7269 6e74 2820 224d 5945 5854 2022   print( "MYEXT "
+0006aff0: 202b 2061 6e61 7474 6f73 686f 775b 6b5d   + anattoshow[k]
+0006b000: 202b 2027 2075 6e66 6f75 6e64 2027 202b   + ' unfound ' +
+0006b010: 2077 6869 6368 6174 6c61 7320 290a 2020   whichatlas ).  
+0006b020: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0006b030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b040: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+0006b050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b060: 7072 696e 7428 2022 4d59 4558 5420 2220  print( "MYEXT " 
+0006b070: 2b20 6d79 6578 7420 290a 0a20 2020 2020  + myext )..     
+0006b080: 2020 2020 2020 2069 6620 6d79 6578 7420         if myext 
+0006b090: 3d3d 2027 6369 7431 3638 6c61 6227 3a0a  == 'cit168lab':.
+0006b0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b0b0: 6f67 6c61 6265 6c6e 616d 653d 7265 2e73  oglabelname=re.s
+0006b0c0: 7562 2822 6369 7431 3638 222c 2222 2c6f  ub("cit168","",o
+0006b0d0: 676c 6162 656c 6e61 6d65 290a 2020 2020  glabelname).    
+0006b0e0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0006b0f0: 2020 2020 2066 6f72 206a 2069 6e20 706f       for j in po
+0006b100: 7374 6669 783a 0a20 2020 2020 2020 2020  stfix:.         
+0006b110: 2020 2020 2020 2069 6620 6a20 3d3d 2022         if j == "
+0006b120: 646b 745f 636f 7274 6578 223a 0a20 2020  dkt_cortex":.   
+0006b130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b140: 206a 203d 2027 646b 7463 6f72 7465 7827   j = 'dktcortex'
+0006b150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006b160: 2069 6620 6a20 3d3d 2022 6465 6570 5f63   if j == "deep_c
+0006b170: 6974 3136 386c 6162 223a 0a20 2020 2020  it168lab":.     
+0006b180: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+0006b190: 203d 2027 6465 6570 5f63 6974 3136 3827   = 'deep_cit168'
+0006b1a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006b1b0: 2061 6e61 7474 6f73 686f 775b 6b5d 203d   anattoshow[k] =
+0006b1c0: 2061 6e61 7474 6f73 686f 775b 6b5d 2e72   anattoshow[k].r
+0006b1d0: 6570 6c61 6365 286a 2c20 2222 290a 2020  eplace(j, "").  
+0006b1e0: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+0006b1f0: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+0006b200: 2020 2020 2020 7072 696e 7428 2061 6e61        print( ana
+0006b210: 7474 6f73 686f 775b 6b5d 202b 2022 2022  ttoshow[k] + " "
+0006b220: 202b 2073 7472 2820 7661 6c73 3276 697a   + str( vals2viz
+0006b230: 2029 2029 0a20 2020 2020 2020 2020 2020   ) ).           
+0006b240: 206d 7961 746c 6173 203d 2061 746c 6173   myatlas = atlas
+0006b250: 5b70 6f73 7466 6978 2e69 6e64 6578 286d  [postfix.index(m
+0006b260: 7965 7874 295d 0a20 2020 2020 2020 2020  yext)].         
+0006b270: 2020 2063 6f72 7265 6374 6465 7363 7269     correctdescri
+0006b280: 7074 203d 2070 6f73 7464 6573 635b 706f  pt = postdesc[po
+0006b290: 7374 6669 782e 696e 6465 7828 6d79 6578  stfix.index(myex
+0006b2a0: 7429 5d0a 2020 2020 2020 2020 2020 2020  t)].            
+0006b2b0: 6c6f 6366 696c 656e 616d 6520 3d20 2074  locfilename =  t
+0006b2c0: 656d 706c 6174 6570 7265 6669 7820 2b20  emplateprefix + 
+0006b2d0: 6d79 6578 7420 2b20 272e 6e69 692e 677a  myext + '.nii.gz
+0006b2e0: 270a 2020 2020 2020 2020 2020 2020 6966  '.            if
+0006b2f0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+0006b300: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0006b310: 206c 6f63 6669 6c65 6e61 6d65 2029 0a20   locfilename ). 
+0006b320: 2020 2020 2020 2020 2020 2069 6620 6d79             if my
+0006b330: 6578 7420 3d3d 2027 7965 6f27 3a0a 2020  ext == 'yeo':.  
+0006b340: 2020 2020 2020 2020 2020 2020 2020 6f67                og
+0006b350: 6c61 6265 6c6e 616d 653d 6f67 6c61 6265  labelname=oglabe
+0006b360: 6c6e 616d 652e 6c6f 7765 7228 290a 2020  lname.lower().  
+0006b370: 2020 2020 2020 2020 2020 2020 2020 6f67                og
+0006b380: 6c61 6265 6c6e 616d 653d 7265 2e73 7562  labelname=re.sub
+0006b390: 2822 7273 666d 7269 5f66 636e 7870 726f  ("rsfmri_fcnxpro
+0006b3a0: 3132 325f 222c 2222 2c6f 676c 6162 656c  122_","",oglabel
+0006b3b0: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+0006b3c0: 2020 2020 2020 6f67 6c61 6265 6c6e 616d        oglabelnam
+0006b3d0: 653d 7265 2e73 7562 2822 7273 666d 7269  e=re.sub("rsfmri
+0006b3e0: 5f66 636e 7870 726f 3132 395f 222c 2222  _fcnxpro129_",""
+0006b3f0: 2c6f 676c 6162 656c 6e61 6d65 290a 2020  ,oglabelname).  
+0006b400: 2020 2020 2020 2020 2020 2020 2020 6f67                og
+0006b410: 6c61 6265 6c6e 616d 653d 7265 2e73 7562  labelname=re.sub
+0006b420: 2822 7273 666d 7269 5f66 636e 7870 726f  ("rsfmri_fcnxpro
+0006b430: 3133 345f 222c 2222 2c6f 676c 6162 656c  134_","",oglabel
+0006b440: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+0006b450: 2020 2020 2020 6c6f 6366 696c 656e 616d        locfilenam
+0006b460: 6520 3d20 227e 2f2e 616e 7473 7079 6d6d  e = "~/.antspymm
+0006b470: 2f70 706d 695f 7465 6d70 6c61 7465 5f35  /ppmi_template_5
+0006b480: 3030 5061 7263 656c 735f 5965 6f32 3031  00Parcels_Yeo201
+0006b490: 315f 3137 4e65 7477 6f72 6b73 5f32 3032  1_17Networks_202
+0006b4a0: 335f 686f 6d6f 746f 7069 632e 6e69 692e  3_homotopic.nii.
+0006b4b0: 677a 220a 2020 2020 2020 2020 2020 2020  gz".            
+0006b4c0: 2020 2020 6174 6c61 7344 6573 6372 6970      atlasDescrip
+0006b4d0: 7420 3d20 7064 2e72 6561 645f 6373 7628  t = pd.read_csv(
+0006b4e0: 6622 7e2f 2e61 6e74 7370 796d 6d2f 7b63  f"~/.antspymm/{c
+0006b4f0: 6f72 7265 6374 6465 7363 7269 7074 7d2e  orrectdescript}.
+0006b500: 6373 7622 290a 2020 2020 2020 2020 2020  csv").          
+0006b510: 2020 2020 2020 6174 6c61 7344 6573 6372        atlasDescr
+0006b520: 6970 742e 7265 6e61 6d65 2863 6f6c 756d  ipt.rename(colum
+0006b530: 6e73 3d7b 2753 7973 7465 6d4e 616d 6527  ns={'SystemName'
+0006b540: 3a20 2744 6573 6372 6970 7469 6f6e 277d  : 'Description'}
+0006b550: 2c20 696e 706c 6163 653d 5472 7565 290a  , inplace=True).
+0006b560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b570: 6174 6c61 7344 6573 6372 6970 742e 7265  atlasDescript.re
+0006b580: 6e61 6d65 2863 6f6c 756d 6e73 3d7b 2752  name(columns={'R
+0006b590: 4f49 273a 2027 4c61 6265 6c27 7d2c 2069  OI': 'Label'}, i
+0006b5a0: 6e70 6c61 6365 3d54 7275 6529 0a20 2020  nplace=True).   
+0006b5b0: 2020 2020 2020 2020 2020 2020 2061 746c               atl
+0006b5c0: 6173 4465 7363 7269 7074 5b27 4465 7363  asDescript['Desc
+0006b5d0: 7269 7074 696f 6e27 5d20 3d20 6174 6c61  ription'] = atla
+0006b5e0: 7344 6573 6372 6970 745b 2744 6573 6372  sDescript['Descr
+0006b5f0: 6970 7469 6f6e 275d 2e73 7472 2e6c 6f77  iption'].str.low
+0006b600: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
+0006b610: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0006b620: 2020 2020 2020 2061 746c 6173 4465 7363         atlasDesc
+0006b630: 7269 7074 203d 2070 642e 7265 6164 5f63  ript = pd.read_c
+0006b640: 7376 2866 227e 2f2e 616e 7473 7079 7431  sv(f"~/.antspyt1
+0006b650: 772f 7b63 6f72 7265 6374 6465 7363 7269  w/{correctdescri
+0006b660: 7074 7d2e 6373 7622 290a 2020 2020 2020  pt}.csv").      
+0006b670: 2020 2020 2020 2020 2020 6174 6c61 7344            atlasD
+0006b680: 6573 6372 6970 745b 2744 6573 6372 6970  escript['Descrip
+0006b690: 7469 6f6e 275d 203d 2061 746c 6173 4465  tion'] = atlasDe
+0006b6a0: 7363 7269 7074 5b27 4465 7363 7269 7074  script['Descript
+0006b6b0: 696f 6e27 5d2e 7374 722e 6c6f 7765 7228  ion'].str.lower(
+0006b6c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0006b6d0: 2020 6174 6c61 7344 6573 6372 6970 745b    atlasDescript[
+0006b6e0: 2744 6573 6372 6970 7469 6f6e 275d 203d  'Description'] =
+0006b6f0: 2061 746c 6173 4465 7363 7269 7074 5b27   atlasDescript['
+0006b700: 4465 7363 7269 7074 696f 6e27 5d2e 7374  Description'].st
+0006b710: 722e 7265 706c 6163 6528 2220 222c 2022  r.replace(" ", "
+0006b720: 5f22 290a 2020 2020 2020 2020 2020 2020  _").            
+0006b730: 2020 2020 6174 6c61 7344 6573 6372 6970      atlasDescrip
+0006b740: 745b 2744 6573 6372 6970 7469 6f6e 275d  t['Description']
+0006b750: 203d 2061 746c 6173 4465 7363 7269 7074   = atlasDescript
+0006b760: 5b27 4465 7363 7269 7074 696f 6e27 5d2e  ['Description'].
+0006b770: 7374 722e 7265 706c 6163 6528 225f 6c65  str.replace("_le
+0006b780: 6674 5f22 2c20 225f 2229 0a20 2020 2020  ft_", "_").     
+0006b790: 2020 2020 2020 2020 2020 2061 746c 6173             atlas
+0006b7a0: 4465 7363 7269 7074 5b27 4465 7363 7269  Descript['Descri
+0006b7b0: 7074 696f 6e27 5d20 3d20 6174 6c61 7344  ption'] = atlasD
+0006b7c0: 6573 6372 6970 745b 2744 6573 6372 6970  escript['Descrip
+0006b7d0: 7469 6f6e 275d 2e73 7472 2e72 6570 6c61  tion'].str.repla
+0006b7e0: 6365 2822 5f72 6967 6874 5f22 2c20 225f  ce("_right_", "_
+0006b7f0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+0006b800: 2020 2061 746c 6173 4465 7363 7269 7074     atlasDescript
+0006b810: 5b27 4465 7363 7269 7074 696f 6e27 5d20  ['Description'] 
+0006b820: 3d20 6174 6c61 7344 6573 6372 6970 745b  = atlasDescript[
+0006b830: 2744 6573 6372 6970 7469 6f6e 275d 2e73  'Description'].s
+0006b840: 7472 2e72 6570 6c61 6365 2822 5f6c 6566  tr.replace("_lef
+0006b850: 7422 2c20 2222 290a 2020 2020 2020 2020  t", "").        
+0006b860: 2020 2020 2020 2020 6174 6c61 7344 6573          atlasDes
+0006b870: 6372 6970 745b 2744 6573 6372 6970 7469  cript['Descripti
+0006b880: 6f6e 275d 203d 2061 746c 6173 4465 7363  on'] = atlasDesc
+0006b890: 7269 7074 5b27 4465 7363 7269 7074 696f  ript['Descriptio
+0006b8a0: 6e27 5d2e 7374 722e 7265 706c 6163 6528  n'].str.replace(
+0006b8b0: 225f 7269 6768 7422 2c20 2222 290a 2020  "_right", "").  
+0006b8c0: 2020 2020 2020 2020 2020 2020 2020 6174                at
+0006b8d0: 6c61 7344 6573 6372 6970 745b 2744 6573  lasDescript['Des
+0006b8e0: 6372 6970 7469 6f6e 275d 203d 2061 746c  cription'] = atl
+0006b8f0: 6173 4465 7363 7269 7074 5b27 4465 7363  asDescript['Desc
+0006b900: 7269 7074 696f 6e27 5d2e 7374 722e 7265  ription'].str.re
+0006b910: 706c 6163 6528 226c 6566 745f 222c 2022  place("left_", "
+0006b920: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+0006b930: 2020 2061 746c 6173 4465 7363 7269 7074     atlasDescript
+0006b940: 5b27 4465 7363 7269 7074 696f 6e27 5d20  ['Description'] 
+0006b950: 3d20 6174 6c61 7344 6573 6372 6970 745b  = atlasDescript[
+0006b960: 2744 6573 6372 6970 7469 6f6e 275d 2e73  'Description'].s
+0006b970: 7472 2e72 6570 6c61 6365 2822 7269 6768  tr.replace("righ
+0006b980: 745f 222c 2022 2229 0a20 2020 2020 2020  t_", "").       
+0006b990: 2020 2020 2020 2020 2061 746c 6173 4465           atlasDe
+0006b9a0: 7363 7269 7074 5b27 4465 7363 7269 7074  script['Descript
+0006b9b0: 696f 6e27 5d20 3d20 6174 6c61 7344 6573  ion'] = atlasDes
+0006b9c0: 6372 6970 745b 2744 6573 6372 6970 7469  cript['Descripti
+0006b9d0: 6f6e 275d 2e73 7472 2e72 6570 6c61 6365  on'].str.replace
+0006b9e0: 2822 2f22 2c22 2e22 290a 2020 2020 2020  ("/",".").      
+0006b9f0: 2020 2020 2020 2020 2020 6966 206d 7965            if mye
+0006ba00: 7874 203d 3d20 274a 4855 5f77 6d27 3a0a  xt == 'JHU_wm':.
+0006ba10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ba20: 2020 2020 6174 6c61 7344 6573 6372 6970      atlasDescrip
+0006ba30: 745b 2744 6573 6372 6970 7469 6f6e 275d  t['Description']
+0006ba40: 203d 2061 746c 6173 4465 7363 7269 7074   = atlasDescript
+0006ba50: 5b27 4465 7363 7269 7074 696f 6e27 5d2e  ['Description'].
+0006ba60: 7374 722e 7265 706c 6163 6528 2266 612d  str.replace("fa-
+0006ba70: 222c 2022 2229 0a20 2020 2020 2020 2020  ", "").         
+0006ba80: 2020 2020 2020 2020 2020 2061 746c 6173             atlas
+0006ba90: 4465 7363 7269 7074 5b27 4465 7363 7269  Descript['Descri
+0006baa0: 7074 696f 6e27 5d20 3d20 6174 6c61 7344  ption'] = atlasD
+0006bab0: 6573 6372 6970 745b 2744 6573 6372 6970  escript['Descrip
+0006bac0: 7469 6f6e 275d 2e73 7472 2e72 6570 6c61  tion'].str.repla
+0006bad0: 6365 2822 2d6c 6566 742d 222c 2022 2229  ce("-left-", "")
+0006bae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006baf0: 2020 2020 2061 746c 6173 4465 7363 7269       atlasDescri
+0006bb00: 7074 5b27 4465 7363 7269 7074 696f 6e27  pt['Description'
+0006bb10: 5d20 3d20 6174 6c61 7344 6573 6372 6970  ] = atlasDescrip
+0006bb20: 745b 2744 6573 6372 6970 7469 6f6e 275d  t['Description']
+0006bb30: 2e73 7472 2e72 6570 6c61 6365 2822 2d72  .str.replace("-r
+0006bb40: 6967 6874 2d22 2c20 2222 290a 2020 2020  ight-", "").    
+0006bb50: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+0006bb60: 7965 7874 203d 3d20 2763 6572 6562 656c  yext == 'cerebel
+0006bb70: 6c75 6d27 3a0a 2020 2020 2020 2020 2020  lum':.          
+0006bb80: 2020 2020 2020 2020 2020 6174 6c61 7344            atlasD
+0006bb90: 6573 6372 6970 745b 2744 6573 6372 6970  escript['Descrip
+0006bba0: 7469 6f6e 275d 203d 2061 746c 6173 4465  tion'] = atlasDe
+0006bbb0: 7363 7269 7074 5b27 4465 7363 7269 7074  script['Descript
+0006bbc0: 696f 6e27 5d2e 7374 722e 7265 706c 6163  ion'].str.replac
+0006bbd0: 6528 226c 5f22 2c20 2222 290a 2020 2020  e("l_", "").    
+0006bbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006bbf0: 6174 6c61 7344 6573 6372 6970 745b 2744  atlasDescript['D
+0006bc00: 6573 6372 6970 7469 6f6e 275d 203d 2061  escription'] = a
+0006bc10: 746c 6173 4465 7363 7269 7074 5b27 4465  tlasDescript['De
+0006bc20: 7363 7269 7074 696f 6e27 5d2e 7374 722e  scription'].str.
+0006bc30: 7265 706c 6163 6528 2272 5f22 2c20 2222  replace("r_", ""
+0006bc40: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+0006bc50: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+0006bc60: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0006bc70: 2820 6174 6c61 7344 6573 6372 6970 7420  ( atlasDescript 
+0006bc80: 290a 2020 2020 2020 2020 2020 2020 6f67  ).            og
+0006bc90: 6c61 6265 6c6e 616d 6520 3d20 6f67 6c61  labelname = ogla
+0006bca0: 6265 6c6e 616d 652e 6c6f 7765 7228 290a  belname.lower().
+0006bcb0: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
+0006bcc0: 6265 6c6e 616d 6520 3d20 7265 2e73 7562  belname = re.sub
+0006bcd0: 2822 2022 2c20 225f 222c 6f67 6c61 6265  (" ", "_",oglabe
+0006bce0: 6c6e 616d 6529 0a20 2020 2020 2020 2020  lname).         
+0006bcf0: 2020 206f 676c 6162 656c 6e61 6d65 203d     oglabelname =
+0006bd00: 2072 652e 7375 6228 225f 6c65 6674 5f22   re.sub("_left_"
+0006bd10: 2c20 225f 222c 6f67 6c61 6265 6c6e 616d  , "_",oglabelnam
+0006bd20: 6529 0a20 2020 2020 2020 2020 2020 206f  e).            o
+0006bd30: 676c 6162 656c 6e61 6d65 203d 2072 652e  glabelname = re.
+0006bd40: 7375 6228 225f 7269 6768 745f 222c 2022  sub("_right_", "
+0006bd50: 5f22 2c6f 676c 6162 656c 6e61 6d65 290a  _",oglabelname).
+0006bd60: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
+0006bd70: 6265 6c6e 616d 6520 3d20 7265 2e73 7562  belname = re.sub
+0006bd80: 2822 5f6c 6566 7422 2c20 2222 2c6f 676c  ("_left", "",ogl
+0006bd90: 6162 656c 6e61 6d65 290a 2020 2020 2020  abelname).      
+0006bda0: 2020 2020 2020 6f67 6c61 6265 6c6e 616d        oglabelnam
+0006bdb0: 6520 3d20 7265 2e73 7562 2822 5f72 6967  e = re.sub("_rig
+0006bdc0: 6874 222c 2022 222c 6f67 6c61 6265 6c6e  ht", "",oglabeln
+0006bdd0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+0006bde0: 206f 676c 6162 656c 6e61 6d65 203d 2072   oglabelname = r
+0006bdf0: 652e 7375 6228 2274 3168 6965 725f 766f  e.sub("t1hier_vo
+0006be00: 6c5f 222c 2022 222c 6f67 6c61 6265 6c6e  l_", "",oglabeln
+0006be10: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+0006be20: 206f 676c 6162 656c 6e61 6d65 203d 2072   oglabelname = r
+0006be30: 652e 7375 6228 2274 3168 6965 725f 6172  e.sub("t1hier_ar
+0006be40: 6561 5f22 2c20 2222 2c6f 676c 6162 656c  ea_", "",oglabel
+0006be50: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+0006be60: 2020 6f67 6c61 6265 6c6e 616d 6520 3d20    oglabelname = 
+0006be70: 7265 2e73 7562 2822 7431 6869 6572 5f74  re.sub("t1hier_t
+0006be80: 686b 5f22 2c20 2222 2c6f 676c 6162 656c  hk_", "",oglabel
+0006be90: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+0006bea0: 2020 6f67 6c61 6265 6c6e 616d 6520 3d20    oglabelname = 
+0006beb0: 7265 2e73 7562 2822 646b 7472 6567 696f  re.sub("dktregio
+0006bec0: 6e73 222c 2022 222c 6f67 6c61 6265 6c6e  ns", "",oglabeln
+0006bed0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+0006bee0: 206f 676c 6162 656c 6e61 6d65 203d 2072   oglabelname = r
+0006bef0: 652e 7375 6228 2264 6b74 636f 7274 6578  e.sub("dktcortex
+0006bf00: 222c 2022 222c 6f67 6c61 6265 6c6e 616d  ", "",oglabelnam
+0006bf10: 6529 0a20 2020 2020 2020 2020 2020 2069  e).            i
+0006bf20: 6620 6d79 6578 7420 3d3d 2027 4a48 555f  f myext == 'JHU_
+0006bf30: 776d 273a 0a20 2020 2020 2020 2020 2020  wm':.           
+0006bf40: 2020 2020 206f 676c 6162 656c 6e61 6d65       oglabelname
+0006bf50: 203d 2072 652e 7375 6228 2264 7469 5f6d   = re.sub("dti_m
+0006bf60: 6561 6e5f 6661 2e22 2c20 2222 2c6f 676c  ean_fa.", "",ogl
+0006bf70: 6162 656c 6e61 6d65 290a 2020 2020 2020  abelname).      
+0006bf80: 2020 2020 2020 2020 2020 6f67 6c61 6265            oglabe
+0006bf90: 6c6e 616d 6520 3d20 7265 2e73 7562 2822  lname = re.sub("
+0006bfa0: 6474 695f 6d65 616e 5f6d 642e 222c 2022  dti_mean_md.", "
+0006bfb0: 222c 6f67 6c61 6265 6c6e 616d 6529 0a20  ",oglabelname). 
+0006bfc0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0006bfd0: 676c 6162 656c 6e61 6d65 203d 2072 652e  glabelname = re.
+0006bfe0: 7375 6228 222e 6c65 6674 2e22 2c20 2222  sub(".left.", ""
+0006bff0: 2c6f 676c 6162 656c 6e61 6d65 290a 2020  ,oglabelname).  
+0006c000: 2020 2020 2020 2020 2020 2020 2020 6f67                og
+0006c010: 6c61 6265 6c6e 616d 6520 3d20 7265 2e73  labelname = re.s
+0006c020: 7562 2822 2e72 6967 6874 2e22 2c20 2222  ub(".right.", ""
+0006c030: 2c6f 676c 6162 656c 6e61 6d65 290a 2020  ,oglabelname).  
+0006c040: 2020 2020 2020 2020 2020 2020 2020 6f67                og
+0006c050: 6c61 6265 6c6e 616d 6520 3d20 7265 2e73  labelname = re.s
+0006c060: 7562 2822 2e6c 7261 7667 2e22 2c20 2222  ub(".lravg.", ""
+0006c070: 2c6f 676c 6162 656c 6e61 6d65 290a 2020  ,oglabelname).  
+0006c080: 2020 2020 2020 2020 2020 2020 2020 6f67                og
+0006c090: 6c61 6265 6c6e 616d 6520 3d20 7265 2e73  labelname = re.s
+0006c0a0: 7562 2822 2e61 7379 6d2e 222c 2022 222c  ub(".asym.", "",
+0006c0b0: 6f67 6c61 6265 6c6e 616d 6529 0a0a 2020  oglabelname)..  
+0006c0c0: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+0006c0d0: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+0006c0e0: 2020 2020 2020 7072 696e 7428 226f 676c        print("ogl
+0006c0f0: 6162 656c 6e61 6d65 2022 202b 206f 676c  abelname " + ogl
+0006c100: 6162 656c 6e61 6d65 2029 0a0a 2020 2020  abelname )..    
+0006c110: 2020 2020 2020 2020 6966 206d 7965 7874          if myext
+0006c120: 203d 3d20 2763 6572 6562 656c 6c75 6d27   == 'cerebellum'
+0006c130: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0006c140: 2020 6966 206e 6f74 2061 746c 6173 4465    if not atlasDe
+0006c150: 7363 7269 7074 2e65 6d70 7479 2061 6e64  script.empty and
+0006c160: 2027 4465 7363 7269 7074 696f 6e27 2069   'Description' i
+0006c170: 6e20 6174 6c61 7344 6573 6372 6970 742e  n atlasDescript.
+0006c180: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
+0006c190: 2020 2020 2020 2020 2020 2020 2061 746c               atl
+0006c1a0: 6173 4465 7363 7269 7074 5b27 4465 7363  asDescript['Desc
+0006c1b0: 7269 7074 696f 6e27 5d20 3d20 6174 6c61  ription'] = atla
+0006c1c0: 7344 6573 6372 6970 745b 2744 6573 6372  sDescript['Descr
+0006c1d0: 6970 7469 6f6e 275d 2e73 7472 2e72 6570  iption'].str.rep
+0006c1e0: 6c61 6365 2822 6c5f 222c 2022 2229 0a20  lace("l_", ""). 
+0006c1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c200: 2020 2061 746c 6173 4465 7363 7269 7074     atlasDescript
+0006c210: 5b27 4465 7363 7269 7074 696f 6e27 5d20  ['Description'] 
+0006c220: 3d20 6174 6c61 7344 6573 6372 6970 745b  = atlasDescript[
+0006c230: 2744 6573 6372 6970 7469 6f6e 275d 2e73  'Description'].s
+0006c240: 7472 2e72 6570 6c61 6365 2822 725f 222c  tr.replace("r_",
+0006c250: 2022 2229 0a20 2020 2020 2020 2020 2020   "").           
+0006c260: 2020 2020 2020 2020 206f 676c 6162 656c           oglabel
+0006c270: 6e61 6d65 3d72 652e 7375 6228 2272 6176  name=re.sub("rav
+0006c280: 6722 2c22 222c 6f67 6c61 6265 6c6e 616d  g","",oglabelnam
+0006c290: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0006c2a0: 2020 2020 2020 206f 676c 6162 656c 6e61         oglabelna
+0006c2b0: 6d65 3d72 652e 7375 6228 226c 6176 6722  me=re.sub("lavg"
+0006c2c0: 2c22 222c 6f67 6c61 6265 6c6e 616d 6529  ,"",oglabelname)
+0006c2d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006c2e0: 2020 2020 2077 6869 6368 696e 6465 7820       whichindex 
+0006c2f0: 3d20 6174 6c61 7344 6573 6372 6970 742e  = atlasDescript.
+0006c300: 696e 6465 785b 6174 6c61 7344 6573 6372  index[atlasDescr
+0006c310: 6970 745b 2744 6573 6372 6970 7469 6f6e  ipt['Description
+0006c320: 275d 203d 3d20 6f67 6c61 6265 6c6e 616d  '] == oglabelnam
+0006c330: 655d 2e76 616c 7565 735b 305d 0a20 2020  e].values[0].   
+0006c340: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0006c350: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0006c360: 2020 2020 2020 2069 6620 6174 6c61 7344         if atlasD
+0006c370: 6573 6372 6970 742e 656d 7074 793a 0a20  escript.empty:. 
+0006c380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c390: 2020 2020 2020 2070 7269 6e74 2822 5468         print("Th
+0006c3a0: 6520 4461 7461 4672 616d 6520 2761 746c  e DataFrame 'atl
+0006c3b0: 6173 4465 7363 7269 7074 2720 6973 2065  asDescript' is e
+0006c3c0: 6d70 7479 2e22 290a 2020 2020 2020 2020  mpty.").        
+0006c3d0: 2020 2020 2020 2020 2020 2020 6966 2027              if '
+0006c3e0: 4465 7363 7269 7074 696f 6e27 206e 6f74  Description' not
+0006c3f0: 2069 6e20 6174 6c61 7344 6573 6372 6970   in atlasDescrip
+0006c400: 742e 636f 6c75 6d6e 733a 0a20 2020 2020  t.columns:.     
+0006c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c420: 2020 2070 7269 6e74 2822 5468 6520 636f     print("The co
+0006c430: 6c75 6d6e 2027 4465 7363 7269 7074 696f  lumn 'Descriptio
+0006c440: 6e27 2064 6f65 7320 6e6f 7420 6578 6973  n' does not exis
+0006c450: 7420 696e 2027 6174 6c61 7344 6573 6372  t in 'atlasDescr
+0006c460: 6970 7427 2e22 290a 2020 2020 2020 2020  ipt'.").        
+0006c470: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0006c480: 2020 2020 2020 2020 2020 7768 6963 6869            whichi
+0006c490: 6e64 6578 203d 2061 746c 6173 4465 7363  ndex = atlasDesc
+0006c4a0: 7269 7074 2e69 6e64 6578 5b61 746c 6173  ript.index[atlas
+0006c4b0: 4465 7363 7269 7074 5b27 4465 7363 7269  Descript['Descri
+0006c4c0: 7074 696f 6e27 5d2e 7374 722e 636f 6e74  ption'].str.cont
+0006c4d0: 6169 6e73 286f 676c 6162 656c 6e61 6d65  ains(oglabelname
+0006c4e0: 295d 0a0a 2020 2020 2020 2020 2020 2020  )]..            
+0006c4f0: 6966 2074 7970 6528 7768 6963 6869 6e64  if type(whichind
+0006c500: 6578 2920 6973 206e 702e 696e 7436 343a  ex) is np.int64:
+0006c510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006c520: 206c 6162 656c 6e75 6d73 203d 2061 746c   labelnums = atl
+0006c530: 6173 4465 7363 7269 7074 2e6c 6f63 5b77  asDescript.loc[w
+0006c540: 6869 6368 696e 6465 782c 2027 4c61 6265  hichindex, 'Labe
+0006c550: 6c27 5d0a 2020 2020 2020 2020 2020 2020  l'].            
+0006c560: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0006c570: 2020 2020 2020 6c61 6265 6c6e 756d 7320        labelnums 
+0006c580: 3d20 6c69 7374 2861 746c 6173 4465 7363  = list(atlasDesc
+0006c590: 7269 7074 2e6c 6f63 5b77 6869 6368 696e  ript.loc[whichin
+0006c5a0: 6465 782c 2027 4c61 6265 6c27 5d29 0a0a  dex, 'Label'])..
+0006c5b0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+0006c5c0: 7965 7874 203d 3d20 2779 656f 273a 0a20  yext == 'yeo':. 
+0006c5d0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0006c5e0: 6172 7473 203d 2072 652e 6669 6e64 616c  arts = re.findal
+0006c5f0: 6c28 7227 5c44 2b27 2c20 6f67 6c61 6265  l(r'\D+', oglabe
+0006c600: 6c6e 616d 6529 0a20 2020 2020 2020 2020  lname).         
+0006c610: 2020 2020 2020 206f 676c 6162 656c 6e61         oglabelna
+0006c620: 6d65 203d 205b 7061 7274 2e72 6570 6c61  me = [part.repla
+0006c630: 6365 2827 5f27 2c20 2727 2920 666f 7220  ce('_', '') for 
+0006c640: 7061 7274 2069 6e20 7061 7274 7320 6966  part in parts if
+0006c650: 2070 6172 742e 7265 706c 6163 6528 275f   part.replace('_
+0006c660: 272c 2027 2729 5d0a 2020 2020 2020 2020  ', '')].        
+0006c670: 2020 2020 2020 2020 6669 6c74 6572 6564          filtered
+0006c680: 5f64 6620 3d20 6174 6c61 7344 6573 6372  _df = atlasDescr
+0006c690: 6970 745b 6174 6c61 7344 6573 6372 6970  ipt[atlasDescrip
+0006c6a0: 745b 2744 6573 6372 6970 7469 6f6e 275d  t['Description']
+0006c6b0: 2e69 7369 6e28 6f67 6c61 6265 6c6e 616d  .isin(oglabelnam
+0006c6c0: 6529 5d0a 2020 2020 2020 2020 2020 2020  e)].            
+0006c6d0: 2020 2020 6c61 6265 6c6e 756d 7320 3d20      labelnums = 
+0006c6e0: 6669 6c74 6572 6564 5f64 665b 274c 6162  filtered_df['Lab
+0006c6f0: 656c 275d 2e74 6f6c 6973 7428 290a 0a20  el'].tolist().. 
+0006c700: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0006c710: 7420 6973 696e 7374 616e 6365 286c 6162  t isinstance(lab
+0006c720: 656c 6e75 6d73 2c20 6c69 7374 293a 0a20  elnums, list):. 
+0006c730: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0006c740: 6162 656c 6e75 6d73 3d5b 6c61 6265 6c6e  abelnums=[labeln
+0006c750: 756d 735d 0a20 2020 2020 2020 2020 2020  ums].           
+0006c760: 2061 6464 656d 6973 7a65 726f 203d 2061   addemiszero = a
+0006c770: 6e74 732e 7468 7265 7368 6f6c 645f 696d  nts.threshold_im
+0006c780: 6167 6528 6164 6465 6d2c 2030 2c20 3029  age(addem, 0, 0)
+0006c790: 0a20 2020 2020 2020 2020 2020 2074 656d  .            tem
+0006c7a0: 7020 3d20 616e 7473 2e69 6d61 6765 5f72  p = ants.image_r
+0006c7b0: 6561 6428 6c6f 6366 696c 656e 616d 6529  ead(locfilename)
+0006c7c0: 0a20 2020 2020 2020 2020 2020 2074 656d  .            tem
+0006c7d0: 7020 3d20 616e 7473 2e6d 6173 6b5f 696d  p = ants.mask_im
+0006c7e0: 6167 6528 7465 6d70 2c20 7465 6d70 2c20  age(temp, temp, 
+0006c7f0: 6c65 7665 6c3d 6c61 6265 6c6e 756d 732c  level=labelnums,
+0006c800: 2062 696e 6172 697a 653d 5472 7565 290a   binarize=True).
+0006c810: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+0006c820: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+0006c830: 2020 2020 2020 2020 7072 696e 7428 2244          print("D
+0006c840: 4542 5547 2229 0a20 2020 2020 2020 2020  EBUG").         
+0006c850: 2020 2020 2020 2070 7269 6e74 2820 2074         print(  t
+0006c860: 656d 702e 7375 6d28 2920 2920 0a20 2020  emp.sum() ) .   
+0006c870: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0006c880: 6e74 2820 6c61 6265 6c6e 756d 7320 290a  nt( labelnums ).
+0006c890: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
+0006c8a0: 5b74 656d 7020 3d3d 2031 5d20 3d20 2876  [temp == 1] = (v
+0006c8b0: 616c 7332 7669 7a29 0a20 2020 2020 2020  als2viz).       
+0006c8c0: 2020 2020 2074 656d 705b 6164 6465 6d69       temp[addemi
+0006c8d0: 737a 6572 6f20 3d3d 2030 5d20 3d20 300a  szero == 0] = 0.
+0006c8e0: 2020 2020 2020 2020 2020 2020 6164 6465              adde
+0006c8f0: 6d20 3d20 6164 6465 6d20 2b20 7465 6d70  m = addem + temp
+0006c900: 0a0a 2020 2020 2020 2020 6966 2076 6572  ..        if ver
+0006c910: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+0006c920: 2020 7072 696e 7428 2744 6f6e 6520 4164    print('Done Ad
+0006c930: 6469 6e67 2729 0a20 2020 2020 2020 2066  ding').        f
+0006c940: 6f72 2061 7878 2069 6e20 6178 6573 3a0a  or axx in axes:.
+0006c950: 2020 2020 2020 2020 2020 2020 6669 6766              figf
+0006c960: 6e3d 6f75 7470 7574 5f70 7265 6669 782b  n=output_prefix+
+0006c970: 6622 6669 677b 636f 6c32 7669 7a7d 6178  f"fig{col2viz}ax
+0006c980: 7b61 7878 7d5f 7079 2e6a 7067 220a 2020  {axx}_py.jpg".  
+0006c990: 2020 2020 2020 2020 2020 6966 2063 726f            if cro
+0006c9a0: 7020 3e20 303a 0a20 2020 2020 2020 2020  p > 0:.         
+0006c9b0: 2020 2020 2020 2063 6d61 736b 203d 2061         cmask = a
+0006c9c0: 6e74 732e 7468 7265 7368 6f6c 645f 696d  nts.threshold_im
+0006c9d0: 6167 6528 2061 6464 656d 2c31 652d 352c  age( addem,1e-5,
+0006c9e0: 2031 6539 2029 2e69 4d61 7468 2822 4d44   1e9 ).iMath("MD
+0006c9f0: 222c 6372 6f70 2920 2b20 616e 7473 2e74  ",crop) + ants.t
+0006ca00: 6872 6573 686f 6c64 5f69 6d61 6765 2820  hreshold_image( 
+0006ca10: 6164 6465 6d2c 2d31 6539 2c20 2d31 652d  addem,-1e9, -1e-
+0006ca20: 3520 292e 694d 6174 6828 224d 4422 2c63  5 ).iMath("MD",c
+0006ca30: 726f 7029 0a20 2020 2020 2020 2020 2020  rop).           
+0006ca40: 2020 2020 2061 6464 656d 4320 3d20 616e       addemC = an
+0006ca50: 7473 2e63 726f 705f 696d 6167 6528 2061  ts.crop_image( a
+0006ca60: 6464 656d 2c20 636d 6173 6b20 290a 2020  ddem, cmask ).  
+0006ca70: 2020 2020 2020 2020 2020 2020 2020 6564                ed
+0006ca80: 6765 696d 6743 203d 2061 6e74 732e 6372  geimgC = ants.cr
+0006ca90: 6f70 5f69 6d61 6765 2820 6564 6765 696d  op_image( edgeim
+0006caa0: 672c 2063 6d61 736b 2029 0a20 2020 2020  g, cmask ).     
+0006cab0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0006cac0: 2020 2020 2020 2020 2020 2020 2061 6464               add
+0006cad0: 656d 4320 3d20 6164 6465 6d0a 2020 2020  emC = addem.    
+0006cae0: 2020 2020 2020 2020 2020 2020 6564 6765              edge
+0006caf0: 696d 6743 203d 2065 6467 6569 6d67 0a20  imgC = edgeimg. 
+0006cb00: 2020 2020 2020 2020 2020 2069 6620 6669             if fi
+0006cb10: 7865 645f 6f76 6572 6c61 795f 7261 6e67  xed_overlay_rang
+0006cb20: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
+0006cb30: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0006cb40: 6464 656d 435b 303a 332c 303a 332c 303a  ddemC[0:3,0:3,0:
+0006cb50: 335d 3d66 6978 6564 5f6f 7665 726c 6179  3]=fixed_overlay
+0006cb60: 5f72 616e 6765 5b30 5d0a 2020 2020 2020  _range[0].      
+0006cb70: 2020 2020 2020 2020 2020 6164 6465 6d43            addemC
+0006cb80: 5b34 3a37 2c34 3a37 2c34 3a37 5d3d 6669  [4:7,4:7,4:7]=fi
+0006cb90: 7865 645f 6f76 6572 6c61 795f 7261 6e67  xed_overlay_rang
+0006cba0: 655b 315d 0a20 2020 2020 2020 2020 2020  e[1].           
+0006cbb0: 2020 2020 2061 6464 656d 435b 2061 6464       addemC[ add
+0006cbc0: 656d 4320 3c3d 2066 6978 6564 5f6f 7665  emC <= fixed_ove
+0006cbd0: 726c 6179 5f72 616e 6765 5b30 5d20 5d20  rlay_range[0] ] 
+0006cbe0: 3d20 3020 2320 6669 7865 645f 6f76 6572  = 0 # fixed_over
+0006cbf0: 6c61 795f 7261 6e67 655b 305d 0a20 2020  lay_range[0].   
+0006cc00: 2020 2020 2020 2020 2020 2020 2061 6464               add
+0006cc10: 656d 435b 2061 6464 656d 4320 3e3d 2066  emC[ addemC >= f
+0006cc20: 6978 6564 5f6f 7665 726c 6179 5f72 616e  ixed_overlay_ran
+0006cc30: 6765 5b31 5d20 5d20 3d20 6669 7865 645f  ge[1] ] = fixed_
+0006cc40: 6f76 6572 6c61 795f 7261 6e67 655b 315d  overlay_range[1]
+0006cc50: 0a20 2020 2020 2020 2020 2020 2061 6e74  .            ant
+0006cc60: 732e 706c 6f74 2865 6467 6569 6d67 432c  s.plot(edgeimgC,
+0006cc70: 2061 6464 656d 432c 2061 7869 733d 6178   addemC, axis=ax
+0006cc80: 782c 206e 736c 6963 6573 3d6e 736c 6963  x, nslices=nslic
+0006cc90: 6573 2c20 6e63 6f6c 3d6e 636f 6c2c 2020  es, ncol=ncol,  
+0006cca0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+0006ccb0: 2020 2020 2020 6f76 6572 6c61 795f 636d        overlay_cm
+0006ccc0: 6170 3d6f 7665 726c 6179 5f63 6d61 702c  ap=overlay_cmap,
+0006ccd0: 2072 6573 616d 706c 653d 4661 6c73 652c   resample=False,
+0006cce0: 206f 7665 726c 6179 5f61 6c70 6861 3d31   overlay_alpha=1
+0006ccf0: 2e30 2c0a 2020 2020 2020 2020 2020 2020  .0,.            
+0006cd00: 2020 2020 6669 6c65 6e61 6d65 3d66 6967      filename=fig
+0006cd10: 666e 2c20 6362 6172 3d61 7878 3d3d 6178  fn, cbar=axx==ax
+0006cd20: 6573 5b30 5d2c 2063 726f 703d 5472 7565  es[0], crop=True
+0006cd30: 2c20 626c 6163 6b5f 6267 3d62 6c61 636b  , black_bg=black
+0006cd40: 5f62 6720 290a 2020 2020 2020 2020 6966  _bg ).        if
+0006cd50: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+0006cd60: 2020 2020 2020 7072 696e 7428 6622 7b63        print(f"{c
+0006cd70: 6f6c 3276 697a 7d20 646f 6e65 2229 0a20  ol2viz} done"). 
+0006cd80: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
+0006cd90: 2020 2020 2020 2070 7269 6e74 2822 444f         print("DO
+0006cda0: 4e45 2062 7261 696e 206d 6170 2066 6967  NE brain map fig
+0006cdb0: 7572 6573 2229 0a20 2020 2072 6574 7572  ures").    retur
+0006cdc0: 6e20 6164 6465 6d0a 0a64 6566 2066 696c  n addem..def fil
+0006cdd0: 7465 725f 6466 2869 6e64 662c 206d 7970  ter_df(indf, myp
+0006cde0: 7265 6669 7829 3a0a 2020 2020 2222 220a  refix):.    """.
+0006cdf0: 2020 2020 5072 6f63 6573 7320 616e 6420      Process and 
+0006ce00: 6669 6c74 6572 2061 2070 616e 6461 7320  filter a pandas 
+0006ce10: 4461 7461 4672 616d 652c 2072 656d 6f76  DataFrame, remov
+0006ce20: 696e 6720 6365 7274 6169 6e20 636f 6c75  ing certain colu
+0006ce30: 6d6e 732c 200a 2020 2020 6669 6c74 6572  mns, .    filter
+0006ce40: 696e 6720 6261 7365 6420 6f6e 2064 6174  ing based on dat
+0006ce50: 6120 7479 7065 732c 2063 6f6d 7075 7469  a types, computi
+0006ce60: 6e67 2074 6865 206d 6561 6e20 6f66 206e  ng the mean of n
+0006ce70: 756d 6572 6963 2063 6f6c 756d 6e73 2c20  umeric columns, 
+0006ce80: 0a20 2020 2061 6e64 2061 6464 696e 6720  .    and adding 
+0006ce90: 6120 7072 6566 6978 2074 6f20 636f 6c75  a prefix to colu
+0006cea0: 6d6e 206e 616d 6573 2e0a 0a20 2020 2050  mn names...    P
+0006ceb0: 6172 616d 6574 6572 733a 0a20 2020 2069  arameters:.    i
+0006cec0: 6e64 6620 2870 616e 6461 732e 4461 7461  ndf (pandas.Data
+0006ced0: 4672 616d 6529 3a20 5468 6520 696e 7075  Frame): The inpu
+0006cee0: 7420 4461 7461 4672 616d 6520 746f 2062  t DataFrame to b
+0006cef0: 6520 7072 6f63 6573 7365 642e 0a20 2020  e processed..   
+0006cf00: 206d 7970 7265 6669 7820 2873 7472 293a   myprefix (str):
+0006cf10: 2041 2073 7472 696e 6720 7072 6566 6978   A string prefix
+0006cf20: 2074 6f20 6265 2061 6464 6564 2074 6f20   to be added to 
+0006cf30: 7468 6520 636f 6c75 6d6e 206e 616d 6573  the column names
+0006cf40: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+0006cf50: 2020 2020 2020 6f66 2074 6865 2070 726f        of the pro
+0006cf60: 6365 7373 6564 2044 6174 6146 7261 6d65  cessed DataFrame
+0006cf70: 2e0a 0a20 2020 2053 7465 7073 3a0a 2020  ...    Steps:.  
+0006cf80: 2020 312e 2052 656d 6f76 6573 2063 6f6c    1. Removes col
+0006cf90: 756d 6e73 2077 6974 6820 6e61 6d65 7320  umns with names 
+0006cfa0: 636f 6e74 6169 6e69 6e67 2027 556e 6e61  containing 'Unna
+0006cfb0: 6d65 6427 2e0a 2020 2020 322e 2049 6620  med'..    2. If 
+0006cfc0: 7468 6520 4461 7461 4672 616d 6520 6861  the DataFrame ha
+0006cfd0: 7320 6e6f 2072 6f77 732c 2069 7420 7265  s no rows, it re
+0006cfe0: 7475 726e 7320 7468 6520 656d 7074 7920  turns the empty 
+0006cff0: 4461 7461 4672 616d 652e 0a20 2020 2033  DataFrame..    3
+0006d000: 2e20 4669 6c74 6572 7320 6f75 7420 636f  . Filters out co
+0006d010: 6c75 6d6e 7320 6261 7365 6420 6f6e 2074  lumns based on t
+0006d020: 6865 2074 7970 6520 6f66 2074 6865 2066  he type of the f
+0006d030: 6972 7374 2065 6c65 6d65 6e74 2c20 0a20  irst element, . 
+0006d040: 2020 2020 2020 6b65 6570 696e 6720 7468        keeping th
+0006d050: 6f73 6520 7468 6174 2061 7265 206f 6620  ose that are of 
+0006d060: 7479 7065 2060 6f62 6a65 6374 602c 2060  type `object`, `
+0006d070: 696e 7460 2c20 6f72 2060 666c 6f61 7460  int`, or `float`
+0006d080: 2e0a 2020 2020 342e 2052 656d 6f76 6573  ..    4. Removes
+0006d090: 2063 6f6c 756d 6e73 2074 6861 7420 6172   columns that ar
+0006d0a0: 6520 6f66 2060 6f62 6a65 6374 6020 6474  e of `object` dt
+0006d0b0: 7970 652e 0a20 2020 2035 2e20 4361 6c63  ype..    5. Calc
+0006d0c0: 756c 6174 6573 2074 6865 206d 6561 6e20  ulates the mean 
+0006d0d0: 6f66 2074 6865 2072 656d 6169 6e69 6e67  of the remaining
+0006d0e0: 2063 6f6c 756d 6e73 2c20 736b 6970 7069   columns, skippi
+0006d0f0: 6e67 204e 614e 2076 616c 7565 732e 0a20  ng NaN values.. 
+0006d100: 2020 2036 2e20 4164 6473 2074 6865 2073     6. Adds the s
+0006d110: 7065 6369 6669 6564 2060 6d79 7072 6566  pecified `mypref
+0006d120: 6978 6020 746f 2074 6865 2063 6f6c 756d  ix` to the colum
+0006d130: 6e20 6e61 6d65 732e 0a0a 2020 2020 5265  n names...    Re
+0006d140: 7475 726e 733a 0a20 2020 2070 616e 6461  turns:.    panda
+0006d150: 732e 4461 7461 4672 616d 653a 2041 2074  s.DataFrame: A t
+0006d160: 7261 6e73 666f 726d 6564 2044 6174 6146  ransformed DataF
+0006d170: 7261 6d65 2077 6974 6820 6120 7369 6e67  rame with a sing
+0006d180: 6c65 2072 6f77 2063 6f6e 7461 696e 696e  le row containin
+0006d190: 6720 0a20 2020 2020 2020 2020 2020 2020  g .             
+0006d1a0: 2020 2020 2020 2020 2074 6865 206d 6561           the mea
+0006d1b0: 6e20 7661 6c75 6573 206f 6620 7468 6520  n values of the 
+0006d1c0: 6669 6c74 6572 6564 2063 6f6c 756d 6e73  filtered columns
+0006d1d0: 2c20 616e 6420 7769 7468 200a 2020 2020  , and with .    
+0006d1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d1f0: 2020 636f 6c75 6d6e 206e 616d 6573 2070    column names p
+0006d200: 7265 6669 7865 6420 6173 2073 7065 6369  refixed as speci
+0006d210: 6669 6564 2e0a 2020 2020 2222 220a 2020  fied..    """.  
+0006d220: 2020 696e 6466 203d 2069 6e64 662e 6c6f    indf = indf.lo
+0006d230: 635b 3a2c 207e 696e 6466 2e63 6f6c 756d  c[:, ~indf.colum
+0006d240: 6e73 2e73 7472 2e63 6f6e 7461 696e 7328  ns.str.contains(
+0006d250: 2755 6e6e 616d 6564 2a27 2c20 6e61 3d46  'Unnamed*', na=F
+0006d260: 616c 7365 2c20 7265 6765 783d 5472 7565  alse, regex=True
+0006d270: 295d 0a20 2020 2069 6620 696e 6466 2e73  )].    if indf.s
+0006d280: 6861 7065 5b30 5d20 3d3d 2030 3a0a 2020  hape[0] == 0:.  
+0006d290: 2020 2020 2020 7265 7475 726e 2069 6e64        return ind
+0006d2a0: 660a 2020 2020 6e75 6d73 203d 205b 6973  f.    nums = [is
+0006d2b0: 696e 7374 616e 6365 2869 6e64 665b 636f  instance(indf[co
+0006d2c0: 6c5d 2e69 6c6f 635b 305d 2c20 286f 626a  l].iloc[0], (obj
+0006d2d0: 6563 742c 2069 6e74 2c20 666c 6f61 7429  ect, int, float)
+0006d2e0: 2920 666f 7220 636f 6c20 696e 2069 6e64  ) for col in ind
+0006d2f0: 662e 636f 6c75 6d6e 735d 0a20 2020 2069  f.columns].    i
+0006d300: 6e64 6620 3d20 696e 6466 2e6c 6f63 5b3a  ndf = indf.loc[:
+0006d310: 2c20 6e75 6d73 5d0a 2020 2020 696e 6466  , nums].    indf
+0006d320: 203d 2069 6e64 662e 6c6f 635b 3a2c 2069   = indf.loc[:, i
+0006d330: 6e64 662e 6474 7970 6573 2021 3d20 276f  ndf.dtypes != 'o
+0006d340: 626a 6563 7427 5d0a 2020 2020 696e 6466  bject'].    indf
+0006d350: 203d 2070 642e 4461 7461 4672 616d 6528   = pd.DataFrame(
+0006d360: 696e 6466 2e6d 6561 6e28 6178 6973 3d30  indf.mean(axis=0
+0006d370: 2c20 736b 6970 6e61 3d54 7275 6529 292e  , skipna=True)).
+0006d380: 540a 2020 2020 696e 6466 203d 2069 6e64  T.    indf = ind
+0006d390: 662e 6164 645f 7072 6566 6978 286d 7970  f.add_prefix(myp
+0006d3a0: 7265 6669 7829 0a20 2020 2072 6574 7572  refix).    retur
+0006d3b0: 6e20 696e 6466 0a0a 0a64 6566 2061 6767  n indf...def agg
+0006d3c0: 7265 6761 7465 5f61 6e74 7370 796d 6d5f  regate_antspymm_
+0006d3d0: 7265 7375 6c74 7328 696e 7075 745f 6373  results(input_cs
+0006d3e0: 762c 2073 7562 6a65 6374 5f63 6f6c 3d27  v, subject_col='
+0006d3f0: 7375 626a 6563 7449 4427 2c20 6461 7465  subjectID', date
+0006d400: 5f63 6f6c 3d27 6461 7465 272c 2069 6d61  _col='date', ima
+0006d410: 6765 5f63 6f6c 3d27 696d 6167 6549 4427  ge_col='imageID'
+0006d420: 2c20 6461 7465 5f63 6f6c 756d 6e3d 2773  , date_column='s
+0006d430: 6573 2d31 272c 2062 6173 655f 7061 7468  es-1', base_path
+0006d440: 3d22 2e2f 5072 6f63 6573 7365 642f 414e  ="./Processed/AN
+0006d450: 5473 4578 7041 7274 2f22 2c20 6869 6572  TsExpArt/", hier
+0006d460: 7661 7269 6162 6c65 3d27 5431 7748 6965  variable='T1wHie
+0006d470: 7261 7263 6869 6361 6c27 2c20 7661 6c69  rarchical', vali
+0006d480: 645f 6d6f 6461 6c69 7469 6573 3d4e 6f6e  d_modalities=Non
+0006d490: 652c 2076 6572 626f 7365 3d46 616c 7365  e, verbose=False
+0006d4a0: 2029 3a0a 2020 2020 2222 220a 2020 2020   ):.    """.    
+0006d4b0: 4167 6772 6567 6174 6520 414e 5473 5079  Aggregate ANTsPy
+0006d4c0: 4d4d 2072 6573 756c 7473 2066 726f 6d20  MM results from 
+0006d4d0: 7468 6520 7370 6563 6966 6965 6420 4353  the specified CS
+0006d4e0: 5620 6669 6c65 2061 6e64 2073 6176 6520  V file and save 
+0006d4f0: 7468 6520 6167 6772 6567 6174 6564 2072  the aggregated r
+0006d500: 6573 756c 7473 2074 6f20 6120 6e65 7720  esults to a new 
+0006d510: 4353 5620 6669 6c65 2e0a 0a20 2020 2050  CSV file...    P
+0006d520: 6172 616d 6574 6572 733a 0a20 2020 202d  arameters:.    -
+0006d530: 2069 6e70 7574 5f63 7376 2028 7374 7229   input_csv (str)
+0006d540: 3a20 4669 6c65 2070 6174 6820 6f66 2074  : File path of t
+0006d550: 6865 2069 6e70 7574 2043 5356 2066 696c  he input CSV fil
+0006d560: 6520 636f 6e74 6169 6e69 6e67 2041 4e54  e containing ANT
+0006d570: 7350 794d 4d20 5143 2072 6573 756c 7473  sPyMM QC results
+0006d580: 2061 7665 7261 6765 6420 616e 6420 7769   averaged and wi
+0006d590: 7468 206f 7574 6c69 6572 206d 6561 7375  th outlier measu
+0006d5a0: 7265 6d65 6e74 732e 0a20 2020 202d 2073  rements..    - s
+0006d5b0: 7562 6a65 6374 5f63 6f6c 2028 7374 7229  ubject_col (str)
+0006d5c0: 3a20 4e61 6d65 206f 6620 7468 6520 636f  : Name of the co
+0006d5d0: 6c75 6d6e 2074 6f20 7374 6f72 6520 7375  lumn to store su
+0006d5e0: 626a 6563 7420 4944 732e 0a20 2020 202d  bject IDs..    -
+0006d5f0: 2064 6174 655f 636f 6c20 2873 7472 293a   date_col (str):
+0006d600: 204e 616d 6520 6f66 2074 6865 2063 6f6c   Name of the col
+0006d610: 756d 6e20 746f 2073 746f 7265 2064 6174  umn to store dat
+0006d620: 6520 696e 666f 726d 6174 696f 6e2e 0a20  e information.. 
+0006d630: 2020 202d 2069 6d61 6765 5f63 6f6c 2028     - image_col (
+0006d640: 7374 7229 3a20 4e61 6d65 206f 6620 7468  str): Name of th
+0006d650: 6520 636f 6c75 6d6e 2074 6f20 7374 6f72  e column to stor
+0006d660: 6520 696d 6167 6520 4944 732e 0a20 2020  e image IDs..   
+0006d670: 202d 2064 6174 655f 636f 6c75 6d6e 2028   - date_column (
+0006d680: 7374 7229 3a20 4e61 6d65 206f 6620 7468  str): Name of th
+0006d690: 6520 636f 6c75 6d6e 2072 6570 7265 7365  e column represe
+0006d6a0: 6e74 696e 6720 7468 6520 6461 7465 2069  nting the date i
+0006d6b0: 6e66 6f72 6d61 7469 6f6e 2e0a 2020 2020  nformation..    
+0006d6c0: 2d20 6261 7365 5f70 6174 6820 2873 7472  - base_path (str
+0006d6d0: 293a 2042 6173 6520 7061 7468 2066 6f72  ): Base path for
+0006d6e0: 2073 6561 7263 6820 7061 7468 732e 2044   search paths. D
+0006d6f0: 6566 6175 6c74 7320 746f 2022 2e2f 5072  efaults to "./Pr
+0006d700: 6f63 6573 7365 642f 414e 5473 4578 7041  ocessed/ANTsExpA
+0006d710: 7274 2f22 2e0a 2020 2020 2d20 6869 6572  rt/"..    - hier
+0006d720: 7661 7269 6162 6c65 2028 7374 7229 203a  variable (str) :
+0006d730: 2074 6865 2073 7472 696e 6720 7661 7269   the string vari
+0006d740: 6162 6c65 2064 656e 6f74 696e 6720 7468  able denoting th
+0006d750: 6520 4869 6572 6172 6368 6963 616c 206f  e Hierarchical o
+0006d760: 7574 7075 740a 2020 2020 2d20 7661 6c69  utput.    - vali
+0006d770: 645f 6d6f 6461 6c69 7469 6573 2028 7374  d_modalities (st
+0006d780: 7220 6172 7261 7929 203a 2069 6465 6e74  r array) : ident
+0006d790: 6966 6965 7320 666f 7220 6561 6368 206d  ifies for each m
+0006d7a0: 6f64 616c 6974 793b 2069 6620 4e6f 6e65  odality; if None
+0006d7b0: 2077 696c 6c20 6265 2072 6570 6c61 6365   will be replace
+0006d7c0: 6420 6279 2067 6574 5f76 616c 6964 5f6d  d by get_valid_m
+0006d7d0: 6f64 616c 6974 6965 7328 6c6f 6e67 3d54  odalities(long=T
+0006d7e0: 7275 6529 0a20 2020 202d 2076 6572 626f  rue).    - verbo
+0006d7f0: 7365 203a 2062 6f6f 6c65 616e 0a0a 2020  se : boolean..  
+0006d800: 2020 4e6f 7465 3a0a 2020 2020 5468 6973    Note:.    This
+0006d810: 2066 756e 6374 696f 6e20 6973 2074 6573   function is tes
+0006d820: 7465 6420 756e 6465 7220 6c69 6d69 7465  ted under limite
+0006d830: 6420 6369 7263 756d 7374 616e 6365 732e  d circumstances.
+0006d840: 2055 7365 2077 6974 6820 6361 7574 696f   Use with cautio
+0006d850: 6e2e 0a0a 2020 2020 4578 616d 706c 6520  n...    Example 
+0006d860: 7573 6167 653a 0a20 2020 2061 6767 5f64  usage:.    agg_d
+0006d870: 6620 3d20 6167 6772 6567 6174 655f 616e  f = aggregate_an
+0006d880: 7473 7079 6d6d 5f72 6573 756c 7473 2822  tspymm_results("
+0006d890: 7163 6466 616f 6c2e 6373 7622 2c20 7375  qcdfaol.csv", su
+0006d8a0: 626a 6563 745f 636f 6c3d 2773 7562 6a65  bject_col='subje
+0006d8b0: 6374 4944 272c 2064 6174 655f 636f 6c3d  ctID', date_col=
+0006d8c0: 2764 6174 6527 2c20 696d 6167 655f 636f  'date', image_co
+0006d8d0: 6c3d 2769 6d61 6765 4944 272c 2064 6174  l='imageID', dat
+0006d8e0: 655f 636f 6c75 6d6e 3d27 7365 732d 3127  e_column='ses-1'
+0006d8f0: 2c20 6261 7365 5f70 6174 683d 222e 2f59  , base_path="./Y
+0006d900: 6f75 722f 4375 7374 6f6d 2f50 6174 682f  our/Custom/Path/
+0006d910: 2229 0a0a 2020 2020 4175 7468 6f72 3a0a  ")..    Author:.
+0006d920: 2020 2020 4176 616e 7473 2061 6e64 2043      Avants and C
+0006d930: 6861 7447 5054 0a20 2020 2022 2222 0a20  hatGPT.    """. 
+0006d940: 2020 2069 6d70 6f72 7420 7061 6e64 6173     import pandas
+0006d950: 2061 7320 7064 0a20 2020 2069 6d70 6f72   as pd.    impor
+0006d960: 7420 6e75 6d70 7920 6173 206e 700a 2020  t numpy as np.  
+0006d970: 2020 6672 6f6d 2067 6c6f 6220 696d 706f    from glob impo
+0006d980: 7274 2067 6c6f 620a 0a20 2020 2064 6566  rt glob..    def
+0006d990: 206d 7972 6561 645f 6373 7628 782c 2063   myread_csv(x, c
+0006d9a0: 6e6d 7329 3a0a 2020 2020 2020 2020 2222  nms):.        ""
+0006d9b0: 220a 2020 2020 2020 2020 5265 6164 7320  ".        Reads 
+0006d9c0: 6120 4353 5620 6669 6c65 2061 6e64 2072  a CSV file and r
+0006d9d0: 6574 7572 6e73 2061 2044 6174 6146 7261  eturns a DataFra
+0006d9e0: 6d65 2065 7863 6c75 6469 6e67 2073 7065  me excluding spe
+0006d9f0: 6369 6669 6564 2063 6f6c 756d 6e73 2e0a  cified columns..
+0006da00: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
+0006da10: 6572 733a 0a20 2020 2020 2020 202d 2078  ers:.        - x
+0006da20: 2028 7374 7229 3a20 4669 6c65 2070 6174   (str): File pat
+0006da30: 6820 6f66 2074 6865 2069 6e70 7574 2043  h of the input C
+0006da40: 5356 2066 696c 6520 6465 7363 7269 6269  SV file describi
+0006da50: 6e67 2074 6865 2062 6c69 6e64 2051 4320  ng the blind QC 
+0006da60: 6f75 7470 7574 0a20 2020 2020 2020 202d  output.        -
+0006da70: 2063 6e6d 7320 286c 6973 7429 3a20 4c69   cnms (list): Li
+0006da80: 7374 206f 6620 636f 6c75 6d6e 206e 616d  st of column nam
+0006da90: 6573 2074 6f20 6578 636c 7564 6520 6672  es to exclude fr
+0006daa0: 6f6d 2074 6865 2044 6174 6146 7261 6d65  om the DataFrame
+0006dab0: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
+0006dac0: 6e73 3a0a 2020 2020 2020 2020 7064 2e44  ns:.        pd.D
+0006dad0: 6174 6146 7261 6d65 3a20 4461 7461 4672  ataFrame: DataFr
+0006dae0: 616d 6520 7769 7468 2073 7065 6369 6669  ame with specifi
+0006daf0: 6564 2063 6f6c 756d 6e73 2065 7863 6c75  ed columns exclu
+0006db00: 6465 642e 0a20 2020 2020 2020 2022 2222  ded..        """
+0006db10: 0a20 2020 2020 2020 2064 6620 3d20 7064  .        df = pd
+0006db20: 2e72 6561 645f 6373 7628 7829 0a20 2020  .read_csv(x).   
+0006db30: 2020 2020 2072 6574 7572 6e20 6466 2e6c       return df.l
+0006db40: 6f63 5b3a 2c20 7e64 662e 636f 6c75 6d6e  oc[:, ~df.column
+0006db50: 732e 6973 696e 2863 6e6d 7329 5d0a 0a20  s.isin(cnms)].. 
+0006db60: 2020 2069 6d70 6f72 7420 7761 726e 696e     import warnin
+0006db70: 6773 0a20 2020 2023 2057 6172 6e69 6e67  gs.    # Warning
+0006db80: 206d 6573 7361 6765 2066 6f72 2075 6e74   message for unt
+0006db90: 6573 7465 6420 6675 6e63 7469 6f6e 0a20  ested function. 
+0006dba0: 2020 2077 6172 6e69 6e67 732e 7761 726e     warnings.warn
+0006dbb0: 2822 5761 726e 696e 673a 2054 6869 7320  ("Warning: This 
+0006dbc0: 6675 6e63 7469 6f6e 2069 7320 6e6f 7420  function is not 
+0006dbd0: 7765 6c6c 2074 6573 7465 642e 2055 7365  well tested. Use
+0006dbe0: 2077 6974 6820 6361 7574 696f 6e2e 2229   with caution.")
+0006dbf0: 0a0a 2020 2020 6966 2076 616c 6964 5f6d  ..    if valid_m
+0006dc00: 6f64 616c 6974 6965 7320 6973 204e 6f6e  odalities is Non
+0006dc10: 653a 0a20 2020 2020 2020 2076 616c 6964  e:.        valid
+0006dc20: 5f6d 6f64 616c 6974 6965 7320 3d20 6765  _modalities = ge
+0006dc30: 745f 7661 6c69 645f 6d6f 6461 6c69 7469  t_valid_modaliti
+0006dc40: 6573 2827 6c6f 6e67 2729 0a0a 2020 2020  es('long')..    
+0006dc50: 2320 5265 6164 2074 6865 2069 6e70 7574  # Read the input
+0006dc60: 2043 5356 2066 696c 650a 2020 2020 6466   CSV file.    df
+0006dc70: 203d 2070 642e 7265 6164 5f63 7376 2869   = pd.read_csv(i
+0006dc80: 6e70 7574 5f63 7376 290a 0a20 2020 2023  nput_csv)..    #
+0006dc90: 2046 696c 7465 7220 726f 7773 2077 6865   Filter rows whe
+0006dca0: 7265 206d 6f64 616c 6974 7920 6973 2027  re modality is '
+0006dcb0: 5431 7727 0a20 2020 2064 6620 3d20 6466  T1w'.    df = df
+0006dcc0: 5b64 665b 276d 6f64 616c 6974 7927 5d20  [df['modality'] 
+0006dcd0: 3d3d 2027 5431 7727 5d0a 2020 2020 6261  == 'T1w'].    ba
+0006dce0: 646e 616d 6573 203d 2067 6574 5f6e 616d  dnames = get_nam
+0006dcf0: 6573 5f66 726f 6d5f 6461 7461 5f66 7261  es_from_data_fra
+0006dd00: 6d65 2820 5b27 556e 6e61 6d65 6427 5d2c  me( ['Unnamed'],
+0006dd10: 2064 6620 290a 2020 2020 6466 3d64 662e   df ).    df=df.
+0006dd20: 6472 6f70 2862 6164 6e61 6d65 732c 2061  drop(badnames, a
+0006dd30: 7869 733d 3129 0a0a 2020 2020 2320 4164  xis=1)..    # Ad
+0006dd40: 6420 6e65 7720 636f 6c75 6d6e 7320 666f  d new columns fo
+0006dd50: 7220 7375 626a 6563 7420 4944 2c20 6461  r subject ID, da
+0006dd60: 7465 2c20 616e 6420 696d 6167 6520 4944  te, and image ID
+0006dd70: 0a20 2020 2064 665b 7375 626a 6563 745f  .    df[subject_
+0006dd80: 636f 6c5d 203d 206e 702e 6e61 6e0a 2020  col] = np.nan.  
+0006dd90: 2020 6466 5b64 6174 655f 636f 6c5d 203d    df[date_col] =
+0006dda0: 2064 6174 655f 636f 6c75 6d6e 0a20 2020   date_column.   
+0006ddb0: 2064 665b 696d 6167 655f 636f 6c5d 203d   df[image_col] =
+0006ddc0: 206e 702e 6e61 6e0a 2020 2020 6466 203d   np.nan.    df =
+0006ddd0: 2064 662e 6173 7479 7065 287b 7375 626a   df.astype({subj
+0006dde0: 6563 745f 636f 6c3a 2073 7472 2c20 6461  ect_col: str, da
+0006ddf0: 7465 5f63 6f6c 3a20 7374 722c 2069 6d61  te_col: str, ima
+0006de00: 6765 5f63 6f6c 3a20 7374 7220 7d29 0a0a  ge_col: str })..
+0006de10: 2320 2020 2069 6620 7665 7262 6f73 653a  #    if verbose:
+0006de20: 0a23 2020 2020 2020 2020 7072 696e 7428  .#        print(
+0006de30: 2064 662e 7368 6170 6520 290a 2320 2020   df.shape ).#   
+0006de40: 2020 2020 2070 7269 6e74 2820 6466 2e64       print( df.d
+0006de50: 7479 7065 7320 290a 0a20 2020 2023 2070  types )..    # p
+0006de60: 7265 6669 6c74 6572 2064 6620 666f 7220  refilter df for 
+0006de70: 6461 7461 2074 6861 7420 6578 6973 7473  data that exists
+0006de80: 0a20 2020 206b 6565 7020 3d20 6e70 2e74  .    keep = np.t
+0006de90: 696c 6528 2046 616c 7365 2c20 6466 2e73  ile( False, df.s
+0006dea0: 6861 7065 5b30 5d20 290a 2020 2020 666f  hape[0] ).    fo
+0006deb0: 7220 7820 696e 2072 616e 6765 2864 662e  r x in range(df.
+0006dec0: 7368 6170 655b 305d 293a 0a20 2020 2020  shape[0]):.     
+0006ded0: 2020 2074 656d 7020 3d20 6466 5b27 6669     temp = df['fi
+0006dee0: 6c65 6e61 6d65 275d 2e69 6c6f 635b 785d  lename'].iloc[x]
+0006def0: 2e73 706c 6974 2822 5f22 290a 2020 2020  .split("_").    
+0006df00: 2020 2020 2320 4765 6e65 7261 6c69 7a65      # Generalize
+0006df10: 6420 7365 6172 6368 2070 6174 6873 0a20  d search paths. 
+0006df20: 2020 2020 2020 2070 6174 685f 7465 6d70         path_temp
+0006df30: 6c61 7465 203d 2066 227b 6261 7365 5f70  late = f"{base_p
+0006df40: 6174 687d 7b74 656d 705b 305d 7d2f 7b64  ath}{temp[0]}/{d
+0006df50: 6174 655f 636f 6c75 6d6e 7d2f 2a2f 2a2f  ate_column}/*/*/
+0006df60: 2a22 0a20 2020 2020 2020 2068 6965 7266  *".        hierf
+0006df70: 6e20 3d20 736f 7274 6564 2867 6c6f 6228  n = sorted(glob(
+0006df80: 2070 6174 685f 7465 6d70 6c61 7465 202b   path_template +
+0006df90: 2022 2d22 202b 2068 6965 7276 6172 6961   "-" + hiervaria
+0006dfa0: 626c 6520 2b20 222d 2a77 6964 652e 6373  ble + "-*wide.cs
+0006dfb0: 7622 2029 2029 0a20 2020 2020 2020 2069  v" ) ).        i
+0006dfc0: 6620 6c65 6e28 2068 6965 7266 6e20 2920  f len( hierfn ) 
+0006dfd0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
+0006dfe0: 206b 6565 705b 785d 3d54 7275 650a 0a20   keep[x]=True.. 
+0006dff0: 2020 200a 2020 2020 6466 3d64 665b 6b65     .    df=df[ke
+0006e000: 6570 5d0a 2020 2020 0a20 2020 2069 6620  ep].    .    if 
+0006e010: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+0006e020: 2070 7269 6e74 2820 226f 7269 6769 6e61   print( "origina
+0006e030: 6c20 696e 7075 7420 6861 6420 7368 6170  l input had shap
+0006e040: 6520 2220 2b20 7374 7228 2064 662e 7368  e " + str( df.sh
+0006e050: 6170 655b 305d 2029 202b 2022 2028 5431  ape[0] ) + " (T1
+0006e060: 206f 6e6c 7929 2061 6e64 2077 6520 6669   only) and we fi
+0006e070: 6e64 2022 202b 2073 7472 2820 286b 6565  nd " + str( (kee
+0006e080: 7029 2e73 756d 2829 2029 202b 2022 2077  p).sum() ) + " w
+0006e090: 6974 6820 6869 6572 6172 6368 6963 616c  ith hierarchical
+0006e0a0: 206f 7574 7075 7420 6465 6669 6e65 6420   output defined 
+0006e0b0: 6279 2076 6172 6961 626c 653a 2022 202b  by variable: " +
+0006e0c0: 2068 6965 7276 6172 6961 626c 6520 290a   hiervariable ).
+0006e0d0: 2020 2020 2020 2020 7072 696e 7428 2064          print( d
+0006e0e0: 662e 7368 6170 6520 290a 0a20 2020 206d  f.shape )..    m
+0006e0f0: 7963 7420 3d20 300a 2020 2020 666f 7220  yct = 0.    for 
+0006e100: 7820 696e 2072 616e 6765 2820 6466 2e73  x in range( df.s
+0006e110: 6861 7065 5b30 5d29 3a0a 2020 2020 2020  hape[0]):.      
+0006e120: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+0006e130: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0006e140: 6622 7b78 7d2e 2e2e 2229 0a20 2020 2020  f"{x}...").     
+0006e150: 2020 206c 6f63 696e 6420 3d20 6466 2e69     locind = df.i
+0006e160: 6e64 6578 5b78 5d0a 2020 2020 2020 2020  ndex[x].        
+0006e170: 7465 6d70 203d 2064 665b 2766 696c 656e  temp = df['filen
+0006e180: 616d 6527 5d2e 696c 6f63 5b78 5d2e 7370  ame'].iloc[x].sp
+0006e190: 6c69 7428 225f 2229 0a20 2020 2020 2020  lit("_").       
+0006e1a0: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+0006e1b0: 2020 2020 2020 2020 2070 7269 6e74 2820           print( 
+0006e1c0: 7465 6d70 2029 0a20 2020 2020 2020 2064  temp ).        d
+0006e1d0: 665b 7375 626a 6563 745f 636f 6c5d 2e69  f[subject_col].i
+0006e1e0: 6c6f 635b 785d 3d74 656d 705b 305d 0a20  loc[x]=temp[0]. 
+0006e1f0: 2020 2020 2020 2064 665b 6461 7465 5f63         df[date_c
+0006e200: 6f6c 5d2e 696c 6f63 5b78 5d3d 6461 7465  ol].iloc[x]=date
+0006e210: 5f63 6f6c 756d 6e0a 2020 2020 2020 2020  _column.        
+0006e220: 6466 5b69 6d61 6765 5f63 6f6c 5d2e 696c  df[image_col].il
+0006e230: 6f63 5b78 5d3d 7465 6d70 5b31 5d0a 0a20  oc[x]=temp[1].. 
+0006e240: 2020 2020 2020 2023 2047 656e 6572 616c         # General
+0006e250: 697a 6564 2073 6561 7263 6820 7061 7468  ized search path
+0006e260: 730a 2020 2020 2020 2020 7061 7468 5f74  s.        path_t
+0006e270: 656d 706c 6174 6520 3d20 6622 7b62 6173  emplate = f"{bas
+0006e280: 655f 7061 7468 7d7b 7465 6d70 5b30 5d7d  e_path}{temp[0]}
+0006e290: 2f7b 6461 7465 5f63 6f6c 756d 6e7d 2f2a  /{date_column}/*
+0006e2a0: 2f2a 2f2a 220a 2020 2020 2020 2020 6966  /*/*".        if
+0006e2b0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+0006e2c0: 2020 2020 2020 7072 696e 7428 7061 7468        print(path
+0006e2d0: 5f74 656d 706c 6174 6529 0a20 2020 2020  _template).     
+0006e2e0: 2020 2068 6965 7266 6e20 3d20 736f 7274     hierfn = sort
+0006e2f0: 6564 2867 6c6f 6228 2070 6174 685f 7465  ed(glob( path_te
+0006e300: 6d70 6c61 7465 202b 2022 2d22 202b 2068  mplate + "-" + h
+0006e310: 6965 7276 6172 6961 626c 6520 2b20 222d  iervariable + "-
+0006e320: 2a77 6964 652e 6373 7622 2029 2029 0a20  *wide.csv" ) ). 
+0006e330: 2020 2020 2020 2069 6620 6c65 6e28 2068         if len( h
+0006e340: 6965 7266 6e20 2920 3e20 303a 0a20 2020  ierfn ) > 0:.   
+0006e350: 2020 2020 2020 2020 2068 6466 3d74 3164           hdf=t1d
+0006e360: 663d 6474 6466 3d72 7364 663d 7065 7266  f=dtdf=rsdf=perf
+0006e370: 6466 3d6e 6d64 663d 666c 6169 7264 663d  df=nmdf=flairdf=
+0006e380: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+0006e390: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+0006e3a0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0006e3b0: 6e74 2868 6965 7266 6e29 0a20 2020 2020  nt(hierfn).     
+0006e3c0: 2020 2020 2020 2068 6466 203d 2070 642e         hdf = pd.
+0006e3d0: 7265 6164 5f63 7376 2868 6965 7266 6e5b  read_csv(hierfn[
+0006e3e0: 305d 290a 2020 2020 2020 2020 2020 2020  0]).            
+0006e3f0: 6261 646e 616d 6573 203d 2067 6574 5f6e  badnames = get_n
+0006e400: 616d 6573 5f66 726f 6d5f 6461 7461 5f66  ames_from_data_f
+0006e410: 7261 6d65 2820 5b27 556e 6e61 6d65 6427  rame( ['Unnamed'
+0006e420: 5d2c 2068 6466 2029 0a20 2020 2020 2020  ], hdf ).       
+0006e430: 2020 2020 2068 6466 3d68 6466 2e64 726f       hdf=hdf.dro
+0006e440: 7028 6261 646e 616d 6573 2c20 6178 6973  p(badnames, axis
+0006e450: 3d31 290a 2020 2020 2020 2020 2020 2020  =1).            
+0006e460: 6e75 6d73 203d 205b 6973 696e 7374 616e  nums = [isinstan
+0006e470: 6365 2868 6466 5b63 6f6c 5d2e 696c 6f63  ce(hdf[col].iloc
+0006e480: 5b30 5d2c 2028 696e 742c 2066 6c6f 6174  [0], (int, float
+0006e490: 2929 2066 6f72 2063 6f6c 2069 6e20 6864  )) for col in hd
+0006e4a0: 662e 636f 6c75 6d6e 735d 0a20 2020 2020  f.columns].     
+0006e4b0: 2020 2020 2020 2063 6f72 656e 616d 6573         corenames
+0006e4c0: 203d 206c 6973 7428 6e70 2e61 7272 6179   = list(np.array
+0006e4d0: 2868 6466 2e63 6f6c 756d 6e73 295b 6e75  (hdf.columns)[nu
+0006e4e0: 6d73 5d29 0a20 2020 2020 2020 2020 2020  ms]).           
+0006e4f0: 2068 6466 2e6c 6f63 5b3a 2c20 6e75 6d73   hdf.loc[:, nums
+0006e500: 5d20 3d20 6864 662e 6c6f 635b 3a2c 206e  ] = hdf.loc[:, n
+0006e510: 756d 735d 2e61 6464 5f70 7265 6669 7828  ums].add_prefix(
+0006e520: 2254 3148 6965 725f 2229 0a20 2020 2020  "T1Hier_").     
+0006e530: 2020 2020 2020 206d 7963 7420 3d20 6d79         myct = my
+0006e540: 6374 202b 2031 0a20 2020 2020 2020 2020  ct + 1.         
+0006e550: 2020 2064 666c 6973 7420 3d20 5b68 6466     dflist = [hdf
+0006e560: 5d0a 0a20 2020 2020 2020 2020 2020 2066  ]..            f
+0006e570: 6f72 206d 796d 6f64 2069 6e20 7661 6c69  or mymod in vali
+0006e580: 645f 6d6f 6461 6c69 7469 6573 3a0a 2020  d_modalities:.  
+0006e590: 2020 2020 2020 2020 2020 2020 2020 7431                t1
+0006e5a0: 7766 6e20 3d20 736f 7274 6564 2867 6c6f  wfn = sorted(glo
+0006e5b0: 6228 2070 6174 685f 7465 6d70 6c61 7465  b( path_template
+0006e5c0: 2b20 222d 2220 2b20 6d79 6d6f 6420 2b20  + "-" + mymod + 
+0006e5d0: 222d 2a77 6964 652e 6373 7622 2029 2029  "-*wide.csv" ) )
+0006e5e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006e5f0: 2069 6620 6c65 6e28 2074 3177 666e 2029   if len( t1wfn )
+0006e600: 203e 2030 203a 0a20 2020 2020 2020 2020   > 0 :.         
+0006e610: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
+0006e620: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
+0006e630: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0006e640: 7269 6e74 2874 3177 666e 290a 2020 2020  rint(t1wfn).    
+0006e650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e660: 7431 6466 203d 206d 7972 6561 645f 6373  t1df = myread_cs
+0006e670: 7628 7431 7766 6e5b 305d 2c20 636f 7265  v(t1wfn[0], core
+0006e680: 6e61 6d65 7329 0a20 2020 2020 2020 2020  names).         
+0006e690: 2020 2020 2020 2020 2020 2074 3164 6620             t1df 
+0006e6a0: 3d20 6669 6c74 6572 5f64 6628 2074 3164  = filter_df( t1d
+0006e6b0: 662c 206d 796d 6f64 2b27 5f27 290a 2020  f, mymod+'_').  
+0006e6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e6d0: 2020 6466 6c69 7374 203d 2064 666c 6973    dflist = dflis
+0006e6e0: 7420 2b20 5b74 3164 665d 0a20 2020 2020  t + [t1df].     
+0006e6f0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0006e700: 2020 2020 2020 2020 6864 6620 3d20 7064          hdf = pd
+0006e710: 2e63 6f6e 6361 7428 2064 666c 6973 742c  .concat( dflist,
+0006e720: 2061 7869 733d 312c 2069 676e 6f72 655f   axis=1, ignore_
+0006e730: 696e 6465 783d 4661 6c73 6520 290a 2020  index=False ).  
+0006e740: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+0006e750: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+0006e760: 2020 2020 2020 7072 696e 7428 2064 662e        print( df.
+0006e770: 6c6f 635b 6c6f 6369 6e64 2c27 6669 6c65  loc[locind,'file
+0006e780: 6e61 6d65 275d 2029 0a20 2020 2020 2020  name'] ).       
+0006e790: 2020 2020 2069 6620 6d79 6374 203d 3d20       if myct == 
+0006e7a0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+0006e7b0: 2020 2073 7562 6466 203d 2064 662e 696c     subdf = df.il
+0006e7c0: 6f63 5b5b 785d 5d0a 2020 2020 2020 2020  oc[[x]].        
+0006e7d0: 2020 2020 2020 2020 6864 662e 696e 6465          hdf.inde
+0006e7e0: 7820 3d20 7375 6264 662e 696e 6465 782e  x = subdf.index.
+0006e7f0: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
+0006e800: 2020 2020 2020 2064 6620 3d20 7064 2e63         df = pd.c
+0006e810: 6f6e 6361 7428 205b 6466 2c68 6466 5d2c  oncat( [df,hdf],
+0006e820: 2061 7869 733d 312c 2069 676e 6f72 655f   axis=1, ignore_
+0006e830: 696e 6465 783d 4661 6c73 6520 290a 2020  index=False ).  
+0006e840: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0006e850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e860: 636f 6d6d 636f 6c73 203d 206c 6973 7428  commcols = list(
+0006e870: 7365 7428 6864 662e 636f 6c75 6d6e 7329  set(hdf.columns)
+0006e880: 2e69 6e74 6572 7365 6374 696f 6e28 6466  .intersection(df
+0006e890: 2e63 6f6c 756d 6e73 2929 0a20 2020 2020  .columns)).     
+0006e8a0: 2020 2020 2020 2020 2020 2064 662e 6c6f             df.lo
+0006e8b0: 635b 6c6f 6369 6e64 2c20 636f 6d6d 636f  c[locind, commco
+0006e8c0: 6c73 5d20 3d20 6864 662e 6c6f 635b 302c  ls] = hdf.loc[0,
+0006e8d0: 2063 6f6d 6d63 6f6c 735d 0a20 2020 2062   commcols].    b
+0006e8e0: 6164 6e61 6d65 7320 3d20 6765 745f 6e61  adnames = get_na
+0006e8f0: 6d65 735f 6672 6f6d 5f64 6174 615f 6672  mes_from_data_fr
+0006e900: 616d 6528 205b 2755 6e6e 616d 6564 275d  ame( ['Unnamed']
+0006e910: 2c20 6466 2029 0a20 2020 2064 663d 6466  , df ).    df=df
+0006e920: 2e64 726f 7028 6261 646e 616d 6573 2c20  .drop(badnames, 
+0006e930: 6178 6973 3d31 290a 2020 2020 7265 7475  axis=1).    retu
+0006e940: 726e 2820 6466 2029 0a0a 6465 6620 6669  rn( df )..def fi
+0006e950: 6e64 5f6d 6f73 745f 7265 6365 6e74 5f66  nd_most_recent_f
+0006e960: 696c 6528 6669 6c65 5f6c 6973 7429 3a0a  ile(file_list):.
+0006e970: 2020 2020 2222 220a 2020 2020 4669 6e64      """.    Find
+0006e980: 7320 616e 6420 7265 7475 726e 7320 7468  s and returns th
+0006e990: 6520 6d6f 7374 2072 6563 656e 746c 7920  e most recently 
+0006e9a0: 6d6f 6469 6669 6564 2066 696c 6520 6672  modified file fr
+0006e9b0: 6f6d 2061 206c 6973 7420 6f66 2066 696c  om a list of fil
+0006e9c0: 6520 7061 7468 732e 0a20 2020 200a 2020  e paths..    .  
+0006e9d0: 2020 5061 7261 6d65 7465 7273 3a0a 2020    Parameters:.  
+0006e9e0: 2020 2d20 6669 6c65 5f6c 6973 743a 2041    - file_list: A
+0006e9f0: 206c 6973 7420 6f66 2073 7472 696e 6773   list of strings
+0006ea00: 2c20 7768 6572 6520 6561 6368 2073 7472  , where each str
+0006ea10: 696e 6720 6973 2061 2070 6174 6820 746f  ing is a path to
+0006ea20: 2061 2066 696c 652e 0a20 2020 200a 2020   a file..    .  
+0006ea30: 2020 5265 7475 726e 733a 0a20 2020 202d    Returns:.    -
+0006ea40: 2054 6865 2070 6174 6820 746f 2074 6865   The path to the
+0006ea50: 206d 6f73 7420 7265 6365 6e74 6c79 206d   most recently m
+0006ea60: 6f64 6966 6965 6420 6669 6c65 2069 6e20  odified file in 
+0006ea70: 7468 6520 6c69 7374 2c20 6f72 204e 6f6e  the list, or Non
+0006ea80: 6520 6966 2074 6865 206c 6973 7420 6973  e if the list is
+0006ea90: 2065 6d70 7479 206f 7220 636f 6e74 6169   empty or contai
+0006eaa0: 6e73 206e 6f20 7661 6c69 6420 6669 6c65  ns no valid file
+0006eab0: 732e 0a20 2020 2022 2222 0a20 2020 2023  s..    """.    #
+0006eac0: 2046 696c 7465 7220 6f75 7420 6974 656d   Filter out item
+0006ead0: 7320 7468 6174 2061 7265 206e 6f74 2066  s that are not f
+0006eae0: 696c 6573 206f 7220 646f 206e 6f74 2065  iles or do not e
+0006eaf0: 7869 7374 0a20 2020 2076 616c 6964 5f66  xist.    valid_f
+0006eb00: 696c 6573 203d 205b 6620 666f 7220 6620  iles = [f for f 
+0006eb10: 696e 2066 696c 655f 6c69 7374 2069 6620  in file_list if 
+0006eb20: 6f73 2e70 6174 682e 6973 6669 6c65 2866  os.path.isfile(f
+0006eb30: 295d 0a20 2020 200a 2020 2020 2320 4368  )].    .    # Ch
+0006eb40: 6563 6b20 6966 2074 6865 2066 696c 7465  eck if the filte
+0006eb50: 7265 6420 6c69 7374 2069 7320 6e6f 7420  red list is not 
+0006eb60: 656d 7074 790a 2020 2020 6966 2076 616c  empty.    if val
+0006eb70: 6964 5f66 696c 6573 3a0a 2020 2020 2020  id_files:.      
+0006eb80: 2020 2320 4669 6e64 2074 6865 2066 696c    # Find the fil
+0006eb90: 6520 7769 7468 2074 6865 206c 6174 6573  e with the lates
+0006eba0: 7420 6d6f 6469 6669 6361 7469 6f6e 2074  t modification t
+0006ebb0: 696d 650a 2020 2020 2020 2020 6d6f 7374  ime.        most
+0006ebc0: 5f72 6563 656e 745f 6669 6c65 203d 206d  _recent_file = m
+0006ebd0: 6178 2876 616c 6964 5f66 696c 6573 2c20  ax(valid_files, 
+0006ebe0: 6b65 793d 6f73 2e70 6174 682e 6765 746d  key=os.path.getm
+0006ebf0: 7469 6d65 290a 2020 2020 2020 2020 7265  time).        re
+0006ec00: 7475 726e 205b 6d6f 7374 5f72 6563 656e  turn [most_recen
+0006ec10: 745f 6669 6c65 5d0a 2020 2020 656c 7365  t_file].    else
+0006ec20: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0006ec30: 204e 6f6e 650a 2020 2020 0a64 6566 2061   None.    .def a
+0006ec40: 6767 7265 6761 7465 5f61 6e74 7370 796d  ggregate_antspym
+0006ec50: 6d5f 7265 7375 6c74 735f 7364 6628 0a20  m_results_sdf(. 
+0006ec60: 2020 2073 7475 6479 5f64 662c 200a 2020     study_df, .  
+0006ec70: 2020 7072 6f6a 6563 745f 636f 6c3d 2770    project_col='p
+0006ec80: 726f 6a65 6374 4944 272c 0a20 2020 2073  rojectID',.    s
+0006ec90: 7562 6a65 6374 5f63 6f6c 3d27 7375 626a  ubject_col='subj
+0006eca0: 6563 7449 4427 2c20 0a20 2020 2064 6174  ectID', .    dat
+0006ecb0: 655f 636f 6c3d 2764 6174 6527 2c20 0a20  e_col='date', . 
+0006ecc0: 2020 2069 6d61 6765 5f63 6f6c 3d27 696d     image_col='im
+0006ecd0: 6167 6549 4427 2c20 0a20 2020 2062 6173  ageID', .    bas
+0006ece0: 655f 7061 7468 3d22 2e2f 222c 200a 2020  e_path="./", .  
+0006ecf0: 2020 6869 6572 7661 7269 6162 6c65 3d27    hiervariable='
+0006ed00: 5431 7748 6965 7261 7263 6869 6361 6c27  T1wHierarchical'
+0006ed10: 2c20 0a20 2020 2073 706c 6974 7365 703d  , .    splitsep=
+0006ed20: 272d 272c 0a20 2020 2069 6473 6570 3d27  '-',.    idsep='
+0006ed30: 2d27 2c0a 2020 2020 7769 6c64 5f63 6172  -',.    wild_car
+0006ed40: 645f 6d6f 6461 6c69 7479 5f69 643d 4661  d_modality_id=Fa
+0006ed50: 6c73 652c 0a20 2020 2073 6563 6f6e 645f  lse,.    second_
+0006ed60: 7370 6c69 743d 4661 6c73 652c 0a20 2020  split=False,.   
+0006ed70: 2076 6572 626f 7365 3d46 616c 7365 2029   verbose=False )
+0006ed80: 3a0a 2020 2020 2222 220a 2020 2020 4167  :.    """.    Ag
+0006ed90: 6772 6567 6174 6520 414e 5473 5079 4d4d  gregate ANTsPyMM
+0006eda0: 2072 6573 756c 7473 2066 726f 6d20 7468   results from th
+0006edb0: 6520 7370 6563 6966 6965 6420 7374 7564  e specified stud
+0006edc0: 7920 6461 7461 2066 7261 6d65 2061 6e64  y data frame and
+0006edd0: 2073 746f 7265 2074 6865 2061 6767 7265   store the aggre
+0006ede0: 6761 7465 6420 7265 7375 6c74 7320 696e  gated results in
+0006edf0: 2061 206e 6577 2064 6174 6120 6672 616d   a new data fram
+0006ee00: 652e 2020 5468 6973 2061 7373 756d 6573  e.  This assumes
+0006ee10: 2064 6174 6120 6973 206f 7267 616e 697a   data is organiz
+0006ee20: 6564 206f 6e20 6469 736b 200a 2020 2020  ed on disk .    
+0006ee30: 6173 2066 6f6c 6c6f 7773 3a20 2072 6f6f  as follows:  roo
+0006ee40: 7464 6972 2f70 726f 6a65 6374 4944 2f73  tdir/projectID/s
+0006ee50: 7562 6a65 6374 4944 2f64 6174 652f 6f75  ubjectID/date/ou
+0006ee60: 7470 7574 6964 2f69 6d61 6765 6964 2f20  tputid/imageid/ 
+0006ee70: 7768 6572 6520 0a20 2020 206f 7574 7075  where .    outpu
+0006ee80: 7469 6420 6973 206d 6f64 616c 6974 792d  tid is modality-
+0006ee90: 7370 6563 6966 6963 2061 6e64 2063 7265  specific and cre
+0006eea0: 6174 6564 2062 7920 414e 5473 5079 4d4d  ated by ANTsPyMM
+0006eeb0: 2070 726f 6365 7373 696e 672e 0a0a 2020   processing...  
+0006eec0: 2020 5061 7261 6d65 7465 7273 3a0a 2020    Parameters:.  
+0006eed0: 2020 2d20 7374 7564 795f 6466 2028 7061    - study_df (pa
+0006eee0: 6e64 6173 2064 6629 3a20 7061 6e64 6173  ndas df): pandas
+0006eef0: 2064 6174 6120 6672 616d 652c 206f 7574   data frame, out
+0006ef00: 7075 7420 6f66 2067 656e 6572 6174 655f  put of generate_
+0006ef10: 6d6d 5f64 6174 6166 7261 6d65 2e0a 2020  mm_dataframe..  
+0006ef20: 2020 2d20 7072 6f6a 6563 745f 636f 6c20    - project_col 
+0006ef30: 2873 7472 293a 204e 616d 6520 6f66 2074  (str): Name of t
+0006ef40: 6865 2063 6f6c 756d 6e20 7468 6174 2073  he column that s
+0006ef50: 746f 7265 7320 7468 6520 7072 6f6a 6563  tores the projec
+0006ef60: 7420 4944 0a20 2020 202d 2073 7562 6a65  t ID.    - subje
+0006ef70: 6374 5f63 6f6c 2028 7374 7229 3a20 4e61  ct_col (str): Na
+0006ef80: 6d65 206f 6620 7468 6520 636f 6c75 6d6e  me of the column
+0006ef90: 2074 6f20 7374 6f72 6520 7375 626a 6563   to store subjec
+0006efa0: 7420 4944 732e 0a20 2020 202d 2064 6174  t IDs..    - dat
+0006efb0: 655f 636f 6c20 2873 7472 293a 204e 616d  e_col (str): Nam
+0006efc0: 6520 6f66 2074 6865 2063 6f6c 756d 6e20  e of the column 
+0006efd0: 746f 2073 746f 7265 2064 6174 6520 696e  to store date in
+0006efe0: 666f 726d 6174 696f 6e2e 0a20 2020 202d  formation..    -
+0006eff0: 2069 6d61 6765 5f63 6f6c 2028 7374 7229   image_col (str)
+0006f000: 3a20 4e61 6d65 206f 6620 7468 6520 636f  : Name of the co
+0006f010: 6c75 6d6e 2074 6f20 7374 6f72 6520 696d  lumn to store im
+0006f020: 6167 6520 4944 732e 0a20 2020 202d 2062  age IDs..    - b
+0006f030: 6173 655f 7061 7468 2028 7374 7229 3a20  ase_path (str): 
+0006f040: 4261 7365 2070 6174 6820 666f 7220 7365  Base path for se
+0006f050: 6172 6368 696e 6720 666f 7220 7072 6f63  arching for proc
+0006f060: 6573 7369 6e67 206f 7574 7075 7473 206f  essing outputs o
+0006f070: 6620 414e 5473 5079 4d4d 2e0a 2020 2020  f ANTsPyMM..    
+0006f080: 2d20 6869 6572 7661 7269 6162 6c65 2028  - hiervariable (
+0006f090: 7374 7229 203a 2074 6865 2073 7472 696e  str) : the strin
+0006f0a0: 6720 7661 7269 6162 6c65 2064 656e 6f74  g variable denot
+0006f0b0: 696e 6720 7468 6520 4869 6572 6172 6368  ing the Hierarch
+0006f0c0: 6963 616c 206f 7574 7075 740a 2020 2020  ical output.    
+0006f0d0: 2d20 7370 6c69 7473 6570 2028 7374 7229  - splitsep (str)
+0006f0e0: 3a20 2074 6865 2073 6570 6172 6174 6f72  :  the separator
+0006f0f0: 2075 7365 6420 746f 2073 706c 6974 2074   used to split t
+0006f100: 6865 2066 696c 656e 616d 650a 2020 2020  he filename.    
+0006f110: 2d20 6964 7365 7020 2873 7472 293a 2074  - idsep (str): t
+0006f120: 6865 2073 6570 6172 6174 6f72 2075 7365  he separator use
+0006f130: 6420 746f 2070 6172 7469 7469 6f6e 2073  d to partition s
+0006f140: 7562 6a65 6374 6964 2064 6174 6520 616e  ubjectid date an
+0006f150: 6420 696d 6167 6569 6420 0a20 2020 2020  d imageid .     
+0006f160: 2020 2066 6f72 2065 7861 6d70 6c65 2c20     for example, 
+0006f170: 6966 2069 6473 6570 2069 7320 2d20 7468  if idsep is - th
+0006f180: 656e 2077 6520 6861 7665 2073 7562 6a65  en we have subje
+0006f190: 6374 6964 2d64 6174 652d 696d 6167 6569  ctid-date-imagei
+0006f1a0: 640a 2020 2020 2d20 7769 6c64 5f63 6172  d.    - wild_car
+0006f1b0: 645f 6d6f 6461 6c69 7479 5f69 6420 2862  d_modality_id (b
+0006f1c0: 6f6f 6c29 3a20 6b65 6570 2069 6620 4661  ool): keep if Fa
+0006f1d0: 6c73 6520 666f 7220 7361 6665 7220 6578  lse for safer ex
+0006f1e0: 6563 7574 696f 6e0a 2020 2020 2d20 7365  ecution.    - se
+0006f1f0: 636f 6e64 5f73 706c 6974 2028 626f 6f6c  cond_split (bool
+0006f200: 293a 2074 6869 7320 6973 2061 2068 6163  ): this is a hac
+0006f210: 6b20 7468 6174 2077 696c 6c20 7370 6c69  k that will spli
+0006f220: 7420 7468 6520 696d 6167 6549 4420 6279  t the imageID by
+0006f230: 202e 2061 6e64 206b 6565 7020 7468 6520   . and keep the 
+0006f240: 6669 7273 7420 7061 7274 206f 6620 7468  first part of th
+0006f250: 6520 7370 6c69 743b 206d 6179 2062 6520  e split; may be 
+0006f260: 6e65 6564 6564 2077 6865 6e20 7468 6520  needed when the 
+0006f270: 696e 7075 7420 6669 6c65 6e61 6d65 7320  input filenames 
+0006f280: 636f 6e74 6169 6e20 2e0a 2020 2020 2d20  contain ..    - 
+0006f290: 7665 7262 6f73 6520 3a20 626f 6f6c 6561  verbose : boolea
+0006f2a0: 6e0a 0a20 2020 204e 6f74 653a 0a20 2020  n..    Note:.   
+0006f2b0: 2054 6869 7320 6675 6e63 7469 6f6e 2069   This function i
+0006f2c0: 7320 7465 7374 6564 2075 6e64 6572 206c  s tested under l
+0006f2d0: 696d 6974 6564 2063 6972 6375 6d73 7461  imited circumsta
+0006f2e0: 6e63 6573 2e20 5573 6520 7769 7468 2063  nces. Use with c
+0006f2f0: 6175 7469 6f6e 2e0a 2020 2020 4f6e 6520  aution..    One 
+0006f300: 7061 7274 6963 756c 6172 2067 6f74 6368  particular gotch
+0006f310: 6120 6973 2069 6620 7468 6520 696d 6167  a is if the imag
+0006f320: 6549 4420 6973 2073 746f 7265 6420 6173  eID is stored as
+0006f330: 2061 206e 756d 6572 6963 2076 616c 7565   a numeric value
+0006f340: 2069 6e20 7468 6520 6461 7461 6672 616d   in the datafram
+0006f350: 6520 0a20 2020 2062 7574 2069 7320 6d65  e .    but is me
+0006f360: 616e 7420 746f 2062 6520 6120 7374 7269  ant to be a stri
+0006f370: 6e67 2e20 2045 2e67 2e20 2730 3030 2720  ng.  E.g. '000' 
+0006f380: 2873 7472 696e 6729 2077 6f75 6c64 2062  (string) would b
+0006f390: 6520 696e 7465 7270 7265 7465 6420 6173  e interpreted as
+0006f3a0: 2030 2069 6e20 7468 6520 0a20 2020 2066   0 in the .    f
+0006f3b0: 696c 6520 6e61 6d65 2067 6c6f 622e 2020  ile name glob.  
+0006f3c0: 5468 6973 2077 6f75 6c64 206d 6973 7320  This would miss 
+0006f3d0: 7468 6520 6578 7461 6e74 2028 6f6e 2064  the extant (on d
+0006f3e0: 6973 6b29 2063 7376 2e0a 0a20 2020 2045  isk) csv...    E
+0006f3f0: 7861 6d70 6c65 2075 7361 6765 3a0a 2020  xample usage:.  
+0006f400: 2020 6167 675f 6466 203d 2061 6767 7265    agg_df = aggre
+0006f410: 6761 7465 5f61 6e74 7370 796d 6d5f 7265  gate_antspymm_re
+0006f420: 7375 6c74 735f 7364 6628 2073 7475 6479  sults_sdf( study
+0006f430: 6466 2c20 7375 626a 6563 745f 636f 6c3d  df, subject_col=
+0006f440: 2773 7562 6a65 6374 4944 272c 2064 6174  'subjectID', dat
+0006f450: 655f 636f 6c3d 2764 6174 6527 2c20 696d  e_col='date', im
+0006f460: 6167 655f 636f 6c3d 2769 6d61 6765 4944  age_col='imageID
+0006f470: 272c 2062 6173 655f 7061 7468 3d22 2e2f  ', base_path="./
+0006f480: 596f 7572 2f43 7573 746f 6d2f 5061 7468  Your/Custom/Path
+0006f490: 2f22 290a 0a20 2020 2041 7574 686f 723a  /")..    Author:
+0006f4a0: 0a20 2020 2041 7661 6e74 7320 616e 6420  .    Avants and 
+0006f4b0: 4368 6174 4750 540a 2020 2020 2222 220a  ChatGPT.    """.
+0006f4c0: 2020 2020 696d 706f 7274 2070 616e 6461      import panda
+0006f4d0: 7320 6173 2070 640a 2020 2020 696d 706f  s as pd.    impo
+0006f4e0: 7274 206e 756d 7079 2061 7320 6e70 0a20  rt numpy as np. 
+0006f4f0: 2020 2066 726f 6d20 676c 6f62 2069 6d70     from glob imp
+0006f500: 6f72 7420 676c 6f62 0a0a 2020 2020 6465  ort glob..    de
+0006f510: 6620 7072 6f67 7265 7373 5f72 6570 6f72  f progress_repor
+0006f520: 7465 7228 6375 7272 656e 745f 7374 6570  ter(current_step
+0006f530: 2c20 746f 7461 6c5f 7374 6570 732c 2077  , total_steps, w
+0006f540: 6964 7468 3d35 3029 3a0a 2020 2020 2020  idth=50):.      
+0006f550: 2020 2320 4361 6c63 756c 6174 6520 7468    # Calculate th
+0006f560: 6520 7072 6f70 6f72 7469 6f6e 206f 6620  e proportion of 
+0006f570: 7072 6f67 7265 7373 0a20 2020 2020 2020  progress.       
+0006f580: 2070 726f 6772 6573 7320 3d20 6375 7272   progress = curr
+0006f590: 656e 745f 7374 6570 202f 2074 6f74 616c  ent_step / total
+0006f5a0: 5f73 7465 7073 0a20 2020 2020 2020 2023  _steps.        #
+0006f5b0: 2043 616c 6375 6c61 7465 2074 6865 206e   Calculate the n
+0006f5c0: 756d 6265 7220 6f66 2027 6669 6c6c 6564  umber of 'filled
+0006f5d0: 2720 6368 6172 6163 7465 7273 2069 6e20  ' characters in 
+0006f5e0: 7468 6520 7072 6f67 7265 7373 2062 6172  the progress bar
+0006f5f0: 0a20 2020 2020 2020 2066 696c 6c65 645f  .        filled_
+0006f600: 6c65 6e67 7468 203d 2069 6e74 2877 6964  length = int(wid
+0006f610: 7468 202a 2070 726f 6772 6573 7329 0a20  th * progress). 
+0006f620: 2020 2020 2020 2023 2043 7265 6174 6520         # Create 
+0006f630: 7468 6520 7072 6f67 7265 7373 2062 6172  the progress bar
+0006f640: 2073 7472 696e 670a 2020 2020 2020 2020   string.        
+0006f650: 6261 7220 3d20 27e2 9688 2720 2a20 6669  bar = '...' * fi
+0006f660: 6c6c 6564 5f6c 656e 6774 6820 2b20 272d  lled_length + '-
+0006f670: 2720 2a20 2877 6964 7468 202d 2066 696c  ' * (width - fil
+0006f680: 6c65 645f 6c65 6e67 7468 290a 2020 2020  led_length).    
+0006f690: 2020 2020 2320 5072 696e 7420 7468 6520      # Print the 
+0006f6a0: 7072 6f67 7265 7373 2062 6172 2077 6974  progress bar wit
+0006f6b0: 6820 7065 7263 656e 7461 6765 0a20 2020  h percentage.   
+0006f6c0: 2020 2020 2070 7269 6e74 2866 275c 7250       print(f'\rP
+0006f6d0: 726f 6772 6573 733a 207c 7b62 6172 7d7c  rogress: |{bar}|
+0006f6e0: 207b 696e 7428 3130 3020 2a20 7072 6f67   {int(100 * prog
+0006f6f0: 7265 7373 297d 2527 2c20 656e 643d 275c  ress)}%', end='\
+0006f700: 7227 290a 2020 2020 2020 2020 2320 5072  r').        # Pr
+0006f710: 696e 7420 6120 6e65 7720 6c69 6e65 2077  int a new line w
+0006f720: 6865 6e20 7468 6520 7072 6f67 7265 7373  hen the progress
+0006f730: 2069 7320 636f 6d70 6c65 7465 0a20 2020   is complete.   
+0006f740: 2020 2020 2069 6620 6375 7272 656e 745f       if current_
+0006f750: 7374 6570 203d 3d20 746f 7461 6c5f 7374  step == total_st
+0006f760: 6570 733a 0a20 2020 2020 2020 2020 2020  eps:.           
+0006f770: 2070 7269 6e74 2829 0a0a 2020 2020 6465   print()..    de
+0006f780: 6620 6d79 7265 6164 5f63 7376 2878 2c20  f myread_csv(x, 
+0006f790: 636e 6d73 293a 0a20 2020 2020 2020 2022  cnms):.        "
+0006f7a0: 2222 0a20 2020 2020 2020 2052 6561 6473  "".        Reads
+0006f7b0: 2061 2043 5356 2066 696c 6520 616e 6420   a CSV file and 
+0006f7c0: 7265 7475 726e 7320 6120 4461 7461 4672  returns a DataFr
+0006f7d0: 616d 6520 6578 636c 7564 696e 6720 7370  ame excluding sp
+0006f7e0: 6563 6966 6965 6420 636f 6c75 6d6e 732e  ecified columns.
+0006f7f0: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
+0006f800: 7465 7273 3a0a 2020 2020 2020 2020 2d20  ters:.        - 
+0006f810: 7820 2873 7472 293a 2046 696c 6520 7061  x (str): File pa
+0006f820: 7468 206f 6620 7468 6520 696e 7075 7420  th of the input 
+0006f830: 4353 5620 6669 6c65 2064 6573 6372 6962  CSV file describ
+0006f840: 696e 6720 7468 6520 626c 696e 6420 5143  ing the blind QC
+0006f850: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
+0006f860: 2d20 636e 6d73 2028 6c69 7374 293a 204c  - cnms (list): L
+0006f870: 6973 7420 6f66 2063 6f6c 756d 6e20 6e61  ist of column na
+0006f880: 6d65 7320 746f 2065 7863 6c75 6465 2066  mes to exclude f
+0006f890: 726f 6d20 7468 6520 4461 7461 4672 616d  rom the DataFram
+0006f8a0: 652e 0a0a 2020 2020 2020 2020 5265 7475  e...        Retu
+0006f8b0: 726e 733a 0a20 2020 2020 2020 2070 642e  rns:.        pd.
+0006f8c0: 4461 7461 4672 616d 653a 2044 6174 6146  DataFrame: DataF
+0006f8d0: 7261 6d65 2077 6974 6820 7370 6563 6966  rame with specif
+0006f8e0: 6965 6420 636f 6c75 6d6e 7320 6578 636c  ied columns excl
+0006f8f0: 7564 6564 2e0a 2020 2020 2020 2020 2222  uded..        ""
+0006f900: 220a 2020 2020 2020 2020 6466 203d 2070  ".        df = p
+0006f910: 642e 7265 6164 5f63 7376 2878 290a 2020  d.read_csv(x).  
+0006f920: 2020 2020 2020 7265 7475 726e 2064 662e        return df.
+0006f930: 6c6f 635b 3a2c 207e 6466 2e63 6f6c 756d  loc[:, ~df.colum
+0006f940: 6e73 2e69 7369 6e28 636e 6d73 295d 0a0a  ns.isin(cnms)]..
+0006f950: 2020 2020 696d 706f 7274 2077 6172 6e69      import warni
+0006f960: 6e67 730a 2020 2020 2320 5761 726e 696e  ngs.    # Warnin
+0006f970: 6720 6d65 7373 6167 6520 666f 7220 756e  g message for un
+0006f980: 7465 7374 6564 2066 756e 6374 696f 6e0a  tested function.
+0006f990: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
+0006f9a0: 6e28 2257 6172 6e69 6e67 3a20 5468 6973  n("Warning: This
+0006f9b0: 2066 756e 6374 696f 6e20 6973 206e 6f74   function is not
+0006f9c0: 2077 656c 6c20 7465 7374 6564 2e20 5573   well tested. Us
+0006f9d0: 6520 7769 7468 2063 6175 7469 6f6e 2e22  e with caution."
+0006f9e0: 290a 0a20 2020 2076 6d6f 6464 6963 7420  )..    vmoddict 
+0006f9f0: 3d20 7b7d 0a20 2020 2023 2041 6464 206b  = {}.    # Add k
+0006fa00: 6579 2d76 616c 7565 2070 6169 7273 0a20  ey-value pairs. 
+0006fa10: 2020 2076 6d6f 6464 6963 745b 2769 6d61     vmoddict['ima
+0006fa20: 6765 4944 275d 203d 2027 5431 7727 0a20  geID'] = 'T1w'. 
+0006fa30: 2020 2076 6d6f 6464 6963 745b 2766 6c61     vmoddict['fla
+0006fa40: 6972 6964 275d 203d 2027 5432 466c 6169  irid'] = 'T2Flai
+0006fa50: 7227 0a20 2020 2076 6d6f 6464 6963 745b  r'.    vmoddict[
+0006fa60: 2770 6572 6669 6427 5d20 3d20 2770 6572  'perfid'] = 'per
+0006fa70: 6627 0a20 2020 2076 6d6f 6464 6963 745b  f'.    vmoddict[
+0006fa80: 2772 7366 6964 3127 5d20 3d20 2772 7366  'rsfid1'] = 'rsf
+0006fa90: 4d52 4927 0a23 2020 2020 766d 6f64 6469  MRI'.#    vmoddi
+0006faa0: 6374 5b27 7273 6669 6432 275d 203d 2027  ct['rsfid2'] = '
+0006fab0: 7273 664d 5249 270a 2020 2020 766d 6f64  rsfMRI'.    vmod
+0006fac0: 6469 6374 5b27 6474 6964 3127 5d20 3d20  dict['dtid1'] = 
+0006fad0: 2744 5449 270a 2320 2020 2076 6d6f 6464  'DTI'.#    vmodd
+0006fae0: 6963 745b 2764 7469 6432 275d 203d 2027  ict['dtid2'] = '
+0006faf0: 4454 4927 0a20 2020 2076 6d6f 6464 6963  DTI'.    vmoddic
+0006fb00: 745b 276e 6d69 6431 275d 203d 2027 4e4d  t['nmid1'] = 'NM
+0006fb10: 3244 4d54 270a 2320 2020 2076 6d6f 6464  2DMT'.#    vmodd
+0006fb20: 6963 745b 276e 6d69 6432 275d 203d 2027  ict['nmid2'] = '
+0006fb30: 4e4d 3244 4d54 270a 0a20 2020 2023 2046  NM2DMT'..    # F
+0006fb40: 696c 7465 7220 726f 7773 2077 6865 7265  ilter rows where
+0006fb50: 206d 6f64 616c 6974 7920 6973 2027 5431   modality is 'T1
+0006fb60: 7727 0a20 2020 2064 6620 3d20 7374 7564  w'.    df = stud
+0006fb70: 795f 6466 5b20 7374 7564 795f 6466 5b27  y_df[ study_df['
+0006fb80: 6d6f 6461 6c69 7479 275d 203d 3d20 2754  modality'] == 'T
+0006fb90: 3177 275d 0a20 2020 2062 6164 6e61 6d65  1w'].    badname
+0006fba0: 7320 3d20 6765 745f 6e61 6d65 735f 6672  s = get_names_fr
+0006fbb0: 6f6d 5f64 6174 615f 6672 616d 6528 205b  om_data_frame( [
+0006fbc0: 2755 6e6e 616d 6564 275d 2c20 6466 2029  'Unnamed'], df )
+0006fbd0: 0a20 2020 2064 663d 6466 2e64 726f 7028  .    df=df.drop(
+0006fbe0: 6261 646e 616d 6573 2c20 6178 6973 3d31  badnames, axis=1
+0006fbf0: 290a 2020 2020 2320 7072 6566 696c 7465  ).    # prefilte
+0006fc00: 7220 6466 2066 6f72 2064 6174 6120 7468  r df for data th
+0006fc10: 6174 2065 7869 7374 730a 2020 2020 6b65  at exists.    ke
+0006fc20: 6570 203d 206e 702e 7469 6c65 2820 4661  ep = np.tile( Fa
+0006fc30: 6c73 652c 2064 662e 7368 6170 655b 305d  lse, df.shape[0]
+0006fc40: 2029 0a20 2020 2066 6f72 2078 2069 6e20   ).    for x in 
+0006fc50: 7261 6e67 6528 6466 2e73 6861 7065 5b30  range(df.shape[0
+0006fc60: 5d29 3a0a 2020 2020 2020 2020 6d79 666e  ]):.        myfn
+0006fc70: 203d 206f 732e 7061 7468 2e62 6173 656e   = os.path.basen
+0006fc80: 616d 6528 2064 665b 2766 696c 656e 616d  ame( df['filenam
+0006fc90: 6527 5d2e 696c 6f63 5b78 5d20 290a 2020  e'].iloc[x] ).  
+0006fca0: 2020 2020 2020 7465 6d70 203d 206d 7966        temp = myf
+0006fcb0: 6e2e 7370 6c69 7428 2073 706c 6974 7365  n.split( splitse
+0006fcc0: 7020 290a 2020 2020 2020 2020 2320 4765  p ).        # Ge
+0006fcd0: 6e65 7261 6c69 7a65 6420 7365 6172 6368  neralized search
+0006fce0: 2070 6174 6873 0a20 2020 2020 2020 2073   paths.        s
+0006fcf0: 6964 3020 3d20 7374 7228 2074 656d 705b  id0 = str( temp[
+0006fd00: 315d 2029 0a20 2020 2020 2020 2073 6964  1] ).        sid
+0006fd10: 203d 2073 7472 2820 6466 5b73 7562 6a65   = str( df[subje
+0006fd20: 6374 5f63 6f6c 5d2e 696c 6f63 5b78 5d20  ct_col].iloc[x] 
+0006fd30: 290a 2020 2020 2020 2020 6966 2073 6964  ).        if sid
+0006fd40: 3020 213d 2073 6964 3a0a 2020 2020 2020  0 != sid:.      
+0006fd50: 2020 2020 2020 7761 726e 696e 6773 2e77        warnings.w
+0006fd60: 6172 6e28 224f 5554 4552 3a20 7468 6520  arn("OUTER: the 
+0006fd70: 6964 2064 6572 6976 6564 2066 726f 6d20  id derived from 
+0006fd80: 7468 6520 6669 6c65 6e61 6d65 2022 202b  the filename " +
+0006fd90: 2073 6964 3020 2b20 2220 646f 6573 206e   sid0 + " does n
+0006fda0: 6f74 206d 6174 6368 2074 6865 2069 6420  ot match the id 
+0006fdb0: 7374 6f72 6564 2069 6e20 7468 6520 6461  stored in the da
+0006fdc0: 7461 2066 7261 6d65 2022 202b 2073 6964  ta frame " + sid
+0006fdd0: 2029 0a20 2020 2020 2020 2020 2020 2077   ).            w
+0006fde0: 6172 6e69 6e67 732e 7761 726e 2820 2266  arnings.warn( "f
+0006fdf0: 696c 656e 616d 6520 6973 203a 2022 202b  ilename is : " +
+0006fe00: 2020 6d79 666e 2029 0a20 2020 2020 2020    myfn ).       
+0006fe10: 2020 2020 2077 6172 6e69 6e67 732e 7761       warnings.wa
+0006fe20: 726e 2820 2273 6964 2069 7320 3a20 2220  rn( "sid is : " 
+0006fe30: 2b20 7369 6420 290a 2020 2020 2020 2020  + sid ).        
+0006fe40: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
+0006fe50: 6e28 2022 7820 6973 203a 2022 202b 2073  n( "x is : " + s
+0006fe60: 7472 2878 2920 290a 2020 2020 2020 2020  tr(x) ).        
+0006fe70: 6d79 7072 6f6a 203d 2073 7472 2864 665b  myproj = str(df[
+0006fe80: 7072 6f6a 6563 745f 636f 6c5d 2e69 6c6f  project_col].ilo
+0006fe90: 635b 785d 290a 2020 2020 2020 2020 6d79  c[x]).        my
+0006fea0: 6461 7465 203d 2073 7472 2864 665b 6461  date = str(df[da
+0006feb0: 7465 5f63 6f6c 5d2e 696c 6f63 5b78 5d29  te_col].iloc[x])
+0006fec0: 0a20 2020 2020 2020 206d 7969 6420 3d20  .        myid = 
+0006fed0: 7374 7228 6466 5b69 6d61 6765 5f63 6f6c  str(df[image_col
+0006fee0: 5d2e 696c 6f63 5b78 5d29 0a20 2020 2020  ].iloc[x]).     
+0006fef0: 2020 2069 6620 7365 636f 6e64 5f73 706c     if second_spl
+0006ff00: 6974 3a0a 2020 2020 2020 2020 2020 2020  it:.            
+0006ff10: 6d79 6964 203d 206d 7969 642e 7370 6c69  myid = myid.spli
+0006ff20: 7428 222e 2229 5b30 5d0a 2020 2020 2020  t(".")[0].      
+0006ff30: 2020 7061 7468 5f74 656d 706c 6174 6520    path_template 
+0006ff40: 3d20 6261 7365 5f70 6174 6820 2b20 222f  = base_path + "/
+0006ff50: 2220 2b20 6d79 7072 6f6a 202b 2020 222f  " + myproj +  "/
+0006ff60: 2220 2b20 7369 6420 2b20 222f 2220 2b20  " + sid + "/" + 
+0006ff70: 6d79 6461 7465 202b 2027 2f27 202b 2068  mydate + '/' + h
+0006ff80: 6965 7276 6172 6961 626c 6520 2b20 272f  iervariable + '/
+0006ff90: 2720 2b20 7374 7228 6d79 6964 2920 2b20  ' + str(myid) + 
+0006ffa0: 222f 220a 2020 2020 2020 2020 6869 6572  "/".        hier
+0006ffb0: 666e 203d 2073 6f72 7465 6428 676c 6f62  fn = sorted(glob
+0006ffc0: 2820 7061 7468 5f74 656d 706c 6174 6520  ( path_template 
+0006ffd0: 2b20 222a 2220 2b20 6869 6572 7661 7269  + "*" + hiervari
+0006ffe0: 6162 6c65 202b 2022 2a77 6964 652e 6373  able + "*wide.cs
+0006fff0: 7622 2029 2029 0a20 2020 2020 2020 2069  v" ) ).        i
+00070000: 6620 6c65 6e28 2068 6965 7266 6e20 2920  f len( hierfn ) 
+00070010: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+00070020: 2020 7072 696e 7428 2068 6965 7266 6e20    print( hierfn 
+00070030: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
+00070040: 696e 7428 2070 6174 685f 7465 6d70 6c61  int( path_templa
+00070050: 7465 2029 0a20 2020 2020 2020 2020 2020  te ).           
+00070060: 2070 7269 6e74 2820 6d79 7072 6f6a 2029   print( myproj )
+00070070: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+00070080: 6e74 2820 7369 6420 290a 2020 2020 2020  nt( sid ).      
+00070090: 2020 2020 2020 7072 696e 7428 206d 7964        print( myd
+000700a0: 6174 6520 2920 0a20 2020 2020 2020 2020  ate ) .         
+000700b0: 2020 2070 7269 6e74 2820 6d79 6964 2029     print( myid )
+000700c0: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+000700d0: 2068 6965 7266 6e20 2920 3e20 303a 0a20   hierfn ) > 0:. 
+000700e0: 2020 2020 2020 2020 2020 206b 6565 705b             keep[
+000700f0: 785d 3d54 7275 650a 0a20 2020 2023 2064  x]=True..    # d
+00070100: 663d 6466 5b6b 6565 705d 0a20 2020 2069  f=df[keep].    i
+00070110: 6620 6466 2e73 6861 7065 5b30 5d20 3d3d  f df.shape[0] ==
+00070120: 2030 3a0a 2020 2020 2020 2020 7761 726e   0:.        warn
+00070130: 696e 6773 2e77 6172 6e28 2269 6e70 7574  ings.warn("input
+00070140: 2064 6174 6120 6672 616d 6520 7368 6170   data frame shap
+00070150: 6520 6973 2066 696c 7465 7265 6420 646f  e is filtered do
+00070160: 776e 2074 6f20 7a65 726f 2229 0a20 2020  wn to zero").   
+00070170: 2020 2020 2072 6574 7572 6e20 6466 0a0a       return df..
+00070180: 2020 2020 6966 206e 6f74 2064 662e 696e      if not df.in
+00070190: 6465 782e 6973 5f75 6e69 7175 653a 0a20  dex.is_unique:. 
+000701a0: 2020 2020 2020 2077 6172 6e69 6e67 732e         warnings.
+000701b0: 7761 726e 2822 6461 7461 2066 7261 6d65  warn("data frame
+000701c0: 2064 6f65 7320 6e6f 7420 6861 7665 2075   does not have u
+000701d0: 6e69 7175 6520 696e 6469 6365 732e 2020  nique indices.  
+000701e0: 7765 2074 6865 7265 666f 7265 2072 6573  we therefore res
+000701f0: 6574 2074 6865 2069 6e64 6578 2074 6f20  et the index to 
+00070200: 616c 6c6f 7720 7468 6520 6675 6e63 7469  allow the functi
+00070210: 6f6e 2074 6f20 636f 6e74 696e 7565 206f  on to continue o
+00070220: 6e2e 2220 290a 2020 2020 2020 2020 6466  n." ).        df
+00070230: 203d 2064 662e 7265 7365 745f 696e 6465   = df.reset_inde
+00070240: 7828 290a 0a20 2020 200a 2020 2020 6966  x()..    .    if
+00070250: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+00070260: 2020 7072 696e 7428 2022 6f72 6967 696e    print( "origin
+00070270: 616c 2069 6e70 7574 2068 6164 2073 6861  al input had sha
+00070280: 7065 2022 202b 2073 7472 2820 6466 2e73  pe " + str( df.s
+00070290: 6861 7065 5b30 5d20 2920 2b20 2220 2854  hape[0] ) + " (T
+000702a0: 3120 6f6e 6c79 2920 616e 6420 7765 2066  1 only) and we f
+000702b0: 696e 6420 2220 2b20 7374 7228 2028 6b65  ind " + str( (ke
+000702c0: 6570 292e 7375 6d28 2920 2920 2b20 2220  ep).sum() ) + " 
+000702d0: 7769 7468 2068 6965 7261 7263 6869 6361  with hierarchica
+000702e0: 6c20 6f75 7470 7574 2064 6566 696e 6564  l output defined
+000702f0: 2062 7920 7661 7269 6162 6c65 3a20 2220   by variable: " 
+00070300: 2b20 6869 6572 7661 7269 6162 6c65 2029  + hiervariable )
+00070310: 0a20 2020 2020 2020 2070 7269 6e74 2820  .        print( 
+00070320: 6466 2e73 6861 7065 2029 0a0a 2020 2020  df.shape )..    
+00070330: 6466 6f75 7420 3d20 7064 2e44 6174 6146  dfout = pd.DataF
+00070340: 7261 6d65 2829 0a20 2020 206d 7963 7420  rame().    myct 
+00070350: 3d20 300a 2020 2020 666f 7220 7820 696e  = 0.    for x in
+00070360: 2072 616e 6765 2820 6466 2e73 6861 7065   range( df.shape
+00070370: 5b30 5d29 3a0a 2020 2020 2020 2020 6966  [0]):.        if
+00070380: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+00070390: 2020 2020 2020 7072 696e 7428 225c 6e5c        print("\n\
+000703a0: 6e2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  n---------------
+000703b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000703c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000703d0: 2d2d 2229 0a20 2020 2020 2020 2020 2020  --").           
+000703e0: 2070 7269 6e74 2866 227b 787d 2e2e 2e22   print(f"{x}..."
+000703f0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00070400: 2020 2020 2020 2020 2020 2020 7072 6f67              prog
+00070410: 7265 7373 5f72 6570 6f72 7465 7228 782c  ress_reporter(x,
+00070420: 2064 662e 7368 6170 655b 305d 2c20 7769   df.shape[0], wi
+00070430: 6474 683d 3530 3029 0a20 2020 2020 2020  dth=500).       
+00070440: 206c 6f63 696e 6420 3d20 6466 2e69 6e64   locind = df.ind
+00070450: 6578 5b78 5d0a 2020 2020 2020 2020 6d79  ex[x].        my
+00070460: 666e 203d 206f 732e 7061 7468 2e62 6173  fn = os.path.bas
+00070470: 656e 616d 6528 2064 665b 2766 696c 656e  ename( df['filen
+00070480: 616d 6527 5d2e 696c 6f63 5b78 5d20 290a  ame'].iloc[x] ).
+00070490: 2020 2020 2020 2020 7369 6420 3d20 7374          sid = st
+000704a0: 7228 2064 665b 7375 626a 6563 745f 636f  r( df[subject_co
+000704b0: 6c5d 2e69 6c6f 635b 785d 2029 0a20 2020  l].iloc[x] ).   
+000704c0: 2020 2020 2074 656d 7042 203d 206d 7966       tempB = myf
+000704d0: 6e2e 7370 6c69 7428 2073 706c 6974 7365  n.split( splitse
+000704e0: 7020 290a 2020 2020 2020 2020 7369 6430  p ).        sid0
+000704f0: 203d 2073 7472 2874 656d 7042 5b31 5d29   = str(tempB[1])
+00070500: 0a20 2020 2020 2020 2069 6620 7369 6430  .        if sid0
+00070510: 2021 3d20 7369 6420 616e 6420 7665 7262   != sid and verb
+00070520: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+00070530: 2077 6172 6e69 6e67 732e 7761 726e 2822   warnings.warn("
+00070540: 494e 4e45 523a 2074 6865 2069 6420 6465  INNER: the id de
+00070550: 7269 7665 6420 6672 6f6d 2074 6865 2066  rived from the f
+00070560: 696c 656e 616d 6520 2220 2b20 7374 7228  ilename " + str(
+00070570: 7369 6429 202b 2022 2064 6f65 7320 6e6f  sid) + " does no
+00070580: 7420 6d61 7463 6820 7468 6520 6964 2073  t match the id s
+00070590: 746f 7265 6420 696e 2074 6865 2064 6174  tored in the dat
+000705a0: 6120 6672 616d 6520 2220 2b20 7374 7228  a frame " + str(
+000705b0: 7369 6430 2920 290a 2020 2020 2020 2020  sid0) ).        
+000705c0: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
+000705d0: 6e28 2022 6669 6c65 6e61 6d65 2069 7320  n( "filename is 
+000705e0: 3a20 2220 2b20 2073 7472 286d 7966 6e29  : " +  str(myfn)
+000705f0: 2029 0a20 2020 2020 2020 2020 2020 2077   ).            w
+00070600: 6172 6e69 6e67 732e 7761 726e 2820 2273  arnings.warn( "s
+00070610: 6964 2069 7320 3a20 2220 2b20 7374 7228  id is : " + str(
+00070620: 7369 6429 2029 0a20 2020 2020 2020 2020  sid) ).         
+00070630: 2020 2077 6172 6e69 6e67 732e 7761 726e     warnings.warn
+00070640: 2820 2278 2069 7320 3a20 2220 2b20 7374  ( "x is : " + st
+00070650: 7228 7829 2029 0a20 2020 2020 2020 2020  r(x) ).         
+00070660: 2020 2077 6172 6e69 6e67 732e 7761 726e     warnings.warn
+00070670: 2820 2269 6e64 6578 2069 7320 3a20 2220  ( "index is : " 
+00070680: 2b20 7374 7228 6c6f 6369 6e64 2920 290a  + str(locind) ).
+00070690: 2020 2020 2020 2020 6d79 7072 6f6a 203d          myproj =
+000706a0: 2073 7472 2864 665b 7072 6f6a 6563 745f   str(df[project_
+000706b0: 636f 6c5d 2e69 6c6f 635b 785d 290a 2020  col].iloc[x]).  
+000706c0: 2020 2020 2020 6d79 6461 7465 203d 2073        mydate = s
+000706d0: 7472 2864 665b 6461 7465 5f63 6f6c 5d2e  tr(df[date_col].
+000706e0: 696c 6f63 5b78 5d29 0a20 2020 2020 2020  iloc[x]).       
+000706f0: 206d 7969 6420 3d20 7374 7228 6466 5b69   myid = str(df[i
+00070700: 6d61 6765 5f63 6f6c 5d2e 696c 6f63 5b78  mage_col].iloc[x
+00070710: 5d29 0a20 2020 2020 2020 2069 6620 7365  ]).        if se
+00070720: 636f 6e64 5f73 706c 6974 3a0a 2020 2020  cond_split:.    
+00070730: 2020 2020 2020 2020 6d79 6964 203d 206d          myid = m
+00070740: 7969 642e 7370 6c69 7428 222e 2229 5b30  yid.split(".")[0
+00070750: 5d0a 2020 2020 2020 2020 6966 2076 6572  ].        if ver
+00070760: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+00070770: 2020 7072 696e 7428 206d 7966 6e20 290a    print( myfn ).
+00070780: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00070790: 7428 2074 656d 7020 290a 2020 2020 2020  t( temp ).      
+000707a0: 2020 2020 2020 7072 696e 7428 2022 6964        print( "id
+000707b0: 2022 202b 2073 6964 2020 290a 2020 2020   " + sid  ).    
+000707c0: 2020 2020 7061 7468 5f74 656d 706c 6174      path_templat
+000707d0: 6520 3d20 6261 7365 5f70 6174 6820 2b20  e = base_path + 
+000707e0: 222f 2220 2b20 6d79 7072 6f6a 202b 2020  "/" + myproj +  
+000707f0: 222f 2220 2b20 7369 6420 2b20 222f 2220  "/" + sid + "/" 
+00070800: 2b20 6d79 6461 7465 202b 2027 2f27 202b  + mydate + '/' +
+00070810: 2068 6965 7276 6172 6961 626c 6520 2b20   hiervariable + 
+00070820: 272f 2720 2b20 7374 7228 6d79 6964 2920  '/' + str(myid) 
+00070830: 2b20 222f 220a 2020 2020 2020 2020 7365  + "/".        se
+00070840: 6172 6368 6869 6572 203d 2070 6174 685f  archhier = path_
+00070850: 7465 6d70 6c61 7465 202b 2022 2a22 202b  template + "*" +
+00070860: 2068 6965 7276 6172 6961 626c 6520 2b20   hiervariable + 
+00070870: 222a 7769 6465 2e63 7376 220a 2020 2020  "*wide.csv".    
+00070880: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
+00070890: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+000708a0: 7428 2073 6561 7263 6868 6965 7220 290a  t( searchhier ).
+000708b0: 2020 2020 2020 2020 6869 6572 666e 203d          hierfn =
+000708c0: 2073 6f72 7465 6428 2067 6c6f 6228 2073   sorted( glob( s
+000708d0: 6561 7263 6868 6965 7220 2920 290a 2020  earchhier ) ).  
+000708e0: 2020 2020 2020 6966 206c 656e 2820 6869        if len( hi
+000708f0: 6572 666e 2029 203e 2031 3a0a 2020 2020  erfn ) > 1:.    
+00070900: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00070910: 6c75 6545 7272 6f72 2822 7468 6572 6520  lueError("there 
+00070920: 6172 6520 2220 2b20 7374 7228 206c 656e  are " + str( len
+00070930: 2820 6869 6572 666e 2029 2029 202b 2022  ( hierfn ) ) + "
+00070940: 206e 756d 6265 7220 6f66 2068 6965 7220   number of hier 
+00070950: 666e 7320 7769 7468 2073 6561 7263 6820  fns with search 
+00070960: 7061 7468 2022 202b 2073 6561 7263 6868  path " + searchh
+00070970: 6965 7220 290a 2020 2020 2020 2020 6966  ier ).        if
+00070980: 206c 656e 2820 6869 6572 666e 2029 203d   len( hierfn ) =
+00070990: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
+000709a0: 2068 6466 3d74 3164 663d 6474 6466 3d72   hdf=t1df=dtdf=r
+000709b0: 7364 663d 7065 7266 6466 3d6e 6d64 663d  sdf=perfdf=nmdf=
+000709c0: 666c 6169 7264 663d 4e6f 6e65 0a20 2020  flairdf=None.   
+000709d0: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
+000709e0: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+000709f0: 2020 2020 2070 7269 6e74 2868 6965 7266       print(hierf
+00070a00: 6e29 0a20 2020 2020 2020 2020 2020 2068  n).            h
+00070a10: 6466 203d 2070 642e 7265 6164 5f63 7376  df = pd.read_csv
+00070a20: 2868 6965 7266 6e5b 305d 290a 2020 2020  (hierfn[0]).    
+00070a30: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+00070a40: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00070a50: 2020 2020 7072 696e 7428 2068 6466 5b27      print( hdf['
+00070a60: 766f 6c5f 6865 6d69 7370 6865 7265 5f6c  vol_hemisphere_l
+00070a70: 6566 7468 656d 6973 7068 6572 6573 275d  efthemispheres']
+00070a80: 2029 0a20 2020 2020 2020 2020 2020 2062   ).            b
+00070a90: 6164 6e61 6d65 7320 3d20 6765 745f 6e61  adnames = get_na
+00070aa0: 6d65 735f 6672 6f6d 5f64 6174 615f 6672  mes_from_data_fr
+00070ab0: 616d 6528 205b 2755 6e6e 616d 6564 275d  ame( ['Unnamed']
+00070ac0: 2c20 6864 6620 290a 2020 2020 2020 2020  , hdf ).        
+00070ad0: 2020 2020 6864 663d 6864 662e 6472 6f70      hdf=hdf.drop
+00070ae0: 2862 6164 6e61 6d65 732c 2061 7869 733d  (badnames, axis=
+00070af0: 3129 0a20 2020 2020 2020 2020 2020 206e  1).            n
+00070b00: 756d 7320 3d20 5b69 7369 6e73 7461 6e63  ums = [isinstanc
+00070b10: 6528 6864 665b 636f 6c5d 2e69 6c6f 635b  e(hdf[col].iloc[
+00070b20: 305d 2c20 2869 6e74 2c20 666c 6f61 7429  0], (int, float)
+00070b30: 2920 666f 7220 636f 6c20 696e 2068 6466  ) for col in hdf
+00070b40: 2e63 6f6c 756d 6e73 5d0a 2020 2020 2020  .columns].      
+00070b50: 2020 2020 2020 636f 7265 6e61 6d65 7320        corenames 
+00070b60: 3d20 6c69 7374 286e 702e 6172 7261 7928  = list(np.array(
+00070b70: 6864 662e 636f 6c75 6d6e 7329 5b6e 756d  hdf.columns)[num
+00070b80: 735d 290a 2020 2020 2020 2020 2020 2020  s]).            
+00070b90: 2320 6864 662e 6c6f 635b 3a2c 206e 756d  # hdf.loc[:, num
+00070ba0: 735d 203d 2068 6466 2e6c 6f63 5b3a 2c20  s] = hdf.loc[:, 
+00070bb0: 6e75 6d73 5d2e 6164 645f 7072 6566 6978  nums].add_prefix
+00070bc0: 2822 5431 4869 6572 5f22 290a 2020 2020  ("T1Hier_").    
+00070bd0: 2020 2020 2020 2020 6864 6620 3d20 6864          hdf = hd
+00070be0: 662e 6164 645f 7072 6566 6978 2822 5431  f.add_prefix("T1
+00070bf0: 4869 6572 5f22 290a 2020 2020 2020 2020  Hier_").        
+00070c00: 2020 2020 6d79 6374 203d 206d 7963 7420      myct = myct 
+00070c10: 2b20 310a 2020 2020 2020 2020 2020 2020  + 1.            
+00070c20: 6466 6c69 7374 203d 205b 6864 665d 0a0a  dflist = [hdf]..
+00070c30: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00070c40: 6d79 6d6f 6420 696e 2076 6d6f 6464 6963  mymod in vmoddic
+00070c50: 742e 6b65 7973 2829 3a0a 2020 2020 2020  t.keys():.      
+00070c60: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+00070c70: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+00070c80: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00070c90: 225c 6e5c 6e2a 2a2a 2a2a 2a2a 2a2a 2a2a  "\n\n***********
+00070ca0: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2022  ************** "
+00070cb0: 202b 206d 796d 6f64 202b 2022 202a 2a2a   + mymod + " ***
+00070cc0: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ****************
+00070cd0: 2a2a 2a2a 2a2a 2229 0a20 2020 2020 2020  ******").       
+00070ce0: 2020 2020 2020 2020 206d 6f64 616c 6974           modalit
+00070cf0: 7963 6c61 7373 203d 2076 6d6f 6464 6963  yclass = vmoddic
+00070d00: 745b 206d 796d 6f64 205d 0a20 2020 2020  t[ mymod ].     
+00070d10: 2020 2020 2020 2020 2020 2069 6620 7769             if wi
+00070d20: 6c64 5f63 6172 645f 6d6f 6461 6c69 7479  ld_card_modality
+00070d30: 5f69 643a 0a20 2020 2020 2020 2020 2020  _id:.           
+00070d40: 2020 2020 2020 2020 206d 796d 6f64 6964           mymodid
+00070d50: 203d 2027 2a27 0a20 2020 2020 2020 2020   = '*'.         
+00070d60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00070d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070d80: 206d 796d 6f64 6964 203d 2073 7472 2820   mymodid = str( 
+00070d90: 6466 5b6d 796d 6f64 5d2e 696c 6f63 5b78  df[mymod].iloc[x
+00070da0: 5d20 290a 2020 2020 2020 2020 2020 2020  ] ).            
+00070db0: 2020 2020 2020 2020 6966 206d 796d 6f64          if mymod
+00070dc0: 6964 2e6c 6f77 6572 2829 2021 3d20 226e  id.lower() != "n
+00070dd0: 616e 2220 616e 6420 6d79 6d6f 6469 642e  an" and mymodid.
+00070de0: 6c6f 7765 7228 2920 213d 2022 6e61 223a  lower() != "na":
+00070df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00070e00: 2020 2020 2020 2020 206d 796d 6f64 6964           mymodid
+00070e10: 203d 206f 732e 7061 7468 2e62 6173 656e   = os.path.basen
+00070e20: 616d 6528 206d 796d 6f64 6964 2029 0a20  ame( mymodid ). 
+00070e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070e40: 2020 2020 2020 206d 796d 6f64 6964 203d         mymodid =
+00070e50: 206f 732e 7061 7468 2e73 706c 6974 6578   os.path.splitex
+00070e60: 7428 206d 796d 6f64 6964 2029 5b30 5d0a  t( mymodid )[0].
+00070e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070e80: 2020 2020 2020 2020 6d79 6d6f 6469 6420          mymodid 
+00070e90: 3d20 6f73 2e70 6174 682e 7370 6c69 7465  = os.path.splite
+00070ea0: 7874 2820 6d79 6d6f 6469 6420 295b 305d  xt( mymodid )[0]
+00070eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00070ec0: 2020 2020 2020 2020 2074 656d 7020 3d20           temp = 
+00070ed0: 6d79 6d6f 6469 642e 7370 6c69 7428 2069  mymodid.split( i
+00070ee0: 6473 6570 2029 0a20 2020 2020 2020 2020  dsep ).         
+00070ef0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00070f00: 796d 6f64 6964 203d 2074 656d 705b 206c  ymodid = temp[ l
+00070f10: 656e 2820 7465 6d70 2029 2d31 205d 0a20  en( temp )-1 ]. 
+00070f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070f30: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00070f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070f50: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+00070f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070f70: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
+00070f80: 6d69 7373 696e 6722 290a 2020 2020 2020  missing").      
+00070f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070fa0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+00070fb0: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
+00070fc0: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
+00070fd0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00070fe0: 2820 226d 6f64 616c 6974 7920 6964 2069  ( "modality id i
+00070ff0: 7320 2220 2b20 6d79 6d6f 6469 6420 2b20  s " + mymodid + 
+00071000: 2220 666f 7220 6d6f 6461 6c69 7479 2022  " for modality "
+00071010: 202b 206d 6f64 616c 6974 7963 6c61 7373   + modalityclass
+00071020: 202b 2027 206d 6f64 616c 6974 7920 7370   + ' modality sp
+00071030: 6563 6966 6963 2073 7562 6a20 2720 2b20  ecific subj ' + 
+00071040: 7369 6420 2b20 2720 6d6f 6461 6c69 7479  sid + ' modality
+00071050: 2073 7065 6369 6669 6320 6964 2069 7320   specific id is 
+00071060: 2720 2b20 6d79 6964 202b 2022 2069 7473  ' + myid + " its
+00071070: 2064 6174 6520 2220 2b20 206d 7964 6174   date " +  mydat
+00071080: 6520 290a 2020 2020 2020 2020 2020 2020  e ).            
+00071090: 2020 2020 6d6f 6461 6c69 7479 636c 6173      modalityclas
+000710a0: 7373 6561 7263 6820 3d20 6d6f 6461 6c69  ssearch = modali
+000710b0: 7479 636c 6173 730a 2020 2020 2020 2020  tyclass.        
+000710c0: 2020 2020 2020 2020 6966 206d 6f64 616c          if modal
+000710d0: 6974 7963 6c61 7373 2069 6e20 5b27 7273  ityclass in ['rs
+000710e0: 664d 5249 272c 2744 5449 275d 3a0a 2020  fMRI','DTI']:.  
+000710f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00071100: 2020 6d6f 6461 6c69 7479 636c 6173 7373    modalityclasss
+00071110: 6561 7263 683d 6d6f 6461 6c69 7479 636c  earch=modalitycl
+00071120: 6173 732b 222a 220a 2020 2020 2020 2020  ass+"*".        
+00071130: 2020 2020 2020 2020 7061 7468 5f74 656d          path_tem
+00071140: 706c 6174 655f 6d20 3d20 6261 7365 5f70  plate_m = base_p
+00071150: 6174 6820 2b20 222f 2220 2b20 6d79 7072  ath + "/" + mypr
+00071160: 6f6a 202b 2020 222f 2220 2b20 7369 6420  oj +  "/" + sid 
+00071170: 2b20 222f 2220 2b20 6d79 6461 7465 202b  + "/" + mydate +
+00071180: 2027 2f27 202b 206d 6f64 616c 6974 7963   '/' + modalityc
+00071190: 6c61 7373 7365 6172 6368 202b 2027 2f27  lasssearch + '/'
+000711a0: 202b 206d 796d 6f64 6964 202b 2022 2f22   + mymodid + "/"
+000711b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000711c0: 206d 6f64 7365 6172 6368 203d 2070 6174   modsearch = pat
+000711d0: 685f 7465 6d70 6c61 7465 5f6d 202b 2022  h_template_m + "
+000711e0: 2a22 202b 206d 6f64 616c 6974 7963 6c61  *" + modalitycla
+000711f0: 7373 7365 6172 6368 202b 2022 2a77 6964  sssearch + "*wid
+00071200: 652e 6373 7622 0a20 2020 2020 2020 2020  e.csv".         
+00071210: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+00071220: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00071230: 2020 2020 2020 2070 7269 6e74 2820 6d6f         print( mo
+00071240: 6473 6561 7263 6820 290a 2020 2020 2020  dsearch ).      
+00071250: 2020 2020 2020 2020 2020 7431 7766 6e20            t1wfn 
+00071260: 3d20 736f 7274 6564 2820 676c 6f62 2820  = sorted( glob( 
+00071270: 6d6f 6473 6561 7263 6820 2920 290a 2020  modsearch ) ).  
+00071280: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00071290: 206c 656e 2820 7431 7766 6e20 2920 3e20   len( t1wfn ) > 
+000712a0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+000712b0: 2020 2020 2020 206e 6c61 7267 6520 3d20         nlarge = 
+000712c0: 6c65 6e28 7431 7766 6e29 0a20 2020 2020  len(t1wfn).     
+000712d0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000712e0: 3177 666e 203d 2066 696e 645f 6d6f 7374  1wfn = find_most
+000712f0: 5f72 6563 656e 745f 6669 6c65 2820 7431  _recent_file( t1
+00071300: 7766 6e20 290a 2020 2020 2020 2020 2020  wfn ).          
+00071310: 2020 2020 2020 2020 2020 7761 726e 696e            warnin
+00071320: 6773 2e77 6172 6e28 2274 6865 7265 2061  gs.warn("there a
+00071330: 7265 2022 202b 2073 7472 2820 6e6c 6172  re " + str( nlar
+00071340: 6765 2029 202b 2022 206e 756d 6265 7220  ge ) + " number 
+00071350: 6f66 2077 6964 6520 666e 7320 7769 7468  of wide fns with
+00071360: 2073 6561 7263 6820 7061 7468 2022 202b   search path " +
+00071370: 206d 6f64 7365 6172 6368 202b 2022 2077   modsearch + " w
+00071380: 6520 7461 6b65 2074 6865 206d 6f73 7420  e take the most 
+00071390: 7265 6365 6e74 206f 6620 7468 6573 6520  recent of these 
+000713a0: 2220 2b20 7431 7766 6e5b 305d 2029 0a20  " + t1wfn[0] ). 
+000713b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000713c0: 6620 6c65 6e28 2074 3177 666e 2029 203d  f len( t1wfn ) =
+000713d0: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
+000713e0: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
+000713f0: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+00071400: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00071410: 6e74 2874 3177 666e 290a 2020 2020 2020  nt(t1wfn).      
+00071420: 2020 2020 2020 2020 2020 2020 2020 7431                t1
+00071430: 6466 203d 206d 7972 6561 645f 6373 7628  df = myread_csv(
+00071440: 7431 7766 6e5b 305d 2c20 636f 7265 6e61  t1wfn[0], corena
+00071450: 6d65 7329 0a20 2020 2020 2020 2020 2020  mes).           
+00071460: 2020 2020 2020 2020 2074 3164 6620 3d20           t1df = 
+00071470: 6669 6c74 6572 5f64 6628 2074 3164 662c  filter_df( t1df,
+00071480: 206d 6f64 616c 6974 7963 6c61 7373 2b27   modalityclass+'
+00071490: 5f27 290a 2020 2020 2020 2020 2020 2020  _').            
+000714a0: 2020 2020 2020 2020 6466 6c69 7374 203d          dflist =
+000714b0: 2064 666c 6973 7420 2b20 5b74 3164 665d   dflist + [t1df]
+000714c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000714d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000714e0: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
+000714f0: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
+00071500: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00071510: 7269 6e74 2820 2220 6361 6e6e 6f74 2066  rint( " cannot f
+00071520: 696e 6420 2220 2b20 6d6f 6473 6561 7263  ind " + modsearc
+00071530: 6820 290a 2020 2020 2020 2020 2020 2020  h ).            
+00071540: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+00071550: 2068 6466 203d 2070 642e 636f 6e63 6174   hdf = pd.concat
+00071560: 2820 6466 6c69 7374 2c20 6178 6973 3d31  ( dflist, axis=1
+00071570: 2c20 6967 6e6f 7265 5f69 6e64 6578 3d46  , ignore_index=F
+00071580: 616c 7365 290a 2020 2020 2020 2020 2020  alse).          
+00071590: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+000715a0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000715b0: 696e 7428 2022 636f 756e 743a 2022 202b  int( "count: " +
+000715c0: 2073 7472 2820 6d79 6374 2029 2029 0a20   str( myct ) ). 
+000715d0: 2020 2020 2020 2020 2020 2073 7562 6466             subdf
+000715e0: 203d 2064 662e 696c 6f63 5b5b 785d 5d0a   = df.iloc[[x]].
+000715f0: 2020 2020 2020 2020 2020 2020 6864 662e              hdf.
+00071600: 696e 6465 7820 3d20 7375 6264 662e 696e  index = subdf.in
+00071610: 6465 782e 636f 7079 2829 0a20 2020 2020  dex.copy().     
+00071620: 2020 2020 2020 2073 7562 6466 203d 2070         subdf = p
+00071630: 642e 636f 6e63 6174 2820 5b73 7562 6466  d.concat( [subdf
+00071640: 2c68 6466 5d2c 2061 7869 733d 312c 2069  ,hdf], axis=1, i
+00071650: 676e 6f72 655f 696e 6465 783d 4661 6c73  gnore_index=Fals
+00071660: 6529 0a20 2020 2020 2020 2020 2020 2064  e).            d
+00071670: 666f 7574 203d 2070 642e 636f 6e63 6174  fout = pd.concat
+00071680: 2820 5b64 666f 7574 2c73 7562 6466 5d2c  ( [dfout,subdf],
+00071690: 2061 7869 733d 302c 2069 676e 6f72 655f   axis=0, ignore_
+000716a0: 696e 6465 783d 4661 6c73 6520 290a 0a20  index=False ).. 
+000716b0: 2020 2069 6620 6466 6f75 742e 7368 6170     if dfout.shap
+000716c0: 655b 305d 203e 2030 3a0a 2020 2020 2020  e[0] > 0:.      
+000716d0: 2020 6261 646e 616d 6573 203d 2067 6574    badnames = get
+000716e0: 5f6e 616d 6573 5f66 726f 6d5f 6461 7461  _names_from_data
+000716f0: 5f66 7261 6d65 2820 5b27 556e 6e61 6d65  _frame( ['Unname
+00071700: 6427 5d2c 2064 666f 7574 2029 0a20 2020  d'], dfout ).   
+00071710: 2020 2020 2064 666f 7574 3d64 666f 7574       dfout=dfout
+00071720: 2e64 726f 7028 6261 646e 616d 6573 2c20  .drop(badnames, 
+00071730: 6178 6973 3d31 290a 2020 2020 7265 7475  axis=1).    retu
+00071740: 726e 2064 666f 7574 0a0a 6465 6620 656e  rn dfout..def en
+00071750: 616e 7469 6f6d 6f72 7068 6963 5f66 696c  antiomorphic_fil
+00071760: 6c69 6e67 5f77 6974 686f 7574 5f6d 6173  ling_without_mas
+00071770: 6b28 2069 6d61 6765 2c20 6178 6973 3d30  k( image, axis=0
+00071780: 2c20 696e 7465 6e73 6974 793d 276c 6f77  , intensity='low
+00071790: 2720 293a 0a20 2020 2022 2222 0a20 2020  ' ):.    """.   
+000717a0: 2050 6572 666f 726d 2061 6e20 656e 616e   Perform an enan
+000717b0: 7469 6f6d 6f72 7068 6963 206c 6573 696f  tiomorphic lesio
+000717c0: 6e20 6669 6c6c 696e 6720 6f6e 2061 6e20  n filling on an 
+000717d0: 696d 6167 6520 7769 7468 6f75 7420 6120  image without a 
+000717e0: 6c65 7369 6f6e 206d 6173 6b2e 0a0a 2020  lesion mask...  
+000717f0: 2020 4172 6773 3a0a 2020 2020 696d 6167    Args:.    imag
+00071800: 6520 2861 6e74 7349 6d61 6765 293a 2054  e (antsImage): T
+00071810: 6865 2061 6e74 7320 696d 6167 6520 746f  he ants image to
+00071820: 2066 6c69 7020 616e 6420 6669 6c6c 0a20   flip and fill. 
+00071830: 2020 2061 7869 7320 2820 696e 7420 293a     axis ( int ):
+00071840: 2074 6865 2061 7869 7320 616c 6f6e 6720   the axis along 
+00071850: 7768 6963 6820 746f 2072 6566 6c65 6374  which to reflect
+00071860: 2074 6865 2069 6d61 6765 0a20 2020 2069   the image.    i
+00071870: 6e74 656e 7369 7479 2028 2073 7472 2029  ntensity ( str )
+00071880: 203a 206c 6f77 206f 7220 6869 6768 0a0a   : low or high..
+00071890: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+000718a0: 2061 6e74 732e 414e 5473 496d 6167 653a   ants.ANTsImage:
+000718b0: 2054 6865 2069 6d61 6765 2061 6674 6572   The image after
+000718c0: 2065 6e61 6e74 696f 6d6f 7270 6869 6320   enantiomorphic 
+000718d0: 6669 6c6c 696e 672e 0a20 2020 2022 2222  filling..    """
+000718e0: 0a20 2020 2069 6d61 6765 6e20 3d20 616e  .    imagen = an
+000718f0: 7473 2e69 4d61 7468 2820 696d 6167 652c  ts.iMath( image,
+00071900: 2027 4e6f 726d 616c 697a 6527 2029 0a20   'Normalize' ). 
+00071910: 2020 2069 6d61 6765 6e20 3d20 616e 7473     imagen = ants
+00071920: 2e69 4d61 7468 2820 696d 6167 656e 2c20  .iMath( imagen, 
+00071930: 2254 7275 6e63 6174 6549 6e74 656e 7369  "TruncateIntensi
+00071940: 7479 222c 2031 652d 362c 2030 2e39 3820  ty", 1e-6, 0.98 
+00071950: 290a 2020 2020 696d 6167 656e 203d 2061  ).    imagen = a
+00071960: 6e74 732e 694d 6174 6828 2069 6d61 6765  nts.iMath( image
+00071970: 6e2c 2027 4e6f 726d 616c 697a 6527 2029  n, 'Normalize' )
+00071980: 0a20 2020 2023 2043 7265 6174 6520 6120  .    # Create a 
+00071990: 6d69 7272 6f72 2069 6d61 6765 2028 666c  mirror image (fl
+000719a0: 6970 7069 6e67 206c 6566 7420 616e 6420  ipping left and 
+000719b0: 7269 6768 7429 0a20 2020 206d 6972 726f  right).    mirro
+000719c0: 725f 696d 6167 6520 3d20 616e 7473 2e72  r_image = ants.r
+000719d0: 6566 6c65 6374 5f69 6d61 6765 2869 6d61  eflect_image(ima
+000719e0: 6765 6e2c 2061 7869 733d 302c 2074 783d  gen, axis=0, tx=
+000719f0: 2753 794e 2720 295b 2777 6172 7065 646d  'SyN' )['warpedm
+00071a00: 6f76 6f75 7427 5d0a 0a20 2020 2023 2043  ovout']..    # C
+00071a10: 7265 6174 6520 6120 7379 6d6d 6574 7269  reate a symmetri
+00071a20: 6320 7665 7273 696f 6e20 6f66 2074 6865  c version of the
+00071a30: 2069 6d61 6765 2062 7920 6176 6572 6167   image by averag
+00071a40: 696e 6720 7468 6520 6f72 6967 696e 616c  ing the original
+00071a50: 2061 6e64 2074 6865 206d 6972 726f 7220   and the mirror 
+00071a60: 696d 6167 650a 2020 2020 7379 6d6d 6574  image.    symmet
+00071a70: 7269 635f 696d 6167 6520 3d20 696d 6167  ric_image = imag
+00071a80: 656e 202a 2030 2e35 202b 206d 6972 726f  en * 0.5 + mirro
+00071a90: 725f 696d 6167 6520 2a20 302e 350a 0a20  r_image * 0.5.. 
+00071aa0: 2020 2023 2049 6465 6e74 6966 7920 706f     # Identify po
+00071ab0: 7465 6e74 6961 6c20 6c65 7369 6f6e 2061  tential lesion a
+00071ac0: 7265 6173 2062 7920 6669 6e64 696e 6720  reas by finding 
+00071ad0: 6469 6666 6572 656e 6365 7320 6265 7477  differences betw
+00071ae0: 6565 6e20 7468 6520 6f72 6967 696e 616c  een the original
+00071af0: 2061 6e64 2073 796d 6d65 7472 6963 2069   and symmetric i
+00071b00: 6d61 6765 0a20 2020 2064 6966 6665 7265  mage.    differe
+00071b10: 6e63 655f 696d 6167 6520 3d20 696d 6167  nce_image = imag
+00071b20: 6520 2d20 7379 6d6d 6574 7269 635f 696d  e - symmetric_im
+00071b30: 6167 650a 2020 2020 6469 6666 7365 6720  age.    diffseg 
+00071b40: 3d20 616e 7473 2e74 6872 6573 686f 6c64  = ants.threshold
+00071b50: 5f69 6d61 6765 2864 6966 6665 7265 6e63  _image(differenc
+00071b60: 655f 696d 6167 652c 2022 4f74 7375 222c  e_image, "Otsu",
+00071b70: 2033 2029 0a20 2020 2069 6620 696e 7465   3 ).    if inte
+00071b80: 6e73 6974 7920 3d3d 2027 6c6f 7727 3a0a  nsity == 'low':.
+00071b90: 2020 2020 2020 2020 6c69 6b65 6c79 5f6c          likely_l
+00071ba0: 6573 696f 6e20 3d20 616e 7473 2e74 6872  esion = ants.thr
+00071bb0: 6573 686f 6c64 5f69 6d61 6765 2820 6469  eshold_image( di
+00071bc0: 6666 7365 672c 2031 2c20 2031 290a 2020  ffseg, 1,  1).  
+00071bd0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00071be0: 6c69 6b65 6c79 5f6c 6573 696f 6e20 3d20  likely_lesion = 
+00071bf0: 616e 7473 2e74 6872 6573 686f 6c64 5f69  ants.threshold_i
+00071c00: 6d61 6765 2820 6469 6666 7365 672c 2033  mage( diffseg, 3
+00071c10: 2c20 2033 290a 2020 2020 6c69 6b65 6c79  ,  3).    likely
+00071c20: 5f6c 6573 696f 6e20 3d20 616e 7473 2e73  _lesion = ants.s
+00071c30: 6d6f 6f74 685f 696d 6167 6528 206c 696b  mooth_image( lik
+00071c40: 656c 795f 6c65 7369 6f6e 2c20 332e 3020  ely_lesion, 3.0 
+00071c50: 292e 694d 6174 6828 224e 6f72 6d61 6c69  ).iMath("Normali
+00071c60: 7a65 2229 0a20 2020 206c 6573 696f 6e6e  ze").    lesionn
+00071c70: 6567 203d 2028 2069 6d61 6765 6e2a 302b  eg = ( imagen*0+
+00071c80: 312e 3020 2920 2d20 6c69 6b65 6c79 5f6c  1.0 ) - likely_l
+00071c90: 6573 696f 6e0a 2020 2020 6669 6c6c 6564  esion.    filled
+00071ca0: 5f69 6d61 6765 203d 2061 6e74 732e 696d  _image = ants.im
+00071cb0: 6167 655f 636c 6f6e 6528 696d 6167 656e  age_clone(imagen
+00071cc0: 2920 2020 200a 2020 2020 6669 6c6c 6564  )    .    filled
+00071cd0: 5f69 6d61 6765 203d 2069 6d61 6765 6e20  _image = imagen 
+00071ce0: 2a20 6c65 7369 6f6e 6e65 6720 2b20 6d69  * lesionneg + mi
+00071cf0: 7272 6f72 5f69 6d61 6765 202a 206c 696b  rror_image * lik
+00071d00: 656c 795f 6c65 7369 6f6e 0a0a 2020 2020  ely_lesion..    
+00071d10: 7265 7475 726e 2066 696c 6c65 645f 696d  return filled_im
+00071d20: 6167 652c 2064 6966 6673 6567 0a0a 0a0a  age, diffseg....
+00071d30: 6465 6620 6669 6c74 6572 5f69 6d61 6765  def filter_image
+00071d40: 5f66 696c 6573 2869 6d61 6765 5f70 6174  _files(image_pat
+00071d50: 6873 2c20 6372 6974 6572 6961 3d27 6c61  hs, criteria='la
+00071d60: 7267 6573 7427 293a 0a20 2020 2022 2222  rgest'):.    """
+00071d70: 0a20 2020 2046 696c 7465 7273 2061 206c  .    Filters a l
+00071d80: 6973 7420 6f66 2069 6d61 6765 2066 696c  ist of image fil
+00071d90: 6520 7061 7468 7320 6261 7365 6420 6f6e  e paths based on
+00071da0: 2073 7065 6369 6669 6564 2063 7269 7465   specified crite
+00071db0: 7269 6120 616e 6420 7265 7475 726e 7320  ria and returns 
+00071dc0: 0a20 2020 2074 6865 2070 6174 6820 6f66  .    the path of
+00071dd0: 2074 6865 2069 6d61 6765 2074 6861 7420   the image that 
+00071de0: 6265 7374 206d 6174 6368 6573 2074 6861  best matches tha
+00071df0: 7420 6372 6974 6572 6961 2028 736d 616c  t criteria (smal
+00071e00: 6c65 7374 2c20 6c61 7267 6573 742c 206f  lest, largest, o
+00071e10: 7220 6272 6967 6874 6573 7429 2e0a 0a20  r brightest)... 
+00071e20: 2020 2041 7267 733a 0a20 2020 2069 6d61     Args:.    ima
+00071e30: 6765 5f70 6174 6873 2028 6c69 7374 293a  ge_paths (list):
+00071e40: 2041 206c 6973 7420 6f66 2066 696c 6520   A list of file 
+00071e50: 7061 7468 7320 746f 2074 6865 2069 6d61  paths to the ima
+00071e60: 6765 732e 0a20 2020 2063 7269 7465 7269  ges..    criteri
+00071e70: 6120 2873 7472 293a 2043 7269 7465 7269  a (str): Criteri
+00071e80: 6120 666f 7220 7365 6c65 6374 696e 6720  a for selecting 
+00071e90: 7468 6520 696d 6167 6520 2827 736d 616c  the image ('smal
+00071ea0: 6c65 7374 272c 2027 6c61 7267 6573 7427  lest', 'largest'
+00071eb0: 2c20 2762 7269 6768 7465 7374 2729 2e0a  , 'brightest')..
+00071ec0: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+00071ed0: 2020 7374 723a 2054 6865 2066 696c 6520    str: The file 
+00071ee0: 7061 7468 206f 6620 7468 6520 7365 6c65  path of the sele
+00071ef0: 6374 6564 2069 6d61 6765 2c20 6f72 204e  cted image, or N
+00071f00: 6f6e 6520 6966 206e 6f20 7661 6c69 6420  one if no valid 
+00071f10: 696d 6167 6573 2061 7265 2066 6f75 6e64  images are found
+00071f20: 2e0a 2020 2020 2222 220a 2020 2020 696d  ..    """.    im
+00071f30: 706f 7274 206e 756d 7079 2061 7320 6e70  port numpy as np
+00071f40: 0a20 2020 2069 6620 6e6f 7420 696d 6167  .    if not imag
+00071f50: 655f 7061 7468 733a 0a20 2020 2020 2020  e_paths:.       
+00071f60: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
+00071f70: 2020 7365 6c65 6374 6564 5f69 6d61 6765    selected_image
+00071f80: 5f70 6174 6820 3d20 4e6f 6e65 0a20 2020  _path = None.   
+00071f90: 2069 6620 6372 6974 6572 6961 203d 3d20   if criteria == 
+00071fa0: 2773 6d61 6c6c 6573 7427 206f 7220 6372  'smallest' or cr
+00071fb0: 6974 6572 6961 203d 3d20 276c 6172 6765  iteria == 'large
+00071fc0: 7374 273a 0a20 2020 2020 2020 2065 7874  st':.        ext
+00071fd0: 7265 6d65 5f76 6f6c 756d 6520 3d20 4e6f  reme_volume = No
+00071fe0: 6e65 0a0a 2020 2020 2020 2020 666f 7220  ne..        for 
+00071ff0: 7061 7468 2069 6e20 696d 6167 655f 7061  path in image_pa
+00072000: 7468 733a 0a20 2020 2020 2020 2020 2020  ths:.           
+00072010: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00072020: 2020 2020 2020 696d 6167 6520 3d20 616e        image = an
+00072030: 7473 2e69 6d61 6765 5f72 6561 6428 7061  ts.image_read(pa
+00072040: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+00072050: 2020 2020 766f 6c75 6d65 203d 206e 702e      volume = np.
+00072060: 7072 6f64 2869 6d61 6765 2e73 6861 7065  prod(image.shape
+00072070: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00072080: 2020 2069 6620 6372 6974 6572 6961 203d     if criteria =
+00072090: 3d20 276c 6172 6765 7374 273a 0a20 2020  = 'largest':.   
+000720a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000720b0: 2069 6620 6578 7472 656d 655f 766f 6c75   if extreme_volu
+000720c0: 6d65 2069 7320 4e6f 6e65 206f 7220 766f  me is None or vo
+000720d0: 6c75 6d65 203e 2065 7874 7265 6d65 5f76  lume > extreme_v
+000720e0: 6f6c 756d 653a 0a20 2020 2020 2020 2020  olume:.         
+000720f0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00072100: 7874 7265 6d65 5f76 6f6c 756d 6520 3d20  xtreme_volume = 
+00072110: 766f 6c75 6d65 0a20 2020 2020 2020 2020  volume.         
+00072120: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00072130: 656c 6563 7465 645f 696d 6167 655f 7061  elected_image_pa
+00072140: 7468 203d 2070 6174 680a 2020 2020 2020  th = path.      
+00072150: 2020 2020 2020 2020 2020 656c 6966 2063            elif c
+00072160: 7269 7465 7269 6120 3d3d 2027 736d 616c  riteria == 'smal
+00072170: 6c65 7374 273a 0a20 2020 2020 2020 2020  lest':.         
+00072180: 2020 2020 2020 2020 2020 2069 6620 6578             if ex
+00072190: 7472 656d 655f 766f 6c75 6d65 2069 7320  treme_volume is 
+000721a0: 4e6f 6e65 206f 7220 766f 6c75 6d65 203c  None or volume <
+000721b0: 2065 7874 7265 6d65 5f76 6f6c 756d 653a   extreme_volume:
+000721c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000721d0: 2020 2020 2020 2020 2065 7874 7265 6d65           extreme
+000721e0: 5f76 6f6c 756d 6520 3d20 766f 6c75 6d65  _volume = volume
+000721f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00072200: 2020 2020 2020 2020 2073 656c 6563 7465           selecte
+00072210: 645f 696d 6167 655f 7061 7468 203d 2070  d_image_path = p
+00072220: 6174 680a 0a20 2020 2020 2020 2020 2020  ath..           
+00072230: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+00072240: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
+00072250: 2020 2020 2020 2020 7072 696e 7428 6622          print(f"
+00072260: 4572 726f 7220 7072 6f63 6573 7369 6e67  Error processing
+00072270: 2069 6d61 6765 207b 7061 7468 7d3a 207b   image {path}: {
+00072280: 657d 2229 0a0a 2020 2020 656c 6966 2063  e}")..    elif c
+00072290: 7269 7465 7269 6120 3d3d 2027 6272 6967  riteria == 'brig
+000722a0: 6874 6573 7427 3a0a 2020 2020 2020 2020  htest':.        
+000722b0: 6d61 785f 6272 6967 6874 6e65 7373 203d  max_brightness =
+000722c0: 204e 6f6e 650a 0a20 2020 2020 2020 2066   None..        f
+000722d0: 6f72 2070 6174 6820 696e 2069 6d61 6765  or path in image
+000722e0: 5f70 6174 6873 3a0a 2020 2020 2020 2020  _paths:.        
+000722f0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00072300: 2020 2020 2020 2020 2069 6d61 6765 203d           image =
+00072310: 2061 6e74 732e 696d 6167 655f 7265 6164   ants.image_read
+00072320: 2870 6174 6829 0a20 2020 2020 2020 2020  (path).         
+00072330: 2020 2020 2020 2062 7269 6768 746e 6573         brightnes
+00072340: 7320 3d20 6e70 2e6d 6561 6e28 696d 6167  s = np.mean(imag
+00072350: 652e 6e75 6d70 7928 2929 0a0a 2020 2020  e.numpy())..    
+00072360: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00072370: 6178 5f62 7269 6768 746e 6573 7320 6973  ax_brightness is
+00072380: 204e 6f6e 6520 6f72 2062 7269 6768 746e   None or brightn
+00072390: 6573 7320 3e20 6d61 785f 6272 6967 6874  ess > max_bright
+000723a0: 6e65 7373 3a0a 2020 2020 2020 2020 2020  ness:.          
+000723b0: 2020 2020 2020 2020 2020 6d61 785f 6272            max_br
+000723c0: 6967 6874 6e65 7373 203d 2062 7269 6768  ightness = brigh
+000723d0: 746e 6573 730a 2020 2020 2020 2020 2020  tness.          
+000723e0: 2020 2020 2020 2020 2020 7365 6c65 6374            select
+000723f0: 6564 5f69 6d61 6765 5f70 6174 6820 3d20  ed_image_path = 
+00072400: 7061 7468 0a0a 2020 2020 2020 2020 2020  path..          
+00072410: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00072420: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+00072430: 2020 2020 2020 2020 2070 7269 6e74 2866           print(f
+00072440: 2245 7272 6f72 2070 726f 6365 7373 696e  "Error processin
+00072450: 6720 696d 6167 6520 7b70 6174 687d 3a20  g image {path}: 
+00072460: 7b65 7d22 290a 0a20 2020 2065 6c73 653a  {e}")..    else:
+00072470: 0a20 2020 2020 2020 2072 6169 7365 2056  .        raise V
+00072480: 616c 7565 4572 726f 7228 2243 7269 7465  alueError("Crite
+00072490: 7269 6120 6d75 7374 2062 6520 2773 6d61  ria must be 'sma
+000724a0: 6c6c 6573 7427 2c20 276c 6172 6765 7374  llest', 'largest
+000724b0: 272c 206f 7220 2762 7269 6768 7465 7374  ', or 'brightest
+000724c0: 272e 2229 0a0a 2020 2020 7265 7475 726e  '.")..    return
+000724d0: 2073 656c 6563 7465 645f 696d 6167 655f   selected_image_
+000724e0: 7061 7468 0a0a 0a0a 6465 6620 6d6d 5f6d  path....def mm_m
+000724f0: 6174 6368 5f62 795f 7163 5f73 636f 7269  atch_by_qc_scori
+00072500: 6e67 2864 665f 612c 2064 665f 622c 206d  ng(df_a, df_b, m
+00072510: 6174 6368 5f63 6f6c 756d 6e2c 2063 7269  atch_column, cri
+00072520: 7465 7269 612c 2070 7265 6669 783d 276d  teria, prefix='m
+00072530: 6174 6368 6564 5f27 2c20 6578 636c 7564  atched_', exclud
+00072540: 655f 636f 6c75 6d6e 733d 4e6f 6e65 293a  e_columns=None):
+00072550: 0a20 2020 2022 2222 0a20 2020 204d 6174  .    """.    Mat
+00072560: 6368 2065 6163 6820 726f 7720 696e 2064  ch each row in d
+00072570: 665f 6120 746f 2061 2072 6f77 2069 6e20  f_a to a row in 
+00072580: 6466 5f62 2062 6173 6564 206f 6e20 6120  df_b based on a 
+00072590: 6d61 7463 6869 6e67 2063 6f6c 756d 6e20  matching column 
+000725a0: 616e 6420 6372 6974 6572 6961 2066 6f72  and criteria for
+000725b0: 2073 656c 6563 7469 6e67 2074 6865 2062   selecting the b
+000725c0: 6573 7420 6d61 7463 682c 0a20 2020 2077  est match,.    w
+000725d0: 6974 6820 6f70 7469 6f6e 7320 746f 2070  ith options to p
+000725e0: 7265 6669 7820 636f 6c75 6d6e 206e 616d  refix column nam
+000725f0: 6573 2066 726f 6d20 6466 5f62 2061 6e64  es from df_b and
+00072600: 2065 7863 6c75 6465 2063 6572 7461 696e   exclude certain
+00072610: 2063 6f6c 756d 6e73 2066 726f 6d20 7468   columns from th
+00072620: 6520 6669 6e61 6c20 6f75 7470 7574 2e20  e final output. 
+00072630: 4164 6469 7469 6f6e 616c 6c79 2c0a 2020  Additionally,.  
+00072640: 2020 7265 7475 726e 7320 6120 4461 7461    returns a Data
+00072650: 4672 616d 6520 636f 6e74 6169 6e69 6e67  Frame containing
+00072660: 2072 6f77 7320 6672 6f6d 2064 665f 6220   rows from df_b 
+00072670: 7468 6174 2077 6572 6520 6e6f 7420 6d61  that were not ma
+00072680: 7463 6865 6420 746f 2061 6e79 2072 6f77  tched to any row
+00072690: 2069 6e20 6466 5f61 2e0a 0a20 2020 2050   in df_a...    P
+000726a0: 6172 616d 6574 6572 733a 0a20 2020 202d  arameters:.    -
+000726b0: 2064 665f 613a 2044 6174 6146 7261 6d65   df_a: DataFrame
+000726c0: 2041 2e0a 2020 2020 2d20 6466 5f62 3a20   A..    - df_b: 
+000726d0: 4461 7461 4672 616d 6520 422e 0a20 2020  DataFrame B..   
+000726e0: 202d 206d 6174 6368 5f63 6f6c 756d 6e3a   - match_column:
+000726f0: 2054 6865 2063 6f6c 756d 6e20 6e61 6d65   The column name
+00072700: 206f 6e20 7768 6963 6820 726f 7773 2073   on which rows s
+00072710: 686f 756c 6420 6d61 7463 6820 6265 7477  hould match betw
+00072720: 6565 6e20 4461 7461 4672 616d 6520 4120  een DataFrame A 
+00072730: 616e 6420 422e 0a20 2020 202d 2063 7269  and B..    - cri
+00072740: 7465 7269 613a 2041 2064 6963 7469 6f6e  teria: A diction
+00072750: 6172 7920 7768 6572 6520 6b65 7973 2061  ary where keys a
+00072760: 7265 2063 6f6c 756d 6e20 6e61 6d65 7320  re column names 
+00072770: 616e 6420 7661 6c75 6573 2061 7265 2027  and values are '
+00072780: 6d69 6e27 206f 7220 276d 6178 272c 2069  min' or 'max', i
+00072790: 6e64 6963 6174 696e 6720 7768 6574 6865  ndicating whethe
+000727a0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+000727b0: 2020 7468 6520 636f 6c75 6d6e 2073 686f    the column sho
+000727c0: 756c 6420 6265 206d 696e 696d 697a 6564  uld be minimized
+000727d0: 206f 7220 6d61 7869 6d69 7a65 6420 666f   or maximized fo
+000727e0: 7220 7468 6520 6265 7374 206d 6174 6368  r the best match
+000727f0: 2e0a 2020 2020 2d20 7072 6566 6978 3a20  ..    - prefix: 
+00072800: 4120 7374 7269 6e67 2070 7265 6669 7820  A string prefix 
+00072810: 746f 2061 6464 2074 6f20 636f 6c75 6d6e  to add to column
+00072820: 206e 616d 6573 2066 726f 6d20 6466 5f62   names from df_b
+00072830: 2069 6e20 7468 6520 6669 6e61 6c20 6f75   in the final ou
+00072840: 7470 7574 2074 6f20 6176 6f69 6420 6475  tput to avoid du
+00072850: 706c 6963 6174 696f 6e2e 0a20 2020 202d  plication..    -
+00072860: 2065 7863 6c75 6465 5f63 6f6c 756d 6e73   exclude_columns
+00072870: 3a20 4120 6c69 7374 206f 6620 636f 6c75  : A list of colu
+00072880: 6d6e 206e 616d 6573 2066 726f 6d20 6466  mn names from df
+00072890: 5f62 2074 6f20 6578 636c 7564 6520 6672  _b to exclude fr
+000728a0: 6f6d 2074 6865 2066 696e 616c 206f 7574  om the final out
+000728b0: 7075 742e 0a20 2020 200a 2020 2020 5265  put..    .    Re
+000728c0: 7475 726e 733a 0a20 2020 202d 2041 2074  turns:.    - A t
+000728d0: 7570 6c65 206f 6620 7477 6f20 4461 7461  uple of two Data
+000728e0: 4672 616d 6573 3a20 0a20 2020 2020 2020  Frames: .       
+000728f0: 2031 2e20 4120 6e65 7720 4461 7461 4672   1. A new DataFr
+00072900: 616d 6520 636f 6d62 696e 696e 6720 6466  ame combining df
+00072910: 5f61 2077 6974 6820 6d61 7463 6865 6420  _a with matched 
+00072920: 726f 7773 2066 726f 6d20 6466 5f62 2e0a  rows from df_b..
+00072930: 2020 2020 2020 2020 322e 2041 2044 6174          2. A Dat
+00072940: 6146 7261 6d65 2063 6f6e 7461 696e 696e  aFrame containin
+00072950: 6720 726f 7773 2066 726f 6d20 6466 5f62  g rows from df_b
+00072960: 2074 6861 7420 7765 7265 206e 6f74 206d   that were not m
+00072970: 6174 6368 6564 2074 6f20 6466 5f61 2e0a  atched to df_a..
+00072980: 2020 2020 2222 220a 2020 2020 6672 6f6d      """.    from
+00072990: 2073 6369 7079 2e73 7461 7473 2069 6d70   scipy.stats imp
+000729a0: 6f72 7420 7a73 636f 7265 0a20 2020 2064  ort zscore.    d
+000729b0: 665f 6120 3d20 6466 5f61 2e6c 6f63 5b3a  f_a = df_a.loc[:
+000729c0: 2c20 7e64 665f 612e 636f 6c75 6d6e 732e  , ~df_a.columns.
+000729d0: 7374 722e 7374 6172 7473 7769 7468 2827  str.startswith('
+000729e0: 556e 6e61 6d65 643a 2729 5d2e 636f 7079  Unnamed:')].copy
+000729f0: 2829 0a20 2020 2069 6620 6466 5f62 2069  ().    if df_b i
+00072a00: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00072a10: 2020 2020 6466 5f62 203d 2064 665f 622e      df_b = df_b.
+00072a20: 6c6f 635b 3a2c 207e 6466 5f62 2e63 6f6c  loc[:, ~df_b.col
+00072a30: 756d 6e73 2e73 7472 2e73 7461 7274 7377  umns.str.startsw
+00072a40: 6974 6828 2755 6e6e 616d 6564 3a27 295d  ith('Unnamed:')]
+00072a50: 2e63 6f70 7928 290a 2020 2020 656c 7365  .copy().    else
+00072a60: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00072a70: 2064 665f 612c 2070 642e 4461 7461 4672   df_a, pd.DataFr
+00072a80: 616d 6528 290a 2020 2020 0a20 2020 2023  ame().    .    #
+00072a90: 204e 6f72 6d61 6c69 7a65 2064 665f 6220   Normalize df_b 
+00072aa0: 6261 7365 6420 6f6e 2063 7269 7465 7269  based on criteri
+00072ab0: 610a 2020 2020 666f 7220 636f 6c2c 2063  a.    for col, c
+00072ac0: 7269 7420 696e 2063 7269 7465 7269 612e  rit in criteria.
+00072ad0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+00072ae0: 2069 6620 6372 6974 203d 3d20 276d 6178   if crit == 'max
+00072af0: 273a 0a20 2020 2020 2020 2020 2020 2064  ':.            d
+00072b00: 665f 622e 6c6f 635b 6466 5f62 2e69 6e64  f_b.loc[df_b.ind
+00072b10: 6578 2c20 6627 7363 6f72 655f 7b63 6f6c  ex, f'score_{col
+00072b20: 7d27 5d20 3d20 7a73 636f 7265 282d 6466  }'] = zscore(-df
+00072b30: 5f62 5b63 6f6c 5d29 0a20 2020 2020 2020  _b[col]).       
+00072b40: 2065 6c69 6620 6372 6974 203d 3d20 276d   elif crit == 'm
+00072b50: 696e 273a 0a20 2020 2020 2020 2020 2020  in':.           
+00072b60: 2064 665f 622e 6c6f 635b 6466 5f62 2e69   df_b.loc[df_b.i
+00072b70: 6e64 6578 2c20 6627 7363 6f72 655f 7b63  ndex, f'score_{c
+00072b80: 6f6c 7d27 5d20 3d20 7a73 636f 7265 2864  ol}'] = zscore(d
+00072b90: 665f 625b 636f 6c5d 290a 0a20 2020 2023  f_b[col])..    #
+00072ba0: 2043 616c 6375 6c61 7465 2027 6265 7374   Calculate 'best
+00072bb0: 5f73 636f 7265 2720 6279 2073 756d 6d69  _score' by summi
+00072bc0: 6e67 2061 6c6c 2073 636f 7265 2063 6f6c  ng all score col
+00072bd0: 756d 6e73 0a20 2020 2073 636f 7265 5f63  umns.    score_c
+00072be0: 6f6c 756d 6e73 203d 205b 6627 7363 6f72  olumns = [f'scor
+00072bf0: 655f 7b63 6f6c 7d27 2066 6f72 2063 6f6c  e_{col}' for col
+00072c00: 2069 6e20 6372 6974 6572 6961 2e6b 6579   in criteria.key
+00072c10: 7328 295d 0a20 2020 2064 665f 625b 2762  s()].    df_b['b
+00072c20: 6573 745f 7363 6f72 6527 5d20 3d20 6466  est_score'] = df
+00072c30: 5f62 5b73 636f 7265 5f63 6f6c 756d 6e73  _b[score_columns
+00072c40: 5d2e 7375 6d28 6178 6973 3d31 290a 0a20  ].sum(axis=1).. 
+00072c50: 2020 206d 6174 6368 6564 5f69 6e64 6963     matched_indic
+00072c60: 6573 203d 205b 5d20 2023 2054 7261 636b  es = []  # Track
+00072c70: 2069 6e64 6963 6573 206f 6620 6d61 7463   indices of matc
+00072c80: 6865 6420 726f 7773 2069 6e20 6466 5f62  hed rows in df_b
+00072c90: 0a0a 2020 2020 2320 4d61 7463 6820 726f  ..    # Match ro
+00072ca0: 7773 0a20 2020 206d 6174 6368 6564 5f72  ws.    matched_r
+00072cb0: 6f77 7320 3d20 5b5d 0a20 2020 2066 6f72  ows = [].    for
+00072cc0: 205f 2c20 726f 775f 6120 696e 2064 665f   _, row_a in df_
+00072cd0: 612e 6974 6572 726f 7773 2829 3a0a 2020  a.iterrows():.  
+00072ce0: 2020 2020 2020 6d61 7463 6865 7320 3d20        matches = 
+00072cf0: 6466 5f62 5b64 665f 625b 6d61 7463 685f  df_b[df_b[match_
+00072d00: 636f 6c75 6d6e 5d20 3d3d 2072 6f77 5f61  column] == row_a
+00072d10: 5b6d 6174 6368 5f63 6f6c 756d 6e5d 5d0a  [match_column]].
+00072d20: 2020 2020 2020 2020 6966 206e 6f74 206d          if not m
+00072d30: 6174 6368 6573 2e65 6d70 7479 3a0a 2020  atches.empty:.  
+00072d40: 2020 2020 2020 2020 2020 6265 7374 5f69            best_i
+00072d50: 6478 203d 206d 6174 6368 6573 5b27 6265  dx = matches['be
+00072d60: 7374 5f73 636f 7265 275d 2e69 6478 6d69  st_score'].idxmi
+00072d70: 6e28 290a 2020 2020 2020 2020 2020 2020  n().            
+00072d80: 6265 7374 5f6d 6174 6368 203d 206d 6174  best_match = mat
+00072d90: 6368 6573 2e6c 6f63 5b62 6573 745f 6964  ches.loc[best_id
+00072da0: 785d 0a20 2020 2020 2020 2020 2020 206d  x].            m
+00072db0: 6174 6368 6564 5f69 6e64 6963 6573 2e61  atched_indices.a
+00072dc0: 7070 656e 6428 6265 7374 5f69 6478 2920  ppend(best_idx) 
+00072dd0: 2023 2054 7261 636b 2074 6869 7320 696e   # Track this in
+00072de0: 6465 7820 6173 206d 6174 6368 6564 0a20  dex as matched. 
+00072df0: 2020 2020 2020 2020 2020 206d 6174 6368             match
+00072e00: 6564 5f72 6f77 732e 6170 7065 6e64 2862  ed_rows.append(b
+00072e10: 6573 745f 6d61 7463 6829 0a20 2020 2020  est_match).     
+00072e20: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00072e30: 2020 2020 206d 6174 6368 6564 5f72 6f77       matched_row
+00072e40: 732e 6170 7065 6e64 2870 642e 5365 7269  s.append(pd.Seri
+00072e50: 6573 2864 7479 7065 3d27 666c 6f61 7436  es(dtype='float6
+00072e60: 3427 2929 0a0a 2020 2020 2320 4372 6561  4'))..    # Crea
+00072e70: 7465 2061 2044 6174 6146 7261 6d65 2066  te a DataFrame f
+00072e80: 726f 6d20 6d61 7463 6865 6420 726f 7773  rom matched rows
+00072e90: 0a20 2020 2064 665f 6d61 7463 6865 6420  .    df_matched 
+00072ea0: 3d20 7064 2e44 6174 6146 7261 6d65 286d  = pd.DataFrame(m
+00072eb0: 6174 6368 6564 5f72 6f77 7329 2e72 6573  atched_rows).res
+00072ec0: 6574 5f69 6e64 6578 2864 726f 703d 5472  et_index(drop=Tr
+00072ed0: 7565 290a 2020 2020 0a20 2020 2023 2045  ue).    .    # E
+00072ee0: 7863 6c75 6465 2073 7065 6369 6669 6564  xclude specified
+00072ef0: 2063 6f6c 756d 6e73 2061 6e64 2061 6464   columns and add
+00072f00: 2070 7265 6669 780a 2020 2020 6966 2065   prefix.    if e
+00072f10: 7863 6c75 6465 5f63 6f6c 756d 6e73 2069  xclude_columns i
+00072f20: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00072f30: 2020 2020 6466 5f6d 6174 6368 6564 203d      df_matched =
+00072f40: 2064 665f 6d61 7463 6865 642e 6472 6f70   df_matched.drop
+00072f50: 2863 6f6c 756d 6e73 3d65 7863 6c75 6465  (columns=exclude
+00072f60: 5f63 6f6c 756d 6e73 2c20 6572 726f 7273  _columns, errors
+00072f70: 3d27 6967 6e6f 7265 2729 0a20 2020 2064  ='ignore').    d
+00072f80: 665f 6d61 7463 6865 6420 3d20 6466 5f6d  f_matched = df_m
+00072f90: 6174 6368 6564 2e72 656e 616d 6528 636f  atched.rename(co
+00072fa0: 6c75 6d6e 733d 6c61 6d62 6461 2078 3a20  lumns=lambda x: 
+00072fb0: 6622 7b70 7265 6669 787d 7b78 7d22 2069  f"{prefix}{x}" i
+00072fc0: 6620 7820 213d 206d 6174 6368 5f63 6f6c  f x != match_col
+00072fd0: 756d 6e20 616e 6420 7820 696e 2064 665f  umn and x in df_
+00072fe0: 6d61 7463 6865 642e 636f 6c75 6d6e 7320  matched.columns 
+00072ff0: 656c 7365 2078 290a 0a20 2020 2023 2043  else x)..    # C
+00073000: 6f6d 6269 6e65 2064 665f 6120 7769 7468  ombine df_a with
+00073010: 206d 6174 6368 6564 2072 6f77 7320 6672   matched rows fr
+00073020: 6f6d 2064 665f 620a 2020 2020 7265 7375  om df_b.    resu
+00073030: 6c74 5f64 6620 3d20 7064 2e63 6f6e 6361  lt_df = pd.conca
+00073040: 7428 5b64 665f 612e 7265 7365 745f 696e  t([df_a.reset_in
+00073050: 6465 7828 6472 6f70 3d54 7275 6529 2c20  dex(drop=True), 
+00073060: 6466 5f6d 6174 6368 6564 5d2c 2061 7869  df_matched], axi
+00073070: 733d 3129 0a20 2020 200a 2020 2020 2320  s=1).    .    # 
+00073080: 4578 7472 6163 7420 756e 6d61 7463 6865  Extract unmatche
+00073090: 6420 726f 7773 2066 726f 6d20 6466 5f62  d rows from df_b
+000730a0: 0a20 2020 2075 6e6d 6174 6368 6564 5f64  .    unmatched_d
+000730b0: 665f 6220 3d20 6466 5f62 2e64 726f 7028  f_b = df_b.drop(
+000730c0: 696e 6465 783d 6d61 7463 6865 645f 696e  index=matched_in
+000730d0: 6469 6365 7329 2e72 6573 6574 5f69 6e64  dices).reset_ind
+000730e0: 6578 2864 726f 703d 5472 7565 290a 0a20  ex(drop=True).. 
+000730f0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+00073100: 5f64 662c 2075 6e6d 6174 6368 6564 5f64  _df, unmatched_d
+00073110: 665f 620a 0a0a 6465 6620 6669 785f 4c52  f_b...def fix_LR
+00073120: 5f52 4c5f 7374 7566 6628 6466 2c20 636f  _RL_stuff(df, co
+00073130: 6c31 2c20 636f 6c32 2c20 7369 7a65 5f63  l1, col2, size_c
+00073140: 6f6c 312c 2073 697a 655f 636f 6c32 2c20  ol1, size_col2, 
+00073150: 6964 312c 2069 6432 2029 3a0a 2020 2020  id1, id2 ):.    
+00073160: 6466 5f63 6f70 7920 3d20 6466 2e63 6f70  df_copy = df.cop
+00073170: 7928 290a 2020 2020 2320 456e 7375 7265  y().    # Ensure
+00073180: 2063 6f6c 756d 6e73 2063 6f6e 7461 696e   columns contain
+00073190: 2073 7472 696e 6773 2066 6f72 2073 7562   strings for sub
+000731a0: 7374 7269 6e67 2063 6865 636b 730a 2020  string checks.  
+000731b0: 2020 6466 5f63 6f70 795b 636f 6c31 5d20    df_copy[col1] 
+000731c0: 3d20 6466 5f63 6f70 795b 636f 6c31 5d2e  = df_copy[col1].
+000731d0: 6173 7479 7065 2873 7472 290a 2020 2020  astype(str).    
+000731e0: 6466 5f63 6f70 795b 636f 6c32 5d20 3d20  df_copy[col2] = 
+000731f0: 6466 5f63 6f70 795b 636f 6c32 5d2e 6173  df_copy[col2].as
+00073200: 7479 7065 2873 7472 290a 2020 2020 6466  type(str).    df
+00073210: 5f63 6f70 795b 6964 315d 203d 2064 665f  _copy[id1] = df_
+00073220: 636f 7079 5b69 6431 5d2e 6173 7479 7065  copy[id1].astype
+00073230: 2873 7472 290a 2020 2020 6466 5f63 6f70  (str).    df_cop
+00073240: 795b 6964 325d 203d 2064 665f 636f 7079  y[id2] = df_copy
+00073250: 5b69 6432 5d2e 6173 7479 7065 2873 7472  [id2].astype(str
+00073260: 290a 2020 2020 0a20 2020 2066 6f72 2069  ).    .    for i
+00073270: 6e64 6578 2c20 726f 7720 696e 2064 665f  ndex, row in df_
+00073280: 636f 7079 2e69 7465 7272 6f77 7328 293a  copy.iterrows():
+00073290: 0a20 2020 2020 2020 2063 6f6c 315f 7661  .        col1_va
+000732a0: 6c20 3d20 726f 775b 636f 6c31 5d0a 2020  l = row[col1].  
+000732b0: 2020 2020 2020 636f 6c32 5f76 616c 203d        col2_val =
+000732c0: 2072 6f77 5b63 6f6c 325d 0a20 2020 2020   row[col2].     
+000732d0: 2020 2073 697a 6531 203d 2072 6f77 5b73     size1 = row[s
+000732e0: 697a 655f 636f 6c31 5d0a 2020 2020 2020  ize_col1].      
+000732f0: 2020 7369 7a65 3220 3d20 726f 775b 7369    size2 = row[si
+00073300: 7a65 5f63 6f6c 325d 0a20 2020 2020 2020  ze_col2].       
+00073310: 200a 2020 2020 2020 2020 2320 4368 6563   .        # Chec
+00073320: 6b20 666f 7220 2752 4c27 206f 7220 274c  k for 'RL' or 'L
+00073330: 5227 2069 6e20 6561 6368 2063 6f6c 756d  R' in each colum
+00073340: 6e20 616e 6420 636f 6d70 6172 6520 7369  n and compare si
+00073350: 7a65 730a 2020 2020 2020 2020 6966 2028  zes.        if (
+00073360: 2752 4c27 2069 6e20 636f 6c31 5f76 616c  'RL' in col1_val
+00073370: 206f 7220 274c 5227 2069 6e20 636f 6c31   or 'LR' in col1
+00073380: 5f76 616c 2920 616e 6420 2827 524c 2720  _val) and ('RL' 
+00073390: 696e 2063 6f6c 325f 7661 6c20 6f72 2027  in col2_val or '
+000733a0: 4c52 2720 696e 2063 6f6c 325f 7661 6c29  LR' in col2_val)
+000733b0: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+000733c0: 6e74 696e 7565 0a20 2020 2020 2020 2065  ntinue.        e
+000733d0: 6c69 6620 2752 4c27 206e 6f74 2069 6e20  lif 'RL' not in 
+000733e0: 636f 6c31 5f76 616c 2061 6e64 2027 4c52  col1_val and 'LR
+000733f0: 2720 6e6f 7420 696e 2063 6f6c 315f 7661  ' not in col1_va
+00073400: 6c20 616e 6420 2752 4c27 206e 6f74 2069  l and 'RL' not i
+00073410: 6e20 636f 6c32 5f76 616c 2061 6e64 2027  n col2_val and '
+00073420: 4c52 2720 6e6f 7420 696e 2063 6f6c 325f  LR' not in col2_
+00073430: 7661 6c3a 0a20 2020 2020 2020 2020 2020  val:.           
+00073440: 2069 6620 7369 7a65 3120 3c20 7369 7a65   if size1 < size
+00073450: 323a 0a20 2020 2020 2020 2020 2020 2020  2:.             
+00073460: 2020 2064 665f 636f 7079 2e61 745b 696e     df_copy.at[in
+00073470: 6465 782c 2063 6f6c 315d 203d 2064 665f  dex, col1] = df_
+00073480: 636f 7079 2e61 745b 696e 6465 782c 2063  copy.at[index, c
+00073490: 6f6c 325d 0a20 2020 2020 2020 2020 2020  ol2].           
+000734a0: 2020 2020 2064 665f 636f 7079 2e61 745b       df_copy.at[
+000734b0: 696e 6465 782c 2073 697a 655f 636f 6c31  index, size_col1
+000734c0: 5d20 3d20 6466 5f63 6f70 792e 6174 5b69  ] = df_copy.at[i
+000734d0: 6e64 6578 2c20 7369 7a65 5f63 6f6c 325d  ndex, size_col2]
+000734e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000734f0: 2064 665f 636f 7079 2e61 745b 696e 6465   df_copy.at[inde
+00073500: 782c 2069 6431 5d20 3d20 6466 5f63 6f70  x, id1] = df_cop
+00073510: 792e 6174 5b69 6e64 6578 2c20 6964 325d  y.at[index, id2]
+00073520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00073530: 2064 665f 636f 7079 2e61 745b 696e 6465   df_copy.at[inde
+00073540: 782c 2073 697a 655f 636f 6c32 5d20 3d20  x, size_col2] = 
+00073550: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
+00073560: 2020 6466 5f63 6f70 792e 6174 5b69 6e64    df_copy.at[ind
+00073570: 6578 2c20 636f 6c32 5d20 3d20 4e6f 6e65  ex, col2] = None
+00073580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00073590: 2064 665f 636f 7079 2e61 745b 696e 6465   df_copy.at[inde
+000735a0: 782c 2069 6432 5d20 3d20 4e6f 6e65 0a20  x, id2] = None. 
+000735b0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000735c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000735d0: 2064 665f 636f 7079 2e61 745b 696e 6465   df_copy.at[inde
+000735e0: 782c 2063 6f6c 325d 203d 204e 6f6e 650a  x, col2] = None.
+000735f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073600: 6466 5f63 6f70 792e 6174 5b69 6e64 6578  df_copy.at[index
+00073610: 2c20 7369 7a65 5f63 6f6c 325d 203d 2030  , size_col2] = 0
+00073620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00073630: 2064 665f 636f 7079 2e61 745b 696e 6465   df_copy.at[inde
+00073640: 782c 2069 6432 5d20 3d20 4e6f 6e65 0a20  x, id2] = None. 
+00073650: 2020 2020 2020 2065 6c69 6620 2752 4c27         elif 'RL'
+00073660: 2069 6e20 636f 6c31 5f76 616c 206f 7220   in col1_val or 
+00073670: 274c 5227 2069 6e20 636f 6c31 5f76 616c  'LR' in col1_val
+00073680: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00073690: 2073 697a 6531 203c 2073 697a 6532 3a0a   size1 < size2:.
+000736a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000736b0: 6466 5f63 6f70 792e 6174 5b69 6e64 6578  df_copy.at[index
+000736c0: 2c20 636f 6c31 5d20 3d20 6466 5f63 6f70  , col1] = df_cop
+000736d0: 792e 6174 5b69 6e64 6578 2c20 636f 6c32  y.at[index, col2
+000736e0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+000736f0: 2020 6466 5f63 6f70 792e 6174 5b69 6e64    df_copy.at[ind
+00073700: 6578 2c20 6964 315d 203d 2064 665f 636f  ex, id1] = df_co
+00073710: 7079 2e61 745b 696e 6465 782c 2069 6432  py.at[index, id2
+00073720: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00073730: 2020 6466 5f63 6f70 792e 6174 5b69 6e64    df_copy.at[ind
+00073740: 6578 2c20 7369 7a65 5f63 6f6c 315d 203d  ex, size_col1] =
+00073750: 2064 665f 636f 7079 2e61 745b 696e 6465   df_copy.at[inde
+00073760: 782c 2073 697a 655f 636f 6c32 5d0a 2020  x, size_col2].  
+00073770: 2020 2020 2020 2020 2020 2020 2020 6466                df
+00073780: 5f63 6f70 792e 6174 5b69 6e64 6578 2c20  _copy.at[index, 
+00073790: 7369 7a65 5f63 6f6c 325d 203d 2030 0a20  size_col2] = 0. 
+000737a0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000737b0: 665f 636f 7079 2e61 745b 696e 6465 782c  f_copy.at[index,
+000737c0: 2063 6f6c 325d 203d 204e 6f6e 650a 2020   col2] = None.  
+000737d0: 2020 2020 2020 2020 2020 2020 2020 6466                df
+000737e0: 5f63 6f70 792e 6174 5b69 6e64 6578 2c20  _copy.at[index, 
+000737f0: 6964 325d 203d 204e 6f6e 650a 2020 2020  id2] = None.    
+00073800: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00073810: 2020 2020 2020 2020 2020 2020 2020 6466                df
+00073820: 5f63 6f70 792e 6174 5b69 6e64 6578 2c20  _copy.at[index, 
+00073830: 636f 6c32 5d20 3d20 4e6f 6e65 0a20 2020  col2] = None.   
+00073840: 2020 2020 2020 2020 2020 2020 2064 665f               df_
+00073850: 636f 7079 2e61 745b 696e 6465 782c 2069  copy.at[index, i
+00073860: 6432 5d20 3d20 4e6f 6e65 0a20 2020 2020  d2] = None.     
+00073870: 2020 2020 2020 2020 2020 2064 665f 636f             df_co
+00073880: 7079 2e61 745b 696e 6465 782c 2073 697a  py.at[index, siz
+00073890: 655f 636f 6c32 5d20 3d20 300a 2020 2020  e_col2] = 0.    
+000738a0: 2020 2020 656c 6966 2027 524c 2720 696e      elif 'RL' in
+000738b0: 2063 6f6c 325f 7661 6c20 6f72 2027 4c52   col2_val or 'LR
+000738c0: 2720 696e 2063 6f6c 325f 7661 6c3a 0a20  ' in col2_val:. 
+000738d0: 2020 2020 2020 2020 2020 2069 6620 7369             if si
+000738e0: 7a65 3220 3c20 7369 7a65 313a 0a20 2020  ze2 < size1:.   
+000738f0: 2020 2020 2020 2020 2020 2020 2064 665f               df_
+00073900: 636f 7079 2e61 745b 696e 6465 782c 2069  copy.at[index, i
+00073910: 6432 5d20 3d20 4e6f 6e65 0a20 2020 2020  d2] = None.     
+00073920: 2020 2020 2020 2020 2020 2064 665f 636f             df_co
+00073930: 7079 2e61 745b 696e 6465 782c 2063 6f6c  py.at[index, col
+00073940: 325d 203d 204e 6f6e 650a 2020 2020 2020  2] = None.      
+00073950: 2020 2020 2020 2020 2020 6466 5f63 6f70            df_cop
+00073960: 792e 6174 5b69 6e64 6578 2c20 7369 7a65  y.at[index, size
+00073970: 5f63 6f6c 325d 203d 2030 0a20 2020 2020  _col2] = 0.     
+00073980: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00073990: 2020 2020 2020 2020 2020 2020 2064 665f               df_
+000739a0: 636f 7079 2e61 745b 696e 6465 782c 2063  copy.at[index, c
+000739b0: 6f6c 315d 203d 2064 665f 636f 7079 2e61  ol1] = df_copy.a
+000739c0: 745b 696e 6465 782c 2063 6f6c 325d 0a20  t[index, col2]. 
+000739d0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000739e0: 665f 636f 7079 2e61 745b 696e 6465 782c  f_copy.at[index,
+000739f0: 2069 6431 5d20 3d20 6466 5f63 6f70 792e   id1] = df_copy.
+00073a00: 6174 5b69 6e64 6578 2c20 6964 325d 0a20  at[index, id2]. 
+00073a10: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00073a20: 665f 636f 7079 2e61 745b 696e 6465 782c  f_copy.at[index,
+00073a30: 2073 697a 655f 636f 6c31 5d20 3d20 6466   size_col1] = df
+00073a40: 5f63 6f70 792e 6174 5b69 6e64 6578 2c20  _copy.at[index, 
+00073a50: 7369 7a65 5f63 6f6c 325d 0a20 2020 2020  size_col2].     
+00073a60: 2020 2020 2020 2020 2020 2064 665f 636f             df_co
+00073a70: 7079 2e61 745b 696e 6465 782c 2073 697a  py.at[index, siz
+00073a80: 655f 636f 6c32 5d20 3d20 300a 2020 2020  e_col2] = 0.    
+00073a90: 2020 2020 2020 2020 2020 2020 6466 5f63              df_c
+00073aa0: 6f70 792e 6174 5b69 6e64 6578 2c20 636f  opy.at[index, co
+00073ab0: 6c32 5d20 3d20 4e6f 6e65 2020 2020 0a20  l2] = None    . 
+00073ac0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00073ad0: 665f 636f 7079 2e61 745b 696e 6465 782c  f_copy.at[index,
+00073ae0: 2069 6432 5d20 3d20 4e6f 6e65 2020 2020   id2] = None    
+00073af0: 0a20 2020 2072 6574 7572 6e20 6466 5f63  .    return df_c
+00073b00: 6f70 790a 0a0a 6465 6620 7265 6e61 6d65  opy...def rename
+00073b10: 6974 2864 662c 206f 6c64 5f63 6f6c 5f6e  it(df, old_col_n
+00073b20: 616d 652c 206e 6577 5f63 6f6c 5f6e 616d  ame, new_col_nam
+00073b30: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
+00073b40: 5265 6e61 6d65 7320 6120 636f 6c75 6d6e  Renames a column
+00073b50: 2069 6e20 6120 7061 6e64 6173 2044 6174   in a pandas Dat
+00073b60: 6146 7261 6d65 2069 6e20 706c 6163 652e  aFrame in place.
+00073b70: 2052 6169 7365 7320 616e 2065 7272 6f72   Raises an error
+00073b80: 2069 6620 7468 6520 7370 6563 6966 6965   if the specifie
+00073b90: 6420 6f6c 6420 636f 6c75 6d6e 206e 616d  d old column nam
+00073ba0: 6520 646f 6573 206e 6f74 2065 7869 7374  e does not exist
+00073bb0: 2e0a 0a20 2020 2050 6172 616d 6574 6572  ...    Parameter
+00073bc0: 733a 0a20 2020 202d 2064 663a 2070 616e  s:.    - df: pan
+00073bd0: 6461 732e 4461 7461 4672 616d 650a 2020  das.DataFrame.  
+00073be0: 2020 2020 2020 5468 6520 4461 7461 4672        The DataFr
+00073bf0: 616d 6520 696e 2077 6869 6368 2074 6865  ame in which the
+00073c00: 2063 6f6c 756d 6e20 6973 2074 6f20 6265   column is to be
+00073c10: 2072 656e 616d 6564 2e0a 2020 2020 2d20   renamed..    - 
+00073c20: 6f6c 645f 636f 6c5f 6e61 6d65 3a20 7374  old_col_name: st
+00073c30: 720a 2020 2020 2020 2020 5468 6520 6375  r.        The cu
+00073c40: 7272 656e 7420 6e61 6d65 206f 6620 7468  rrent name of th
+00073c50: 6520 636f 6c75 6d6e 2074 6f20 6265 2072  e column to be r
+00073c60: 656e 616d 6564 2e0a 2020 2020 2d20 6e65  enamed..    - ne
+00073c70: 775f 636f 6c5f 6e61 6d65 3a20 7374 720a  w_col_name: str.
+00073c80: 2020 2020 2020 2020 5468 6520 6e65 7720          The new 
+00073c90: 6e61 6d65 2066 6f72 2074 6865 2063 6f6c  name for the col
+00073ca0: 756d 6e2e 0a20 2020 200a 2020 2020 5261  umn..    .    Ra
+00073cb0: 6973 6573 3a0a 2020 2020 2d20 5661 6c75  ises:.    - Valu
+00073cc0: 6545 7272 6f72 3a20 4966 2074 6865 206f  eError: If the o
+00073cd0: 6c64 2063 6f6c 756d 6e20 6e61 6d65 2064  ld column name d
+00073ce0: 6f65 7320 6e6f 7420 6578 6973 7420 696e  oes not exist in
+00073cf0: 2074 6865 2044 6174 6146 7261 6d65 2e0a   the DataFrame..
+00073d00: 2020 2020 0a20 2020 2052 6574 7572 6e73      .    Returns
+00073d10: 3a0a 2020 2020 4e6f 6e65 0a20 2020 2022  :.    None.    "
+00073d20: 2222 0a20 2020 2069 6d70 6f72 7420 7761  "".    import wa
+00073d30: 726e 696e 6773 0a20 2020 2023 2043 6865  rnings.    # Che
+00073d40: 636b 2069 6620 7468 6520 6f6c 6420 636f  ck if the old co
+00073d50: 6c75 6d6e 206e 616d 6520 6578 6973 7473  lumn name exists
+00073d60: 2069 6e20 7468 6520 4461 7461 4672 616d   in the DataFram
+00073d70: 650a 2020 2020 6966 206f 6c64 5f63 6f6c  e.    if old_col
+00073d80: 5f6e 616d 6520 6e6f 7420 696e 2064 662e  _name not in df.
+00073d90: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
+00073da0: 2077 6172 6e69 6e67 732e 7761 726e 2866   warnings.warn(f
+00073db0: 2254 6865 2063 6f6c 756d 6e20 277b 6f6c  "The column '{ol
+00073dc0: 645f 636f 6c5f 6e61 6d65 7d27 2064 6f65  d_col_name}' doe
+00073dd0: 7320 6e6f 7420 6578 6973 7420 696e 2074  s not exist in t
+00073de0: 6865 2044 6174 6146 7261 6d65 2e22 290a  he DataFrame.").
+00073df0: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+00073e00: 2020 200a 2020 2020 2320 5072 6f63 6565     .    # Procee
+00073e10: 6420 7769 7468 2072 656e 616d 696e 6720  d with renaming 
+00073e20: 7468 6520 636f 6c75 6d6e 2069 6620 6974  the column if it
+00073e30: 2065 7869 7374 730a 2020 2020 6466 2e72   exists.    df.r
+00073e40: 656e 616d 6528 636f 6c75 6d6e 733d 7b6f  ename(columns={o
+00073e50: 6c64 5f63 6f6c 5f6e 616d 653a 206e 6577  ld_col_name: new
+00073e60: 5f63 6f6c 5f6e 616d 657d 2c20 696e 706c  _col_name}, inpl
+00073e70: 6163 653d 5472 7565 290a 0a0a 6465 6620  ace=True)...def 
+00073e80: 6d6d 5f6d 6174 6368 5f62 795f 7163 5f73  mm_match_by_qc_s
+00073e90: 636f 7269 6e67 5f61 6c6c 2820 7163 5f64  coring_all( qc_d
+00073ea0: 6174 6166 7261 6d65 2c20 6669 785f 4c52  ataframe, fix_LR
+00073eb0: 524c 3d54 7275 652c 2076 6572 626f 7365  RL=True, verbose
+00073ec0: 3d54 7275 6520 293a 0a20 2020 2022 2222  =True ):.    """
+00073ed0: 0a20 2020 2050 726f 6365 7373 6573 2061  .    Processes a
+00073ee0: 2071 7561 6c69 7479 2063 6f6e 7472 6f6c   quality control
+00073ef0: 2028 5143 2920 4461 7461 4672 616d 6520   (QC) DataFrame 
+00073f00: 746f 2070 6572 666f 726d 206d 6f64 616c  to perform modal
+00073f10: 6974 792d 7370 6563 6966 6963 206d 6174  ity-specific mat
+00073f20: 6368 696e 6720 616e 6420 6669 6c74 6572  ching and filter
+00073f30: 696e 6720 6261 7365 640a 2020 2020 6f6e  ing based.    on
+00073f40: 2070 7265 6465 6669 6e65 6420 6372 6974   predefined crit
+00073f50: 6572 6961 2c20 6f70 7469 6d69 7a69 6e67  eria, optimizing
+00073f60: 2066 6f72 206d 696e 696d 616c 206f 7574   for minimal out
+00073f70: 6c69 6572 7320 616e 6420 6e6f 6973 652c  liers and noise,
+00073f80: 2061 6e64 206d 6178 696d 616c 2073 6967   and maximal sig
+00073f90: 6e61 6c2d 746f 2d6e 6f69 7365 2072 6174  nal-to-noise rat
+00073fa0: 696f 2028 534e 5229 2c0a 2020 2020 6578  io (SNR),.    ex
+00073fb0: 7065 6374 6564 2076 616c 7565 206f 6620  pected value of 
+00073fc0: 7261 6e64 6f6d 6e65 7373 2028 4556 5229  randomness (EVR)
+00073fd0: 2c20 616e 6420 6469 6d65 6e73 696f 6e61  , and dimensiona
+00073fe0: 6c69 7479 2074 696d 6520 2864 696d 7429  lity time (dimt)
+00073ff0: 2e0a 0a20 2020 2054 6869 7320 6675 6e63  ...    This func
+00074000: 7469 6f6e 2069 7465 7261 7469 7665 6c79  tion iteratively
+00074010: 206d 6174 6368 6573 2064 6174 6166 7261   matches datafra
+00074020: 6d65 7320 6465 7269 7665 6420 6672 6f6d  mes derived from
+00074030: 2074 6865 2051 4320 6461 7461 6672 616d   the QC datafram
+00074040: 6520 666f 7220 6469 6666 6572 656e 7420  e for different 
+00074050: 696d 6167 696e 6720 6d6f 6461 6c69 7469  imaging modaliti
+00074060: 6573 2c0a 2020 2020 6170 706c 7969 6e67  es,.    applying
+00074070: 2061 2073 6572 6965 7320 6f66 2066 696c   a series of fil
+00074080: 7465 7273 2074 6f20 7365 6c65 6374 2074  ters to select t
+00074090: 6865 2062 6573 7420 6d61 7463 6865 7320  he best matches 
+000740a0: 6261 7365 6420 6f6e 2074 6865 2051 4320  based on the QC 
+000740b0: 6d65 7472 6963 732e 204d 6174 6368 6573  metrics. Matches
+000740c0: 2061 7265 206d 6164 6520 7769 7468 0a20   are made with. 
+000740d0: 2020 2063 6f6e 7369 6465 7261 7469 6f6e     consideration
+000740e0: 2074 6f20 6d69 6e69 6d69 7a65 206f 7574   to minimize out
+000740f0: 6c69 6572 206c 6f6f 7020 616e 6420 6e6f  lier loop and no
+00074100: 6973 652c 2077 6869 6c65 206d 6178 696d  ise, while maxim
+00074110: 697a 696e 6720 534e 522c 2045 5652 2c20  izing SNR, EVR, 
+00074120: 616e 6420 6469 6d74 2066 6f72 2065 6163  and dimt for eac
+00074130: 6820 6d6f 6461 6c69 7479 2e0a 0a20 2020  h modality...   
+00074140: 2050 6172 616d 6574 6572 733a 0a20 2020   Parameters:.   
+00074150: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+00074160: 7163 5f64 6174 6166 7261 6d65 203a 2070  qc_dataframe : p
+00074170: 616e 6461 732e 4461 7461 4672 616d 650a  andas.DataFrame.
+00074180: 2020 2020 2020 2020 5468 6520 4461 7461          The Data
+00074190: 4672 616d 6520 636f 6e74 6169 6e69 6e67  Frame containing
+000741a0: 2051 4320 6d65 7472 6963 7320 666f 7220   QC metrics for 
+000741b0: 6469 6666 6572 656e 7420 6d6f 6461 6c69  different modali
+000741c0: 7469 6573 2061 6e64 2069 6d61 6769 6e67  ties and imaging
+000741d0: 2064 6174 612e 0a20 2020 2066 6978 5f4c   data..    fix_L
+000741e0: 5252 4c20 3a20 626f 6f6c 2c20 6f70 7469  RRL : bool, opti
+000741f0: 6f6e 616c 0a0a 2020 2020 7665 7262 6f73  onal..    verbos
+00074200: 6520 3a20 626f 6f6c 2c20 6f70 7469 6f6e  e : bool, option
+00074210: 616c 0a20 2020 2020 2020 2049 6620 5472  al.        If Tr
+00074220: 7565 2c20 7072 696e 7473 2074 6865 2070  ue, prints the p
+00074230: 726f 6772 6573 7320 616e 6420 7468 6520  rogress and the 
+00074240: 7368 6170 6520 6f66 2074 6865 2044 6174  shape of the Dat
+00074250: 6146 7261 6d65 2062 6569 6e67 2070 726f  aFrame being pro
+00074260: 6365 7373 6564 2069 6e20 6561 6368 2073  cessed in each s
+00074270: 7465 702e 0a0a 2020 2020 5072 6f63 6573  tep...    Proces
+00074280: 733a 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  s:.    -------. 
+00074290: 2020 2031 2e20 5374 616e 6461 7264 697a     1. Standardiz
+000742a0: 6573 206d 6f64 616c 6974 6965 7320 6279  es modalities by
+000742b0: 206d 6572 6769 6e67 2044 5449 2d72 656c   merging DTI-rel
+000742c0: 6174 6564 2065 6e74 7269 6573 2e0a 2020  ated entries..  
+000742d0: 2020 322e 2043 6f6e 7665 7274 7320 7370    2. Converts sp
+000742e0: 6563 6966 6963 2063 6f6c 756d 6e73 2074  ecific columns t
+000742f0: 6f20 6170 7072 6f70 7269 6174 6520 6461  o appropriate da
+00074300: 7461 2074 7970 6573 2066 6f72 2070 726f  ta types for pro
+00074310: 6365 7373 696e 672e 0a20 2020 2033 2e20  cessing..    3. 
+00074320: 5065 7266 6f72 6d73 206d 6f64 616c 6974  Performs modalit
+00074330: 792d 7370 6563 6966 6963 206d 6174 6368  y-specific match
+00074340: 696e 6720 616e 6420 6669 6c74 6572 696e  ing and filterin
+00074350: 6720 6261 7365 6420 6f6e 2074 6865 206f  g based on the o
+00074360: 7574 6c69 6572 2063 6f6c 756d 6e20 616e  utlier column an
+00074370: 6420 6372 6974 6572 6961 2066 6f72 2065  d criteria for e
+00074380: 6163 6820 6d6f 6461 6c69 7479 2e0a 2020  ach modality..  
+00074390: 2020 342e 2049 7465 7261 7469 7665 6c79    4. Iteratively
+000743a0: 2070 726f 6365 7373 6573 2075 6e6d 6174   processes unmat
+000743b0: 6368 6564 2064 6174 6120 666f 7220 7072  ched data for pr
+000743c0: 6564 6566 696e 6564 206d 6f64 616c 6974  edefined modalit
+000743d0: 6965 7320 7769 7468 2073 7065 6369 6669  ies with specifi
+000743e0: 6320 7072 6566 6978 6573 2074 6f20 6669  c prefixes to fi
+000743f0: 6e64 2066 7572 7468 6572 206d 6174 6368  nd further match
+00074400: 6573 2e0a 2020 2020 0a20 2020 2052 6574  es..    .    Ret
+00074410: 7572 6e73 3a0a 2020 2020 2d2d 2d2d 2d2d  urns:.    ------
+00074420: 2d0a 2020 2020 7061 6e64 6173 2e44 6174  -.    pandas.Dat
+00074430: 6146 7261 6d65 0a20 2020 2020 2020 2054  aFrame.        T
+00074440: 6865 206d 6174 6368 6564 2061 6e64 2066  he matched and f
+00074450: 696c 7465 7265 6420 4461 7461 4672 616d  iltered DataFram
+00074460: 6520 6166 7465 7220 6170 706c 7969 6e67  e after applying
+00074470: 2061 6c6c 2051 4320 7363 6f72 696e 6720   all QC scoring 
+00074480: 616e 6420 6d61 7463 6869 6e67 206f 7065  and matching ope
+00074490: 7261 7469 6f6e 7320 6163 726f 7373 2073  rations across s
+000744a0: 7065 6369 6669 6564 206d 6f64 616c 6974  pecified modalit
+000744b0: 6965 732e 0a0a 2020 2020 2222 220a 2020  ies...    """.  
+000744c0: 2020 7163 5f64 6174 6166 7261 6d65 5b27    qc_dataframe['
+000744d0: 6d6f 6461 6c69 7479 275d 203d 2071 635f  modality'] = qc_
+000744e0: 6461 7461 6672 616d 655b 276d 6f64 616c  dataframe['modal
+000744f0: 6974 7927 5d2e 7265 706c 6163 6528 5b27  ity'].replace(['
+00074500: 4454 4964 7769 272c 2027 4454 4962 3027  DTIdwi', 'DTIb0'
+00074510: 5d2c 2027 4454 4927 2c20 7265 6765 783d  ], 'DTI', regex=
+00074520: 5472 7565 290a 2020 2020 7163 5f64 6174  True).    qc_dat
+00074530: 6166 7261 6d65 5b27 6669 6c65 6e61 6d65  aframe['filename
+00074540: 275d 3d71 635f 6461 7461 6672 616d 655b  ']=qc_dataframe[
+00074550: 2766 696c 656e 616d 6527 5d2e 6173 7479  'filename'].asty
+00074560: 7065 2873 7472 290a 2020 2020 7163 5f64  pe(str).    qc_d
+00074570: 6174 6166 7261 6d65 5b27 6f6c 5f6c 6f6f  ataframe['ol_loo
+00074580: 7027 5d3d 7163 5f64 6174 6166 7261 6d65  p']=qc_dataframe
+00074590: 5b27 6f6c 5f6c 6f6f 7027 5d2e 6173 7479  ['ol_loop'].asty
+000745a0: 7065 2866 6c6f 6174 290a 2020 2020 7163  pe(float).    qc
+000745b0: 5f64 6174 6166 7261 6d65 5b27 6f6c 5f6c  _dataframe['ol_l
+000745c0: 6f66 275d 3d71 635f 6461 7461 6672 616d  of']=qc_datafram
+000745d0: 655b 276f 6c5f 6c6f 6627 5d2e 6173 7479  e['ol_lof'].asty
+000745e0: 7065 2866 6c6f 6174 290a 2020 2020 7163  pe(float).    qc
+000745f0: 5f64 6174 6166 7261 6d65 5b27 6f6c 5f6c  _dataframe['ol_l
+00074600: 6f66 5f64 6563 6973 696f 6e27 5d3d 7163  of_decision']=qc
+00074610: 5f64 6174 6166 7261 6d65 5b27 6f6c 5f6c  _dataframe['ol_l
+00074620: 6f66 5f64 6563 6973 696f 6e27 5d2e 6173  of_decision'].as
+00074630: 7479 7065 2866 6c6f 6174 290a 2020 2020  type(float).    
+00074640: 6f75 746c 6965 725f 636f 6c75 6d6e 3d27  outlier_column='
+00074650: 6f6c 5f6c 6f6f 7027 0a20 2020 206d 6d64  ol_loop'.    mmd
+00074660: 6630 203d 2062 6573 745f 6d6d 6d28 2071  f0 = best_mmm( q
+00074670: 635f 6461 7461 6672 616d 652c 2027 5431  c_dataframe, 'T1
+00074680: 7727 2c20 6f75 746c 6965 725f 636f 6c75  w', outlier_colu
+00074690: 6d6e 3d6f 7574 6c69 6572 5f63 6f6c 756d  mn=outlier_colum
+000746a0: 6e20 295b 2766 696c 7427 5d0a 2020 2020  n )['filt'].    
+000746b0: 666c 6466 203d 2062 6573 745f 6d6d 6d28  fldf = best_mmm(
+000746c0: 2071 635f 6461 7461 6672 616d 652c 2027   qc_dataframe, '
+000746d0: 5432 466c 6169 7227 2c20 6f75 746c 6965  T2Flair', outlie
+000746e0: 725f 636f 6c75 6d6e 3d6f 7574 6c69 6572  r_column=outlier
+000746f0: 5f63 6f6c 756d 6e20 295b 2766 696c 7427  _column )['filt'
+00074700: 5d0a 2020 2020 6e6d 6466 203d 2062 6573  ].    nmdf = bes
+00074710: 745f 6d6d 6d28 2071 635f 6461 7461 6672  t_mmm( qc_datafr
+00074720: 616d 652c 2027 4e4d 3244 4d54 272c 206f  ame, 'NM2DMT', o
+00074730: 7574 6c69 6572 5f63 6f6c 756d 6e3d 6f75  utlier_column=ou
+00074740: 746c 6965 725f 636f 6c75 6d6e 2029 5b27  tlier_column )['
+00074750: 6669 6c74 275d 0a20 2020 2072 7364 6620  filt'].    rsdf 
+00074760: 3d20 6265 7374 5f6d 6d6d 2820 7163 5f64  = best_mmm( qc_d
+00074770: 6174 6166 7261 6d65 2c20 2772 7366 4d52  ataframe, 'rsfMR
+00074780: 4927 2c20 6f75 746c 6965 725f 636f 6c75  I', outlier_colu
+00074790: 6d6e 3d6f 7574 6c69 6572 5f63 6f6c 756d  mn=outlier_colum
+000747a0: 6e20 295b 2766 696c 7427 5d0a 2020 2020  n )['filt'].    
+000747b0: 6474 6466 203d 2062 6573 745f 6d6d 6d28  dtdf = best_mmm(
+000747c0: 2071 635f 6461 7461 6672 616d 652c 2027   qc_dataframe, '
+000747d0: 4454 4927 2c20 6f75 746c 6965 725f 636f  DTI', outlier_co
+000747e0: 6c75 6d6e 3d6f 7574 6c69 6572 5f63 6f6c  lumn=outlier_col
+000747f0: 756d 6e20 295b 2766 696c 7427 5d0a 0a20  umn )['filt'].. 
+00074800: 2020 2063 7269 7465 7269 6120 3d20 7b27     criteria = {'
+00074810: 6f6c 5f6c 6f6f 7027 3a20 276d 696e 272c  ol_loop': 'min',
+00074820: 2027 6e6f 6973 6527 3a20 276d 696e 272c   'noise': 'min',
+00074830: 2027 736e 7227 3a20 276d 6178 272c 2027   'snr': 'max', '
+00074840: 4556 5227 3a20 276d 6178 272c 2027 7265  EVR': 'max', 're
+00074850: 666c 6563 7469 6f6e 5f65 7272 273a 276d  flection_err':'m
+00074860: 696e 277d 0a20 2020 2078 636c 203d 205b  in'}.    xcl = [
+00074870: 2027 6d72 696d 6667 272c 2027 6d72 696d   'mrimfg', 'mrim
+00074880: 6f64 656c 272c 276d 7269 4d61 676e 6574  odel','mriMagnet
+00074890: 6963 4669 656c 6453 7472 656e 6774 6827  icFieldStrength'
+000748a0: 2c20 2764 7469 5f66 6169 6c65 6427 2c20  , 'dti_failed', 
+000748b0: 2772 7366 5f66 6169 6c65 6427 2c20 2773  'rsf_failed', 's
+000748c0: 7562 6a65 6374 4944 272c 2027 6461 7465  ubjectID', 'date
+000748d0: 272c 2027 7375 626a 6563 7449 4464 6174  ', 'subjectIDdat
+000748e0: 6527 2c27 7265 7065 6174 275d 0a20 2020  e','repeat'].   
+000748f0: 2023 2041 7373 756d 696e 6720 6466 5f61   # Assuming df_a
+00074900: 2061 6e64 2064 665f 6220 6172 6520 616c   and df_b are al
+00074910: 7265 6164 7920 6c6f 6164 6564 0a20 2020  ready loaded.   
+00074920: 206d 6d64 662c 2075 6e64 6666 6c20 3d20   mmdf, undffl = 
+00074930: 6d6d 5f6d 6174 6368 5f62 795f 7163 5f73  mm_match_by_qc_s
+00074940: 636f 7269 6e67 286d 6d64 6630 2c20 666c  coring(mmdf0, fl
+00074950: 6466 2c20 2773 7562 6a65 6374 4944 6461  df, 'subjectIDda
+00074960: 7465 272c 2063 7269 7465 7269 612c 200a  te', criteria, .
+00074970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074980: 2020 2020 2020 2020 7072 6566 6978 3d27          prefix='
+00074990: 5432 466c 6169 725f 272c 2065 7863 6c75  T2Flair_', exclu
+000749a0: 6465 5f63 6f6c 756d 6e73 3d78 636c 2029  de_columns=xcl )
+000749b0: 0a0a 2020 2020 7072 6566 6978 6573 203d  ..    prefixes =
+000749c0: 205b 274e 4d31 5f27 2c20 274e 4d32 5f27   ['NM1_', 'NM2_'
+000749d0: 2c20 274e 4d33 5f27 2c20 274e 4d34 5f27  , 'NM3_', 'NM4_'
+000749e0: 2c20 274e 4d35 5f27 2c20 274e 4d36 5f27  , 'NM5_', 'NM6_'
+000749f0: 5d20 200a 2020 2020 756e 6466 6d6f 6420  ]  .    undfmod 
+00074a00: 3d20 6e6d 6466 2020 2320 496e 6974 6961  = nmdf  # Initia
+00074a10: 6c69 7a65 2027 756e 6466 6d6f 6427 2077  lize 'undfmod' w
+00074a20: 6974 6820 276e 6d64 6627 2066 6f72 2074  ith 'nmdf' for t
+00074a30: 6865 2066 6972 7374 2069 7465 7261 7469  he first iterati
+00074a40: 6f6e 0a20 2020 2069 6620 756e 6466 6d6f  on.    if undfmo
+00074a50: 6420 6973 206e 6f74 204e 6f6e 653a 0a20  d is not None:. 
+00074a60: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+00074a70: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+00074a80: 7269 6e74 2827 7374 6172 7420 4e4d 2729  rint('start NM')
+00074a90: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+00074aa0: 6e74 2820 756e 6466 6d6f 642e 7368 6170  nt( undfmod.shap
+00074ab0: 6520 290a 2020 2020 2020 2020 666f 7220  e ).        for 
+00074ac0: 7072 6566 6978 2069 6e20 7072 6566 6978  prefix in prefix
+00074ad0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00074ae0: 6966 2075 6e64 666d 6f64 2e73 6861 7065  if undfmod.shape
+00074af0: 5b30 5d20 3e20 3530 3a0a 2020 2020 2020  [0] > 50:.      
+00074b00: 2020 2020 2020 2020 2020 6d6d 6466 2c20            mmdf, 
+00074b10: 756e 6466 6d6f 6420 3d20 6d6d 5f6d 6174  undfmod = mm_mat
+00074b20: 6368 5f62 795f 7163 5f73 636f 7269 6e67  ch_by_qc_scoring
+00074b30: 286d 6d64 662c 2075 6e64 666d 6f64 2c20  (mmdf, undfmod, 
+00074b40: 2773 7562 6a65 6374 4944 6461 7465 272c  'subjectIDdate',
+00074b50: 2063 7269 7465 7269 612c 2070 7265 6669   criteria, prefi
+00074b60: 783d 7072 6566 6978 2c20 6578 636c 7564  x=prefix, exclud
+00074b70: 655f 636f 6c75 6d6e 733d 7863 6c29 0a20  e_columns=xcl). 
+00074b80: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00074b90: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+00074ba0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00074bb0: 7269 6e74 2820 7072 6566 6978 2029 0a20  rint( prefix ). 
+00074bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074bd0: 2020 2070 7269 6e74 2820 756e 6466 6d6f     print( undfmo
+00074be0: 642e 7368 6170 6520 290a 0a20 2020 2063  d.shape )..    c
+00074bf0: 7269 7465 7269 6120 3d20 7b27 6f6c 5f6c  riteria = {'ol_l
+00074c00: 6f6f 7027 3a20 276d 696e 272c 2027 6e6f  oop': 'min', 'no
+00074c10: 6973 6527 3a20 276d 696e 272c 2027 736e  ise': 'min', 'sn
+00074c20: 7227 3a20 276d 6178 272c 2027 4556 5227  r': 'max', 'EVR'
+00074c30: 3a20 276d 6178 272c 2027 6469 6d74 273a  : 'max', 'dimt':
+00074c40: 276d 6178 277d 0a20 2020 2023 2068 6967  'max'}.    # hig
+00074c50: 6865 7220 6276 616c 7565 7320 6c65 6164  her bvalues lead
+00074c60: 2074 6f20 6d6f 7265 206e 6f69 7365 202e   to more noise .
+00074c70: 2e2e 0a20 2020 2063 7269 7465 7269 6120  ...    criteria 
+00074c80: 3d20 7b27 6f6c 5f6c 6f6f 7027 3a20 276d  = {'ol_loop': 'm
+00074c90: 696e 272c 2027 6e6f 6973 6527 3a20 276d  in', 'noise': 'm
+00074ca0: 696e 272c 2020 2764 7469 5f62 7661 6c75  in',  'dti_bvalu
+00074cb0: 654d 6178 273a 276d 696e 272c 2020 2764  eMax':'min',  'd
+00074cc0: 696d 7427 3a27 6d61 7827 7d0a 2020 2020  imt':'max'}.    
+00074cd0: 7072 6566 6978 6573 203d 205b 2744 5449  prefixes = ['DTI
+00074ce0: 315f 272c 2027 4454 4932 5f27 2c20 2744  1_', 'DTI2_', 'D
+00074cf0: 5449 335f 275d 2020 2320 4c69 7374 206f  TI3_']  # List o
+00074d00: 6620 7072 6566 6978 6573 2066 6f72 2065  f prefixes for e
+00074d10: 6163 6820 6d61 7463 6869 6e67 2069 7465  ach matching ite
+00074d20: 7261 7469 6f6e 0a20 2020 2075 6e64 666d  ration.    undfm
+00074d30: 6f64 203d 2064 7464 660a 2020 2020 6966  od = dtdf.    if
+00074d40: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+00074d50: 2020 7072 696e 7428 2773 7461 7274 2044    print('start D
+00074d60: 5427 290a 2020 2020 2020 2020 7072 696e  T').        prin
+00074d70: 7428 2075 6e64 666d 6f64 2e73 6861 7065  t( undfmod.shape
+00074d80: 2029 0a20 2020 2066 6f72 2070 7265 6669   ).    for prefi
+00074d90: 7820 696e 2070 7265 6669 7865 733a 0a20  x in prefixes:. 
+00074da0: 2020 2020 2020 2069 6620 756e 6466 6d6f         if undfmo
+00074db0: 642e 7368 6170 655b 305d 203e 2035 303a  d.shape[0] > 50:
+00074dc0: 0a20 2020 2020 2020 2020 2020 206d 6d64  .            mmd
+00074dd0: 662c 2075 6e64 666d 6f64 203d 206d 6d5f  f, undfmod = mm_
+00074de0: 6d61 7463 685f 6279 5f71 635f 7363 6f72  match_by_qc_scor
+00074df0: 696e 6728 6d6d 6466 2c20 756e 6466 6d6f  ing(mmdf, undfmo
+00074e00: 642c 2027 7375 626a 6563 7449 4464 6174  d, 'subjectIDdat
+00074e10: 6527 2c20 6372 6974 6572 6961 2c20 7072  e', criteria, pr
+00074e20: 6566 6978 3d70 7265 6669 782c 2065 7863  efix=prefix, exc
+00074e30: 6c75 6465 5f63 6f6c 756d 6e73 3d78 636c  lude_columns=xcl
+00074e40: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00074e50: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+00074e60: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00074e70: 2070 7265 6669 7820 290a 2020 2020 2020   prefix ).      
+00074e80: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00074e90: 2075 6e64 666d 6f64 2e73 6861 7065 2029   undfmod.shape )
+00074ea0: 0a0a 2020 2020 7072 6566 6978 6573 203d  ..    prefixes =
+00074eb0: 205b 2772 7366 315f 272c 2027 7273 6632   ['rsf1_', 'rsf2
+00074ec0: 5f27 2c20 2772 7366 335f 275d 2020 2320  _', 'rsf3_']  # 
+00074ed0: 4c69 7374 206f 6620 7072 6566 6978 6573  List of prefixes
+00074ee0: 2066 6f72 2065 6163 6820 6d61 7463 6869   for each matchi
+00074ef0: 6e67 2069 7465 7261 7469 6f6e 0a20 2020  ng iteration.   
+00074f00: 2075 6e64 666d 6f64 203d 2072 7364 6620   undfmod = rsdf 
+00074f10: 2023 2049 6e69 7469 616c 697a 6520 2775   # Initialize 'u
+00074f20: 6e64 666d 6f64 2720 7769 7468 2027 6e6d  ndfmod' with 'nm
+00074f30: 6466 2720 666f 7220 7468 6520 6669 7273  df' for the firs
+00074f40: 7420 6974 6572 6174 696f 6e0a 2020 2020  t iteration.    
+00074f50: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+00074f60: 2020 2020 7072 696e 7428 2773 7461 7274      print('start
+00074f70: 2072 7366 2729 0a20 2020 2020 2020 2070   rsf').        p
+00074f80: 7269 6e74 2820 756e 6466 6d6f 642e 7368  rint( undfmod.sh
+00074f90: 6170 6520 290a 2020 2020 666f 7220 7072  ape ).    for pr
+00074fa0: 6566 6978 2069 6e20 7072 6566 6978 6573  efix in prefixes
+00074fb0: 3a0a 2020 2020 2020 2020 6966 2075 6e64  :.        if und
+00074fc0: 666d 6f64 2e73 6861 7065 5b30 5d20 3e20  fmod.shape[0] > 
+00074fd0: 3530 3a0a 2020 2020 2020 2020 2020 2020  50:.            
+00074fe0: 6d6d 6466 2c20 756e 6466 6d6f 6420 3d20  mmdf, undfmod = 
+00074ff0: 6d6d 5f6d 6174 6368 5f62 795f 7163 5f73  mm_match_by_qc_s
+00075000: 636f 7269 6e67 286d 6d64 662c 2075 6e64  coring(mmdf, und
+00075010: 666d 6f64 2c20 2773 7562 6a65 6374 4944  fmod, 'subjectID
+00075020: 6461 7465 272c 2063 7269 7465 7269 612c  date', criteria,
+00075030: 2070 7265 6669 783d 7072 6566 6978 2c20   prefix=prefix, 
+00075040: 6578 636c 7564 655f 636f 6c75 6d6e 733d  exclude_columns=
+00075050: 7863 6c29 0a20 2020 2020 2020 2020 2020  xcl).           
+00075060: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+00075070: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00075080: 6e74 2820 7072 6566 6978 2029 0a20 2020  nt( prefix ).   
+00075090: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+000750a0: 6e74 2820 756e 6466 6d6f 642e 7368 6170  nt( undfmod.shap
+000750b0: 6520 290a 2020 2020 0a20 2020 2069 6620  e ).    .    if 
+000750c0: 6669 785f 4c52 524c 3a0a 2020 2020 2020  fix_LRRL:.      
+000750d0: 2020 2320 2020 2020 2020 206d 6d64 663d    #        mmdf=
+000750e0: 6669 785f 4c52 5f52 4c5f 7374 7566 6628  fix_LR_RL_stuff(
+000750f0: 206d 6d64 662c 2027 4454 4931 5f66 696c   mmdf, 'DTI1_fil
+00075100: 656e 616d 6527 2c20 2744 5449 325f 6669  ename', 'DTI2_fi
+00075110: 6c65 6e61 6d65 272c 2027 4454 4931 5f64  lename', 'DTI1_d
+00075120: 696d 7427 2c20 2744 5449 325f 6469 6d74  imt', 'DTI2_dimt
+00075130: 2729 0a20 2020 2020 2020 206d 6d64 663d  ').        mmdf=
+00075140: 6669 785f 4c52 5f52 4c5f 7374 7566 6628  fix_LR_RL_stuff(
+00075150: 206d 6d64 662c 2027 7273 6631 5f66 696c   mmdf, 'rsf1_fil
+00075160: 656e 616d 6527 2c20 2772 7366 325f 6669  ename', 'rsf2_fi
+00075170: 6c65 6e61 6d65 272c 2027 7273 6631 5f64  lename', 'rsf1_d
+00075180: 696d 7427 2c20 2772 7366 325f 6469 6d74  imt', 'rsf2_dimt
+00075190: 272c 2027 7273 6631 5f69 6d61 6765 4944  ', 'rsf1_imageID
+000751a0: 272c 2027 7273 6632 5f69 6d61 6765 4944  ', 'rsf2_imageID
+000751b0: 2720 2029 0a20 2020 2065 6c73 653a 0a20  '  ).    else:. 
+000751c0: 2020 2020 2020 2069 6d70 6f72 7420 7761         import wa
+000751d0: 726e 696e 6773 0a20 2020 2020 2020 2077  rnings.        w
+000751e0: 6172 6e69 6e67 732e 7761 726e 2822 4649  arnings.warn("FI
+000751f0: 584d 453a 2073 686f 756c 6420 6669 7820  XME: should fix 
+00075200: 4c52 2061 6e64 2052 4c20 7369 7475 6174  LR and RL situat
+00075210: 696f 6e20 666f 7220 7468 6520 4454 4920  ion for the DTI 
+00075220: 616e 6420 7273 664d 5249 2229 0a0a 2020  and rsfMRI")..  
+00075230: 2020 2320 6e6f 7720 646f 2074 6865 206e    # now do the n
+00075240: 6563 6573 7361 7279 2072 6570 6c61 6365  ecessary replace
+00075250: 6d65 6e74 730a 2020 2020 0a20 2020 2072  ments.    .    r
+00075260: 656e 616d 6569 7428 206d 6d64 662c 2027  enameit( mmdf, '
+00075270: 7065 7266 5f69 6d61 6765 4944 272c 2027  perf_imageID', '
+00075280: 7065 7266 6964 2720 290a 2020 2020 7265  perfid' ).    re
+00075290: 6e61 6d65 6974 2820 6d6d 6466 2c20 2770  nameit( mmdf, 'p
+000752a0: 6572 665f 6669 6c65 6e61 6d65 272c 2027  erf_filename', '
+000752b0: 7065 7266 666e 2720 290a 2020 2020 7265  perffn' ).    re
+000752c0: 6e61 6d65 6974 2820 6d6d 6466 2c20 2754  nameit( mmdf, 'T
+000752d0: 3246 6c61 6972 5f69 6d61 6765 4944 272c  2Flair_imageID',
+000752e0: 2027 666c 6169 7269 6427 2029 0a20 2020   'flairid' ).   
+000752f0: 2072 656e 616d 6569 7428 206d 6d64 662c   renameit( mmdf,
+00075300: 2027 5432 466c 6169 725f 6669 6c65 6e61   'T2Flair_filena
+00075310: 6d65 272c 2027 666c 6169 7266 6e27 2029  me', 'flairfn' )
+00075320: 0a20 2020 2072 656e 616d 6569 7428 206d  .    renameit( m
+00075330: 6d64 662c 2027 7273 6631 5f69 6d61 6765  mdf, 'rsf1_image
+00075340: 4944 272c 2027 7273 6669 6431 2720 290a  ID', 'rsfid1' ).
+00075350: 2020 2020 7265 6e61 6d65 6974 2820 6d6d      renameit( mm
+00075360: 6466 2c20 2772 7366 325f 696d 6167 6549  df, 'rsf2_imageI
+00075370: 4427 2c20 2772 7366 6964 3227 2029 0a20  D', 'rsfid2' ). 
+00075380: 2020 2072 656e 616d 6569 7428 206d 6d64     renameit( mmd
+00075390: 662c 2027 7273 6631 5f66 696c 656e 616d  f, 'rsf1_filenam
+000753a0: 6527 2c20 2772 7366 666e 3127 2029 0a20  e', 'rsffn1' ). 
+000753b0: 2020 2072 656e 616d 6569 7428 206d 6d64     renameit( mmd
+000753c0: 662c 2027 7273 6632 5f66 696c 656e 616d  f, 'rsf2_filenam
+000753d0: 6527 2c20 2772 7366 666e 3227 2029 0a20  e', 'rsffn2' ). 
+000753e0: 2020 2072 656e 616d 6569 7428 206d 6d64     renameit( mmd
+000753f0: 662c 2027 4454 4931 5f69 6d61 6765 4944  f, 'DTI1_imageID
+00075400: 272c 2027 6474 6964 3127 2029 0a20 2020  ', 'dtid1' ).   
+00075410: 2072 656e 616d 6569 7428 206d 6d64 662c   renameit( mmdf,
+00075420: 2027 4454 4932 5f69 6d61 6765 4944 272c   'DTI2_imageID',
+00075430: 2027 6474 6964 3227 2029 0a20 2020 2072   'dtid2' ).    r
+00075440: 656e 616d 6569 7428 206d 6d64 662c 2027  enameit( mmdf, '
+00075450: 4454 4933 5f69 6d61 6765 4944 272c 2027  DTI3_imageID', '
+00075460: 6474 6964 3327 2029 0a20 2020 2072 656e  dtid3' ).    ren
+00075470: 616d 6569 7428 206d 6d64 662c 2027 4454  ameit( mmdf, 'DT
+00075480: 4931 5f66 696c 656e 616d 6527 2c20 2764  I1_filename', 'd
+00075490: 7466 6e31 2720 290a 2020 2020 7265 6e61  tfn1' ).    rena
+000754a0: 6d65 6974 2820 6d6d 6466 2c20 2744 5449  meit( mmdf, 'DTI
+000754b0: 325f 6669 6c65 6e61 6d65 272c 2027 6474  2_filename', 'dt
+000754c0: 666e 3227 2029 0a20 2020 2072 656e 616d  fn2' ).    renam
+000754d0: 6569 7428 206d 6d64 662c 2027 4454 4933  eit( mmdf, 'DTI3
+000754e0: 5f66 696c 656e 616d 6527 2c20 2764 7466  _filename', 'dtf
+000754f0: 6e33 2720 290a 2020 2020 666f 7220 7820  n3' ).    for x 
+00075500: 696e 2072 616e 6765 2831 2c36 293a 0a20  in range(1,6):. 
+00075510: 2020 2020 2020 2074 656d 7030 3d22 4e4d         temp0="NM
+00075520: 222b 7374 7228 7829 2b22 5f69 6d61 6765  "+str(x)+"_image
+00075530: 4944 220a 2020 2020 2020 2020 7465 6d70  ID".        temp
+00075540: 313d 226e 6d69 6422 2b73 7472 2878 290a  1="nmid"+str(x).
+00075550: 2020 2020 2020 2020 7265 6e61 6d65 6974          renameit
+00075560: 2820 6d6d 6466 2c20 7465 6d70 302c 2074  ( mmdf, temp0, t
+00075570: 656d 7031 2029 0a20 2020 2020 2020 2074  emp1 ).        t
+00075580: 656d 7030 3d22 4e4d 222b 7374 7228 7829  emp0="NM"+str(x)
+00075590: 2b22 5f66 696c 656e 616d 6522 0a20 2020  +"_filename".   
+000755a0: 2020 2020 2074 656d 7031 3d22 6e6d 666e       temp1="nmfn
+000755b0: 222b 7374 7228 7829 0a20 2020 2020 2020  "+str(x).       
+000755c0: 2072 656e 616d 6569 7428 206d 6d64 662c   renameit( mmdf,
+000755d0: 2074 656d 7030 2c20 7465 6d70 3120 290a   temp0, temp1 ).
+000755e0: 2020 2020 7265 7475 726e 206d 6d64 660a      return mmdf.
```

### Comparing `antspymm-1.3.7/antspymm.egg-info/PKG-INFO` & `antspymm-1.3.8/antspymm.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: antspymm
-Version: 1.3.7
+Version: 1.3.8
 Summary: multi-channel/time-series medical image processing with antspyx
 Author-email: "Avants, Gosselin, Tustison, Reardon" <stnava@gmail.com>
 License: Apache 2.0
 Requires-Python: >=3.8
 Description-Content-Type: text/markdown
 License-File: LICENSE
 Requires-Dist: h5py>=2.10.0
```

### Comparing `antspymm-1.3.7/antspymm.egg-info/SOURCES.txt` & `antspymm-1.3.8/antspymm.egg-info/SOURCES.txt`

 * *Files 13% similar despite different names*

```diff
@@ -26,31 +26,31 @@
 docs/roi_visualization_ppmi.py
 docs/step1_blind_qc.py
 docs/step2_outlierness.py
 docs/step3_mm_nrg_csv.py
 docs/step4_aggregate.py
 docs/ukbb_to_nrg_processing.py
 docs/ukbb_to_nrg_processing2.py
+tests/bids_2_nrg.py
 tests/blind_qc.py
+tests/deformation_gradient_reo.py
+tests/dti_recon.py
+tests/dti_reg.py
+tests/dwi_rebasing.py
+tests/dwi_run.py
+tests/dwi_run_ptbp_scrub.py
+tests/flair_run.py
+tests/joint_dti_recon.py
 tests/mm.py
+tests/mm_csv.py
 tests/mm_nrg.py
+tests/nrg_validation.py
 tests/outlierness.py
 tests/parallel_study_aggregation_example.py
-tests/test_00_setup.py
-tests/test_bids_2_nrg.py
-tests/test_deformation_gradient_reo.py
-tests/test_dti_recon.py
-tests/test_dti_reg.py
-tests/test_dwi_rebasing.py
-tests/test_dwi_run.py
-tests/test_dwi_run_ptbp_scrub.py
-tests/test_flair_run.py
-tests/test_joint_dti_recon.py
-tests/test_mm_csv.py
-tests/test_nrg_validation.py
-tests/test_perfusion_ptbp.py
-tests/test_perfusion_run.py
-tests/test_rsfmri_run.py
-tests/test_rsfmri_run_minimal.py
-tests/test_ukbb_rsfmri.py
+tests/perfusion_ptbp.py
+tests/perfusion_run.py
+tests/rsfmri_run.py
+tests/rsfmri_run_minimal.py
+tests/test_reference_run.py
 tests/testsr.py
+tests/ukbb_rsfmri.py
 tests/visualize_tractogram.py
```

### Comparing `antspymm-1.3.7/docs/adni_rsfmri_2_nrg_conversion.py` & `antspymm-1.3.8/docs/adni_rsfmri_2_nrg_conversion.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/antspymm_data_dictionary.csv` & `antspymm-1.3.8/docs/antspymm_data_dictionary.csv`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/bids_cohort_example.py` & `antspymm-1.3.8/docs/bids_cohort_example.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/blind_qc.Rmd` & `antspymm-1.3.8/docs/blind_qc.Rmd`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/blind_qc.html` & `antspymm-1.3.8/docs/blind_qc.html`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/convert_adni_dti_to_nrg.R` & `antspymm-1.3.8/docs/convert_adni_dti_to_nrg.R`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/deepnbm.jpg` & `antspymm-1.3.8/docs/deepnbm.jpg`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/example_antspymm_output.csv` & `antspymm-1.3.8/docs/example_antspymm_output.csv`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/example_run_from_directory.py` & `antspymm-1.3.8/docs/example_run_from_directory.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/make_dict_table.Rmd` & `antspymm-1.3.8/docs/make_dict_table.Rmd`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/make_dict_table.html` & `antspymm-1.3.8/docs/make_dict_table.html`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/nrg_cohort_example.py` & `antspymm-1.3.8/docs/nrg_cohort_example.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/ptbp_nrg.py` & `antspymm-1.3.8/docs/ptbp_nrg.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/roi_visualization.py` & `antspymm-1.3.8/docs/roi_visualization.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/roi_visualization_ppmi.py` & `antspymm-1.3.8/docs/roi_visualization_ppmi.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/step1_blind_qc.py` & `antspymm-1.3.8/docs/step1_blind_qc.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/step2_outlierness.py` & `antspymm-1.3.8/docs/step2_outlierness.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/step3_mm_nrg_csv.py` & `antspymm-1.3.8/docs/step3_mm_nrg_csv.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/step4_aggregate.py` & `antspymm-1.3.8/docs/step4_aggregate.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/ukbb_to_nrg_processing.py` & `antspymm-1.3.8/docs/ukbb_to_nrg_processing.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/docs/ukbb_to_nrg_processing2.py` & `antspymm-1.3.8/docs/ukbb_to_nrg_processing2.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/pyproject.toml` & `antspymm-1.3.8/pyproject.toml`

 * *Files 1% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 [build-system]
 requires = ["setuptools>=42", "wheel"]
 build-backend = "setuptools.build_meta"
 
 [project]
 name = "antspymm"
-version = "1.3.7"
+version = "1.3.8"
 description = "multi-channel/time-series medical image processing with antspyx"
 readme = "README.md"
 requires-python = ">=3.8"
 license = { text = "Apache 2.0" }
 authors = [
     { name = "Avants, Gosselin, Tustison, Reardon", email = "stnava@gmail.com" }
 ]
```

### Comparing `antspymm-1.3.7/tests/blind_qc.py` & `antspymm-1.3.8/tests/blind_qc.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/mm.py` & `antspymm-1.3.8/tests/mm.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/mm_nrg.py` & `antspymm-1.3.8/tests/mm_nrg.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/outlierness.py` & `antspymm-1.3.8/tests/outlierness.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/parallel_study_aggregation_example.py` & `antspymm-1.3.8/tests/parallel_study_aggregation_example.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/test_deformation_gradient_reo.py` & `antspymm-1.3.8/tests/deformation_gradient_reo.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/test_dti_reg.py` & `antspymm-1.3.8/tests/dti_reg.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/test_dwi_rebasing.py` & `antspymm-1.3.8/tests/dwi_rebasing.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/test_dwi_run.py` & `antspymm-1.3.8/tests/dwi_run.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/test_dwi_run_ptbp_scrub.py` & `antspymm-1.3.8/tests/dwi_run_ptbp_scrub.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/test_joint_dti_recon.py` & `antspymm-1.3.8/tests/joint_dti_recon.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/test_mm_csv.py` & `antspymm-1.3.8/tests/mm_csv.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/test_nrg_validation.py` & `antspymm-1.3.8/tests/nrg_validation.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/test_perfusion_ptbp.py` & `antspymm-1.3.8/tests/perfusion_ptbp.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/test_perfusion_run.py` & `antspymm-1.3.8/tests/perfusion_run.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/test_rsfmri_run.py` & `antspymm-1.3.8/tests/rsfmri_run.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/test_rsfmri_run_minimal.py` & `antspymm-1.3.8/tests/rsfmri_run_minimal.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/test_ukbb_rsfmri.py` & `antspymm-1.3.8/tests/ukbb_rsfmri.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/testsr.py` & `antspymm-1.3.8/tests/testsr.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.7/tests/visualize_tractogram.py` & `antspymm-1.3.8/tests/visualize_tractogram.py`

 * *Files identical despite different names*

